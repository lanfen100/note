
    <html lang="zh-cn">
    <head>
    <meta content="text/html; charset=utf-8" http-equiv="content-type" />
    <link href="F:\bkdoc\md_to_pdf/default.css" rel="stylesheet">
    </head>
    <body>
    <h1 id="_1">快速入门</h1>
<h2 id="_2">情景</h2>
<p>运维的职能为 <strong>应用发布</strong> 、 <strong>变更</strong> 、 <strong>故障处理</strong> 以及 <strong>日常需求</strong> ，覆盖研发运营生命周期的 <strong>持续集成</strong> （CI）、 <strong>持续部署</strong> （CD）、 <strong>持续运营</strong> （CO）三个阶段，从测试包交付到测试环境，到将验证通过的版本部署到生产环境，以及提供业务上线后的运维基础和增值服务。</p>
<p>传统人工、脚本的运维模式会面临 <strong>效率低下</strong> 、 <strong>频繁出错背锅</strong> 等等挑战，在质量、效率、成本、安全四个维度上，无法跟随业务快速增长的步伐。此外，由于这种困境，运维交付基础运维服务已经疲于奔命，无法向上交付运维的增值服务，难以体现自身价值。</p>
<p>蓝鲸是腾讯游戏基于 PaaS 理念设计的一套 <strong>研发运营一体化解决方案</strong> ，服务于业务全生命周期。将服务以原子能力集成，并提供了自主研发 SaaS 的 DevOps 工具链，通过私有化部署的模式，帮助企业整合及落地研发运营体系，提升企业研发运营效率，帮助企业运维团队转型，提供更多增值服务。</p>
<p>接下来，我们通过 <strong>一个传统单体应用的发布（将版本部署至生产环境）</strong> 、 <strong>故障处理（磁盘告警自动化处理）</strong> 以及 <strong>日常需求（测试同学自助调整应用配置）</strong> 等几大场景，看蓝鲸是如何高效的交付运维服务。</p>
<h2 id="_3">前提条件</h2>
<ul>
<li><a href="5.1/蓝鲸体系/品牌简介/intro.md">了解蓝鲸的体系架构</a></li>
</ul>
<p>{% video %}http://bkopen-10032816.file.myqcloud.com/grayscale_test/BkVideo/bk_AdVideo_cn.mp4{% endvideo %}</p>
<ul>
<li><a href="5.1/部署维护/README.md">完成蓝鲸的部署</a></li>
</ul>
<h2 id="_4">操作步骤</h2>
<ul>
<li>准备环境</li>
<li>应用交付</li>
<li>故障处理</li>
<li>日常需求</li>
</ul>
<h2 id="1">1. 准备环境</h2>
<p>完成蓝鲸部署后，接下来开始初始化环境。</p>
<p>在蓝鲸 CMDB 中 新建业务、划分业务拓扑，以及 安装 Agent，完成蓝鲸对业务主机的纳管。</p>
<h3 id="11-cmdb">1.1 CMDB 新建业务及划分业务拓扑</h3>
<p>在蓝鲸中，蓝鲸 CMDB 位于原子平台层，通过蓝鲸 PaaS 的 ESB 模块，为上层 SaaS 提供统一的资源管理。</p>
<p>所以，针对业务或者主机等资源的管理之前，要先将其在 CMDB 中纳管。</p>
<p>首先，在配置平台中 <a href="5.1/配置平台/快速入门/case1.md">新建业务</a>，然后参照 <a href="5.1/bk_solutions/CD/CMDB/CMDB_management_hosts.md">业务上线时 CMDB 如何管理主机</a> 完成业务拓扑的划分。</p>
<p>接下来，安装 Agent，蓝鲸的管控平台可以对主机实现包含文件分发、命令执行、数据上报的管控，同时主机会自动录入到蓝鲸 CMDB 对应的业务。</p>
<h3 id="12-agent">1.2 安装 Agent</h3>
<p>参照 <a href="5.1/bk_solutions/CD/Automation/Hybrid_cloud_management.md">管理直连网络区域的主机</a>，完成 Agent 安装。</p>
<h3 id="13">1.3 执行脚本和分发文件</h3>
<p>执行一个脚本和文件分发，验证环境是否已准备妥当。</p>
<p>{% video %}../CD/Automation/media/blueking_execute_push_file.mp4{% endvideo %}</p>
<p>接下来，我们尝试做一次单体应用的版本发布。</p>
<h2 id="2">2. 应用交付</h2>
<p>参照 <a href="5.1/bk_solutions/CD/Automation/application_deployment.md">一次标准的应用交付自动化案例</a>，完成一次自动化的应用交付，效果如下：</p>
<p>{% video %}../CD/Automation/media/sops_execution.mp4{% endvideo %}</p>
<p>完成应用交付后，接下来了解在蓝鲸中如何实现告警的自动化处理。</p>
<h2 id="3">3. 故障处理</h2>
<p>根据企业内部正在使用的监控系统，参照 <a href="5.1/bk_solutions/CO/FTA/Zabbix_Alarm_processing_automation.md">Zabbix 告警自动处理</a> 或 <a href="5.1/bk_solutions/CO/FTA/REST_API_PUSH_Alarm_processing_automation.md">第 3 方监控系统告警自动处理</a> 或<a href="5.1/bk_solutions/CO/FTA/Bkmonitor_Alarm_processing_automation.md">蓝鲸监控告警自动处理</a>，实现 <strong>磁盘告警自动化处理</strong>。</p>
<p>{% video %}../CO/FTA/media/zabbix_fta.mp4{% endvideo %}</p>
<p>接下来，了解来自产品、运营、测试等团队，对运维的日常需求，是如何释放运维，做到 <strong>需求自助化</strong> 的。</p>
<h2 id="4">4. 日常需求</h2>
<p>参照 <a href="5.1/bk_solutions/CD/Demand_self_service.md">需求自助化:测试自助调整验收环境</a>，完成测试自助修改测试环境配置，从此再也不会骚扰运维了。</p>
<p><img alt="-w1336" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/media/15638726755169.jpg" /></p>
<p>以上就是一个运维的日常，在蓝鲸中如何做到 <strong>标准化</strong> 、 <strong>自动化</strong> 和 <strong>自助化</strong>。</p>
<hr />
<p>当然，如果想做深，你还需要实现 <a href="5.1/bk_solutions/CD/CMDB/CMDB_CI_auto_discovery_MySQL.md">CMDB 中资源实例的自动发现</a>，靠自动化去维护 CMDB 实例。</p>
<p>在自动化的应用发布过程中，不免还是需要和上下游沟通版本发布细节，如此高的沟通成本，我们建议运维在标准运维固化发布流程，并 <a href="5.1/bk_solutions/CD/Automation/ops_half_automation.md">启用操作员的发布功能</a>，让运维更关注增值服务。</p>
<p>另一方面，蓝鲸 ITSM 实现 <a href="5.1/bk_solutions/CO/ITSM/Service_Request.md">服务器资源申请流程线上化</a>、<a href="5.1/bk_solutions/CO/ITSM/Release_Management.md">应用发布流程线上化</a>、<a href="5.1/bk_solutions/CO/ITSM/Change_Management.md">环境变更流线上化</a>、<a href="5.1/bk_solutions/CO/ITSM/Incident_Management.md">故障提报流程线上化</a>，通过线上流程完成企业 IT 的运营维护，告别邮件的低效率和不可回溯的交付模式。</p>
<p>持续部署(Continuous Deployment)之前是持续集成(Continuous Integration)和 <a href="5.1/bk_solutions/CI/Pipeline_git_commit_to_stag.md">持续交付(Continuous Delivery)</a>，蓝盾会逐渐覆盖，尽请期待。</p>
<hr />
<p>解决了运维当前的主要矛盾后，蓝鲸更关注 <strong>研发运营这个领域的行业技术变化</strong>。</p>
<p>通过支持 Kubernetes 和 Mesos 容器编排的蓝鲸容器管理平台，实现 <a href="5.1/bk_solutions/CD/BCS/Bcs_deploy_nginx_cluster.md">快速构建 Nginx 集群</a> 、<a href="5.1/bk_solutions/CD/BCS/Bcs_app_Rolling_Update_Deployment.html">应用的滚动升级</a> 、<a href="5.1/bk_solutions/CD/BCS/Bcs_blue_green_deployment.md">蓝绿发布</a> 以及自动扩缩容等微服务化带来的技术红利。</p>
<p>蓝鲸，不止如此，更多尽情关注蓝鲸公众号。</p>
<p><img src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/Getting_started/media/15659324878049.jpg" height="200" width="200"/></p><h1 id="_1">测试环境自动更新</h1>
<h2 id="_2">情景</h2>
<p>开发同学完成功能开发、本地测试通过后，运维通过自动化工具或人工登录服务器更新，由于开发和运维存在 <strong>沟通成本</strong>，导致持续集成的测试环节效率低下，影响整体研发效率。</p>
<p>接下来看蓝盾（BK-CI）是如何做到 <strong>测试环境自动更新</strong>。</p>
<h2 id="_3">前提条件</h2>
<ul>
<li><a href="https://github.com/Tencent/bk-ci">部署蓝盾（BK-CI）</a></li>
</ul>
<h2 id="_4">操作步骤</h2>
<ul>
<li>配置自动构建流水线</li>
<li>提交代码（Git Commit）验证</li>
</ul>
<h3 id="1">1. 配置自动构建流水线</h3>
<p><img alt="bk-ci-demo" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CI/media/bk-ci-demo.png" /></p>
<h3 id="2-git-commit">2. 提交代码（Git Commit）验证</h3>
<p>下面为一次自动更新记录，从 <strong>提交代码到更新测试环境</strong>，<strong>不到 1 分钟</strong>。</p>
<p>{% video %}media/bk-ci-demo-HD.mp4{% endvideo %}</p><h1 id="_1">运维 "四化建设" 之标准化：配置管理标准化</h1>
<blockquote>
<p>自动化前，先做好标准化。</p>
</blockquote>
<p>2014 年 GOT 大会上，腾讯游戏技术运营负责人刘栖铜在《腾讯游戏云的理想与实践》分享中提到运维服务的“四化建设” : 标准化、自动化、服务化、产品化是如何交付运维价值。</p>
<p>这里我们介绍，运维"四化建设"的基石"标准化"中的 <strong>配置管理标准化</strong>，以 <strong>蓝鲸配置平台为案例，实战分析企业如何落地配置管理标准化，以及上层 SaaS 如何消费 CMDB</strong>，为后续的自动化、数据化、智能化打牢基础。</p>
<p>首先，我们看下 IT 基础资源、应用在配置管理方面遇到的痛点。</p>
<h2 id="_2">配置管理的痛点</h2>
<ul>
<li>手工录入 CMDB 数据</li>
<li>日常的发布、变更、故障处理、日常需求处理等运维自动化系统没有消费 CMDB ，而是在 CMDB 和自动化系统中通过键盘复制粘贴主机 IP...</li>
<li>无法保证配置数据的准确性</li>
<li>未纳管应用系统，仅管理 IT 基础设施，如主机、网络设备等</li>
<li>排查问题时，无法通过可视化拓扑方式查看资源间的关联关系，比如 DB 挂了，影响了哪些业务的哪些模块</li>
<li>...</li>
</ul>
<p>接下来，我们尝试以项目的方式，解决运维在配置管理上遇到的痛点。</p>
<h2 id="1">1. 项目目标</h2>
<p>建立一个权威统一的 CMDB 配置主数据，作为自动化运维平台、监控平台、运维流程平台等一系列 IT 系统的基石。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/15602199321821.jpg" /></p>
<p><center>（ CMDB 是 ITIL 的基石）</center></p>
<p>确立了项目目标，接下来做技术选型。</p>
<h2 id="2">2. 技术选型</h2>
<p>在蓝鲸体系架构中，配置平台位于原子平台层，通过蓝鲸 PaaS 的 ESB 为上层 SaaS 提供覆盖研发运营 CI（持续集成）、CD（持续交付和持续部署）、CO（持续运营）领域的配置管理能力。</p>
<p><img alt="CMDB在蓝鲸架构中的位置" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/CMDB%E5%9C%A8%E8%93%9D%E9%B2%B8%E6%9E%B6%E6%9E%84%E4%B8%AD%E7%9A%84%E4%BD%8D%E7%BD%AE-1.png" /></p>
<p><center>（ <strong>配置平台</strong> 在蓝鲸体系架构中的位置）</center></p>
<p>这意味，在架构上确立了蓝鲸配置平台可 <strong>打破企业研发运营系统存在的"信息孤岛，无法实现配置管理数据互通"</strong> 的痛点，不给企业再新增一个竖井式的“烟囱”。</p>
<p>以下是蓝鲸配置平台（<a href="https://github.com/Tencent/bk-cmdb">已开源</a>）相当于传统 CMDB 的优势，正好切中运维在配置管理上遇到的痛点，同时在产品设计和架构上具有很强的扩展能力。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/15602199513502.jpg" /></p>
<p><center>（ <strong>配置平台</strong> 的核心能力）</center></p>
<p>确立了技术方案后，接下来介绍如何在企业内部实施 CMDB，使其成为自动化等 IT 系统的基石。</p>
<p>如何实施 CMDB，请参考场景案例： <a href="5.1/bk_solutions/CD/CMDB/CMDB_management_hosts.md">业务上线时 CMDB 如何管理主机</a>、<a href="5.1/bk_solutions/CD/CMDB/CMDB_management_process.md">CMDB 如何管理进程</a>、<a href="5.1/bk_solutions/CD/CMDB/CMDB_management_database_middleware.md">CMDB 如何管理 MySQL 实例</a>、<a href="5.1/bk_solutions/CD/CMDB/CMDB_integration.md">企业 CMDB 主机实例同步至蓝鲸 CMDB</a>、<a href="5.1/bk_solutions/CD/CMDB/CMDB_CI_auto_discovery_MySQL.md">自动发现 MySQL 实例</a>。</p>
<h2 id="3">3. 技术发展方向</h2>
<p>当自动化等 IT 系统越来越依赖于 CMDB，如何保证 <strong>CMDB 数据的准确性</strong> 呢？我们认为 CMDB 需要具备配置数据的审计和校验能力，并关联 ITSM 系统，完善 CMDB 中配置数据的变更流程。</p>
<p>自动发现采集器的开发毕竟存在开发成本，是否可以提供 <strong>开箱即用的 CI 属性和 CI 间关联关系</strong>（如数据库或中间件运行在哪台主机上，亦或是业务程序访问了哪台 DB ）的自动发现能力。</p>
<p>此外，IT 系统 <strong>对 CMDB 的消费程度需要持续加深</strong>，CMDB 需加强在 CI 属性、关联关系以及供上层 SaaS 消费的便利度，比如监控系统中的资源对象全部以 CMDB 中为准，不再自己保留一部分资源对象，真正实现以 CMDB 为核心的资源管理和自动化运维。</p>
<p>万丈高楼平地起，无论想实现自动化、数据化还是智能化，<strong>都需要把第一步的标准化做好</strong>，尤其是标准化中的配置管理标准化，切不可操之过急。</p>
<p>最后希望，企业的 IT 系统建设能够逐步演进、完善，让广大运维兄弟真正能 <strong>交付运维价值</strong>，体会运维这个岗位给企业带来的价值。</p>
<p>来吧，一起共建属于大家的 <a href="https://github.com/Tencent/bk-cmdb">开源的 CMDB 项目</a>！</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/15605114938006.jpg" /></p>
<p><center>（开源共建 CMDB ）</center></p>
<h2 id="_3">扩展阅读</h2>
<ul>
<li><a href="http://www.kokojia.com/article/9133.html">论运维的四化建设 腾讯游戏的实践分享</a></li>
<li><a href="https://en.wikipedia.org/wiki/Configuration_management_database">Configuration Management Database</a></li>
<li><a href="https://github.com/Tencent/bk-cmdb">Github Tencent/bk-cmdb</a></li>
</ul><h1 id="cmdb">业务上线时 CMDB 如何管理主机</h1>
<h2 id="_1">情景</h2>
<p>新业务（常见的三层架构：接入层、逻辑层、存储层）上线，需要用 CMDB 管理业务上线依赖的主机资源，便于后续实现发布、变更、故障处理等场景的自动化流程。</p>
<h2 id="_2">前提条件</h2>
<p>在配置平台中 <a href="5.1/配置平台/快速入门/case1.md">新建完业务</a>，并导入主机及将主机分配到业务中。</p>
<h2 id="_3">操作步骤</h2>
<ul>
<li>梳理业务架构</li>
<li>新建集群</li>
<li>新建模块</li>
<li>使用场景：在作业平台中查询接入层的磁盘使用率</li>
</ul>
<h3 id="1">1. 梳理业务架构</h3>
<p>业务的架构设计最终要体现在 CMDB 的业务拓扑树上，所以我们先梳理业务的架构。</p>
<p>以业务“欢乐游戏( demo )"为例，其架构是常见的三层架构：<code>接入层</code> -&gt; <code>逻辑层</code> -&gt; <code>存储层</code></p>
<p>为了满足全国各地用户就近接入，按照地域划分了不同的区，但架构一致。</p>
<p><img alt="-w758" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/15625775986620.jpg" /></p>
<h3 id="2">2. 新建集群</h3>
<p>按照上述业务架构，可将做如下对应：</p>
<ul>
<li>业务中的区 &lt;-&gt; CMDB 中的集群</li>
<li>业务中的分层架构 &lt;-&gt; CMDB 中模块</li>
</ul>
<p>在<code>业务资源</code> -&gt; <code>业务拓扑</code>中，选中根节点<code>业务</code>，新建节点<code>集群</code>一区。</p>
<p><img alt="-w1396" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/15625781118900.jpg" /></p>
<blockquote>
<p>环境类型：一般保持<code>正式</code>；测试环境设置为<code>测试</code>，让测试环境的发布流程模板只能选择<code>测试</code>集群；</p>
<p>服务状态：一般保持<code>开放</code>，在某些场景如开区准备的时候，状态可置为<code>关闭</code>，让发布系统无法选中；</p>
</blockquote>
<p>新建完集群<code>一区</code>、<code>二区</code>后，可看到如下业务拓扑</p>
<p><img alt="-w1391" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/15625845771786.jpg" /></p>
<p>接下来，在集群下创建模块。</p>
<h3 id="3">3. 新建模块</h3>
<p>选中<code>集群</code>节点，新建模块</p>
<p><img alt="-w1503" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/15625851392280.jpg" /></p>
<blockquote>
<p>模块类型：一般为<code>普通</code>，当模块类型为数据库类时，选择<code>数据库</code>
主要维护人、备份维护人：该模块维护人，一般在告警推送时会用到；区别在于电话通知时优先<code>主要维护人</code>，如果<code>主要维护人</code>未接听，自动转<code>备份维护人</code>，此处逻辑需要自行实现；</p>
</blockquote>
<p>模块创建好了，接下来 <a href="5.1/配置平台/产品功能/BuzResource.md">分配主机</a>，将 <code>基础资源</code> -&gt; <code>主机</code> 中的资源按照业务架构分配至对应的模块；</p>
<p><img alt="-w1447" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/15625859972786.jpg" /></p>
<h3 id="4">4. 使用场景：在作业平台中查询接入层的磁盘使用率</h3>
<p>通过一个简单的场景，体验 <a href="5.1/作业平台/产品介绍/产品介绍.md">作业平台</a> 如何消费主机实例
{% video %}media/cmdb_job_consume.mp4{% endvideo %}</p>
<h2 id="_4">扩展阅读</h2>
<h3 id="1-saas-cmdb">1. 蓝鲸内置 SaaS 的 CMDB 消费场景</h3>
<h4 id="11">1.1 应用发布、变更：资源编排工具 标准运维</h4>
<p>应用发布、变更流程包含版本在多台主机上的文件分发、命令执行等操作，如何优雅的选择这批主机，需要使用 CMDB 的查询主机实例功能。</p>
<p><img alt="CMDB场景-标准运维-01" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/CMDB%E5%9C%BA%E6%99%AF-%E6%A0%87%E5%87%86%E8%BF%90%E7%BB%B4-01.png" /></p>
<p>（在 <a href="5.1/标准运维/README.md">标准运维</a> 中一次应用交付的执行历史）</p>
<p>在参数中使用<code>动态IP</code>变量，<strong>运维无需关心主机扩缩容、故障替换等场景带来的主机变更</strong>，无需担心漏更新主机或更新错主机。
<img alt="标准运维传参-CMDB" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/%E6%A0%87%E5%87%86%E8%BF%90%E7%BB%B4%E4%BC%A0%E5%8F%82-CMDB.png" /></p>
<h4 id="12">1.2 故障处理：监控、故障自愈</h4>
<p>针对业务架构中的某一层级模块（如接入层）设置一个 <a href="5.1/蓝鲸监控/快速入门/服务拨测/uptime_config.md">告警检测策略</a>，无需关心实例的新增、删除及修改。</p>
<p><img alt="蓝鲸监控的CMDB消费场景" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/%E8%93%9D%E9%B2%B8%E7%9B%91%E6%8E%A7%E7%9A%84CMDB%E6%B6%88%E8%B4%B9%E5%9C%BA%E6%99%AF.png" /></p>
<p>如何实现实时感知，背后的逻辑是通过 CMDB 的事件推送功能，实时感知实例的新增、修改、删除等动作。</p>
<p><img alt="事件推送" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/%E4%BA%8B%E4%BB%B6%E6%8E%A8%E9%80%81.png" /></p>
<p>在 <a href="5.1/FTA/Intro/README.md">故障自愈</a> 中的消费场景也是如此，一个或多个模块的某一个告警，关联对应的处理动作。
<img alt="故障自愈的CMDB消费场景" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/%E6%95%85%E9%9A%9C%E8%87%AA%E6%84%88%E7%9A%84CMDB%E6%B6%88%E8%B4%B9%E5%9C%BA%E6%99%AF.png" /></p>
<h4 id="13-dbaaix-sa">1.3 平台团队对资源的管控，例如全业务 DBA、AIX SA</h4>
<p>以 DBA 为例，需要管控所有 DB，可将运行数据库的主机所属模块的类型设置为<code>数据库</code>，然后通过<code>动态分组</code>功能查询模块类型为<code>数据库</code>的主机。</p>
<p><img alt="-w1502" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/15625888898060.jpg" /></p>
<p>在 <a href="5.1/作业平台/产品介绍/产品介绍.md">蓝鲸作业平台</a> 中可使用该动态分组来选择 DB 主机。</p>
<p><img alt="-w1234" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/15625757452328.jpg" /></p>
<h3 id="2_1">2. 三级拓扑不够用，怎么办？新建多级拓扑节点</h3>
<p>如果业务架构在大区（<code>集群</code>）之上还有一级（平台：如<code>Android_Weixin</code>、<code>Android_QQ</code>等）</p>
<p><img alt="-w814" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/15625862638485.jpg" /></p>
<p>可在<code>业务模型</code>中，<code>业务</code>与<code>集群</code>间新建一级或多级拓扑</p>
<p><img alt="-w1163" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/15625750066642.jpg" /></p>
<p>新的业务拓扑如下：</p>
<p><img alt="-w1521" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/15625764667893.jpg" /></p>
<blockquote>
<p>注：当前版本新增层级拓扑的生效范围是所有业务，在未来的某一个版本中可调整生效范围；
蓝鲸体系在未来的某一个迭代中，将重点弱化业务和细化权限</p>
</blockquote>
<h3 id="3-master-db-slave-db">3. Master DB 和 Slave DB 如何实现物理架构的高可用？</h3>
<p>两者一定不要放在同一个机架或交换机下，否则机架或交换机掉电，亦或是交换机故障，Master DB 和 Slave DB 都宕机，无法正常切换，导致业务无法对外提供服务。</p>
<p>操作方法：[模型管理] -&gt; [模型] -&gt; [主机] -&gt; [模型字段]，新增<code>存放机架 ID</code>、<code>网络设备 ID</code>。</p>
<p>此外，配置主机与机架或上联交换机的关联可使用<code>模型关联</code>，确保数据的唯一性可设置<code>唯一校验</code>，另外<code>字段分组</code>可调整 CI 属性的呈现方式。</p>
<p><img alt="-w1569" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/15637891727474.jpg" /></p><h1 id="cmdb">CMDB 如何管理进程</h1>
<h2 id="_1">情景</h2>
<p>应用的存储是 MariaDB，在 CMDB 中注册 MariaDB，以便在监控系统做进程监控。</p>
<h2 id="_2">前提条件</h2>
<p>在配置平台中<a href="5.1/配置平台/快速入门/case1.md">新建业务</a> 及业务拓扑。</p>
<h2 id="_3">步骤</h2>
<ul>
<li>CMDB 中注册进程和端口</li>
<li>将进程绑定模块</li>
<li>监控系统自动实现进程端口监控</li>
</ul>
<h3 id="1-cmdb">1. CMDB 中注册进程</h3>
<p>在菜单<code>业务资源</code>-<code>进程管理</code>中<code>新建进程</code></p>
<p><img alt="-w1300" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/15625715311134.jpg" /></p>
<h4 id="11">1.1 注册进程</h4>
<ul>
<li>进程名称：对外显示的服务名：<code>MariaDB</code>；</li>
<li>功能名称：程序的二进制名称：<code>mysqld</code>；</li>
</ul>
<p>在配置功能名称时，使用命令查询该程序的二进制名称</p>
<div class="codehilite"><pre><span></span>$ ps -ef <span class="p">|</span> grep -i mysqld
mysql     <span class="m">7800</span>     <span class="m">1</span>  <span class="m">0</span> 7月08 ?       <span class="m">00</span>:00:00 /bin/sh /usr/bin/mysqld_safe --basedir<span class="o">=</span>/usr
mysql     <span class="m">7980</span>  <span class="m">7800</span>  <span class="m">0</span> 7月08 ?       <span class="m">00</span>:01:55 /usr/libexec/mysqld --basedir<span class="o">=</span>/usr --datadir<span class="o">=</span>/var/lib/mysql --plugin-dir<span class="o">=</span>/usr/lib64/mysql/plugin --log-error<span class="o">=</span>/var/log/mariadb/mariadb.log --pid-file<span class="o">=</span>/var/run/mariadb/mariadb.pid --socket<span class="o">=</span>/var/lib/mysql/mysql.sock
</pre></div>


<blockquote>
<p>注：监控系统一般<code>完全匹配</code>二进制名称。
   获取二进制名称的方法：<code>basename $(readlink -f /proc/7980/exe)</code></p>
</blockquote>
<h4 id="12">1.2 注册端口</h4>
<p>查询 mysqld 监听的 IP 和端口</p>
<div class="codehilite"><pre><span></span>$ netstat -antp <span class="p">|</span> grep mysqld
tcp        <span class="m">0</span>      <span class="m">0</span> <span class="m">10</span>.0.4.29:3306          <span class="m">0</span>.0.0.0:*               LISTEN      <span class="m">7980</span>/mysqld
</pre></div>


<ul>
<li>绑定 IP：MariaDB 为存储层，一般绑定内网 IP，故选择<code>第一内网 IP</code>。</li>
<li>端口：进程监听的端口，<code>3306</code></li>
<li>协议：<code>TCP</code></li>
</ul>
<h3 id="2">2. 将进程绑定模块</h3>
<p><a href="5.1/bk_solutions/CD/CMDB/CMDB_management_hosts.md">如何管理主机</a> 提到依据业务架构来划分业务拓扑，业务拓扑中模块代表服务，而服务将由一个或多个进程监听的端口来对用户或其他模块提供服务。</p>
<p>所以，需要将<code>进程</code>绑定至对应的<code>模块</code>上。</p>
<p>这里将<code>MariaDB</code>进程绑定至存储层模块上。</p>
<p><img alt="-w1273" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/15625579982411.jpg" /></p>
<h3 id="3">3. 监控系统自动实现进程端口监控</h3>
<p>给模块 <a href="5.1/配置平台/快速入门/case1.md">分配主机</a></p>
<p><img alt="-w1541" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/15625580245427.jpg" /></p>
<p>等候一分钟，在蓝鲸自带的监控系统 <a href="5.1/蓝鲸监控/产品简介/README.md">蓝鲸监控</a> 中可以看到 <a href="5.1/蓝鲸监控/产品功能/Process_monitor_desc.md">进程的运行情况</a>。</p>
<p><img alt="-w1570" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/15632804527438.jpg" /></p>
<p>点击 MariaDB 图标，可以查看其占用的 CPU、内存使用率以及文件句柄数等进程占用的资源指标。</p>
<p><img alt="-w1249" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/15626645050893.jpg" /></p>
<h2 id="_4">扩展阅读</h2>
<h3 id="1-cmdb_1">1. 监控系统消费 CMDB 中进程配置背后的逻辑</h3>
<p>当给模块分配完主机后，该主机的大部分 CI 属性将被自动推送至<code>/var/lib/gse/host/hostid</code></p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
  <span class="err">.....</span>
     <span class="nt">&quot;process&quot;</span> <span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span>
         <span class="nt">&quot;bind_ip&quot;</span> <span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span>
         <span class="nt">&quot;bind_modules&quot;</span> <span class="p">:</span> <span class="p">[</span> <span class="mi">68</span> <span class="p">],</span>
         <span class="nt">&quot;bk_func_id&quot;</span> <span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
         <span class="nt">&quot;bk_func_name&quot;</span> <span class="p">:</span> <span class="s2">&quot;mysqld&quot;</span><span class="p">,</span>  <span class="err">//</span> <span class="err">对应功能名称</span>
         <span class="nt">&quot;bk_process_id&quot;</span> <span class="p">:</span> <span class="mi">110</span><span class="p">,</span>
         <span class="nt">&quot;bk_process_name&quot;</span> <span class="p">:</span> <span class="s2">&quot;MariaDB&quot;</span><span class="p">,</span>  <span class="err">//</span> <span class="err">对应进程名称</span>
         <span class="nt">&quot;bk_start_param_regex&quot;</span> <span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
         <span class="nt">&quot;port&quot;</span> <span class="p">:</span> <span class="s2">&quot;3306&quot;</span><span class="p">,</span>
         <span class="nt">&quot;protocol&quot;</span> <span class="p">:</span> <span class="s2">&quot;1&quot;</span>
      <span class="p">}</span>
   <span class="p">]</span>
<span class="p">}</span>
</pre></div>


<p>蓝鲸内置的进程监控采集器<code>processbeat</code>会读取该文件，并写入自身的配置文件<code>/usr/local/gse/plugins/etc/processbeat.conf</code>，以实现进程和端口的监控。</p>
<div class="codehilite"><pre><span></span><span class="l l-Scalar l-Scalar-Plain">......</span>
<span class="l l-Scalar l-Scalar-Plain">processbeat.processes</span><span class="p p-Indicator">:</span>
<span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mysqld // 二进制名称</span>
  <span class="nt">displayname</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">MariaDB</span>
  <span class="nt">protocol</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">tcp</span>
  <span class="nt">ports</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">3306</span>
  <span class="nt">paramregex</span><span class="p">:</span> <span class="s">&quot;&quot;</span>
  <span class="nt">bindip</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">10.0.4.29</span>
</pre></div>


<h3 id="2-java">2. 二进制名称均为 java，该如何配置</h3>
<p>如 ZooKeeper、Hadoop 的二进制均为<code>java</code>，可用进程启动参数区分</p>
<div class="codehilite"><pre><span></span>$ ps -ef <span class="p">|</span> grep -i zookeeper

root      <span class="m">4872</span>     <span class="m">1</span>  <span class="m">0</span> May11 ?        <span class="m">14</span>:05:34 /data/bkee/service/java/bin/java -Dzookeeper.log.dir<span class="o">=</span>/data/bkee/logs/zk/ -Dzookeeper.root.logger<span class="o">=</span>INFO,ROLLINGFILE -Dzookeeper.DigestAuthenticationProvider.superDigest<span class="o">=</span>bkadmin:1bF5dHUwvnyrhMDaPLkHwFS1JOg<span class="o">=</span> -cp /data/bkee/service/zk/bin/../build/classes:/data/bkee/service/zk/bin/../build/lib/*.jar:/data/bkee/service/zk/bin/../lib/slf4j-log4j12-1.6.1.jar:/data/bkee/service/zk/bin/../lib/slf4j-api-1.6.1.jar:/data/bkee/service/zk/bin/../lib/netty-3.10.5.Final.jar:/data/bkee/service/zk/bin/../lib/log4j-1.2.16.jar:/data/bkee/service/zk/bin/../lib/jline-0.9.94.jar:/data/bkee/service/zk/bin/../zookeeper-3.4.10.jar:/data/bkee/service/zk/bin/../src/java/lib/*.jar:/data/bkee/etc:/data/bkee/service/zk/conf:/data/bkee/service/java/lib: -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.local.only<span class="o">=</span><span class="nb">false</span> org.apache.zookeeper.server.quorum.QuorumPeerMain /data/bkee/etc/zoo.cfg


ps -ef <span class="p">|</span> grep -i kafka
root      <span class="m">5707</span>     <span class="m">1</span>  <span class="m">3</span> May11 ?        <span class="m">1</span>-22:34:50 /data/bkee/service/java/bin/java -Xmx1G -Xms1G -server -XX:+UseG1GC -XX:MaxGCPauseMillis<span class="o">=</span><span class="m">20</span> -XX:InitiatingHeapOccupancyPercent<span class="o">=</span><span class="m">35</span> -XX:+DisableExplicitGC -Djava.awt.headless<span class="o">=</span><span class="nb">true</span> -Xloggc:/data/bkee/logs/kafka/kafkaServer-gc.log -verbose:gc -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintGCTimeStamps -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.authenticate<span class="o">=</span><span class="nb">false</span> -Dcom.sun.management.jmxremote.ssl<span class="o">=</span><span class="nb">false</span> -Dkafka.logs.dir<span class="o">=</span>/data/bkee/logs/kafka -Dlog4j.configuration<span class="o">=</span>file:./../config/log4j.properties -cp /data/bkee/service/java/lib::/data/bkee/service/kafka/bin/../libs/aopalliance-repackaged-2.5.0-b05.jar:/data/bkee/service/kafka/bin/../libs/argparse4j-0.7.0.jar:/data/bkee/service/kafka/bin/../libs/connect-api-0.10.2.0.jar:/data/bkee/service/kafka/bin/../libs/connect-file-0.10.2.0.jar:/data/bkee/service/kafka/bin/../libs/connect-json-0.10.2.0.jar:/data/bkee/service/kafka/bin/../libs/connect-runtime-0.10.2.0.jar:/data/bkee/service/kafka/bin/../libs/connect-transforms-0.10.2.0.jar:/data/bkee/service/kafka/bin/../libs/guava-18.0.jar:/data/bkee/service/kafka/bin/../libs/hk2-api-2.5.0-b05.jar:/data/bkee/service/kafka/bin/../libs/hk2-locator-2.5.0-b05.jar:/data/bkee/service/kafka/bin/../libs/hk2-utils-2.5.0-b05.jar:/data/bkee/service/kafka/bin/../libs/jackson-annotations-2.8.0.jar:/data/bkee/service/kafka/bin/../libs/jackson-annotations-2.8.5.jar:/data/bkee/service/kafka/bin/../libs/jackson-core-2.8.5.jar:/data/bkee/service/kafka/bin/../libs/jackson-databind-2.8.5.jar:/data/bkee/service/kafka/bin/../libs/jackson-jaxrs-base-2.8.5.jar:/data/bkee/service/kafka/bin/../libs/jackson-jaxrs-json-provider-2.8.5.jar:/data/bkee/service/kafka/bin/../libs/jackson-module-jaxb-annotations-2.8.5.jar:/data/bkee/service/kafka/bin/../libs/javassist-3.20.0-GA.jar:/data/bkee/service/kafka/bin/../libs/javax.annotation-api-1.2.jar:/data/bkee/service/kafka/bin/../libs/javax.inject-1.jar:/data/bkee/service/kafka/bin/../libs/javax.inject-2.5.0-b05.jar:/data/bkee/service/kafka/bin/../libs/javax.servlet-api-3.1.0.jar:/data/bkee/service/kafka/bin/../libs/javax.ws.rs-api-2.0.1.jar:/data/bkee/service/kafka/bin/../libs/jersey-client-2.24.jar:/data/bkee/service/kafka/bin/../libs/jersey-common-2.24.jar:/data/bkee/service/kafka/bin/../libs/jersey-container-servlet-2.24.jar:/data/bkee/service/kafka/bin/../libs/jersey-container-servlet-core-2.24.jar:/data/bkee/service/kafka/bin/../libs/jersey-guava-2.24.jar:/data/bkee/service/kafka/bin/../libs/jersey-media-jaxb-2.24.jar:/data/bkee/service/kafka/bin/../libs/jersey-server-2.24.jar:/data/bkee/service/kafka/bin/../libs/jetty-continuation-9.2.15.v20160210.jar:/data/bkee/service/kafka/bin/../libs/jetty-http-9.2.15.v20160210.jar:/data/bkee/service/kafka/bin/../libs/jetty-io-9.2.15.v20160210.jar:/data/bkee/service/kafka/bin/../libs/jetty-security-9.2.15.v20160210.jar:/data/bkee/service/kafka/bin/../libs/jetty-server-9.2.15.v20160210.jar:/data/bkee/service/kafka/bin/../libs/jetty-servlet-9.2.15.v20160210.jar:/data/bkee/service/kafka/bin/../libs/jetty-servlets-9.2.15.v20160210.jar:/data/bkee/service/kafka/bin/../libs/jetty-util-9.2.15.v20160210.jar:/data/bkee/service/kafka/bin/../libs/jopt-simple-5.0.3.jar:/data/bkee/service/kafka/bin/../libs/kafka_2.12-0.10.2.0.jar:/data/bkee/service/kafka/bin/../libs/kafka_2.12-0.10.2.0-sources.jar:/data/bkee/service/kafka/bin/../libs/kafka_2.12-0.10.2.0-test-sources.jar:/data/bkee/service/kafka/bin/../libs/kafka-clients-0.10.2.0.jar:/data/bkee/service/kafka/bin/../libs/kafka-log4j-appender-0.10.2.0.jar:/data/bkee/service/kafka/bin/../libs/kafka-streams-0.10.2.0.jar:/data/bkee/service/kafka/bin/../libs/kafka-streams-examples-0.10.2.0.jar:/data/bkee/service/kafka/bin/../libs/kafka-tools-0.10.2.0.jar:/data/bkee/service/kafka/bin/../libs/log4j-1.2.17.jar:/data/bkee/service/kafka/bin/../libs/lz4-1.3.0.jar:/data/bkee/service/kafka/bin/../libs/metrics-core-2.2.0.jar:/data/bkee/service/kafka/bin/../libs/osgi-resource-locator-1.0.1.jar:/data/bkee/service/kafka/bin/../libs/reflections-0.9.10.jar:/data/bkee/service/kafka/bin/../libs/rocksdbjni-5.0.1.jar:/data/bkee/service/kafka/bin/../libs/scala-library-2.12.1.jar:/data/bkee/service/kafka/bin/../libs/scala-parser-combinators_2.12-1.0.4.jar:/data/bkee/service/kafka/bin/../libs/slf4j-api-1.7.21.jar:/data/bkee/service/kafka/bin/../libs/slf4j-log4j12-1.7.21.jar:/data/bkee/service/kafka/bin/../libs/snappy-java-1.1.2.6.jar:/data/bkee/service/kafka/bin/../libs/validation-api-1.1.0.Final.jar:/data/bkee/service/kafka/bin/../libs/zkclient-0.10.jar:/data/bkee/service/kafka/bin/../libs/zookeeper-3.4.9.jar kafka.Kafka ../config/server.properties
</pre></div>


<p>进程的功能名称均为<code>java</code>，<code>启动参数匹配规则</code>中分别输入<code>zookeeper</code>、<code>kafka</code>即可.</p><h1 id="mysql">管理数据库/中间件实例：以 MySQL 为例</h1>
<h2 id="_1">情景</h2>
<p>应用使用的存储是 MySQL，为了便于 MySQL 的日常维护（如 SQL 变更），需要在 CMDB 中创建 MySQL CI 对象，录入 MySQL 实例。</p>
<blockquote>
<p>蓝鲸 CMDB 拥有灵活的 CI 能力，掌握该教程后，可以管理数据库、中间件、硬件等 CI 对象</p>
</blockquote>
<h2 id="_2">前提条件</h2>
<p>在配置平台中 <a href="5.1/配置平台/快速入门/case1.md">新建好业务</a>，并 定义拓扑及分配主机。</p>
<p><strong>术语解释</strong>
 - <strong>CI</strong> : (Configuration Items)，资源对象，如 <code>MySQL</code>、主机、交易系统、交换机、路由器等
 - <strong>CI 属性</strong> : (Configuration Items Attribute)，资源对象的配置属性，如 MySQL CI 属性为实例名、IP、端口、存储引擎、数据库版本等
 - <strong>CI 实例</strong> : CI 的实例化，唯一识别一个资源对象，如 MySQL CI 实例为<code>gd_area_master_01</code></p>
<h2 id="_3">操作步骤</h2>
<ul>
<li>梳理 : 梳理 MySQL CI 属性</li>
<li>建模 : 创建 MySQL CI 对象</li>
<li>实例化 : 添加 MySQL 实例</li>
</ul>
<h3 id="1-mysql-ci">1. 梳理 MySQL CI 属性</h3>
<p>根据消费 MySQL 的场景，梳理 MySQL 常见的 CI 属性。</p>
<table>
   <tr>
      <td>字段分组</td>
      <td>字段中文名</td>
      <td>字段英文名</td>
      <td>字段类型</td>
      <td>录入方式</td>
      <td>是否唯一</td>
      <td>是否必填</td>
   </tr>
   <tr>
      <td rowspan=11>基本信息</td>
      <td>实例名</td>
      <td>bk_inst_name</td>
      <td>短字符</td>
      <td>自动</td>
      <td>是</td>
      <td>是</td>
   </tr>
   <tr>
      <td>IP地址</td>
      <td>ip_addr</td>
      <td>短字符</td>
      <td>自动</td>
      <td>是</td>
      <td>是</td>
   </tr>
   <tr>
      <td>端口</td>
      <td>port</td>
      <td>数字</td>
      <td>自动</td>
      <td>是</td>
      <td>是</td>
   </tr>
   <tr>
      <td>数据库版本</td>
      <td>version</td>
      <td>短字符</td>
      <td>自动</td>
      <td></td>
      <td></td>
   </tr>
   <tr>
      <td>安装路径</td>
      <td>install_dir</td>
      <td>长字符</td>
      <td>自动</td>
      <td></td>
      <td></td>
   </tr>
   <tr>
      <td>数据库文件路径</td>
      <td>dbfile_dir</td>
      <td>长字符</td>
      <td>自动</td>
      <td></td>
      <td></td>
   </tr>
   <tr>
      <td>是否开启binlog</td>
      <td>enable_binlog</td>
      <td>枚举</td>
      <td>自动</td>
      <td></td>
      <td></td>
   </tr>
   <tr>
      <td>是否开启慢查询日志</td>
      <td>enable_slowlog</td>
      <td>枚举</td>
      <td>自动</td>
      <td></td>
      <td></td>
   </tr>
   <tr>
      <td>字符集</td>
      <td>chart_set</td>
      <td>短字符</td>
      <td>自动</td>
      <td></td>
      <td></td>
   </tr>
   <tr>
      <td>存储引擎</td>
      <td>storage_engine</td>
      <td>短字符</td>
      <td>自动</td>
      <td></td>
      <td></td>
   </tr>
   <tr>
      <td>数据库大小</td>
      <td>db_size</td>
      <td>数字</td>
      <td>自动</td>
      <td></td>
      <td></td>
   </tr>
   <tr>
      <td rowspan=6>核心参数</td>
      <td>innodb缓存池大小</td>
      <td>innodb_buffer_pool_size</td>
      <td>数字</td>
      <td>自动</td>
      <td></td>
      <td></td>
   </tr>
   <tr>
      <td>innodb日志缓存大小</td>
      <td>innodb_log_buffer_size</td>
      <td>数字</td>
      <td>自动</td>
      <td></td>
      <td></td>
   </tr>
   <tr>
      <td>innodb日志磁盘写入策略</td>
      <td>innodb_flush_log_at_trx_commit</td>
      <td>短字符</td>
      <td>自动</td>
      <td></td>
      <td></td>
   </tr>
   <tr>
      <td>线程缓存大小</td>
      <td>thread_cache_size</td>
      <td>数字</td>
      <td>自动</td>
      <td></td>
      <td></td>
   </tr>
   <tr>
      <td>查询缓存大小</td>
      <td>query_cache_size</td>
      <td>数字</td>
      <td>自动</td>
      <td></td>
      <td></td>
   </tr>
   <tr>
      <td>最大连接数</td>
      <td>max_connections</td>
      <td>数字</td>
      <td>自动</td>
      <td></td>
      <td></td>
   </tr>
</table>

<p>其中，CI 属性自动录入参考<a href="5.1/bk_solutions/CD/CMDB/CMDB_CI_auto_discovery_MySQL.md">自动发现 MySQL 实例</a>。</p>
<p>通过<code>实例名</code>可以唯一标识一个 MySQL 实例，具体是<code>IP</code>和<code>端口</code>的组合。</p>
<h3 id="2-mysql-ci">2. 创建 MySQL CI 对象</h3>
<p>第一步梳理完 MySQL CI 属性后，接下来开始建模：创建 MySQL CI。</p>
<h4 id="21-ci">2.1 创建 CI</h4>
<p>选择<code>模型管理</code>中选择<code>模型</code>，创建 MySQL 模型。</p>
<p><img alt="-w992" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/15632800013005.jpg" /></p>
<h4 id="22-ci">2.2 新增 CI 属性</h4>
<p>按照梳理 MySQL CI 属性 中梳理的结果来添加 CI 属性。</p>
<p><img alt="-w1676" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/15637992522730.jpg" /></p>
<p>如果手工操作繁琐，也可以导入一个 MySQL 模型示例。</p>
<h4 id="23-ci">2.3 设立 CI 关联</h4>
<p>针对 MySQL 的管理，除了 CI 属性外，我们同时还关心 MySQL 运行在哪台主机上，所以需要在模型中新建一个“主机上运行 MySQL”的关联。</p>
<p>1 个主机可以运行多个 MySQL 实例，所以<code>源到目标的约束条件</code>为“ 1-N ”</p>
<p><img alt="-w1239" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/15633674736247.jpg" /></p>
<h4 id="24">2.4 新增唯一校验</h4>
<p>通过<code>实例名</code>可以唯一标识一个 MySQL 实例，具体是<code>IP</code>和<code>端口</code>的组合，所以将 IP 和端口作为一个组合校验。</p>
<p><img alt="-w1220" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/15633674062813.jpg" /></p>
<h3 id="3-mysql">3. 添加 MySQL 实例</h3>
<p>完成 MySQL CI 的建模之后，接下来添加 MySQL 实例</p>
<h4 id="31-ci">3.1 新增或导入 CI 实例</h4>
<p>从首页进入 MySQL 实例列表页</p>
<p><img alt="-w1580" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/15643140385105.jpg" /></p>
<p>点击<code>新建</code>按钮，按提示添加 MySQL 实例，也可以批量导入 MySQL 实例。</p>
<p><img alt="-w1399" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/15637993409385.jpg" /></p>
<h4 id="32-ci">3.2 创建 CI 实例的关联关系</h4>
<p>打开一个 MySQL 实例的详情页，点击<code>关联</code> TAB 中的<code>关联管理</code>，<code>关联</code>当前实例运行在哪台主机上。</p>
<p><img alt="-w1398" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/15637993763312.jpg" /></p>
<p>再次点击<code>关联管理</code>，可预览 MySQL 实例与主机的关联关系。</p>
<p><img alt="-w1320" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/15643143202999.jpg" /></p>
<p>如果参照本篇教程将<code>机架</code>、<code>交换机</code>、<code>机房管理单元</code>、<code>数据中心</code>等 IT 基础设施均录入 CMDB 中，将可以查询一个 MySQL 实例完整的关联关系。</p>
<p><img alt="-w1397" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/15637996905990.jpg" /></p><h1 id="mysql">自动发现数据库实例：以 MySQL 为例</h1>
<blockquote>
<p>感谢 <a href="http://www.canwayit.com/tech/index.html">嘉为科技</a> 贡献该文档.</p>
</blockquote>
<h2 id="_1">情景</h2>
<p>业务存储层是 MySQL，通过蓝鲸 CMDB 已管理 MySQL 实例，然而却是手工维护，难以长期维护。需要通过自动化的方式实现，自动发现 MySQL 实例、 MySQL CI 属性以及关联关系。</p>
<h2 id="_2">前提条件</h2>
<ol>
<li>提前导入或录入 MySQL CI 、创建模型（不是实例）的关联关系，详见：<a href="5.1/bk_solutions/CD/CMDB/CMDB_management_database_middleware.md">如何管理数据库实例:以 MySQL 为例</a></li>
<li>在蓝鲸开发者中心 <a href="5.1/开发指南/SaaS开发/新手入门/Windows.md">新建一个应用</a>，用于调用 <a href="5.1/API文档/CC/README.md">CMDB 的 API</a></li>
<li>提供一个运维权限的账号以及 CMDB 的主机 IP 和端口,用于执行 JOB 作业</li>
<li>创建查询 MySQL CI 属性的账号</li>
</ol>
<div class="codehilite"><pre><span></span>     sudo mysql -e <span class="s2">&quot;CREATE USER &#39;bk&#39;@&#39;{YOUR_MYSQL_IP}&#39; IDENTIFIED BY &#39;{PASSWORD_FOR_BK_QUERY}&#39;;&quot;</span>
     sudo mysql -e <span class="s2">&quot;GRANT PROCESS, REPLICATION CLIENT ON *.* TO &#39;bk&#39;@&#39;{YOUR_MYSQL_IP}&#39; WITH MAX_USER_CONNECTIONS 5;&quot;</span>
     sudo mysql -e <span class="s2">&quot;GRANT SELECT ON performance_schema.* TO &#39;bk&#39;@&#39;{YOUR_MYSQL_IP}&#39;;&quot;</span>
</pre></div>


<h2 id="_3">操作步骤</h2>
<ul>
<li>梳理自动发现逻辑</li>
<li>代码解读（含样例脚本）</li>
<li>测试效果</li>
</ul>
<h3 id="_4">视频教程</h3>
<p>{% video %}media/cmdb_mysql_autodiscovery.mp4{% endvideo %}</p>
<h3 id="1">1.梳理自动发现逻辑</h3>
<ul>
<li><strong>自动发现 MySQL 实例</strong>：调用作业平台的快速脚本执行 API，在 MySQL 所在的主机上执行 ps 命令发现 MySQL 实例，调用 CMDB 的 API 创建实例。</li>
<li><strong>自动发现  MySQL CI  属性</strong>：调用 CMDB 获取实例的 API，获取 MySQL 实例所在的主机，调用作业平台的快速脚本执行 API，执行 SQL 语句查询 MySQL 属性，并调用 CMDB API 更新实例。</li>
<li><strong>自动发现 MySQL 与所在主机的关联关系</strong>：调用 CMDB 查询实例 API 找出 MySQL 实例对应主机，创建关联关系。</li>
</ul>
<h3 id="2">2. 代码解读（含样例脚本）</h3>
<h4 id="21-mysql">2.1 自动发现 MySQL 实例</h4>
<ul>
<li>通过 <code>ps</code> 命令获取 <code>mysql</code> 的 <code>进程ID</code></li>
<li>通过 <code>netstat</code> 命令，根据 <code>进程ID</code> 获得 <code>mysql端口</code> 号</li>
<li>调用 <code>CMDB</code> 创建实例的接口，将发现到的实例存入 <code>CMDB</code></li>
</ul>
<div class="codehilite"><pre><span></span><span class="ch">#! /usr/bin/env python</span>
<span class="c1"># -*-coding:utf-8-*-</span>

<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
<span class="nb">reload</span><span class="p">(</span><span class="n">sys</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">setdefaultencoding</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>

<span class="n">BK_PAAS_HOST</span> <span class="o">=</span> <span class="s1">&#39;http://&#39;</span>   <span class="c1"># 蓝鲸 PaaS 地址，例如https://paas.blueking.com/</span>
<span class="n">BK_APP_CODE</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>  <span class="c1"># 用于调用蓝鲸CMDB API 的 SaaS账号</span>
<span class="n">BK_APP_TOKEN</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="c1"># 用于调用蓝鲸CMDB API 的 SaaS Token</span>
<span class="n">BK_USERNAME</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="c1"># 拥有业务运维权限的蓝鲸账号</span>
<span class="n">BK_BIZ_ID</span> <span class="o">=</span>   <span class="c1"># 业务 ID，在哪个业务下发现 MySQL 实例</span>
<span class="n">BK_OBJ_ID</span> <span class="o">=</span> <span class="s1">&#39;mysql&#39;</span>  <span class="c1">#  MySQL CI 名</span>
<span class="n">BK_CMDB_HOST</span> <span class="o">=</span> <span class="s1">&#39;http://{CMDB_HOST}:33031&#39;</span>  <span class="c1"># 在蓝鲸业务下查看配置平台的主机IP或在install.config中 cmdb 对应的 IP</span>
<span class="n">MYSQL_HOST_IP</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>  <span class="c1"># 此处最好自行编写代码来获取 MySQL的IP</span>
<span class="n">MYSQL_USERNAME</span> <span class="o">=</span> <span class="s1">&#39;bk&#39;</span>  <span class="c1"># 查询 MySQL CI 属性的 MySQL 账号</span>
<span class="n">MYSQL_PASSWORD</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="c1"># 查询 MySQL CI 属性的 MySQL 密码</span>
<span class="n">MYSQL_OS_ACCOUNT</span> <span class="o">=</span> <span class="s1">&#39;root&#39;</span>   <span class="c1"># 执行 JOB 作业的操作系统账号，用于发现 MySQL 实例、CI属性、关联关系</span>

<span class="c1"># 自动发现MySQL</span>
<span class="k">class</span> <span class="nc">CoverMysql</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bk_biz_id</span> <span class="o">=</span> <span class="n">BK_BIZ_ID</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job</span> <span class="o">=</span> <span class="n">JobMan</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cover_ips</span> <span class="o">=</span> <span class="n">MYSQL_HOST_IP</span>

    <span class="k">def</span> <span class="nf">start_cover</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ip_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_ip_list</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ip_list</span><span class="o">.</span><span class="fm">__len__</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;bk_biz_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bk_biz_id</span><span class="p">,</span>
            <span class="s2">&quot;script_content&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_script</span><span class="p">(),</span>
            <span class="s2">&quot;script_timeout&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
            <span class="s2">&quot;account&quot;</span><span class="p">:</span> <span class="n">MYSQL_OS_ACCOUNT</span><span class="p">,</span>
            <span class="s2">&quot;script_type&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;ip_list&quot;</span><span class="p">:</span> <span class="n">ip_list</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">fast_execute_sql</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ip_list</span><span class="p">:</span>
            <span class="n">res</span><span class="p">,</span> <span class="n">log_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">get_log</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;ip&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">log_content</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_inst_data</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;ip&#39;</span><span class="p">],</span> <span class="n">proc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_inst</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_inst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">BK_PAAS_HOST</span> <span class="o">+</span> <span class="s1">&#39;/api/c/compapi/v2/cc/create_inst/&#39;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;bk_app_code&quot;</span><span class="p">:</span> <span class="n">BK_APP_CODE</span><span class="p">,</span>
            <span class="s2">&quot;bk_app_secret&quot;</span><span class="p">:</span> <span class="n">BK_APP_TOKEN</span><span class="p">,</span>
            <span class="s2">&quot;bk_username&quot;</span><span class="p">:</span> <span class="n">BK_USERNAME</span><span class="p">,</span>
            <span class="s2">&quot;bk_obj_id&quot;</span><span class="p">:</span> <span class="n">BK_OBJ_ID</span><span class="p">,</span>
            <span class="s2">&quot;bk_supplier_account&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span>
        <span class="p">}</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">)</span>
        <span class="n">rp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">params</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;请求失败&#39;</span><span class="p">)</span>

    <span class="c1"># 查询主机</span>
    <span class="k">def</span> <span class="nf">search_ip_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">BK_PAAS_HOST</span> <span class="o">+</span> <span class="s1">&#39;/api/c/compapi/v2/cc/search_host/&#39;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;bk_app_code&quot;</span><span class="p">:</span> <span class="n">BK_APP_CODE</span><span class="p">,</span>
            <span class="s2">&quot;bk_app_secret&quot;</span><span class="p">:</span> <span class="n">BK_APP_TOKEN</span><span class="p">,</span>
            <span class="s2">&quot;bk_username&quot;</span><span class="p">:</span> <span class="n">BK_USERNAME</span><span class="p">,</span>
            <span class="s2">&quot;bk_supplier_account&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bk_biz_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">bk_biz_id</span><span class="p">,</span>
            <span class="s2">&quot;condition&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;bk_obj_id&quot;</span><span class="p">:</span> <span class="s2">&quot;host&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="s2">&quot;condition&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;operator&#39;</span><span class="p">:</span> <span class="s1">&#39;$eq&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;field&#39;</span><span class="p">:</span> <span class="s1">&#39;bk_os_type&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;1&#39;</span>  <span class="c1"># 查询linux主机</span>
                        <span class="p">},</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;operator&#39;</span><span class="p">:</span> <span class="s1">&#39;$in&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;field&#39;</span><span class="p">:</span> <span class="s1">&#39;bk_host_innerip&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cover_ips</span>  
                        <span class="p">}</span>                 
                    <span class="p">]</span>
                <span class="p">},</span>
            <span class="p">],</span>
        <span class="p">}</span>
        <span class="n">rp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">params</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;请求失败&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">rp</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;查询主机失败&#39;</span><span class="p">)</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;info&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[{</span>
            <span class="s2">&quot;bk_cloud_id&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">][</span><span class="s1">&#39;bk_cloud_id&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;bk_inst_id&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">][</span><span class="s1">&#39;bk_cloud_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="fm">__len__</span><span class="p">()</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;ip&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">][</span><span class="s1">&#39;bk_host_innerip&#39;</span><span class="p">]</span>
        <span class="p">}</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">info</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_make_inst_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">proc</span><span class="p">):</span>
        <span class="n">port</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;port&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">inst_name</span> <span class="o">=</span> <span class="s1">&#39;{0}-{1}-{2}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">BK_OBJ_ID</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;ip_addr&#39;</span><span class="p">:</span> <span class="n">ip</span><span class="p">,</span>
            <span class="s1">&#39;bk_inst_name&#39;</span><span class="p">:</span> <span class="n">inst_name</span><span class="p">,</span>
            <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="n">port</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">_mysql_script</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">script</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;&quot;&quot;#!/bin/bash</span>
<span class="s2"># 获取进程端口号</span>
<span class="s2">Get_Port_Join_Str(){</span>
<span class="s2">    port_arr_str=$(netstat -ntlp | grep $1 |awk &#39;{print $4}&#39;|awk -F &#39;:&#39; &#39;{print $NF}&#39;|sed &#39;s/ *$//g&#39;|sed &#39;s/^ *//g&#39;|sort|uniq)</span>
<span class="s2">    if [ -z &quot;$port_arr_str&quot; ];then</span>
<span class="s2">        continue</span>
<span class="s2">    fi</span>
<span class="s2">    port_str=&quot;&quot;</span>
<span class="s2">    for port in ${port_arr_str[@]}</span>
<span class="s2">    do</span>
<span class="s2">        if [ -n &quot;$port_str&quot; ];then</span>
<span class="s2">            port_str=${port_str},${port}</span>
<span class="s2">        else</span>
<span class="s2">            port_str=${port}</span>
<span class="s2">        fi</span>
<span class="s2">    done</span>
<span class="s2">}</span>

<span class="s2">Get_Soft_Pid(){</span>
<span class="s2">    i=0</span>
<span class="s2">    soft_pid=()</span>
<span class="s2">    pid_arr=$(ps -ef | grep -v grep | grep -i $1 |awk &#39;{print $2}&#39; )</span>
<span class="s2">    for pid in ${pid_arr[@]}</span>
<span class="s2">    do</span>
<span class="s2">         # 过滤掉端口不存在的进程</span>
<span class="s2">        port_str=$(netstat -ntlp | grep -w $pid)</span>
<span class="s2">        if [ -z &quot;$port_str&quot; ];then</span>
<span class="s2">            continue</span>
<span class="s2">        fi</span>
<span class="s2">         # 过滤掉不是mysql的进程</span>
<span class="s2">        is_mysql=$($(readlink /proc/$pid/exe) -V 2&gt;/dev/null|grep -i mysql)</span>
<span class="s2">        if [ -z &quot;$is_mysql&quot; ];then</span>
<span class="s2">            continue</span>
<span class="s2">        fi</span>
<span class="s2">        # 过滤掉蓝鲸sass 进程</span>
<span class="s2">        userId=$(ps -ef | grep $1 | grep -w $pid | grep -v grep | awk &#39;{print $1}&#39;)</span>
<span class="s2">        if [[ &quot;$userId&quot; == &quot;apps&quot; ]];then</span>
<span class="s2">            continue</span>
<span class="s2">        fi</span>
<span class="s2">        # 筛选后的pid</span>
<span class="s2">        soft_pid[$i]=$pid</span>
<span class="s2">        i=$(expr $i + 1)</span>
<span class="s2">    done</span>
<span class="s2">}</span>

<span class="s2">Cover_Mysql(){</span>
<span class="s2">    condition=mysql</span>
<span class="s2">    Get_Soft_Pid $condition</span>
<span class="s2">    for pid in ${soft_pid[@]}</span>
<span class="s2">    do</span>
<span class="s2">        Get_Port_Join_Str $pid</span>
<span class="s2">        exe_path=$(readlink /proc/$pid/exe)</span>
<span class="s2">        echo {&#39;&quot;&#39;port&#39;&quot;&#39;: &#39;&quot;&#39;$port_str&#39;&quot;&#39;}</span>
<span class="s2">    done</span>
<span class="s2">}</span>
<span class="s2">Cover_Mysql</span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
</pre></div>


<h4 id="22-mysql-ci">2.2 自动采集 MySQL CI 属性</h4>
<ul>
<li>获取 CMDB 中 MySQL 的实例</li>
<li>根据 MySQL 中的 IP，调用作业平台执行脚本，采集配置信息</li>
<li>调用 CMDB 更新实例接口, 将采集到的配置信息保存到 CMDB 中</li>
</ul>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">CollectMysql</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job</span> <span class="o">=</span> <span class="n">JobMan</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cred</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="n">MYSQL_USERNAME</span><span class="p">,</span>
            <span class="s1">&#39;password&#39;</span><span class="p">:</span> <span class="n">MYSQL_PASSWORD</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">start_collect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">insts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_inst</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">inst</span> <span class="ow">in</span> <span class="n">insts</span><span class="p">:</span>
            <span class="n">hosts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_host</span><span class="p">(</span><span class="n">inst</span><span class="p">[</span><span class="s1">&#39;ip_addr&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">hosts</span><span class="o">.</span><span class="fm">__len__</span><span class="p">():</span>
                <span class="k">print</span> <span class="sa">u</span><span class="s1">&#39;主机不存在&#39;</span>
                <span class="k">continue</span>
            <span class="n">host</span> <span class="o">=</span> <span class="n">hosts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">biz_id</span> <span class="o">=</span> <span class="n">host</span><span class="p">[</span><span class="s1">&#39;biz&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;bk_biz_id&#39;</span><span class="p">]</span>
            <span class="n">innerip</span> <span class="o">=</span> <span class="n">host</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">][</span><span class="s1">&#39;bk_host_innerip&#39;</span><span class="p">]</span>
            <span class="n">cloud_id</span> <span class="o">=</span> <span class="n">host</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">][</span><span class="s1">&#39;bk_cloud_id&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;bk_inst_id&#39;</span><span class="p">]</span>
            <span class="n">ip_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s1">&#39;ip&#39;</span><span class="p">:</span> <span class="n">innerip</span><span class="p">,</span>
                    <span class="s1">&#39;bk_cloud_id&#39;</span><span class="p">:</span> <span class="n">cloud_id</span>
                <span class="p">}</span>
            <span class="p">]</span>
            <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;bk_biz_id&quot;</span><span class="p">:</span> <span class="n">biz_id</span><span class="p">,</span>
                <span class="s2">&quot;script_content&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mysql_script</span><span class="p">(</span><span class="n">innerip</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cred</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cred</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]),</span>
                <span class="s2">&quot;script_timeout&quot;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>
                <span class="s2">&quot;account&quot;</span><span class="p">:</span> <span class="n">MYSQL_OS_ACCOUNT</span><span class="p">,</span>
                <span class="s2">&quot;script_type&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s2">&quot;ip_list&quot;</span><span class="p">:</span> <span class="n">ip_list</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">fast_execute_sql</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
            <span class="n">res</span><span class="p">,</span> <span class="n">log_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">get_log</span><span class="p">(</span><span class="n">innerip</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">inst_id</span> <span class="o">=</span> <span class="n">inst</span><span class="p">[</span><span class="s1">&#39;bk_inst_id&#39;</span><span class="p">]</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">log_content</span><span class="p">)</span>
            <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clear_data</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_inst</span><span class="p">(</span><span class="n">inst_id</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
            <span class="n">asst_host</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;bk_asst_inst_id&#39;</span><span class="p">:</span> <span class="n">inst_id</span><span class="p">,</span>
                <span class="s1">&#39;bk_inst_id&#39;</span><span class="p">:</span> <span class="n">host</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">][</span><span class="s1">&#39;bk_host_id&#39;</span><span class="p">],</span>
                <span class="s1">&#39;bk_obj_asst_id&#39;</span><span class="p">:</span> <span class="s2">&quot;host_run_{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">BK_OBJ_ID</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_asst</span><span class="p">(</span><span class="n">asst_host</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">search_inst</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;bk_app_code&quot;</span><span class="p">:</span> <span class="n">BK_APP_ID</span><span class="p">,</span>
            <span class="s2">&quot;bk_app_secret&quot;</span><span class="p">:</span> <span class="n">BK_APP_TOKEN</span><span class="p">,</span>
            <span class="s2">&quot;bk_username&quot;</span><span class="p">:</span> <span class="n">BK_USERNAME</span><span class="p">,</span>
            <span class="s2">&quot;bk_supplier_account&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bk_obj_id&quot;</span><span class="p">:</span> <span class="n">BK_OBJ_ID</span><span class="p">,</span>
            <span class="s2">&quot;condition&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">BK_OBJ_ID</span><span class="p">:</span> <span class="p">[]</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">BK_PAAS_HOST</span> <span class="o">+</span> <span class="s1">&#39;/api/c/compapi/v2/cc/search_inst/&#39;</span>
        <span class="n">rp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">params</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;请求失败&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">rp</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;查询实例失败&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;info&#39;</span><span class="p">]</span>

    <span class="c1"># 查询主机</span>
    <span class="k">def</span> <span class="nf">search_host</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">BK_PAAS_HOST</span> <span class="o">+</span> <span class="s1">&#39;/api/c/compapi/v2/cc/search_host/&#39;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;bk_app_code&quot;</span><span class="p">:</span> <span class="n">BK_APP_ID</span><span class="p">,</span>
            <span class="s2">&quot;bk_app_secret&quot;</span><span class="p">:</span> <span class="n">BK_APP_TOKEN</span><span class="p">,</span>
            <span class="s2">&quot;bk_username&quot;</span><span class="p">:</span> <span class="n">BK_USERNAME</span><span class="p">,</span>
            <span class="s2">&quot;bk_supplier_account&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;condition&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="s2">&quot;bk_obj_id&quot;</span><span class="p">:</span> <span class="s2">&quot;host&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="s2">&quot;condition&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="s1">&#39;operator&#39;</span><span class="p">:</span> <span class="s1">&#39;$in&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;field&#39;</span><span class="p">:</span> <span class="s1">&#39;bk_host_innerip&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">ip</span><span class="p">]</span>
                        <span class="p">}</span>
                    <span class="p">]</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="s2">&quot;bk_obj_id&quot;</span><span class="p">:</span> <span class="s2">&quot;biz&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">[],</span>
                    <span class="s2">&quot;condition&quot;</span><span class="p">:</span> <span class="p">[]</span>
                <span class="p">},</span>
            <span class="p">],</span>
        <span class="p">}</span>
        <span class="n">rp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">params</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;请求失败&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">rp</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;查询主机失败&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;info&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">update_inst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inst_id</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;bk_app_code&quot;</span><span class="p">:</span> <span class="n">BK_APP_ID</span><span class="p">,</span>
            <span class="s2">&quot;bk_app_secret&quot;</span><span class="p">:</span> <span class="n">BK_APP_TOKEN</span><span class="p">,</span>
            <span class="s2">&quot;bk_username&quot;</span><span class="p">:</span> <span class="n">BK_USERNAME</span><span class="p">,</span>
            <span class="s2">&quot;bk_supplier_account&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;bk_obj_id&quot;</span><span class="p">:</span> <span class="n">BK_OBJ_ID</span><span class="p">,</span>
            <span class="s2">&quot;bk_inst_id&quot;</span><span class="p">:</span> <span class="n">inst_id</span>
        <span class="p">}</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="o">**</span><span class="n">config</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">BK_PAAS_HOST</span> <span class="o">+</span> <span class="s1">&#39;/api/c/compapi/v2/cc/update_inst/&#39;</span>
        <span class="n">rp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">params</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;请求失败&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">rp</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;更新实例失败&#39;</span><span class="p">)</span>



    <span class="k">def</span> <span class="nf">clear_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="k">print</span> <span class="n">config</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;character&#39;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;charset&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
            <span class="s1">&#39;db_version&#39;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;db_version&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
            <span class="s1">&#39;db_size&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;db_size&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;MB&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;mb&#39;</span><span class="p">))),</span>
            <span class="s1">&#39;install_dir&#39;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;basedir&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
            <span class="s1">&#39;dbfile_dir&#39;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;datafile_path&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
            <span class="s1">&#39;enable_binlog&#39;</span><span class="p">:</span> <span class="s1">&#39;enable_binlog&#39;</span> <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_binlog&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;ON&#39;</span> <span class="k">else</span> <span class="s1">&#39;disable_binlog&#39;</span><span class="p">,</span>
            <span class="s1">&#39;enable_slowlog&#39;</span><span class="p">:</span> <span class="s1">&#39;enable_slowlog&#39;</span> <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;is_slow_query_log&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;ON&#39;</span> <span class="k">else</span> <span class="s1">&#39;disable_slowlog&#39;</span><span class="p">,</span>
            <span class="s1">&#39;storage_engine&#39;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;storage_engine&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
            <span class="s1">&#39;inno_buff_pool_size&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;innodb_buffer_pool_size&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">),</span>
            <span class="s1">&#39;inno_log_buff_size&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;innodb_log_buffer_size&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">),</span>
            <span class="s1">&#39;inno_flush_log_trx&#39;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;innodb_flush_log_at_trx_commit&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
            <span class="s1">&#39;thread_cache_size&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;thread_cache_size&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">),</span>
            <span class="s1">&#39;query_cache_size&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;query_cache_size&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">),</span>
            <span class="s1">&#39;max_connections&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;max_connections&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
        <span class="p">}</span>



    <span class="k">def</span> <span class="nf">_mysql_script</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
        <span class="n">mysql_script</span> <span class="o">=</span> <span class="sa">u</span><span class="s2">&quot;&quot;&quot;#!/bin/bash</span>
<span class="s2">ip= {</span><span class="si">% r</span><span class="s2">aw %}{{ip}}{</span><span class="si">% e</span><span class="s2">ndraw %}</span>
<span class="s2">username={</span><span class="si">% r</span><span class="s2">aw %}{{username}}{</span><span class="si">% e</span><span class="s2">ndraw %}</span>
<span class="s2">password={</span><span class="si">% r</span><span class="s2">aw %}{{password}}{</span><span class="si">% e</span><span class="s2">ndraw %}</span>
<span class="s2">sql1=&#39;&#39;&#39;show VARIABLES WHERE variable_name LIKE &quot;character_set_database&quot;</span>
<span class="s2">OR variable_name LIKE &quot;slow_query_log&quot;</span>
<span class="s2">OR variable_name LIKE &quot;datadir&quot;</span>
<span class="s2">or variable_name LIKE &quot;basedir&quot;</span>
<span class="s2">OR variable_name LIKE &quot;version&quot;</span>
<span class="s2">or variable_name LIKE &quot;log_bin&quot; &#39;&#39;&#39;</span>
<span class="s2">sql2=&#39;SHOW VARIABLES WHERE variable_name =&quot;default_storage_engine&quot;&#39;</span>
<span class="s2"># 大小  </span>
<span class="s2">sql3=&quot;select concat(round((sum(data_length)+sum(index_length))/1024/1024,2),&#39;MB&#39;) as data from information_schema.tables&quot;  </span>
<span class="s2"># 数据库名</span>
<span class="s2">base_info=$(mysql -u$username -h$ip -p$password -s -e &quot;${sql1}&quot; 2&gt;/dev/null)</span>
<span class="s2">sql10=&#39;&#39;&#39;SHOW VARIABLES WHERE variable_name LIKE &quot;innodb_buffer_pool_size&quot; OR variable_name LIKE &quot;innodb_log_buffer_size&quot; OR variable_name LIKE &quot;innodb_flush_log_at_trx_commit&quot; OR variable_name LIKE &quot;thread_cache_size&quot; OR variable_name LIKE &quot;query_cache_size&quot; OR variable_name LIKE &quot;max_connections&quot;&#39;&#39;&#39;</span>
<span class="s2">base_info2=$(mysql -u$username -h$ip -p$password -s -e &quot;${sql10}&quot; 2&gt;/dev/null)</span>

<span class="s2">charset=`echo $base_info|awk -F &#39; &#39; &#39;{print $4}&#39;`</span>
<span class="s2">db_version=`echo $base_info|awk -F &#39; &#39; &#39;{print $12}&#39;`</span>
<span class="s2">db_size=$(mysql -u$username -h$ip -p$password -s -e &quot;${sql3}&quot; 2&gt;/dev/null)</span>
<span class="s2">basedir=`echo $base_info|awk -F &#39; &#39; &#39;{print $2}&#39;`</span>
<span class="s2">datafile_path=`echo $base_info|awk -F &#39; &#39; &#39;{print $6}&#39;`</span>
<span class="s2">storage_engine=`echo $(mysql -u$username -h$ip -p$password -s -e &quot;${sql2}&quot; 2&gt;/dev/null)|awk -F &#39; &#39; &#39;{print $2}&#39;`</span>
<span class="s2">is_binlog=`echo $base_info|awk -F &#39; &#39; &#39;{print $8}&#39;`</span>
<span class="s2">is_slow_query_log=`echo $base_info|awk -F &#39; &#39; &#39;{print $10}&#39;`</span>

<span class="s2">innodb_buffer_pool_size=`echo $base_info2|awk -F &#39; &#39; &#39;{print $2}&#39;`</span>
<span class="s2">innodb_log_buffer_size=`echo $base_info2|awk -F &#39; &#39; &#39;{print $6}&#39;`</span>
<span class="s2">innodb_flush_log_at_trx_commit=`echo $base_info2|awk -F &#39; &#39; &#39;{print $4}&#39;`</span>
<span class="s2">thread_cache_size=`echo $base_info2|awk -F &#39; &#39; &#39;{print $12}&#39;`</span>
<span class="s2">query_cache_size=`echo $base_info2|awk -F &#39; &#39; &#39;{print $10}&#39;`</span>
<span class="s2">max_connections=`echo $base_info2|awk -F &#39; &#39; &#39;{print $8}&#39;`</span>

<span class="s2">echo {&#39;&quot;&#39;charset&#39;&quot;&#39;: &#39;&quot;&#39;$charset&#39;&quot;&#39;,</span><span class="se">\</span>
<span class="s2"> &#39;&quot;&#39;db_version&#39;&quot;&#39;: &#39;&quot;&#39;$db_version&#39;&quot;&#39;,</span><span class="se">\</span>
<span class="s2">  &#39;&quot;&#39;db_size&#39;&quot;&#39;: &#39;&quot;&#39;$db_size&#39;&quot;&#39;,</span><span class="se">\</span>
<span class="s2">  &#39;&quot;&#39;basedir&#39;&quot;&#39;: &#39;&quot;&#39;$basedir&#39;&quot;&#39;,</span><span class="se">\</span>
<span class="s2">  &#39;&quot;&#39;datafile_path&#39;&quot;&#39;: &#39;&quot;&#39;$datafile_path&#39;&quot;&#39;,</span><span class="se">\</span>
<span class="s2">  &#39;&quot;&#39;storage_engine&#39;&quot;&#39;: &#39;&quot;&#39;$storage_engine&#39;&quot;&#39;,</span><span class="se">\</span>
<span class="s2">  &#39;&quot;&#39;is_binlog&#39;&quot;&#39;: &#39;&quot;&#39;$is_binlog&#39;&quot;&#39;,</span><span class="se">\</span>
<span class="s2">  &#39;&quot;&#39;is_slow_query_log&#39;&quot;&#39;: &#39;&quot;&#39;$is_slow_query_log&#39;&quot;&#39;,</span><span class="se">\</span>
<span class="s2">  &#39;&quot;&#39;innodb_buffer_pool_size&#39;&quot;&#39;: &#39;&quot;&#39;$innodb_buffer_pool_size&#39;&quot;&#39;,</span><span class="se">\</span>
<span class="s2">  &#39;&quot;&#39;innodb_log_buffer_size&#39;&quot;&#39;: &#39;&quot;&#39;$innodb_log_buffer_size&#39;&quot;&#39;,</span><span class="se">\</span>
<span class="s2">  &#39;&quot;&#39;innodb_flush_log_at_trx_commit&#39;&quot;&#39;: &#39;&quot;&#39;$innodb_flush_log_at_trx_commit&#39;&quot;&#39;,</span><span class="se">\</span>
<span class="s2">  &#39;&quot;&#39;thread_cache_size&#39;&quot;&#39;: &#39;&quot;&#39;$thread_cache_size&#39;&quot;&#39;,</span><span class="se">\</span>
<span class="s2">  &#39;&quot;&#39;query_cache_size&#39;&quot;&#39;: &#39;&quot;&#39;$query_cache_size&#39;&quot;&#39;,</span><span class="se">\</span>
<span class="s2">  &#39;&quot;&#39;max_connections&#39;&quot;&#39;: &#39;&quot;&#39;$max_connections&#39;&quot;&#39;</span><span class="se">\</span>
<span class="s2">  }</span>
<span class="s2">exit</span>
<span class="s2">&quot;&quot;&quot;</span>
        <span class="n">mysql_script</span> <span class="o">=</span> <span class="n">mysql_script</span> \
            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;{</span><span class="si">% r</span><span class="s1">aw %}{{username}}{</span><span class="si">% e</span><span class="s1">ndraw %}&#39;</span><span class="p">,</span> <span class="n">username</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;{</span><span class="si">% r</span><span class="s1">aw %}{{password}}{</span><span class="si">% e</span><span class="s1">ndraw %}&#39;</span><span class="p">,</span> <span class="n">password</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;{</span><span class="si">% r</span><span class="s1">aw %}{{ip}}{</span><span class="si">% e</span><span class="s1">ndraw %}&#39;</span><span class="p">,</span> <span class="n">ip</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">mysql_script</span><span class="p">)</span>
</pre></div>


<h4 id="23">2.3 自动发现关联信息</h4>
<ul>
<li>通过 MySQL 实例中 IP 地址，找到与之对应的主机</li>
<li>调用 CMDB 创建关联的接口，添加主机和 MySQL 直接的关联关系</li>
</ul>
<div class="codehilite"><pre><span></span><span class="c1"># 3. 发现 MySQL 实例与所在主机的关联关系</span>
    <span class="c1"># 创建关联: CMDB_HOST + &#39;/api/v3/inst/association/action/create&#39;</span>
    <span class="c1"># 目前暂未开放ESB接口，接口地址和参数通过抓包获取</span>
    <span class="c1"># params:</span>
    <span class="c1"># {</span>
    <span class="c1">#   &#39;bk_asst_inst_id&#39;: 目标实例ID, * 必填</span>
    <span class="c1">#   &#39;bk_inst_id&#39;: 源实例ID, * 必填</span>
    <span class="c1">#   &#39;bk_obj_asst_id&#39;：关联ID * 必填</span>
    <span class="c1"># }</span>
    <span class="k">def</span> <span class="nf">create_asst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="n">is_asst</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_asst</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>  <span class="c1"># 判断关联关系是否已存在</span>
        <span class="k">if</span> <span class="n">is_asst</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">BK_CMDB_HOST</span> <span class="o">+</span> <span class="s1">&#39;/api/v3/inst/association/action/create&#39;</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
            <span class="s2">&quot;HTTP_BlUEKING_SUPPLIER_ID&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;BK_USER&quot;</span><span class="p">:</span> <span class="n">BK_USERNAME</span>
        <span class="p">}</span>
        <span class="n">rp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">params</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;请求失败&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">rp</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]:</span>
            <span class="k">print</span> <span class="n">res</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;创建关联失败&#39;</span><span class="p">)</span>

    <span class="c1"># 查询关联: CMDB_HOST + &#39;/api/v3/object/association/action/search&#39;</span>
    <span class="c1"># 目前暂未开放ESB接口，接口地址和参数通过抓包获取</span>
    <span class="c1"># params:</span>
    <span class="c1"># {</span>
    <span class="c1">#   &#39;bk_asst_inst_id&#39;: 目标实例ID,</span>
    <span class="c1">#   &#39;bk_inst_id&#39;: 源实例ID,</span>
    <span class="c1">#   &#39;bk_obj_id&#39;: 模型ID, * 必填</span>
    <span class="c1">#   &#39;bk_obj_asst_id&#39;：关联ID</span>
    <span class="c1"># }</span>
    <span class="k">def</span> <span class="nf">search_asst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">BK_CMDB_HOST</span> <span class="o">+</span> <span class="s1">&#39;/api/v3/inst/association/action/search&#39;</span>
        <span class="n">params</span><span class="p">[</span><span class="s1">&#39;bk_obj_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">BK_OBJ_ID</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="s2">&quot;application/json&quot;</span><span class="p">,</span>
            <span class="s2">&quot;HTTP_BlUEKING_SUPPLIER_ID&quot;</span><span class="p">:</span> <span class="s2">&quot;0&quot;</span><span class="p">,</span>
            <span class="s2">&quot;BK_USER&quot;</span><span class="p">:</span> <span class="n">BK_USERNAME</span>
        <span class="p">}</span>
        <span class="n">rp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">params</span><span class="p">),</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;请求失败&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">rp</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;查询关联&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">asst</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;bk_obj_asst_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">asst</span><span class="p">[</span><span class="s1">&#39;bk_obj_asst_id&#39;</span><span class="p">]</span> <span class="ow">and</span> \
                    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;bk_inst_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">asst</span><span class="p">[</span><span class="s1">&#39;bk_inst_id&#39;</span><span class="p">]</span> <span class="ow">and</span> \
                    <span class="n">params</span><span class="p">[</span><span class="s1">&#39;bk_asst_inst_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">asst</span><span class="p">[</span><span class="s1">&#39;bk_asst_inst_id&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span>
</pre></div>


<h4 id="24">2.4 封装作业平台执行类</h4>
<p>封装好调用作业平台快速执行脚本接口的类</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">JobMan</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ip_log</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">get_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ip</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ip</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip_log</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="sa">u</span><span class="s2">&quot;IP{0}未执行作业，可能是IP未录入或Agent异常&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip_log</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="s2">&quot;is_success&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip_log</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="s2">&quot;log_content&quot;</span><span class="p">]</span>

    <span class="c1"># 快速执行脚本</span>
    <span class="k">def</span> <span class="nf">fast_execute_sql</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">BK_PAAS_HOST</span> <span class="o">+</span> <span class="s1">&#39;/api/c/compapi/v2/job/fast_execute_script/&#39;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({</span>
            <span class="s2">&quot;bk_app_code&quot;</span><span class="p">:</span> <span class="n">BK_APP_ID</span><span class="p">,</span>
            <span class="s2">&quot;bk_app_secret&quot;</span><span class="p">:</span> <span class="n">BK_APP_TOKEN</span><span class="p">,</span>
            <span class="s2">&quot;bk_username&quot;</span><span class="p">:</span> <span class="n">BK_USERNAME</span><span class="p">,</span>
        <span class="p">},</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span>
        <span class="n">rp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">params</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;请求失败&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">rp</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;执行脚本失败&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_job_instance_log</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;bk_biz_id&#39;</span><span class="p">],</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;job_instance_id&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">get_job_instance_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bk_biz_id</span><span class="p">,</span> <span class="n">job_instance_id</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;bk_app_code&quot;</span><span class="p">:</span> <span class="n">BK_APP_ID</span><span class="p">,</span>
            <span class="s2">&quot;bk_app_secret&quot;</span><span class="p">:</span> <span class="n">BK_APP_TOKEN</span><span class="p">,</span>
            <span class="s2">&quot;bk_username&quot;</span><span class="p">:</span> <span class="n">BK_USERNAME</span><span class="p">,</span>
            <span class="s2">&quot;bk_biz_id&quot;</span><span class="p">:</span> <span class="n">bk_biz_id</span><span class="p">,</span>
            <span class="s2">&quot;job_instance_id&quot;</span><span class="p">:</span> <span class="n">job_instance_id</span>
        <span class="p">}</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">BK_PAAS_HOST</span> <span class="o">+</span> <span class="s1">&#39;/api/c/compapi/v2/job/get_job_instance_log/&#39;</span>
        <span class="n">rp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">params</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;请求失败&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">rp</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;获取日志失败&#39;</span><span class="p">)</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">step</span><span class="p">[</span><span class="s1">&#39;is_finished&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__get_step_log</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_job_instance_log</span><span class="p">(</span><span class="n">bk_biz_id</span><span class="p">,</span> <span class="n">job_instance_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__get_step_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">step_res</span> <span class="ow">in</span> <span class="n">step</span><span class="p">[</span><span class="s1">&#39;step_results&#39;</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">ip_content</span> <span class="ow">in</span> <span class="n">step_res</span><span class="p">[</span><span class="s1">&#39;ip_logs&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">ip_content</span><span class="p">[</span><span class="s1">&#39;ip&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip_log</span><span class="p">:</span>
                    <span class="k">print</span> <span class="n">ip_content</span><span class="p">[</span><span class="s1">&#39;ip&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="sa">u</span><span class="s2">&quot;IP重复&quot;</span>
                    <span class="k">continue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ip_log</span><span class="p">[</span><span class="n">ip_content</span><span class="p">[</span><span class="s1">&#39;ip&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;is_success&quot;</span><span class="p">:</span> <span class="n">step_res</span><span class="p">[</span><span class="s2">&quot;ip_status&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">9</span><span class="p">,</span>
                    <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">ip_content</span><span class="p">[</span><span class="s1">&#39;bk_cloud_id&#39;</span><span class="p">],</span>
                    <span class="s2">&quot;ip&quot;</span><span class="p">:</span> <span class="n">ip_content</span><span class="p">[</span><span class="s1">&#39;ip&#39;</span><span class="p">],</span>
                    <span class="s2">&quot;log_content&quot;</span><span class="p">:</span> <span class="n">ip_content</span><span class="p">[</span><span class="s1">&#39;log_content&#39;</span><span class="p">]</span>
                <span class="p">}</span>
</pre></div>


<h4 id="25">2.5 调用执行</h4>
<div class="codehilite"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1"># 自动发现</span>
    <span class="n">cover</span> <span class="o">=</span> <span class="n">CoverMysql</span><span class="p">()</span>
    <span class="n">cover</span><span class="o">.</span><span class="n">start_cover</span><span class="p">()</span>
    <span class="c1"># 自动采集</span>
    <span class="n">collect</span> <span class="o">=</span> <span class="n">CollectMysql</span><span class="p">()</span>
    <span class="n">collect</span><span class="o">.</span><span class="n">start_collect</span><span class="p">()</span>
</pre></div>


<h3 id="3">3. 测试效果</h3>
<ul>
<li>自动发现 MySQL 实例</li>
</ul>
<p><img alt="-w1373" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/15637899863101.jpg" /></p>
<ul>
<li>自动发现 MySQL CI 属性</li>
</ul>
<p><img alt="-w1372" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/15637900105715.jpg" /></p>
<ul>
<li>自动发现 MySQL 与主机的关联关系</li>
</ul>
<p><img alt="-w1372" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/15637901490690.jpg" /></p>
<blockquote>
<p>注：关联关系中，主机与机架、机房管理单元、机房等关联需要单独添加对应的关联关系，此处不做展开。</p>
</blockquote>
<h2 id="mysql-demo">MySQL 自动发现采集器 Demo</h2>
<p>请 <a href="5.1/bk_solutions/CD/CMDB/media/cmdb_autodiscovery_mysql_instance.py.tgz">下载 demo</a> 后，在一台有  Python 环境的主机（可访问蓝鲸）或 SaaS 中运行。</p>
<h2 id="_5">其他说明</h2>
<p>要实现周期性自动发现，可用<code>Celery</code>的周期任务实现</p><h1 id="cmdb-cmdb">企业原有 CMDB 同步至蓝鲸 CMDB</h1>
<blockquote>
<p>感谢社区用户 <a href="https://bk.tencent.com/s-mart/personal/10966/">Kevin</a> 提供该文档.</p>
</blockquote>
<h2 id="_1">情景</h2>
<p>公司基础部门维护公司统一的一套 CMDB，资源主要以服务器为主，资源交付后会直接进入公司的 CMDB，需要手动导出列表，修改成蓝鲸 CMDB 的导入格式，导入蓝鲸 CMDB。存在如下问题：</p>
<ul>
<li>资源交付后需要手动导出、导入，少量机器频繁交付，为了让机器及时加入蓝鲸管控，需要频繁人工参与</li>
<li>公司 CMDB 与蓝鲸 CMDB 字段不统一，需要手动复制、编辑字段属性，再导入蓝鲸，非常繁琐</li>
</ul>
<h2 id="_2">前提条件</h2>
<ul>
<li>
<p>在配置平台中 <a href="5.1/配置平台/快速入门/case1.md">新建好业务</a>。</p>
</li>
<li>
<p>熟悉一门脚本语言，如<code>Python</code>，本教程以<code>Python</code>为例</p>
</li>
<li>
<p>了解 <a href="5.1/API文档/CC/README.md">蓝鲸 CMDB API</a></p>
</li>
</ul>
<h2 id="_3">操作步骤</h2>
<ul>
<li>
<p>梳理同步逻辑</p>
</li>
<li>
<p>代码实践及解读</p>
</li>
<li>
<p>定时同步</p>
</li>
</ul>
<h3 id="1">1. 梳理同步逻辑</h3>
<p>查询公司 CMDB 与蓝鲸 CMDB 服务器属性的对应关系，生成属性映射 MAP 表，MAP 表中只记录需要关注的属性，并确认相关属性都已在蓝鲸 CMDB 中创建。</p>
<p><strong>新增资源</strong></p>
<ul>
<li>
<p>通过接口查询公司 CMDB，获取自己所在业务部门下的全量服务器列表</p>
</li>
<li>
<p>通过接口获取蓝鲸 CMDB 的服务器列表</p>
</li>
<li>
<p>遍历两个列表，找出蓝鲸 CMDB 中没有的服务器，汇总成列表，并通过接口录入到蓝鲸 CMDB</p>
</li>
</ul>
<p><strong>更新资源</strong></p>
<ul>
<li>分别获取两个 CMDB 的数据，遍历两组数据，对比属性 MAP 表中的属性字段，找出数据不同的服务器，汇总成列表，再统一更新到蓝鲸 CMDB</li>
</ul>
<h3 id="2">2. 代码实践及解读</h3>
<h4 id="21">2.1 新建应用</h4>
<p>在蓝鲸开发者中心 <a href="5.1/开发指南/SaaS开发/新手入门/Windows.md">新建一个应用</a>，用于调用 <a href="5.1/API文档/CC/README.md">CMDB 的 API</a>。</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">urllib2</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="n">PAAS_API</span> <span class="o">=</span> <span class="s1">&#39;https://paas.bk.com&#39;</span> <span class="c1"># 蓝鲸 PaaS 地址</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
    <span class="n">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> </span><span class="si">%(filename)s</span><span class="s1">[line:</span><span class="si">%(lineno)d</span><span class="s1">] </span><span class="si">%(levelname)s</span><span class="s1"> </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="n">datefmt</span><span class="o">=</span><span class="s1">&#39;%a, </span><span class="si">%d</span><span class="s1"> %b %Y %H:%M:%S&#39;</span><span class="p">,</span>
    <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;./update.log&#39;</span><span class="p">,</span>
    <span class="n">filemode</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>

<span class="n">BASE_ARGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    接口调用中的通用参数</span>
<span class="sd">    蓝鲸中新建一个应用，获取相关应用信息</span>
<span class="sd">    并在https://paas.bk.com/admin/bkcore/functioncontroller/中添加认证白名单，否则调用CMDB     接口会失败，参考： 开发者中心-API网关-使用指南-API调用说明</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="s1">&#39;bk_app_code&#39;</span><span class="p">:</span> <span class="s1">&#39;sync-cmdb&#39;</span><span class="p">,</span>  <span class="c1"># 应用 ID</span>
    <span class="s1">&#39;bk_app_secret&#39;</span><span class="p">:</span> <span class="s1">&#39;xxxx-xxxxxxxxxxxx&#39;</span><span class="p">,</span> <span class="c1"># 应用 Token</span>
    <span class="s1">&#39;bk_username&#39;</span><span class="p">:</span><span class="s1">&#39;user.name&#39;</span> <span class="c1"># 蓝鲸系统中的用户名</span>
    <span class="p">}</span>
</pre></div>


<h4 id="22-cmdb">2.2 获取蓝鲸 CMDB 主机列表</h4>
<p>查询蓝鲸 CMDB 的获取主机 <code>search_host</code> API ，返回主机列表</p>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">getBkCmdbHost</span><span class="p">():</span>
    <span class="c1"># 查询蓝鲸CMDB，返回主机列表</span>
    <span class="n">bkList</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">PAAS_API</span> <span class="o">+</span> <span class="s1">&#39;/api/c/compapi/v2/cc/search_host/&#39;</span> <span class="c1"># api请求地址</span>
    <span class="n">apiArgs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1"># api相关参数，参考https://paas.bk.com/esb/api_docs/system/CC/search_host/</span>
        <span class="s1">&#39;condition&#39;</span><span class="p">:[</span>
            <span class="p">{</span>
                <span class="s2">&quot;bk_obj_id&quot;</span><span class="p">:</span> <span class="s2">&quot;host&quot;</span><span class="p">,</span>
                <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;condition&quot;</span><span class="p">:</span> <span class="p">[]</span>
            <span class="p">}]</span>
    <span class="p">}</span>

    <span class="n">args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">BASE_ARGS</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="o">+</span> <span class="n">apiArgs</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">j_content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">j_content</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;info&#39;</span><span class="p">]:</span>
        <span class="n">bkList</span><span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">][</span><span class="s1">&#39;bk_host_innerip&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">bkList</span>
</pre></div>


<h4 id="23-cmdb">2.3 获取 公司 CMDB 主机列表</h4>
<p>调用公司 CMDB 获取主机列表 API，返回主机列表</p>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">getCmdbHost</span><span class="p">():</span>
    <span class="c1"># 根据企业内部接口自己实现，返回IP信息列表</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    infoList = [</span>
<span class="sd">        &quot;ip1&quot;: {</span>
<span class="sd">            &quot;sn&quot;: &quot;xxxx&quot;,</span>
<span class="sd">            &quot;service_term&quot;: 3,</span>
<span class="sd">            ...</span>
<span class="sd">        },</span>
<span class="sd">        &quot;ip2&quot;: {},</span>
<span class="sd">        ...</span>
<span class="sd">    ]</span>
<span class="sd">    &#39;&#39;&#39;</span>
</pre></div>


<h4 id="24-ip-ip">2.4 生成新增 IP 列表、更新 IP 列表、更新信息列表</h4>
<p>根据步骤 2.2 和 步骤 2.3 获取到的两个主机列表，对比生成所需的新增列表和更新列表。</p>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">genAddList</span><span class="p">(</span><span class="n">cmdbList</span><span class="p">,</span> <span class="n">bkList</span><span class="p">):</span>
    <span class="c1"># 对比两个列表，返回新增IP列表</span>
    <span class="n">addList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cmdbList</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bkList</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="c1">#print k, cmdbList[k]</span>
            <span class="n">addList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">addList</span>

<span class="k">def</span> <span class="nf">genUpdateList</span><span class="p">(</span><span class="n">cmdbList</span><span class="p">,</span> <span class="n">bkList</span><span class="p">):</span>
    <span class="c1"># 对比两个列表，生成需要更新的IP列表</span>
    <span class="n">ipList</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">attrMAP</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attributeMAP</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">}</span> <span class="c1"># 过滤出自己关心的主机属性</span>
    <span class="k">for</span> <span class="n">ip</span><span class="p">,</span> <span class="n">cmdbHost</span> <span class="ow">in</span> <span class="n">cmdbList</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">ip</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bkList</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">continue</span>
        <span class="n">bkHost</span> <span class="o">=</span> <span class="n">bkList</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">cmdbAttr</span><span class="p">,</span> <span class="n">bkAttr</span> <span class="ow">in</span> <span class="n">attrMAP</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">cmdbAttr</span> <span class="ow">in</span> <span class="n">cmdbHost</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">bkAttr</span> <span class="ow">in</span> <span class="n">bkHost</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">and</span> <span class="n">cmdbHost</span><span class="p">[</span><span class="n">cmdbAttr</span><span class="p">]</span> <span class="o">!=</span> <span class="n">bkHost</span><span class="p">[</span><span class="n">bkAttr</span><span class="p">]:</span>
                <span class="n">ipList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ip</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ipList</span>

<span class="k">def</span> <span class="nf">genInfoList</span><span class="p">(</span><span class="n">cmdbList</span><span class="p">,</span> <span class="n">bkList</span><span class="p">,</span> <span class="n">ipList</span><span class="p">,</span> <span class="n">attributeMAP</span><span class="p">):</span>
    <span class="c1"># 根据IP列表生成主机详细信息列表</span>
    <span class="n">infoList</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">attrMAP</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attributeMAP</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">}</span>
    <span class="k">for</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">ipList</span><span class="p">:</span>
        <span class="n">ipInfo</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">attrMAP</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">cmdbList</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">ipInfo</span><span class="p">[</span><span class="n">attrMAP</span><span class="p">[</span><span class="n">k</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cmdbList</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ip</span> <span class="ow">in</span> <span class="n">bkList</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="c1">#添加bk_host_id</span>
            <span class="n">ipInfo</span><span class="p">[</span><span class="s1">&#39;bk_host_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bkList</span><span class="p">[</span><span class="n">ip</span><span class="p">][</span><span class="s1">&#39;bk_host_id&#39;</span><span class="p">]</span>
        <span class="n">infoList</span><span class="p">[</span><span class="n">ip</span><span class="p">]</span> <span class="o">=</span> <span class="n">ipInfo</span>
    <span class="k">return</span> <span class="n">infoList</span>

<span class="n">attributeMAP</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># 属性对应列表，值为None的字段不关心，不录入蓝鲸cmdb</span>
    <span class="s1">&#39;AssetNo&#39;</span><span class="p">:</span>          <span class="s1">&#39;bk_asset_id&#39;</span><span class="p">,</span>          <span class="c1">#资产编号</span>
    <span class="s1">&#39;SN&#39;</span><span class="p">:</span>               <span class="s1">&#39;bk_sn&#39;</span><span class="p">,</span>                <span class="c1">#序列号</span>
    <span class="s1">&#39;Manufacture&#39;</span><span class="p">:</span>      <span class="s1">&#39;machine_manufacturer&#39;</span><span class="p">,</span> <span class="c1">#厂商</span>
    <span class="s1">&#39;ManufactureType&#39;</span><span class="p">:</span>  <span class="s1">&#39;machine_model&#39;</span><span class="p">,</span>        <span class="c1">#厂商型号</span>
    <span class="s1">&#39;MachineType&#39;</span><span class="p">:</span>      <span class="s1">&#39;machine_type&#39;</span><span class="p">,</span>         <span class="c1">#MachineType</span>
    <span class="s1">&#39;HostName&#39;</span><span class="p">:</span>         <span class="bp">None</span><span class="p">,</span>                   <span class="c1">#主机名</span>
    <span class="s1">&#39;IP&#39;</span><span class="p">:</span>               <span class="s1">&#39;bk_host_innerip&#39;</span><span class="p">,</span>      <span class="c1">#IP</span>
    <span class="s1">&#39;BusinessIP&#39;</span><span class="p">:</span>       <span class="s1">&#39;bk_host_bizip&#39;</span><span class="p">,</span>        <span class="c1">#业务IP</span>
    <span class="s1">&#39;PublicIP&#39;</span><span class="p">:</span>         <span class="s1">&#39;bk_host_outerip&#39;</span><span class="p">,</span>      <span class="c1">#公网IP</span>
    <span class="s1">&#39;VNetIP&#39;</span><span class="p">:</span>           <span class="s1">&#39;bk_host_usernetip&#39;</span><span class="p">,</span>    <span class="c1">#用户网IP</span>
    <span class="s1">&#39;tags&#39;</span><span class="p">:</span>             <span class="bp">None</span><span class="p">,</span>                   <span class="c1">#资产类型</span>
    <span class="c1">#其它...</span>
<span class="p">}</span>

<span class="n">addList</span> <span class="o">=</span> <span class="n">genAddList</span><span class="p">(</span><span class="n">cmdbList</span><span class="p">,</span> <span class="n">bkList</span><span class="p">)</span>
<span class="n">updateList</span> <span class="o">=</span> <span class="n">genUpdateList</span><span class="p">(</span><span class="n">cmdbList</span><span class="p">,</span> <span class="n">bkList</span><span class="p">):</span>
<span class="n">addInfoList</span> <span class="o">=</span> <span class="n">genInfoList</span><span class="p">(</span><span class="n">cmdbList</span><span class="p">,</span> <span class="n">bkList</span><span class="p">,</span> <span class="n">addList</span><span class="p">,</span> <span class="n">attributeMAP</span><span class="p">)</span>
<span class="n">updateInfoList</span> <span class="o">=</span> <span class="n">genInfoList</span><span class="p">(</span><span class="n">cmdbList</span><span class="p">,</span> <span class="n">bkList</span><span class="p">,</span> <span class="n">addList</span><span class="p">,</span> <span class="n">attributeMAP</span><span class="p">)</span>
</pre></div>


<h4 id="25-cmdb">2.5 录入、更新主机数据到蓝鲸 CMDB</h4>
<ul>
<li>录入新增主机信息：使用 步骤 2.4 中生成的新增主机信息列表，录入蓝鲸 CMDB</li>
</ul>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">addBkCmdbHost</span><span class="p">(</span><span class="n">infoList</span><span class="p">):</span>
    <span class="c1"># 录入新增数据到cmdb</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    infoList = [</span>
<span class="sd">        &quot;ip1&quot;: {</span>
<span class="sd">            &quot;bk_sn&quot;: &quot;xxxx&quot;,</span>
<span class="sd">            &quot;bk_service_term&quot;: 3,</span>
<span class="sd">            ...</span>
<span class="sd">        },</span>
<span class="sd">        &quot;ip2&quot;: {},</span>
<span class="sd">        ...</span>
<span class="sd">    ]</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">ipInfoList</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">infoList</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
        <span class="n">v</span><span class="p">[</span><span class="s1">&#39;bk_cloud_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">v</span><span class="p">[</span><span class="s1">&#39;import_from&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;3&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;bk_host_id&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">del</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="s1">&#39;bk_host_id&#39;</span><span class="p">])</span>
        <span class="c1">#print k, v</span>
        <span class="n">ipInfoList</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="n">url</span> <span class="o">=</span> <span class="n">PAAS_API</span> <span class="o">+</span> <span class="s1">&#39;/api/c/compapi/v2/cc/add_host_to_resource/&#39;</span>
    <span class="n">apiArgs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;host_info&#39;</span><span class="p">:</span> <span class="n">ipInfoList</span>
    <span class="p">}</span>

    <span class="n">args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">BASE_ARGS</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="o">+</span> <span class="n">apiArgs</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">print</span> <span class="n">content</span>

<span class="n">addBkCmdbHost</span><span class="p">(</span><span class="n">addInfoList</span><span class="p">)</span>
</pre></div>


<ul>
<li>更新主机数据：使用步骤 2.4 中生成的更新主机信息列表，更新蓝鲸 CMDB</li>
</ul>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">updateBkCmdbHost</span><span class="p">(</span><span class="n">infoList</span><span class="p">):</span>
    <span class="c1"># 更新数据到cmdb</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">PAAS_API</span> <span class="o">+</span> <span class="s1">&#39;/api/c/compapi/v2/cc/update_host/&#39;</span>
    <span class="k">for</span> <span class="n">ip</span><span class="p">,</span> <span class="n">ipInfo</span> <span class="ow">in</span> <span class="n">infoList</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">bk_host_id</span> <span class="o">=</span> <span class="n">ipInfo</span><span class="p">[</span><span class="s1">&#39;bk_host_id&#39;</span><span class="p">]</span>
        <span class="k">del</span><span class="p">(</span><span class="n">ipInfo</span><span class="p">[</span><span class="s1">&#39;bk_host_id&#39;</span><span class="p">])</span>
        <span class="n">apiArgs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;bk_host_id&#39;</span><span class="p">:</span> <span class="n">bk_host_id</span><span class="p">,</span>
            <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">ipInfo</span>
        <span class="p">}</span>

        <span class="c1">#print apiArgs</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">BASE_ARGS</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="o">+</span> <span class="n">apiArgs</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;bk_host_id: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">bk_host_id</span><span class="p">)</span> <span class="o">+</span> <span class="n">content</span><span class="p">)</span>
        <span class="k">print</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>

<span class="n">updateBkCmdbHost</span><span class="p">(</span><span class="n">updateInfoList</span><span class="p">)</span>
</pre></div>


<h3 id="3">3. 定时同步</h3>
<ul>
<li>CMDB 同步脚本使用 <a href="5.1/作业平台/产品功能/定时作业.md">JOB</a> 的定时作业或 <a href="5.1/标准运维/产品功能/flow.md">标准运维</a> 的定时任务进行周期托管，方便迁移或者修改维护</li>
</ul>
<p><img alt="1562225679643" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/1562225679643.png" /></p>
<p>注：上述教程是企业 CMDB <code>单向</code>、<code>定期</code>同步主机实例至蓝鲸 CMDB 的实践，如果需要实时同步，一般推荐 <a href="5.1/配置平台/产品功能/ModelManagement.md">消息推动</a>的方式。</p><h1 id="open-falcon-cmdb">Open-Falcon 集成蓝鲸 CMDB 业务拓扑树</h1>
<blockquote>
<p>感谢社区用户 <a href="https://bk.tencent.com/s-mart/personal/10116/">StephenWang</a> 贡献该文档.</p>
</blockquote>
<h2 id="_1">情景</h2>
<p><code>Open-Falcon</code> 是一款开源监控产品， 默认通过 <code>Endpoint</code>（一般为主机名） 查找服务器，体验不够友好。</p>
<p>集成蓝鲸配置平台的业务拓扑树，将首页左侧栏改造为服务树，通过选择业务模块快速选择机器，提高监控查看效率。</p>
<h2 id="_2">前提条件</h2>
<ul>
<li><a href="5.1/bk_solutions/CD/CMDB/CMDB_management_hosts.md">主机纳管在蓝鲸配置平台中</a></li>
<li>在蓝鲸开发者中心 <a href="5.1/开发指南/SaaS开发/新手入门/Windows.md">新建一个应用</a>，用于调用 <a href="5.1/API文档/CC/README.md">CMDB 的 API</a></li>
<li>熟悉 <code>Python</code>、<code>JavaScript</code></li>
</ul>
<h2 id="_3">操作步骤</h2>
<ul>
<li>配置平台中建立业务拓扑</li>
<li>查询主机及拓扑，写入 Redis</li>
<li>封装后台接口</li>
<li>Open-Falcon 前端调用</li>
<li>预览效果</li>
</ul>
<h3 id="1">1. 配置平台中建立业务拓扑</h3>
<p>参照 <a href="5.1/bk_solutions/CD/CMDB/CMDB_management_hosts.md">主机纳管在蓝鲸配置平台中</a>，根据应用的部署分层架构，建立业务拓扑如下：</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/15642787521397.jpg" /></p>
<h3 id="2-redis">2. 查询主机及拓扑，写入 Redis</h3>
<ul>
<li>定时调用配置平台<code>查询主机:search_host</code>接口</li>
<li>将结果转化为 <code>ztree</code> 的数据格式，并写入 Redis</li>
</ul>
<div class="codehilite"><pre><span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">redis</span>

<span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;/api/c/compapi/v2/cc/search_host/&#39;</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;bk_app_code&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>  <span class="c1"># 用于调用蓝鲸CMDB API的SaaS账号</span>
        <span class="s2">&quot;bk_app_secret&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="c1"># 用于调用蓝鲸CMDB API的SaaS Token</span>
        <span class="s2">&quot;bk_username&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="c1"># 拥有业务运维权限的蓝鲸账号</span>
        <span class="s2">&quot;condition&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;bk_obj_id&quot;</span><span class="p">:</span> <span class="s2">&quot;host&quot;</span><span class="p">,</span>
                <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">[]</span>

            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s2">&quot;bk_obj_id&quot;</span><span class="p">:</span> <span class="s2">&quot;module&quot;</span><span class="p">,</span>
                <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">[]</span>

            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s2">&quot;bk_obj_id&quot;</span><span class="p">:</span> <span class="s2">&quot;set&quot;</span><span class="p">,</span>
                <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">[]</span>

            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s2">&quot;bk_obj_id&quot;</span><span class="p">:</span> <span class="s2">&quot;biz&quot;</span><span class="p">,</span>
                <span class="s2">&quot;fields&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;condition&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;bk_biz_id&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;operator&quot;</span><span class="p">:</span> <span class="s2">&quot;$eq&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mi">3</span>
                    <span class="p">}</span>
                <span class="p">]</span>
            <span class="p">}</span>

        <span class="p">]</span>

    <span class="p">}</span>

<span class="n">topo</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;info&#39;</span><span class="p">]:</span>
    <span class="n">ip</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">][</span><span class="s1">&#39;bk_host_innerip&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">module</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="s1">&#39;module&#39;</span><span class="p">]:</span>
        <span class="n">topo2</span> <span class="o">=</span> <span class="n">module</span><span class="p">[</span><span class="s1">&#39;TopModuleName&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)</span>
        <span class="n">sett</span> <span class="o">=</span> <span class="n">topo2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">modd</span> <span class="o">=</span> <span class="n">topo2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">topo2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">sett</span><span class="p">,</span> <span class="s1">&#39;pid&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">sett</span><span class="p">}</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">topo</span><span class="p">:</span>
            <span class="n">topo</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">sett</span><span class="p">,</span> <span class="s1">&#39;pid&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">sett</span><span class="p">})</span>
        <span class="k">if</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">modd</span><span class="p">,</span> <span class="s1">&#39;pid&#39;</span><span class="p">:</span> <span class="n">sett</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">modd</span><span class="p">}</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">topo</span><span class="p">:</span>
            <span class="n">topo</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">modd</span><span class="p">,</span> <span class="s1">&#39;pid&#39;</span><span class="p">:</span> <span class="n">sett</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">modd</span><span class="p">})</span>
        <span class="k">if</span> <span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">ip</span><span class="p">,</span> <span class="s1">&#39;pid&#39;</span><span class="p">:</span> <span class="n">modd</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">ip</span><span class="p">}</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">topo</span><span class="p">:</span>
            <span class="n">topo</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">ip</span><span class="p">,</span> <span class="s1">&#39;pid&#39;</span><span class="p">:</span> <span class="n">modd</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">ip</span><span class="p">})</span>

<span class="n">rdp</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">ConnectionPool</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">port</span><span class="o">=</span><span class="mi">6379</span><span class="p">)</span>
<span class="n">rdc</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">connection_pool</span><span class="o">=</span><span class="n">rdp</span><span class="p">)</span>

<span class="n">topo</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">topo</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
<span class="n">rdc</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s1">&#39;cmdb&#39;</span><span class="p">,</span><span class="nb">str</span><span class="p">({</span><span class="s1">&#39;value&#39;</span><span class="p">:</span><span class="n">topo</span><span class="p">}))</span>
</pre></div>


<h3 id="3">3. 封装后台接口</h3>
<ul>
<li>用 <code>flask</code> 开发接口，用于 Openfalcon 前端调用</li>
<li>跨域访问处理 : 调用外部接口，需要解决跨域问题</li>
</ul>
<div class="codehilite"><pre><span></span><span class="c1">#-*-coding:utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">flask</span>
<span class="kn">import</span> <span class="nn">redis</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">jsonify</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">request</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">make_response</span>

<span class="n">server</span> <span class="o">=</span> <span class="n">flask</span><span class="o">.</span><span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="nd">@server.route</span><span class="p">(</span><span class="s1">&#39;/topo_new_ztree/&#39;</span><span class="p">,</span><span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">search_new_ztree</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :method: post</span>
<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">rdp</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">ConnectionPool</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">6379</span><span class="p">)</span>
        <span class="n">rdc</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">connection_pool</span><span class="o">=</span><span class="n">rdp</span><span class="p">)</span>
        <span class="n">topo</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">rdc</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cmdb&#39;</span><span class="p">))[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;success&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">topo</span><span class="p">}))</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">make_response</span><span class="p">(</span><span class="n">jsonify</span><span class="p">({</span><span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)},</span> <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="s1">&#39;fail&#39;</span><span class="p">}))</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Access-Control-Allow-Origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Access-Control-Allow-Methods&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;POST&#39;</span>
        <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Access-Control-Allow-Headers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;x-requested-with,content-type&#39;</span>
        <span class="k">return</span> <span class="n">response</span>
</pre></div>


<h3 id="4">4. 前端样式调整</h3>
<p>修改 Open-Falcon 前端页面<code>dashboard/rrd/templates/index.html</code></p>
<p>前端拓扑树选择 <code>ztree</code> 插件：支持模糊查询，勾选事件等，具体功能可查询 <a href="http://www.treejs.cn/v3/api.php" title="ztree">官方 API</a></p>
<ul>
<li>调用上述的接口, <code>ztree</code> 加载返回结果</li>
<li>拓扑树中可以自定义勾选事件</li>
</ul>
<div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="nx">post_url</span><span class="o">=</span><span class="s1">&#39;/topo_new_ztree/&#39;</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">createTree</span><span class="p">(</span><span class="nx">post_url</span><span class="p">){</span>
  <span class="kd">var</span> <span class="nx">zTree</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">setting</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">check</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">enable</span><span class="o">:</span> <span class="kc">true</span>
    <span class="p">},</span>
    <span class="nx">view</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">dblClickExpand</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="nx">data</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">simpleData</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">enable</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
        <span class="nx">idKey</span><span class="o">:</span> <span class="s2">&quot;id&quot;</span><span class="p">,</span>
        <span class="nx">pIdKey</span><span class="o">:</span> <span class="s2">&quot;pid&quot;</span><span class="p">,</span>
        <span class="nx">rootPId</span><span class="o">:</span> <span class="mi">0</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="nx">callback</span><span class="o">:</span><span class="p">{</span>
      <span class="nx">onCheck</span><span class="o">:</span><span class="nx">onCheck</span>
    <span class="p">}</span>

  <span class="p">};</span>
  <span class="kd">function</span> <span class="nx">onCheck</span><span class="p">(){</span>
    <span class="c1">//自定义勾选事件</span>
  <span class="p">};</span>
  <span class="nx">$</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">post_url</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
    <span class="nx">zTree</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">fn</span><span class="p">.</span><span class="nx">zTree</span><span class="p">.</span><span class="nx">init</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#tree&quot;</span><span class="p">),</span> <span class="nx">setting</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">message</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span>
</pre></div>


<h3 id="5">5. 预览效果</h3>
<p>可直接通过左侧的服务树选择资源，十分方便。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/15642788068769.jpg" /></p>
<p>改造前，查找资源只能通过检索，十分不便，如下图：</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/CMDB/media/15643014658046.jpg" /></p>
<blockquote>
<p>注: CMDB 中的资源经常变动，建议使用事件驱动的<a href="5.1/配置平台/产品功能/ModelManagement.md">消息推送</a>来监听资源变化，而不是周期获取。</p>
</blockquote><h1 id="_1">应用交付，从人工到自动化的转变</h1>
<blockquote>
<p>在提升企业应用交付效率的同时，输出运维价值</p>
</blockquote>
<p><a href="5.1/bk_solutions/CD/CMDB/Configuration_management_standardization.md">配置管理标准化</a> 提到，运维服务“四化建设”的标准化是如何规范运维在配置管理、发布、变更、故障处理、监控告警等场景的运维能力，重点阐述企业如何建设 <strong>配置管理标准化</strong>。</p>
<p>接下来，我们通过理论配合实践（以 <a href="5.1/标准运维/产品简介/README.md">蓝鲸标准运维</a>为例），分析"四化建设"第 2 个阶段 : <strong>自动化</strong> ，如何 <strong>让应用交付从人工到自动化的转变，在提升企业应用交付效率的同时，输出运维价值</strong>。</p>
<p>首先，我们看下应用交付遇到的痛点。</p>
<h2 id="_2">应用交付痛点</h2>
<p>管理者觉得在 <strong>质量、效率、成本、安全上你做得都很差</strong>，而作为执行者的你，<strong>心累、身体累的同时还担心哪天不小心背锅而走</strong>。</p>
<ul>
<li>应用部署至生产环境周期长，无法快速迭代</li>
<li>部署过程中跨越多个运维系统，操作较为繁琐，容易出错</li>
<li>部署到生产环境后，可能面临回滚</li>
<li>无法直观查看部署进展,心里没底</li>
<li>每周大部分时间投入到发布、变更、故障处理，谈什么运维价值</li>
<li>运维操作零散，不可审计，无法满足合规性要求</li>
<li>...</li>
</ul>
<h2 id="1">1. 项目目标</h2>
<h3 id="11">1.1 术语解释</h3>
<ul>
<li><strong>资源编排</strong> : (Resource Orchestration)，用户定义资源的编排流程，工具执行编排流程，执行时只关注输入，提升重复性应用/资源交付的运维效率。</li>
<li><strong>持续集成</strong>[1] : (Continues Integration)，Code -&gt; 自动化测试 -&gt; 合入主分支 -&gt; 归档构建（最好是捕获 commit 事件自动触发 CI ）</li>
<li><strong>持续交付</strong> : (Continues Delivery)，归档构建 -&gt; 测试环境自动交付（ CI 成功后，会自动触发持续交付，在同一个 pipeline 中）</li>
<li><strong>持续部署</strong> : (Continues Deployment)，归档构建 -&gt; 生产环境自动部署（灰度发布、全量发布等）</li>
</ul>
<h3 id="12">1.2 项目目标</h3>
<p>在运维"四化建设"基石" <strong>标准化</strong> "的基础上，从 <strong>运维四要素</strong> ：<code>质量</code>、<code>效率</code>、<code>成本</code>、<code>安全</code>的角度出发，以实现应用交付自动化的目标。</p>
<ul>
<li>标准化：通过流程模板固化在标准化阶段沉淀的发布、变更、故障处理流程</li>
<li>运维四要素<ul>
<li>质量：减少人工实施导致的人为错误</li>
<li>效率：应用交付提速，从多天 1 发到 1 天多发</li>
<li>成本：认领工单后，只需关注交付结果，让运维更聚焦增值服务</li>
<li>安全：满足安全合规要求，实现应用交付过程可视化，交付历史归档可查</li>
</ul>
</li>
</ul>
<p><img alt="应用交付自动化的目标" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/%E5%BA%94%E7%94%A8%E4%BA%A4%E4%BB%98%E8%87%AA%E5%8A%A8%E5%8C%96%E7%9A%84%E7%9B%AE%E6%A0%87-1.png" /></p>
<h2 id="2">2. 技术选型</h2>
<p>需要一套资源编排工具，<strong>串接应用交付过程中的各个原子节点</strong>。如执行类：文件分发、命令执行、DB 提单等，周边类：告警屏蔽、任务通知、审批等，流程类：认领 ITSM 单据，结单等）。</p>
<p>放眼行业，资源编排在公有云中早有对应的成熟工具[2]</p>
<table>
<thead>
<tr>
<th>行业应用</th>
<th>AWS</th>
<th>Azure</th>
<th>谷歌云</th>
<th>阿里云</th>
<th>青云</th>
</tr>
</thead>
<tbody>
<tr>
<td>对应产品</td>
<td><a href="https://docs.aws.amazon.com/zh_cn/AWSCloudFormation/latest/UserGuide/Welcome.html">Cloud Formation</a></td>
<td><a href="https://docs.microsoft.com/zh-cn/azure/azure-resource-manager/resource-group-overview">Azure-RM</a> </td>
<td><a href="https://cloud.google.com/deployment-manager/docs/quickstart">Cloud Deployment Manager</a></td>
<td><a href="https://help.aliyun.com/document_detail/28852.html">ROS</a></td>
<td><a href="https://docs.qingcloud.com/product/operation/topology">RO</a></td>
</tr>
</tbody>
</table>
<p><img alt="内网负载均衡器" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/%E5%86%85%E7%BD%91%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%99%A8.png" /></p>
<p>（青云的资源编排工具）</p>
<p>然而，行业慢慢关注混合云，从信通院发布的《混合云白皮书（2019 年）》[3]中获悉，2018 年国内混合云的占有率为 8.1% ，同期全球占比 58%，以至于 Terraform[4]慢慢成长起来了。</p>
<p>然而，这些资源编排工具只能满足企业在云端（公有云、私有云、混合云）资源的编排，包括 Ansible 在内的自动化工具 <strong>无法满足应用交付过程中与企业 IT 系统的交互</strong> ，比如发布工单、CMDB、审批流程等等，更多仍然还是偏执行。</p>
<p>蓝鲸标准运维，正是解决上述行业痛点。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15617076684346.jpg" /></p>
<p>标准运维在蓝鲸体系中位于 SaaS 场景层，通过 PaaS 层的 ESB 或 API Gateway 与原子平台层的 CMDB、作业平台等平台交互。</p>
<p><img alt="标准运维在蓝鲸体系中的定位" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/%E6%A0%87%E5%87%86%E8%BF%90%E7%BB%B4%E5%9C%A8%E8%93%9D%E9%B2%B8%E4%BD%93%E7%B3%BB%E4%B8%AD%E7%9A%84%E5%AE%9A%E4%BD%8D-1.png" /></p>
<p>确立了技术方案后，接下来介绍如何在企业内部实施标准运维，实现应用交付自动化。</p>
<p>如何实施标准运维，请参考场景案例：<a href="5.1/bk_solutions/CD/CMDB/CMDB_integration.md">应用如何自动化部署至生产环境</a>、<a href="ops_half_automation.md">应用交付人力转移，让运维更专注业务优化</a>。</p>
<h2 id="3">3. 技术发展方向</h2>
<p>蓝鲸体系内覆盖更多的场景，如告警屏蔽、解屏蔽，关联 ITSM 工单等，<strong>单一来源使其自成体系</strong>，体验更流畅。</p>
<p><strong>丰富持续部署领域所依赖资源的标准插件</strong>，如各大公有云和私有云（ Openstack 等）的资源（云主机、数据库、中间件等），向 Terraform 看齐。</p>
<p>支持<strong>模板语法</strong>（如 YAML、JSON、Python、Jinja 等），增强复杂场景的编排能力。</p>
<p><strong>开放基于 BPMN 的画布设计器</strong>，不止与底层编排服务，让更多的场景 SaaS（如运营活动逻辑的自助配置）可以低成本的构建。</p>
<p>标准运维负责 DevOps 流程的 CD（持续部署）部分，将版本部署至生产环境，而 <a href="https://github.com/Tencent/bk-ci">蓝盾 CI 平台</a> 负责之前的 CI（持续集成）+ CD（持续交付）, 二者间的联动，让整个 DevOps 流程更加流畅。</p>
<p>现在你还在通过二进制的方式部署你的业务，但再过 2 年可能就不是这样了，已有不少行业已在使用容器编排服务，部署模式已经发生了革新的转变。所以在蓝鲸体系内，<a href="https://github.com/Tencent/bk-bcs">蓝鲸容器管理平台</a>将补上这块能力的空缺。</p>
<p>万丈高楼平地起，标准化、自动化需要依次建设，技术没有弯道超车。</p>
<p>最后希望，企业的 IT 系统建设能够逐步演进、完善，让广大运维兄弟真正能交付运维价值，体会运维这个岗位给企业带来的价值。</p>
<p>来吧，一起共建属于大家的开源自动化运维项目：<a href="https://github.com/Tencent/bk-sops">标准运维</a>！</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15617132080186.jpg" /></p>
<p>（开源共建标准运维）</p>
<h2 id="_3">扩展阅读</h2>
<ul>
<li>[1] 阮一峰. <a href="http://www.ruanyifeng.com/blog/2015/09/continuous-integration.html">持续集成是什么？</a> [EB/OL]，2015-9-23</li>
<li>[2] 唐盛军. <a href="https://bbs.huaweicloud.com/blogs/50719c3767c411e89fc57ca23e93a89f">全球公有云编排服务大比拼</a> [EB/OL]，2018-6-4</li>
<li>[3] 中国信息通信研究院. <a href="https://mp.weixin.qq.com/s/efqSLdrKu0OtWiUsCullyg">《混合云白皮书（2019 年）》</a> [EB/OL]，2019-6-17</li>
<li>[4] Terraform. <a href="https://www.terraform.io/intro/vs/cloudformation.html">Terraform vs. CloudFormation, Heat, etc.</a> [EB/OL]</li>
<li>[5] 叶光芳. <a href="https://mp.weixin.qq.com/s/rCPDpxDG5v_BFo1gPRNq3w">赣州银行利用蓝鲸标准运维实现容灾一键切换</a> [EB/OL]，2019-5-28</li>
<li>[6] 元鼎科技. <a href="https://mp.weixin.qq.com/s/MPNjXzpOMqgigvUVzU8hiA">金融行业落地自动化持续交付</a> [EB/OL]，2019-4-9</li>
<li>[7] 蓝鲸. <a href="https://mp.weixin.qq.com/s/Qk0kL-581cugcRXiJnqKgg">企业运维自动化新玩法</a> [EB/OL]，2019-3-14</li>
<li>[8] 蓝鲸. <a href="https://github.com/Tencent/bk-sops">Github Tencent/bk-sops</a> [EB/OL]</li>
<li>[9] 蓝鲸. <a href="https://github.com/Tencent/bk-cmdb">Github Tencent/bk-cmdb</a> [EB/OL]</li>
<li>[10] 蓝鲸. <a href="https://github.com/Tencent/bk-ci">Github Tencent/bk-ci</a> [EB/OL]</li>
<li>[11] 蓝鲸. <a href="https://github.com/Tencent/bk-bcs">Github Tencent/bcs</a> [EB/OL]</li>
</ul><h2 id="_1">管控混合云架构下的基础设施</h2>
<h2 id="_2">情景</h2>
<p>随着云计算浪潮的推进，多云管控逐渐成为趋势，多云间网络无法互通。</p>
<p>接下来看下蓝鲸是如何管控多云主机。</p>
<h2 id="_3">前提条件</h2>
<ul>
<li><a href="5.1/部署维护/README.md">部署完蓝鲸</a></li>
</ul>
<p><strong>术语解释</strong></p>
<ul>
<li><strong>GSE Server</strong> : <a href="5.1/管控平台/产品简介/README.md">蓝鲸管控平台</a>的后台服务，由文件分发、命令执行、数据上报三个模块组成。</li>
<li><strong>GSE Proxy</strong> : 跨云网络中，GSE Server 和跨云网络中被管控主机的代理，实现对跨云网络主机的管控。</li>
<li><strong>Agent</strong> : 运行在被管控主机上的代理程序，实现文件分发、命令执行以及数据上报。</li>
<li><strong>VPC</strong> : (Virtual Private Cloud)，私有网络，逻辑隔离的网络空间，每个私有网络内的服务资源内网互通，不同私有网络之间内网不通，但可通过新建<strong>对等连接</strong>来连通。</li>
<li><strong>云区域</strong> : 标识 VPC 网络，蓝鲸多云管控的关键字段，通过 租户 ID( bk_supplier_id )、云区域、IP 三者唯一标识主机。</li>
<li><strong>直连网络</strong> : 蓝鲸后台服务所在的网络，该网络下管控的主机与蓝鲸后台互通。</li>
</ul>
<h2 id="_4">操作步骤</h2>
<ul>
<li>梳理网络拓扑</li>
<li>管理直连网络区域的主机</li>
<li>管理跨云网络区域的主机</li>
</ul>
<h3 id="1">1. 梳理网络拓扑</h3>
<p>以下是一个经典的多云管控网络拓扑图。</p>
<p>蓝鲸所在的网络为 <code>VPC 1</code> ，通过<code>直连方式</code>管理该网络区域的主机，通过带有外网的 <code>GSE Proxy</code> 来管理公有云的主机（网络为 <code>VPC 2</code> 和 <code>VPC 3</code>）。</p>
<p><img alt="-w1093" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15658731519358.jpg" /></p>
<blockquote>
<p>上图是从管控角度绘制的网络拓扑图。</p>
<p>在跨云管控的场景下，在蓝鲸所在 VPC 1 网络下发安装 Agent 的行为，还需要蓝鲸后台的 <a href="5.1/部署维护/基础包安装/环境准备/get_ready.md">Nginx 模块</a> 具备外网 IP，供 VPC 2 和 VPC 3 网络的 GSE Proxy 下载 Proxy 和 Agent 安装包。</p>
</blockquote>
<h3 id="2">2. 管理直连网络区域的主机</h3>
<p>先介绍如何管控蓝鲸后台服务所在网络（也称直连网络）的主机。</p>
<h4 id="21-agent">2.1 安装 Agent</h4>
<p>打开 <a href="5.1/节点管理/README.md">节点管理</a> ，选择 <code>直连区域</code>，按提示填写 <code>IP地址</code>、<code>操作系统</code>、<code>端口</code>、<code>账号</code>、<code>密码</code>。</p>
<p><img alt="-w1338" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15644828249316.jpg" /></p>
<p>点击<code>开始安装</code>，稍等片刻安装完成。</p>
<p><img alt="-w1341" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15644828965485.jpg" /></p>
<p>在<code>插件管理</code>页面可以查看该主机上运行的插件状态和版本号。</p>
<p><img alt="-w1506" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15644866467462.jpg" /></p>
<p>在配置平台的<code>主机详情页</code>，可以看到该台主机的<code>实时状态</code>。</p>
<p><img alt="-w1395" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15644830563012.jpg" /></p>
<p>在<code>主机详情页</code>的属性 TAB 页，可以看到<code>自动发现</code>的主机属性，源于运行在被管控主机上的<code>basereport</code>插件主动上报。</p>
<p><img alt="-w1583" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15644831112494.jpg" /></p>
<p>在<code>变更记录</code>TAB 页可以知道，节点管理在安装 Agent 的过程中会向配置平台导入主机。</p>
<p><img alt="-w1397" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15644830879910.jpg" /></p>
<h4 id="22">2.2 命令执行和分发文件测试</h4>
<p>使用作业平台<code>执行脚本</code>和<code>分发文件</code>做测试。</p>
<p>{% video %}media/blueking_execute_push_file.mp4{% endvideo %}</p>
<h3 id="3">3. 管理跨云网络区域的主机</h3>
<p>接下来介绍，如何管控跨云网络（例如 VPC 2 和 VPC 3）的主机。</p>
<h4 id="31">3.1 策略开通</h4>
<p>跨云网络中，通过<strong>GSE Proxy</strong> 代理 GSE Server 与跨云网络中被管控主机的流量，实现对跨云网络主机的管控。</p>
<p>点击节点管理右侧的【 ？帮助】菜单，会显示节点管理安装 Agent、Proxy 的架构图，以及 GSE Proxy 与 GSE Server 通信相互开通的策略。</p>
<p><img alt="-w1676" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15659228204608.jpg" />
<img alt="-w1675" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15659228393010.jpg" /></p>
<p>完成上述网络访问策略开通,接下来，准备安装 GSE Proxy。</p>
<h4 id="32-gse-proxy">3.2 安装 GSE Proxy</h4>
<p>为了演示方便，将网络拓扑图 中的 VPC 2 命名为“腾讯云”，你也可以命名为“广州三区”或“上海三区”等。</p>
<p>现在添加<strong>云区域</strong>，如<code>腾讯云</code>。</p>
<p>选择菜单【安装 Agent】，点击【云区域管理】，然后【添加云区域】，如“腾讯云”。</p>
<p><img alt="-w1666" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15659237466295.jpg" /></p>
<p>填写 Proxy 的内网、外网 IP 地址，以及账号，点击【开始安装】。</p>
<p><img alt="-w1329" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15644871367752.jpg" /></p>
<p>完成 Proxy 的安装，在【云区域管理】列表中可以找到已经安装好的 Proxy。</p>
<p><img alt="-w1493" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15646466711340.jpg" /></p>
<p>完成 Proxy 的安装，接下来安装该网络下的 Agent。</p>
<h4 id="33-agent">3.3 安装 Agent</h4>
<p>选择菜单【安装 Agent】，点击【腾讯云】，【添加 P-Agent】，然后点击【开始安装】。</p>
<p><img alt="-w1494" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15646466260902.jpg" /></p>
<p>完成该网络下的 Agent 安装。</p>
<p><img alt="-w1676" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15653223254775.jpg" /></p>
<p>在【配置平台】中也可以找到对应的主机和主机属性。</p>
<p><img alt="-w1678" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15659268976255.jpg" /></p>
<h4 id="34">3.4 命令执行和分发文件测试</h4>
<p>使用作业平台<code>执行脚本</code>和<code>分发文件</code>做测试。</p>
<p>{% video %}media/bk_nodeman.mp4{% endvideo %}</p>
<h2 id="_5">扩展阅读</h2>
<h3 id="_6">多级级联：管理隔离网络的主机</h3>
<p>在部分企业网络环境中，存在 <code>VPC 1（蓝鲸所处网络）</code> 和 <code>VPC 3</code> 不互通，但需要管控 VPC 3 网络主机的场景，如下图：</p>
<p><img alt="-w1274" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15658731695414.jpg" /></p>
<p>这时候，需要企业网络环境中，存在一个 VPC 2 的网络， 通过申请网络策略，连通 VPC1 和 VPC 3 中的指定（最小策略，安全）服务器。</p>
<p>这时需要使用蓝鲸管控平台的<strong>多级级联</strong>功能， VPC 3 网络中的主机与 GSE Proxy 2 互通，GSE Proxy 2 通过 上联 GSE Proxy 1 与 蓝鲸 GSE Server 通信。</p>
<blockquote>
<p><code>多级级联</code>功能尽请期待。</p>
</blockquote><h1 id="37">37 秒完成万台服务器的目录标准化</h1>
<h2 id="_1">情景</h2>
<p>对运行在上万台服务器上的业务服务做标准化的调整（还历史债务），经过多轮的灰度验证，计划对剩下数万台服务器批量操作。</p>
<h2 id="_2">前提条件</h2>
<ul>
<li>服务器已在 <a href="5.1/bk_solutions/CD/CMDB/CMDB_management_hosts.md">CMDB 注册</a></li>
<li>拥有服务器所在 CMDB 中业务的运维权限</li>
</ul>
<h2 id="_3">操作步骤</h2>
<ul>
<li>新建作业</li>
<li>执行和查看执行结果</li>
</ul>
<h3 id="1">1. 新建作业</h3>
<p>按照标准化的需求，我们需要将 <code>gsectl</code> 文件推送至 <code>/usr/local/gse_bkte/agent/bin/</code> 目录，为了确保万无一失，做 MD5 校验。</p>
<p>作业模板如下：</p>
<p><img alt="job_magnanimity" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/job_magnanimity.png" /></p>
<p>提示：为了阐述作业平台中的两个全局参数：<code>IP</code> 和 <code>云参</code>，我们通过 <a href="5.1/bk_solutions/CD/Automation/ops_half_automation.md">需求自助化</a> 中用到的作业模板来介绍。</p>
<p><img alt="-w1670" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15638759120598.jpg" /></p>
<p>IP 这个参数，我们一般建议使用 <a href="5.1/配置平台/产品功能/BuzResource.md">动态分组</a>，因为服务器会有故障替换的可能，IP 会变。</p>
<p><code>云参</code>在脚本中可以直接引用。</p>
<p><img alt="-w1395" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15638755522581.jpg" /></p>
<h3 id="2">2.执行作业及查看执行结果</h3>
<p>点击<code>执行作业</code>后，在 9946 台服务器上总耗时 37 秒。</p>
<p><img alt="job_magnanimity_history_list" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/job_magnanimity_history_list.png" /></p>
<p>其中分发 gsectl 文件耗时 13 秒。</p>
<p><img alt="job_magnanimity_history_push_file" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/job_magnanimity_history_push_file.png" /></p>
<p>MD5 校验耗时 24 秒。</p>
<p><img alt="job_magnanimity_history_exec_script" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/job_magnanimity_history_exec_script.png" /></p><h1 id="_1">一次标准的应用交付自动化案例</h1>
<h2 id="_2">情景</h2>
<p>应用发布是运维这个岗位的职能之一，发布关联多个 ITIL 系统的功能模块，比如发布单、监控的告警屏蔽、DB 变更、业务内公告、统一登录入口等，频繁在多个系统间切换，不但影响效率而且容易出错，同时无法可视化查看发布进度以及事后的回溯。</p>
<p>接下来，一起看下标准运维是如何解决这些痛点。</p>
<h2 id="_3">前提条件</h2>
<ul>
<li><a href="5.1/bk_solutions/CD/CMDB/CMDB_management_hosts.md">主机在蓝鲸 CMDB 中管理</a></li>
</ul>
<p><strong>术语解释</strong>
 - <strong>流程模板</strong> : 标准化的资源和应用交付模式，通过资源编排引擎，实现对资源的创建、配置，实现自动化交付资源或应用，行业中一般称之为<code>pipeline</code>、<code>资源编排模板</code>，比如一次发布任务可以编排为一个流程模板。
 - <strong>标准插件</strong> : 多个执行节点通过编排规则实现流程模板，其中的执行节点称之为 标准插件，比如<code>执行脚本</code>为一个标准插件</p>
<p>更多详见 <a href="5.1/标准运维/术语解释/glossary.md">术语定义</a></p>
<h2 id="_4">操作步骤</h2>
<ul>
<li>梳理：梳理标准化模板</li>
<li>建模：新建流程模板</li>
<li>执行：执行流程</li>
</ul>
<h3 id="1">1. 梳理标准化模板</h3>
<p><a href="5.1/bk_solutions/CD/CMDB/Configuration_management_standardization.md">配置管理标准化</a>中提到，运维服务“四化建设”的标准化包含配置管理、发布、变更、故障处理、监控告警等场景的流程制定。以发布为例，通过流程图梳理应用交付的流程。</p>
<p>分为发布前准备、发布中、发布后检查三部分。</p>
<p><img alt="应用交付自动化" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/%E5%BA%94%E7%94%A8%E4%BA%A4%E4%BB%98%E8%87%AA%E5%8A%A8%E5%8C%96-1.png" /></p>
<h3 id="2">2. 创建流程模板</h3>
<p>为了简化演示，将流程图中的关键节点在标准运维的业务流程模板中体验出来。</p>
<p>选择<code>[流程模板]</code> -&gt; <code>[业务流程]</code>，点击<code>新建</code>来创建业务流程模板。</p>
<p>从左侧标准插件区，选择发布流程中需要的标准插件作为流程的节点，比如<code>执行作业</code>, 向右拖动到画布。</p>
<p><img alt="-w1606" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15644736844126.jpg" /></p>
<p>选择作业平台中准备好的 <code>作业模板</code>，然后新建 <code>全局变量</code>，并将全局变量填充到节点的参数中。</p>
<p><img alt="-w1603" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15644771226551.jpg" /></p>
<p>按照上述步骤，完成一个应用发布的流程模板。</p>
<p><img alt="-w1606" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15644773728491.jpg" /></p>
<blockquote>
<p>标准运维内置了 CMDB、作业平台、通知等标准组件，如果不在此列的，需要开发标准运维插件来 <a href="5.1/bk_solutions/CD/Automation/intergration_itil.md">集成企业内部 ITIL 系统</a>。</p>
</blockquote>
<p>这里重点说明 <code>全局参数</code> 和 <code>流程分支</code>。</p>
<h4 id="21">2.1 全局参数</h4>
<p>服务器发生故障后，保障下一次应用发布获取最新的 IP 列表，可以通过 IP 选择器实现。</p>
<p><img alt="-w1602" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15644781544003.jpg" /></p>
<h4 id="22">2.2 流程分支</h4>
<p>应用发布过程中，执行成功 和 执行失败的处理分支不同，可以通过流程分支功能对上一步执行结果为真或为假来判断。</p>
<p><img alt="-w1173" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15644783233169.jpg" /></p>
<p>提前引用上一步流程节点的输出参数<code>执行结果</code>，将其用于上图中的流程分支表达式。</p>
<p><img alt="-w1127" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15644782523637.jpg" /></p>
<h3 id="3">3. 执行流程</h3>
<p>在业务流程列表中，点击<code>新建任务</code></p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15638818330008.jpg" /></p>
<p>点击执行任务流程</p>
<p>{% video %}media/sops_execution.mp4{% endvideo %}</p>
<h2 id="_5">扩展阅读</h2>
<h3 id="_6">上下文传参</h3>
<p>将一个流程节点的输出作为另一个流程节点的输入。</p>
<p>比如第 1 步输出 MD5 值 ，第 2 步分发版本，第 3 步使用第 1 步中生成的 MD5 值 来校验版本的一致性，效果如下：</p>
<p><img alt="-w1486" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15616298718559.jpg" /></p>
<p>主要用到标准运维流程节点中的 <strong>引用输出参数</strong>，引用第 1 步中的 <code>release_md5</code> 变量。</p>
<p><img alt="-w1641" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15616299242595.jpg" /></p>
<p><code>release_md5</code>变量需要提前在作业模板中设置，如下图：</p>
<p><img alt="-w1417" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15644779332012.jpg" />
<img alt="-w1274" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15629369392955.jpg" /></p><h2 id="_1">操作员做应用交付，让运维更专注</h2>
<h2 id="_2">情景</h2>
<p>应用交付虽然做到了自动化，但运维仍需和周边团队跟进流程，耗费大量时间，此时通过 <a href="5.1/标准运维/产品简介/README.md">标准运维</a> <code>职能化</code> 的能力将应用交付的流程，转移给操作员执行。</p>
<p>运维 <code>blueking</code> 提交一个应用发布的职能化任务给到 <code>caozuo(操作员A）</code>，<code>caozuo(操作员A)</code> 执行任务，跟进任务执行的进展。</p>
<h2 id="_3">前提条件</h2>
<ul>
<li>在标准运维中 <a href="5.1/标准运维/产品功能/flow.md">建立一个流程</a></li>
<li>准备两个角色：<code>运维</code> 和  <a href="5.1/PaaS平台/产品功能/系统管理/UserManage.md">职能化(操作员)</a></li>
</ul>
<h2 id="_4">操作步骤</h2>
<ul>
<li>准备职能化角色</li>
<li>运维发起职能化任务流程</li>
<li>职能化认领任务</li>
</ul>
<h3 id="1">1. 准备职能化角色</h3>
<p>在<code>用户管理</code>中新增<code>职能化账户</code>，如<code>操作员A</code></p>
<p><img alt="-w1226" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15626758602537.jpg" /></p>
<p>将其添加至业务的<code>操作人员</code>角色中</p>
<p><img alt="-w1358" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15626757873636.jpg" /></p>
<p>在标准运维的<code>业务流程</code>中给<code>职能化</code>授权</p>
<p><img alt="-w1678" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15626655943347.jpg" /></p>
<h3 id="2">2. 运维发起职能化任务流程</h3>
<p>运维选择一个应用发布流程，点击<code>新建任务</code>，选择<code>职能化任务流程</code></p>
<p><img alt="-w1673" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15626651187357.jpg" /></p>
<h3 id="3">3. 职能化认领任务</h3>
<p>用<code>操作员A</code>的角色访问标准运维，在<code>职能化中心</code>中认领刚才新建的<code>职能化任务</code></p>
<p><img alt="-w1484" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15626652375328.jpg" /></p>
<p>如果不需要修改参数，点击<code>认领</code>即可</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15626653433243.jpg" /></p>
<p>点击<code>执行</code>按钮</p>
<p><img alt="-w1666" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15626726352252.jpg" /></p>
<p>可以看到任务执行的状态
{% video %}media/stag_delivery.mp4{% endvideo %}</p>
<p>在<code>职能化中心</code>可以看到任务已经执行完成。</p>
<p><img alt="-w1433" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15627514845867.jpg" /></p>
<p>对应运维视角，也可以看到任务已执行完成。</p>
<p><img alt="-w1589" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15627516202535.jpg" /></p>
<p>如此，运维可以把日常的应用发布需求提交给操作员执行，释放自己，把精力多放在<code>运维服务目录输出</code>以及<code>业务优化</code>上。</p>
<h2 id="_5">扩展阅读: 设置任务执行者</h2>
<p>操作员执行任务流程时，标准运维从<code>任务执行者</code>字段获取运维人员列表，如果不填，则为该业务的随机运维人员。</p>
<p><img alt="-w1349" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15626743700020.jpg" /></p><h1 id="it">开发标准运维插件，集成内部 IT 系统</h1>
<h1 id="_1">情景</h1>
<p>标准运维内置了蓝鲸体系内作业平台、配置平台等系统的原子，但应用交付过程中还包含了部分企业内部的 ITIL 系统，例如<code>DB变更</code>、<code>监控</code>、<code>工单</code>，需要开发标准运维的标准插件，将应用交付过程中，使用到的能力或接口集成到标准运维中。</p>
<h1 id="_2">前提条件</h1>
<ul>
<li>掌握 <a href="5.1/开发指南/SaaS开发/新手入门/macOS.md">蓝鲸 SaaS 开发</a>，打开 <a href="https://cloud.tencent.com/edu/learning/major-100008">腾讯运维开发实战课</a> 马上学习</li>
<li>掌握 <a href="5.1/开发指南/扩展开发/API网关/README.md">蓝鲸 API 网关开发</a></li>
</ul>
<h1 id="_3">步骤</h1>
<ul>
<li>梳理逻辑</li>
<li>开发环境初始化</li>
<li>蓝鲸 API 网关开发</li>
<li>标准插件后台开发</li>
<li>标准插件前端开发</li>
<li>标准插件测试</li>
</ul>
<h2 id="1">1. 梳理逻辑</h2>
<p>标准运维要调用 IT 系统的功能特性，比如<code>执行 DB 变更</code>或<code>告警屏蔽</code>，需要将对应 API 对接至蓝鲸 ESB 中，然后再开发标准运维的标准插件。</p>
<p>以下为标准插件的调用逻辑图。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/15643115225611.jpg" /></p>
<blockquote>
<p>注：建议 IT 系统的功能特性和标准运维解耦，标准运维不包含功能逻辑，仅负责转发。</p>
</blockquote>
<h2 id="2">2. 开发环境初始化</h2>
<p>在开始开发之前，先把 <a href="5.1/开发指南/SaaS开发/新手入门/macOS.md">蓝鲸 SaaS 的开发环境</a>准备好。</p>
<p>然后在 <strong>标准运维项目根目录</strong> 下执行 <code>Django-admin startapp custom_atoms</code> ，接着新建<code>components/collections</code> 和 <code>static/custom_atoms</code> 目录。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/31.png" /></p>
<p>打开<code>conf/settings_custom.py</code>文件，找到<code>INSTALL_APPS_CUSTOM</code>，加入<code>custom_atoms</code>。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/32.png" /></p>
<h2 id="3-esb-api">3. 接入 ESB API</h2>
<p>参照 <a href="5.1/开发指南/扩展开发/API网关/README.md">蓝鲸 API 网关开发指南</a>完成 ESB 接入，然后更新标准运维<code>bluking/component</code>下的文件。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/33.png" /></p>
<h2 id="4">4. 标准插件后台开发</h2>
<p>在<code>custom_atoms/components/collections</code>目录下创建 <code>test.py</code> 文件，其中需要定义的属性和类如下所示。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/34.png" /></p>
<p><strong>test.py 属性详解</strong>：</p>
<ul>
<li><code>__group_name__</code> ：标准插件所属分类（一般是对应 API 的系统简称，如配置平台(CMDB)）</li>
<li><code>class TestCustomService(Service)</code> ：标准插件后台执行逻辑</li>
<li><code>__need_schedule__</code> = True：是否是异步执行，默认为 False</li>
<li><code>interval = StaticIntervalGenerator(5)</code> ：异步标准插件的轮询策略</li>
<li><code>def execute</code> ：前端参数获取、API 参数组装、结果解析、结果输出</li>
<li><code>def schedule</code> ：轮询逻辑、结果输出</li>
<li><code>def outputs_format</code> ：输出参数格式化</li>
<li><code>class TestCustomComponent(Component)</code> ：标准插件定义</li>
<li><code>name</code> ： 标准插件名称</li>
<li><code>code</code> ：唯一编码</li>
<li><code>bound_service</code> ：绑定后台服务</li>
<li><code>form</code> ：前端表单定义文件路径</li>
</ul>
<p><strong>TestCustomService 中 execute 函数详解</strong>：
- 可以是任何 Python 代码，如果对应于 ESB API 调用，一般分为参数组装、API 调用、结果解析。
- <code>data</code> 是标准插件前端数据，对应于前端的表单，可以用 get_one_of_inputs 获取某一个参数；执行完成可以使用 set_outputs 写入返回值和异常信息(ex_data)。
- <code>parent_data</code> 是任务的公共参数，包括 excutor—执行者，operator—操作员，biz_cc_id—所属业务 ID。详细请查看 gcloud/taskflow3/utils.py。
- 返回 True 表示标准插件执行成功，False 表示执行失败</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/35.png" /></p>
<p><code>TestCustomService</code> 中 <code>execute</code> 函数详解：
- 返回列表格式。
- 列表格式的每一项定义一个返回字段，是 execute 函数中的 set_outputs 输出的字段的子集；key—输出字段标识，name—输出字段含义，type—输出字段类型（str、int 等 python 数据结构）。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/36.png" /></p>
<p><code>TestCustomService</code> 中 <code>shedule</code> 函数详解：
- 由 <code>interval</code> 控制调用策略，如 pipeline.core.flow.activity.StaticIntervalGenerator（每隔多少秒轮询一次）、DefaultIntervalGenerator（每次轮询间隔时间是上一次的两倍）。
- 使用 <code>self.finish_schedule</code> 结束轮询。
- 返回 <code>True</code> 表示标准插件执行成功，<code>False</code> 表示执行失败。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/37.png" /></p>
<h2 id="5">5. 标准插件前端开发</h2>
<p>在 <code>custom_atoms/static/custom_atoms</code> 目录下创建 <code>test</code> 目录，并创建 <code>test_custom.js</code> 文件，注意文件路径和标准插件后台定义的 form 保持一致。通过 <code>$.atoms</code> 注册标准插件前端配置，其中各项含义是：
- <code>test_custom</code> ：标准插件后台定义的 code。
- <code>tag_code</code> ：参数 code，请保持全局唯一，命名规范为“系统名_参数名”
- <code>type</code> ：前端表单类型，可选 input、textarea、radio、checkbox、select、datetime、datatable、upload、combine 等
- <code>attrs</code> ：对应 type 的属性设置，如 name、validation</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/38.png" /></p>
<h2 id="6">6. 标准插件测试</h2>
<p>创建流程模板，新增标准插件节点，标准插件类型选择新开发的标准插件，展示的输入参数和前端配置项一致，输出参数和后台 <code>outputs_format</code> 一致，其中执行结果是系统默认，值是<code>True</code> 或 <code>False</code> ，表示节点执行结果是成功还是失败。</p>
<p><img alt="标准插件开发" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/%E6%A0%87%E5%87%86%E6%8F%92%E4%BB%B6%E5%BC%80%E5%8F%91.png" /></p>
<p>根据上一步创建的流程模板，新建任务执行后查看结果。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/40.png" /></p>
<p>如果标准插件执行出错，请先查看节点执行详情，确定是否是代码逻辑异常。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/41.png" /></p>
<p>接着查看 APP 组件类型日志，确定是都是 ESB API 调用异常。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/Automation/media/42.png" /></p>
<h2 id="_4">提交代码</h2>
<p>执行 <code>python manage.py collectstatic –noinput</code>，然后就可以提交代码并打包发布了。</p>
<h1 id="_5">标准插件开发规范</h1>
<ul>
<li>分组命名规则是“系统名(系统英文缩写)”，如“作业平台(JOB)”。</li>
<li>标准插件编码(code)使用下划线方式，规则是“系统名_接口名”，如 job_execute_task。</li>
<li>后台类名使用驼峰式，规则是“标准插件编码+继承类名”，如 JobExecuteTaskService。</li>
<li>前端 JS 文件目录保持和系统名缩写一致，JS 文件名保持和标准插件编码一致。</li>
<li>参数 <code>tag_code</code> 命名规则是“系统名_参数名”，这样可以保证全局唯一；长度不要超过 20 个字符。</li>
</ul><h1 id="_1">需求自助化:测试自助调整验收环境</h1>
<h2 id="_2">情景</h2>
<p>测试同学经常找运维同学调整测试环境的配置，比如调整不同的角色或代币（<strong>本文以调整角色为例</strong>）来验证功能是否符合预期，一来让运维时间碎片化，二来交付给需求方的时间不固定，需求方也不满意，影响整体效率。</p>
<p>需要一种让需求方自助操作的入口，简化输入，关注输出，解脱运维的同时提升需求方的满意度。</p>
<h2 id="_3">前提条件</h2>
<ul>
<li>准备一个<code>测试</code>角色，并在蓝鲸配置平台中将其添加到业务的<code>测试人员</code>角色中</li>
<li>准备调整角色的标准运维流程模板</li>
</ul>
<h2 id="_4">操作步骤</h2>
<ul>
<li>新建标准运维流程模板</li>
<li>新建自助调角色轻应用</li>
<li>测试轻应用</li>
</ul>
<h2 id="1">1. 新建标准运维流程模板</h2>
<h3 id="11">1.1 新建流程模板</h3>
<p>调整用户角色的逻辑很简单，一般作业平台的一个作业即可满足，此处不展开介绍如何创建作业。</p>
<p>新建流程模板，如下。</p>
<p><img alt="-w1678" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/media/15638707333072.jpg" /></p>
<p>由于轻应用重点之一是<code>简化输入</code>，所以尽可能方便需求方填写参数。此处有 2 个参数：<code>角色</code> 和 <code>账号</code>。</p>
<p>角色一般可以枚举，所以使用<code>下拉框</code>，简化输入。</p>
<p><img alt="-w411" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/media/15638716485845.jpg" /></p>
<p>账号这里是数字，使用<code>输入框</code>，同时加上正则，帮用户纠错。</p>
<p><img alt="-w421" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/media/15638715975909.jpg" /></p>
<p>保存任务流程，并执行任务，验证任务流程可调整角色。</p>
<h3 id="12">1.2 给测试账号授权</h3>
<p>选择流程模板，对<code>测试</code>账号 ceshi 赋予 <code>新建</code>、<code>执行</code>任务权限.</p>
<p><img alt="qinyingyong-quanxian" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/media/qinyingyong-quanxian.png" /></p>
<p>在<code>业务配置</code>中设置任务真正的执行者（比如执行作业平台的作业），因为测试没有运维权限。</p>
<p><img alt="-w1362" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/media/15638727701253.jpg" /></p>
<h2 id="2">2. 新建自助调角色轻应用</h2>
<p>点击<code>轻应用</code>导航栏，按提示新建轻应用。</p>
<p><img alt="qinyingyong_xxx" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/media/qinyingyong_xxx.png" /></p>
<h2 id="3">3. 测试轻应用</h2>
<p>使用测试账号 ceshi 登录蓝鲸，找到刚才创建的<code>自助调角色</code>SaaS。</p>
<p><img alt="-w967" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/media/15642119684271.jpg" /></p>
<p>点击<code>自助调角色</code>SaaS</p>
<p><img alt="-w1336" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/media/15638726755169.jpg" /></p>
<p>执行任务</p>
<p><img alt="-w1336" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/media/15638727133832.jpg" /></p>
<p>至此，测试同学自助调整测试环境的轻应用已配置完毕，后续测试同学直接打开<code>自助调角色</code>SaaS 即可完成需求。</p>
<p>此外，如产品和测试需要调整配置，DBA 需要 AWR 报告，测试需要添加白名单等等运维的日常需求，均可以通过轻应用方式解决，<strong>简化输入，关注输出</strong>，在解脱运维的同时，还能提升需求的满意度。</p><h1 id="nginx">快速构建 Nginx 集群</h1>
<h2 id="_1">情景</h2>
<p>传统的 Nginx 集群要先部署多个 Nginx 节点，然后通过 <code>upstream</code> 统一一个入口提供给用户访问。</p>
<p>该过程操作繁琐，接下来看 BCS（容器管理平台） 如何通过 <strong>容器调度 (以 K8S 编排为例，BCS 同时还支持 Mesos)</strong> 快速构建 Nginx 集群。</p>
<h2 id="_2">前提条件</h2>
<ul>
<li><a href="https://kubernetes.io/zh/docs/concepts/">K8S 基本概念</a>，包含  <a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/deployment/">Deployment</a>、<a href="https://kubernetes.io/docs/concepts/services-networking/service/">Services</a>。</li>
<li><a href="5.1/部署维护/增强包安装/部署安装/bcs_install.md">完成 BCS 部署</a></li>
<li>准备 2 台云主机：4 核 8 G，不低于 CentOS 7，K8s Master 和 Node 各 1 台</li>
<li>完成上述 2 台云主机的 Agent 安装 ，并分配至 CMDB 业务下</li>
</ul>
<h2 id="_3">操作步骤</h2>
<ul>
<li>新建集群</li>
<li>BCS 快速构建 Nginx 集群</li>
</ul>
<h3 id="1">1. 新建集群</h3>
<h4 id="11">1.1 启用容器服务</h4>
<p>在 BCS 首页，点击<code>新建项目</code>，如<code>欢乐游戏(demo)</code>。</p>
<p><img alt="-w1378" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15648362836651.jpg" /></p>
<p>然后选择容器编排类型为 <code>Kubernetes</code> ，关联前提条件中提到的 CMDB 业务，点击<code>启用容器服务</code>。</p>
<p><img alt="-w1304" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15648364147641.jpg" /></p>
<h4 id="12">1.2 新建集群</h4>
<p><code>启用容器服务</code>后，进入容器服务欢迎页，点击<code>创建容器集群</code>。</p>
<p><img alt="-w1361" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15648365448905.jpg" /></p>
<p>按提示填写集群的基本信息。</p>
<p><img alt="-w1368" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15648366557109.jpg" /></p>
<blockquote>
<p>容器服务的集群划分和 <a href="5.1/bk_solutions/CD/CMDB/CMDB_management_hosts.md">传统单体应用在 CMDB 中的集群划分</a> 很类似，可以按照<code>地域（如华北区）</code>或者<code>完全独立的应用集合（微信区）</code>来划分。</p>
</blockquote>
<p>选择 1 台云主机作为 Master。</p>
<p><img alt="-w1368" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15648366389029.jpg" /></p>
<p>点击<code>确定</code>后，集群开始初始化。</p>
<p><img alt="-w1368" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15648367382011.jpg" /></p>
<p>点击<code>节点管理</code></p>
<p><img alt="-w1363" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15648839802641.jpg" /></p>
<p>点击<code>添加节点</code>，按提示节点添加。</p>
<p><img alt="-w1368" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15648840282881.jpg" /></p>
<p>至此，新建集群完毕。可以看到集群的基础信息。</p>
<p><img alt="-w1487" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15648861584543.jpg" /></p>
<p>另外，在集群的设置(<strong>⋮</strong>)下拉菜单中，可以看到集群主要性能指标。</p>
<p><img alt="-w1488" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15648861821783.jpg" /></p>
<h3 id="2-bcs-nginx">2. BCS 快速构建 Nginx 集群</h3>
<h4 id="21">2.1 新建命名空间</h4>
<p>新建命名空间<code>dev</code></p>
<p><img alt="-w1462" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15652519427953.jpg" /></p>
<h4 id="22">2.2 新建模板集</h4>
<p>模板集，可以类比为 K8S 中 <strong><a href="https://helm.sh/">Helm</a></strong> 的<code>Charts</code>，在 K8S 编排中，是 K8S 对象的集合：<code>Deployment（无状态）</code>、<code>StatefulSet（有状态）</code>、<code>DaemonSet（守护进程集）</code>、<code>Job（定时任务）</code>、<code>Configmap（配置项）</code>、<code>Secret（保密字典）</code>，具体参见 <a href="5.1/bcs/Function/TemplateIntroduce.md">模板集使用介绍</a> 。</p>
<p>打开菜单 <code>[模板集]</code>，新建模板集 <code>web-nginx</code>。</p>
<p><img alt="-w1466" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15652520004880.jpg" /></p>
<p>按提示，填写<code>Deployment</code></p>
<p><img alt="-w1465" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15652532175601.jpg" />
<img alt="-w1462" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15652535815272.jpg" /></p>
<p>填写<code>Service</code></p>
<p><img alt="-w1458" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15652542476126.jpg" /></p>
<h4 id="23">2.3 实例化</h4>
<p><img alt="-w1470" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15652543011285.jpg" />
<img alt="-w1466" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15652545088426.jpg" /></p>
<h4 id="24">2.4 检查部署效果</h4>
<p>在菜单 <code>网络</code> -&gt; <code>Services</code> 中，找到刚实例化的 Service <code>web-nginx</code></p>
<p><img alt="-w1465" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15652551496895.jpg" /></p>
<p>在菜单 <code>[应用]</code> -&gt; <code>[Deployment]</code> 中可以找到 <code>web-nginx</code></p>
<p><img alt="-w1464" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15652552229901.jpg" /></p>
<p>以及其运行指标</p>
<p><img alt="-w1463" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15652552369974.jpg" /></p>
<p>通过访问 <code>Node+NodePort</code>，可以查看刚刚部署 Nginx 集群的版本号。</p>
<div class="codehilite"><pre><span></span><span class="o">[</span>root@ip-10-0-5-94-n-bcs-k8s-40015 ~<span class="o">]</span><span class="c1"># curl 10.0.5.94:30008 -I</span>
HTTP/1.1 <span class="m">200</span> OK
Server: nginx/1.12.2
Date: Thu, <span class="m">08</span> Aug <span class="m">2019</span> <span class="m">09</span>:11:42 GMT
</pre></div>


<p>通过访问 <code>Service IP + Port</code> ，也可以查看刚部署 Nginx 的版本号。</p>
<div class="codehilite"><pre><span></span><span class="o">[</span>root@ip-10-0-5-94-n-bcs-k8s-40015 ~<span class="o">]</span><span class="c1"># curl 10.254.11.4:8088 -I</span>
HTTP/1.1 <span class="m">200</span> OK
Server: nginx/1.12.2
Date: Thu, <span class="m">08</span> Aug <span class="m">2019</span> <span class="m">09</span>:12:33 GMT
Content-Type: text/html
Content-Length: <span class="m">612</span>
Last-Modified: Tue, <span class="m">11</span> Jul <span class="m">2017</span> <span class="m">13</span>:29:18 GMT
Connection: keep-alive
ETag: <span class="s2">&quot;5964d2ae-264&quot;</span>
Accept-Ranges: bytes
</pre></div><h1 id="_1">应用的滚动升级</h1>
<h2 id="_2">情景</h2>
<p>传统的应用更新方式是停服更新，用户在更新期间 <strong>无法使用服务</strong> 。</p>
<p>接下来，将以 Nginx 从 <code>1.12.2</code> 升级 <code>1.17.0</code> 为例，看 BCS 中的 <strong>滚动更新能力</strong> 是如何实现 <strong>不停机更新</strong> ，<strong>用户无感知</strong>。</p>
<h2 id="_3">前提条件</h2>
<ul>
<li><a href="https://kubernetes.io/zh/docs/concepts/">K8S 基本概念</a>，包含 <a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/deployment/">Deployment</a>、<a href="https://kubernetes.io/docs/concepts/services-networking/service/">Services</a>。</li>
<li><a href="5.1/部署维护/增强包安装/部署安装/bcs_install.md">完成 BCS 部署</a></li>
</ul>
<h2 id="_4">操作步骤</h2>
<ul>
<li>滚动更新逻辑介绍</li>
<li>BCS 滚动更新操作指引</li>
</ul>
<h3 id="1">1. 滚动更新逻辑介绍</h3>
<p>滚动更新的逻辑如下图，创建一个新版本的实例（ POD），销毁一个旧版本实例（POD），如此滚动，直至线上都是新版本，旧版本已全部销毁。</p>
<p>滚动更新对用户无感知。</p>
<p><img alt="-w1549" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15652581859764.jpg" /></p>
<h3 id="2-bcs">2. BCS 滚动更新操作指引</h3>
<h4 id="21-nginx1170">2.1 推送 Nginx:1.17.0 至镜像仓库</h4>
<p>参照 <a href="5.1/bcs/Function/HarborGuide.md">Harbor 仓库使用指南</a>，将镜像 Nginx:1.17.0 推送至 BCS 公共镜像仓库。</p>
<h4 id="211">2.1.1 注册镜像仓库账号</h4>
<p>在 <a href="5.1/部署维护/增强包安装/环境准备/bcs_envprepare.md">部署 BCS</a> 的中控机上获取镜像仓库的访问地址。</p>
<div class="codehilite"><pre><span></span><span class="c1"># source /data/install/utils.fc &amp;&amp; echo ${HARBOR_SERVER_FQDN}:${HARBOR_SERVER_HTTPS_PORT}</span>
hub-d.o.******.com:443
</pre></div>


<p>登录仓库地址，注册镜像仓库账号。</p>
<p><img alt="-w1051" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15652566855628.jpg" /></p>
<p>注册完，登录后可以访问公共仓库。</p>
<p><img alt="-w1478" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15652567813655.jpg" /></p>
<h4 id="212-nginx1170">2.1.2 推送 Nginx:1.17.0 至镜像仓库</h4>
<p>使用 <code>docker pull</code> 从 <code>hub.docker.com</code> 拉取镜像 <code>nginx:1.17.0</code>。</p>
<div class="codehilite"><pre><span></span><span class="c1"># docker pull nginx:1.17.0</span>
<span class="m">1</span>.17.0: Pulling from library/nginx
fc7181108d40: Pull <span class="nb">complete</span>
c4277fc40ec2: Pull <span class="nb">complete</span>
780053e98559: Pull <span class="nb">complete</span>
Digest: sha256:bdbf36b7f1f77ffe7bd2a32e59235dff6ecf131e3b6b5b96061c652f30685f3a
Status: Downloaded newer image <span class="k">for</span> nginx:1.17.0
</pre></div>


<p>规范镜像 <code>tag</code> 为仓库要求的格式。</p>
<div class="codehilite"><pre><span></span><span class="c1"># docker tag nginx:1.17.0 hub-d.******.com/public/nginx:1.17.0</span>

<span class="c1"># docker images</span>
REPOSITORY                                                                TAG                  IMAGE ID            CREATED             SIZE
nginx                                                                     <span class="m">1</span>.17.0               719cd2e3ed04        <span class="m">8</span> weeks ago         109MB
hub-d.******.com/public/nginx                                           <span class="m">1</span>.17.0               719cd2e3ed04        <span class="m">8</span> weeks ago         109MB
</pre></div>


<p>推动镜像至 BCS 镜像仓库。</p>
<div class="codehilite"><pre><span></span><span class="c1"># docker push hub-d.******.com/public/nginx:1.17.0</span>
The push refers to repository <span class="o">[</span>hub-d.******.com/public/nginx<span class="o">]</span>
d7acf794921f: Pushed
d9569ca04881: Pushed
cf5b3c6798f7: Pushed
<span class="m">1</span>.17.0: digest: sha256:079aa93463d2566b7a81cbdf856afc6d4d2a6f9100ca3bcbecf24ade92c9a7fe size: <span class="m">948</span>
</pre></div>


<p>在镜像仓库中，可以找到刚推送的 <code>Nginx:1.17.0</code> 镜像。</p>
<p><img alt="-w1465" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15652572564612.jpg" /></p>
<p>在 BCS 的<code>[仓库菜单]</code>中也可以找到。</p>
<p><img alt="-w1462" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15652575817580.jpg" /></p>
<h4 id="22-nginx-1122-1170">2.2 滚动升级 Nginx ：从 1.12.2 到 1.17.0</h4>
<p>确认当前版本号为<code>nginx/1.12.2</code></p>
<div class="codehilite"><pre><span></span><span class="o">[</span>root@ip-10-0-5-94-n-bcs-k8s-40015 ~<span class="o">]</span><span class="c1"># curl 10.0.5.94:30008 -I</span>
HTTP/1.1 <span class="m">200</span> OK
Server: nginx/1.12.2
Date: Thu, <span class="m">08</span> Aug <span class="m">2019</span> <span class="m">09</span>:11:42 GMT
</pre></div>


<p>在【模板集】的【Deployment】页面中，修改【镜像及版本】，将版本从 <code>1.12.2</code> 修改为在推送 Nginx:1.17.0 至镜像仓库中上传的 Nginx 新镜像 <code>1.17.0</code>。</p>
<p><img alt="-w1633" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15652627456802.jpg" /></p>
<p>点击【更多设置】，了解默认滚动升级的更新策略。</p>
<p><img alt="-w1269" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15659379375124.jpg" /></p>
<blockquote>
<ul>
<li><code>maxUnavailable</code> : 滚动升级期间，考虑应用容量，不可用 Pod 的数量上限</li>
<li><code>maxSurge</code> : 滚动升级期间，考虑集群资源，超出期望 Pod 的数量上限</li>
<li><code>minReadySeconds</code> : 滚动升级期间，考虑可用性，探测 Pod 正常后转为可用的时间  </li>
</ul>
</blockquote>
<p>修改完镜像的版本后，接下来【保存】模板集，填写【新版本】的版本号。</p>
<p><img alt="-w1633" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15652627905254.jpg" /></p>
<p>接着，开始滚动升级。点击菜单【应用】 -&gt; 【Deployment】，找到<code>web-nginx</code>应用，点击【滚动升级】。</p>
<p><img alt="-w1637" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15652616938580.jpg" /></p>
<p>可以看到，差异点是<code>images</code>从<code>nginx:1.12.2</code>调整为<code>nginx:1.17.0</code></p>
<p><img alt="-w1637" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15652628433125.jpg" /></p>
<p>点击【确定】滚动升级后，正在更新。</p>
<p><img alt="-w1636" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15652628788988.jpg" /></p>
<p>通过 右下角的 【Web console】 可以通过命令行的方式获取实例(POD)的基础信息。</p>
<p><img alt="-w1636" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15652622109567.jpg" /></p>
<p>以下是更新前后的对比</p>
<div class="codehilite"><pre><span></span>root:~$ kubectl get pods -n dev -o wideNAME                         READY   STATUS    RESTARTS   AGE    IP            NODE                           NOMINATED NODE
web-nginx-678bb9c4fb-m8cf4   <span class="m">1</span>/1     Running   <span class="m">0</span>          134m   <span class="m">172</span>.32.1.18   ip-10-0-5-94-n-bcs-k8s-40015   &lt;none&gt;
web-nginx-678bb9c4fb-nxwf4   <span class="m">1</span>/1     Running   <span class="m">0</span>          134m   <span class="m">172</span>.32.1.17   ip-10-0-5-94-n-bcs-k8s-40015   &lt;none&gt;

root:~$ kubectl get pods -n dev -o wide
NAME                        READY   STATUS    RESTARTS   AGE   IP            NODE                           NOMINATED NODE
web-nginx-f95ffc78d-cxhrq   <span class="m">1</span>/1     Running   <span class="m">0</span>          21s   <span class="m">172</span>.32.1.20   ip-10-0-5-94-n-bcs-k8s-40015   &lt;none&gt;
web-nginx-f95ffc78d-pqtcj   <span class="m">1</span>/1     Running   <span class="m">0</span>          14s   <span class="m">172</span>.32.1.21   ip-10-0-5-94-n-bcs-k8s-40015   &lt;none&gt;
</pre></div>


<p>可以看到<code>Nginx</code>版本已经从<code>1.12.2</code>更新为<code>1.17.0</code></p>
<div class="codehilite"><pre><span></span><span class="o">[</span>root@ip-10-0-5-94-n-bcs-k8s-40015 ~<span class="o">]</span><span class="c1"># curl 10.0.5.94:30008 -I</span>
HTTP/1.1 <span class="m">200</span> OK
Server: nginx/1.17.0
</pre></div><h1 id="_1">应用的蓝绿发布（原：研发测试环境管理）</h1>
<h2 id="_2">情景</h2>
<p>传统的应用更新方式是<strong>停服更新</strong>，用户在更新期间<strong>无法使用服务</strong>。</p>
<p>接下来，将以 Nginx 从 <code>1.12.2</code> 升级 <code>1.17.0</code> + 程序代码（index.html 的内容从 Nginx 默认页 更新为 1.17.0）为例，看 BCS 中的<strong>蓝绿发布能力</strong>是如何实现<strong>不停机更新</strong>，<strong>用户无感知</strong>。</p>
<h2 id="_3">前提条件</h2>
<ul>
<li><a href="https://kubernetes.io/zh/docs/concepts/">K8S 基本概念</a>，包含 <a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/deployment/">Deployment</a>、<a href="https://kubernetes.io/docs/concepts/services-networking/service/">Services</a>；本节教程新增概念：<a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/">ConfigMap</a>、<a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">Ingress</a>、<a href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/">Ingress Controllers</a>。</li>
<li><a href="5.1/部署维护/增强包安装/部署安装/bcs_install.md">完成 BCS 部署</a></li>
</ul>
<h2 id="_4">操作步骤</h2>
<ul>
<li>应用的蓝绿发布逻辑介绍</li>
<li>使用 K8S 资源准备版本</li>
<li>使用 K8S 资源准备新版本</li>
<li>切换流量并观察</li>
</ul>
<h3 id="1">1. 蓝绿发布逻辑介绍</h3>
<h4 id="11">1.1 发布逻辑示意图</h4>
<p>蓝绿发布，即准备当前运行版本 和 新版本 两组实例，正式发布的时候，修改服务的域名的 DNS 记录将，将其指向新版本的 Ingress 指向的地址 。</p>
<p><img alt="-w1303" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15680799749131.jpg" /></p>
<h4 id="12">1.2 版本更新流程中引入的对象</h4>
<p>以 Nginx 从 <code>1.12.2</code> 升级 <code>1.17.0</code> + 程序代码（index.html 的内容从 Nginx 默认页 更新为 1.17.0）为例，使用以下几个 新的对象：</p>
<ul>
<li>程序代码或可执行文件（index.html） ：Docker 镜像</li>
<li>程序或运行环境配置（nginx.conf） ：ConfigMap</li>
<li>负载均衡器 （LoadBalancer）+ Ingress ： 用户接入和负载均衡</li>
</ul>
<p>其中 Deployment、Service 不再赘述。</p>
<h3 id="2-k8s">2. 使用 K8S 资源准备版本</h3>
<h4 id="21-loadbalancer">2.1 新增 LoadBalancer</h4>
<p>Ingress 是 K8S 中描述用户接入的对象之一， 需要配合 LB 应用才能对外提供访问。</p>
<p>在 BCS 中，LoadBalancer 背后的技术是 K8S 维护的 <strong>Nginx Ingress Controller</strong>。</p>
<p>选择菜单【LoadBalancer】，点击【新建 LoadBalancer】，选择一个节点作为 LB 对外提供网络接入服务。</p>
<p><img alt="-w1678" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15659439205670.jpg" /></p>
<blockquote>
<p>建议业务 Pod 不调度至 LB 所在的节点，可使用 节点亲和性（nodeAffinity）实现。</p>
</blockquote>
<h4 id="22-configmap-nginxconf">2.2 Configmap ： 存放 nginx.conf</h4>
<p>在【模板集】菜单中，选择【Configmap】，新建 nginx.conf 和 default.conf 两个 configmap，实现<strong>应用程序和配置的解耦</strong>。</p>
<p><img alt="-w1674" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15659435399613.jpg" /></p>
<h4 id="23-k8s-deployment-serviceingress">2.3 创建 K8S 对象 Deployment 、Service、Ingress</h4>
<ul>
<li>创建 Deployment</li>
</ul>
<p>在【Deployment】中，填写 名称、标签（Label）、容器镜像、挂载卷（挂载 Configmap）。</p>
<p><img alt="-w1675" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15659437982262.jpg" />
<img alt="-w1672" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15659438850899.jpg" /></p>
<ul>
<li>创建 Service</li>
</ul>
<p>在【Service】中关联 Deployment 以及服务名称、暴露的端口。</p>
<p><img alt="-w1629" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15680918349969.jpg" /></p>
<ul>
<li>新建 Ingress</li>
</ul>
<p>在【Ingress】中填写 【主机名】、【路径】以及绑定 【Service】。</p>
<p><img alt="-w1629" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15680920723966.jpg" /></p>
<h4 id="24">2.4 实例化模板集</h4>
<p>保存模板集后，实例化模板集。</p>
<p><img alt="-w1678" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15659439491084.jpg" /></p>
<p>可以看到对应资源已生成好。</p>
<ul>
<li>Deployment</li>
</ul>
<p><img alt="-w1678" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15659449765672.jpg" /></p>
<ul>
<li>Service</li>
</ul>
<p><img alt="-w1677" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15659450631792.jpg" /></p>
<ul>
<li>Ingress</li>
</ul>
<p><img alt="-w1677" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15659450818610.jpg" /></p>
<p>修改域名解析或修改 PC 上 hosts 文件（Mac 下路径为 /etc/hosts），将 Ingress 中配置的主机名解析到 LoadBalancer 中节点的外网 IP，然后打开浏览器访问。</p>
<p><img alt="-w1115" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15680984160424.jpg" /></p>
<p>以上作为线上环境运行的版本，接下来部署新版本。</p>
<h3 id="3-k8s">3. 使用 K8S 资源准备新版本</h3>
<p>本次新版本参照微服务更新的最佳实践：将应用程序打入 Docker Image，<strong>更新 Deployment 中的镜像即更新版本</strong>。</p>
<h4 id="31-docker-image">3.1 制作新版本的 Docker Image</h4>
<p>以 index.html 为应用程序，将其打入镜像，由于新版本的运行时是 Ningx 1.17.0，故以  Nginx 1.17.0 为基础镜像。</p>
<ul>
<li>准备 dockerfile</li>
</ul>
<div class="codehilite"><pre><span></span>$ ll
total <span class="m">16</span>
-rw-r--r--  <span class="m">1</span> breaking  staff    49B  <span class="m">9</span> <span class="m">10</span> <span class="m">10</span>:55 dockerfile
-rw-r--r--  <span class="m">1</span> breaking  staff    40B  <span class="m">9</span> <span class="m">10</span> <span class="m">10</span>:54 index.html

$ cat index.html

Welcome to BCS.

Nginx Version: <span class="m">1</span>.17.0

$ cat dockerfile
FROM nginx:1.17.0
COPY index.html /usr/share/nginx/html
</pre></div>


<ul>
<li>构建 Docker Image</li>
</ul>
<div class="codehilite"><pre><span></span>$ docker build -t bcs_nginx:1.17.0 .
Sending build context to Docker daemon  <span class="m">3</span>.072kB
Step <span class="m">1</span>/2 : FROM nginx:1.17.0
 ---&gt; 719cd2e3ed04
Step <span class="m">2</span>/2 : COPY index.html /usr/share/nginx/html
 ---&gt; 9e1342027c80
Successfully built 9e1342027c80
Successfully tagged bcs_nginx:1.17.0

$ docker images
REPOSITORY                                              TAG                   IMAGE ID            CREATED             SIZE
bcs_nginx                                               <span class="m">1</span>.17.0                9e1342027c80        <span class="m">18</span> seconds ago      109MB
</pre></div>


<ul>
<li>推送镜像到仓库</li>
</ul>
<div class="codehilite"><pre><span></span>$ docker tag bcs_nginx:1.17.0 &lt;Registry_URL&gt;/joyfulgame/bcs_nginx:1.17.0

$ docker push &lt;Registry_URL&gt;/joyfulgame/bcs_nginx:1.17.0
The push refers to repository <span class="o">[</span>&lt;Registry_URL&gt;/joyfulgame/bcs_nginx<span class="o">]</span>
8b2c2f2923c8: Pushed
d7acf794921f: Mounted from joyfulgame/nginx
d9569ca04881: Mounted from joyfulgame/nginx
cf5b3c6798f7: Mounted from joyfulgame/nginx
<span class="m">1</span>.17.0: digest: sha256:b608ac54ca92dd092529f9b86403d3a539eab030103e2e0c1a984787ece448c9 size: <span class="m">1155</span>
</pre></div>


<blockquote>
<p>更多 Docker Image 的构建方法可以参考 <a href="https://github.com/nginxinc/docker-nginx/blob/master/stable/alpine/Dockerfile">docker-nginx</a>。</p>
</blockquote>
<h4 id="32">3.2 克隆模板集为新版本</h4>
<p>由于新版本主要在 Deployment 的镜像版本、Ingress 绑定的主机名，以及这几个 K8S 对象的命名差别（同一个命名空间不允许重名），所以克隆模板集，然后修改即可。</p>
<p>点击【复制模板集】，会克隆一个模板集，命名为：蓝绿发布-绿</p>
<p><img alt="-w1678" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15659444709512.jpg" /></p>
<ul>
<li>修改【Deployment】中的名称、标签以及镜像版本。</li>
</ul>
<p><img alt="-w1679" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15681000388594.jpg" /></p>
<ul>
<li>修改【Service】中的名称、关联标签。</li>
</ul>
<p><img alt="-w1620" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15681000844250.jpg" /></p>
<ul>
<li>修改 Ingress，主机名不能上一个版本一样。</li>
</ul>
<p><img alt="-w1631" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15681001549718.jpg" /></p>
<p>最后保存模板集，然后开始实例化模板集。</p>
<p>修改域名解析或修改 PC 上 hosts 文件（Mac 下路径为 /etc/hosts）后，访问 Ingress 中配置的主机名。</p>
<p><img alt="-w513" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15681005088734.jpg" /></p>
<h3 id="4">4. 切换流量并观察</h3>
<p>如果是客户端业务，将请求的后端地址指向为新版本的主机名即可，如果客户端不方便更新配置，可以使用 CNAME 将域名指向到新的版本的主机名。</p>
<p>观察一段时间，如果没有异常，删除原版本的实例即可。</p>
<p><img alt="-w1626" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CD/BCS/media/15681007939276.jpg" /></p>
<ul>
<li>
<p>蓝绿发布的好处：新版本如果发现异常，可以快速的切换到老版本。</p>
</li>
<li>
<p>蓝绿发布的坏处：预备双倍的资源，直到下线老版本。不过如果有云平台，成本可控。</p>
</li>
</ul>
<p>企业可以结合自身实际情况，选择合适的版本发布方式。</p><h1 id="_1">集成内部语音网关实现电话告警</h1>
<blockquote>
<p>特别感谢社区用户 <a href="https://bk.tencent.com/s-mart/personal/10966/">Kevin</a> 提供该文档.</p>
</blockquote>
<h2 id="_2">情景</h2>
<p>故障处理是运维的几大职能之一，重要告警不能漏告，通过微信、邮件、短信等通知方式无法触达，所以需要使用电话告警。</p>
<p>蓝鲸监控默认已支持腾讯云的语音网关，实现电话告警通知，但如果公司已有第三方(非腾讯云)的电话告警服务，该如何接入呢？</p>
<h2 id="_3">前提条件</h2>
<ul>
<li>开通好企业内部语音网关</li>
<li>掌握 <a href="5.1/开发指南/SaaS开发/新手入门/macOS.md">蓝鲸 SaaS 开发</a>，打开 <a href="https://bk.tencent.com/s-mart/community/question/440">腾讯运维开发实战课</a> 马上学习</li>
<li>掌握 <a href="5.1/开发指南/扩展开发/API网关/README.md">蓝鲸 API 网关开发</a></li>
</ul>
<h2 id="_4">操作步骤</h2>
<ul>
<li>梳理逻辑</li>
<li>代码解读</li>
<li>电话告警测试</li>
</ul>
<h3 id="1">1. 梳理逻辑</h3>
<p>对企业内部语音网关封装一个接口，改造蓝鲸 ESB 中语音通知 API 即可。</p>
<p>以下为语音通知的调用逻辑图。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/Monitor_Base/media/15644704218616.jpg" /></p>
<h3 id="2">2. 代码解读</h3>
<h4 id="21">2.1 封装企业内部语音网关接口</h4>
<p>实现内部电话告警接口，并放到 send_voice_msg.py 同一层目录下。</p>
<p>本例中的接口：<code>ums_alarm.ums_tools.send_phone(user_phone_list, content)</code></p>
<p>参数为电话电码列表、告警内容，返回值为调用结果(<code>True</code> / <code>False</code>)和接口的返回消息</p>
<h4 id="22-esb-api">2.2 改造蓝鲸 ESB 中语音通知 API</h4>
<p>在蓝鲸 PaaS 所在机器的消息通知代码目录下，修改 <code>send_voice_msg.py</code></p>
<div class="codehilite"><pre><span></span><span class="nb">source</span> /data/install/utils.fc
ssh <span class="nv">$APPO_IP</span>
<span class="nb">cd</span> /data/bkce/open_paas/esb/components/generic/templates/cmsi/
</pre></div>


<blockquote>
<p>注：企业版请将 <code>bkce</code> 改成 <code>bkee</code></p>
</blockquote>
<h5 id="221">2.2.1 获取请求接口的数据</h5>
<p>原有 <code>send_voice_msg.py</code> 文件已经实现了大部分内容，关键在于 Form 类中的 handle(self) 函数，这个函数已实现从请求接口的数据中获取<code>告警接收人列表data['user_list_information']</code>，另外只需要使用<code>data['auto_read_message']</code>获取告警信息即可。</p>
<div class="codehilite"><pre><span></span><span class="c1"># 公共语音接口/api/c/compapi/cmsi/send_voice_msg/请求参数示例</span>
<span class="p">{</span>
    <span class="s2">&quot;bk_app_code&quot;</span><span class="p">:</span> <span class="s2">&quot;esb_test&quot;</span><span class="p">,</span>
    <span class="s2">&quot;bk_app_secret&quot;</span><span class="p">:</span> <span class="s2">&quot;xxx&quot;</span><span class="p">,</span>
    <span class="s2">&quot;bk_token&quot;</span><span class="p">:</span> <span class="s2">&quot;xxx&quot;</span><span class="p">,</span>
    <span class="s2">&quot;auto_read_message&quot;</span><span class="p">:</span> <span class="s2">&quot;This is a test&quot;</span><span class="p">,</span>
    <span class="s2">&quot;user_list_information&quot;</span><span class="p">:</span> <span class="p">[{</span>
        <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="s2">&quot;admin&quot;</span><span class="p">,</span>
        <span class="s2">&quot;mobile_phone&quot;</span><span class="p">:</span> <span class="s2">&quot;1234567890&quot;</span><span class="p">,</span>
    <span class="p">}]</span>
<span class="p">}</span>
</pre></div>


<h5 id="222">2.2.2 调用企业内部语音告警接口</h5>
<p>修改 <code>#TODO: can be updated</code> 之后的部分，全部注释掉。</p>
<p>使用上一步得到的告警信息 <code>data['auto_read_message']</code> 和上面接口中得到 <code>data['user_list_information']</code> ，根据实际情况组装后，以参数形式调用企业内部语音告警接口即可。</p>
<div class="codehilite"><pre><span></span>    <span class="c1"># TODO: can be updated</span>
    <span class="c1"># -----------------实现下面的代码-----------------</span>
    <span class="c1"># 取告警内容</span>
    <span class="n">v_content</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;auto_read_message&#39;</span><span class="p">]</span>
    <span class="c1"># 获取用户手机列表</span>
    <span class="n">user_phone_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">user_list</span><span class="p">[</span><span class="s1">&#39;mobile_phone&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">user_list</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;user_list_information&#39;</span><span class="p">]]</span>
    <span class="c1"># 调用接口，发送告警</span>
    <span class="n">ret</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">ums_tools</span><span class="o">.</span><span class="n">send_phone</span><span class="p">(</span><span class="n">user_phone_list</span><span class="p">,</span> <span class="n">v_content</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">ret</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
         <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">msg</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;OK&#39;</span>
            <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="s1">&#39;data&#39;</span><span class="p">:</span> <span class="n">msg</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Send voice error&#39;</span>
            <span class="p">}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">payload</span> <span class="o">=</span> <span class="n">result</span>
</pre></div>


<h4 id="23-paas">2.3 重启 PaaS</h4>
<p>蓝鲸中控机上重启 PaaS ，使代码生效</p>
<div class="codehilite"><pre><span></span>/data/install/bkcec stop paas
/data/install/bkcec start paas
</pre></div>


<h3 id="3">3. 电话告警测试</h3>
<p>配置电话告警策略，触发告警，验证结果。</p>
<p><img alt="1564473737697" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/Monitor_Base/media/1564473737697.png" /></p>
<p>告警产生后，手机将收到语音告警电话。</p>
<p>{% video %}media/send_voice_msg.mp3{% endvideo %}</p>
<p>不漏掉任何一个重要的告警。</p><h1 id="_1">概述</h1>
<h2 id="_2">敬请期待</h2><h1 id="_1">概述</h1>
<p>敬请期待</p><h1 id="_1">故障自愈</h1>
<p>故障自愈是行业领先的"故障自动化处理"解决方案，提升企业的服务可用性和降低故障处理的人力投入，实现故障自愈从"人工处理"到"无人值守"的变革!</p>
<p>{% video %}media/fta_brand_video.mp4{% endvideo %}</p>
<p>通过自动化处理节省人力投入，通过预定的恢复流程让恢复过程更可靠，通过并行分析达到更快的故障定位和恢复。</p>
<p>一句话概括：实时发现告警，预诊断分析，自动恢复故障，并打通周边系统实现整个流程的闭环。</p><h1 id="_1">蓝鲸监控告警自动处理</h1>
<h2 id="_2">情景</h2>
<p>故障处理是运维的职能之一，人工登录服务器处理告警，存在 2 个问题：<code>故障处理效率低</code> 和 <code>操作疏忽时可能影响生产环境</code>，例如删除文件输入绝对路径时，在根目录和日志目录间误敲空格，导致根目录删除。</p>
<p>接下来通过 “<strong>蓝鲸监控的进程告警接入故障自愈</strong>”这个案例 ，来了解故障自愈是如何解决这 2 个痛点。</p>
<h2 id="_3">前提条件</h2>
<ul>
<li><a href="../../CD/CMDB/CMDB_management_hosts.md">蓝鲸配置平台纳管了主机</a></li>
<li><a href="../../CD/CMDB/CMDB_management_process.md">蓝鲸配置平台纳管了进程</a></li>
<li><a href="../../CD/Automation/Massive_host_control.md#New_job">作业平台新建一个作业</a></li>
</ul>
<p><strong>术语解释</strong>
 - <strong>自愈套餐</strong> : 告警的处理动作，如拉起进程的作业；
 - <strong>自愈方案</strong> : 关联 告警 和 处理动作的一个组合；</p>
<h2 id="_4">操作步骤</h2>
<ul>
<li>启用蓝鲸监控告警源</li>
<li>接入自愈方案</li>
<li>自愈测试</li>
</ul>
<h3 id="1">1. 启用蓝鲸监控告警源</h3>
<p>在菜单 <code>[接入自愈]</code> -&gt; <code>[管理告警源]</code>中，启用<code>蓝鲸监控</code>。</p>
<p><img alt="-w1678" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/FTA/media/15644862864407.jpg" /></p>
<h3 id="2">2. 接入自愈方案</h3>
<p>在菜单 [接入自愈] 中，点击 <code>接入自愈</code> , 告警类型选择 <code>[主机监控]进程端口</code>，模块选择<code>存储层</code>，因为不同类型服务器拉起进程的作业不一样。</p>
<p>点击新建<code>自愈套餐</code>的按钮，准备新建拉起进程的作业。</p>
<p><img alt="-w1677" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/FTA/media/15644864703986.jpg" /></p>
<p>在套餐中，套餐类型选择 <code>作业平台</code>，新建 <code>启动MariaDB的作业</code> 。</p>
<p><img alt="-w1440" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/FTA/media/15645573643892.jpg" /></p>
<p>点击<code>新建作业的按钮</code>后，跳转至作业平台，在菜单 <code>[作业执行]</code> -&gt; <code>[新建作业]</code> 中，新建如下作业：</p>
<p><img alt="-w1639" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/FTA/media/15645571501689.jpg" /></p>
<div class="codehilite"><pre><span></span><span class="c1"># Check</span>
ps -ef <span class="p">|</span> grep -i mysqld
netstat -ntlp <span class="p">|</span> grep -i <span class="m">3306</span>

<span class="c1"># Start MariaDB</span>
systemctl start mariadb   <span class="o">||</span> job_fail <span class="s2">&quot;start mariadb fail&quot;</span>


<span class="c1"># Check</span>
ps -ef <span class="p">|</span> grep -i mysqld
netstat -ntlp <span class="p">|</span> grep -i <span class="m">3306</span>
netstat -ntlp <span class="p">|</span> grep -i <span class="m">3306</span> <span class="o">||</span> job_fail <span class="s2">&quot;mariadb not listen 3306&quot;</span>

job_success <span class="s2">&quot;start mariadb succ&quot;</span>
</pre></div>


<p>保存<code>启动MariaDB</code>的套餐后，自动回到接入自愈的页面，保存自愈方案即可。</p>
<p><img alt="-w1670" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/FTA/media/15644864936415.jpg" /></p>
<p>回到接入自愈列表，在列表中可以找到刚刚创建的自愈方案。</p>
<p><img alt="-w1678" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/FTA/media/15644865413991.jpg" /></p>
<h3 id="3">3. 自愈测试</h3>
<p>接下来将停止 MariaDB 进程，来验证是否可以自动启动进程，以恢复 DB 服务。</p>
<div class="codehilite"><pre><span></span><span class="c1"># ps -ef | grep -i mysqld</span>
mysql      <span class="m">926</span>     <span class="m">1</span>  <span class="m">0</span> <span class="m">10</span>:47 ?        <span class="m">00</span>:00:00 /bin/sh /usr/bin/mysqld_safe --basedir<span class="o">=</span>/usr
mysql     <span class="m">1159</span>   <span class="m">926</span>  <span class="m">0</span> <span class="m">10</span>:47 ?        <span class="m">00</span>:00:09 /usr/libexec/mysqld --basedir<span class="o">=</span>/usr --datadir<span class="o">=</span>/var/lib/mysql --plugin-dir<span class="o">=</span>/usr/lib64/mysql/plugin --log-error<span class="o">=</span>/var/log/mariadb/mariadb.log --pid-file<span class="o">=</span>/var/run/mariadb/mariadb.pid --socket<span class="o">=</span>/var/lib/mysql/mysql.sock
root     <span class="m">16763</span>  <span class="m">7429</span>  <span class="m">0</span> <span class="m">19</span>:40 pts/1    <span class="m">00</span>:00:00 grep --color<span class="o">=</span>auto -i mysqld
<span class="c1"># systemctl stop mariadb</span>
</pre></div>


<p>稍等片刻，收到蓝鲸监控的进程端口告警。</p>
<p><img alt="-w1441" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/FTA/media/15645579545088.jpg" /></p>
<p>在故障自愈的自愈详情中，找到了该条告警的自愈记录，耗时 21 秒。</p>
<p><img alt="-w1635" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/FTA/media/15645579997854.jpg" /></p>
<p>跳转到作业平台的执行历史，可以看到 MariaDB 已经启动成功。</p>
<p><img alt="-w1635" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/FTA/media/15645580172760.jpg" /></p>
<p>回到监控的事件中心，可以看到 告警已经恢复。</p>
<p><img alt="-w1597" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/FTA/media/15645606328548.jpg" /></p>
<p><strong>告警自动处理，如此简单</strong>。</p>
<p>以上为主机监控的告警自动化处理，其他类型告警请参考对应文档：<a href="5.1/蓝鲸监控/快速入门/组件监控/Component_Monitor_Fault_Auto-recovery.md">组件监控告警自动化处理</a>、<a href="5.1/蓝鲸监控/快速入门/自定义监控/Custom_Monitor_Auto-recovery.md">自定义采集的告警自动化处理</a>。</p>
<p>故障自动处理是把双刃剑，需要考虑因为网络波动等场景导致的假告警，这时可以用到故障自愈的<code>异常防御需审批</code>功能。具体请参照 <a href="./REST_API_PUSH_Alarm_processing_automation.md">故障自愈的收敛防护</a> 。</p>
<p>故障自愈，在<strong>安全的前提下完成告警的自动化处理</strong>。</p><h1 id="zabbix">Zabbix 告警自动处理</h1>
<h2 id="_1">情景</h2>
<p>故障处理是运维的职能之一，<code>Zabbix</code> 自带 <code>ActionScript</code>虽然可以实现告警自动处理，但存在 2 个问题：<code>无法集中管理自动处理的脚本</code>、<code>没有收敛防护，安全性无法保障</code>。</p>
<p>接下来我们通过将 <strong>Zabbix 中磁盘使用率（vfs.fs.*）告警接入故障自愈</strong> 这个案例 ，来了解故障自愈是如何解决这 2 个痛点。</p>
<h2 id="_2">前提条件</h2>
<ul>
<li><a href="../../CD/CMDB/CMDB_management_hosts.md">蓝鲸配置平台纳管了 Zabbix 监控的对象</a></li>
<li>拥有 Zabbix 管理员账号，用于注册 Zabbix Action</li>
</ul>
<p><strong>术语解释</strong>
 - <strong>自愈套餐</strong> : 告警的处理动作，等同于 Zabbix 的 Action；
 - <strong>自愈方案</strong> : 关联 告警 和 处理动作的一个组合；</p>
<h2 id="_3">操作步骤</h2>
<ul>
<li>接入 Zabbix 告警源</li>
<li>接入自愈方案</li>
<li>自愈测试</li>
</ul>
<h3 id="_4">视频教程</h3>
<p>{% video %}media/zabbix_fta.mp4{% endvideo %}</p>
<h3 id="1-zabbix">1. 接入 Zabbix 告警源</h3>
<p>在菜单 [接入自愈] -&gt; [管理告警源] 中，点击 <strong>启用</strong> Zabbix。</p>
<p><img alt="-w1423" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/FTA/media/15643686738143.jpg" /></p>
<p>跳转到接入流程页面</p>
<p><img alt="-w1487" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/FTA/media/15644555486013.jpg" /></p>
<p>Zabbix 接入故障自愈的逻辑是，告警产生时，执行<code>Action</code>，将告警推送至故障自愈接收告警的回调接口。</p>
<p>接下来，我们下载并初始化该<code>Action</code>。</p>
<h4 id="11">1.1 下载初始化脚本</h4>
<p>参照上图，进入 Zabbix Action 的目录 <code>/usr/lib/zabbix/alertscripts</code>，下载初始化脚本 <code>zabbix_fta_alarm.py</code>。</p>
<div class="codehilite"><pre><span></span><span class="o">[</span>root@37ae504b6646 alertscripts<span class="o">]</span><span class="c1"># wget &#39;http://${PaaS_Host}/o/bk_fta_solutions/0/alarm_source/scripts/zabbix_fta_alarm.py?fta_application_id=66fdfe50-3075-49bf-8101-d97386030c9b&amp;fta_application_secret=EfgBbXD25N6870j9nkgf3ns8eOEsH2Sk&#39; -O /usr/lib/zabbix/alertscripts/zabbix_fta_alarm.py --no-check-certificate</span>
</pre></div>


<blockquote>
<p>注：请直接复制故障自愈页面的命令，其中包含故障自愈的页面 URL 以及账号信息。</p>
</blockquote>
<h4 id="12-zabbix">1.2 初始化 Zabbix 告警配置</h4>
<p>执行初始化 Zabbix 告警配置脚本 <code>zabbix_fta_alarm.py</code>，参数依次为 <code>--init</code>、<code>Zabbiz API URL</code>、<code>Zabbix账号</code>、<code>Zabbix密码</code></p>
<div class="codehilite"><pre><span></span><span class="o">[</span>root@37ae504b6646 alertscripts<span class="o">]</span><span class="c1"># chmod  +x zabbix_fta_alarm.py</span>
<span class="o">[</span>root@37ae504b6646 alertscripts<span class="o">]</span><span class="c1"># ./zabbix_fta_alarm.py --init http://${Zabbix_Host}/api_jsonrpc.php  Admin zabbix</span>
<span class="o">[</span><span class="m">2019</span>-07-30 <span class="m">10</span>:51:45,374<span class="o">]</span> INFO fta: get auth token: 136b14f3b8fe226bc02bc5eb4dfd7ac6
<span class="o">[</span><span class="m">2019</span>-07-30 <span class="m">10</span>:51:45,455<span class="o">]</span> INFO fta: action_get success: <span class="o">{</span>u<span class="s1">&#39;jsonrpc&#39;</span>: u<span class="s1">&#39;2.0&#39;</span>, u<span class="s1">&#39;result&#39;</span>: <span class="o">[{</span>u<span class="s1">&#39;actionid&#39;</span>: u<span class="s1">&#39;8&#39;</span><span class="o">}]</span>, u<span class="s1">&#39;id&#39;</span>: <span class="m">1</span><span class="o">}</span>
<span class="o">[</span><span class="m">2019</span>-07-30 <span class="m">10</span>:51:45,572<span class="o">]</span> INFO fta: action_delete success: <span class="o">{</span>u<span class="s1">&#39;jsonrpc&#39;</span>: u<span class="s1">&#39;2.0&#39;</span>, u<span class="s1">&#39;result&#39;</span>: <span class="o">{</span>u<span class="s1">&#39;actionids&#39;</span>: <span class="o">[</span>u<span class="s1">&#39;8&#39;</span><span class="o">]}</span>, u<span class="s1">&#39;id&#39;</span>: <span class="m">1</span><span class="o">}</span>
<span class="o">[</span><span class="m">2019</span>-07-30 <span class="m">10</span>:51:45,640<span class="o">]</span> INFO fta: user_get success: <span class="o">{</span>u<span class="s1">&#39;jsonrpc&#39;</span>: u<span class="s1">&#39;2.0&#39;</span>, u<span class="s1">&#39;result&#39;</span>: <span class="o">[{</span>u<span class="s1">&#39;userid&#39;</span>: u<span class="s1">&#39;6&#39;</span><span class="o">}]</span>, u<span class="s1">&#39;id&#39;</span>: <span class="m">1</span><span class="o">}</span>
<span class="o">[</span><span class="m">2019</span>-07-30 <span class="m">10</span>:51:45,809<span class="o">]</span> INFO fta: user_delete success: <span class="o">{</span>u<span class="s1">&#39;jsonrpc&#39;</span>: u<span class="s1">&#39;2.0&#39;</span>, u<span class="s1">&#39;result&#39;</span>: <span class="o">{</span>u<span class="s1">&#39;userids&#39;</span>: <span class="o">[</span>u<span class="s1">&#39;6&#39;</span><span class="o">]}</span>, u<span class="s1">&#39;id&#39;</span>: <span class="m">1</span><span class="o">}</span>
<span class="o">[</span><span class="m">2019</span>-07-30 <span class="m">10</span>:51:45,902<span class="o">]</span> INFO fta: mediatype_get success: <span class="o">{</span>u<span class="s1">&#39;jsonrpc&#39;</span>: u<span class="s1">&#39;2.0&#39;</span>, u<span class="s1">&#39;result&#39;</span>: <span class="o">[{</span>u<span class="s1">&#39;mediatypeid&#39;</span>: u<span class="s1">&#39;7&#39;</span><span class="o">}]</span>, u<span class="s1">&#39;id&#39;</span>: <span class="m">1</span><span class="o">}</span>
<span class="o">[</span><span class="m">2019</span>-07-30 <span class="m">10</span>:51:45,984<span class="o">]</span> INFO fta: mediatype_delete success: <span class="o">{</span>u<span class="s1">&#39;jsonrpc&#39;</span>: u<span class="s1">&#39;2.0&#39;</span>, u<span class="s1">&#39;result&#39;</span>: <span class="o">{</span>u<span class="s1">&#39;mediatypeids&#39;</span>: <span class="o">[</span>u<span class="s1">&#39;7&#39;</span><span class="o">]}</span>, u<span class="s1">&#39;id&#39;</span>: <span class="m">1</span><span class="o">}</span>
<span class="o">[</span><span class="m">2019</span>-07-30 <span class="m">10</span>:51:46,077<span class="o">]</span> INFO fta: mediatype_create success: <span class="o">{</span>u<span class="s1">&#39;jsonrpc&#39;</span>: u<span class="s1">&#39;2.0&#39;</span>, u<span class="s1">&#39;result&#39;</span>: <span class="o">{</span>u<span class="s1">&#39;mediatypeids&#39;</span>: <span class="o">[</span>u<span class="s1">&#39;8&#39;</span><span class="o">]}</span>, u<span class="s1">&#39;id&#39;</span>: <span class="m">1</span><span class="o">}</span>
<span class="o">[</span><span class="m">2019</span>-07-30 <span class="m">10</span>:51:46,174<span class="o">]</span> INFO fta: user_create success: <span class="o">{</span>u<span class="s1">&#39;jsonrpc&#39;</span>: u<span class="s1">&#39;2.0&#39;</span>, u<span class="s1">&#39;result&#39;</span>: <span class="o">{</span>u<span class="s1">&#39;userids&#39;</span>: <span class="o">[</span>u<span class="s1">&#39;7&#39;</span><span class="o">]}</span>, u<span class="s1">&#39;id&#39;</span>: <span class="m">1</span><span class="o">}</span>
<span class="o">[</span><span class="m">2019</span>-07-30 <span class="m">10</span>:51:46,274<span class="o">]</span> INFO fta: action_create success: <span class="o">{</span>u<span class="s1">&#39;jsonrpc&#39;</span>: u<span class="s1">&#39;2.0&#39;</span>, u<span class="s1">&#39;result&#39;</span>: <span class="o">{</span>u<span class="s1">&#39;actionids&#39;</span>: <span class="o">[</span><span class="m">9</span><span class="o">]}</span>, u<span class="s1">&#39;id&#39;</span>: <span class="m">1</span><span class="o">}</span>
</pre></div>


<p>该脚本会创建一个名为<code>FTA_Event_Handler</code>的 Media Type，名为 <code>FTA_Act</code> 的 Action，名为 <code>FTA_Mgr</code> 的用户。</p>
<p><img alt="-w1475" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/FTA/media/15643875269373.jpg" /></p>
<h3 id="2">2. 接入自愈方案</h3>
<p>Zabbix 告警源 接入成功后，接下来关联告警 和 告警的处理动作。</p>
<p>将 Zabbix 中磁盘容量告警<strong>关联</strong>一个磁盘清理的<strong>处理动作</strong>。</p>
<p>选择菜单 [接入自愈] -&gt; [接入自愈]，点击<strong>接入自愈</strong></p>
<p><img alt="-w1475" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/FTA/media/15644567077537.jpg" /></p>
<p>进入<strong>接入自愈</strong>页面，告警类型选择<code>磁盘容量(vfs.fs.*)</code>，自愈套餐点击 <code>+号</code> 新建 磁盘清理自愈套餐。</p>
<p><img alt="-w1408" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/FTA/media/15644571789970.jpg" /></p>
<p>跳转至磁盘清理的自愈套餐页面。</p>
<p><img alt="-w1415" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/FTA/media/15644572175064.jpg" /></p>
<p>保存自愈套餐后，自动回到接入自愈页面。添加完自愈方案后，在接入自愈列表页可以找到刚才创建的自愈方案。</p>
<p><img alt="-w1466" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/FTA/media/15643924049885.jpg" /></p>
<h3 id="3">3. 自愈测试</h3>
<p>生成一个大文件，使磁盘剩余空间低于 20%（ Zabbix 中默认设定的 Trigger 是&lt;20% ）</p>
<div class="codehilite"><pre><span></span><span class="o">[</span>root@access_layer_breaking gse<span class="o">]</span><span class="c1"># pwd</span>
/data/logs/gse
<span class="o">[</span>root@access_layer_breaking gse<span class="o">]</span><span class="c1"># touch -d &quot;10 days ago&quot; agent-20190726-00001.log</span>
<span class="o">[</span>root@access_layer_breaking gse<span class="o">]</span><span class="c1"># ll</span>
总用量 <span class="m">3906980</span>
-rw-r--r-- <span class="m">1</span> root root <span class="m">4000000000</span> 7月  <span class="m">20</span> <span class="m">11</span>:38 agent-20190726-00001.log
-rw-r--r-- <span class="m">1</span> root root     <span class="m">196795</span> 7月  <span class="m">26</span> <span class="m">23</span>:59 agent-20190726-00002.log
-rw-r--r-- <span class="m">1</span> root root     <span class="m">194952</span> 7月  <span class="m">27</span> <span class="m">23</span>:59 agent-20190727-00003.log
-rw-r--r-- <span class="m">1</span> root root     <span class="m">198532</span> 7月  <span class="m">28</span> <span class="m">23</span>:59 agent-20190728-00004.log
-rw-r--r-- <span class="m">1</span> root root     <span class="m">142948</span> 7月  <span class="m">29</span> <span class="m">17</span>:33 agent-20190729-00005.log
<span class="o">[</span>root@access_layer_breaking gse<span class="o">]</span><span class="c1"># dd if=/dev/zero of=4gb.log bs=1GB count=4</span>
记录了4+0 的读入
记录了4+0 的写出
4000000000字节<span class="o">(</span><span class="m">4</span>.0 GB<span class="o">)</span>已复制，34.0365 秒，118 MB/秒
</pre></div>


<p>稍等片刻，收到 Zabbix 邮件告警，以及故障自愈的处理通知。</p>
<p><img alt="-w1306" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/FTA/media/15644582323388.jpg" /></p>
<p>在故障自愈的 [自愈详情]菜单中也可以找到自愈记录。</p>
<p><img alt="-w1608" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/FTA/media/15644579656827.jpg" /></p>
<p>可以查看详情执行记录。</p>
<p><img alt="-w1124" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/FTA/media/15644579889239.jpg" /></p>
<p><img alt="-w1251" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/FTA/media/15644580199172.jpg" /></p>
<p>从告警产生到处理结束，耗时 30 秒。</p>
<p><strong>告警自动处理，如此简单</strong>，不要再手动登录到服务器上处理告警了。</p>
<h2 id="_5">扩展阅读</h2>
<h3 id="1">1. 告警收敛确保安全的告警自动处理</h3>
<p>选择菜单 <code>[高级配置]</code> -&gt; <code>[告警收敛]</code>，新增高危告警的收敛规则，比如 Ping 告警。</p>
<p>一般网络波动时，可能触发假的 Ping 告警，这时不能直接重启服务器，可以通过告警收敛，让运维审批。</p>
<p><img alt="-w1501" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/FTA/media/15644585231679.jpg" /></p>
<p>具体执行记录，请参照 <a href="./REST_API_PUSH_Alarm_processing_automation.md">故障自愈的收敛防护</a></p>
<h3 id="2_1">2. 健康度日报</h3>
<p>如果服务器频繁触发自愈，那么需要去思考本质问题是什么，是磁盘使用率的告警策略不合适，还是主板故障，亦或是程序运行异常。</p>
<p>这时可以使用 预警功能。</p>
<p>我们在做该教程的时候，在同一天触发了 2 条磁盘使用率的自愈记录，所以产生了一条健康诊断记录。</p>
<p><img alt="-w1645" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/FTA/media/15644587787256.jpg" /></p>
<p>在邮件中也可以找到。</p>
<p><img alt="-w1079" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/FTA/media/15644581460418.jpg" /></p>
<p>可在菜单 <code>[高级配置]</code> -&gt; <code>[接入预警]</code>中设置。</p><h1 id="3">第 3 方监控系统告警自动处理</h1>
<hr />
<h2 id="_1">情景</h2>
<p>故障处理是运维的职能之一，人工登录服务器处理告警，存在 2 个问题：<code>故障处理效率低</code> 和 <code>操作疏忽时可能影响生产环境</code>，例如删除文件输入绝对路径时，在根目录和日志目录间误敲空格，导致根目录删除。</p>
<p>前面介绍了 <a href="./Bkmonitor_Alarm_processing_automation.md">蓝鲸监控</a>、<a href="./Zabbix_Alarm_processing_automation.md">Zabbix</a> 告警的自动处理，接下来通过 “<strong>REST API 告警接入故障自愈</strong>”这个案例 ，来了解故障自愈如何集成第 3 方监控系统。</p>
<h2 id="_2">前提条件</h2>
<ul>
<li><a href="../../CD/CMDB/CMDB_management_hosts.md">蓝鲸配置平台纳管了主机</a></li>
<li><a href="../../CD/Automation/Massive_host_control.md">作业平台新建一个作业</a></li>
</ul>
<p><strong>术语解释</strong>
 - <strong>自愈套餐</strong> : 告警的处理动作，比如清理日志的作业
 - <strong>自愈方案</strong> : 关联 告警 和 处理动作的一个组合</p>
<h2 id="_3">操作步骤</h2>
<ul>
<li>启用 REST API(推送)告警源</li>
<li>接入自愈方案</li>
<li>自愈测试</li>
<li>故障自愈的收敛防护</li>
</ul>
<h3 id="1-rest-api">1. 启用 REST API(推送)告警源</h3>
<p>第 3 方监控系统调用 REST API(推送)接口，故障自愈收到告警后立即做自动化处理。</p>
<p><img alt="告警自动处理RESTAPI" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/FTA/media/%E5%91%8A%E8%AD%A6%E8%87%AA%E5%8A%A8%E5%A4%84%E7%90%86RESTAPI.png" /></p>
<p>首先，启用告警源。</p>
<p>在菜单 <code>[接入自愈]</code> -&gt; <code>[管理告警源]</code>中，启用<code>REST API(推送)</code>。</p>
<p><img alt="-w1607" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/FTA/media/15644897774502.jpg" /></p>
<h3 id="2">2. 接入自愈方案</h3>
<p>在菜单 [接入自愈] 中，点击 <code>接入自愈</code> , 告警类型选择 <code>REST默认分类</code>。</p>
<p>点击新建<code>自愈套餐</code>的按钮，准备一个告警的处理动作。</p>
<p><img alt="-w1462" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/FTA/media/15645495294643.jpg" /></p>
<p>在自愈套餐页面，套餐类型选择<code>作业平台</code>，点击作业名称右侧的加号，新建一个测试的作业模板。</p>
<p><img alt="-w1467" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/FTA/media/15645496712334.jpg" /></p>
<p>点击<code>新建作业的按钮</code>后，跳转至作业平台，在菜单 <code>[作业执行]</code> -&gt; <code>[新建作业]</code> 中，新建一个默认的作业即可。</p>
<p><img alt="-w1618" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/FTA/media/15645586006821.jpg" /></p>
<p>保存<code>REST API测试</code>的自愈套餐后，自动回到接入自愈的页面，保存自愈方案即可。</p>
<p><img alt="-w1632" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/FTA/media/15645586988459.jpg" /></p>
<p>回到接入自愈列表，在列表中可以找到刚刚创建的自愈方案。</p>
<p><img alt="-w1461" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/FTA/media/15645497070309.jpg" /></p>
<h3 id="3_1">3. 自愈测试</h3>
<p>在 <code>REST API(推送)</code>的告警源管理页面，复制调用实例。</p>
<p><img alt="-w1463" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/FTA/media/15645498508783.jpg" /></p>
<p>将示例中的 IP 替换给该业务下任意一个 IP，然后贴到终端下执行。</p>
<p><img alt="-w1677" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/FTA/media/15645500000862.jpg" /></p>
<blockquote>
<p>如果多次调试，请保证<code>source_id</code>唯一（重复会丢弃），<code>source_time</code>和服务器时间一致（过长会丢弃）。</p>
</blockquote>
<p>在<code>自愈详情</code>页面可以找到自愈记录。</p>
<p><img alt="-w1462" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/FTA/media/15645500166456.jpg" /></p>
<p>点开<code>状态</code>按钮，可以查看详情。</p>
<p><img alt="-w1096" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/FTA/media/15645537350395.jpg" /></p>
<p>点击<code>详情</code>中的作业执行 ID，可查看执行的作业。</p>
<p><img alt="-w1469" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/FTA/media/15645537631995.jpg" /></p>
<p>至此，一次模拟告警的故障自愈演示完毕。</p>
<p>REST API(推动) 的场景在于，如果你使用的监控系统故障自愈默认未集成，则可以通过回调 REST API 的方式，将告警推送至故障自愈，故障自愈执行对应的处理动作，完成告警的自动处理。</p>
<h3 id="4">4. 故障自愈的收敛防护</h3>
<p>故障自动处理是把双刃剑，需要考虑因为网络波动等场景导致的假告警，这时可以用到故障自愈的<code>异常防御需审批</code>功能。</p>
<p>在菜单 <code>高级配置</code> -&gt; <code>告警收敛</code>，新建 1 条收敛规则。</p>
<p>告警类型选择<code>REST默认分类</code>，条件为<code>相同业务</code>，触发频次为<code>5分钟2次以上</code>，收敛方式为<code>异常防御需审批</code>，备注填写<code>疑似网络波动，请审批</code>。</p>
<p><img alt="-w1647" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/FTA/media/15645549056435.jpg" /></p>
<p>执行 4 次告警推送后，可以看到多条告警收敛为 1 条告警，需要运维审批。</p>
<p><img alt="-w1647" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/FTA/media/15645548545230.jpg" /></p>
<p><img alt="-w1640" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/FTA/media/15645549476173.jpg" /></p>
<p>故障自愈，在安全的前提下完成告警的自动化处理。</p>
<blockquote>
<p>收敛审批是通过企业微信实现，请参考 <a href="5.1/FTA/Scenes/WeChat_approval_access_process.md">微信审批接入流程</a>。</p>
</blockquote><h1 id="_1">服务器资源申请流程线上化</h1>
<h2 id="_2">情景</h2>
<p>传统的资源申请是 <strong>通过邮件</strong>，沟通成本太高，而且无法回溯。</p>
<p>新业务上线，需要申请几台服务器用于部署应用。接下来，看蓝鲸 ITSM 是如何 <strong>实现服务器申请的流程线上化</strong>。</p>
<h2 id="_3">前提条件</h2>
<ul>
<li>蓝鲸企业版，自带 ITSM SaaS。</li>
<li>准备 1 个 管理员账号，用于<strong>流程设计</strong>；1 个运维账号用于<strong>资源申请</strong> ，1 个 <a href="5.1/PaaS平台/产品功能/系统管理/UserManage.md">普通账号</a> <code>SA</code> 用于<strong>审批和交付资源</strong>。</li>
</ul>
<h2 id="_4">操作步骤</h2>
<ul>
<li>梳理资源申请流程</li>
<li>创建资源申请服务目录及流程</li>
<li>一次资源申请示例</li>
</ul>
<h3 id="1">1. 梳理资源申请流程</h3>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657805498419.jpg" /></p>
<blockquote>
<p>流程图中是一个实践案例，部分数据需要从周边系统获取，此处功能需要做二次开发，本教程专注流程本身。</p>
</blockquote>
<h3 id="2">2. 创建资源申请服务目录及流程</h3>
<p>先设计资源申请的<strong>流程</strong>，<strong>流程依附在服务目录上对外提供服务</strong>。</p>
<h4 id="21">2.1 角色设置</h4>
<p>使用蓝鲸管理员账号给该业务<strong>分配运维人员的角色</strong>。</p>
<p><img alt="-w1406" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657827837142.jpg" /></p>
<p>使用管理员账号<strong>新增通用角色</strong> SA ，并添加用户 sa_zhang（该账户是前提条件中准备的）。</p>
<p><img alt="-w1489" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15653338148649.jpg" /></p>
<h4 id="22">2.2 设计资源申请流程</h4>
<h5 id="221">2.2.1 填写流程信息</h5>
<p>选择菜单【流程设计】 ，点击【新增】按钮，按提示填写流程信息。</p>
<p><img alt="-w1278" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15653287159233.jpg" /></p>
<p>流程类型选择【请求】，需要【关联业务】，因为资源申请和业务相关，资源管理员需要知道将资源分配给哪个业务。</p>
<p>点击【下一步】，进入【定义与配置流程】环节。</p>
<h5 id="222">2.2.2 定义与配置流程</h5>
<p><img alt="-w1404" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657835995889.jpg" /></p>
<p>点击上图【流程画布】中的【齿轮】，配置【提单】流程节点的字段。</p>
<p>一般是业务的<strong>运维</strong>提服务器资源申请的单据，所以操作角色选择【CMDB 业务公用角色】-&gt; 【运维人员】。</p>
<p><img alt="-w1400" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657837227373.jpg" /></p>
<p>点击【新增字段】，参照 <strong>梳理资源申请流程</strong> ，新增每个环节中需要的字段。</p>
<p><img alt="-w1401" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657838719444.jpg" /></p>
<p>参照 <strong>梳理资源申请流程</strong>，完成整个服务器申请流程的配置。</p>
<p><img alt="-w1397" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657840311702.jpg" /></p>
<h5 id="223">2.2.3 启用流程</h5>
<p>【启用流程】，选择适合的通知策略，点击【提交】完成流程设计。</p>
<p><img alt="-w1400" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657840684184.jpg" /></p>
<h5 id="224">2.2.4 流程模板实例化</h5>
<p>选择菜单【流程设计】，找到刚编辑的申请服务器流程，点击【部署】，生成流程实例。</p>
<p><img alt="-w1398" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657841898867.jpg" /></p>
<h4 id="23">2.3 在服务目录中新增 "申请服务器" 服务，并绑定流程</h4>
<p>选择菜单【服务】，点击【新增】按钮，新增"申请服务器"服务，并 <strong>关联</strong> 刚生成的流程实例。</p>
<p><img alt="-w1399" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657842891310.jpg" /></p>
<p>选择菜单【服务目录】，选中【根目录】，点击右侧【 <strong>⋮</strong> 】，点击【新增】，按提示新增一个名为 <strong>基础设施资源</strong> 的服务目录，然后在 <strong>基础设施资源</strong> 下新建一个 <strong>计算资源</strong> 的服务目录。</p>
<p><img alt="-w1400" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657845850831.jpg" /></p>
<p>选中刚刚创建的服务目录【计算资源】，右侧会显示【添加】按钮，点击该按钮添加 <strong>申请服务器</strong> 服务。</p>
<p><img alt="-w1399" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657846326931.jpg" /></p>
<h3 id="3">3. 一次资源申请示例</h3>
<p>创建完"申请服务器"流程及服务目录后，接下来做一次<strong>服务器申请</strong>演示。</p>
<p><img alt="-w799" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657847596993.jpg" /></p>
<h4 id="31">3.1 运维提单申请服务器</h4>
<p>用<code>运维</code>账号登录 ITSM ，选择【请求管理】菜单，点击【新增请求】，选择【申请服务器】服务，点击【提交】。</p>
<p><img alt="-w1390" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15653317491334.jpg" /></p>
<p>在申请服务器的提单界面，填写服务器申请的关键信息：关联业务、期望交付时间以及服务器的配置和地域。为了安全起见，逻辑层和存储层一般不需要外网 IP。</p>
<p>点击【提交】，创建服务器申请需求。</p>
<p><img alt="-w1648" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657856231015.jpg" /></p>
<blockquote>
<p>注：点击【保存模板】可以记录提单环节的关键信息，下次提单只需修改少部分字段即可。</p>
</blockquote>
<h4 id="32-sa">3.2 SA 审批单据</h4>
<p>SA 收到一封<strong>待处理</strong>的<strong>服务器申请</strong>邮件。</p>
<p><img alt="-w901" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657858051061.jpg" /></p>
<p>使用 SA 账号登录 ITSM ，在待办列表中，找到一个刚刚运维提交的服务器申请单据。</p>
<p><img alt="-w1679" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657859619643.jpg" /></p>
<p>点击链接，同时在周边系统查看该业务的低负载指标，确认达标，点击【通过】，完成本环节流程。</p>
<p><img alt="-w1662" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657862481388.jpg" /></p>
<blockquote>
<p>低负载指标：CPU、内存、网络等指标是否长期处于一个很低的水平，如果是的话，证明计算资源利用率低，SA 一般不予通过资源申请。</p>
</blockquote>
<h4 id="33">3.3 交付服务器</h4>
<p>SA 创建资源，并录入到【交付服务器】环节的服务器配置中。</p>
<p><img alt="-w1662" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657865788372.jpg" /></p>
<p>至此，服务器申请流程结束。</p>
<p>运维登录 ITSM，即可查看申请的服务器资源。</p>
<p><img alt="-w1630" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657866472778.jpg" /></p><h1 id="_1">发布流程线上化</h1>
<h2 id="_2">情景</h2>
<p>应用发布是运维的职能之一，传统的应用发布通过邮件交付，沟通成本太高，而且不符合合规性检查。</p>
<p>接下来，以<strong>一个业务的应用发布为例</strong>，看蓝鲸 ITSM 是如何解决这个痛点的。</p>
<h2 id="_3">前提条件</h2>
<ul>
<li>蓝鲸企业版，自带 ITSM SaaS。</li>
<li>准备发布流程中的 <a href="5.1/PaaS平台/产品功能/系统管理/UserManage.md">各个角色</a> 的账号，包含流程设计的<code>管理员</code>，以及应用发布流程中的<code>产品</code>、<code>运维</code>、<code>测试</code>、<code>QC</code>。</li>
</ul>
<h2 id="_4">操作步骤</h2>
<ul>
<li>梳理应用发布流程</li>
<li>创建应用发布服务目录及流程</li>
<li>一次应用发布示例</li>
</ul>
<h3 id="1">1. 梳理应用发布流程</h3>
<p>从 ITSM 理论出发，梳理一个应用发布流程图，<strong>将测试环境验收通过的版本，部署到生产环境</strong>。包含研发运营环节的<strong>测试</strong>、产品<strong>提交发布需求</strong>、运维<strong>协调发布资源</strong>、<strong>发布</strong>，以及最后质量保证(QA)对应用<strong>发布质量的管理</strong>。</p>
<p><img alt="-w1506" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15659242689054.jpg" /></p>
<blockquote>
<p>流程图中是一个实践案例，部分数据需要从周边系统获取，此处功能需要做二次开发，本教程专注流程本身。</p>
</blockquote>
<h3 id="2">2. 创建"应用发布"流程及服务目录</h3>
<p>先设计应用发布的<strong>流程</strong>，<strong>流程依附在服务目录上对外提供服务</strong>。</p>
<h4 id="21">2.1 角色设置</h4>
<p>使用蓝鲸管理员账号给该业务<strong>分配对应角色的权限</strong>。</p>
<p><img alt="-w1347" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657677924105.jpg" /></p>
<p>使用管理员账号<strong>新增通用角色</strong> QC ，并添加用户 qc_c（该账户是前提条件中准备的）。</p>
<p><img alt="-w1356" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657673907984.jpg" /></p>
<h4 id="22">2.2 设计应用发布流程</h4>
<h5 id="221">2.2.1 填写流程信息</h5>
<p>选择菜单【流程设计】 ，点击【新增】按钮，按提示填写流程信息。</p>
<p><img alt="-w1357" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657675913906.jpg" /></p>
<p>流程类型选择【变更】，需要【关联业务】，因为应用发布和业务相关，同时关联业务对应的角色：产品、运维、测试。</p>
<p>点击【下一步】，进入【定义与配置流程】环节。</p>
<h5 id="222">2.2.2 定义与配置流程</h5>
<p><img alt="-w1612" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657687519024.jpg" /></p>
<p>点击上图【流程画布】中的【齿轮】，配置【提单】流程节点的字段。</p>
<p>一般是业务的<strong>产品</strong>提应用的发布单据，所以操作角色选择【CMDB 业务公用角色】-&gt; 【产品人员】。</p>
<p><img alt="-w1614" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657685179459.jpg" /></p>
<p>点击【新增字段】，参照 <strong>梳理应用发布流程</strong>，新增每个环节中需要的字段。</p>
<p><img alt="-w1616" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657684206630.jpg" /></p>
<p>参照 <strong>梳理应用发布流程</strong>，完成整个应用发布流程的配置。</p>
<p><img alt="-w1603" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657693304263.jpg" /></p>
<h5 id="223">2.2.3 启用流程</h5>
<p>【启用流程】，选择适合的通知策略，点击【提交】完成流程设计。</p>
<p><img alt="-w1610" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657700705257.jpg" /></p>
<h5 id="224">2.2.4 流程模板实例化</h5>
<p>选择菜单【流程设计】，找到刚编辑的应用发布流程，点击【部署】，生成流程实例。</p>
<p><img alt="-w1608" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657714512813.jpg" /></p>
<h4 id="23">2.3 在服务目录中新增"应用发布"服务，并绑定流程</h4>
<p>选择菜单【服务】，点击【新增】按钮，新增"应用发布"服务，并<strong>关联</strong>刚生成的流程实例。</p>
<p><img alt="-w1610" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657715921795.jpg" /></p>
<p>选择菜单【服务目录】，选中【根目录】，点击右侧【 <strong>⋮</strong> 】，点击【新增】，按提示新增一个名为<strong>应用发布</strong>的服务目录。</p>
<p><img alt="-w1602" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657716914488.jpg" /></p>
<p>选中刚刚创建的服务目录【应用发布】，右侧会显示【添加】按钮，点击该按钮添加<strong>应用发布</strong>服务。</p>
<p><img alt="-w1613" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657718206864.jpg" /></p>
<h3 id="3">3. 一次应用发布示例</h3>
<p>创建完"应用发布"流程及服务目录后，接下来做<strong>一次应用发布演示</strong>。</p>
<p><img alt="-w723" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657727131323.jpg" /></p>
<h4 id="31">3.1 产品提交发布需求</h4>
<p>用<code>产品</code>账号登录 ITSM ，选择【变更管理】菜单，点击【新增变更】，选择【应用发布】服务，点击【提交】。</p>
<p><img alt="-w1661" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657728020743.jpg" /></p>
<p>在变更申请界面，填写<strong>本次版本发布的关键信息</strong>，包括版本包路径、MD5 ，用于自动化应用发布系统直接从仓库中获取版本，以及版本发布范围和时间。</p>
<p>点击【提交】，创建发布需求。</p>
<p><img alt="-w1628" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657735354575.jpg" /></p>
<h4 id="32">3.2 测试确认版本质量</h4>
<p>测试人员收到一封<strong>待处理</strong>的<strong>测试确认</strong>邮件。</p>
<p><img alt="-w913" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657747653730.jpg" /></p>
<p>使用测试账号登录 ITSM ，在待办列表中，找到刚刚产品提的发布单。</p>
<p><img alt="-w1677" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657591451663.jpg" /></p>
<p>点击链接，选择评估结果和测试结果，并填写测试概况，点击【通过】，完成本环节流程。</p>
<p><img alt="-w1678" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657591950680.jpg" />
<img alt="-w1665" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657593296906.jpg" /></p>
<h4 id="33">3.3 运维协调资源</h4>
<p>使用运维的账号登录 ITSM，在待办列表找到单据。</p>
<p><img alt="-w1663" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657594541620.jpg" /></p>
<p>点击【通过】，开始协调发布资源，做好发布准备。</p>
<p><img alt="-w1661" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657594759068.jpg" /></p>
<h4 id="34">3.4 运维实施发布</h4>
<p>完成了发布准备，到了计划发布时间，在自动化应用发布系统（如标准运维）上完成应用发布后，在该发布单的运维发布环节填写<strong>本次运维发布的概况</strong>。</p>
<p><img alt="-w1657" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657596113646.jpg" /></p>
<h4 id="35-qc">3.5 QC 发布评估</h4>
<p>QC（质量保障）人员在工作台的待办列表中，找到本次发布的单据。</p>
<p><img alt="-w1677" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657596783221.jpg" /></p>
<p>QC 根据业务指标监控系统的数据以及事件管理中是否存在关联的事件，对此次发布做出发布评估。</p>
<p><img alt="-w1672" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657597517613.jpg" /></p>
<p>至此，一次应用发布的流程结束。</p>
<p><img alt="-w1671" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15657664966934.jpg" /></p><h1 id="_1">环境变更流程线上化</h1>
<h2 id="_2">情景</h2>
<p>变更是运维的职能之一，包含应用的配置、基础设施的环境等变更。</p>
<p>应用所依赖的服务器已经服役 5 年，不在维保期限，故障率抖升，为了保障应用的稳定性，运维团队计划在业务低峰期，完成服务器的以旧换新。</p>
<p>ITSM 中的变更管理（Change Managent）规范了变更环节的操作，确保<strong>高效有序的完成环境变更</strong>，对应用的可用性负责，并对生产环境的变更满足<strong>合规性检查</strong>。</p>
<p>变更管理是蓝鲸 ITSM 的一个模块，接下来介绍在蓝鲸 ITSM 如何<strong>完成这次服务器的替换升级</strong>。</p>
<h2 id="_3">前提条件</h2>
<ul>
<li>蓝鲸企业版，自带 ITSM SaaS。</li>
<li>准备环境变更流程中 <a href="5.1/PaaS平台/产品功能/系统管理/UserManage.md">多个角色</a> 的账号，包含<code>运维</code>、<code>QC</code>、<code>产品</code>，以及流程设计的<code>管理员</code>。</li>
</ul>
<h2 id="_4">操作步骤</h2>
<ul>
<li>梳理环境变更流程</li>
<li>创建环境变更服务目录及流程</li>
<li>一次环境变更示例</li>
</ul>
<h3 id="1">1. 梳理环境变更流程</h3>
<p>从 ITSM 理论出发，梳理<strong>环境变更流程图</strong>，包含运维<strong>变更申请</strong>、<strong>受理变更</strong>、<strong>变更操作和总结</strong>，以及最后质量保证（QC）对变更的<strong>评估管理</strong>。</p>
<p><img alt="-w1274" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15659272273490.jpg" /></p>
<blockquote>
<p>流程图中是一个实践案例，部分数据需要从周边系统获取，此处功能需要做二次开发，本教程专注流程本身。</p>
</blockquote>
<h3 id="2">2. 创建环境变更服务目录及流程</h3>
<p>先设计环境变更的<strong>流程</strong>，<strong>流程依附在服务目录上对外提供服务</strong>。</p>
<h4 id="21">2.1 角色设置</h4>
<p>参照 <a href="5.1/bk_solutions/CO/ITSM/Release_Management.md">角色设置</a> 完成对<code>运维</code>、<code>产品</code>和<code>QC</code>的授权。</p>
<h4 id="22">2.2 设计环境变更流程</h4>
<h5 id="221">2.2.1 填写流程信息</h5>
<p>选择菜单【流程设计】 ，点击【新增】按钮，按提示填写流程信息。</p>
<p><img alt="-w1338" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658666453759.jpg" /></p>
<p>流程类型选择【变更】，需要【关联业务】，因为<strong>环境变更和业务相关</strong>，同时关联业务对应的角色：产品、运维。</p>
<p>点击【下一步】，进入【定义与配置流程】环节。</p>
<h5 id="222">2.2.2 定义与配置流程</h5>
<p><img alt="-w1337" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658667483286.jpg" /></p>
<p>点击上图【流程画布】中的【齿轮】，配置【提单】流程节点的字段。</p>
<p>一般是<strong>运维</strong>提环境变更单据，所以操作角色选择【CMDB 业务公用角色】-&gt; 【运维人员】(角色授权详见给角色分配权限 ）。</p>
<p><img alt="-w1335" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658668218721.jpg" /></p>
<p>点击【新增字段】，参照 <strong>梳理环境变更流程</strong>，新增每个环节中需要的字段。</p>
<p><img alt="-w1285" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658670592201.jpg" /></p>
<p>参照 <strong>梳理环境变更流程</strong>，，完成整个环境变更流程的配置。</p>
<p><img alt="-w1517" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658682086636.jpg" /></p>
<h5 id="223">2.2.3 启用流程</h5>
<p>【启用流程】，选择适合的通知策略，点击【提交】完成流程设计。</p>
<p><img alt="-w1522" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658682459451.jpg" /></p>
<h5 id="224">2.2.4 流程模板实例化</h5>
<p>选择菜单【流程设计】，找到刚编辑的环境变更流程，点击【部署】，生成流程实例。</p>
<p><img alt="-w1522" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658682863006.jpg" /></p>
<h4 id="23">2.3 在服务目录中新增"环境变更"服务，并绑定流程</h4>
<p>选择菜单【服务】，点击【新增】按钮，新增"环境变更"服务，并<strong>关联</strong>刚生成的流程实例。</p>
<p><img alt="-w1522" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658687042752.jpg" /></p>
<p>选择菜单【服务目录】，选中【根目录】，点击右侧【 <strong>⋮</strong> 】，点击【新增】，按提示新增一个名为<strong>环境变更</strong>的服务目录。</p>
<p><img alt="-w1523" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658688170167.jpg" /></p>
<p>选中刚刚创建的服务目录【环境变更】，右侧会显示【添加】按钮，点击该按钮添加<strong>环境变更</strong>服务。</p>
<p><img alt="-w1522" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658688910183.jpg" /></p>
<p>至此，<strong>流程设计和服务目录已新建好</strong>，接下来做一次环境变更演示。</p>
<h1 id="3">3. 一次环境变更示例</h1>
<p><img alt="-w776" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658720001516.jpg" /></p>
<h4 id="31">3.1 运维：变更申请</h4>
<p>用<code>运维</code>账号登录 ITSM ，选择【变更管理】菜单，点击【新增变更】，选择【环境变更】服务，点击【提交】。</p>
<p><img alt="-w1574" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658690314017.jpg" /></p>
<p>在【新增变更】界面，填写<strong>本次环境变更的关键信息</strong>，包括变更原因、范围以及时间等。</p>
<p>点击【提交】，完成变更申请。</p>
<p><img alt="-w1510" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658696903972.jpg" /></p>
<h4 id="32">3.2 运维组长：变更审核</h4>
<p>运维组长收到一封<strong>待处理</strong>的<strong>变更审核</strong>邮件。</p>
<p><img alt="-w997" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658700619796.jpg" /></p>
<p>使用<strong>运维</strong>账号登录 ITSM ，在待办列表中，找到待处理的环境变更单。</p>
<p><img alt="-w1510" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658697525323.jpg" /></p>
<p>点击链接，审核本次变更，点击【通过】，完成本环节流程。</p>
<p><img alt="-w1502" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658697806146.jpg" /></p>
<h4 id="33">3.3 运维：变更操作及总结</h4>
<p>环境变更完毕后，填写变更总结。</p>
<p><img alt="-w1502" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658698294902.jpg" /></p>
<h4 id="34-qc">3.4 QC：变更评估</h4>
<p>QC（质量保障）人员在工作台的待办列表中，找到本次环境变更的单据。</p>
<p><img alt="-w1512" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658698912944.jpg" /></p>
<p>QC 依据该业务的业务关键指标数据、投诉情况，做出<strong>变更评估</strong>。</p>
<p><img alt="-w1522" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658699278776.jpg" /></p>
<p>至此，一次<strong>环境变更的流程结束</strong>。</p>
<p><img alt="-w1666" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658699768290.jpg" /></p><h1 id="_1">故障提报流程线上化</h1>
<h2 id="_2">情景</h2>
<p>ITSM 中的故障管理(Incident Management)帮企业构建了一套<strong>应对故障的处理机制</strong>，确保故障来临之时可以<strong>高效有序的响应、处理以及回溯故障的表面和本质</strong>，并将根源问题通过转单到<strong>问题管理模块</strong>，实现<strong>故障的闭环</strong>。</p>
<p>故障管理是蓝鲸 ITSM 内置的模块之一，接下来介绍在蓝鲸 ITSM 是如何应对<strong>部分地区用户集中无法访问网站的投诉</strong>。</p>
<h2 id="_3">前提条件</h2>
<ul>
<li>蓝鲸企业版，自带 ITSM SaaS。</li>
<li>准备故障提报流程中 <a href="5.1/PaaS平台/产品功能/系统管理/UserManage.md">多个角色</a> 的账号，包含<code>运维</code>、<code>QC</code>、<code>产品</code>，以及流程设计的<code>管理员</code>。</li>
</ul>
<h2 id="_4">操作步骤</h2>
<ul>
<li>梳理故障提报流程</li>
<li>创建故障提报服务目录及流程</li>
<li>一次故障提报示例</li>
</ul>
<h3 id="1">1. 梳理故障提报流程</h3>
<p>从 ITSM 理论出发，梳理故障提报的流程图，包含客服 <strong>提单</strong>、运维 <strong>故障跟进</strong>、运维 <strong>回溯总结故障</strong>，以及最后质量保证(QC)对故障的 <strong>评估管理</strong>。</p>
<p><img alt="-w1458" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658530577275.jpg" /></p>
<blockquote>
<p>流程图中是一个实践案例，部分数据需要从周边系统获取，此处功能需要做二次开发，本教程专注流程本身。</p>
</blockquote>
<h3 id="2">2. 创建故障提报服务目录及流程</h3>
<p>先设计故障提报的<strong>流程</strong>，<strong>流程依附在服务目录上对外提供服务</strong>。</p>
<h4 id="21">2.1 角色设置</h4>
<p>参照  <a href="5.1/bk_solutions/CO/ITSM/Release_Management.md">角色设置</a> 完成对<code>运维</code>、<code>产品</code>和<code>QC</code>的授权。</p>
<h4 id="22">2.2 设计故障受理流程</h4>
<h5 id="221">2.2.1 填写流程信息</h5>
<p>选择菜单【流程设计】 ，点击【新增】按钮，按提示填写流程信息。</p>
<p><img alt="-w1362" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658545362420.jpg" /></p>
<p>流程类型选择【事件】，需要【关联业务】，因为故障提报和业务相关，同时关联业务对应的角色：产品、运维。</p>
<p>点击【下一步】，进入【定义与配置流程】环节。</p>
<h5 id="222">2.2.2 定义与配置流程</h5>
<p><img alt="-w1352" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658547862596.jpg" /></p>
<p>点击上图【流程画布】中的【齿轮】，配置【提单】流程节点的字段。</p>
<p>一般是<strong>客服</strong>提故障单据，所以操作角色选择【通用角色表】-&gt; 【客服】(客服角色授权详见给 <strong>角色分配权限</strong>）。</p>
<p><img alt="-w1336" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658551277354.jpg" /></p>
<p>点击【新增字段】，参照 <strong>梳理故障提报流程</strong>，新增每个环节中需要的字段。</p>
<p><img alt="-w1408" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658592435245.jpg" /></p>
<p>参照 <strong>梳理故障提报流程</strong>，完成整个故障受理流程的配置。</p>
<p><img alt="-w1397" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658592876789.jpg" /></p>
<h5 id="223">2.2.3 启用流程</h5>
<p>【启用流程】，选择适合的通知策略，点击【提交】完成流程设计。</p>
<p><img alt="-w1404" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658593359980.jpg" /></p>
<h5 id="224">2.2.4 流程模板实例化</h5>
<p>选择菜单【流程设计】，找到刚编辑的故障受理流程，点击【部署】，生成流程实例。</p>
<p><img alt="-w1403" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658593653122.jpg" /></p>
<h4 id="23">2.3 在服务目录中新增"故障受理"服务，并绑定流程</h4>
<p>选择菜单【服务】，点击【新增】按钮，新增"故障受理"服务，并<strong>关联</strong>刚生成的流程实例。</p>
<p><img alt="-w1403" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658595078266.jpg" /></p>
<p>选择菜单【服务目录】，选中【根目录】，点击右侧【 <strong>⋮</strong> 】，点击【新增】，按提示新增一个名为<strong>故障受理</strong>的服务目录。</p>
<p><img alt="-w1402" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658595666163.jpg" /></p>
<p>选中刚刚创建的服务目录【故障受理】，右侧会显示【添加】按钮，点击该按钮添加<strong>故障受理</strong>服务。</p>
<p><img alt="-w1404" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658596158089.jpg" /></p>
<p>至此，流程设计和服务目录已新建好，接下来做一次故障提报演示。</p>
<h3 id="3">3. 一次故障提报示例</h3>
<p><img alt="-w768" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658720727110.jpg" /></p>
<h4 id="31">3.1 客服提报故障单</h4>
<p>用<code>客服</code>账号登录 ITSM ，选择【事件管理】菜单，点击【新增事件】，选择【故障受理】服务，点击【提交】。</p>
<p><img alt="-w1332" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658597438200.jpg" /></p>
<p>在【新增事件】界面，填写<strong>本次故障提报的关键信息</strong>，包括故障标题、截图以及故障处理团队等。</p>
<p>点击【提交】，提报故障。</p>
<p><img alt="-w1331" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658604949447.jpg" /></p>
<h4 id="32">3.2 运维跟进故障处理</h4>
<p>运维收到一封<strong>待处理</strong>的<strong>故障受理</strong>邮件。</p>
<p><img alt="-w619" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658606919760.jpg" /></p>
<p>使用<strong>运维</strong>账号登录 ITSM ，在待办列表中，找到待处理的故障单。</p>
<p><img alt="-w1499" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658608778520.jpg" /></p>
<p>点击链接，填写故障处理记录，点击【通过】，完成本环节流程。</p>
<p><img alt="-w1491" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658613447194.jpg" /></p>
<h4 id="33">3.3 故障总结</h4>
<p>处理完故障后，运维<strong>复盘本次故障</strong>，做故障总结。</p>
<p><img alt="-w1662" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658620538481.jpg" /></p>
<h4 id="34-qc">3.4 QC 做故障评估</h4>
<p>QC（质量保障）人员在工作台的待办列表中，找到本次故障的单据。</p>
<p><img alt="-w1497" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658621496239.jpg" /></p>
<p>QC 依据本次故障的影响范围、原因以及处理情况，做出故障评估。</p>
<p><img alt="-w1492" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658622710282.jpg" /></p>
<p>至此，一次<strong>故障提报和处理的流程结束</strong>。</p>
<p><img alt="-w1498" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/CO/ITSM/media/15658623014535.jpg" /></p><h1 id="_1">常见问题</h1>
<h2 id="1">1. 蓝鲸支持私有化部署吗</h2>
<p>蓝鲸支持私有化部署。</p>
<p>私有化部署，满足企业对敏感数据的合规性要求以及自主掌控的能力。</p>
<h2 id="2">2. 蓝鲸的代码开放吗</h2>
<p>目前蓝鲸开源了 <a href="https://github.com/Tencent/bk-paas">PaaS</a> 、<a href="https://github.com/Tencent/bk-cmdb">CMDB</a> 、<a href="https://github.com/Tencent/bk-sops">标准运维</a> 、 <a href="https://github.com/Tencent/bk-bcs/">BCS</a>、<a href="https://github.com/Tencent/bk-ci">蓝鲸 CI</a>，更多开源计划请关注蓝鲸公众号。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bk_solutions/Getting_started/media/15659324878049.jpg" /></p>
<h2 id="3-paas-paas">3. 蓝鲸的 PaaS 是真 PaaS 吗</h2>
<p>蓝鲸的 <a href="5.1/PaaS平台/产品简介/README.md">PaaS 平台</a> 是一个开放的平台，让用户可以简单、快速地创建、部署和管理应用，它提供了完善的前后台开发框架、服务总线（ ESB ）、调度引擎、公共组件等模块，帮助用户快速、低成本、免运维地构建支撑工具和运营系统。</p>
<p>PaaS 平台为一个应用从创建到部署，再到后续的维护管理提供了完善的自助化和自动化服务，如日志查询、监控告警等，从而使用户可以将全部精力投入到应用的开发之中。</p>
<p>PaaS 平台的主要功能有：支持多语言的开发框架/样例、免运维托管、SaaS 运营数据可视化、企业服务总线（API Gateway）、可拖拽的前端服务（MagicBox）等。</p>
    </body>
    </html>
    