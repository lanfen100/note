
    <html lang="zh-cn">
    <head>
    <meta content="text/html; charset=utf-8" http-equiv="content-type" />
    <link href="F:\bkdoc\md_to_pdf/default.css" rel="stylesheet">
    </head>
    <body>
    <h1 id="_1">简介</h1>
<p>蓝鲸社区版，是蓝鲸智云提供的面向社区用户的基于 PaaS 的运维技术解决方案套件。 它永久免费，支持公有云环境、私有环境的独立搭建部署。</p>
<p>本文档主要介绍蓝鲸社区版的初次安装部署、日常维护、更新升级、故障排查等运维相关的内容。</p>
<p>关于蓝鲸各大平台、SaaS 应用的相关使用说明，请参考蓝鲸社区版产品白皮书。</p>
<h2 id="_2">安装方案</h2>
<p>蓝鲸社区版基础包安装介质分为软件包 (src)、部署脚本包 (install)。</p>
<p>安装原理：通过 <code>rsync + ssh</code> ，将软件包里的各模块按需分发到指定机器，通过部署脚本安装软件依赖、自动生成配置文件、初始化数据库、配置账户和权限等，最后启动进程。</p>
<ul>
<li>
<p><a href="./基础包安装/软件包简介/src_overview.md">软件包简介</a></p>
</li>
<li>
<p><a href="./部署脚本/intro.md">部署脚本简介</a></p>
</li>
</ul>
<h2 id="_3">安装环境准备</h2>
<p>在开始安装前，请参照 <a href="./基础包安装/环境准备/get_ready.md">环境准备文档</a>，准备安装介质，配置系统环境。</p>
<h2 id="_4">安装方式</h2>
<p>社区版目前支持两种安装方式选择：</p>
<ul>
<li>
<p><strong>单机部署</strong>：对于首次接触蓝鲸的用户，寻找一个最快体验和评估蓝鲸的核心功能的方式，请参照 <a href="./基础包安装/单机部署/install_on_single_host.md">单机部署文档</a>，可以快速体验到蓝鲸基础平台的功能。</p>
</li>
<li>
<p><strong>标准部署</strong>：若需完整的社区版基础包功能，请参照 <a href="./基础包安装/多机部署/quick_install.md">标准部署文档</a> 进行安装。</p>
</li>
</ul>
<h2 id="_5">推荐安装流程</h2>
<p>推荐安装完基础平台后在安装容器管理平台</p>
<h2 id="_6">升级已安装的环境</h2>
<p>升级更新社区版，请参考 <a href="./升级指引/update2V4.1/cev31_v41.md">升级指引</a>。</p><h1 id="_1">术语解释</h1>
<p><strong>PaaS：</strong> 平台即服务，本文特指蓝鲸的 PaaS 平台。</p>
<p><strong>JOB：</strong> 蓝鲸作业平台。</p>
<p><strong>CMDB：</strong> 蓝鲸配置平台。</p>
<p><strong>BKDATA：</strong> 蓝鲸数据平台基础服务。</p>
<p><strong>SaaS：</strong> 软件即服务，本文特指 S-mart 市场下载的应用。</p>
<p><strong>S-mart 市场：</strong> 蓝鲸的应用生态市场。</p>
<p><strong>FTA：</strong> 故障自愈后台。</p>
<p><strong>GSE (General Service Engine)：</strong> 管控平台。</p>
<p><strong>中控机：</strong> 执行命令安装的所属机器。（查看中控机方式：cat /data/install/.controller_ip）</p><h1 id="_1">脚本架构图</h1>
<h2 id="bkcec">bkcec 脚本原理</h2>
<p><img alt="bkcec脚本原理" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/bkcec_flow.png" /></p><h1 id="_1">软件下载</h1>
<p>安装软件需要 <a href="https://bk.tencent.com/download/">下载</a> 2 个文件：软件包、证书。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/downloadall.png" /></p>
<ul>
<li>软件包（完整包和分包）
为了方便用户获取社区版软件包，提供了 2 种下载模式：完整包下载、分包下载。所以，社区版的“完整包”=“部署脚本”+“产品软件”+“开源组件”。用户可以根据自己的需要进行下载。</li>
</ul>
<blockquote>
<p>部署脚本: 用于自动化安装和维护蓝鲸软件产品，属于蓝鲸软件的通用“安装和维护工具”，可以用于安装维护不同版本的产品软件，和不同版本的开源组件。
产品软件: 是蓝鲸所有自研产品/服务的集合，包括平台级产品和 SaaS 级产品。用户可以根据需要选择更新整个产品，或者更新部分模块。
开源组件: 提供了蓝鲸软件在使用过程中依赖的所有开源组件和配置模板，可根据需要选择下载，若涉及到开源组件的版权信息，请遵守开源协议要求。</p>
</blockquote>
<p>说明：首次安装用户，建议下载完整包。</p>
<ul>
<li>证书
软件安装过程中，需要提供证书文件，才能确保软件的正常启动，最多输入 3 个 MAC 地址。</li>
</ul><h1 id="_1">部署脚本</h1>
<h2 id="bkcec">bkcec 说明</h2>
<p>bkcec 是蓝鲸社区版的安装维护主脚本。</p>
<p>bk_install 是封装了 bkcec 的集成安装脚本。</p>
<p>bkcec 的调用语法为：<code>bkcec &lt;command&gt; &lt;module&gt; [project] [1]</code></p>
<p>其中可用的 command 有：</p>
<ul>
<li><strong>sync：</strong> 从中控机的 src/ 同步安装 <code>&lt;module&gt;</code> 依赖的文件和目录到对应机器的 src/ 下。</li>
<li><strong>install：</strong> 安装 <code>&lt;module&gt;</code> 到 $INSTALL_PATH（默认 /data/bkce）下。</li>
<li><strong>install <module> 1：</strong> 等同于先执行 <code>sync &lt;module&gt;</code>，再执行<code>install &lt;module&gt;</code>，合二为一。</li>
<li><strong>initdata：</strong> 安装后初始化，常用于模块的用户创建，sql 导入，权限设置等操作。</li>
<li><strong>render：</strong> 渲染模块的模板文件，install 过程中会调用它，做模板变量替换。</li>
<li><strong>status：</strong> 检查模块的进程是否运行。</li>
<li><strong>start：</strong> 启动模块的进程。</li>
<li><strong>stop：</strong> 停止模块的进程。</li>
<li><strong>upgrade：</strong> 升级更新模块。</li>
</ul>
<p>其中模块名，对应 install.config 里的名称，当前社区版包含以下模块，按模块特点分为两类：</p>
<ul>
<li>
<p>开源外部组件。</p>
</li>
<li>
<p>蓝鲸自研产品。</p>
</li>
</ul>
<h3 id="_2">开源外部组件</h3>
<h4 id="_3">基础部分：</h4>
<ul>
<li>
<p><strong>nginx：</strong> web 服务器和反向代理。</p>
</li>
<li>
<p><strong>rabbitmq：</strong> 消息队列服务。</p>
</li>
<li>
<p><strong>kafka：</strong> 分布式数据流处理服务。</p>
</li>
<li>
<p><strong>zk：</strong> zookeeper 分布式配置服务。</p>
</li>
<li>
<p><strong>es：</strong> elasticsearch 分布式搜索和数据分析引擎。</p>
</li>
<li>
<p><strong>consul：</strong> 分布式服务发现和域名服务。</p>
</li>
<li>
<p><strong>mongodb：</strong> 面向文档的数据库管理系统。</p>
</li>
<li>
<p><strong>mysql：</strong> 关系数据库管理系统。</p>
</li>
<li>
<p><strong>beanstalk：</strong> 消息队列服务。</p>
</li>
<li>
<p><strong>redis：</strong> 键值对存储数据库。</p>
</li>
</ul>
<h4 id="bcs">BCS 部分：</h4>
<ul>
<li>
<p><strong>web_console：</strong> 是容器服务提供快捷查看集群状态的命令行服务。</p>
</li>
<li>
<p><strong>cc：</strong> 容器管理平台配置中心。</p>
</li>
<li>
<p><strong>monitor：</strong> 容器监控后台-用于产生告警。</p>
</li>
<li>
<p><strong>thanos(rule)：</strong> 全局监控告警策略。</p>
</li>
<li>
<p><strong>devops(navigator)：</strong> 提供产品导航统一框架。</p>
</li>
<li>
<p><strong>grafana：</strong> 容器监控后台-用于可视化展示。</p>
</li>
<li>
<p><strong>devops(pm)：</strong> 项目管理后台模块。</p>
</li>
<li>
<p><strong>harbor(api)：</strong> 是蓝盾 bcs 容器服务查询 docker 镜像信息的中间件，目前只支持harbor镜像查询 ，后面有计划支持其他 docker 仓库( jfrog /腾讯云等）。</p>
</li>
<li>
<p><strong>harbor(server)：</strong> Harbor 是 Vmware 公司开源的企业级 Docker Registry 管理项目。</p>
</li>
<li>
<p><strong>bcs(api)：</strong> apiserver 是 bcs 容器管理平台的总接入口，是 bcs 对外暴露的唯一入口。主要功能包括：路由，服务发现，负载均衡，熔断，限流，鉴权等功能。</p>
</li>
<li>
<p><strong>bcs(storage)：</strong> bcs-storage 作为 bcs 的动态数据管理，负责存储来自 mesos 和 k8s 集群上报的资源动态数据，并提供相应的查询 API 接口。</p>
</li>
<li>
<p><strong>bcs(health-master)：</strong> health-master 负责整个监控服务的源数据拉取，为 health-slave 提供任务分发功能。同时负责数据的分析、聚合、 处理等。</p>
</li>
<li>
<p><strong>bcs(dns-service)：</strong> 为 bcs service 下的 mesos 集群提供 DNS 服务。</p>
</li>
<li>
<p><strong>bcs(health-slave)：</strong> health-slave 负责：任务获取-&gt; 执行 -&gt; 上报执行结果。</p>
</li>
<li>
<p><strong>bcs(ops)：</strong> 容器服务调用标准运维作业。</p>
</li>
</ul>
<h3 id="_4">蓝鲸自研产品</h3>
<ul>
<li>
<p><strong>paas：</strong> 蓝鲸 PaaS 平台。</p>
</li>
<li>
<p><strong>cmdb：</strong> 蓝鲸配置平台。</p>
</li>
<li>
<p><strong>job：</strong> 蓝鲸作业平台。</p>
</li>
<li>
<p><strong>gse：</strong> 管控平台后台。</p>
</li>
<li>
<p><strong>license：</strong> 证书服务。</p>
</li>
<li>
<p><strong>appo：</strong>  SaaS 部署的正式环境。</p>
</li>
<li>
<p><strong>appt：</strong> SaaS 部署的测试环境。</p>
</li>
<li>
<p><strong>bkdata：</strong> 数据平台基础服务。</p>
</li>
<li>
<p><strong>dataapi：</strong> 数据平台 API 接口服务。</p>
</li>
<li>
<p><strong>databus：</strong> 数据平台总线服务。</p>
</li>
<li>
<p><strong>monitor：</strong> 监控后台。</p>
</li>
<li>
<p><strong>fta：</strong> 故障自愈后台。</p>
</li>
</ul>
<p><strong>启动蓝鲸监控后台服务示例： <code>./bkece start bkdata monitor</code></strong>。</p>
<h3 id="_5">文件用途</h3>
<h4 id="_6">脚本包的文件说明</h4>
<ul>
<li>
<p><strong>RELEASE.md：</strong> 版本日志。</p>
</li>
<li>
<p><strong>VERSION：</strong> 版本号。</p>
</li>
<li>
<p><strong>agent_setup/：</strong> 存放安装 Agent 相关的脚本以及脚本模版。</p>
</li>
<li>
<p><strong>appmgr/：</strong> 存放构建 SaaS 和运行 SaaS 所需的脚本，社区版采用 virtualenv 方式。</p>
</li>
<li>
<p><strong>bk_install：</strong> 封装 bkcec 用来做集成安装部署。</p>
</li>
<li>
<p><strong>bkcec：</strong> 安装和维护的主脚本。</p>
</li>
<li>
<p><strong>bkco.env bkco.fc bkco_install：</strong> 网络管理模块所用的安装部署相关环境变量和函数定义。</p>
</li>
<li>
<p><strong>clean.fc：</strong> 卸载清理相关函数。</p>
</li>
<li>
<p><strong>configure_ssh_without_pass：</strong> 一键配置免密 ssh 登陆用的脚本。</p>
</li>
<li>
<p><strong>control.rc：</strong> 定义进程启停的函数库。</p>
</li>
<li>
<p><strong>crontab.rc：</strong> crontab 新增和删除相关的函数定义。</p>
</li>
<li>
<p><strong>deck/saas.py：</strong> 命令行部署 SaaS 应用的工具。</p>
</li>
<li>
<p><strong>deliver.rc：</strong> 定义从中控机同步文件目录到对应模块机器的函数。</p>
</li>
<li>
<p><strong>dependences.env：</strong> 各模块依赖的命令和 rpm 包定义。</p>
</li>
<li>
<p><strong>errors.env：</strong> 错误码定义。</p>
</li>
<li>
<p><strong>functions：</strong> 通用的 bash 函数。</p>
</li>
<li>
<p><strong>globals.env：</strong> 定义蓝鲸组件用到的全局变量配置。</p>
</li>
<li>
<p><strong>health_check/check_proc_exists：</strong> Consul 使用的健康检查脚本。</p>
</li>
<li>
<p><strong>install.config：</strong> 定义模块在主机的分布部署方式。</p>
</li>
<li>
<p><strong>install_minibk：</strong> 最小化单机部署的封装脚本。</p>
</li>
<li>
<p><strong>migrate/：</strong> 蓝鲸套件迁移升级的脚本，目前没有用。</p>
</li>
<li>
<p><strong>parse_config：</strong> 解析 install.config 并生成 Consul 主配置和服务定义的配置， <code>config.env</code> 等文件。</p>
</li>
<li>
<p><strong>pip/：</strong> 存放安装脚本所需的 pip 依赖包。</p>
</li>
<li>
<p><strong>ports.env：</strong> 定义所有组件需要设定的端口信息。</p>
</li>
<li>
<p><strong>process_watch + watch.rc：</strong> 进程监控脚本。</p>
</li>
<li>
<p><strong>register.rc：</strong> 自动注册主机到 CMDB 的函数。</p>
</li>
<li>
<p><strong>scripts/：</strong> gse_agent 和 gse_proxy 安装所需要启停脚本，在安装 GSE 时会自动打包进去。</p>
</li>
<li>
<p><strong>status.rc：</strong> 检查进程状态相关的函数。</p>
</li>
<li>
<p><strong>summary.rc：</strong> 打印相关模块和所有模块的版本信息。</p>
</li>
<li>
<p><strong>templates/：</strong> 安装脚本初始依赖的配置模版，目前只是 Consul 的 Supervisor 配置。</p>
</li>
<li>
<p><strong>templates_render.rc：</strong> 渲染配置模版，根据读取配置文件和动态生成的变量去替换模版里的占位符。</p>
</li>
<li>
<p><strong>update.rc：</strong> 一些更新配置或者证书的操作定义。</p>
</li>
<li>
<p><strong>upgrade.rc：</strong> 各模块的升级操作封装。</p>
</li>
<li>
<p><strong>utils.fc：</strong> 安装、初始化主要函数都在这里先找。</p>
</li>
<li>
<p><strong>bcs/：</strong> 存放 bcs 构建所需的脚本。</p>
</li>
<li>
<p><strong>install.config.3ip.sample</strong> 部署基础不含bcs时使用。</p>
</li>
<li>
<p><strong>install.config.bcs.sample</strong> 完整的基础平台+bcs方案分布。</p>
</li>
<li>
<p><strong>install.config.bcs.single.sample</strong> 单机部署bcs模块分布示例。</p>
</li>
<li>
<p><strong>install.config.new.sample</strong>：部署 bcs 时使用。</p>
</li>
</ul>
<h3 id="_7">完成安装或日常升级后生成的文件</h3>
<ul>
<li>
<p><strong>.agreed：</strong> 同意安装协议后的标记文件。</p>
</li>
<li>
<p><strong>.app.token：</strong> 后台程序和 SaaS，访问 ESB 接口时需要使用的 app_code 和 app_token 的键值对。</p>
</li>
<li>
<p><strong>.bk_install.step：</strong> 集成安装的步骤进度标记文件。</p>
</li>
<li>
<p><strong>.controller_ip：</strong> 中控机的 IP 地址。</p>
</li>
<li>
<p><strong>.migrate/：</strong> 成功导入的 sql 文件的标记文件。使用了 chattr +i，具有不可删除属性。</p>
</li>
<li>
<p><strong>.path：</strong> 蓝鲸的安装路径。</p>
</li>
<li>
<p><strong>.rcmdrc：</strong> 使用 rcmd()函数远程执行命令时，会加载的 rc 文件。</p>
</li>
<li>
<p><strong>/tmp/bkc.log：</strong> bkcec 等脚本输出的日志。</p>
</li>
</ul><h1 id="_1">机器评估</h1>
<p>对于蓝鲸部署所需的硬件配置选型，并无定规。蓝鲸由众多开源组件和自研组件构成。
开源组件的硬件选型可以参考相应的官方文档。</p>
<p>蓝鲸产品本身的建议配置如下：</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>配置</th>
</tr>
</thead>
<tbody>
<tr>
<td>PaaS</td>
<td>2 核 4G</td>
</tr>
<tr>
<td>CMDB</td>
<td>2 核 2G</td>
</tr>
<tr>
<td>JOB</td>
<td>2 核 4G</td>
</tr>
<tr>
<td>BKDATA</td>
<td>4 核 12G</td>
</tr>
<tr>
<td>FTA</td>
<td>1 核 2G</td>
</tr>
</tbody>
</table>
<p>如果硬件资源富余，可以一开始拆分搭建部署。若硬件资源不足，一开始可以混合搭建，注意观测资源消耗情况，可以适时增加机器，迁移模块的方式来保证整体的可用性。</p>
<p>资源规划是一个复杂的、动态的过程，更像是一门艺术而不是科学。</p>
<p>这里给出的一个比较合理的初始配置，基于以下考虑：</p>
<ol>
<li>
<p>分布式模块达到高可用至少三个节点，所以至少需要三个 OS (物理机或虚拟机均可)</p>
</li>
<li>
<p>BKDATA 是耗费资源最多的蓝鲸组件。请分配到 4 核 16G 以上的机器。</p>
</li>
<li>
<p>若日志检索，蓝鲸监控是主要使用场景，请给 influxdb 和 elasticsearch 模块更多的内存，更好磁盘性能。如 SSD。</p>
</li>
<li>
<p>NGINX 模块所在的机器需要有对外提供服务，可访问的 IP。这是蓝鲸平台的总入口。</p>
</li>
<li>
<p>如果需要有跨云管理需求，GSE 部署的机器需要有跨云的网络条件。</p>
</li>
</ol>
<p>根据以上考虑，安装蓝鲸初始配置，请满足：</p>
<ul>
<li>1 台 4 核 16G</li>
<li>2 台 4 核 8G</li>
</ul><h1 id="_1">安装环境准备</h1>
<p>开始安装蓝鲸社区版前，需按以下文档指南，做好准备工作。</p>
<p><strong>注意：所有待安装蓝鲸的机器均需要按以下清单检查和操作。</strong></p>
<h2 id="_2">获取安装包</h2>
<p>蓝鲸社区版包含部署脚本、产品软件和开源组件。蓝鲸提供完整包与分包的下载通道，请自行到下载地址按需获取。新装环境及新用户建议下载完整包使用。</p>
<p>下载地址：<a href="https://bk.tencent.com/download/">https://bk.tencent.com/download/</a></p>
<p>下载完成后，请核对 MD5 码。</p>
<h2 id="centos">CentOS 系统设置</h2>
<p>准备好硬件，安装完原生 CentOS 系统后。我们需要对初始系统做一些配置，保证后续安装过程的顺畅和蓝鲸平台的运行。</p>
<p><strong>系统版本：</strong> 要求 CentOS-7.0 以上版本，推荐 CentOS-7.5。</p>
<ol>
<li>
<p>关闭 SELinux</p>
<p>```bash</p>
<h1 id="selinux">检查 SELinux 的状态，如果它已经禁用，可以跳过后面的命令</h1>
<p>sestatus
```</p>
<p>可以使用以下命令禁用 SELinux，或者修改配置文件。
```bash</p>
<h1 id="selinux_1">通过命令禁用 SELinux</h1>
<p>setenforce 0</p>
<h1 id="_3">或者修改配置文件</h1>
<p>sed -i 's/^SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config
<code>接着，重启机器：</code>bash
reboot
```
2. 安装 rsync 命令</p>
<p>安装脚本依赖 rsync 分发同步文件。</p>
<p>```bash</p>
<h1 id="rsync-rsync">检查是否有 rsync 命令，如果有返回 rsync 路径，可以跳过后面的命令</h1>
<p>which rsync</p>
<h1 id="rsync">安装 rsync</h1>
<p>yum -y install rsync
```
3. 关闭默认防火墙（firewalld）</p>
<p>安装和运行蓝鲸时，模块之间互相访问的端口策略较多，建议对蓝鲸后台服务器之间关闭防火墙。</p>
<p>```bash</p>
<h1 id="not-running">检查默认防火墙状态，如果返回 not running，可以跳过后面的命令</h1>
<p>firewall-cmd --state
<code>停止并禁用 firewalld</code>bash
systemctl stop firewalld    # 停止 firewalld
systemctl disable firewalld # 禁用 firewall 开机启动
```</p>
</li>
<li>
<p>停止并禁用 NetWorkManager
    <code>bash
    systemctl stop NetworkManager 
    systemctl disable NetworkManager</code></p>
</li>
<li>
<p>调整最大文件打开数</p>
<p>```bash</p>
<h1 id="root-max-open-files">检查当前 root 账号下的 max open files 值</h1>
<p>ulimit -n
```</p>
<p>如果为默认的 1024，建议通过修改配置文件调整为 102400 或更大。</p>
<p><strong>注意：</strong> limits.conf 初始文件的备份。
<code>bash
cat &lt;&lt; EOF &gt;&gt; /etc/security/limits.conf
root soft nofile 102400
root hard nofile 102400
EOF</code></p>
<p>修改后，重新使用 root 登录检查是否生效。</p>
</li>
<li>
<p>确认服务器时间同步</p>
<p>服务器后台时间不同步会对时间敏感的服务带来不可预见的后果。务必在安装和使用蓝鲸时保证时间同步。</p>
<p>```bash</p>
<h1 id="3s">检查每台机器当前时间和时区是否一致，若相互之间差别大于3s（考虑批量执行时的时差），建议校时。</h1>
<p>date -R</p>
<h1 id="ntp-serverntpd">查看和ntp server的时间差异(需要外网访问，如果内网有ntpd服务器，自行替换域名为该服务的地址)</h1>
<p>ntpdate -d cn.pool.ntp.org
```</p>
<p>如果输出的最后一行 offset 大于 1s 建议校时。
```bash</p>
<h1 id="ntp">和 ntp 服务器同步时间</h1>
<p>ntpdate cn.pool.ntp.org
```</p>
<p>更可靠的方式包括通过运行 ntpd 或者 chrony 等服务在后台保持时间同步。具体请参考官方文档 <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/system_administrators_guide/ch-configuring_ntp_using_ntpd">使用 ntpd 配置 NTP</a> 或 <a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/system_administrators_guide/ch-Configuring_NTP_Using_the_chrony_Suite">使用 chrony 配置 NTP</a>。</p>
</li>
<li>
<p>检查是否存在全局 HTTP 代理</p>
<p>蓝鲸服务器之间会有的 HTTP 请求，如果存在 HTTP 代理，且未能正确代理这些请求，会发生不可预见的错误。</p>
<p>```bash</p>
<h1 id="http_proxy-https_proxy">检查 http_proxy https_proxy 变量是否设置，若为空可以跳过后面的操作。</h1>
<p>echo "$http_proxy" "$https_proxy"
```
对于本机配置 http_proxy 变量的方式，请依次查找文件 /etc/profile、/etc/bashrc、$HOME/.bashrc 等是否有设置。
或者咨询网络管理员/IT 部门协助处理。</p>
</li>
</ol>
<p>在这些主机中，选择任意一台机器作为蓝鲸的运维中控机。之后的安装命令执行，如果没有特别说明，均在这台中控机上执行。</p>
<p>将下载的蓝鲸社区版完整包上传到中控机，并解压到 <strong>同级</strong> 目录下。以解压到 <code>/data</code> 目录为例：</p>
<div class="codehilite"><pre><span></span>tar xf bkce_src-5.0.3.tar.gz  -C /data
</pre></div>


<p>解压之后，得到两个目录：src，install</p>
<ul>
<li>
<p>src：存放蓝鲸产品软件，以及依赖的开源组件</p>
</li>
<li>
<p>install：存放安装部署脚本、安装时的参数配置、日常运维脚本等</p>
</li>
</ul>
<h2 id="yum">配置 YUM 源</h2>
<p>在所有蓝鲸服务器上配置好 YUM 源，要求该 YUM  源包含 EPEL。</p>
<p>不能连外网 YUM 源的环境，可以配置一个内部的 YUM  源 或者本地 YUM 源。</p>
<h2 id="yum_1">本地 YUM 源</h2>
<p>参考附录中的 <a href="../../场景案例/离线部署/offline_setup.md">离线安装的配置方法</a>。</p>
<h2 id="yum_2">在线 YUM 源</h2>
<p>推荐使用以下 YUM 源：</p>
<ul>
<li><a href="https://mirrors.cloud.tencent.com/help/centos.html">腾讯云 CentOS</a></li>
<li><a href="https://mirrors.cloud.tencent.com/help/epel.html">腾讯云 EPEL</a></li>
</ul>
<h2 id="_4">配置文件</h2>
<p>在 install 目录下，共有三个配置：</p>
<ul>
<li>install.config</li>
<li>globals.env</li>
<li>ports.env</li>
</ul>
<h3 id="installconfig">install.config</h3>
<p><code>install.config</code> 是模块和服务器对应关系的配置文件，描述在哪些机器上安装哪些模块。
每行两列，第一列是 IP 地址；第二列是以英文逗号分隔的模块名称。
详情参考<code>install.config.3IP.sample</code>文件（可将 install.config.3IP.sample 复制为 install.config）。</p>
<div class="codehilite"><pre><span></span><span class="o">[</span>bkce-basic<span class="o">]</span>
<span class="m">10</span>.0.0.1 nginx,rabbitmq,kafka<span class="o">(</span>config<span class="o">)</span>,zk<span class="o">(</span>config<span class="o">)</span>,es,appt,fta,consul,bkdata<span class="o">(</span>databus<span class="o">)</span>
<span class="m">10</span>.0.0.2 mongodb,appo,kafka<span class="o">(</span>config<span class="o">)</span>,zk<span class="o">(</span>config<span class="o">)</span>,es,mysql,consul,bkdata<span class="o">(</span>dataapi<span class="o">)</span>,beanstalk
<span class="m">10</span>.0.0.3 paas,cmdb,job,gse,license,kafka<span class="o">(</span>config<span class="o">)</span>,zk<span class="o">(</span>config<span class="o">)</span>,es,redis,influxdb,consul,bkdata<span class="o">(</span>monitor<span class="o">)</span>
</pre></div>


<blockquote>
<p>说明:
- 该配置文件，ip 后面使用空格与服务名称隔开，含有多个内网 ip 的机器，默认使用 /sbin/ifconfig 输出中的第一个内网 ip，在 ip 后面写上该机器要安装的服务列表即可，部署过程中默认使用标准私有地址，若企业环境使用非标准私有地址，请参考 <strong>本章后续内容 - 非标准私有地址处理方法</strong> 的处理方法。
- zk 表示 zookeeper， es 表示 elasticsearch。
- gse 与 redis 需要部署在同一台机器上。
- 增加机器数量时， 可以将以上配置中的服务挪到新的机器上，分担负载。 要保证：kafka， es， zk 的每个组件的总数量为 3。</p>
</blockquote>
<h3 id="globalsenv">globals.env</h3>
<p>该文件定义了各类组件的账号密码信息。 功能开关控制选项等。可根据实际情况进行修改。
配置项含义，请查看文件中的注释。</p>
<ul>
<li>该文件含密码信息，请保证除了 root 用户外，其他用户不可读。</li>
<li>各类账号密码建议修改，注意设置的各类密码不能有 / $  ` &lt; &gt; &amp; 等特殊字符。</li>
<li>配置 HTTP 代理：若公司不能访问外网，但有自己的 proxy，在该配置文件的 BK_PROXY 选项中指定代理地址。</li>
<li>若需要跨云管理功能(服务器在不同的 IDC，内网不互通的情况):</li>
<li>需要将 gse 所在机器的外网 IP 填到该文件中 GSE_WAN_IP 配置项中的括号里 如：<code>export GSE_WAN_IP=(1.2.3.4)</code>，若没有外网 IP 则留空。</li>
<li><code>HAS_DNS_SERVER</code> 配置默认为 0，表示配置的蓝鲸域名需要通过 /etc/hosts 来解析，此时部署脚本会自动修改每台机器的 /etc/hosts 添加相关域名。如果想走自己的 dns 配置，改为非 0 即可。</li>
<li><code>HTTP_SCHEMA=http</code>  默 认 HTTP_SCHEMA 设置为  HTTP 即蓝鲸软件全站为  HTTP，若设置为 HTTPS 则蓝鲸软件全站为 HTTPS，可支持 HTTP 和 HTTPS 的切换。</li>
<li>该配置文件中提供了访问蓝鲸三大平台的域名配置，需要提前准备好。</li>
</ul>
<p><code>bash
  export BK_DOMAIN="bk.com"                # 蓝鲸根域名(不含主机名)
  export PAAS_FQDN="paas.$BK_DOMAIN"       # PAAS 完整域名
  export CMDB_FQDN="cmdb.$BK_DOMAIN"       # CMDB 完整域名
  export JOB_FQDN="job.$BK_DOMAIN"         # JOB 完整域名</code></p>
<blockquote>
<p>说明：
1. BK_DOMAIN 的值不能为 "com" "net" 这种顶级域名，至少二级域名开始。
2. FQDN 的选择需要遵循 DNS 的命名规范，可选的字符集是 [A-Za-z0-9.] 以及 "-"，特别要注意，下划线 (_) 是不允许的。
3. PAAS_FQDN CMDB_FQDN JOB_FQDN 的值都必须在 BK_DOMAIN 定义的根域名之下，保证登陆鉴权的 cookie 文件有效。</p>
</blockquote>
<h3 id="portsenv">ports.env</h3>
<p>端口定义。 默认情况下，不用修改。特殊场景下，若有端口冲突，可以自行定义。</p>
<h2 id="_5">非标准私有地址处理方法</h2>
<p>蓝鲸社区版部署脚本中(install 目录)下有以下文件中有获取 ip 的函数 get_lan_ip，非标准地址，均需要在安装部署前完成修改。</p>
<div class="codehilite"><pre><span></span>./appmgr/docker/saas/buildsaas
./appmgr/docker/build
./functions
./scripts/gse/server/gsectl
./scripts/gse/plugins/reload.sh
./scripts/gse/plugins/start.sh
./scripts/gse/plugins/stop.sh
./scripts/gse/agent/gsectl
./scripts/gse/proxy/gsectl
./scripts/gse/agentaix/gsectl.ksh
./agent_setup/download#agent_setup_pro.sh
./agent_setup/download#agent_setup_aix.ksh
./agent_setup/download#agent_setup.sh
</pre></div>


<p>这些文件列表，可能随版本迭代变动，也可以用以下命令查找出来包含这个函数的脚本文件有哪些：</p>
<div class="codehilite"><pre><span></span>grep -l <span class="s1">&#39;get_lan_ip *()&#39;</span> -r /data/install
</pre></div>


<p>修改方法：</p>
<p>假设服务器的的 ip 是：138.x.x.x，它不在标准的私有地址范围，那么你需要修改 get_lan_ip() 函数为：</p>
<div class="codehilite"><pre><span></span>get_lan_ip  <span class="o">()</span> <span class="o">{</span>
...省略
               <span class="k">if</span> <span class="o">(</span><span class="nv">$3</span> ~ /^10<span class="se">\.</span>/<span class="o">)</span> <span class="o">{</span>
                   print <span class="nv">$3</span>
               <span class="o">}</span>
               <span class="k">if</span> <span class="o">(</span><span class="nv">$3</span> ~ /^138<span class="se">\.</span>/<span class="o">)</span> <span class="o">{</span>
                   print <span class="nv">$3</span>
               <span class="o">}</span>
          <span class="o">}</span><span class="err">&#39;</span>

   <span class="k">return</span> <span class="nv">$?</span>
<span class="o">}</span>
</pre></div>


<h2 id="pipconf">pip.conf</h2>
<p>在线安装时，依赖 pip，需要配置可用的 pip 源。</p>
<div class="codehilite"><pre><span></span>vim /data/src/.pip/pip.conf

<span class="o">[</span>global<span class="o">]</span>
index-url <span class="o">=</span> https://mirrors.cloud.tencent.com/pypi/simple
trusted-host <span class="o">=</span> mirrors.cloud.tencent.com
</pre></div>


<ul>
<li>
<p>设置为能连上的 pip 源，以腾讯云镜像源加速 pip 为例。默认的 pip 源配置通常无法使用，验证方式如下。</p>
</li>
<li>
<p>在每台机器上对 <code>pip.conf</code> 中配置的 url 进行操作：<code>curl http://xxxxxxx</code>，若能正常返回列表信息则为成功。</p>
</li>
</ul>
<h2 id="_6">获取证书</h2>
<ol>
<li>
<p>通过 <code>ifconfig</code> 或者 <code>ip addr</code> 命令获取 install.config 文件中，license 和 gse 模块所在服务器的第一个内网网卡的 MAC 地址。如果分别属于两台服务器，那么两个的 MAC 地址以英文;分隔。</p>
</li>
<li>
<p>在官网 <a href="https://bk.tencent.com/download_ssl/">证书生成页面</a> 根据输入框提示填入 MAC 地址，生成并下载证书。</p>
</li>
<li>
<p>上传证书到中控机，并解压到 <code>src/cert</code> 目录下。</p>
<p><code>bash
tar xf ssl_certificates.tar.gz -C /data/src/cert/</code></p>
</li>
</ol>
<h2 id="ssh">配置 SSH 免密登陆</h2>
<p>登录到中控机，执行以下操作：</p>
<div class="codehilite"><pre><span></span><span class="nb">cd</span> /data/install
bash configure_ssh_without_pass  <span class="c1"># 根据提示输入各主机的 root 密码完成免密登陆配置</span>
</pre></div>


<h2 id="_7">安装前校验环境是否满足</h2>
<p>按文档要求做完环境和部署的配置后，准备开始安装前，请运行以下脚本，来校验是否满足：</p>
<div class="codehilite"><pre><span></span><span class="nb">cd</span> /data/install
bash precheck.sh
</pre></div>


<p>正常输出如下图所示：</p>
<div class="codehilite"><pre><span></span>start <span class="s">&lt;&lt;check_ssh_nopass&gt;&gt; ... [OK]</span>
<span class="s">start &lt;&lt;check_password&gt;&gt; ... [OK]</span>
<span class="s">start &lt;&lt;check_cert_mac&gt;&gt; ... [OK]</span>
<span class="s">start &lt;&lt;check_get_lan_ip&gt;&gt; ... [OK]</span>
<span class="s">start &lt;&lt;check_install_config&gt;&gt; ... [OK]</span>
<span class="s">start &lt;&lt;check_s</span>elinux&gt;&gt; ... <span class="o">[</span>OK<span class="o">]</span>
start <span class="s">&lt;&lt;check_umask&gt;&gt; ... [OK]</span>
<span class="s">start &lt;&lt;check_</span>rabbitmq_version&gt;&gt; ... <span class="o">[</span>OK<span class="o">]</span>
start <span class="s">&lt;&lt;check_http_proxy&gt;&gt; ... [OK]</span>
<span class="s">start &lt;&lt;check_</span>open_files_limit&gt;&gt; ... <span class="o">[</span>OK<span class="o">]</span>
start <span class="s">&lt;&lt;check_domain&gt;&gt; ... [OK]</span>
<span class="s">start &lt;&lt;check_</span>rsync&gt;&gt; ... <span class="o">[</span>OK<span class="o">]</span>
start <span class="s">&lt;&lt;check_service_dir&gt;&gt; ... [OK]</span>
<span class="s">start &lt;&lt;check_</span>networkmanager&gt;&gt; ... <span class="o">[</span>OK<span class="o">]</span>
start <span class="s">&lt;&lt;chec</span>k_firewalld&gt;&gt; ... <span class="o">[</span>OK<span class="o">]</span>
</pre></div>


<p>如果发现有 [FAIL] 的报错，按照提示和本文档修复。修复后，可继续跑 precheck.sh 脚本，直到不再出现 [FAIL]。如果需要从头开始检查，请使用 <code>precheck.sh -r</code> 参数。</p><h1 id="_1">软件包内容概述</h1>
<p>解压 <code>bkce_src-xx.tar.gz</code> 安装包后，<code>src</code> 即为软件包目录，存放了蓝鲸基础平台、官方 SaaS 包、开源组件等内容。</p>
<div class="codehilite"><pre><span></span><span class="o">[</span>root@nginx-1 src<span class="o">]</span><span class="c1"># tree -F -L 1</span>
.
├── bkdata/
├── bknetwork/
├── blueking.env
├── cert/
├── cmdb/
├── ENTERPRISE
├── fta/
├── gse/
├── job/
├── license/
├── MD5
├── miniweb/
├── official_saas/
├── open_paas/
├── paas_agent/
├── service/
└── VERSION
</pre></div>


<h2 id="_2">软件包内容说明</h2>
<p>蓝鲸基础平台及 SaaS 详细说明请参考 <a href="https://bk.tencent.com/docs/">产品白皮书</a>，开源组件版本和配置方式可参考 <a href="../../附录/开源组件版本/version.md">附录</a>。</p>
<ul>
<li><strong>VERSION</strong>：社区版版本号文件。</li>
<li><strong>ENTERPRISE</strong>：代号文件，社区版默认都是 <strong>blueking</strong>。</li>
<li><strong>MD5</strong>：MD5 校验文件。</li>
<li><strong>blueking.env</strong>：证书环境变量。</li>
<li><strong>cert/</strong>：放置证书文件的目录。</li>
<li><strong>license/</strong>：鉴权服务器。</li>
<li><strong>miniweb/</strong>：空目录，安装时会动态生成一些脚本和配置文件到这里。</li>
<li><strong>service/</strong>：开源组件存放目录。</li>
<li><strong>open_paas/</strong>：PaaS 后台。</li>
<li><strong>paas_agent/</strong>：SaaS 部署后台。</li>
<li><strong>official_saas/</strong>：官方 SaaS 包，可以在后台一键部署蓝鲸官方 SaaS。</li>
<li><strong>cmdb/</strong>：配置平台后台。</li>
<li><strong>job/</strong>：作业平台后台。</li>
<li><strong>gse/</strong>：管控平台后台。</li>
<li><strong>bkdata</strong>：数据平台基础模块存放路径，包含 dataapi，databus，monitor 三个子工程。</li>
<li><strong>dataapi/</strong>：数据平台 API 接口服务。</li>
<li><strong>databus/</strong>：数据平台总线服务。</li>
<li><strong>monitor/</strong>：蓝鲸监控后台服务。</li>
<li><strong>fta</strong>：故障自愈后台。</li>
<li><strong>bknetwork</strong>：网络管理 SaaS 的后台模块。</li>
</ul>
<h2 id="_3">软件包目录结构</h2>
<p>请按照目录结构检查对应文件目录是否存在：</p>
<blockquote>
<p><strong>Note：</strong> .pip 是 pip 源的配置文件，由于兼容前后版本，在软件包和部署脚本包多个地方都存在，可以忽略。社区版 V5.1 版本的 pip 源配置文件整合到 install 目录中。</p>
</blockquote>
<div class="codehilite"><pre><span></span><span class="o">[</span>root@nginx-1 src<span class="o">]</span><span class="c1"># tree -F -L 1</span>
.
├── bkdata/
├── bknetwork/
├── blueking.env
├── cert/
├── cmdb/
├── ENTERPRISE
├── fta/
├── gse/
├── job/
├── license/
├── MD5
├── miniweb/
├── official_saas/
├── open_paas/
├── paas_agent/
├── service/
└── VERSION
</pre></div>


<p>上面这层目录称为模块，模块下面会有子工程，称为 <code>project</code> ，比如 BKDATA 模块下：</p>
<div class="codehilite"><pre><span></span><span class="o">[</span>root@nginx-1 bkdata<span class="o">]</span><span class="c1"># tree -F -L 1 . support-files/</span>
.
├── dataapi/
├── databus/
├── monitor/
└── support-files/
support-files/
├── pkgs/
├── README.md
├── scripts/
├── sql/
└── templates/
</pre></div>


<p>这里重点介绍下 <code>support-files/</code> 目录：</p>
<ul>
<li>
<p><strong>pkgs</strong>： 存放依赖包，比如 Python 工程的 pip 包。</p>
</li>
<li>
<p><strong>scripts</strong>： 存放该模块依赖的工具脚本、crontab 记录等。</p>
</li>
<li>
<p><strong>sql</strong>： 存放初始或者升级时用到的 sql 文件。</p>
</li>
<li>
<p><strong>templates</strong>： 存放模块的模板文件，安装时会替换里面的 类似 <code>__VAR_NAME__</code>： 形式的变量。</p>
</li>
</ul><h1 id="_1">单机部署</h1>
<p>单机部署方案是针对新老用户快速低成本的搭建一套精简版的蓝鲸社区版推出的。</p>
<p>从社区版 4.1.11 版本开始，支持完整版本蓝鲸的单机部署体验，前提要求是，单机 CPU 不低于 2 核，可用内存不低于 16GB。
若机器性能没满足要求，只能部署精简版的蓝鲸平台。</p>
<p>精简版蓝鲸平台满足简单的运维场景需求，包含：PaaS 平台，配置平台，作业平台，以及安装  Agent 用的 节点管理 SaaS。</p>
<h2 id="_2">部署方式</h2>
<ul>
<li>
<p><a href="https://cloud.tencent.com/developer/labs/lab/10386">腾讯云实验室</a></p>
</li>
<li>
<p>自行提供主机</p>
</li>
</ul>
<h2 id="_3">自行提供主机</h2>
<p>按照安装 <a href="../../基础包安装/环境准备/get_ready.md">环境准备</a> 章节中，主机和系统环境的要求做好相应设置。</p>
<ul>
<li>环境准备</li>
<li>
<p>准备一台 CentOS 7 以上操作系统的机器（物理机和虚拟机均可）。</p>
</li>
<li>
<p>按照安装 <a href="../../基础包安装/环境准备/get_ready.md">环境准备</a> 章节中，主机和系统环境的要求做好相应设置。</p>
</li>
<li>
<p>配置好 YUM 源，包含 EPEL 仓库（可以通过 <code>yum info nginx</code> 测试下）。</p>
</li>
<li>
<p>从 <a href="http://bk.tencent.com/download/">官网下载</a> 完整包，并解压到 /data/ 下。</p>
<p><code>bash
$ tar xf bkce_src-5.0.3.tar.gz  -C /data</code></p>
</li>
<li>
<p>获取机器的 MAC 地址后，下载 <a href="https://bk.tencent.com/download_ssl/">证书文件</a>，解压到 src/cert 目录下
    <code>bash
    $ tar xf ssl_certificates.tar.gz -C /data/src/cert</code></p>
</li>
<li>
<p>配置参数</p>
</li>
<li>
<p>install.config 这个文件安装脚本会自动生成，无需自行配置。</p>
</li>
<li>
<p>globals.env 重点关注域名和 GSE 外网 IP 相关的配置，详情参考 <a href="../../基础包安装/环境准备/get_ready.md#configs">环境准备-配置文件</a> 一节。</p>
</li>
<li>
<p>ports.env 一般不用修改。</p>
</li>
<li>
<p>执行安装</p>
</li>
</ul>
<p>如果部署全部组件，请执行：
  <code>bash
  $ cd /data/install
  $ ./install_minibk -y</code></p>
<p>如果按需部署，假设只需要 PaaS，CMDB，JOB 平台，请执行：
  <code>bash
  $ cd /data/install
  $ ./install_minibk
  $ ./bk_install paas &amp;&amp; ./bk_install cmdb &amp;&amp; ./bk_install job</code></p>
<p>安装过程中遇到失败的情况，请先定位排查解决后，再重新运行失败时的安装指令。</p>
<h2 id="_4">访问蓝鲸</h2>
<p>根据 <code>install/globals.env</code> 里配置的 PaaS 域名(PAAS_FQDN)、账号 (PAAS_ADMIN_USER)、密码(PAAS_ADMIN_PASS)信息，登录访问(若域名没设置 DNS 解析，需配置本机 hosts)。</p>
<ul>
<li>域名信息</li>
</ul>
<p><code>bash
  export BK_DOMAIN="xxx.com"
  export PAAS_FQDN="paas.$BK_DOMAIN"
  export CMDB_FQDN="cmdb.$BK_DOMAIN"
  export JOB_FQDN="job.$BK_DOMAIN"</code></p>
<ul>
<li>账号信息</li>
</ul>
<p><code>bash
  export PAAS_ADMIN_USER=admin
  export PAAS_ADMIN_PASS="xxx"</code></p>
<p>日常维护和运维，单机部署和多机是一致的，请参考 <a href="../../维护手册/日常维护/maintain.md">维护文档</a>。</p>
<h2 id="_5">使用蓝鲸</h2>
<p>请参考蓝鲸各 <a href="https://bk.tencent.com/docs/">产品白皮书</a>。</p><h1 id="_1">标准部署</h1>
<blockquote>
<p><strong>部署说明：</strong> 请严格 按顺序执行 以下操作完成蓝鲸智云社区版基础包的安装，以下步骤若有报错/失败，需要根据提示修复错误后，在重新执行相同的命令（支持断点续装）。</p>
</blockquote>
<p><strong>每一个步骤执行如果有报错，需要修复错误，保证安装成功后，才可以继续</strong>。因为安装顺序是有依赖关系的，如果前面的平台失败扔继续往下安装，会遇到更多的报错导致整体安装失败。</p>
<p>修复错误所需要了解的相关命令，请参考 <a href="../../维护手册/日常维护/maintain.md">维护文档</a>。</p>
<p>进行标准部署之前，请确保已完成 <a href="../../基础包安装/环境准备/get_ready.md">环境准备</a> 操作。</p>
<div class="codehilite"><pre><span></span><span class="nb">cd</span> /data/install

<span class="c1"># 安装 PaaS 平台及其依赖服务，该步骤完成后，可以打开 PaaS 平台。</span>
./bk_install paas

<span class="c1"># 安装配置平台及其依赖服务，该步骤完成后，可以打开配置平台，看到蓝鲸业务及示例业务。</span>
./bk_install cmdb  

<span class="c1"># 该步骤完成后，可以打开作业平台，并执行作业。同时在配置平台中可以看到蓝鲸的模块下加入了主机。</span>
<span class="c1"># 安装作业平台及其依赖组件，并在安装蓝鲸的服务器上装好 gse_agent 供验证。</span>
./bk_install job

<span class="c1"># 部署正式环境及测试环境</span>
<span class="c1"># 该步骤完成后可以在开发者中心的服务器信息和第三方服务信息中看到已经成功激活的服务器</span>
<span class="c1"># 同时也可以进行 SaaS 应用(除蓝鲸监控和日志检索)的上传部署</span>
./bk_install app_mgr

<span class="c1"># 安装蓝鲸数据平台基础模块及其依赖服务。安装该模块后，可以开始安装使用 SaaS 应用: 蓝鲸监控和日志检索</span>
./bk_install bkdata

<span class="c1"># 安装故障自愈的后台模块及依赖其服务</span>
<span class="c1"># 安装该模块后，可以开始安装使用 SaaS 应用: 故障自愈</span>
./bk_install fta

<span class="c1"># 重装 gse_agent 并注册正确的集群模块到配置平台</span>
<span class="c1"># 执行完该操作后，可以在配置平台中看到主机按照 install.config 中的配置分布到对应拓扑下</span>
./bkcec install gse_agent

<span class="c1">#部署官方 SaaS 到正式环境(通过命令行从 /data/src/official_saas/ 目录自动部署 SaaS )</span>
<span class="c1"># 执行完该操作后，可以在蓝鲸工作台看到并使用所有官方 SaaS</span>
./bkcec install saas-o
</pre></div>


<p>完成以后以上步骤后， 就可以按照部署完成的提示，开始使用蓝鲸智云社区版基础包了。</p>
<h2 id="_2">合作商软件包安装</h2>
<p><a href="../../合作方软件包安装/网络管理/net_man.md">网络管理</a></p>
<p><a href="../../合作方软件包安装/CICDKit/CICDKit.md">CICDKit</a></p>
<h2 id="bk_install">bk_install 安装命令解析</h2>
<ul>
<li>
<p>bk_install 其实是调用一连串的 bkcec 命令来执行安装过程。</p>
</li>
<li>
<p>bkcec 的命令如果执行成功，则将执行成功的参数写入 <code>/data/install/.bk_install.step</code>。</p>
</li>
<li>
<p>例如执行 <code>bkcec start rabbitmq</code> ，如果执行失败，手动通过一些命令让 RabbitMQ 拉起后，可以自行 <code>echo start rabbitmq &gt;&gt; /data/install/.bk_install.step</code> 追加，然后继续运行 <code>./bk_install xxx</code> 这样会自动跳过 <code>bkcec start rabbitmq</code> ，继续下面的安装指令。</p>
</li>
</ul><h1 id="_1">环境验证</h1>
<h2 id="_2">从后台验证环境是否安装正常</h2>
<ol>
<li>登录到中控机，通过脚本自带的命令查询蓝鲸后台模块的运行状态</li>
</ol>
<div class="codehilite"><pre><span></span><span class="c1"># 加载环境变量和蓝鲸安装维护的函数</span>
<span class="nb">source</span> /data/install/utils.fc

<span class="c1"># 查看运行状态</span>
./bkcec status all
</pre></div>


<p><img alt="后台状态图1" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/check1.png" />
<img alt="后台状态图2" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/check2.png" />
如上图所示，所有模块状态都是 <code>RUNNING</code> 则说明蓝鲸社区版后台模块部署正常。</p>
<ol>
<li>
<p>检查 BKDATA 清洗数据的任务是否正常启动</p>
</li>
<li>
<p>社区版 V5.0 及更早版本，在部署 BKDATA 的主机上执行:</p>
</li>
</ol>
<p><code>bash
  # 检查是否有包含 databus_etl 的任务
  crontab -l</code></p>
<ul>
<li>
<p>社区版 V5.1 及之后版本，在部署完 BKDATA 后，检查进程  <code>run_cron</code> 是否存活:</p>
</li>
<li>
<p>检查 BKDATA 运行状态
  ```bash
  # 从中控机中跳转到 BKDATA Svr，执行检查脚本检查接口，无报错即正常</p>
</li>
</ul>
<p>ssh $BKDATA_IP
  ./data/bkce/bkdata/dataapi/bin/check_xxx.sh
  ```
<img alt="bkdata检查脚本执行结果" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/check3.png" /></p>
<ol>
<li>
<p>检查 Agent 状态是否正常：</p>
</li>
<li>
<p>在中控机执行</p>
</li>
</ol>
<p>```bash
  ./bkcec status gse_agent</p>
<p># 返回 “Running” 说明 Agent 状态正常
  # 如果返回 "Exit" 则需要手动安装或者启动
  # 手动安装
  ./bkcec install gse_agent
  # 启动
  ./bkcec start gse_agent
  ```</p>
<ol>
<li>
<p>检查健康状态 API：</p>
</li>
<li>
<p>蓝鲸产品后台提供了健康检查的接口，用 HTTP GET 请求访问，接口地址和端口用变量表达：</p>
</li>
</ol>
<p>```bash
  cd /data/install &amp;&amp; source utils.fc</p>
<p># PaaS 注意 URL 末尾带上/
  curl http://$PAAS_FQDN:$PAAS_HTTP_PORT/healthz/</p>
<p># CMDB(beta)，目前版本不够准确
  curl http://$CMDB_IP:$CMDB_API_PORT/healthz</p>
<p># JOB
  curl http://$JOB_FQDN:$PAAS_HTTP_PORT/healthz
  ```</p>
<ul>
<li>蓝鲸监控 SaaS 的监控检查接口，可以用浏览器直接访问:</li>
</ul>
<div class="codehilite"><pre><span></span>http://<span class="nv">$PAAS_FQDN</span>:<span class="nv">$PAAS_HTTP_PORT</span>/o/bk_monitor/healthz/
</pre></div>


<h2 id="_3">从页面验证功能是否运行正常</h2>
<p>请先 <strong>配置 host 或者 DNS</strong> 解析后，确认访问社区版域名（部署完成后提示的域名）是否正常。</p>
<ul>
<li>配置 host / DNS 解析：配置 DNS 服务或者在本地配置 host 解析请参照 蓝鲸配置文件 global.env 或者中控机下 <code>/etc/hosts</code>。</li>
</ul>
<p>从蓝鲸工作台-开发者中心-服务器中检查 <strong>正式服务器</strong> 是否激活。</p>
<p><img alt="APPO状态检查图" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/paas_appostatuscheck.png" /></p>
<p>从蓝鲸工作台-开发者中心-第三方服务中检查 <strong>RabbitMQ 服务</strong> 是否激活。</p>
<p><img alt="RabbitMQ状态检查图" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/paas_rabbitmqstatuscheck.png" /></p>
<p>登录蓝鲸，从各 SaaS 验证环境功能是否运行正常。</p>
<blockquote>
<p>产品功能介绍&amp;使用手册请参考各 <a href="https://bk.tencent.com/docs/">产品白皮书</a></p>
</blockquote><h1 id="_1">快速使用</h1>
<p>为了验证刚部署安装的环境是否正常，除了从后台验证，也需要从页面上进行功能性的验证。</p>
<h2 id="_2">创建业务</h2>
<ul>
<li>首先在配置平台(CMDB) 上新建一个任务，将 admin 添加至运维人员。</li>
</ul>
<p><img alt="添加业务" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/add_business.png" /></p>
<ul>
<li>在业务下新建集群以及模块。(蓝鲸业务不支持集群及模块操作)</li>
</ul>
<p><img alt="添加模块" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/add_modul.png" /></p>
<p><strong>下述步骤需在节点管理完成后操作。</strong></p>
<ul>
<li>成功安装完 Agent后，在 配置平台(CMDB) 中的对应业务下，则会出现安装好 Agent 的主机。</li>
</ul>
<p><img alt="主机" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/hosts.png" /></p>
<ul>
<li>将资源池下的主机移动到模块下。</li>
</ul>
<p><img alt="分配主机" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/dis_host.png" /></p>
<h2 id="agent">安装 Agent</h2>
<ul>
<li>在对应业务下安装主机 Agent。</li>
</ul>
<p><img alt="安装agent" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/agent.png" /></p>
<p><img alt="成功安装agent" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/success_agent.png" /></p>
<ul>
<li>Agent 安装成功后查看下采集器是否正常。</li>
</ul>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/agent_status.png" /></p>
<h2 id="_3">执行作业</h2>
<ul>
<li>测试快速执行脚本可用性。</li>
</ul>
<p><img alt="快速执行作业脚本" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/exec_job.png" /></p>
<ul>
<li>查看作业执行情况。</li>
</ul>
<p><img alt="作业执行成功" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/job_success.png" /></p>
<ul>
<li>测试快速分发文件可用性。</li>
</ul>
<p>上传测试文件，分发至目标主机。</p>
<p><img alt="快速分发文件" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/exec_file.png" /></p>
<p>查看文件分发情况。</p>
<p><img alt="文件分发成功" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/file_success.png" /></p>
<p>查看目标主机路径下是否存在该文件。</p>
<p><img alt="主机存在文件" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/exist_file.png" /></p>
<ul>
<li>测试定时作业可用性。</li>
</ul>
<p>左侧导航栏选择【新建作业】，作业新建完成后，选择【定时作业】进行添加定时作业任务。然后启动任务。</p>
<p><img alt="定时作业" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/add_script.png" /></p>
<p><img alt="新建定时作业" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/job_Timeing.png" /></p>
<p>左侧导航栏选择【执行历史】查看定时作业执行情况。</p>
<p><img alt="定制作业执行情况" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/Timejobsuccess.png" /></p>
<h2 id="_4">创建流程</h2>
<ul>
<li>
<p>新建一个业务流程模板。</p>
<p>选择【快速执行脚本】，输入脚本内容，目标 IP 通过变量进行传入，类型选择【IP 选择器】，<a href="https://github.com/Tencent/bk-sops/blob/V3.3.X/docs/features/variables_engine.md#ip%E9%80%89%E6%8B%A9%E5%99%A8%E7%AE%80%E5%8D%95%E7%89%88">IP 选择器（简单版）跟 IP 选择器的区别</a> 。</p>
</li>
</ul>
<p><img alt="新建流程模版" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/add_sops.png" /></p>
<ul>
<li>新建并认领流程任务。</li>
</ul>
<p><img alt="新建" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/add_sops_task.png" /></p>
<p><img alt="认领任务" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/select_sops_task.png" /></p>
<ul>
<li>查看参数无误并执行任务。</li>
</ul>
<p><img alt="执行任务" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/view_para.png" /></p>
<ul>
<li>任务执行完成后，点击步骤可以查看执行的详细信息。点击对应链接可以跳转至作业平台查看作业执行情况及信息。</li>
</ul>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/sops_task_situation.png" /></p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/sops_task_situation2.png" /></p>
<h2 id="_5">主机监控</h2>
<ul>
<li>查看蓝鲸获取主机信息，主机状态，主机监控，服务状态图情况。</li>
</ul>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/bk_monitor.png" /></p>
<h2 id="_6">故障自愈</h2>
<ul>
<li>创建自愈套餐(如果不创建也可以自行使用默认套餐)。</li>
</ul>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/fta.png" /></p>
<ul>
<li>接入自愈。蓝鲸监控模拟告警，看故障自愈是否能够获取到告警并实现自愈。</li>
</ul>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/add_fta.png" /></p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/fta_source.png" /></p><h1 id="paas">安装 PaaS 平台</h1>
<p>PaaS 平台是蓝鲸产品的门户入口，所以安装蓝鲸先安装 PaaS 平台。</p>
<p>PaaS 平台依赖的组件和服务如下：</p>
<p><img alt="PaaS依赖简图" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/paas_depends.png" /></p>
<p>安装 PaaS 平台前，我们需要将中控机解压的 src/、install/ 目录根据 <code>install.config</code> 配置的 IP 和模块关系来分发文件。</p>
<div class="codehilite"><pre><span></span>./bkcec sync all
</pre></div>


<h2 id="consul">安装 Consul</h2>
<p>蓝鲸整个平台的内部通信基础是 Consul，所以最先安装的开源组件是 Consul。</p>
<div class="codehilite"><pre><span></span>./bkcec install consul   
./bkcec start consul
</pre></div>


<p>过程详解：</p>
<p><a href="https://www.consul.io/">Consul</a> 是一个分布式的服务发现和配置管理的开源组件。它只有一个二进制文件，所以安装的主要工作在于生成需要的配置文件。</p>
<p>安装 Consul 的主要步骤在 <code>install_consul</code> 函数中，它主要做了以下几个事情：</p>
<ul>
<li>
<p>生成 Consul 的主配置 <code>consul.conf</code> 和 Consul 用的服务定义文件<code>consul.d/service.json</code> 是由 <code>parse_config</code> 这个 Python 脚本读取 <code>install.config</code> 在每台机器上自动生成。</p>
</li>
<li>
<p>生成 Consul 的配置后，还需要生成启动的 Supervisor 配置。</p>
</li>
<li>
<p>修改系统的 <code>/etc/resolv.conf</code> 加上 <code>nameserver 127.0.0.1</code> 并保证它是第一条记录</p>
</li>
</ul>
<p>启动 Consul ，正常启动后，可以用 <code>consul members</code> 确认是否三台主机，其余机器为 client （如果机器数量大于 3）。</p>
<h2 id="license">安装 License 服务</h2>
<p>证书服务 License 也是所有蓝鲸产品的全局依赖，第二个安装。</p>
<div class="codehilite"><pre><span></span>./bkcec install license
./bkcec start license
</pre></div>


<p>详解：
1. 拷贝 License 代码和 cert 目录。</p>
<ol>
<li>
<p>渲染模块配置文件。</p>
</li>
<li>
<p>启动 License。</p>
</li>
</ol>
<h2 id="mysql">安装 MySQL</h2>
<p>开始安装 MySQL 数据库，并初始化设置。</p>
<div class="codehilite"><pre><span></span>./bkcec install mysql
./bkcec start mysql
./bkcec initdata mysql
</pre></div>


<p>详解：</p>
<ol>
<li>
<p>安装包里自带了 MySQL 的二进制，所以直接拷贝到安装目录。新建 MySQL 用户。</p>
</li>
<li>
<p>渲染 my.cnf 模板，然后建立 /etc/my.cnf 的软链。</p>
</li>
<li>
<p>执行 <code>mysql_install_db</code> 命令，初始化。</p>
</li>
<li>
<p>启动 MySQL。</p>
</li>
<li>
<p>对所有 install.config 里的 IP 在 MySQL 上授权。</p>
</li>
</ol>
<h2 id="redis">安装 Redis</h2>
<div class="codehilite"><pre><span></span>./bkcec install redis
./bkcec start redis
</pre></div>


<p>详解：</p>
<ol>
<li>
<p>将 Redis 命令拷贝到 <code>/usr/bin</code>。</p>
</li>
<li>
<p>渲染配置模板。</p>
</li>
<li>
<p>修改系统内核参数。</p>
<ul>
<li>
<p><code>net.core.somaxconn = 512</code></p>
</li>
<li>
<p><code>vm.overcommit_memory = 1</code></p>
</li>
</ul>
</li>
<li>
<p>启动 Redis。</p>
</li>
</ol>
<h2 id="nginx">安装 Nginx</h2>
<p>Nginx 通过 yum 命令从 epel 源里安装。</p>
<div class="codehilite"><pre><span></span>./bkcec install nginx
./bkcec start nginx
</pre></div>


<p>详解：</p>
<ol>
<li>
<p>yum 安装 nginx。</p>
</li>
<li>
<p>渲染 nginx 模板，并将 <code>/etc/nginx/nginx.conf</code> 软链到 <code>$INSTALL_PATH/etc/nginx.conf</code>。</p>
</li>
<li>
<p>创建 <code>$INSTALL_PATH/miniweb/download</code> 目录，并将 <code>/data/src/miniweb</code> 目录和 <code>/data/install/functions</code> 文件同步过去。供 Agent 安装时可以 HTTP 远程下载用。</p>
</li>
<li>
<p>启动 Nginx。</p>
</li>
</ol>
<h2 id="paas_1">安装 PaaS</h2>
<p>最后安装 PaaS 模块。</p>
<p><code>bash
 ./bkcec install paas
 ./bkcec initdata paas
 ./bkcec start paas</code></p>
<p>详解：</p>
<ol>
<li>
<p>安装 PaaS 用的函数叫 <code>install_open_paas</code> 。注意 PaaS 在安装部署脚本里均会被转换为 open_paas 来标识。这是一个特例。</p>
<ul>
<li>
<p>修改 <code>/etc/hosts</code> 配置 FQDN。</p>
</li>
<li>
<p>拷贝代码文件到 <code>$INSTALL_PATH/open_paas</code>。</p>
</li>
<li>
<p>安装 open_paas 专用的 Python。</p>
</li>
<li>
<p>创建四个子工程（appengine，login，esb，paas）的 Python 虚拟环境。</p>
</li>
<li>
<p>安装每个子工程依赖的 pip 包。</p>
</li>
<li>
<p>渲染模板文件。</p>
</li>
</ul>
</li>
<li>
<p>初始化 PaaS</p>
<ul>
<li>
<p>导入 SQL 初始化数据库。</p>
</li>
<li>
<p>PaaS Login ESB 分别做 Python migrate 初始化。</p>
</li>
<li>
<p>ESB 同步 API 文档事项。</p>
</li>
<li>
<p>添加 APP 的鉴权白名单，没有 session 时也可以调用 ESB。</p>
</li>
</ul>
</li>
<li>
<p>启动 PaaS。</p>
</li>
</ol><h1 id="cmdb">安装 CMDB</h1>
<p>CMDB 是蓝鲸的配置平台，数据库采用 MongoDB ，服务发现和配置管理使用 ZooKeeper ，快照数据使用 Redis 存储，快照采集依赖 GSE。</p>
<p>CMDB 的架构可以参考 GitHub 上的 <a href="https://github.com/Tencent/bk-cmdb/blob/master/docs/overview/architecture.md">蓝鲸智云配置平台的架构设计</a></p>
<p>CMDB 依赖的组件和服务如下：</p>
<p><img alt="CMDB依赖简图" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/cmdb_depends.png" /></p>
<p>Github 上也有 CMDB 的安装说明，蓝鲸社区版集成时稍微做了些规范改造和安装自动化，需要了解为什么这样安装 MongoDB 的，可以阅读 <a href="https://github.com/Tencent/bk-cmdb/blob/master/docs/overview/installation.md">CMDB 部署文档</a>。</p>
<h2 id="mongodb">安装 MongoDB</h2>
<p>安装 CMDB 的依赖中， MongoDB 是最重要的存储依赖，且目前只有 CMDB 独享，故先介绍 MongoDB 的安装：</p>
<div class="codehilite"><pre><span></span>./bkcec install mongodb
./bkcec initdata mongodb
./bkcec start mongodb
</pre></div>


<p>详解：</p>
<ol>
<li>
<p>MongoDB 二进制在蓝鲸的 <code>service/</code> 目录下已经自包含，所以安装时直接用 rsync 将 <code>src/service/mongodb</code> 目录同步到 <code>bkce/service/</code> 下即可。</p>
</li>
<li>
<p>MongoDB 的配置文件模板只有一个 mongodb.yaml ，里面具体配置的含义，请参考 <a href="https://docs.mongodb.com/manual/reference/configuration-options/">MongoDB 官方的配置说明文档</a></p>
</li>
<li>
<p>初始化 MongoDB ：</p>
<ul>
<li>
<p>首先以不开启鉴权的方式启动 MongoDB ，并创建管理员 <code>sysadmin</code> 的角色，和 · 里定义的 <code>$MONGODB_USER</code> 用户，并配置为 <code>sysadmin</code> 角色。</p>
</li>
<li>
<p>创建 <code>bk_cmdb</code> 用户，创建 CMDB 数据库，并授予 <code>bk_cmdb</code> 用户读写它的权限。</p>
</li>
<li>
<p>关闭 MongoDB 进程。</p>
</li>
</ul>
</li>
<li>
<p>调用 <code>$INSTALL_PATH/service/mongodb/bin/mongodb.sh start</code> 启动 MongoDB。</p>
</li>
</ol>
<h2 id="zookeeper">安装 ZooKeeper</h2>
<p>ZooKeeper 在这里的用途是作为 CMDB 的服务发现组件：</p>
<div class="codehilite"><pre><span></span>./bkcec install zk
./bkcec start zk
</pre></div>


<p>详解:</p>
<ol>
<li>
<p>拷贝 Java 和 ZooKeeper 代码目录到 <code>$INSTALL_PATH/service/</code> 下。</p>
</li>
<li>
<p>渲染配置文件模板，主要是 <code>zoo.cfg</code> ，并创建软连接到 <code>$INSTALL_PATH/etc/zoo.cfg</code>。</p>
</li>
<li>
<p>启动 ZooKeeper。</p>
</li>
</ol>
<h2 id="_1">安装配置平台</h2>
<p>需要特别注意的是 <code>CMDB</code> 先启动，再初始化数据：</p>
<div class="codehilite"><pre><span></span>./bkcec install cmdb
./bkcec start cmdb
./bkcec initdata cmdb
</pre></div>


<p>详解：</p>
<ol>
<li>
<p>安装配置平台</p>
<ul>
<li>
<p>安装依赖，从 <code>dependences.env</code> 里读取到 CMDB 依赖 Nginx。需要先 Yum 安装 nginx。</p>
</li>
<li>
<p>rsync 将 <code>src/cmdb</code>  拷贝到 <code>bkcec/</code> 下。</p>
</li>
<li>
<p>创建一个名为 CMDB 的虚拟环境，给 <code>Supervisord</code> 使用。</p>
</li>
<li>
<p>渲染 CMDB 模板文件。</p>
</li>
<li>
<p>软连接 <code>bkcec/etc/nginx.conf</code> 到 <code>/etc/nginx/nginx.conf</code> 覆盖 Nginx 默认的配置。</p>
</li>
<li>
<p>将 <code>globals.env</code> 里配置的 <code>CMDB_FQDN</code> 域名写入 <code>/etc/hosts</code>。</p>
</li>
</ul>
</li>
<li>
<p>启动配置平台</p>
<ul>
<li>
<p>需要等待 ZK 服务可用，通过 <code>dig +short zk.service.consul</code> 是否解析成功来判断。</p>
</li>
<li>
<p>启动 Nginx ，如果 Nginx 进程已经启动，则执行 <code>reload</code>。</p>
</li>
<li>
<p><code>workon cmdb; supervisord -c $INSTALL_PATH/etc/supervisor-cmdb-server.conf</code> 启动 CMDB 后台进程。</p>
</li>
<li>
<p>启动 CMDB 后，cmdb_adminserver 会将所有进程的配置文件写入 ZK 节点内，其他进程启动时从 ZK 读取配置。</p>
</li>
</ul>
</li>
<li>
<p>初始化配置平台</p>
<ul>
<li>
<p>初始化 CMDB 前需要保证所有 CMDB 后台进程的端口均可用。如果不可用说明启动 CMDB 虽然进程 <code>RUNNING</code> ，但是端口未监听，此时可以尝试重启 CMDB 。</p>
</li>
<li>
<p>调用 cmdb_adminserver 的 http 接口（/migrate/v3/migrate/community/0），来初始化 CMDB 。</p>
</li>
</ul>
</li>
</ol>
<h2 id="_2">安装管控平台</h2>
<p>配置平台的快照数据，依赖蓝鲸组件 <code>GSE</code> 后台：</p>
<div class="codehilite"><pre><span></span>./bkcec install gse
./bkcec initdata gse
./bkcec start gse
</pre></div>


<p>详解：</p>
<ol>
<li>
<p>安装 GSE</p>
<ul>
<li>
<p>拷贝 GSE 后台， cert 目录 到 <code>$INSTALL_PATH/</code> 下。</p>
</li>
<li>
<p>根据 <code>globals.env</code> 里是否自动获取外网 IP 配置，来设定 GSE 需要监听的 IP 地址。</p>
</li>
<li>
<p>渲染配置模板。</p>
</li>
<li>
<p>将 Agent ， Proxy ，和证书打包，并传到 Nginx 的 <code>miniweb</code> 下，供安装 Agent 时使用。</p>
</li>
</ul>
</li>
<li>
<p>初始化 GSE 的 ZK 默认配置。</p>
</li>
<li>启动 GSE 后台进程。</li>
</ol><h1 id="job">安装 JOB 作业平台</h1>
<p>JOB 是蓝鲸的作业平台，它依赖管控平台的 GSE 和每台服务器上安装 GSE_Agent 才能工作。另外它也需要从配置平台读取业务权限和主机 IP 列表，所以要在安装 <code>CMDB</code> 成功后，再安装 JOB</p>
<p><img alt="JOB依赖简图" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/job_depends.png" /></p>
<p>JOB 依赖的开源组件 <code>MySQL</code> 、 <code>Redis</code> 、 <code>RabbitMQ</code> 、 <code>Nginx</code> ，其中只有 <code>RabbitMQ</code> 还未安装。</p>
<h2 id="rabbitmq">安装 RabbitMQ</h2>
<p>RabbitMQ 除了 JOB 使用，在蓝鲸社区版中，用到了 Celery 组件的 SaaS 和后台也依赖，SaaS 上下架所用到的 Paas_Agent 组件依赖 RabbitMQ 的 management 插件功能。这个功能在 rabbitmq 3.0 以上才支持，所以 通过 YUM 安装 RabbitMQ 时确保版本在 3.0 以上。</p>
<div class="codehilite"><pre><span></span>./bkcec install rabbitmq
./bkcec initdata rabbitmq
</pre></div>


<p>详解：</p>
<ol>
<li>
<p>安装 RabbitMQ-Server</p>
<ul>
<li>
<p><code>yum install rabbitmq-server</code> 安装 RabbitMQ 前需要安装 Erlang，如果配置好 Yum 源，可以自动安装依赖。</p>
</li>
<li>
<p>安装 RabbitMQ 后，系统会自动创建 RabbitMQ 用户，蓝鲸社区版里会将 RabbitMQ 默认的目录配置到 $INSTALL_PATH 下，所以需要创建这些目录，并授权：</p>
</li>
</ul>
<p><code>bash
install -d -o rabbitmq -g rabbitmq $INSTALL_PATH/etc/rabbitmq
install -d -o rabbitmq -g rabbitmq $INSTALL_PATH/public/rabbitmq
install -d -o rabbitmq -g rabbitmq $INSTALL_PATH/public/rabbitmq/mnesia
install -d -o rabbitmq -g rabbitmq $INSTALL_PATH/logs/rabbitmq</code></p>
<ul>
<li>生成 RabbitMQ 的配置</li>
</ul>
<p><code>bash
render_cfg_templates service "*#rabbitmq#*"
echo '[rabbitmq_management，rabbitmq_management_agent].' &gt;$INSTALL_PATH/etc/rabbitmq/enabled_plugins</code></p>
</li>
<li>
<p>启动 RabbitMQ</p>
</li>
</ol>
<p><code>bash
  systemdctl start rabbitmq-server</code></p>
<ol>
<li>初始化 RabbitMQ，会添加账户，vhost，设置权限，具体内容，请参考 <code>initdata_rabbitmq</code> 函数</li>
</ol>
<h2 id="_1">安装作业平台</h2>
<p>开始安装作业平台</p>
<div class="codehilite"><pre><span></span>./bkcec install job
./bkcec initdata job
./bkcec start job
</pre></div>


<p>详解：</p>
<ol>
<li>
<p>安装作业平台（install_job 函数）</p>
<ul>
<li>
<p>安装 Java 依赖。</p>
</li>
<li>
<p>拷贝 JOB 工程代码。</p>
</li>
<li>
<p>添加 hosts。</p>
</li>
<li>
<p>渲染配置模板。</p>
</li>
<li>
<p>转换 JOB 和 GSE 通信用的公钥和密钥格式（gen_job_cert）。</p>
</li>
</ul>
</li>
<li>
<p>启动作业平台</p>
</li>
</ol>
<p><code>bash
  $INSTALL_PATH/job/job/bin/job.sh start</code></p>
<ol>
<li>初始化作业平台，导入 SQL 文件</li>
</ol>
<h2 id="gse_agent">安装 gse_agent</h2>
<p>在蓝鲸后台自身所在主机（install.config 中配置的 IP ），安装上 GSE_Agent。</p>
<div class="codehilite"><pre><span></span>./bkcec install gse_agent
</pre></div><h1 id="saas">安装 SaaS</h1>
<p>SaaS 部署环境分为测试环境 (APPT) 和正式环境 (APPO)，<strong>注意测试环境与正式环境不能安装在同一台主机中</strong>。对应的后台模块叫 <code>PaaS_Agent</code> ，正式环境和测试环境的区分主要是启动时环境变量的差异。</p>
<p><img alt="Paas-Agent依赖简图" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/paas_agent_depends.png" /></p>
<p>PaaS_Agent 使用 Python 的 <code>virtualenv</code> 工具来隔离不同的 SaaS 环境。有一些 SaaS 需要使用 <code>Celery</code> 框架，故依赖 <code>RabbitMQ</code> 。这些依赖前述步骤已经安装完成。</p>
<p>集成安装这个模块的命令在快速部署文档里提到： <code>./bk_install app_mgr</code> 。</p>
<h2 id="rabbitmq">激活 RabbitMQ</h2>
<p>由于 RabbitMQ 的安装和初始化在前面步骤已经完成，此时会跳过这两步，到激活 RabbitMQ ：</p>
<div class="codehilite"><pre><span></span>./bkcec activate rabbitmq
</pre></div>


<p>激活 RabbitMQ 是调用 PaaS 的接口，传递 RabbitMQ 的用户名和密码，供 PaaS 验证 RabbitMQ 的部署是否成功。
验证成功后，PaaS 会把这个 RabbitMQ 示例标记为激活可用状态，才能继续后面的 SaaS 安装部署操作。</p>
<h2 id="appo">安装 APPO 环境</h2>
<p><code>bash
./bkcec install appo
./bkcec initdata appo
./bkcec start appo
./bkcec activate appo</code></p>
<p>详解：</p>
<ol>
<li>
<p>安装 APPO  (install_PaaS_Agent 函数)</p>
<ul>
<li>
<p>创建 APPS 用户，该用户用来启停 SaaS 的后台 Python 工程。</p>
</li>
<li>
<p>拷贝 PaaS_Agent 二进制和证书目录。</p>
</li>
<li>
<p>安装专属 Python 解释器。</p>
</li>
<li>
<p>使用专属 Python 创建 PaaS_Agent 的 <code>virtualenv</code> 。</p>
</li>
<li>
<p>创建 <code>$INSTALL_PATH/.appenvs</code> 目录作为 <code>WORKON_HOME</code> 。</p>
</li>
<li>
<p>安装 PaaS_Agent 部署 SaaS 时的 Python 包依赖。</p>
</li>
<li>
<p>安装 Nginx 做 SaaS 的反向代理。</p>
</li>
<li>
<p>渲染 PaaS_Agent 模板，生成配置。</p>
</li>
<li>
<p>添加 <code>/etc/hosts</code> 记录。</p>
</li>
</ul>
</li>
<li>
<p>初始化 APPO (initdata_PaaS_Agent)</p>
<ul>
<li>
<p>初始化 PaaS_Agent MySQL 数据库</p>
</li>
<li>
<p>注册 PaaS_Agent 到 PaaS 平台，成功后获取到 <code>sid</code> 和 <code>Token</code></p>
</li>
<li>
<p>根据 <code>sid</code> 和 <code>Token</code> ，修改 PaaS_Agent 的配置文件。</p>
</li>
</ul>
</li>
<li>
<p>启动 PaaS_Agent。</p>
</li>
<li>
<p>激活 PaaS_Agent 。启用这个已经注册的 PaaS_Agent 主机。在做 SaaS 上下架时，只会操作激活过的 PaaS_Agent 服务器。</p>
</li>
</ol>
<h2 id="appt">安装 APPT 环境</h2>
<p><code>bash
./bkcec install appt
./bkcec initdata appt
./bkcec start appt
./bkcec activate appt</code></p><h1 id="bkdata">安装 BKDATA</h1>
<p>BKDATA（蓝鲸数据平台基础服务）包含三个子工程</p>
<ul>
<li>dataapi</li>
<li>databus</li>
<li>monitor</li>
</ul>
<p><img alt="Bkdata依赖简图" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/bkdata_depends.png" /></p>
<p>新增的依赖有 <code>Kafka</code> 、 <code>ES</code> 、 <code>Beanstalk</code> 、 <code>InfluxDB</code> 。其中 Kafka 用来做数据流处理； ES(Elasticsearch) 用来存储日志文本数据； Beanstalk 是监控后台依赖的队列服务， InfluxDB 是存储信息的时序数据库。</p>
<h2 id="_1">安装依赖</h2>
<h3 id="elasticasearch">安装 Elasticasearch</h3>
<div class="codehilite"><pre><span></span>./bkcec install es
./bkcec start es
</pre></div>


<p>详解：</p>
<ol>
<li>
<p>安装 ES (install_es)</p>
<ul>
<li>
<p>安装 Java。</p>
</li>
<li>
<p>同步 ES 目录到 <code>$INSTALL_PATH/service/</code> 下。</p>
</li>
<li>
<p>渲染配置模板。</p>
</li>
<li>
<p>添加 ES 系统用户来运行 Elasticsearch。</p>
</li>
<li>
<p>修改内核参数和 <code>open files</code> 值。</p>
</li>
<li>
<p>设置目录权限，让 ES 用户可以读写。</p>
</li>
</ul>
</li>
<li>
<p>启动 ES</p>
</li>
</ol>
<h3 id="kafka">安装 Kafka</h3>
<div class="codehilite"><pre><span></span>./bkcec install kafka
./bkcec start kafka
</pre></div>


<p>详解：</p>
<ol>
<li>
<p>安装 Kafka (install_kafka)</p>
<ul>
<li>
<p>安装 Java。</p>
</li>
<li>
<p>同步 Kafka 目录到 <code>$INSTALL_PATH/service/</code> 下。</p>
</li>
<li>
<p>渲染配置模板。</p>
</li>
<li>
<p>修改 <code>/etc/hosts</code> 配置上主机名。</p>
</li>
</ul>
</li>
<li>
<p>启动 Kafka</p>
</li>
</ol>
<h3 id="beanstalk">安装 Beanstalk</h3>
<div class="codehilite"><pre><span></span>./bkcec install beanstalk
./bkcec start beanstalk
</pre></div>


<p>详解：</p>
<ol>
<li>安装 Beanstalkd(install_beanstalk) ，使用 Yum 安装。</li>
<li>启动 Beanstalk。</li>
</ol>
<h3 id="influxdb">安装 InfluxDB</h3>
<div class="codehilite"><pre><span></span>./bkcec install influxdb
./bkcec start influxdb
</pre></div>


<p>详解：</p>
<ol>
<li>
<p>安装 InfluxDB (install_influxdb)</p>
<ul>
<li>
<p>从 <code>$PKG_SRC_PATH/service/influxdb-*.rpm</code> 安装。</p>
</li>
<li>
<p>渲染配置模板，并做软链接。</p>
</li>
<li>
<p>修改目录权限让 InfluxDB 用户可以读写。</p>
</li>
</ul>
</li>
<li>
<p>启动 InfluxDB</p>
</li>
</ol>
<h3 id="bkdata_1">安装 BKDATA</h3>
<div class="codehilite"><pre><span></span>./bkcec install bkdata
./bkcec initdata bkdata
./bkcec start bkdata
</pre></div>


<p>详解：</p>
<ol>
<li>
<p>安装 BKDATA (install_bkdata)</p>
<ul>
<li>
<p>安装 <code>dependents.env</code> 里定义依赖的 Yum 包。</p>
</li>
<li>
<p>尝试修复可能引起安装 MySQL-python pip 包的 lib 库问题 (fixlocation_libmysqlclient_r 函数)。</p>
</li>
<li>
<p>同步代码工程目录，同步 cert 目录。</p>
</li>
<li>
<p>因为 databus 是 Java 工程，安装 Java。</p>
</li>
<li>
<p>安装 Python 虚拟环境（init_virtualenv 函数）。</p>
</li>
<li>
<p>安装 Python 工程的 requirments.txt 定义的 pip 包。</p>
</li>
<li>
<p>渲染配置模板。</p>
</li>
</ul>
</li>
<li>
<p>初始化 BKDATA (initdata_bkdata)</p>
<ul>
<li>
<p>初始化 MySQL 数据库表结构。</p>
</li>
<li>
<p>dataapi 工程 migrate trt 初始化。</p>
</li>
<li>
<p>初始化 Kafka 的 topic 数据。</p>
</li>
</ul>
</li>
<li>
<p>启动 BKDATA</p>
<ul>
<li>
<p>启动 BKDATA。</p>
</li>
<li>
<p>如果是第一次启动 BKDATA ，那么运行 init_bkdata_snapshot 函数，因为这个初始化需要 dataapi 启动后才能运行。运行成功后，设置一个标记文件，$INSTALL_PATH/.init_bkdata_snapshot。防止重复执行。</p>
</li>
</ul>
</li>
</ol>
<h3 id="fta">安装 FTA</h3>
<p>FTA 是蓝鲸故障自愈的后台进程</p>
<div class="codehilite"><pre><span></span>./bkcec install fta
./bkcec initdata fta
./bkcec start fta
</pre></div>


<p>详解：</p>
<ol>
<li>
<p>安装 FTA  (install_fta)</p>
<ul>
<li>
<p>安装 dependents.env 里定义依赖的 Yum 包。</p>
</li>
<li>
<p>同步代码工程目录，同步 cert 目录。</p>
</li>
<li>
<p>安装 Python 虚拟环境（init_virtualenv 函数）。</p>
</li>
<li>
<p>安装 Python 工程的 requirments.txt 定义的 pip 包。</p>
</li>
<li>
<p>渲染配置模板。</p>
</li>
</ul>
</li>
<li>
<p>初始化 FTA (initdata fta)</p>
<ul>
<li>初始化 MySQL 的库表结构。</li>
</ul>
</li>
<li>
<p>启动 FTA</p>
</li>
</ol><h1 id="_1">机器评估</h1>
<p>测试用途，只支持 Centos7.5+ 的系统版本</p>
<table>
<thead>
<tr>
<th align="left">分布名称</th>
<th>服务简介</th>
<th>机器数量</th>
<th>配置要求</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">bcs-web</td>
<td>bcs 配置，监控，导航，thanos，Harbor 等服务</td>
<td>2-3 台</td>
<td>8C16G1T</td>
</tr>
<tr>
<td align="left">bcs-server</td>
<td>bcs 后台服务，etcd，mongodb，zk 等服务</td>
<td>3-5 台(奇数)</td>
<td>8C16G300G</td>
</tr>
<tr>
<td align="left">K8S 集群</td>
<td>业务集群，可以将业务进程运行在该 K8S 集群中</td>
<td>3+N</td>
<td>4C8G300G</td>
</tr>
<tr>
<td align="left">Mesos 集群</td>
<td>业务集群，可以将业务进程运行在该 mesos 集群中</td>
<td>3+N</td>
<td>4C8G300G</td>
</tr>
</tbody>
</table>
<blockquote>
<p>生产环境，建议根据实际情况增加主机数量。</p>
</blockquote><h1 id="_1">环境准备</h1>
<h2 id="_2">下载容器平台安装包</h2>
<ul>
<li><a href="https://bk.tencent.com/download_sdk/">从官网下载容器平台安装包</a></li>
</ul>
<div class="codehilite"><pre><span></span>tar xf bkce_bcs-x.x.x.tgz  <span class="c1"># 跟 src 保持同级目录</span>
</pre></div>


<h2 id="installconfig">修改 install.config 配置</h2>
<p>使用 sample 文件 ( <strong>install.config.new.sample</strong> )，将下面的 bcs 相关配置追加到原 install.config 里面。</p>
<blockquote>
<p><strong>注意：</strong> 部署 <code>BCS 蓝鲸平台机器不能与业务机器（k8s，mesos）混用</code></p>
</blockquote>
<p><strong>如下示例：</strong></p>
<div class="codehilite"><pre><span></span><span class="o">[</span>bcs-web<span class="o">]</span>
<span class="m">10</span>.0.0.4    bcs<span class="o">(</span>web_console<span class="o">)</span>,bcs<span class="o">(</span>cc<span class="o">)</span>,bcs<span class="o">(</span>monitor<span class="o">)</span>,mysql01<span class="o">(</span>bcs<span class="o">)</span>,thanos<span class="o">(</span>query<span class="o">)</span>,devops<span class="o">(</span>navigator<span class="o">)</span>
<span class="m">10</span>.0.0.5    bcs<span class="o">(</span>grafana<span class="o">)</span>,devops<span class="o">(</span>pm<span class="o">)</span>,harbor<span class="o">(</span>api<span class="o">)</span>,harbor<span class="o">(</span>server<span class="o">)</span>,thanos<span class="o">(</span>rule<span class="o">)</span>

<span class="o">[</span>bcs-server<span class="o">]</span>
<span class="m">10</span>.0.0.6    zk01<span class="o">(</span>bcs<span class="o">)</span>,etcd<span class="o">(</span>bcs<span class="o">)</span>,mongodb01<span class="o">(</span>bcs<span class="o">)</span>,bcs<span class="o">(</span>api<span class="o">)</span>,bcs<span class="o">(</span>storage<span class="o">)</span>,bcs<span class="o">(</span>health-master<span class="o">)</span>,bcs<span class="o">(</span>dns-service<span class="o">)</span>,bcs<span class="o">(</span>health-slave<span class="o">)</span>,bcs<span class="o">(</span>ops<span class="o">)</span>,iam<span class="o">(</span>server<span class="o">)</span>
<span class="m">10</span>.0.0.7    zk01<span class="o">(</span>bcs<span class="o">)</span>,etcd<span class="o">(</span>bcs<span class="o">)</span>,mongodb01<span class="o">(</span>bcs<span class="o">)</span>,bcs<span class="o">(</span>api<span class="o">)</span>,bcs<span class="o">(</span>storage<span class="o">)</span>,bcs<span class="o">(</span>health-master<span class="o">)</span>,bcs<span class="o">(</span>dns-service<span class="o">)</span>,bcs<span class="o">(</span>health-slave<span class="o">)</span>,bcs<span class="o">(</span>ops<span class="o">)</span>
<span class="m">10</span>.0.0.8    zk01<span class="o">(</span>bcs<span class="o">)</span>,etcd<span class="o">(</span>bcs<span class="o">)</span>,mongodb01<span class="o">(</span>bcs<span class="o">)</span>,bcs<span class="o">(</span>api<span class="o">)</span>,bcs<span class="o">(</span>storage<span class="o">)</span>,bcs<span class="o">(</span>health-master<span class="o">)</span>,bcs<span class="o">(</span>dns-service<span class="o">)</span>,bcs<span class="o">(</span>health-slave<span class="o">)</span>,bcs<span class="o">(</span>ops<span class="o">)</span>
</pre></div>


<blockquote>
<p>Note:
1. zk(config)，zk01(bcs) 属于两个不同的集群实例，用 01，02 等数字区域，生成的环境变量则统一通过标签区分。
2. devops(navigator) 和 harbor(server) 不能配置到相同的主机上。
3. bcs-server 部分的 etcd， zk，mongodb 都需要加上 bcs 标签识别。写法为：服务名(标识名)，如：etcd(bcs)。
4. 检查 globals.env 内的 redis 密码是否含有特殊字符，如果有需要去掉特殊字符，详情参考 <a href="5.1/常见问题/组件/redis.md">Redis 密码修改</a>
5. harbor，devops 不能与 nginx 相关部署在同一台。</p>
</blockquote>
<h2 id="installbcsportsenv">修改 install/bcs/ports.env 配置</h2>
<div class="codehilite"><pre><span></span><span class="nb">export</span> <span class="nv">BCS_MONITOR_IFACE</span><span class="o">=</span><span class="s2">&quot;eth0&quot;</span>
</pre></div>


<blockquote>
<p>Note:</p>
<ol>
<li>登陆 install.config 中的 bcs(monitor) 模块所在的机器，查看该机器实际网卡名称并替换 BCS_MONITOR_IFACE 该变量的值。</li>
</ol>
</blockquote>
<h2 id="installbcsglobalsenv">修改 install/bcs/globals.env 配置</h2>
<div class="codehilite"><pre><span></span><span class="c1"># 根据业务需求设置访问域名</span>

<span class="nb">export</span> <span class="nv">HARBOR_SERVER_FQDN</span><span class="o">=</span>hub.<span class="nv">$BK_DOMAIN</span>
<span class="nb">export</span> <span class="nv">DEVOPS_NAVIGATOR_FQDN</span><span class="o">=</span>devops.<span class="nv">$BK_DOMAIN</span>
</pre></div>


<h2 id="_3">配置免密</h2>
<div class="codehilite"><pre><span></span>bash  install/configure_ssh_without_pass  <span class="c1"># 新增机器配置免密</span>
</pre></div>


<h2 id="hosts">配置本地 hosts</h2>
<div class="codehilite"><pre><span></span>devops.&lt;BK_DOMAIN&gt;    devops<span class="o">(</span>navigotr<span class="o">)</span>所在IP
api-&lt;DEVOPS_NAVIGATOR_FQDN&gt;    devops<span class="o">(</span>navigotr<span class="o">)</span>所在IP
hub.&lt;BK_DOMAIN&gt;       harbor<span class="o">(</span>server<span class="o">)</span>所在IP
</pre></div><h1 id="_1">安装部署</h1>
<blockquote>
<p>首先保证基础平台安装完成后，在安装容器管理平台</p>
</blockquote>
<p><strong>安装社区版</strong></p>
<ul>
<li>
<p>安装社区版 5.1， 并部署好标准运维等 SaaS</p>
<blockquote>
<ol>
<li>安全前注意调整 globals.env 中的各类密码，不能带有特殊字符。详情查看 <a href="../../基础包安装/环境准备/get_ready.md#globals">环境准备-globals.env</a>。</li>
<li>nginx 需要 1.10 + 以上。</li>
<li>openssl 需要 1.0.2 以上版本。</li>
</ol>
</blockquote>
</li>
<li>
<p>安装步骤略
    &gt; Note: 若安装时选择了 https 模式，并且证书是自签名的(默认自带方式安装的证书)，需要在浏览器中将证书添加到可信任列表中。</p>
</li>
</ul>
<p><strong>安装后台</strong></p>
<p>准备 YUM 源。在部署 bcs 的第一个步骤中，需要初始化中控机的 docker 环境。脚本会自动添加 docker 官方 YUM 源来安装 docker-ce 所以需要保证服务器到外网的连通性，保证以下命令可用：</p>
<div class="codehilite"><pre><span></span>yum install -y yum-utils device-mapper-persistent-data lvm2
yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
yum -y install docker-ce
</pre></div>


<ul>
<li>使用集成安装方式：</li>
</ul>
<div class="codehilite"><pre><span></span>  ./bk_install bcs

  步骤说明：
  <span class="m">1</span>. 该步骤首先初始化容器环境，添加 docker yum 源并安装启动 docker。

  <span class="m">2</span>. 若社区版是运行了一段时间后，新加入一批主机到 install.config 中用于部署 bcs，则接下来需要为新的机器上做免密登陆，安装 consul，同步基础开源组件包等步骤。

  <span class="m">3</span>. 同步所有依赖额服务包。

  <span class="m">4</span>. 安装 MySQL，ZK，etcd，MongoDB 等。

  <span class="m">5</span>. 安装 iam。

  <span class="m">6</span>. 安装 Harbor，导入镜像。

  <span class="m">7</span>. 安装并初始化 bcs，devops，thanos 等服务。

  <span class="m">8</span>. 启动各服务进程。

  <span class="m">9</span>. 安装 SaaS。
</pre></div>


<blockquote>
<p>在启动 etcd 的步骤，可能卡住，出现这种情况时，按一次 <code>CTRL+C</code>。跳过</p>
</blockquote>
<ul>
<li>打开 PaaS，点击容器管理平台，开始使用容器管理平台，请参考 <a href="5.1/bcs/Introduction/README.md">容器管理平台白皮书</a></li>
</ul><h1 id="saas">SaaS 通用部署</h1>
<h2 id="saas_1">SaaS 说明</h2>
<p>SaaS（Software as a Service）：软件即服务，是当前非常流行的一种软件交付模式，蓝鲸官方基于蓝鲸体系自研设计出底层通用的 PaaS，在此基础上可以开发成不同类型的 SaaS。</p>
<h2 id="saas_2">蓝鲸官方 SaaS</h2>
<p>蓝鲸官方提供了多款 SaaS ，其特性是开箱即用，满足自动化运维体系最基础、最通用的 CI/CD 需求。</p>
<table>
<thead>
<tr>
<th>SaaS</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>节点管理</td>
<td>一款用于在浏览器管理受控机后台服务的产品，是蓝鲸自动化运维体系的基础</td>
</tr>
<tr>
<td>蓝鲸监控</td>
<td>蓝鲸智云推出的一款针对主机/容器和互联网应用进行监控的产品</td>
</tr>
<tr>
<td>故障自愈</td>
<td>故障自愈是蓝鲸智云推出的行业领先的"故障自动化处理"解决方案，提升企业的服务可用性和降低故障处理的人力投入，实现故障自愈从 "人工处理" 到 "无人值守" 的变革</td>
</tr>
<tr>
<td>标准运维</td>
<td>标准运维是拥有可视化的图形界面，并进行任务流程编排和执行的系统</td>
</tr>
<tr>
<td>日志检索</td>
<td>日志检索是蓝鲸智云为了解决运维场景中查询日志难的问题而推出的一款产品</td>
</tr>
<tr>
<td>ITSM</td>
<td>ITSM（IT 服务管理）是一套帮助企业对 IT 系统的规划、研发、实施和运营进行有效管理的方法论</td>
</tr>
</tbody>
</table>
<blockquote>
<p>注：蓝鲸官方 SaaS 默认包含在官网下载的 src 包，解压到 /data 目录（路径：/data/src/official_saas/）中，可在安装蓝鲸基础包的过程中一键安装 <strong>当前社区版对应的</strong> 蓝鲸官方 SaaS，请参考 <a href="../../基础包安装/多机部署/quick_install.md">标准部署</a>。</p>
</blockquote>
<h2 id="_1">合作商软件包</h2>
<p>合作商软件包，是由蓝鲸与合作伙伴提供的运维场景解决方案类的 SaaS 产品，如 Wman、OSKit、网络管理、CICDKit 等，该类型 SaaS 可在已有基础包的前提下，以“插件”的方式，面向用户提供更多个性化的场景解决方案。</p>
<table>
<thead>
<tr>
<th>SaaS</th>
<th>开发合作伙伴</th>
<th>技术支持群（QQ）</th>
</tr>
</thead>
<tbody>
<tr>
<td>网络管理平台</td>
<td>可源信息科技</td>
<td>702497771</td>
</tr>
<tr>
<td>CICDKit</td>
<td>嘉为科技</td>
<td>972825279</td>
</tr>
</tbody>
</table>
<blockquote>
<p>注：网络管理平台以及 CICDKIt 前往 <a href="https://bk.tencent.com/download_sdk/">官网下载页</a> 下载。</p>
</blockquote>
<h2 id="saas_3">更多 SaaS</h2>
<p>蓝鲸授权服务商、蓝鲸社区用户根据企业需求 "定制化" 开发的 SaaS 应用，经过蓝鲸官方审核后会上线 S-mart 市场。</p>
<ul>
<li>
<p>到 <a href="https://bk.tencent.com/s-mart/market?best_type=1">官方 S-mart 市场</a> 选择下载：蓝鲸智云搭建的企业级应用生态市场。</p>
</li>
<li>
<p>蓝鲸用户自主开发：基于蓝鲸开发框架，用户可低成本自主开发 SaaS 满足企业需求，蓝鲸应用开发可参考文档中心的 <a href="5.1/开发指南/开发简介/README.md">开发指南</a>。</p>
</li>
</ul>
<h2 id="saas_4">SaaS 安装</h2>
<p>SaaS 安装说明：</p>
<ul>
<li>
<p>官方 SaaS：官方 SaaS 可以在基础包标准安装过程中部署，也可以通过通用方式部署。</p>
</li>
<li>
<p>合作商软件包：社区版目前对外开放 <a href="../../合作方软件包安装/网络管理/net_man.md">网络管理平台</a> 及 <a href="../../合作方软件包安装/CICDKit/CICDKit.md">CICDKit</a>。</p>
</li>
</ul>
<h2 id="saas_5">SaaS 通用部署方式</h2>
<blockquote>
<p><strong>注意：</strong> SaaS 安装部署成功后，必须给 <a href="5.1/PaaS平台/场景案例/White.md">SaaS 开组件 "免用户认证"的白名单</a>。</p>
</blockquote>
<p>【蓝鲸工作台】 - 【开发者中心】 - 【S-mart 应用】。</p>
<p><img alt="配图3" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/3.png" /></p>
<p>在S-mart应用，点击【上传 SaaS 包】。</p>
<p><img alt="配图1" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/1.png" /></p>
<p>将 SaaS 包上传之后，进行【一键部署】。</p>
<p><img alt="配图2" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/2.png" /></p>
<p>部署成功后，在蓝鲸工作台/桌面即可看到 SaaS，打开运行正常说明部署成功。</p>
<p><img alt="配图4" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/4.png" /></p>
<p><img alt="配图5" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/5.png" /></p>
<ul>
<li>外链应用或通过域名访问的 SaaS ：    </li>
</ul>
<p>通过浏览器登录社区版页面，在域名后添加  <code>admin</code>  进入 后台管理页面。</p>
<p><img alt="配图6" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/6.png" /></p>
<p><strong>Home - 常用链接 - 增加常用链接</strong>，  <code>名称</code> 填入对应 SaaS 名称， <code>链接</code> 填入对应域名，<code>类型</code> 选择 <code>SaaS链接</code> ，上传对应 Logo 后保存，即可在蓝鲸工作台中访问该 SaaS。</p>
<p><img alt="配图8" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/8.png" /></p>
<p><img alt="配图7" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/7.png" /></p>
<blockquote>
<p>用户自主开发的应用，蓝鲸暂不支持托管其后台服务蓝鲸官方 SaaS 需求的后台服务，已经集成在基础包安装文档中，无需单独额外安装蓝鲸官方 SaaS 一键部署参考 <a href="./saasdeploy.md#saas">官方 SaaS 说明</a>。合作商软件包请参考文档中的合作商软件包安装指引。</p>
</blockquote>
<h2 id="saas_6">SaaS 升级</h2>
<ol>
<li>
<p>获取到最新版本的 SaaS 包后，按照 SaaS 部署的步骤到 PaaS 平台中部署上线即可。</p>
</li>
<li>
<p>需要后台服务支持的 SaaS 若后台有变更时，请先升级后台服务，再到 PaaS 平台中升级 SaaS，保持前后端版本一致性，否则功能会受影响。</p>
</li>
</ol>
<p>Note：</p>
<blockquote>
<p>前后端版本一致性：对社区版 SaaS 进行升级时，需确认清楚 SaaS 和后台版本是否对应，比如：社区版 V5.0 的蓝鲸监控 SaaS 版本是 1.4.23，后台服务版本是 0.2.7，若升级安装后，实际环境中前后台版本不对应，可能会导致应用使用异常。<strong>因 Bug 修复其他原因进行过官方升级的除外</strong>， <strong>版本详情可参考对应社区版的版本日志或者咨询蓝鲸助手</strong>。</p>
</blockquote><h1 id="_1">标准运维部署</h1>
<h2 id="app">修改旧版标准运维 APP 信息</h2>
<p>如果之前未安装过标准运维(APP_CODE: gcloud)，可以直接跳过第一步，直接进入第二步。</p>
<p>假设你的蓝鲸桌面地址是 {BK_PAAS_HOST}/console/，那么请打开 "蓝鲸智云后台管理" 链接 {BK_PAAS_HOST}/admin/。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/11.png" /></p>
<p>点击 【应用基本信息】 ，找到应用编码为 "gcloud" 的一行数据，点击应用名称 【标准运维】 进入编辑页面。修改应用名称为 "标准运维(旧版)" 后【保存】并退出 admin 页面。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/22.png" /></p>
<h2 id="esb">开通 ESB 白名单</h2>
<p>如果是全新版本部署蓝鲸，可以跳过这一步，直接进入第三步。
如果升级安装的蓝鲸，需要手动在中控机执行如下命令，开通标准运维访问 ESB 的白名单，以便标准运维原子可以正常调用 ESB 接口。</p>
<div class="codehilite"><pre><span></span><span class="nb">source</span> /data/install/utils.fc
add_app_token bk_sops <span class="s2">&quot;</span><span class="k">$(</span>_app_token bk_sops<span class="k">)</span><span class="s2">&quot;</span> <span class="s2">&quot;标准运维&quot;</span>
</pre></div>


<h2 id="redis">准备 Redis 资源</h2>
<p>联系部署同事在当前蓝鲸的运行环境找一台机器，新建一个 redis 服务账号和密码。也可以公用部署了蓝鲸已经部署的 redis 服务，需要注意多个应用公用一个 redis 服务可能存在 KEY 值冲突，并且无法保障标准运维服务的独立和可靠。</p>
<h2 id="app_1">上传部署标准运维 APP</h2>
<p>在开发者中心上传并部署新版的标准运维 APP。</p>
<h2 id="_2">修改标准运维环境变量配置</h2>
<p>打开蓝鲸桌面 {BK_PAAS_HOST}/console/，在应用市场找到名字为 "标准运维" (APP_CODE: bk_sops) 的应用，添加到桌面并打开。</p>
<p>如果是企业版，请右键单击【业务首页】，选择在 "新标签页打开连接"。</p>
<p>修改浏览器链接为 {BK_PAAS_HOST}/o/bk_sops/admin/，打开标准运维管理后台页面。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/33.png" /></p>
<p>找到【环境变量 EnvironmentVariables】并单击进入编辑页面。将第二步中准备的 redis 信息填写到环境变量配置中。即增加 3 条数据 <code>BKAPP_REDIS_HOST、BKAPP_REDIS_PORT、BKAPP_REDIS_PASSWORD</code>。</p>
<p>如果直接复用蓝鲸已经部署好的 redis 服务，环境变量可以分别配置为：
- BKAPP_REDIS_HOST=在中控机执行 source /data/install/utils.fc &amp;&amp; echo $REDIS_IP 获取</p>
<ul>
<li>
<p>BKAPP_REDIS_PASSWORD=在中控机执行 source /data/install/utils.fc &amp;&amp; echo $REDIS_PASS 获取</p>
</li>
<li>
<p>BKAPP_REDIS_PORT=6379</p>
</li>
</ul>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/44.png" /></p>
<h2 id="app_2">重新部署标准运维 APP</h2>
<p>由于环境变量只有在项目启动时才会加载，所以修改后必须重新部署才会生效，请进入开发者中心，找到 "标准运维"，点击重新部署。</p><h2 id="_1">网络管理平台</h2>
<h3 id="_2">环境准备</h3>
<ol>
<li>下载 <a href="http://bk.tencent.com/download/">网络管理平台</a> :</li>
<li>
<p>解压后目录结构如下：
    <code>bash
    bknetwork
    |-- bknetwork-3.6.1.tgz
    |-- install
    |   |-- bkco_install
    |   `-- third
    |       |-- control_bknetwork.rc
    |       |-- deliver_bknetwork.rc
    |       |-- globals_bknetwork.env
    |       |-- initdata_bknetwork.rc
    |       |-- install_bknetwork.rc
    |       |-- ports_bknetwork.env
    |       |-- render_bknetwork.rc
    |       |-- status_bknetwork.rc
    |       `-- upgrade_bknetwork.rc
    `-- MD5</code></p>
</li>
<li>
<p>确认蓝鲸社区版的 PaaS，CMDB，JOB 已经部署完成。如无，请参考 <a href="../../基础包安装/多机部署/quick_install.md">标准部署</a> 进行安装部署。</p>
</li>
<li>
<p>解压插件包</p>
<p>```bash
tar xf bknetwork.tgz -C /data/src/</p>
<h1 id="src-data">假设现 src 目录在 /data/ 下</h1>
<p>tar xf /data/src/bknetwork/bknetwork-3.6.1.tgz  -C  /data/src/</p>
<h1 id="install-data">假设现 install 目录在 /data/ 下</h1>
<p>rsync -a /data/src/bknetwork/install/  /data/install/
```</p>
</li>
<li>
<p>根据实际情况修改中控机 <code>/data/install/third/globals_bknetwork.env</code> 网络管理域名等信息。</p>
</li>
</ol>
<h3 id="_3">安装部署</h3>
<p>```bash
  # 假设现 install 目录在 /data/ 下。
  cd /data/install</p>
<p># 开始安装
  ./bkco_install bknetwork
  ```</p>
<p>配置的域名访问网络管理，将网络管理平台添加到蓝鲸工作台。</p>
<ul>
<li>通过浏览器登录社区版页面，在域名后添加 <code>admin</code> 进入蓝鲸智云后台管理页面。</li>
<li>Home - 常用链接 - 增加常用链接，名称填入网络管理平台，将配置的域名填入链接，类型选择 <code>SaaS 链接</code> ，选择 Logo 后保存，即可在蓝鲸工作台中访问 SaaS 网络管理平台。</li>
</ul><h2 id="cicdkit">CICDKit</h2>
<h3 id="_1">环境准备</h3>
<ol>
<li>
<p>官网下载 <a href="https://bk.tencent.com/download_sdk/">CICDKit 软件包</a> 和  <a href="https://bk.tencent.com/download_sdk/">CICDKit 脚本安装包</a></p>
<blockquote>
<p>注意：部署 CICDKit 属于增值部署，需提前部署好蓝鲸基础社区版环境，脚本需基于 V1.4.13 版本之上部署。</p>
</blockquote>
<p><code>bash
tar -xf bkce_cicdkit-1.0.0.tgz -C /data
tar -xf install_ce-cicdkit_fix-1.0.2.tar -C /data</code></p>
</li>
<li>
<p>安装 CICDKit 的机器可用配置不能低于 4C8G，系统版本不能低于 Centos 7.0，建议单独一台机器部署。</p>
</li>
<li>
<p>修改配置：</p>
<ul>
<li><strong>注意：</strong> 请勿将 MySQL 57 同蓝鲸的 MySQL 部署在同一台机器上。</li>
<li>
<p>中控机 install/third/globals_cicdkit.env 域名信息 (CICDKIT_FQDN)。</p>
</li>
<li>
<p>install.config 新增 cicdkit 及其依赖的 mysql 5.7 的配置。</p>
</li>
</ul>
<p><code>bash
  10.0.0.0 mysql57,cicdkit</code></p>
</li>
</ol>
<h3 id="cicdkit_1">安装 CICDKit 后台</h3>
<p>开始安装</p>
<div class="codehilite"><pre><span></span>./bkcec sync common
./bkco_install cicdkit
</pre></div>


<p>配置每台机器的 hosts，该解析只供 ESB 解析使用，和 cicdkit-saas 嵌套的 sonarqube 使用。</p>
<div class="codehilite"><pre><span></span><span class="nb">source</span> /data/install/utils.fc
<span class="nb">echo</span> <span class="nv">$CICDKIT_FQDN</span>  <span class="c1">#测试是否能获取到正确值,默认为：cicdkit.bk.com</span>
                    <span class="c1">#若不能可多执行一次 source</span>
<span class="k">for</span> ip in <span class="si">${</span><span class="nv">ALL_IP</span><span class="p">[@]</span><span class="si">}</span><span class="p">;</span><span class="k">do</span>
  ssh <span class="nv">$ip</span> <span class="s2">&quot;echo </span><span class="nv">$CICDKIT_IP</span><span class="s2"> </span><span class="nv">$CICDKIT_FQDN</span><span class="s2"> &gt;&gt;/etc/hosts&quot;</span><span class="p">;</span> <span class="k">done</span>
</pre></div>


<p>重启进程</p>
<p><code>bash
./bkcec stop cicdkit self
./bkcec start cicdkit self</code></p>
<ul>
<li>从 S-mart 市场下载 <a href="http://bk.tencent.com/s-mart">CICDKit-SaaS</a> 部署，CICDKit 的持续部署功能依赖 <a href="http://bk.tencent.com/s-mart">标准运维 V3</a> 版本</li>
</ul><h1 id="_1">离线部署</h1>
<h2 id="yum-iso">YUM 源有 ISO 镜像文件时</h2>
<ol>
<li>
<p>下载相关镜像文件。相关镜像下载链接请看文章末尾。</p>
</li>
<li>
<p>Centos7.x.iso</p>
</li>
<li>
<p>挂载到每台机器上：</p>
<p><code>bash
mkdir -p /mnt/centos7 /mnt/centos7-epel
mount -t iso9660 xxxx.iso /mnt/centos7
mount -t iso9660 xxx.iso /mnt/centos7-epel</code>
3. 配置离线 repo。</p>
<ul>
<li>
<p>/etc/yum.repos.d/offline-centos7.repo</p>
<p><code>bash
[offline-centos7]
name=CentOS-$releasever - blueking
baseurl=file:///mnt/centos7
enabled=1
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7</code></p>
</li>
<li>
<p>/etc/yum.repos.d/offline-centos7-epel.repo</p>
<p><code>bash
[offline-centos7-epel]
name=CentOS-$releasever - blueking
baseurl=file:///mnt/centos7-epel
enabled=1
exclude=epel-release
gpgcheck=1
gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-EPEL-7</code></p>
</li>
</ul>
</li>
</ol>
<h2 id="pip">PIP 包准备</h2>
<p>PIP 包蓝鲸自带了离线包，所以无需单独下载。
不过 bkdata 和 fta 自带的包可能会和安装时的操作系统不匹配，导致安装失败。</p>
<p>在有网络环境下，可以用以下方式下载 pip 包：</p>
<div class="codehilite"><pre><span></span>mkdir /data/pip
pip download -d /data/pip -r requirements.txt
</pre></div>


<p>所以这里列举下蓝鲸 Python 工程的 requirements.txt 路径，以及下载离线包后应该存放的路径。</p>
<div class="codehilite"><pre><span></span><span class="c1"># bkdata 所需的 pip 包</span>
src<span class="se">\b</span>kdata<span class="se">\d</span>ataapi<span class="se">\r</span>equirements.txt
src<span class="se">\b</span>kdata<span class="se">\m</span>onitor<span class="se">\r</span>equirements.txt

<span class="c1"># 需要放到以下路径</span>
src<span class="se">\b</span>kdata<span class="se">\s</span>upport-files<span class="se">\p</span>kgs

<span class="c1"># fta 角色所需的 pip 包</span>
src<span class="se">\f</span>ta<span class="se">\f</span>ta<span class="se">\r</span>equirements.txt

<span class="c1"># 需要放到以下路径</span>
src<span class="se">\f</span>ta<span class="se">\s</span>upport-files<span class="se">\p</span>kgs

<span class="c1"># open_paas 角色所需的 pip 包</span>
src<span class="se">\o</span>pen_paas<span class="se">\a</span>ppengine<span class="se">\r</span>equirements.txt
src<span class="se">\o</span>pen_paas<span class="se">\e</span>sb<span class="se">\r</span>equirements.txt
src<span class="se">\o</span>pen_paas<span class="se">\l</span>ogin<span class="se">\r</span>equirements.txt
src<span class="se">\o</span>pen_paas<span class="se">\p</span>aas<span class="se">\r</span>equirements.txt

<span class="c1"># 需要放到以下路径</span>
src<span class="se">\o</span>pen_paas<span class="se">\s</span>upport-files<span class="se">\p</span>kgs

<span class="c1"># paas_agent下的  pip 包其实时给 SaaS 部署用的。</span>
src<span class="se">\p</span>aas_agent<span class="se">\p</span>aas_agent<span class="se">\r</span>equirements.txt

<span class="c1"># 需要放到以下路径</span>
src<span class="se">\p</span>aas_agent<span class="se">\s</span>upport-files<span class="se">\p</span>kgs
</pre></div>


<p>附： 相关镜像下载链接：
  - <a href="http://bkopen-1252002024.file.myqcloud.com/dl/bk_offline_repo-7.2.1511.iso">CentOS7.2.1511_minimal_x86_64</a></p>
<ul>
<li>
<p><a href="http://bkopen-1252002024.file.myqcloud.com/dl/bk_offline_repo-7.3.1611.iso">CentOS7.3.1611_minimal_x86_64</a></p>
</li>
<li>
<p><a href="http://bkopen-1252002024.file.myqcloud.com/dl/bk_offline_repo-7.4.1708.iso">CentOS7.4.1708_minimal_x86_64</a></p>
</li>
<li>
<p><a href="http://bkopen-1252002024.file.myqcloud.com/dl/bk_offline_repo-7.5.1804.iso">CentOS7.5.1804_minimal_x86_64</a></p>
</li>
</ul><h1 id="https">蓝鲸全站 HTTPS 改造方案</h1>
<p><strong>思路</strong></p>
<ol>
<li>
<p><code>open_paas</code> nginx 配置 HTTPS。</p>
</li>
<li>
<p>内部接口     统一走 HTTP。</p>
</li>
<li>
<p>涉及前端跳转  统一走 HTTPS。</p>
</li>
</ol>
<p><strong>运维同学关注 open_paas 部署相关</strong></p>
<h2 id="nginx">Nginx</h2>
<p>申请得到 HTTPS 证书，并配置</p>
<p>以下实例仅供参考(测试环境使用)，具体生产配置请重新确认</p>
<div class="codehilite"><pre><span></span><span class="c1"># http 自动跳转 https</span>
server <span class="o">{</span>
        listen       xxxx:80<span class="p">;</span>
        server_name  paas.bk.com<span class="p">;</span>
        <span class="k">return</span> <span class="m">301</span> https://<span class="nv">$server_name$request_uri</span><span class="p">;</span>
<span class="o">}</span>

server <span class="o">{</span>
    listen       xxxx:443 ssl<span class="p">;</span>
    server_name  paas.bk.com<span class="p">;</span>

    access_log /data/bkce/logs/nginx/openpaas_access.log<span class="p">;</span>
    error_log /data/bkce/logs/nginx/openpaas_error.log<span class="p">;</span>

    client_max_body_size    512m<span class="p">;</span>

    ssl on<span class="p">;</span>
    ssl_certificate     /data/bkce/cert/bk_domain.cert<span class="p">;</span>
    ssl_certificate_key /data/bkce/cert/bk_domain.key<span class="p">;</span>
    ssl_protocols       TLSv1 TLSv1.1 TLSv1.2<span class="p">;</span>
    ssl_ciphers         HIGH:!aNULL:!MD5<span class="p">;</span>

    <span class="c1"># ============================ paas ============================</span>
    <span class="c1"># PAAS_SERVICE HOST/PORT</span>
    location / <span class="o">{</span>
        proxy_pass http://SSL_OPEN_PAAS<span class="p">;</span>
        proxy_pass_header Server<span class="p">;</span>
        proxy_set_header X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
        proxy_set_header X-Real-IP <span class="nv">$remote_addr</span><span class="p">;</span>
        proxy_set_header X-Scheme <span class="nv">$scheme</span><span class="p">;</span>
        proxy_set_header Host <span class="nv">$http_host</span><span class="p">;</span>
        proxy_redirect off<span class="p">;</span>
        proxy_read_timeout <span class="m">600</span><span class="p">;</span>
    <span class="o">}</span>
    .........
<span class="o">}</span>
</pre></div>


<h2 id="open_paas">open_paas 的部署</h2>
<p>open_paas 的项目 paas/esb/login/console/appengine，增加了一个环境变量 <code>PAAS_INNER_DOMAIN</code>。</p>
<div class="codehilite"><pre><span></span><span class="n">PAAS_DOMAIN</span> <span class="o">=</span> <span class="s1">&#39;__PAAS_FQDN__:__PAAS_HTTPS_PORT__&#39;</span>
<span class="n">PAAS_INNER_DOMAIN</span> <span class="o">=</span> <span class="s1">&#39;__PAAS_HOST__:__PAAS_HTTP_PORT__&#39;</span>
</pre></div>


<p>需要确保</p>
<ol>
<li>
<p><code>PAAS_DOMAIN</code> 是外网地址，即到 <code>nginx</code> 的地址。</p>
</li>
<li>
<p><code>PAAS_INNER_DOMAIN</code> 是内网地址，即到 <code>consul</code> 的地址。</p>
</li>
</ol>
<p>此时，给到 <code>saas</code> 的环境变量都是<code>https</code>。</p>
<div class="codehilite"><pre><span></span><span class="n">BK_PAAS_HOST</span> <span class="o">=</span> <span class="s2">&quot;https://</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">PAAS_DOMAIN</span>
<span class="n">BK_CC_HOST</span> <span class="o">=</span> <span class="s2">&quot;https://</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">HOST_CC</span>
<span class="n">BK_JOB_HOST</span> <span class="o">=</span> <span class="s1">&#39;https://</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">HOST_JOB</span>

<span class="n">BK_PAAS_INNER_HOST</span> <span class="o">=</span> <span class="s2">&quot;http://</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">PAAS_INNER_DOMAIN</span>
</pre></div>


<h2 id="_1">其他平台部署</h2>
<p>需要提供，是的依赖方自行决定使用内部 or 外部域名。</p>
<ul>
<li>
<p><code>PAAS_DOMAIN</code>  外部 https，nginx。</p>
</li>
<li>
<p><code>PAAS_INNER_DOMAIN</code> 内部 http，consul。</p>
</li>
</ul>
<p><strong>SaaS 开发者关注 <a href="5.1/开发指南/SaaS开发/开发基础/README.md">开发框架</a> 改造</strong></p>
<h2 id="confdefaultpy">conf/default.py</h2>
<p>新增一个配置：conf/default.py 文件中大概 50 行处 <code>BK_PAAS_HOST = os.environ.get('BK_PAAS_HOST'，BK_PAAS_HOST)</code> 的后面添加</p>
<div class="codehilite"><pre><span></span><span class="n">BK_PAAS_INNER_HOST</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;BK_PAAS_INNER_HOST&#39;</span><span class="p">,</span><span class="n">BK_PAAS_HOST</span><span class="p">)</span>
</pre></div>


<p>此时，本地开发，没有 <code>BK_PAAS_INNER_HOST</code> 会走 <code>BK_PAAS_HOST</code>，走 <code>https</code> ; 在 PaaS 中部署，有这个环境变量，会走内网 <code>http</code>。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/15353433877928.png" /></p>
<h2 id="bluekingcomponentconfpy">blueking/component/conf.py</h2>
<p>blueking/component/conf.py 文件中大概 11 行处修改变量</p>
<p>组件调用， 将 <code>COMPONENT_SYSTEM_HOST</code> 修改为 <code>INNER_HOST</code></p>
<div class="codehilite"><pre><span></span><span class="n">COMPONENT_SYSTEM_HOST</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="s1">&#39;BK_PAAS_INNER_HOST&#39;</span><span class="n">settings</span><span class="o">.</span><span class="n">BK_PAAS_HOST</span><span class="p">)</span>
</pre></div>


<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/部署维护/场景案例/..../../assets/15353434175842.png" /></p>
<h2 id="accountaccountspy">account/accounts.py</h2>
<p>account/accounts.py 文件中大概 34 行处修改变量，修改登录访问地址依赖  <code>BK_PAAS_INNER_HOST</code></p>
<div class="codehilite"><pre><span></span><span class="n">BK_LOGIN_VERIFY_URL</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/login/accounts/is_login/&quot;</span> <span class="o">%</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span><span class="s1">&#39;BK_PAAS_INNER_HOST&#39;</span><span class="p">,</span><span class="n">settings</span><span class="o">.</span><span class="n">BK_PAAS_HOST</span><span class="p">)</span>
<span class="n">BK_GET_USER_INFO_URL</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/login/accounts/get_user/&quot;</span> <span class="o">%</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span><span class="s1">&#39;BK_PAAS_INNER_HOST&#39;</span><span class="p">,</span><span class="n">settings</span><span class="o">.</span><span class="n">BK_PAAS_HOST</span><span class="p">)</span>
</pre></div>


<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/15353433993101.png" /></p>
<h2 id="esb-api-https">[ESB 调用方关注] API 网关用户 HTTPS 改造方案</h2>
<p>API 网关 API 提供外部 HTTPS、内部 HTTP 两个协议，（内部表示与 API 网关部署在同一个环境，可使用同一个内部域名解析服务）。</p>
<h2 id="url">直接通过 URL 访问组件的情况</h2>
<ol>
<li>
<p>通过 HTTPS 协议访问，使用 HTTPS 外部域名，Python 程序使用 reqeusts 包时，请求参数需添加 verify=False。</p>
</li>
<li>
<p>通过 HTTP 协议访问，服务需要与 API 网关部署在同一环境，使用内部新域名即可，其他不需要变动。</p>
</li>
</ol>
<p>注意：
1. 本地开发测试，需使用 HTTPS 协议。</p>
<ol>
<li>
<p>脚本等不确定服务器的场景，需使用 HTTPS 协议。</p>
</li>
<li>
<p>JOB、CC 等第三方系统，如果正式环境与 ESB 部署在同一环境，服务器可以解析内部域名，可以使用 HTTP 协议。</p>
</li>
</ol>
<h2 id="saas-sdk">SaaS 使用组件 SDK 的情况</h2>
<ol>
<li>检查 blueking/component/client.py BaseComponentClient.request 方法中，requests.request 包含 verify=False 参数。</li>
</ol>
<div class="codehilite"><pre><span></span><span class="k">return</span> <span class="n">requests</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="p">,</span><span class="n">url</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span><span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>


<ol>
<li>配置更新(可选，以下配置，SaaS 正式环境会使用内部域名访问组件)。</li>
</ol>
<div class="codehilite"><pre><span></span><span class="n">conf</span><span class="o">/</span><span class="n">default</span><span class="o">.</span><span class="n">py</span>
<span class="n">BK_PAAS_INNER_HOST</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;BK_PAAS_INNER_HOST&#39;</span><span class="p">,</span><span class="n">BK_PAAS_HOST</span><span class="p">)</span>

<span class="n">blueking</span><span class="o">/</span><span class="n">component</span><span class="o">/</span><span class="n">conf</span><span class="o">.</span><span class="n">py</span>
<span class="n">COMPONENT_SYSTEM_HOST</span> <span class="o">=</span> <span class="n">getatrr</span><span class="p">(</span><span class="n">settings</span><span class="p">,</span><span class="s1">&#39;BK_PAAS_INNER_HOST&#39;</span><span class="p">,</span><span class="n">settings</span><span class="o">.</span><span class="n">BK_PAAS_HOST</span><span class="p">)</span>
</pre></div>


<ol>
<li>本地开发: 例如 saas/ 脚本，依赖线上服务地址，务必将依赖地址改成 <code>https</code>，否则 <code>nginx</code> 会自动将 <code>http</code> 转 301 至 <code>https</code>，参数信息会丢失，导致请求异常。</li>
</ol>
<h2 id="_2">[依赖登录关注] 其他登录系统</h2>
<p>内部调用走 <code>PAAS_INNER_DOMAIN</code>(内部 consul 地址)，需要跳转(例如登录跳转)走<code>PAAS_DOMAIN</code>(因为是在用户浏览器上跳转的)。</p>
<ul>
<li>
<p>配置  <code>PAAS_DOMAIN</code> 及 <code>PAAS_INNER_DOMAIN</code> 两个地址(需运营组给到替换变量)。</p>
</li>
<li>
<p>访问  <code>/login/accounts/is_login/</code>及<code>/login/accounts/get_user</code>及 ESB 等，走 <code>PAAS_INNER_DOMAIN</code>。</p>
</li>
<li>
<p>登录跳转走  <code>PAAS_DOMAIN</code>。</p>
</li>
</ul><h2 id="_1">开源版本替换说明</h2>
<p>蓝鲸社区版，是蓝鲸智云提供的面向社区用户的基于 PaaS 的运维技术解决方案套件，该软件永久免费，支持公有云环境、私有环境的独立搭建部署，本文档主要介绍蓝鲸社区版中，如何将开源的产品替换到已有的社区版环境中。关于基础包安装、增强包安装、软件升级、 SaaS 部署等内容请查看部署维护其他文档。</p>
<h3 id="_2">替换说明</h3>
<ol>
<li>版本限制：</li>
</ol>
<table>
<thead>
<tr>
<th>开源产品</th>
<th>替换已有社区版限制</th>
<th>开源产品地址</th>
</tr>
</thead>
<tbody>
<tr>
<td>配置平台</td>
<td>社区版 V5.0 或以上版本(配置平台版本 3.2.2 或以上)</td>
<td>https://github.com/Tencent/bk-cmdb</td>
</tr>
<tr>
<td>PaaS 平台</td>
<td>社区版 V5.0.4 及以下版本</td>
<td>https://github.com/Tencent/bk-paas</td>
</tr>
<tr>
<td>标准运维</td>
<td>不限制替换版本，按照替换文档操作即可</td>
<td>https://github.com/Tencent/bk-sops</td>
</tr>
<tr>
<td>容器管理平台</td>
<td>社区版 V5.1 或以上版本</td>
<td>https://github.com/Tencent/bk-bcs</td>
</tr>
<tr>
<td>故障自愈</td>
<td>敬请期待</td>
<td>敬请期待</td>
</tr>
</tbody>
</table>
<ol>
<li>产品升级：</li>
</ol>
<p>已开源的产品发布新版本时，会同步更新开源版，用户在开源项目中获取最新版本的 release 包后按照文档再次进行 <code>替换/安装</code> 即可</p><h1 id="paas">开源版 PaaS 平台替换社区版部署指南</h1>
<ul>
<li>
<p>本方案目前仅适用于社区版 <code>V5.0.4</code> 以后的版本</p>
</li>
<li>
<p>替换前请务必手动备份 DB 数据 <code>MySQL</code></p>
</li>
</ul>
<h2 id="open_paas">Open_Paas 替换指南</h2>
<ul>
<li>备份原社区版 <code>open_paas</code> 目录,将开源的 PaaS 代码解压到中控机的 <code>/tmp</code> 目录下</li>
</ul>
<p><code>bash
  mv /data/src/open_paas /data/open_paas-bak  #备份原 PaaS 工程
  cp -a /tmp/bk-PaaS-master/paas-ce/paas /data/src/open_paas #拷贝开源代码到 src 目录
  cp -a /data/open_paas-bak/support-files  /data/src/open_paas/ #拷贝原配置模版文件
  rsync -a /data/open_paas-bak/esb/components/*  /data/src/open_paas/esb/components/
  cp -a /data/open_paas-bak/esb/lib/gse /data/src/open_paas/esb/lib/</code></p>
<ul>
<li>
<p>安装开源 PaaS 平台</p>
</li>
<li>
<p>替换已经部署好的社区版 PaaS 平台</p>
</li>
</ul>
<p><code>bash
  ./bkcec sync paas
  ./bkcec install paas
  ./bkcec initdata paas
  ./bkcec stop paas
  ./bkcec start paas</code></p>
<ul>
<li>全新安装: 替换完 <code>/data/src/open_paas</code> 目录后，参考社区版 <a href="../../../基础包安装/多机部署/quick_install.md">标准部署</a> 文档即可：</li>
</ul>
<p><code>bash
  ./bk_install paas</code></p>
<h2 id="paas_agent">paas_agent 替换指南</h2>
<ul>
<li>将开源版编译后生成的二进制：paasagent/bin/paas_agent 拷贝替换社区版 /data/src/paas_agent/paas_agent/bin/paas_agent</li>
</ul>
<p><code>bash
  cp -f paasagent/bin/paas_agent /data/src/paas_agent/paas_agent/bin/  # 将生成的开源二进制文件拷贝到 src/paas_agent 目录下</code></p>
<ul>
<li>安装开源 <code>paas_agent</code></li>
</ul>
<p>```bash
  # 安装 appo
  ./bkcec stop appo
  ./bkcec sync appo
  ./bkcec install appo
  ./bkcec initdata appo
  ./bkcec start appo
  ./bkcec activate appo</p>
<p># 安装 appt
  ./bkcec stop appt
  ./bkcec sync appt
  ./bkcec install appt
  ./bkcec initdata appt
  ./bkcec start appt<br />
  ./bkcec activate appt
  ```</p>
<h2 id="saas">蓝鲸官方 SaaS 应用组件的维护</h2>
<p>1.以标准运维 <code>bk_sops</code> 为例进行说明</p>
<p><strong>（1）场景一：</strong></p>
<p>复制 SaaS 为新应用，访问 SaaS 应用组件时，请求转发到新的 SaaS 应用。假定新标准运维应用为 <code>bk-sops-ce</code>。</p>
<ul>
<li>
<p>打开 <code>$INSTALL_PATH/paas/esb/components/confapis/sops/sops.yaml</code>，将每个组件配置中 <code>dest_path</code> 替换为新应用 <code>bk-sops-ce</code> 提供的 API 地址比如，将 <code>dest_path</code> 改为 <code>/o/bk-sops-ce/apigw/get_template_list/{bk_biz_id}/</code></p>
</li>
<li>
<p>更新配置参考：API 网关服务常用指令/更新配置</p>
</li>
<li>
<p>重启服务参考：API 网关服务常用指令/重启 API 网关服务</p>
</li>
</ul>
<p><strong>（2）场景二：</strong></p>
<p>复制 SaaS 为新应用，并为新应用提供新的组件。假定新标准运维应用为 <code>bk-sops-ce</code>。</p>
<ul>
<li>将 <code>$INSTALL_PATH/paas/esb/components/bk/apisv2/sops</code> 复制为 <code>$INSTALL_PATH/paas/esb/components/bk/apisv2/bk_sops_ce</code>；</li>
</ul>
<p>并将 <code>bk_sops_ce/toolkit/configs.py 中的 SYSTEM_NAME</code> 改为 <code>BK_SOPS_CE</code>（新应用 ID 的大写形式）。</p>
<ul>
<li>将 <code>$INSTALL_PATH/paas/esb/components/confapis/sops</code> 复制为 <code>$INSTALL_PATH/paas/esb/components/confapis/bk_sops_ce</code>；</li>
</ul>
<p>将 <code>bk_sops_ce/sops.yaml 文件名更新为 bk_sops_ce/bk_sops_ce.yaml</code>；</p>
<p>将 <code>bk_sops_ce/bk_sops_ce.yaml</code> 每个组件配置中 path 替换为新组件的路径，如：<code>/v2/bk_sops_ce/get_template_list/</code>；</p>
<p>将 <code>bk_sops_ce/bk_sops_ce.yaml</code> 每个组件配置中 <code>comp_codename</code> 替换为新组件的组件代号，比如： <code>generic.v2.bk_sops_ce.sops_component</code>；</p>
<p>将 <code>bk_sops_ce/bk_sops_ce.yaml</code> 每个组件配置中 <code>dest_path</code> 替换为新应用 <code>bk_sops_ce</code> 提供的 API 地址，比如：<code>/o/bk-sops-ce/apigw/get_template_list/{bk_biz_id}/</code>。</p>
<ul>
<li>
<p>在 API 网关管理端-&gt;系统管理中，添加一个新的系统，系统名称为：<code>BK_SOPS_CE</code>（同步骤 1  中的 <code>SYSTEM_NAME</code>）</p>
</li>
<li>
<p>更新配置参考：API 网关服务常用指令/更新配置</p>
</li>
<li>
<p>重启服务参考：API 网关服务常用指令/重启 API 网关服务</p>
</li>
<li>
<p>新组件访问路径
  <code>/api/c/compapi/ + {path}（bk_sops_ce/bk_sops_ce.yaml 中的配置项 path）</code></p>
</li>
</ul><h1 id="_1">开源配置平台替换社区版部署指南</h1>
<ul>
<li>本方案目前仅适用于社区版 <code>V5.0.</code> 或者更高版本。</li>
<li>替换前请务必手动备份 DB 数据 <code>MongoDB</code>。</li>
</ul>
<h2 id="_2">背景</h2>
<p>有许多用户是通过蓝鲸社区版开始接触 <code>bk-cmdb</code> 项目，随着对蓝鲸社区版使用逐渐深入之后，可能会遇到些功能特性需求或者需要修复的 bug，社区版 CMDB 需要随着蓝鲸智云整体发布流程出包，因此需求或 bugfix 不能快速的体现到社区版本出包上。</p>
<p>为了解决社区版不能 CMDB 不能快速迭代的问题，本文在此提出一种使用开源 CMDB 替换社区版 CMDB 的方案，开源版本 CMDB 从 Issue 提出到 pr 合入主干链路相比社区版本省去了很多耗时的流程，可以做到快速迭代。</p>
<h2 id="cmdb-cmdb">开源版 CMDB 与社区版 CMDB</h2>
<p>开源版本指的是 GitHub 上的 <a href="https://github.com/Tencent/bk-cmdb">开源 CMDB 项目</a>，社区版指的是伴随 <a href="https://bk.tencent.com/">蓝鲸智云</a> 产品一起发布出去的社区版。</p>
<p>两者采用的源代码是一致的，比如您在蓝鲸智云 <a href="https://bk.tencent.com/download/">下载页面</a> 看到的 CMDB 最新版本是 <code>3.2.2</code>，它跟 GitHub 上 <a href="https://github.com/Tencent/bk-cmdb/releases/tag/release-v3.2.2">release-v3.2.2</a> 采用相同代码编译结果。</p>
<p>主要区别在于两者的配置文件，社区版本 CMDB 是蓝鲸社区版的一部分，启动配置文件对接的也是蓝鲸社区版，比如登录对接的蓝鲸统一登录，比如即将推出的细粒度权限版本也会对接蓝鲸权限中心。相对而言，开源版本独立部署，没有蓝鲸统一登录与蓝鲸权限中心等依赖环境，因此二进制包中默认的配置是采用的无登录和内置鉴权方案。</p>
<h2 id="_3">替换有哪些好处</h2>
<ul>
<li>
<p>能够较快体验到最新的功能特性</p>
</li>
<li>
<p>可以及时得到 bugfix</p>
</li>
<li>掌握替换方法之后，方便基于开源版本进行二次开发</li>
</ul>
<h2 id="_4">升级建议</h2>
<ul>
<li>
<p>做好备份</p>
</li>
<li>
<p>系统化测试</p>
</li>
<li>
<p>尽量在同一个大版本下进行升级，比如 <code>3.2.2</code> 升级到 <code>3.2.6</code>， 它们都是源于 <code>3.2.x</code> 分支的 release，相对来说没有大的功能变更，主要进行了一些优化及 bugfix 工作。</p>
</li>
</ul>
<h2 id="_5">替换步骤</h2>
<p>这部分内容需要操作社区版环境，这里先统一社区版部署根目录 <code>export BKCE=/data/bkce</code></p>
<h2 id="_6">备份</h2>
<h3 id="mongodb">备份 MongoDB</h3>
<ul>
<li>
<p><code>mongodump --host 127.0.0.1 --port 27017 --out backup/ --db cmdb</code></p>
</li>
<li>
<p>详细请参考 <a href="https://docs.mongodb.com/manual/tutorial/backup-and-restore-tools/">Back Up and Restore with MongoDB Tools</a></p>
</li>
</ul>
<h3 id="cmdb">备份 CMDB</h3>
<p>如果磁盘空间足够的话，可以直接备份整个社区版。</p>
<h2 id="cmdb_1">下载编译 CMDB</h2>
<ul>
<li>前置条件：可从外网下载 node</li>
</ul>
<p>如果只是使用 CMDB，建议从 GitHub 下载最新的 release 代码。</p>
<p>由于某些原因，较新版本的 release 里面，暂时没能提供二进制文件，需要自行编译。</p>
<div class="codehilite"><pre><span></span><span class="nv">workspace</span><span class="o">=</span>tmp1
<span class="nv">release</span><span class="o">=</span>v3.2.8

mkdir -p <span class="si">${</span><span class="nv">workspace</span><span class="si">}</span>
<span class="nb">cd</span> <span class="si">${</span><span class="nv">workspace</span><span class="si">}</span>
<span class="nb">export</span> <span class="nv">GOPATH</span><span class="o">=</span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>
wget https://github.com/Tencent/bk-cmdb/archive/release-<span class="si">${</span><span class="nv">release</span><span class="si">}</span>.tar.gz
tar -xf release-<span class="si">${</span><span class="nv">release</span><span class="si">}</span>.tar.gz
mkdir src
mv bk-cmdb-release-<span class="si">${</span><span class="nv">release</span><span class="si">}</span> src/configcenter
<span class="nb">cd</span> src/configcenter/src

<span class="nv">GITHASH</span><span class="o">=</span><span class="si">${</span><span class="nv">release</span><span class="si">}</span> <span class="nv">GITTAG</span><span class="o">=</span>ocr-<span class="si">${</span><span class="nv">release</span><span class="si">}</span> <span class="nv">VERSION</span><span class="o">=</span><span class="si">${</span><span class="nv">release</span><span class="si">}</span> make
</pre></div>


<h2 id="_7">生成配置</h2>
<p>新版本中可能会进行相应的调整，比如新增一些配置字段，为了保障升级后的程序正常运行，最好基于新版本重新生成一份配置文件。</p>
<p>生成配置时需要用社区版的配置文件对应的配置参数重新生成配置，社区版 CMDB 的配置文件一般在目录 <code>${BKCE}/cmdb/server/conf/</code> 中。</p>
<div class="codehilite"><pre><span></span><span class="o">[</span>root@VM_1_210_centos ~<span class="o">]</span><span class="c1"># ll ${BKCE}cmdb/server/conf/</span>
total <span class="m">44</span>
-rw-r--r-- <span class="m">1</span> root root   <span class="m">0</span> Apr <span class="m">17</span> <span class="m">21</span>:00 apiserver.conf
-rw-r--r-- <span class="m">1</span> root root <span class="m">188</span> Apr <span class="m">17</span> <span class="m">21</span>:00 auditcontroller.conf
-rw-r--r-- <span class="m">1</span> root root <span class="m">833</span> Apr <span class="m">17</span> <span class="m">21</span>:00 datacollection.conf
-rw-r--r-- <span class="m">1</span> root root <span class="m">292</span> Apr <span class="m">17</span> <span class="m">21</span>:00 eventserver.conf
-rw-r--r-- <span class="m">1</span> root root <span class="m">126</span> Apr <span class="m">17</span> <span class="m">21</span>:00 host.conf
-rw-r--r-- <span class="m">1</span> root root <span class="m">292</span> Apr <span class="m">17</span> <span class="m">21</span>:00 hostcontroller.conf
-rw-r--r-- <span class="m">1</span> root root <span class="m">473</span> Apr <span class="m">17</span> <span class="m">21</span>:00 migrate.conf
-rw-r--r-- <span class="m">1</span> root root <span class="m">355</span> Apr <span class="m">17</span> <span class="m">21</span>:00 objectcontroller.conf
-rw-r--r-- <span class="m">1</span> root root <span class="m">291</span> Apr <span class="m">17</span> <span class="m">21</span>:00 proc.conf
-rw-r--r-- <span class="m">1</span> root root <span class="m">292</span> Apr <span class="m">17</span> <span class="m">21</span>:00 proccontroller.conf
-rw-r--r-- <span class="m">1</span> root root <span class="m">202</span> Apr <span class="m">17</span> <span class="m">21</span>:00 topo.conf
-rw-r--r-- <span class="m">1</span> root root <span class="m">709</span> Apr <span class="m">17</span> <span class="m">21</span>:00 webserver.conf
<span class="o">[</span>root@VM_1_210_centos ~<span class="o">]</span><span class="c1">#</span>
</pre></div>


<p>可参考如下生成配置示例进行相应调整：</p>
<div class="codehilite"><pre><span></span><span class="nb">cd</span> bin/build/v3.2.8

./init.py --discovery <span class="m">127</span>.0.0.1:2181 <span class="se">\</span>
--database cmdb <span class="se">\</span>
--redis_ip <span class="m">127</span>.0.0.1 <span class="se">\</span>
--redis_port <span class="m">6379</span> <span class="se">\</span>
--redis_pass <span class="m">1234</span> <span class="se">\</span>
--mongo_ip <span class="m">127</span>.0.0.1 <span class="se">\</span>
--mongo_port <span class="m">27017</span> <span class="se">\</span>
--mongo_user cc <span class="se">\</span>
--mongo_pass cc <span class="se">\</span>
--blueking_cmdb_url http://bk.tencent.com <span class="se">\</span>
--blueking_paas_url http://bk.tencent.com <span class="se">\</span>
--listen_port <span class="m">8083</span>

➜  v3.2.8 tree cmdb_adminserver/configures
cmdb_adminserver/configures
├── apiserver.conf
├── auditcontroller.conf
├── datacollection.conf
├── eventserver.conf
├── host.conf
├── hostcontroller.conf
├── migrate.conf
├── objectcontroller.conf
├── proc.conf
├── proccontroller.conf
├── topo.conf
└── webserver.conf
</pre></div>


<p>升级前后的配置文件可以通过对比工具进一步查看升级前后配置的区别，保障生成正确的配置文件。一种比较有效的方式时通过 Git 来管理这些配置，通过 pr 的方式查看配置升级前后的区别。</p>
<h2 id="cmdb_2">停止 CMDB</h2>
<div class="codehilite"><pre><span></span>supervisorctl -c <span class="si">${</span><span class="nv">BKCE</span><span class="si">}</span>/etc/supervisor-cmdb-server.conf stop all
supervisorctl -c <span class="si">${</span><span class="nv">BKCE</span><span class="si">}</span>/etc/supervisor-cmdb-server.conf status
</pre></div>


<h2 id="_8">更新二进制和配置文件</h2>
<h3 id="_9">更新二进制</h3>
<div class="codehilite"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="nb">cd</span> tmp/src/configcenter/src/bin/build/v3.2.8
<span class="nv">files</span><span class="o">=</span><span class="s2">&quot;</span><span class="k">$(</span>find . -type f -name <span class="s2">&quot;cmdb_*&quot;</span><span class="k">)</span><span class="s2">&quot;</span>
<span class="k">for</span> file in <span class="nv">$files</span><span class="p">;</span><span class="k">do</span>
    cp -f <span class="si">${</span><span class="nv">file</span><span class="si">}</span> <span class="si">${</span><span class="nv">BKCE</span><span class="si">}</span>/cmdb/server/bin/
<span class="k">done</span>

cp -rf web <span class="si">${</span><span class="nv">BKCE</span><span class="si">}</span>/cmdb/
</pre></div>


<h3 id="_10">更新国际化数据</h3>
<div class="codehilite"><pre><span></span>cp -rf cmdb_adminserver/conf/errors <span class="si">${</span><span class="nv">BKCE</span><span class="si">}</span>/cmdb/
cp -rf cmdb_adminserver/conf/language/ <span class="si">${</span><span class="nv">BKCE</span><span class="si">}</span>/cmdb/
</pre></div>


<h3 id="_11">更新进程配置</h3>
<div class="codehilite"><pre><span></span>cp -rf cmdb_adminserver/configures <span class="si">${</span><span class="nv">BKCE</span><span class="si">}</span>/cmdb/server/conf
</pre></div>


<h2 id="_12">启动开源版本</h2>
<div class="codehilite"><pre><span></span>supervisorctl -c <span class="si">${</span><span class="nv">BKCE</span><span class="si">}</span>/etc/supervisor-cmdb-server.conf start all
supervisorctl -c <span class="si">${</span><span class="nv">BKCE</span><span class="si">}</span>/etc/supervisor-cmdb-server.conf status
</pre></div>


<h2 id="migrate">migrate</h2>
<p>开源版本中有个 <code>init_db.sh</code> 脚本用来升级数据库，该脚本其实是想 Adminserver 发起一个请求，由 Adminserver 执行升级操作。做 MongoDB 数据升级时，可以直接执行该脚本，或者直接调用 Adminserver 的 HTTP 接口。</p>
<div class="codehilite"><pre><span></span>curl -X POST -H <span class="s1">&#39;Content-Type:application/json&#39;</span> -H <span class="s1">&#39;BK_USER:migrate&#39;</span> -H <span class="s1">&#39;HTTP_BLUEKING_SUPPLIER_ID:0&#39;</span> http://<span class="si">${</span><span class="nv">adminserver</span><span class="si">}</span>:60004/migrate/v3/migrate/community/0
</pre></div>


<h2 id="_13">验证</h2>
<p>执行到这一步，说明升级操作流程基本执行完了，但是这并不意味着升级成功，只有经过您反复验证后的升级才算完成。</p>
<h2 id="_14">问题反馈</h2>
<p>如果替换过程遇到无法进行下去，可以先到 GitHub CMDB 上搜索相关问题，可能你遇到的问题前人已经踩过坑了。如果仍然找不到答案，可以到蓝鲸 CMDB 开源开发交流 305496802 咨询，或者直接在 GitHub 多。比如现在用的哪个版本 CMDB，开源版本还是社区版本，版本号多少，遇到什么样的问题，期望得到什么样的效果等等，提问时你可以换个角度思考下，问题是否足够清晰，背景信息是否足够。参考 <a href="https://www.zhihu.com/question/62887673">如何在 GitHub 上正确的提 Issue？</a></p>
<h2 id="_15">更新版本号信息</h2>
<ul>
<li>
<p><code>VERSION</code></p>
</li>
<li>
<p><code>projects.yaml</code></p>
</li>
</ul>
<p>主要更新各个 CMDB Server 的 version 字段</p>
<div class="codehilite"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cmdb_coreservice</span>
  <span class="nt">module</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cmdb</span>
  <span class="nt">project_dir</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cmdb/server/bin</span>
  <span class="nt">alias</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cmdb_coreservice</span>
  <span class="nt">role</span><span class="p">:</span> <span class="s">&quot;node&quot;</span>
  <span class="nt">language</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">golang</span>
  <span class="nt">version</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3.2.8</span>
  <span class="nt">version_type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">oc</span>
</pre></div>


<h2 id="_16">常见问题解决</h2>
<h2 id="make-git">make 时 git 命令执行报错</h2>
<p>现象：</p>
<div class="codehilite"><pre><span></span>go build -i -ldflags <span class="s2">&quot;-X configcenter/src/common/version.CCVersion= -X configcenter/src/common/version.CCBuildTime=2019-05-09T14:35:01+0800 -X configcenter/src/common/version.CCGitHash= -X configcenter/src/common/version.CCTag=&quot;</span> -o tmp/src/configcenter/src/bin/build/cmdb_proccontroller/cmdb_proccontroller
fatal: not a git repository <span class="o">(</span>or any of the parent directories<span class="o">)</span>: .git
fatal: not a git repository <span class="o">(</span>or any of the parent directories<span class="o">)</span>: .git
fatal: not a git repository <span class="o">(</span>or any of the parent directories<span class="o">)</span>: .git
fatal: not a git repository <span class="o">(</span>or any of the parent directories<span class="o">)</span>: .git
</pre></div>


<p>原因：常规 make 时默认从 Git 版本中提取</p>
<p>解决办法：设置 GITHASH，GITTAG，VERSION 这三个编译环境变量，如 <code>GITHASH=xxx GITTAG=ocr-v3.2.8 VERSION=v3.2.8 make</code></p>
<h2 id="make-generatepy">make 时提示 <code>generate.py</code> 语法问题</h2>
<p>出错现象如下：</p>
<div class="codehilite"><pre><span></span>go build -i -ldflags <span class="s2">&quot;-X configcenter/src/common/version.CCVersion=v3.2.8-t -X configcenter/src/common/version.CCBuildTime=2019-05-09T15:00:38+0800 -X configcenter/src/common/version.CCGitHash=xxx-t -X configcenter/src/common/version.CCTag=release-v3.2.8-t&quot;</span> -o tmp/src/configcenter/src/bin/build/v3.2.8-t/cmdb_webserver/cmdb_webserver
File <span class="s2">&quot;./generate.py&quot;</span>, line <span class="m">55</span>
print <span class="s1">&#39;generate.py -t &lt;target&gt;  -i &lt;base_image&gt; -o &lt;output&gt;&#39;</span>
                                                           ^
SyntaxError: Missing parentheses in call to <span class="s1">&#39;print&#39;</span>. Did you mean print<span class="o">(</span><span class="s1">&#39;generate.py -t &lt;target&gt;  -i &lt;base_image&gt; -o &lt;output&gt;&#39;</span><span class="o">)</span>?
make: *** <span class="o">[</span>default<span class="o">]</span> Error <span class="m">1</span>
</pre></div>


<p>问题位置：</p>
<div class="codehilite"><pre><span></span>➜  src grep -n generate.py Makefile
<span class="m">13</span>: @cd <span class="k">$(</span>SCRIPT_DIR<span class="k">)</span> <span class="o">&amp;&amp;</span> python ./generate.py -t <span class="s1">&#39;$(BIN_PATH)&#39;</span> -i <span class="s1">&#39;${IMAGE}&#39;</span> -o <span class="s1">&#39;$(BIN_PATH)/docker&#39;</span>
<span class="m">23</span>: @cd <span class="k">$(</span>SCRIPT_DIR<span class="k">)</span> <span class="o">&amp;&amp;</span> python ./generate.py -t <span class="s1">&#39;$(BIN_PATH)&#39;</span> -i <span class="s1">&#39;${IMAGE}&#39;</span> -o <span class="s1">&#39;$(BIN_PATH)/docker&#39;</span>
<span class="m">38</span>: @cd <span class="k">$(</span>SCRIPT_DIR<span class="k">)</span> <span class="o">&amp;&amp;</span> python ./generate.py -t <span class="s1">&#39;$(BIN_PATH)&#39;</span> -i <span class="s1">&#39;${IMAGE}&#39;</span> -o <span class="s1">&#39;$(BIN_PATH)/docker&#39;</span>
</pre></div>


<p>解决办法：</p>
<ul>
<li>方法一: 切换到 python 2 环境后重新编译: 通过 virtualenv</li>
</ul>
<div class="codehilite"><pre><span></span>mkvirtualenv bk-cmdb -p /usr/local/bin/python2
</pre></div>


<ul>
<li>
<p>方法二: 切换到 python 2 环境后重新编译: 直接修改 python 路径，比如改成 <code>/usr/local/bin/python2</code></p>
</li>
<li>
<p>方法三: 如果不需要生成 dockerfile 文件，可以将上述三行代码删除了，再重新编译</p>
</li>
</ul><h1 id="saas">开源版 SaaS 标准运维替换社区版部署指南</h1>
<h2 id="_1">开发环境后台部署</h2>
<h3 id="_2">部署蓝鲸社区版</h3>
<p>标准运维 SaaS 的登录鉴权依赖于蓝鲸智云 PaaS 平台，业务信息需要从蓝鲸智云配置平台提供的接口获取，所以你需要先下载部署蓝鲸社区版，作为开发联调环境。</p>
<ul>
<li>
<p><a href="https://bk.tencent.com/download/">下载网址</a></p>
</li>
<li>
<p><a href="../../../README.md">安装方案</a></p>
</li>
<li>
<p><a href="https://bk.tencent.com/s-mart/community">产品论坛</a></p>
</li>
<li>
<p>QQ 交流群：495299374</p>
</li>
</ul>
<h3 id="rabbitmq">准备本地 RabbitMQ 资源</h3>
<p>在本地安装 RabbitMQ，并启动 RabbitMQ-Server，服务监听的端口保持默认（5672）。</p>
<h3 id="redis">准备本地 Redis 资源</h3>
<p>在本地安装 Redis，并启动 Redis-Server，服务监听的端口保持默认（6379）。</p>
<h3 id="mysql">准备本地 MySQL</h3>
<p>在本地安装 MySQL，并启动 MySQL-Server，服务监听的端口保持默认（3306）。</p>
<h3 id="python">本地 Python 包安装</h3>
<p>通过 Git 拉取源代码到工程目录中，并进入目录下运行</p>
<div class="codehilite"><pre><span></span>pip install -r requirements.txt
</pre></div>


<h3 id="_3">配置本地环境变量和数据库</h3>
<p>1) 设置环境变量  </p>
<p>设置环境变量的目的是让项目运行时能正确获取以下变量的值：
BK_PaaS_HOST、BK_CC_HOST、BK_JOB_HOST 分别改为你部署的蓝鲸社区版域名、配置平台域名、作业平台域名（需要加上 http 前缀。如果是 https 域名，请改为 https 前缀）。</p>
<p>APP_ID 设置为你的社区版标准运维应用 ID，默认设置为 bk_sops。APP_TOKEN 设置为你的社区版标准运维应用 TOKEN，默认可以访问 <code>http://{BK_PaaS_HOST}/admin/app/app/</code>，找到名为"标准运维"的应用，查看详情获取 Token 字段值。</p>
<p>有三种方式设置本地开发需要的环境变量。</p>
<p>一是手动设置，即执行如下命令</p>
<div class="codehilite"><pre><span></span><span class="nb">export</span> <span class="nv">APP_ID</span><span class="o">=</span><span class="s2">&quot;bk_sops&quot;</span>
<span class="nb">export</span> <span class="nv">APP_TOKEN</span><span class="o">=</span><span class="s2">&quot;{APP_TOKEN}&quot;</span>
<span class="nb">export</span> <span class="nv">BK_PaaS_HOST</span><span class="o">=</span><span class="s2">&quot;{BK_PaaS_HOST}&quot;</span>
<span class="nb">export</span> <span class="nv">BK_CC_HOST</span><span class="o">=</span><span class="s2">&quot;{BK_CC_HOST}&quot;</span>
<span class="nb">export</span> <span class="nv">BK_JOB_HOST</span><span class="o">=</span><span class="s2">&quot;{BK_JOB_HOST}&quot;</span>
</pre></div>


<p>二是直接修改 scripts/develop/sites/community/env.sh，然后执行</p>
<div class="codehilite"><pre><span></span><span class="nb">source</span> scripts/develop/sites/community/env.sh
</pre></div>


<p>第三种方式，你可以直接修改项目的 settings 配置，先修改 <code>config/__init__.py</code> ，设置项目的基础信息</p>
<div class="codehilite"><pre><span></span><span class="n">APP_ID</span> <span class="o">=</span> <span class="s1">&#39;bk_sops&#39;</span>
<span class="n">APP_TOKEN</span> <span class="o">=</span> <span class="s1">&#39;{APP_TOKEN}&#39;</span>
<span class="n">BK_PaaS_HOST</span> <span class="o">=</span> <span class="s1">&#39;{BK_PaaS_HOST}&#39;</span>
</pre></div>


<p>然后修改 config/dev.py ，追加配置平台域名、作业平台域名配置</p>
<div class="codehilite"><pre><span></span><span class="n">BK_CC_HOST</span> <span class="o">=</span> <span class="s1">&#39;{BK_CC_HOST}&#39;</span>
<span class="n">BK_JOB_HOST</span> <span class="o">=</span> <span class="s1">&#39;{BK_JOB_HOST}&#39;</span>
</pre></div>


<p>2) 修改 config/dev.py，设置本地开发用的数据库信息，添加 Redis 本地信息</p>
<div class="codehilite"><pre><span></span><span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;ENGINE&#39;</span><span class="p">:</span> <span class="s1">&#39;django.db.backends.MySQL&#39;</span><span class="p">,</span>  <span class="c1"># 默认用MySQL</span>
        <span class="s1">&#39;NAME&#39;</span><span class="p">:</span> <span class="n">APP_ID</span><span class="p">,</span>       <span class="c1"># 数据库名 (默认与APP_ID相同)</span>
        <span class="s1">&#39;USER&#39;</span><span class="p">:</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span>       <span class="c1"># 你的数据库user</span>
        <span class="s1">&#39;PASSWORD&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>       <span class="c1"># 你的数据库password</span>
        <span class="s1">&#39;HOST&#39;</span><span class="p">:</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>  <span class="c1"># 数据库HOST</span>
        <span class="s1">&#39;PORT&#39;</span><span class="p">:</span> <span class="s1">&#39;3306&#39;</span><span class="p">,</span>       <span class="c1"># 默认3306</span>
    <span class="p">},</span>
<span class="p">}</span>

<span class="n">Redis</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
    <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="mi">6379</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>


<h3 id="_4">创建并初始化数据库</h3>
<p>1) 在 MySQL 中创建名为 bk_sops 的数据库</p>
<div class="codehilite"><pre><span></span>CREATE DATABASE <span class="sb">`</span>bk_sops<span class="sb">`</span> DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci<span class="p">;</span>
</pre></div>


<p>2) 在工程目录下执行以下命令初始化数据库</p>
<div class="codehilite"><pre><span></span>Python manage.py migrate
Python manage.py createcachetable django_cache
</pre></div>


<h3 id="_5">打包并收集前端静态资源</h3>
<p>1）安装依赖包<br />
进入 frontend/desktop/，执行以下命令安装</p>
<div class="codehilite"><pre><span></span>npm install
</pre></div>


<p>2）本地打包
在 frontend/desktop/ 目录下，继续执行以下命令打包前端静态资源</p>
<div class="codehilite"><pre><span></span>npm run build -- --STATIC_ENV<span class="o">=</span>dev
</pre></div>


<p>3）收集静态资源
回到项目根目录，执行以下命令收集前端静态资源到 static 目录下</p>
<div class="codehilite"><pre><span></span>Python manage.py collectstatic --noinput
</pre></div>


<p>前端资源文件需要单独拷贝收集，执行如下命令</p>
<div class="codehilite"><pre><span></span>rm -rf static/dev static/images
mv frontend/desktop/static/dev static/
mv frontend/desktop/static/images static/
</pre></div>


<h3 id="hosts">配置本地 hosts</h3>
<p>Windows：在 C:\Windows\System32\drivers\etc\host 文件中添加“127.0.0.1 dev.{BK_PaaS_HOST}”。</p>
<p>Mac：执行 "sudo vim /etc/hosts"，添加 "127.0.0.1 dev.{BK_PaaS_HOST}"。</p>
<h3 id="_6">启动进程</h3>
<div class="codehilite"><pre><span></span>Python manage.py celery worker -l info
Python manage.py runServer <span class="m">8000</span>
</pre></div>


<h3 id="_7">访问页面</h3>
<p>使用浏览器开发 <code>http://dev.{BK_PaaS_HOST}:8000/</code> 访问应用。</p>
<h2 id="_8">开发环境前端部署</h2>
<h3 id="nodejs">安装 node.js</h3>
<p>标准运维前端是用 Vue 框架开发的，在本地开发时需要先安装 node.js，直接去官网下载软件并安装即可，地址为：https://nodejs.org/en/。</p>
<h3 id="_9">安装依赖包</h3>
<p>进入 frontend/desktop/，执行以下命令安装。</p>
<div class="codehilite"><pre><span></span>npm install
</pre></div>


<h3 id="_10">修改配置文件</h3>
<p>把 frontend/desktop/ 中的所有文件中的 {BK_PaaS_HOST} 换成你部署的蓝鲸社区版地址，如果你的应用 ID 修改过，请把所有文件中的 bk_sops 改成你的新应用 ID。</p>
<h3 id="_11">启动前端工程</h3>
<p>进入 bk_sops/src/frontend/desktop/，执行以下命令运行前端工程。默认启动的是 9000 端口，然后通过 <code>http://dev.{BK_PaaS_HOST}:9000/</code> 访问前端应用，此时后端请求会自动转发到你启动的 django 工程，即 8000 端口。</p>
<div class="codehilite"><pre><span></span>npm run dev
</pre></div>


<h3 id="_12">开发后打包</h3>
<p>前端开发完成后，正式发布前需要先打包。还是在 frontend/desktop/ 目录下，执行如下命令打包，会自动在当前目录下生成 static/dist/ 目录，即打包好的前端资源。</p>
<div class="codehilite"><pre><span></span>npm run build -- --SITE_URL<span class="o">=</span><span class="s2">&quot;/o/bk_sops&quot;</span> --STATIC_ENV<span class="o">=</span><span class="s2">&quot;open/prod&quot;</span>
</pre></div>


<h3 id="_13">收集静态资源</h3>
<p>前端打包后，需要在工程目录下运行如下命令收集静态资源到 static 下。</p>
<div class="codehilite"><pre><span></span>rm -rf static/open static/images
mv frontend/desktop/static/open static/
mv frontend/desktop/static/images static/
</pre></div>


<h2 id="_14">正式环境源码部署</h2>
<h3 id="fork">Fork 源代码到自己的仓库</h3>
<p>通过 Fork 源代码到自己的仓库，可以进行二次开发和定制。建议公共特性开发和 bug 修复通过 Pull requests 及时提交到官方仓库。如果不需要进行二次开发，请直接在 releases 中获取打包好的版本，上传部署升级官方标准运维 SaaS。</p>
<h3 id="_15">打包并收集前端静态资源</h3>
<p>1）安装依赖包<br />
进入 frontend/desktop/，执行以下命令安装</p>
<div class="codehilite"><pre><span></span>npm install
</pre></div>


<p>2）本地打包
在 frontend/desktop/ 目录下，继续执行以下命令打包前端静态资源</p>
<div class="codehilite"><pre><span></span>npm run build -- --STATIC_ENV<span class="o">=</span>dev
</pre></div>


<p>3）收集静态资源
回到项目根目录，执行以下命令收集前端静态资源到 static 目录下</p>
<div class="codehilite"><pre><span></span>Python manage.py collectstatic --noinput
</pre></div>


<h3 id="_16">创建应用</h3>
<p>前往你部署的蓝鲸社区版平台，在"开发者中心"点击"应用创建"，填写需要的参数，注意代码仓库填写你的 Github 仓库地址，账号和密码。注意，由于官方已经存在一个名为"标准运维"的应用，你只能填写不一样的应用名称和应用 ID，如"标准运维定制版"、bk-sops-ce。</p>
<h3 id="_17">修改配置</h3>
<p>前往你部署的蓝鲸社区版平台，在"开发者中心"点击"新手指南"，按照文档指引进行操作，主要是数据库配置修改和设置 APP_ID, APP_TOKEN, BK_PaaS_HOST 等变量。</p>
<h3 id="api">开通 API 白名单</h3>
<p>手动在你部署的蓝鲸社区版的中控机执行如下命令，开通标准运维访问蓝鲸 PaaS 平台 API 网关的白名单，以便标准插件可以正常调用 API。</p>
<div class="codehilite"><pre><span></span><span class="nb">source</span> /data/install/utils.fc
add_app_token bk-sops-ce <span class="s2">&quot;</span><span class="k">$(</span>_app_token bk-sops-ce<span class="k">)</span><span class="s2">&quot;</span> <span class="s2">&quot;标准运维定制版&quot;</span>
</pre></div>


<p>注意把"标准运维定制版" 和 bk-sops-ce 改为你创建的应用名称和应用 ID。</p>
<h3 id="redis_1">准备 Redis 资源</h3>
<p>在你部署的蓝鲸社区版的运行环境找一台机器，新建一个 Redis 服务账号和密码。也可以公用部署蓝鲸社区版时已经有的 Redis 服务。</p>
<h3 id="_18">部署应用</h3>
<p>前往你部署的蓝鲸社区版平台，在"开发者中心"点击"我的应用"，找到你刚才创建的应用，点击"应用部署"，请勾选"启用 celery"和"启用周期性任务"。这样你就可以在测试环境访问你新建的"标准运维定制版"应用了。</p>
<h3 id="_19">修改标准运维环境变量配置</h3>
<p>更多可查看 <a href="../../../SaaS部署/标准运维/sops_install.md">标准运维部署</a></p>
<p>打开蓝鲸桌面 <code>http://{BK_PaaS_HOST}/console/</code>，在应用市场找到名字为“标准运维” (APP_CODE: bk_sops) 的应用，添加到桌面并打开。
修改浏览器链接为 <code>http://{BK_PaaS_HOST}/o/bk-sops-ce/admin/</code>，打开标准运维管理后台页面。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/11.png" /></p>
<p>找到环境变量 "EnvironmentVariables" 表并单击进入编辑页面。将第二步中准备好的 Redis 信息填写到环境变量配置中，即增加 3 条数据 BKAPP_Redis_HOST、BKAPP_Redis_PORT、BKAPP_Redis_PASSWORD。
如果直接复用蓝鲸已经部署好的 Redis 服务，环境变量可以分别配置为：</p>
<ul>
<li>
<p>BKAPP_Redis_HOST=在中控机执行 <code>source /data/install/utils.fc &amp;&amp; echo $Redis_IP</code> 获取</p>
</li>
<li>
<p>BKAPP_Redis_PASSWORD=在中控机执行 <code>source /data/install/utils.fc &amp;&amp; echo $Redis_PASS</code> 获取</p>
</li>
<li>
<p>BKAPP_Redis_PORT=6379</p>
</li>
</ul>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/44.png" /></p>
<h3 id="_20">重新部署应用</h3>
<p>由于环境变量只有在项目启动时才会加载，所以修改后必须重新部署才会生效，请进入开发者中心，找到你创建的应用，点击 【应用部署】，请勾选 【启用 celery】和 【启用周期性任务】。</p>
<h3 id="saas_1">替换官方标准运维 SaaS</h3>
<p>按照前面的步骤操作后，你已经在蓝鲸社区版 PaaS 上创建了一个标准运维的定制版本，如果功能测试正常（请主要测试流程模板创建、任务执行、任务操作等核心功能），那么你可以选择下架官方标准运维应用，并用定制版本替换。  </p>
<p>1) 如果需要保留官方标准运维应用的所有数据，你需要修改数据库配置<br />
获取你部署的蓝鲸社区版平台的数据库账号密码，以及官方标准运维应用的数据库名，默认测试环境是 bk_sops_bkt，正式环境是 bk_sops。修改代码的 config/stag.py 和 config/prod.py，分别修改为上面获取的官方标准运维应用的数据库信息。</p>
<div class="codehilite"><pre><span></span><span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;ENGINE&#39;</span><span class="p">:</span> <span class="s1">&#39;django.db.backends.MySQL&#39;</span><span class="p">,</span>  <span class="c1"># 默认用MySQL</span>
        <span class="s1">&#39;NAME&#39;</span><span class="p">:</span> <span class="s1">&#39;bk_sops&#39;</span><span class="p">,</span>                     <span class="c1"># 数据库名 (测试环境写 bk_sops_bkt)</span>
        <span class="s1">&#39;USER&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>                            <span class="c1"># 官方标准运维应用数据库user</span>
        <span class="s1">&#39;PASSWORD&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>                        <span class="c1"># 官方标准运维应用数据库password</span>
        <span class="s1">&#39;HOST&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>                            <span class="c1"># 官方标准运维应用数据库HOST</span>
        <span class="s1">&#39;PORT&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>                            <span class="c1"># 官方标准运维应用数据库PORT</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></div>


<p>2) 由于标准运维接入了蓝鲸 PaaS 平台 API 网关，你需要修改标准运维网关配置
请参考 <a href="5.1/部署维护/场景案例/开源产品替换/Paas平台/replace_paas_with_opensource_version.md">API 网关替换方式</a> 文档，把标准运维 API 转发到你的定制版本的接口。</p>
<h3 id="_21">正式环境上传部署</h3>
<h3 id="fork_1">Fork 源代码到自己的仓库</h3>
<p>通过 Fork 源代码到自己的仓库，可以进行二次开发和定制。建议公共特性开发和 bug 修复通过 Pull requests 及时提交到官方仓库。如果不需要进行二次开发，请直接在 releases 中获取打包好的版本，上传部署升级官方标准运维 SaaS。</p>
<h3 id="_22">修改版本号</h3>
<p>如果有任何代码修改，请务必修改 app.yml 文件中 version 版本号。</p>
<h3 id="_23">打包并收集前端静态资源</h3>
<p>1）安装依赖包<br />
进入 frontend/desktop/，执行以下命令安装</p>
<div class="codehilite"><pre><span></span>npm install
</pre></div>


<p>2）本地打包
在 frontend/desktop/ 目录下，继续执行以下命令打包前端静态资源</p>
<div class="codehilite"><pre><span></span>npm run build -- --STATIC_ENV<span class="o">=</span>dev
</pre></div>


<p>3）收集静态资源
回到项目根目录，执行以下命令收集前端静态资源到 static 目录下</p>
<div class="codehilite"><pre><span></span>Python manage.py collectstatic --noinput
</pre></div>


<h3 id="_24">准备环境</h3>
<p>由于上传部署只支持从本地安装 Python 依赖包，而 Python 安装包是和部署的机器架构相关的，所以你需要在和蓝鲸社区版部署的机器一样的环境执行打包脚本。即准备 CentOS 7 以上操作系统的机器，可以使用 docker。</p>
<h3 id="_25">应用打包</h3>
<p>在 CentOS 机器上，通过 git 拉取你的标准运维定制版仓库代码后，在项目根目录下运行以下命令执行打包操作。</p>
<div class="codehilite"><pre><span></span>bash scripts/publish/build.sh
</pre></div>


<p>注意，该脚本会把项目依赖的 Python 包都下载到生成的版本包中，请务必保证把项目依赖的 Python 包都加入到 requirements.txt 文件中。打包完成后会在当前目录下生成一个名为 "bk_sops-当前时间串.tar,gz" 格式的文件，即版本包。</p>
<h3 id="_26">上传版本并部署</h3>
<p>前往你部署的蓝鲸社区版平台，在【开发者中心】点击【S-mart 应用】，找到官方标准运维应用并进入详情。在 "上传版本" 中，点击【上传文件】后选中上一步打包生成的版本包，等待上传完成。然后点击【发布部署】，你就可以在测试环境或者正式环境部署你最新的版本包了。</p><h1 id="bk-bcs-saas">开源 bk-bcs-saas 替换社区版部署指南[基础版]</h1>
<h2 id="bcs-cc">替换 bcs-cc</h2>
<ul>
<li>备份原社区版 <code>bcs</code> 目录，将开源 <code>bcs</code> 代码解压到中控机的 <code>/tmp</code> 目录下。</li>
</ul>
<p><code>bash
  mkdir -p /data/bcs_bak
  cp -a  /data/src/bcs/ /data/bcs_bak/</code></p>
<ul>
<li>
<p>替换 <code>bcs/cc/bin/bcs_cc</code> 文件</p>
</li>
<li>
<p>将编译生成的 <code>bcs_cc</code> 二进制文件替换到原 <code>/data/src/bcs/cc/bin/</code> 目录下</p>
<p><code>bash
rm -f /data/src/bcs/cc/bin/bcs_cc  # 删除原 bcs_cc二进制文件
cp -a bcs-cc/bin/bcs_cc /data/src/bcs/cc/bin/  # 替换编译后生成的 bcs_cc 二进制文件</code></p>
</li>
</ul>
<h2 id="bcs_web_console">替换 bcs_web_console</h2>
<ul>
<li>替换 <code>bcs/web_console</code> 目录</li>
</ul>
<p><code>bash
  rm -rf /data/src/bcs/web_console/manage.py # 删除原文件
  rm -rf /data/src/bcs/web_console/backend # 删除原文件
  tar xf bcs-app/build/bcs_web_console-ce-20190619173651.tar.gz -C /data/src/  # 将开源构建的 backend 目录同步到 src下</code></p>
<h2 id="devops">替换 devops</h2>
<ul>
<li>备份原社区版 <code>devops</code> 目录，将开源 <code>devops</code> 代码解压到中控机的 <code>/tmp</code> 目录下。</li>
</ul>
<p><code>bash
   mkdir -p /data/devops_bak
   cp -a /data/src/devops /data/devops_bak  # 备份为开源目录</code>
- 替换 <code>frontend/console</code> 目录</p>
<p><code>bash
  rm -rf /data/src/devops/navigator/frontend/console/* # 删除原文件
  rsync -a bcs-projmgr/frontend/dist/*  /data/src/devops/navigator/frontend/console/ # 更新开源文件</code>
- 替换 <code>gateway/lua</code> 目录</p>
<p><code>bash
  rm -rf /data/src/devops/navigator/gateway/lua/*  # 删除原文件
  rsync -a bcs-projmgr/gateway/lua/*  src/devops/navigator/gateway/lua</code></p>
<ul>
<li>替换 <code>devops/pm</code> 目录
  <code>bash
  rm -f /data/src/devops/pm/project-admin.jar
  rsync -a bcs-projmgr/pm/release/service-project-1.0.0.jar /data/src/devops/pm/project-admin.jar</code></li>
</ul>
<h2 id="bcsdevops">安装 bcs，devops</h2>
<ul>
<li>未安装 bcs</li>
<li>
<p>安装 bcs</p>
<p><code>bash
./bk_install bcs  # 集成安装</code></p>
</li>
<li>
<p>已安装 bcs</p>
</li>
<li>
<p>停进程</p>
<p><code>bash
echo bcs devops | xargs -n 1 ./bkcec stop
echo bcs devops | xargs -n 1 ./bkcec status</code></p>
</li>
<li>
<p>备份原数据</p>
<p><code>bash
ssh $DEVOPS_NAVIGATOR_IP
mv /data/bkce/devops /data/bkce/devops_bak
ssh $DEVOPS_PM_IP
mv /data/bkce/devops/pm /data/bkce/devops/pm_bak  
ssh $BCS_CC_IP
mv /data/bkce/bcs/cc /data/bkce/bcs/cc_bak
ssh $BCS_WEB_CONSOLE_IP
mv /data/bkce/bcs/web_console /data/bkce/bcs/web_console_bak</code></p>
</li>
<li>
<p>更新 devops</p>
<p><code>bash
./bkcec sync bcs
./bkcec install devops
./bkcec upgrade devops
./bkcec start devops
./bkcec status devops</code></p>
</li>
<li>
<p>更新 bcs</p>
<p><code>bash
./bkcec sync bcs
./bkcec install bcs
./bkcec upgrade bcs  
./bkcec start bcs
./bkcec status bcs</code></p>
</li>
</ul>
<h2 id="_1">验证</h2>
<ul>
<li>登陆 PaaS 平台，能否正常打开容器管理平台应用，各页面显示是否正常，数据上报是否正常。</li>
</ul><h1 id="saas">企业版社区版 SaaS 独立域名配置</h1>
<h2 id="_1">说明</h2>
<ul>
<li>假设 PaaS 平台的域名 <code>PAAS_DOMAIN</code> 是: <code>paas.bking.com</code>。</li>
<li>SaaS 通过 PaaS 平台部署到正式环境, 可以通过 <code>http:/paas.bking.com/o/{app_code}/</code> 正常访问到。</li>
<li>此时, 通过配置独立域名, 可以通过 <code>http://{app_code}.bking.com/</code> 访问到。</li>
<li>注意: 独立域名必须同 <code>PAAS_DOMAIN</code>处于同一个一级域名下, 因为要使用 Cookie 进行登录态同步( PaaS 项目配置 <code>BK_COOKIE_DOMAIN</code>)。</li>
<li>该文档支持配置使用独立域名访问 SaaS 应用, 但是保持 <code>/o/{app_code}/</code> 路径, 这样做的好处: 1) 应用代码不需要做修改 。2) 同时独立域名及在桌面访问该应用。</li>
</ul>
<p>目前的流量链路: <code>PaaS 一级 Nginx 服务器 -&gt; APPO 二级 Nginx 服务器 -&gt; {app_code}.sock</code>。</p>
<p>切入点在: <code>PaaS 一级 Nginx 服务器</code> 这里, 增加一个独立域名配置, 使得 <code>独立域名 一级 Nginx 服务器 -&gt; APPO 二级 Nginx 服务器 -&gt; {app_code}.sock</code></p>
<h2 id="nginx">Nginx 配置</h2>
<p>到 <code>PaaS 一级 Nginx 服务器</code> (PaaS 域名配置的 Nginx 服务器), 新增 <code>独立域名配置</code></p>
<p>以开发框架为例: app_code = <code>bk_framework</code>; 由于域名不支持下划线, 配置实例中独立域名使用 <code>bk-framework.bking.com</code></p>
<p>增加 Nginx 配置文件 <code>bk_framework.conf</code>, <code>reload</code> 生效后, 可以通过 <code>http://bk-framework.bking.com/</code> 独立域名访问</p>
<h2 id="http">HTTP 配置</h2>
<div class="codehilite"><pre><span></span>server <span class="o">{</span>
    listen <span class="m">80</span><span class="p">;</span>
    server_name  bk-frameowrk.bking.com<span class="p">;</span>

    client_max_body_size    512m<span class="p">;</span>
    access_log  /data/bkee/logs/nginx/bk_framework_access_fqdn.log<span class="p">;</span>

    <span class="c1"># route to the /o/{app_code}/</span>
    location / <span class="o">{</span>
        proxy_pass http://PAAS_AGENT_PROD/o/bk_framework/<span class="p">;</span>
        proxy_pass_header Server<span class="p">;</span>
        proxy_set_header X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
        proxy_set_header X-Real-IP <span class="nv">$remote_addr</span><span class="p">;</span>
        proxy_set_header X-Scheme <span class="nv">$scheme</span><span class="p">;</span>
        proxy_set_header X-Forwarded-Proto <span class="nv">$scheme</span><span class="p">;</span>
        proxy_set_header X-Forwarded-Host <span class="nv">$http_host</span><span class="p">;</span>
        proxy_set_header Host <span class="nv">$http_host</span><span class="p">;</span>
        proxy_redirect off<span class="p">;</span>
        proxy_read_timeout <span class="m">600</span><span class="p">;</span>
    <span class="o">}</span>

    location ~ ^/o/bk_framework/ <span class="o">{</span>
        proxy_pass http://PAAS_AGENT_PROD<span class="p">;</span>
        proxy_pass_header Server<span class="p">;</span>
        proxy_set_header X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
        proxy_set_header X-Real-IP <span class="nv">$remote_addr</span><span class="p">;</span>
        proxy_set_header X-Scheme <span class="nv">$scheme</span><span class="p">;</span>
        proxy_set_header Host <span class="nv">$http_host</span><span class="p">;</span>
        proxy_set_header X-Forwarded-Proto <span class="nv">$scheme</span><span class="p">;</span>
        proxy_set_header X-Forwarded-Host <span class="nv">$http_host</span><span class="p">;</span>
        proxy_redirect off<span class="p">;</span>
        proxy_read_timeout <span class="m">600</span><span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<h2 id="https">HTTPS 配置</h2>
<p>HTTPS 配置(除了 <code>server_name</code>, <code>access_log</code> 和 <code>location</code>, 其他 SSL 相关配置需要同 <code>PaaS</code> 域名配置)</p>
<div class="codehilite"><pre><span></span>server <span class="o">{</span>
    listen <span class="m">443</span> ssl<span class="p">;</span>
    listen <span class="m">80</span><span class="p">;</span>
    server_name  bk-frameowrk.bking.com<span class="p">;</span>

    client_max_body_size    512m<span class="p">;</span>
    access_log  /data/bkee/logs/nginx/bk_framework_access_fqdn.log<span class="p">;</span>

    include /data/bkee/etc/nginx/bk.ssl<span class="p">;</span>
    <span class="c1"># force https-redirects</span>
    <span class="k">if</span> <span class="o">(</span><span class="nv">$scheme</span> <span class="o">=</span> http<span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="m">301</span> https://<span class="nv">$server_name$request_uri</span><span class="p">;</span>
    <span class="o">}</span>

    <span class="c1"># route to the /o/{app_code}/</span>
    location / <span class="o">{</span>
        proxy_pass http://PAAS_AGENT_PROD/o/bk_framework/<span class="p">;</span>
        proxy_pass_header Server<span class="p">;</span>
        proxy_set_header X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
        proxy_set_header X-Real-IP <span class="nv">$remote_addr</span><span class="p">;</span>
        proxy_set_header X-Scheme <span class="nv">$scheme</span><span class="p">;</span>
        proxy_set_header X-Forwarded-Proto <span class="nv">$scheme</span><span class="p">;</span>
        proxy_set_header X-Forwarded-Host <span class="nv">$http_host</span><span class="p">;</span>
        proxy_set_header Host <span class="nv">$http_host</span><span class="p">;</span>
        proxy_redirect off<span class="p">;</span>
        proxy_read_timeout <span class="m">600</span><span class="p">;</span>
    <span class="o">}</span>

    location ~ ^/o/bk_framework/ <span class="o">{</span>
        proxy_pass http://PAAS_AGENT_PROD<span class="p">;</span>
        proxy_pass_header Server<span class="p">;</span>
        proxy_set_header X-Forwarded-For <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
        proxy_set_header X-Real-IP <span class="nv">$remote_addr</span><span class="p">;</span>
        proxy_set_header X-Scheme <span class="nv">$scheme</span><span class="p">;</span>
        proxy_set_header Host <span class="nv">$http_host</span><span class="p">;</span>
        proxy_set_header X-Forwarded-Proto <span class="nv">$scheme</span><span class="p">;</span>
        proxy_set_header X-Forwarded-Host <span class="nv">$http_host</span><span class="p">;</span>
        proxy_redirect off<span class="p">;</span>
        proxy_read_timeout <span class="m">600</span><span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div><h1 id="_1">蓝鲸组件配置文件</h1>
<h2 id="_2">开源组件</h2>
<p>开源组件的实际配置均在 <code>/data/bkce/etc</code> 目录下，而这些配置文件其实是通过变量替换
<code>/data/src/service/support-files/templates/</code> (模板目录路径随用户解压至的目录而不同) 下的预设模板文件生成的，所以要从源头修改配置应该修改 <code>/data/src</code> 下的，然后通过以下命令同步，并渲染模板文件：</p>
<ul>
<li>./bkcec sync 模块</li>
<li>./bkcec render 模块</li>
</ul>
<p>渲染模板时，bkcec 脚本通过调用 templates_render.rc 里定义的函数 <code>render_cfg_templates</code> 来实现
举例说明，假设 <code>/data/src/service/support-files/templates/</code> 目录下有如下文件：</p>
<ul>
<li>
<p>#etc#nginx#job.conf<br />
那么当模板渲染时，它里面的占位符诸如 <code>__BK_HOME__</code> 会被对应的 <code>$BK_HOME</code> 变量的值替换掉
然后生成 <code>/data/bkce/etc/nginx/job.conf</code> 这个文件。可以发现，脚本将文件名中的 <code>#</code> 替换成 <code>/</code> ，然后放到 <code>$INSTALL_PATH</code> 目录下，也就是默认的 <code>/data/bkce</code></p>
</li>
<li>
<p>kafka#config#server.properties<br />
这个形式的模板文件和上述的不同之处时没有以 <code>#</code> 开头，那么它表示一个相对模块安装路径的配置，也就是
对于 <code>/data/src/service/</code> 来说，它会被安装到 <code>/data/bkce/service</code> ，那么 <code>kafka#config#server.properties</code> 就会生成到 <code>/data/bkce/service/kafka/config/server.properties</code></p>
</li>
<li>
<p>#etc#my.cnf.tpl<br />
这类文件名和第一个不同之处在于多了 <code>.tpl</code> 的后缀名，生成时 tpl 后缀会被去掉。</p>
</li>
</ul>
<p>其他模块文件，以此类推。</p>
<p>以下列举当前所有的开源组件配置文件路径：</p>
<h3 id="nginx">Nginx</h3>
<ul>
<li>
<p>#etc#nginx.conf<br />
Nginx 主配置文件，安装时会 <code>ln -s /data/bkce/etc/nginx.conf /etc/nginx/nginx.conf</code></p>
</li>
<li>
<p>#etc#nginx#paas.conf<br />
PaaS 平台的 Nginx server 配置</p>
</li>
<li>
<p>#etc#nginx#cmdb.conf<br />
配置平台的 Nginx server 配置，主配置会 include <code>/data/bkce/etc/nginx/</code> 下的配置文件</p>
</li>
<li>
<p>#etc#nginx#job.conf
作业平台的 Nginx server 配置</p>
</li>
<li>
<p>#etc#nginx#miniweb.conf<br />
存放 Agent 安装时所需要下载的脚本和依赖软件包</p>
</li>
</ul>
<h3 id="rabbitmq">RabbitMQ</h3>
<ul>
<li>#etc#rabbitmq#rabbitmq-env.conf</li>
<li>#etc#rabbitmq#rabbitmq.config</li>
<li>#etc#rabbitmq#enabled_plugins</li>
</ul>
<h3 id="mongodb">MongoDB</h3>
<ul>
<li>#etc#mongodb.yaml</li>
</ul>
<h3 id="mysql">MySQL</h3>
<ul>
<li>#etc#my.cnf.tpl</li>
</ul>
<h3 id="redis">Redis</h3>
<ul>
<li>#etc#redis.conf</li>
</ul>
<h3 id="consul">Consul</h3>
<p>Consul 的配置文件比较特殊，因为它是全局依赖， Consul 的配置文件会存放在 <code>/data/bkce/etc/consul.conf</code> ，它没有对应的模板文件，是由 <code>/data/install/parse_config</code> 这个脚本来生成。不过 Consul 启动的 supervisor 配置文件模板在：</p>
<ul>
<li>#etc#supervisor-consul.conf</li>
</ul>
<h3 id="zookeeper">ZooKeeper</h3>
<ul>
<li>#etc#zoo.cfg</li>
</ul>
<h3 id="elasticsearch">Elasticsearch</h3>
<ul>
<li>es#config#elasticsearch.yml.tpl</li>
</ul>
<h3 id="kafka">Kafka</h3>
<ul>
<li>kafka#config#server.properties</li>
</ul>
<h3 id="influxdb">InfluxDB</h3>
<ul>
<li>#etc#influxdb.conf</li>
</ul>
<h3 id="beanstalk">Beanstalk</h3>
<ul>
<li>#etc#beanstalkd</li>
</ul>
<h2 id="_3">蓝鲸组件</h2>
<p>蓝鲸组件除了作业平台和管控平台，其他均用 supervisor 来做进程启停，所以都会存在一个对应的 supervisor 进程配置文件
它的标准规范是：#etc#supervisor-模块名-工程名.conf，如果没有子工程，则工程名等于模块名。例如 bkdata 存在三个子工程，所以各自的 supervisor 配置为：</p>
<ul>
<li>#etc#supervisor-bkdata-dataapi.conf</li>
<li>#etc#supervisor-bkdata-databus.conf</li>
<li>#etc#supervisor-bkdata-dataapi.conf</li>
</ul>
<p>故障自愈模块，因为没有子工程，所以它的 supervisor 配置文件为：</p>
<ul>
<li>#etc#supervisor-fta-fta.conf</li>
</ul>
<p>因为 supervisor 配置具有一致性，下面不再具体列举 supervisor 相关配置文件。</p>
<h3 id="cmdb">配置平台 CMDB</h3>
<p>CMDB 的后台是微服务化架构，每个进程对应一个配置文件，所以配置文件模板也有很多，</p>
<ul>
<li>server#conf#模块名.conf</li>
</ul>
<p>模块名对应进程名，比如进程名叫 <code>cmdb_webserver</code> 那它对应的配置文件名叫 webserver.conf</p>
<ul>
<li>#etc#nginx#cmdb.conf</li>
</ul>
<p>CMDB 进程对应的 Nginx 配置，里面会通过 url rewrite 兼容 v2 的接口。cmdb_webserver 提供的 Web 页面
也是经过这层 Nginx 反向代理。</p>
<h3 id="job">作业平台 JOB</h3>
<p>作业平台的配置文件比较简单。一个配置文件，一个启动脚本：</p>
<ul>
<li>#etc#job.conf</li>
</ul>
<p>主配置文件，里面的中文注释非常详尽，这里不再赘述。</p>
<ul>
<li>job#bin#job.sh  </li>
</ul>
<p>Job 进程的启停脚本，里面可以设置一些调试参数，Java 虚拟机内存分配大小等</p>
<h3 id="paas">PaaS</h3>
<p>PaaS 平台 在 src 目录下叫 open_paas 它实际上由 appengine login esb paas 四个子工程组成。</p>
<ul>
<li>#etc#uwsgi-open_paas-工程名.ini  </li>
</ul>
<p>这里工程名用上面四个工程分别替换可得到，是这四个 Python 工程 uwsgi 的配置文件</p>
<p>以下四个分别是对应工程的 配置文件</p>
<ul>
<li>paas#conf#settings_production.py.tpl</li>
<li>login#conf#settings_production.py.tpl</li>
<li>esb#configs#default.py.tpl</li>
<li>appengine#controller#settings.py.tpl</li>
</ul>
<p>其中 ESB 的配置中，配置了访问其他周边模块的接口域名和端口。</p>
<h3 id="gse">GSE</h3>
<p>GSE 目录下的模板文件分为 agent、plugins、proxy、后台。</p>
<p>GSE 后台的配置模板，需要留意的是生成后的配置中监听的 IP 地址是否符合预期：</p>
<ul>
<li>#etc#gse#api.conf</li>
<li>#etc#gse#btsvr.conf</li>
<li>#etc#gse#data.conf</li>
<li>#etc#gse#dba.conf</li>
<li>#etc#gse#task.conf</li>
</ul>
<p>GSE Proxy 后台的配置模板:</p>
<ul>
<li>proxy#etc#btsvr.conf</li>
<li>proxy#etc#proxy.conf</li>
<li>proxy#etc#transit.conf</li>
</ul>
<p>GSE Agent 的配置模板，<code>*</code> 表示匹配所有的，这里 Agent 按系统和 CPU 架构区分了不同的目录</p>
<ul>
<li>agent_*#etc#agent.conf</li>
<li>agent_*#etc#iagent.conf</li>
<li>agent_*#etc#procinfo.conf</li>
</ul>
<p>GSE agent plugins 的配置模板</p>
<ul>
<li>plugins_*#etc#basereport.conf</li>
<li>plugins_*#etc#alarm.json</li>
</ul>
<h3 id="paas_agent">paas_agent</h3>
<p>paas_agent 是 appo、和 appt 模块对应的后台代码目录，它的配置文件由两部分构成：</p>
<ul>
<li>#etc#nginx.conf  #etc#nginx#paasagent.conf  </li>
</ul>
<p>paas_agent 依赖一个 Nginx 做路由转发，这里是它的 Nginx 配置</p>
<ul>
<li>#etc#paas_agent_config.yaml.tpl  </li>
</ul>
<p>paas_agent 的主配置，需要特别注意的是，这里的 <code>sid</code> 和 <code>token</code> 是激活 paas_agent 成功后，获取返回的字符串自动填充的，里面的配置应该和开发者中心，服务器信息页面看到的一致</p>
<h3 id="bkdata">BKDATA</h3>
<p>BKDATA 分为<code>dataapi</code> 、 <code>databus</code> 、 <code>monitor</code> 三个工程，dataapi 是 Python 工程，databus 是 Java 工程，monitor 是 Python 工程。</p>
<p>dataapi 的配置：</p>
<ul>
<li>dataapi#conf#dataapi_settings.py</li>
<li>dataapi#pizza#settings_default.py</li>
<li>dataapi#tool#settings.py</li>
</ul>
<p>databus 的配置：</p>
<ul>
<li>databus#conf#es.cluster.properties</li>
<li>databus#conf#jdbc.cluster.properties</li>
<li>databus#conf#tsdb.cluster.properties</li>
<li>databus#conf#etl.cluster.properties</li>
<li>databus#conf#redis.cluster.properties</li>
</ul>
<p>monitor 的配置：</p>
<ul>
<li>monitor#bin#environ.sh</li>
<li>monitor#conf#worker#production#community.py</li>
</ul>
<h3 id="fta">故障自愈 FTA</h3>
<p>故障自愈后台的配置</p>
<ul>
<li><code>fta#project#settings_env.py</code></li>
</ul>
<h2 id="_4">常用配置调整</h2>
<p>调整后的配置模板文件请自行备份好，如果遇到升级，需要手工对比后再覆盖，如果升级后的文件没有新增配置，可以直接覆盖，但如果升级后的配置文件有新增，需要自行处理合并。</p>
<h3 id="redis_1">调整 Redis 使用的最大内存大小</h3>
<p>编辑 <code>/data/src/service/support-files/templates/#etc#redis.conf</code></p>
<p>插入一行，比如限制最大使用 4GB 内存：</p>
<div class="codehilite"><pre><span></span>maxmemory 4G
</pre></div>


<p>再执行以下命令生效：</p>
<div class="codehilite"><pre><span></span>./bkcec sync redis
./bkcec render redis
./bkcec stop redis
./bkcec start redis
</pre></div>


<h3 id="bkdata-databus">调整 BKDATA 的 databus 内存使用大小</h3>
<p>databus 目前有五个进程，对应的配置文件分别是：</p>
<div class="codehilite"><pre><span></span>/data/src/bkdata/support-files/templates/databus#conf#es.cluster.properties
/data/src/bkdata/support-files/templates/databus#conf#etl.cluster.properties
/data/src/bkdata/support-files/templates/databus#conf#jdbc.cluster.properties
/data/src/bkdata/support-files/templates/databus#conf#redis.cluster.properties
/data/src/bkdata/support-files/templates/databus#conf#tsdb.cluster.properties
</pre></div>


<p>分别修改这五个文件里的 "deploy.cluster.memory.max" 的值，根据实际情况调大小。原则：如果内存够用，但 CPU 占用很高，适当调大；如果内存不够用，CPU 占用正常，可以适当调小。</p>
<h3 id="es">调整 ES 的内存使用大小</h3>
<p>修改 <code>/data/bkce/service/es/config/jvm.options</code> 里的</p>
<div class="codehilite"><pre><span></span>-Xms1G
-Xmx1G
</pre></div>


<p>为合适的数值，如果不需要用日志检索，那可以尽量调低。</p>
<h3 id="kafka_1">调整 Kafka 的内存使用大小</h3>
<p>修改 <code>/data/bkce/service/kafka/bin/kafka-server-start.sh</code> 里的</p>
<p>KAFKA_HEAP_OPTS="-Xmx1G -Xms1G"</p>
<h3 id="fta_1">调整 FTA 进程数</h3>
<p><code>/data/bkce/etc/supervisor-fta-fta.conf</code> 里 numprocs 和 gunicorn 的进程数</p>
<h3 id="bkdata-dataapi-worker">调整 Bkdata-dataapi 的 worker 数</h3>
<p><code>/data/bkce/etc/supervisor-bkdata-dataapi.conf</code> 里的 gunicorn 的 -w 参数</p>
<h3 id="bkdata-monitor">调整 Bkdata-monitor 的进程数</h3>
<p><code>/data/bkce/etc/supervisor-bkdata-monitor.conf</code> 里的 numprocs 配置项</p>
<h3 id="paas-worker">调整 PaaS 的 worker 数量</h3>
<p><code>/data/bkce/etc/uwsgi-open_paas*.ini</code> 里的 workers 配置</p>
<h3 id="job_1">调整 JOB 的内存使用大小</h3>
<p><code>/data/bkce/job/job/bin/job.sh里startup()</code> 函数下的 JOB_JAVA_OPTS="-Xms256M -Xmx256M"</p><h1 id="_1">蓝鲸日常维护</h1>
<h2 id="_2">统一术语</h2>
<ul>
<li>
<p><strong>INSTALL_PATH：</strong> 安装路径，默认为 <code>/data/bkce</code></p>
</li>
<li>
<p><strong>CTRL_PATH：</strong> 安装维护脚本所在目录，默认为 <code>/data/install</code></p>
</li>
<li>
<p><strong>PKG_SRC_PATH：</strong> 组件原始包解压目录，默认为 <code>/data/src</code>
s</p>
</li>
<li>
<p><strong>中控机：</strong> 安装蓝鲸后台服务器中，选一台作为中控机，安装蓝鲸和运维蓝鲸，一般均从这台机器开始</p>
</li>
<li>
<p><strong>source utils.fc：</strong> 一些操作需要加载蓝鲸环境变量和函数后才能调用，此为 <code>cd $CTRL_PATH/ &amp;&amp; source utils.fc</code> 的简写</p>
</li>
<li>
<p><strong>bkcec <command> <module>：</strong> 若无特殊说明，含义是：<code>cd $CTRL_PATH &amp;&amp; ./bkcec &lt;command&gt; &lt;module&gt;</code></p>
</li>
</ul>
<p>下面提到路径时，均以默认路径为例，请根据实际安装路径修改相关命令</p><h1 id="_1">蓝鲸日常维护</h1>
<h2 id="_2">登陆指定服务器</h2>
<p>一般维护操作时，均从中控机出发，跳转到其他模块服务器进行操作</p>
<p>假设发现作业平台模块启动失败，想登陆到作业平台模块所在服务器查看相关日志：</p>
<div class="codehilite"><pre><span></span><span class="nb">source</span> utils.fc

<span class="c1"># 这个命令用来加载环境变量（/data/install/*.env）和蓝鲸安装维护的函数（/data/install/*.{rc,fc})。</span>
<span class="c1"># 在该文档中，凡是提到查看 xx 函数的地方，可以用以下方法找到：</span>
<span class="c1"># source utils.fc;  type 函数名，例如想看 initdata_rabbitmq 做了什么事情，请运行 type initdata_rabbitmq ，返回的内容里可能也有没见过的函数调用，那继续使用 `type 函数名` 来查看</span>
<span class="c1"># grep &quot;函数名 *()&quot; *.rc *.fc 通过过滤函数定义，来寻找位置</span>
<span class="c1">#  编辑器内的搜索跳转</span>
</pre></div>


<div class="codehilite"><pre><span></span>ssh <span class="nv">$JOB_IP</span>
<span class="c1"># 因为 /data/install/config.env 里通过解析 install.config ，生成了模块对应的 IP ，所以，我们可以直接用 $MODULE_IP 这样的方式来访问。MODULE，用 install.config 里模块名的大写形式进行替换。譬如 bkdata 所在的 IP 为 $BKDATA_IP ，配置平台所在IP为 $CMDB_IP ，依此类推。</span>
<span class="c1"># 也可以输入 $ 符号后，用 &lt;tab&gt; 补全试试。</span>
</pre></div><h1 id="_1">蓝鲸日常维护</h1>
<h2 id="_2">查看日志</h2>
<p>日志文件统一在 <code>/data/bkce/logs/</code> 下，按模块名，组件名分目录存放。</p>
<p>假设需要查看作业平台的日志：</p>
<div class="codehilite"><pre><span></span><span class="nb">cd</span> /data/bkce/logs/job
</pre></div>


<p>组件日志均在对应部署主机 $INSTALL_PATH/logs/$MODULE/ 目录下。</p>
<p>SaaS 较为特殊，在部署了 paas_agent 的主机 <code>/data/bkce/paas_agent/apps/logs</code> 下，根据 AppCode 名分目录存放。</p><h1 id="_1">蓝鲸日常维护</h1>
<h2 id="_2">组件启停</h2>
<p>一般情况，可以在中控机用 <code>bkcec start/stop &lt;module&gt; &lt;project&gt;</code> 方式来整体启停进程，但了解每个组件的手动启停方式也有助于运维好蓝鲸。另外需要特别注意的是，开源组件里分布式架构的 <code>Kafka</code> 、 <code>ZK</code> 、 <code>Consul</code> ，这些尽量逐个启停。</p>
<p>下面分三类来介绍不同组件的启停命令</p>
<h2 id="supervisor">Supervisor 托管</h2>
<p>supervisord 和 supervisorctl 都会使用 Python 虚拟环境 (virtualenv) 来单独安装隔离。每个模块对应的虚拟环境名称，可以在机器上输入 <code>workon</code> 命令查看。</p>
<p>特别注意的是：Consul 使用全局的 <code>/opt/py27/bin/supervisord</code> 和 <code>/opt/py27/bin/supervisorctl</code></p>
<p>Supervisor 托管的分两级维度， <code>module</code> 和 <code>project</code> ， <code>project</code> 可以单独启停。</p>
<p>例如：</p>
<div class="codehilite"><pre><span></span>./bkcec stop paas esb
./bkcec start paas esb
</pre></div>


<p>使用 Supervisor 托管的模块如下：</p>
<ul>
<li>
<p>bkdata/{monior,databus,dataapi}</p>
</li>
<li>
<p>paas_agent</p>
</li>
<li>
<p>open_paas</p>
</li>
<li>
<p>fta ( FTA 比较特殊，单独封装了/data/bkce/fta/fta/bin/fta.sh 启停脚本)</p>
</li>
<li>
<p>cmdb-server （配置平台的后台进程）</p>
</li>
<li>
<p>consul （使用全局 Supervisor ）</p>
</li>
</ul>
<p>以 bkdata/dataapi 为例，单独启动 dataapi 的进程：</p>
<div class="codehilite"><pre><span></span><span class="c1"># 进入虚拟环境</span>
workon dataapi

<span class="c1"># 启动</span>
supervisord -c /data/bkce/etc/supervisor-bkdata-dataapi.conf

<span class="c1">#临时停止，但不退出 supervisord</span>
supervisorctl -c /data/bkce/etc/supervisor-bkdata-dataapi.conf stop all

<span class="c1"># 完全退出，包括 supervisord</span>
supervisorctl -c /data/bkce/etc/supervisor-bkdata-dataapi.conf shutdown
</pre></div>


<p>其他模块依此类推</p>
<h2 id="gse">GSE 启停方法</h2>
<p>GSE 组件分为 GSE 后台，GSE 客户端，GSE 插件，分别对应三个不同的启停进程：</p>
<ul>
<li>
<p>GSE 后台服务端： <code>/data/bkce/gse/server/bin/gsectl [start|stop|restart] &lt;module&gt;</code></p>
</li>
<li>
<p>GSE 客户端（Agent）:  <code>/usr/local/gse/agent/bin/gsectl [start|stop|restart]</code></p>
</li>
<li>
<p>GSE 插件进程（plugin）： <code>/usr/local/gse/plugins/bin/{stop,start,restart}.sh &lt;module&gt;</code></p>
</li>
</ul>
<h2 id="_3">开源组件</h2>
<h3 id="java">Java</h3>
<ul>
<li>
<p>Elasticsearch: 切换到 ES 用户执行 /data/bkce/service/es/bin/es.sh start</p>
</li>
<li>
<p>ZooKeeper: /data/bkce/service/zk/bin/zk.sh start</p>
</li>
<li>
<p>Kafka: /data/bkce/service/kafka/bin/kafka.sh start</p>
</li>
</ul>
<h3 id="golangcc">Golang/C/C++</h3>
<ul>
<li>
<p>Nginx: nginx 或者 nginx -s reload</p>
</li>
<li>
<p>Beanstalkd: <code>nohup beastalkd -l $LAN_IP -p $BEANSTALK_PORT &amp;&gt;/dev/null &amp;</code></p>
</li>
<li>
<p>MySQL: /data/bkce/service/mysql/bin/mysql.sh start</p>
</li>
<li>
<p>MongoDB: /data/bkce/service/mongodb/bin/mongodb.sh start</p>
</li>
</ul>
<h3 id="erlang">Erlang</h3>
<ul>
<li>RabbitMQ: <code>systemctl start rabbitmq-server</code></li>
</ul>
<h2 id="_4">蓝鲸组件</h2>
<ul>
<li>
<p>License: <code>/data/bkce/license/license/bin/license.sh start</code></p>
</li>
<li>
<p>JOB: <code>/data/bkce/job/job/bin/job.sh start</code></p>
</li>
<li>
<p>APPO / APPT : 从 <code>/data/bkce/paas_agent/apps/Envs/*</code> 下遍历 workon home ，然后使用 <code>apps</code> 用户调用 supervisord 拉起进程。</p>
</li>
</ul>
<h2 id="_5">第三方组件</h2>
<ul>
<li>bk_network: <code>/data/bkce/bknetwork/bknetwork/bin/nms.sh start &gt;/dev/null 2&gt;&amp;1</code></li>
</ul><h1 id="_1">蓝鲸日常维护</h1>
<h2 id="_2">磁盘清理</h2>
<p>可能产生比较大数据量的目录有：</p>
<ul>
<li>
<p>/data/bkce/logs</p>
</li>
<li>
<p>/data/bkce/public</p>
</li>
<li>
<p>/data/bkce/service</p>
</li>
</ul>
<p>logs 目录可以按需设置自动清理 N 天前的日志。</p>
<p>public 目录一般不能手动删除，一般比较大的组件可能有</p>
<ul>
<li>
<p>MySQL 数据库太大</p>
</li>
<li>
<p>Kafka 数据</p>
</li>
<li>
<p>Elasticsearch 数据</p>
</li>
</ul>
<h2 id="mysql">MySQL 日志清理</h2>
<blockquote>
<p>MySQL中的 binlog 日志记录了数据库中数据的变动，便于对数据的基于时间点和基于位置的恢复，但是 binlog 也会日渐增大，占用很大的磁盘空间，因此，要对 binlog 使用正确安全的方法清理掉一部分没用的日志。</p>
</blockquote>
<p><strong>注意：</strong> 下述方法仅供参考，具体以实际生产环境情况进行调整。</p>
<p><strong>手动清理 binlog</strong></p>
<p>若社区版设置了多台 MySQL，需查看主库和从库正在使用的 binlog 是哪个文件</p>
<div class="codehilite"><pre><span></span>```<span class="nv">bash</span>
    <span class="nv">MySQL</span> [<span class="ss">(</span><span class="nv">none</span><span class="ss">)</span>]<span class="o">&gt;</span> <span class="k">show</span> <span class="nv">master</span> <span class="nv">status</span>\<span class="nv">G</span>
<span class="o">***************************</span> <span class="mi">1</span>. <span class="nv">row</span> <span class="o">***************************</span>
            <span class="nv">File</span>: <span class="nv">mysql</span><span class="o">-</span><span class="nv">bin</span>.<span class="mi">000006</span>
        <span class="nv">Position</span>: <span class="mi">97013298</span>
    <span class="nv">Binlog_Do_DB</span>:
<span class="nv">Binlog_Ignore_DB</span>:
<span class="mi">1</span> <span class="nv">row</span> <span class="nv">in</span> <span class="nv">set</span> <span class="ss">(</span><span class="mi">0</span>.<span class="mi">00</span> <span class="nv">sec</span><span class="ss">)</span>

<span class="nv">MySQL</span> [<span class="ss">(</span><span class="nv">none</span><span class="ss">)</span>]<span class="o">&gt;</span> <span class="k">show</span> <span class="nv">slave</span> <span class="nv">status</span>\<span class="nv">G</span>
<span class="nv">Empty</span> <span class="nv">set</span> <span class="ss">(</span><span class="mi">0</span>.<span class="mi">00</span> <span class="nv">sec</span><span class="ss">)</span>
```
</pre></div>


<p>删除 binlog 日志之前，对 binlog 进行备份。</p>
<p>清理方法一：删除指定日期以前的日志索引中binlog日志文件
    <code>bash
    purge master logs before '201x-xx-xx 17:20:00';</code></p>
<p>清理方法二：删除指定日志文件的日志索引中binlog日志文件
    <code>bash
    purge master logs to'mysql-bin.00000x';</code></p>
<p><strong>注意：</strong></p>
<ul>
<li>
<p>时间和文件名一定不可以写错，尤其是时间中的年和文件名中的序号，以防不小心将正在使用的 binlog 删除。</p>
</li>
<li>
<p>切勿删除正在使用的 binlog。</p>
</li>
<li>
<p>使用该语法，会将对应的文件和 mysql-bin.index 中的对应路径删除。</p>
</li>
</ul>
<p><strong>自动清理 binlog 日志</strong></p>
<p>使用如下方法查询当前 binlog 的过期时间，若为 0 表示不过期。</p>
<div class="codehilite"><pre><span></span>mysql&gt; show variables like <span class="s1">&#39;expire_logs_days&#39;</span><span class="p">;</span>
+------------------+-------+
<span class="p">|</span> Variable_name    <span class="p">|</span> Value <span class="p">|</span>
+------------------+-------+
<span class="p">|</span> expire_logs_days <span class="p">|</span>   <span class="m">0</span>   <span class="p">|</span>
+------------------+-------+
</pre></div>


<p>使用如下方法设置 binlog 过期时间，设置 30 表示 30 天后自动清理之前的过期日志。该方法只是临时启用，重启 MySQL 服务之后则失效。永久生效则需将参数添加至 MySQL 配置文件。</p>
<div class="codehilite"><pre><span></span>mysql&gt; <span class="nb">set</span> global <span class="nv">expire_logs_days</span> <span class="o">=</span> <span class="m">30</span><span class="p">;</span>
</pre></div>


<h2 id="kafka">Kafka 日志清理</h2>
<blockquote>
<p>Kafka 将数据持久化到了硬盘上，允许配置一定的策略对数据清理，清理的策略有两个，删除和压缩。
<strong>注意：</strong> 下面清理策略，请根据实际业务，服务器状况，及需求来定制。</p>
</blockquote>
<p><strong>方法一：</strong> 调整配置文件</p>
<div class="codehilite"><pre><span></span><span class="c1"># 配置文件位置</span>
/data/bkce/service/kafka/config/server.properties

<span class="c1"># 可以增加 log.cleanup.policy 这个数据清理方式设置，此行为为删除动作</span>
log.cleanup.policy<span class="o">=</span>delete

<span class="c1"># 下面有 2 种方式，保留时间或大小，请自行根据实际情况调整此处设置，1G 为 1073741824 。具体保留大小根据实际情况设置</span>
<span class="c1"># 注意：下面为直接删除，删除后的消息不可恢复</span>
log.retention.hours<span class="o">=</span><span class="m">168</span>（超过指定时间168小时后，删除旧的消息）
log.retention.bytes<span class="o">=</span><span class="m">10737418240</span>（超过指定大小 10G 后，删除旧的消息）
</pre></div>


<p>设置完毕后，重启服务来生效。</p>
<p><strong>方法二：</strong> Kafka 设置 Topic 过期时间</p>
<div class="codehilite"><pre><span></span><span class="c1"># 设置过期时间，只能用毫秒（retention.ms），或者 bytes（retention.bytes）</span>

$ /data/bkce/service/kafka/bin/kafka-topics.sh --zookeeper zk.service.consul:2181/common_kafka --topic snapshot2 --alter --config retention.ms<span class="o">=</span><span class="m">17280000</span>
$ WARNING: Altering topic configuration from this script has been deprecated and may be removed in future releases.
          Going forward, please use kafka-configs.sh <span class="k">for</span> this functionality
$ updated config <span class="k">for</span> topic <span class="s2">&quot;snapshot2&quot;</span>
</pre></div>


<h2 id="elasticsearch">Elasticsearch 日志清理</h2>
<ul>
<li>
<p>查看目前所有的索引
    <code>bash
    source /data/install/utils.fc  
    curl -s "http://$ES_IP:$ES_REST_PORT/_cat/indices"</code></p>
</li>
<li>
<p>删除索引
  <code>bash
  # index_name 是索引名称
    curl -XDELETE http://$ES_IP:$ES_REST_PORT/index_name</code>
    <img alt="es索引" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/bk_search_log.png" /></p>
</li>
</ul><h1 id="_1">蓝鲸日常维护</h1>
<h2 id="_2">变更域名</h2>
<ul>
<li>
<p>修改 globale.env 中的域名配置信息。</p>
</li>
<li>
<p>修改 每台机器上的 <code>/etc/hosts</code> 匹配上新的域名。</p>
</li>
<li>
<p>修改完成后按如下命令顺序执行：</p>
</li>
</ul>
<div class="codehilite"><pre><span></span>./bkcec sync common
<span class="nb">echo</span> fta bkdata job cmdb paas nginx <span class="p">|</span> xargs -n <span class="m">1</span> ./bkcec stop
<span class="nb">echo</span> fta bkdata job cmdb paas nginx <span class="p">|</span> xargs -n <span class="m">1</span> ./bkcec render
<span class="nb">echo</span> nginx paas cmdb job bkdata fta <span class="p">|</span> xargs -n <span class="m">1</span> ./bkcec start
</pre></div>


<p>如果有安装 SaaS ，到 <strong>开发者中心-Smart 应用-已上线</strong> 的 SaaS 操作栏里的【部署 】按钮，重新【一键部署】 SaaS。</p><h1 id="_1">蓝鲸日常维护</h1>
<h2 id="http-https">全站 HTTP 切换 HTTPS</h2>
<ul>
<li>
<p>修改 globale.env 中的 HTTP_SCHEMA='https'。</p>
</li>
<li>
<p>修改完成后按如下命令顺序执行。</p>
</li>
<li>
<p>全站 https 切换 http ，只需要修改 globale.env 中的 HTTP_SCHEMA='http' 即可，然后执行相同步骤即可</p>
</li>
</ul>
<div class="codehilite"><pre><span></span>./bkcec sync common
./bkcec install nginx
./bkcec stop nginx
./bkcec start nginx
<span class="nb">echo</span>  job cmdb paas  <span class="p">|</span> xargs -n <span class="m">1</span> ./bkcec stop
<span class="nb">echo</span>  job cmdb paas  <span class="p">|</span> xargs -n <span class="m">1</span> ./bkcec render
<span class="nb">echo</span>  job cmdb paas  <span class="p">|</span> xargs -n <span class="m">1</span> ./bkcec start
<span class="nb">echo</span>  job cmdb paas  <span class="p">|</span> xargs -n <span class="m">1</span> ./bkcec status
</pre></div><h1 id="_1">蓝鲸日常维护</h1>
<h2 id="default_http_port">变更 DEFAULT_HTTP_PORT 端口</h2>
<p>安装好后的蓝鲸访问端口默认是 80 ，如果安装成功后想修改它，需要按以下步骤：</p>
<ol>
<li>
<p>修改 ports.env 文件里的 <code>DEFAULT_HTTP_PORT</code> 值为新的端口</p>
</li>
<li>
<p>同步配置到其他机器：<code>./bkcec sync common</code></p>
</li>
<li>
<p>渲染涉及到的进程的模块文件</p>
<p><code>bash
./bkcec render $module</code>
知道如何操作以及为什么需要这样操作：</p>
</li>
</ol>
<p>修改 DEFAULT_HTTP_PORT 后，PAAS_HTTP_PORT CMDB_HTTP_PORT JOB_HTTP_PORT，这些端口都发生了变化。我们需要了解哪些配置文件模板引用了他们。所以，执行命令：</p>
<div class="codehilite"><pre><span></span>grep -lrE <span class="s2">&quot;(JOB|CMDB|PAAS|DEFAULT)_HTTP_PORT&quot;</span> /data/src/*/support-files/
</pre></div>


<p>发现，涉及的文件所在模块为：<code>bkdata,cmdb,fta,gse,job,miniweb,open_paas,paas_agent,nginx</code>。所以这些文件均需要重新 <code>render</code> 配置，然后重启模块生效。</p>
<p>以下模块需要 <code>render</code> 操作：</p>
<div class="codehilite"><pre><span></span><span class="nb">echo</span> cmdb job gse paas appo bkdata fta <span class="p">|</span> xargs -n <span class="m">1</span> ./bkcec render
</pre></div>


<p>APPO(paas_agent) 的配置需要一个特殊操作：</p>
<div class="codehilite"><pre><span></span>./bkcec initdata appo
</pre></div>


<p>Nginx 和 miniweb 较为特殊，需要以下命令：</p>
<div class="codehilite"><pre><span></span>./bkcec install nginx
./bkcec stop nginx
./bkcec start nginx
</pre></div>


<p>重启其余进程:</p>
<div class="codehilite"><pre><span></span><span class="k">for</span> module in cmdb job gse paas appo bkdata fta<span class="p">;</span> <span class="k">do</span> ./bkcec stop <span class="nv">$module</span> <span class="p">;</span> sleep <span class="m">2</span><span class="p">;</span> ./bkcec start <span class="nv">$module</span> <span class="p">;</span><span class="k">done</span>
</pre></div><h1 id="_1">蓝鲸日常维护</h1>
<h2 id="_2">更新证书</h2>
<p>有时候 GSE 和 License 所在服务器的 MAC 地址发生了变化，此时证书需要重新从官网生成下载，然后操作更新证书的步骤</p>
<p>中控机上解压新的证书</p>
<div class="codehilite"><pre><span></span><span class="nb">cd</span> /data/src/cert <span class="o">&amp;&amp;</span> rm -f *
tar -xvf /data/ssl_certificates.tar.gz -C /data/src/cert/
</pre></div>


<p>操作更新相关组件</p>
<div class="codehilite"><pre><span></span><span class="nb">source</span> /data/install/utils.fc
<span class="k">for</span> ip in <span class="si">${</span><span class="nv">ALL_IP</span><span class="p">[@]</span><span class="si">}</span><span class="p">;</span> <span class="k">do</span>
    _rsync -a <span class="nv">$PKG_SRC_PATH</span>/cert/ root@<span class="nv">$ip</span>:<span class="nv">$PKG_SRC_PATH</span>/cert/
    _rsync -a <span class="nv">$PKG_SRC_PATH</span>/cert/ root@<span class="nv">$ip</span>:<span class="nv">$INSTALL_PATH</span>/cert/
<span class="k">done</span>

 <span class="k">for</span> ip in <span class="si">${</span><span class="nv">JOB_IP</span><span class="p">[@]</span><span class="si">}</span><span class="p">;</span> <span class="k">do</span>
     rcmd root@<span class="nv">$ip</span> <span class="s2">&quot;gen_job_cert&quot;</span>
 <span class="k">done</span>

./bkcec stop license
./bkcec start license
./bkcec stop job
./bkcec start job
./bkcec install gse <span class="m">1</span>
./bkcec stop gse
./bkcec start gse
./bkcec stop bkdata
./bkcec start bkdata
./bkcec stop fta
./bkcec start fta
</pre></div>


<p>Proxy 和 Agent 的更新，需要把新的 cert 目录传到对应机器的路径：</p>
<ul>
<li>agent: <code>/usr/local/gse/agent/cert/</code></li>
<li>proxy: <code>/usr/local/gse/proxy/cert/</code></li>
</ul>
<p>然后重启进程：</p>
<ul>
<li>Proxy 和 Agent 均为：<code>/usr/local/gse/agent/bin/gsectl restart</code></li>
</ul><h1 id="_1">蓝鲸日常维护</h1>
<h2 id="_2">迁移服务</h2>
<p>假设想将 BKDATA 模块从目前混搭的服务器上，迁移到一台新机器，可以按如下步骤操作：</p>
<ul>
<li>停掉原来服务器上的 BKDATA 进程 <code>./bkcec stop bkdata</code></li>
<li>修改 install.config 文件，新增一行 <code>$ip bkdata</code> IP 为待迁移的机器 IP ，删除原 ip 所在行的 <code>bkdata</code></li>
<li>新机器配置好中控机的 SSH 免密登陆</li>
</ul>
<p>除非特别指出，在中控机上依次执行以下命令，每一个命令成功后，再继续下一个：</p>
<div class="codehilite"><pre><span></span><span class="c1"># 同步 install.config 更改</span>
./bkcec sync common

<span class="c1">#  同步基础依赖 Consul</span>
./bkcec sync consul

<span class="c1"># 同步 BKDATA 模块</span>
./bkcec sync bkdata

<span class="c1"># 安装 Consul</span>
./bkcec install consul

<span class="c1"># 重启 Consul</span>
./bkcec stop consul
./bkcec start consul

<span class="c1"># 安装 BKDATA</span>
./bkcec install bkdata

<span class="c1"># 给新机器授予 MySQL 权限</span>
./bkcec initdata mysql

<span class="c1">#  给新的 BKDATA 补上初始化标记文件</span>
ssh <span class="nv">$BKDATA_IP</span> <span class="s1">&#39;touch /data/bkce/.dataapi_snaphost&#39;</span>

<span class="c1"># 启动新的 BKDATA</span>
./bkcec start bkdata
</pre></div>


<p>登陆到老的 BKDATA 机器，将标记文件 /data/bkce/.installed_module 文件中的 BKDATA 行删除：</p>
<div class="codehilite"><pre><span></span>sed -i <span class="s1">&#39;/bkdata/d&#39;</span> /data/bkce/.installed_module
</pre></div>


<p>其余模块的迁移流程大致和 BKDATA 类似。只是部分模块有一些特殊注意事项需要额外做一些操作。列举如下：</p>
<ul>
<li>PaaS 迁移。因为 PaaS IP 地址发生了改变，而作业平台的配置文件 job.conf 中，有一项 api.ip.whitelist 配置，需要随之修改。可以在迁移完 PaaS 后运行如下命令自动修改生效
  <code>bash
  ./bkcec render job
  ./bkcec stop job
  ./bkcec start job</code>
  PaaS 迁移后，Nginx 上对 PaaS 的反向代理配置也需要跟随改变，Nginx 需要重新渲染配置，重新加载配置。</li>
</ul><h1 id="_1">蓝鲸日常维护</h1>
<h2 id="appt">单机部署增加一台 APPT</h2>
<p>使用单机部署方案，虽然 install.config 里自动配置了 APPT 和 APPO 两个模块，但实际生效的只有 APPO 。部署蓝鲸官方的 SaaS，只需要 APPO 即可。</p>
<p>用户如果有自己开发 SaaS 应用，提测时，平台会提示没有可用的测试环境。这时需要扩充一个 APPT 环境。运维操作如下, 以下命令均在中控机上执行：</p>
<ol>
<li>
<p>新增一台服务器 (假设 IP 为 10.0.0.2) 作为 APPT ，机器配置 1 核 1G 以上即可，跑的测试 SaaS 越多，配置需求越高。</p>
</li>
<li>
<p>登陆中控机，编辑 install.config , 新增一行
    <code>bash
    10.0.0.2 appt</code>
    并将原来 install.config 第一行中的 <code>APPO,APPT</code> 换成 <code>APPO</code></p>
</li>
<li>
<p>对 10.0.0.2 配置好 SSH 免密登陆。</p>
</li>
<li>
<p>依次运行以下命令开始安装 APPT</p>
<p><code>bash
./bkcec sync common
./bkcec sync consul
./bkcec sync appt
./bkcec install consul
./bkcec stop consul
./bkcec start consul
./bkcec install appt
./bkcec initdata appt
./bkcec start appt
./bkcec activate appt</code>
5. 查看开发者中心-&gt;服务器信息中，类别为《测试服务器》的信息是否正确，状态是否激活。</p>
</li>
</ol><h1 id="_1">蓝鲸日常维护</h1>
<h2 id="_2">健康检查</h2>
<p>蓝鲸产品后台提供了健康检查的接口，用 HTTP GET 请求访问，接口地址和端口用变量表达：</p>
<div class="codehilite"><pre><span></span><span class="nb">cd</span> /data/install <span class="o">&amp;&amp;</span> <span class="nb">source</span> utils.fc

<span class="c1"># PAAS 注意 URL 末尾带上/</span>
curl http://<span class="nv">$PAAS_FQDN</span>:<span class="nv">$PAAS_HTTP_PORT</span>/healthz/

<span class="c1"># 配置平台 (beta)，目前版本不够准确</span>
curl http://<span class="nv">$CMDB_IP</span>:<span class="nv">$CMDB_API_PORT</span>/healthz

<span class="c1"># 作业平台</span>
curl http://<span class="nv">$JOB_FQDN</span>:<span class="nv">$PAAS_HTTP_PORT</span>/healthz
</pre></div>


<p>蓝鲸监控 SaaS 的监控检查接口，可以用浏览器直接访问:</p>
<div class="codehilite"><pre><span></span>http://<span class="nv">$PAAS_FQDN</span>:<span class="nv">$PAAS_HTTP_PORT</span>/o/bk_monitor/healthz/
</pre></div><h1 id="_1">蓝鲸日常维护</h1>
<h2 id="_2">机器重启后</h2>
<ul>
<li>确认 /etc/resolv.conf 里第一个 nameserver 是 <code>127.0.0.1</code>， <code>option</code> 选项不能有 <code>rotate</code></li>
<li>检查重启机器的 crontab ，是否有自动拉起进程的配置 <code>crontab -l | grep process_watch</code> ，重启后的自动拉起主要靠 crontab</li>
<li>中控机上确认所有进程状态： <code>./bkcec status all</code> , 正常情况下应该都是正常拉起 <code>RUNNING</code> 状态，如果有 <code>EXIT</code> 的，则尝试手动拉起。手动拉起的具体方法参考 <a href="../../维护手册/日常维护/start_stop.md">组件的启动停止</a></li>
<li>
<p>如果社区版所有机器同时重启，很大概率会有很多进程启动失败，因为不同机器上组件恢复的时间没法控制，导致依赖的组件还没启动起来，导致失败，连锁反应。所以这种情况，遵循和安装时的启动原则:</p>
<ol>
<li>
<p>先启动 DB</p>
</li>
<li>
<p>启动依赖的其他开源组件及服务</p>
</li>
<li>
<p>启动蓝鲸产品</p>
</li>
</ol>
</li>
<li>
<p>如果已经部署过 SaaS ，那么手动拉起。
    <code>bash
    ./bkcec start saas-o # 正式环境
    ./bkcec start saas-t # 测试环境</code></p>
</li>
</ul><h1 id="v31-v41">社区版 V3.1 升级至 V4.1 指引</h1>
<h2 id="_1">升级前准备</h2>
<p><strong>假设 src 和 install 在 /data 下，按各自实际情况调整，务必按照顺序执行</strong></p>
<p><strong>请务必认真详细阅读每一个文字并理解后才能操作升级事宜</strong></p>
<h2 id="_2">注意事项（风险点说明）</h2>
<ol>
<li>
<p>本次升级为停服升级，请确保通知到用户后再开始执行升级操作。</p>
</li>
<li>
<p>更新前请自行做好数据备份工作</p>
</li>
<li>
<p>请按顺序执行升级操作，若有疑问，请立即 <a href="http://bk.tencent.com/s-mart/community">反馈</a></p>
</li>
<li>
<p><strong>bkdata</strong> 不支持回滚</p>
</li>
<li>
<p><strong>蓝鲸</strong> 业务不允许删除，如删除将导致配置平台快照数据、监控、日志检索、故障自愈、标准运维无法使用</p>
</li>
<li>
<p>升级完 cmdb 后务必确认蓝鲸业务 ID 是否为 <strong>3</strong></p>
<ul>
<li>检查方法，登录到 CMDB 平台点击【组织架构】--【业务】--【查看蓝鲸业务 ID】 是否为 3</li>
</ul>
</li>
<li>
<p>下文中所以命令均假设 V3.1 版本安装在 /data/ 下，请根据实际路径修改</p>
</li>
<li>升级不支持更改安装路径</li>
</ol>
<h2 id="agent-saas">升级 Agent 安装 SaaS</h2>
<ul>
<li>
<p><strong>Agent 安装 SaaS 务必手动升级到 4.0 专用版本 (V1.0.52)，否则会造成 Agent 安装 SaaS 数据无法同步到节点管理上,后续 Agent 安装 SaaS 不做更新维护，由【节点管理】替代</strong></p>
</li>
<li>
<p>清理 crontab 任务</p>
</li>
</ul>
<p><code>bash
  #在中控机执行
  cd /data/install
  ./bkcec clean cron</code></p>
<ul>
<li>停止进程</li>
</ul>
<p>```bash
  #在中控机执行
  cd /data/install
  for m in bkdata fta job cmdb paas gse kafka license nginx consul; do
      ./bkcec stop $m
  done
  # 停止过程中license报错请忽略</p>
<p># （必须）确认上述进程是否都是EXIT状态
  for m in bkdata fta job cmdb paas gse kafka license nginx consul; do
      ./bkcec status $m
  done
  ```</p>
<blockquote>
<p>注意：
  确保 <code>consul nginx cmdb job paas bkdata kafka fta gse license</code> 进程均为 <code>EXIT</code> 后，继续执行下面步骤</p>
</blockquote>
<ul>
<li>
<p>解压 src</p>
</li>
<li>
<p>备份 src 目录</p>
</li>
</ul>
<p>```bash
  # 在中控机执行</p>
<p># （必须）请一定用 mv 备份 src 目录!!!
  cd /data
  mv src src.bak
  ```</p>
<ul>
<li>解压全量 src 包</li>
</ul>
<p>src 包 <a href="http://bk.tencent.com/download/#community">下载地址</a></p>
<p><code>bash
  tar xf bkce_patch-4.1.16.tgz   # 程序包
  tar xf bkce_common-1.0.0.tgz  # 公共组件包</code></p>
<ul>
<li>恢复证书</li>
</ul>
<p><code>bash
  cp src.bak/cert/* src/cert/</code>
- 恢复 bkarchiva 程序包</p>
<p><code>bash
  #由于该功能已经下架，新版 src 不带此目录
  cp -r src.bak/bkarchiva  /data/src/</code></p>
<h2 id="_3">升级部署脚本</h2>
<p>在中控机执行
部署脚本 <a href="http://bk.tencent.com/download/#community">下载地址</a></p>
<ul>
<li>备份 install 目录，请不要 mv install 目录。</li>
</ul>
<p><code>bash
  cd /data
  #请不要使用mv,必须使用cp命令，不然会导致install目录内的.app.token发生改变
  cp -a install install.bak</code></p>
<ul>
<li>解压 install_ce-x.x.tar.gz 包，内容覆盖到 install 目录中去</li>
</ul>
<p><code>bash
  tar xf install_ce-x.x.tar.gz -C /data/</code></p>
<ul>
<li>还原三个用户配置（globals.env install.config ports.env）</li>
</ul>
<p><code>bash
  cd /data/install.bak
  cp globals.env install.config ports.env ../install</code></p>
<ul>
<li>
<p>返回 /data/install
  <code>bash
  cd /data/install</code></p>
</li>
<li>
<p>更新 globals.env，增加 mongodb 的管理员帐号密码信息（密码请自行更改）</p>
<blockquote>
<p>注意 paas 登录密码如果你在界面已经修改，请务必将 <code>globals.env</code> 内的 <code>paas_admin_pass</code> 的值改为一致</p>
</blockquote>
</li>
<li>
<p>添加到 <code>globals.env</code> 顶部</p>
</li>
</ul>
<p>```bash
  # vim:ft=sh</p>
<p>shopt -s nullglob
  if [ -d $CTRL_DIR/third ]; then
      for f in $CTRL_DIR/third/globals_*.env; do
          source $f
          done
      fi</p>
<p>if [ -d $CTRL_DIR/extra ]; then
      for f in $CTRL_DIR/extra/globals_*.env; do
          source $f
          done
  fi
  shopt -u nullglob</p>
<p>#填写 gse,nginx 外网 IP 到括号内
  export GSE_WAN_IP=()
  export NGINX_WAN_IP=()
  ```</p>
<ul>
<li>添加到 <code>globals.env</code> 最末尾</li>
</ul>
<p>```bash
  export MONGODB_USER="root"    # mongodb 全局用户名
  export MONGODB_PASS='bk@321'  # mongodb 密码</p>
<p># HAS_DNS_SERVER 选项, 域名解析通过 DNS server 还是通过配置 hosts
  # 通过 hosts 配置映射关系时, 一下默认为0, 表示没有自己的 DNS server
  # 此时, 会在所有机器上的 /etc/hosts 文件中添加 paas,cmdb,job 等平台的映射关系
  export HAS_DNS_SERVER=0
  export UPDATE_HOST_NAME=0</p>
<p>export GSE_AGENT_HOME=/usr/local/gse</p>
<p>#windows agent 的安装路径暂时不支持修改, GSE_WIN_AGENT_HOME的取值勿动!
  export GSE_WIN_AGENT_HOME=/cygdrive/c/gse</p>
<p>export BIZ_ID=0</p>
<p>#若不能直连往外, 请关闭该选项
  #若环境可以直连外网, 以下选项设置为 1, 便于自动设置 NGINX 的外网 IP 的监听地址
  export AUTO_GET_WANIP=0</p>
<p>#若无法自动获取外网 IP, 在需要跨云管理时, 在以下数组中填写 gse, nginx 的外网 ip 地址
  export GSE_WAN_IP=()
  export NGINX_WAN_IP=()</p>
<p>#安装部署 SaaS 应用需要使用到的 pip 源
  export PYPI_SOURCE='pypi.douban.com'</p>
<p>export BK_TIMEZONE="Asia/Shanghai"
  export BK_PROXY=
```</p>
<blockquote>
<p><strong>注意</strong> <code>export AUTO_GET_WANIP=0</code> 这一行，如环境机器可以直连外网，请将 0 换成 1。
若不能请将 gse和 nginx 的外网 IP 填写到 <code>export GSE_WAN_IP=()</code> <code>export NGINX_WAN_IP=()</code>括号中</p>
</blockquote>
<ul>
<li>更新 ports.env，增加新增的端口信息</li>
</ul>
<p>```bash
  # 添加到文件顶部位置</p>
<p>shopt -s nullglob
  if [ -d $CTRL_DIR/extra ]; then
          for f in $CTRL_DIR/extra/ports_*.env; do
              source $f
          done
  fi</p>
<p>if [ -d $CTRL_DIR/third ]; then
          for f in $CTRL_DIR/third/ports_*.env; do
              source $f
          done
  fi
  shopt -u nullglob
  ```</p>
<p>```bash
  # 添加到文件尾部
  export PAAS_HTTPS_PORT=$DEFAULT_HTTPS_PORT
  export CMDB_HTTPS_PORT=$DEFAULT_HTTPS_PORT
  export JOB_HTTPS_PORT=$DEFAULT_HTTPS_PORT
  export APPO_HTTPS_PORT=$DEFAULT_HTTPS_PORT
  export APPT_HTTPS_PORT=$DEFAULT_HTTPS_PORT
  export CC_API_PORT=8019
  export RABBITMQ_PORT=5672
  export RABBITMQ_DIST_PORT=15672
  export RABBITMQ_ADMIN_PORT=25672
  export GSE_OPS_PORT=58725
  export GSE_OPTS_PORT=58636
  export GSE_TRANS_PORT=58625
  export GSE_TASK_API_PORT=48669
  export GSE_TASK_APIV2_PORT=48673
  export GSE_TASK_IO_PORT=48668
  export GSE_CACHEAPI_PORT=59313
  export GSE_PROC_PORT=52025
  export GSE_PMS_PORT=52030
  export CONNECTOR_REDIS_PORT=10053
  export CONNECTOR_TSDB_PORT=10054</p>
<p>export INFLUXDB_PORT=5260
  export CONSUL_HTTP_PORT=8500
  export DATABUS_ES_PORT=10050
  export DATABUS_MYSQL_PORT=10051
  export DATABUS_ETL_PORT=10052
  export DATABUS_REDIS_PORT=10053
  export DATABUS_TSDB_PORT=10054
  export DATABUS_HDFS_PORT=10055
  export DATABUS_OFFLINE_PORT=10056</p>
<p>export CMDB_OBJECT_CTRL_PORT=31001
  export CMDB_HOST_CTRL_PORT=31002
  export CMDB_PROC_CTRL_PORT=31003
  export CMDB_AUDIT_CTRL_PORT=31004
  export CMDB_MIGRATE_CTRL_PORT=31005
  export CMDB_HOST_PORT=32001
  export CMDB_TOPO_PORT=32002
  export CMDB_PROC_PORT=32003
  export CMDB_ADMIN_PORT=32004
  export CMDB_EVENT_PORT=32005
  export CMDB_API_PORT=33031
  export CMDB_OPENAPI_PORT=33062
  export CMDB_WEB_PORT=33083
  export MONGODB_PORT=27017
  ```
- 在 install.config 中增加 mongodb 和 influxdb 节点</p>
<p><code>bash
  # 新版 cmdb 需依赖 MongoDB
  # bkdata 需依赖 influxDB
  # 请根据实际机器配置分配
  # 例：
  1.1.1.1  xxx,xxx,xxx,xxxx,xxx,mongodb,influxdb</code>
- 增加 bk_nodeman bk_monitor 的白名单</p>
<p>```bash
  cd /data/install</p>
<p>source utils.fc
  source ~/.bkrc
  source initdata.rc</p>
<p>echo $INSTALL_PATH
  # 返回的是您当前bkce安装的目录，若返回为空请务必将您当前安装路径写入.path文件内
  echo $INSTALL_PATH &gt;&gt; .path     #将安装目录路径写到.path里面
  _add_esb_whitelist    #添加白名单
  ```</p>
<ul>
<li>（可选）若需要使用 “网络管理”，请按实际情况修改 bkco.env，并在 install.config 中增加 bknetwork</li>
</ul>
<p><code>bash
  # 例：
  1.1.1.1  xxx,xxx,xxx,xxxx,xxx,bknetwork</code></p>
<ul>
<li>同步脚本更新</li>
</ul>
<p><code>bash
  ./bkcec sync common</code></p>
<ul>
<li>适配新版服务状态检查，将所有机器上的<code>$INSTALL_PATH/.installed_module</code>内容合并到中控机的<code>$INSTALL_PATH/.installed_sumary</code>中，并去重。</li>
</ul>
<p>```bash</p>
<p>source $CTRL_DIR/utils.fc</p>
<p>for ip in ${ALL_IP[@]}; do ssh $ip cat $INSTALL_PATH/.installed_module; done \
  | sort -u &gt; $INSTALL_PATH/.installed_sumary</p>
<p># 并将 paas_agent 替换为 appo appt（如果没有appt，可以去掉）
  sed -i '/paas_agent/d' $INSTALL_PATH/.installed_sumary
  [[ -n "$APPO_IP" ]] &amp;&amp; echo appo &gt;&gt; $INSTALL_PATH/.installed_sumary
  [[ -n "$APPT_IP" ]] &amp;&amp; echo appt &gt;&gt; $INSTALL_PATH/.installed_sumary
  ```</p>
<ul>
<li>增加 bk_monitor 添加账号及 vhost 到 rabbitmq</li>
</ul>
<p>```bash
  # 执行下面操作需要看到有done返回才算成功
  source $CTRL_DIR/utils.fc</p>
<p>rcmd root@$RABBITMQ_IP "rabbitmqctl add_user "bk_monitor" "$(_app_token bk_monitor)""
  rcmd root@$RABBITMQ_IP "rabbitmqctl add_user "bk_data" "$(_app_token bk_data)""
  rcmd root@$RABBITMQ_IP "rabbitmqctl add_user "bk_monitor" "$(_app_token bk_monitor)""
  rcmd root@$RABBITMQ_IP "rabbitmqctl add_user "bk_bkdata" "$(_app_token bk_bkdata)""
  rcmd root@$RABBITMQ_IP "rabbitmqctl add_user "bk_paas_kibana" "$(_app_token bk_paas_kibana)""
  rcmd root@$RABBITMQ_IP "rabbitmqctl add_user "bk_dataadmin" "$(_app_token bk_dataadmin)""
  rcmd root@$RABBITMQ_IP "rabbitmqctl add_user "bk_dataweb" "$(_app_token bk_dataweb)""
  rcmd root@$RABBITMQ_IP "rabbitmqctl add_user "bk_appo" "$(_app_token bk_appo)""
  rcmd root@$RABBITMQ_IP "rabbitmqctl add_user "bk_appt" "$(_app_token bk_appt)""
  rcmd root@$RABBITMQ_IP "rabbitmqctl add_user "bk_sops" "$(_app_token bk_sops)""
  rcmd root@$RABBITMQ_IP "rabbitmqctl add_user "gcloud" "$(_app_token gcloud)""
  rcmd root@$RABBITMQ_IP "rabbitmqctl add_user "bk_itsm" "$(_app_token bk_itsm)""
  rcmd root@$RABBITMQ_IP "rabbitmqctl set_user_tags bk_monitor management"
  rcmd root@$RABBITMQ_IP "rabbitmqctl set_user_tags bk_bkdata management"
  rcmd root@$RABBITMQ_IP "rabbitmqctl add_vhost bk_monitor"
  rcmd root@$RABBITMQ_IP "rabbitmqctl add_vhost bk_data"
  rcmd root@$RABBITMQ_IP "rabbitmqctl add_vhost bk_bkdata"
  rcmd root@$RABBITMQ_IP 'rabbitmqctl set_permissions -p bk_bkdata bk_bkdata ".<em>" ".</em>" ".<em>"'
  rcmd root@$RABBITMQ_IP 'rabbitmqctl set_permissions -p bk_monitor bk_monitor ".</em>" ".<em>" ".</em>"'
  rcmd root@$RABBITMQ_IP 'rabbitmqctl set_permissions -p bk_data bk_data ".<em>" ".</em>" ".*"'
  ```</p>
<ul>
<li>同步 src 更新
  <code>bash
   cd /data/install
   ./bkcec sync all</code></li>
</ul>
<hr />
<h2 id="_4">开始升级</h2>
<h3 id="_5">升级开源组件</h3>
<ul>
<li>更新 consul</li>
</ul>
<p>```bash
  # 在中控机执行
  # 安装 consul
  ./bkcec install consul</p>
<p># 启动
  ./bkcec start consul</p>
<p># 确认其状态正常
  ./bkcec status consul
  ```
-  更新 mysql 配置</p>
<p><code>bash
  ./bkcec stop mysql
  ./bkcec status mysql #必须进程 exit
  ./bkcec install mysql 1
  ./bkcec start mysql</code></p>
<ul>
<li>更新 nginx 配置</li>
</ul>
<p>在中控机执行</p>
<ul>
<li>
<p>更新内容：</p>
<ol>
<li>
<p>取消 nginx 默认过滤带下划线 headers 的限制。</p>
</li>
<li>
<p>更新 agent 安装脚本。</p>
</li>
</ol>
</li>
<li>
<p>更新步骤：</p>
<p>```bash
cd /data/install
./bkcec install nginx 1</p>
<h1 id="_6">启动</h1>
<p>./bkcec start nginx</p>
<h1 id="_7">确认其状态正常</h1>
<p>./bkcec status nginx
```</p>
</li>
<li>
<p>更新 kafka 配置</p>
</li>
</ul>
<p>```bash
  # 在中控机执行
  cd /data/install</p>
<p># 重新生成 kafka 配置文件
  ./bkcec render kafka</p>
<p># 启动
  ./bkcec start kafka</p>
<p># 确认其状态正常
  ./bkcec status kafka
  ```
- 更新 zk 数据
  在中控机执行</p>
<p>```bash
  cd /data/install
  source utils.fc
  source ~/.bkrc</p>
<p>zk_cmd="$INSTALL_PATH/service/zk/bin/zkCli.sh -server $ZK_IP0:$ZK_PORT"
  $zk_cmd delete /gse/config/etc/operserver/all/pingcfg
  ```</p>
<h3 id="db">安装 DB</h3>
<ul>
<li>安装 MongoDB</li>
</ul>
<p>```bash
  # 在中控机执行
  cd /data/install</p>
<p># 安装 MongoDB
  ./bkcec install mongodb</p>
<p># 初始化用户信息
  ./bkcec initdata mongodb</p>
<p># 启动
  ./bkcec start mongodb</p>
<p># 确认其状态正常
  ./bkcec status mongodb
  ```</p>
<ul>
<li>安装 influxDB</li>
</ul>
<p>```bash
  # 在中控机执行
  cd /data/install</p>
<p>#安装 influxDB
  ./bkcec install influxdb</p>
<p># 启动
  ./bkcec start influxdb</p>
<p># 确认其状态正常
  ./bkcec status influxdb
  ```</p>
<ul>
<li>安装 cmdb3.0</li>
</ul>
<p>```bash
  # 在中控机执行
  cd /data/install
  source utils.fc
  # （必须）删除无用 nginx 配置
  ssh $CMDB_IP "rm -vf $INSTALL_PATH/etc/nginx/cmdb.conf"</p>
<p>./bkcec install cmdb
  ./bkcec start cmdb
  ./bkcec status cmdb<br />
  # （必须）所有进程都 RUNNING 才能继续
  ./bkcec initdata cmdb
  ```</p>
<h3 id="cmdb">迁移 原 cmdb 数据</h3>
<ul>
<li>
<p>在 <strong>mongodb</strong> 所在的机器上执行执行</p>
</li>
<li>
<p>将 cmdb_upgrade_tool-0.7.0.tgz 上传到 mongodb 所属机器，根据以下指引迁移数据库</p>
</li>
</ul>
<p>```bash
  # 解压工具包，以 /data 目录为例
  tar xf cmdb_upgrade_tool-0.7.0.tgz -C /data
  cd /data/cmdb_upgrade_tool/
  # /data/install参数表示 globals.env 所在目录，请根据实际修改
  ./create_dbupgrade_config.sh /data/install</p>
<p># 检查生成的 template.conf 文件，各项参数自动生成是否正确
  # [data-dir]下的 dir=配置表示 CMDB2.0 的备份数据存放路径，请保证磁盘空间足够</p>
<p># 执行同步工具迁移数据
  ./dbupgrade --config=./template.conf --env=community
  ```</p>
<ul>
<li>
<p>重新加载 cmdb3.0 配置</p>
</li>
<li>
<p>重启 cmdb 进程，加载配置</p>
<p>```bash</p>
<h1 id="_8">在中控机执行</h1>
<p>cd /data/install
./bkcec stop cmdb
./bkcec start cmdb
```</p>
</li>
<li>
<p>升级 license</p>
</li>
</ul>
<p>```bash
  # 升级模块
  ./bkcec upgrade license</p>
<p># 启动
  ./bkcec start license
  ```</p>
<ul>
<li>升级完成后检查服务状态</li>
</ul>
<p><code>bash
  ./bkcec status license</code></p>
<ul>
<li>升级 PaaS</li>
</ul>
<p>```bash
  # 升级模块
  source /data/install/utils.fc
  source ~/.bkrc</p>
<p># 添加标记文件
  touch $CTRL_DIR/.migrate/0001_open_paas_20180710-1600_mysql.sql</p>
<p>./bkcec upgrade paas</p>
<p>./bkcec initdata paas
  # 启动
  ./bkcec start paas</p>
<p>./bkcec status paas
  ```</p>
<ul>
<li>升级 GSE</li>
</ul>
<p>```bash
  # 升级模块
  ./bkcec install gse</p>
<p>./bkcec initdata gse
  # 启动
  ./bkcec start gse</p>
<p>./bkcec status gse
  ```</p>
<ul>
<li>升级 JOB</li>
</ul>
<p>```bash
  source /data/install/utils.fc
  source ~/.bkrc</p>
<p># 添加标记文件
  touch $CTRL_DIR/.migrate/0001_job_ce_20180712-1000_mysql.sql</p>
<p># 升级job
  ./bkcec upgrade job
  ./bkcec initdata job</p>
<p># 启动
  ./bkcec start job</p>
<p># 检查状态是否正常
  ./bkcec status job
  ```</p>
<ul>
<li>升级 BKDATA</li>
</ul>
<p>```bash
  source /data/install/utils.fc
  source ~/.bkrc
  # 添加 标记文件
  touch $CTRL_DIR/.migrate/0001_dataapi_20180714-0157_mysql.sql
  touch $CTRL_DIR/.migrate/0001_monitor_20180503-0000_mysql.sql
  # 升级bkdata
  ./bkcec upgrade bkdata
  ./bkcec initdata bkdata
  # 启动
  ./bkcec start bkdata   #启动时会报init_snapshot_config错误提示可忽略</p>
<p>#查看状态
  ./bkcec status bkdata  #必须是runnning状态才能继续</p>
<p># 清理无用任务
  rcmd root@$BKDATA_IP "bash $INSTALL_PATH/bkdata/dataapi/bin/remove_old_task.sh"
  #无报错信息，且有正常输出信息</p>
<p>rcmd root@$BKDATA_IP "workon dataapi; python manage.py migrate --database trt"
  #无报错信息，且有正常输出信息</p>
<p># 重启bkdata
  ./bkcec stop bkdata
  ./bkcec status bkdata
  ./bkcec start bkdata   #启动时间长，不可有任何报错信息，且有一堆正常输出</p>
<p># 修复kafka组件问题</p>
<p>bash fix_topic_expire.sh  #将该脚本文件放到中控机执行,该脚本在V4CMDB数据迁移工具包里面</p>
<p>```</p>
<ul>
<li>升级 FTA</li>
</ul>
<p>```bash
  # 升级模块
  source /data/install/utils.fc
  source ~/.bkrc
  # 添加 标记文件
  touch $CTRL_DIR/.migrate/0001_fta_20180727-1814_mysql.sql
  ./bkcec upgrade fta</p>
<p># 启动
  ./bkcec start fta</p>
<p>./bkcec status fta
  ```</p>
<ul>
<li>
<p>升级 S-mart 应用
  <code>bash
  cd /data/install
  ./bkcec install saas-o</code></p>
</li>
<li>
<p>升级 gse_agent</p>
</li>
<li>
<p>升级蓝鲸所在机器的 gse agent</p>
</li>
</ul>
<p><code>bash
  cd /data/install
  source utils.fc
  for ip in ${ALL_IP[@]}; do
      ssh $ip "wget http://$NGINX_IP:$DEFAULT_HTTP_PORT/download/agent_setup_pro.sh; \
      bash agent_setup_pro.sh -m client -u"
  done</code>
- 升级 业务机器 的 gse agent</p>
<ul>
<li>
<p>请使用 【节点管理】 app 的 agent 升级功能</p>
</li>
<li>
<p>手动升级方法
  <code>bash
  # 登录 需要升级的机器
  wget http://$NGINX_IP:$DEFAULT_HTTP_PORT/download/agent_setup_pro.sh
  bash agent_setup_pro.sh -m client -u</code></p>
</li>
</ul>
<h2 id="_9">验证</h2>
<ul>
<li>登录各平台检查是否正常</li>
</ul><h1 id="v40-v41">社区版 V4.0 升级至 V4.1 指引</h1>
<p>下述命令均假设社区版本的 src 和 install 包安装在/ data/install /data/src 目录的，请根据实际路径做对应的修改。</p>
<h2 id="_1">升级前准备</h2>
<p>升级 Agent 安装 SaaS
- <strong>Agent 安装 SaaS 务必手动升级到 4.0 专用版本 (V1.0.52)，否则会造成 Agent 安装 SaaS 数据无法同步到节点管理上，后续 Agent 安装 SaaS 不做更新维护，由【节点管理】替代</strong></p>
<ul>
<li>
<p>解压 src</p>
</li>
<li>
<p>备份 src 目录</p>
</li>
</ul>
<p><code>bash
  # 中控机执行
  # （必须）请一定用 mv 备份 src 目录。
  cd /data
  mv src src.bak</code></p>
<ul>
<li>
<p>解压 src 包</p>
</li>
<li>
<p>src 包 <a href="http://bk.tencent.com/download/#community">下载地址</a></p>
</li>
</ul>
<p><code>bash
  tar xf bkce_patch-4.1.16.tgz   #程序包
  tar xf bkce_common-1.0.0.tgz   #公共组件包</code></p>
<ul>
<li>恢复证书</li>
</ul>
<p><code>bash
  cp src.bak/cert/* src/cert/</code></p>
<ul>
<li>升级部署脚本</li>
</ul>
<p>在中控机执行部署脚本 <a href="http://bk.tencent.com/download/#community">下载地址</a></p>
<ul>
<li>
<p>备份 install 目录，请不要 mv install 目录。
  <code>bash
  cd /data
  #请不要使用mv命令备份，一定要使用 cp 备份 install，不然会导致install目录内的app.token发生改变
  cp -a install install.bak</code></p>
</li>
<li>
<p>解压 install_ce-x.x.tar.gz 包，内容覆盖到 install 目录中去
  <code>bash
  tar xf install_ce-x.x.tar.gz -C /data/</code></p>
</li>
<li>还原三个用户配置（globals.env install.config ports.env）</li>
</ul>
<p><code>bash
  # 注意!!!!!
  # ports.env文件在最新的一版里变量已经更换（CMDB的 变量做了调整）\
  # 如你当前环境的端口都没有修改过便使用最新的ports.env文件\
  # 若你已经修改过文件内的端口请自行对比并更新到最新的ports.env文件对应位置\
  # paas登录密码如果你在界面已经修改，请务必将`globals.env`内的`paas_admin_pass`的值改为一致
  cd /data/install.bak
  cp -a globals.env install.config  ../install</code></p>
<ul>
<li><strong>编辑</strong> <code>install.config</code> 在任意一行末尾 <strong>新增</strong> <code>influxdb</code>模块(必须增加，后面 bkdata 需要使用该模块)  <code>bknetwork</code>模块 (如果需要网络管理后台)</li>
</ul>
<p><code>bash
  cd /data/install
  1.1.1.1  xxx，xxx，xxx，xxxx，xxx，influxdb，bknetwork</code>
- <strong>编辑</strong> <code>globals.env</code>
- 添加到 <code>globals.env</code> 顶部开头位置</p>
<p>```bash
  # vim:ft=sh</p>
<p>shopt -s nullglob
  if [ -d $CTRL_DIR/third ]; then
      for f in $CTRL_DIR/third/globals_*.env; do
          source $f
      done
      fi</p>
<p>if [ -d $CTRL_DIR/extra ]; then
      for f in $CTRL_DIR/extra/globals_*.env; do
          source $f
      done
       fi
  shopt -u nullglob</p>
<p>#填写gse，nginx外网IP到括号内
  export GSE_WAN_IP=()
  export NGINX_WAN_IP=()
  ```</p>
<ul>
<li><strong>编辑</strong><code>ports.env</code></li>
</ul>
<p>```bash
  shopt -s nullglob
  if [ -d $CTRL_DIR/third ]; then
          for f in $CTRL_DIR/third/ports_*.env; do
              source $f
          done
  fi</p>
<p>if [ -d $CTRL_DIR/extra ]; then
          for f in $CTRL_DIR/extra/ports_*.env; do
              source $f
          done
  fi
  shopt -u nullglob</p>
<p>export PAAS_HTTPS_PORT=$DEFAULT_HTTPS_PORT
  export CMDB_HTTPS_PORT=$DEFAULT_HTTPS_PORT
  export JOB_HTTPS_PORT=$DEFAULT_HTTPS_PORT
  export APPO_HTTPS_PORT=$DEFAULT_HTTPS_PORT
  export APPT_HTTPS_PORT=$DEFAULT_HTTPS_PORT</p>
<p>```</p>
<ul>
<li>适配新版服务状态检查，将所有机器上的 <code>$INSTALL_PATH/.installed_module</code>内容合并到中控机的<code>$INSTALL_PATH/.installed_sumary</code>中，并去重。</li>
</ul>
<p><code>bash
  source utils.fc
  for ip in ${ALL_IP[@]}; do ssh $ip cat $INSTALL_PATH/.installed_module; done \
  | sort -u &gt; $INSTALL_PATH/.installed_sumary
  # 并将 paas_agent 替换为 appo appt（如果没有appt，可以去掉）
  sed -i '/paas_agent/d' $INSTALL_PATH/.installed_sumary
  [[ -n "$APPO_IP" ]] &amp;&amp; echo appo &gt;&gt; $INSTALL_PATH/.installed_sumary
  [[ -n "$APPT_IP" ]] &amp;&amp; echo appt &gt;&gt; $INSTALL_PATH/.installed_sumary</code></p>
<ul>
<li>增加 bk_monitor 添加账号及 vhost 到 rabbitmq
  ```bash
  # 执行下面操作需要看到有done返回才算成功
  source /data/install/utils.fc</li>
</ul>
<p>rcmd root@$RABBITMQ_IP "rabbitmqctl add_user "bk_monitor" "$(_app_token bk_monitor)""
  rcmd root@$RABBITMQ_IP "rabbitmqctl add_user "bk_data" "$(_app_token bk_data)""
  rcmd root@$RABBITMQ_IP "rabbitmqctl add_user "bk_monitor" "$(_app_token bk_monitor)""
  rcmd root@$RABBITMQ_IP "rabbitmqctl add_user "bk_bkdata" "$(_app_token bk_bkdata)""
  rcmd root@$RABBITMQ_IP "rabbitmqctl add_user "bk_paas_kibana" "$(_app_token bk_paas_kibana)""
  rcmd root@$RABBITMQ_IP "rabbitmqctl add_user "bk_dataadmin" "$(_app_token bk_dataadmin)""
  rcmd root@$RABBITMQ_IP "rabbitmqctl add_user "bk_dataweb" "$(_app_token bk_dataweb)""
  rcmd root@$RABBITMQ_IP "rabbitmqctl add_user "bk_appo" "$(_app_token bk_appo)""
  rcmd root@$RABBITMQ_IP "rabbitmqctl add_user "bk_appt" "$(_app_token bk_appt)""
  rcmd root@$RABBITMQ_IP "rabbitmqctl add_user "bk_sops" "$(_app_token bk_sops)""
  rcmd root@$RABBITMQ_IP "rabbitmqctl add_user "gcloud" "$(_app_token gcloud)""
  rcmd root@$RABBITMQ_IP "rabbitmqctl add_user "bk_itsm" "$(_app_token bk_itsm)""
  rcmd root@$RABBITMQ_IP "rabbitmqctl set_user_tags bk_monitor management"
  rcmd root@$RABBITMQ_IP "rabbitmqctl set_user_tags bk_bkdata management"
  rcmd root@$RABBITMQ_IP "rabbitmqctl add_vhost bk_monitor"
  rcmd root@$RABBITMQ_IP "rabbitmqctl add_vhost bk_data"
  rcmd root@$RABBITMQ_IP "rabbitmqctl add_vhost bk_bkdata"
  rcmd root@$RABBITMQ_IP 'rabbitmqctl set_permissions -p bk_bkdata bk_bkdata ".<em>" ".</em>" ".<em>"'
  rcmd root@$RABBITMQ_IP 'rabbitmqctl set_permissions -p bk_monitor bk_monitor ".</em>" ".<em>" ".</em>"'
  rcmd root@$RABBITMQ_IP 'rabbitmqctl set_permissions -p bk_data bk_data ".<em>" ".</em>" ".*"'
  ```</p>
<ul>
<li>增加 bk_nodeman 的白名单
  <code>bash
  cd /data/install
  add_app_token bk_nodeman "$(_app_token bk_nodeman)" "节点管理"</code></li>
</ul>
<h2 id="_2">开始升级</h2>
<h3 id="_3">安装开源组件</h3>
<p>```bash
  ./bkcec clean cron  # 停掉监控
  ./bkcec sync all     # 同步文件</p>
<p>./bkcec install nginx 1
  ./bkcec stop nginx
  ./bkcec start nginx</p>
<p>./bkcec install influxdb  #安装influxdb
  ./bkcec start influxdb</p>
<p>./bkcec install consul   #由于新增了influxdb模块，需要重装consul
  ./bkcec stop consul
  ./bkcec start consul</p>
<p>./bkcec stop mysql  #更新 mysql 配置
  ./bkcec install mysql 1
  ./bkcec start mysql
  ```</p>
<h3 id="_4">更新蓝鲸组件</h3>
<ul>
<li>更新 PaaS</li>
</ul>
<p>```bash
  source /data/install/utils.fc
  source ~/.bkrc
  # 添加 标记文件
  touch $CTRL_DIR/.migrate/0001_open_paas_20180710-1600_mysql.sql</p>
<p>./bkcec stop paas
  ./bkcec status paas
  ./bkcec upgrade paas
  ./bkcec initdata paas
  ./bkcec start paas
  ```
- 更新 CMDB</p>
<p><code>bash
  ./bkcec upgrade cmdb
  ./bkcec stop cmdb
  ./bkcec start cmdb  
  ./bkcec initdata cmdb</code>
- 更新 FTA</p>
<p>```bash
  source /data/install/utils.fc
  source ~/.bkrc
  # 添加 标记文件
  touch $CTRL_DIR/.migrate/0001_fta_20180727-1814_mysql.sql</p>
<p>./bkcec stop fta
  ./bkcec upgrade fta
  ./bkcec start fta<br />
  ```</p>
<ul>
<li>更新 GSE</li>
</ul>
<p><code>bash
  ./bkcec stop gse
  ./bkcec install gse 1
  ./bkcec initdata gse
  ./bkcec start gse</code>
- 升级 JOB</p>
<p>```bash
  source /data/install/utils.fc
  source ~/.bkrc
  # 添加标记文件
  touch $CTRL_DIR/.migrate/0001_job_ce_20180712-1000_mysql.sql
  # 升级job
  ./bkcec upgrade job
  ./bkcec initdata job
  ./bkcec stop job
  # 启动
  ./bkcec start job</p>
<p># 检查状态是否正常
  ./bkcec status job
  ```</p>
<ul>
<li>更新 zk 数据</li>
</ul>
<p>在中控机执行
  ```bash
  cd /data/install
  source utils.fc
  source ~/.bkrc</p>
<p>zk_cmd="$INSTALL_PATH/service/zk/bin/zkCli.sh -server $ZK_IP0:$ZK_PORT"
  $zk_cmd delete /gse/config/etc/operserver/all/pingcfg
  ```</p>
<ul>
<li>升级 BKDATA</li>
</ul>
<p>```bash
  source /data/install/utils.fc
  source ~/.bkrc
  # 添加 标记文件
  touch $CTRL_DIR/.migrate/0001_dataapi_20180714-0157_mysql.sql
  touch $CTRL_DIR/.migrate/0002_dataapi_20180716-1741_mysql.sql
  touch $CTRL_DIR/.migrate/0001_monitor_20180503-0000_mysql.sql
  # 更新bkdata
  ./bkcec upgrade bkdata
  ./bkcec initdata bkdata
  # 清理无用任务
  rcmd root@$BKDATA_IP "rm -f  $INSTALL_PATH/.init_bkdata_snapshot"
  rcmd root@$BKDATA_IP "rm -f  $INSTALL_PATH/.dataapi_snaphost"
  #无报错信息，且有正常输出信息
  rcmd root@$BKDATA_IP "workon dataapi; python manage.py migrate --database trt"
  #无报错信息，且有正常输出信息</p>
<p># 重启bkdata
  ./bkcec stop bkdata
  ./bkcec status bkdata
  ./bkcec start bkdata   #启动时间长，不可有任何报错信息，且有一堆正常输出
  ```</p>
<h3 id="saas">升级 SaaS</h3>
<div class="codehilite"><pre><span></span>./bk_install saas-o
</pre></div>


<h3 id="agent">升级 Agent</h3>
<ul>
<li>升级蓝鲸所在机器的 gse_agent 在中控机执行</li>
</ul>
<p><code>bash
  cd /data/install
  source utils.fc
  for ip in ${ALL_IP[@]}; do
      ssh $ip "wget http://$NGINX_IP:$DEFAULT_HTTP_PORT/download/agent_setup_pro.sh; \
          bash agent_setup_pro.sh -m client -u"
  done</code>
- 升级 业务机器 的 gse agent</p>
<ul>
<li>
<p>请使用 【节点管理】APP 的 agent 升级功能</p>
</li>
<li>
<p>手动升级方法</p>
</li>
</ul>
<p><code>bash
    # 登录 需要升级的机器
  wget http://$NGINX_IP:$DEFAULT_HTTP_PORT/download/agent_setup_pro.sh
  bash agent_setup_pro.sh -m client -u</code></p>
<h2 id="_5">验证</h2>
<ul>
<li>各平台可正常访问</li>
</ul><h1 id="v41-v4116">社区版 V4.1 升级至 V4.1.16 指引</h1>
<p>下述命令均假设社区版本的 src 和 install 包安装在 /data/install /data/src 目录的，请根据实际
路径做对应的修改。</p>
<h2 id="_1">升级前准备</h2>
<ul>
<li>
<p>解压 src</p>
</li>
<li>
<p>备份 src 目录</p>
</li>
</ul>
<p><code>bash
  # 中控机执行
  # （必须）请一定用 mv 备份 src 目录!!!
  cd /data
  mv src src.bak</code></p>
<ul>
<li>
<p>解压包</p>
</li>
<li>
<p>src 包 <a href="http://bk.tencent.com/download/#community">下载地址</a></p>
</li>
</ul>
<p><code>bash
  tar xf bkce_patch-4.1.x.tgz  #程序包
  tar xf bkce_common-1.0.0.tgz  #公共组件包</code></p>
<ul>
<li>恢复证书</li>
</ul>
<p><code>bash
  cp src.bak/cert/* src/cert/</code></p>
<ul>
<li>升级部署脚本</li>
</ul>
<p>在中控机执行部署脚本 <a href="http://bk.tencent.com/download/#community">下载地址</a></p>
<ul>
<li>备份 install 目录，请不要 mv install 目录。
  <code>bash
  cd /data
  #请不要使用mv命令备份，一定使用cp备份install目录，不然会导致app.token发生改变
  cp -a install install.bak</code></li>
<li>解压 install_ce-x.x.tar.gz 包，内容覆盖到 install 目录中去
  <code>bash
  tar xf install_ce-x.x.tar.gz -C /data/</code></li>
<li>还原三个用户配置（globals.env install.config ports.env）<blockquote>
<p>注意 paas 登录密码如果你在界面已经修改，请务必将<code>globals.env</code>内的<code>paas_admin_pass</code>的值改为一致</p>
</blockquote>
</li>
</ul>
<p><code>bash
  cd /data/install.bak
  cp -a globals.env install.config ports.env ../install</code></p>
<ul>
<li><strong>编辑</strong> <code>install.config</code> 在任意一行末尾 <strong>新增</strong> <code>influxdb</code>模块(必须增加，后面 bkdata 需要使用该模块)  <code>bknetwork</code>模块 (如果需要网络管理后台)</li>
</ul>
<p><code>bash
  cd /data/install
  1.1.1.1  xxx，xxx，xxx，xxxx，xxx，influxdb，bknetwork</code>
- <strong>编辑</strong> <code>globals.env</code>
- 添加到 <code>globals.env</code>顶部开头位置</p>
<p>```bash
  # vim:ft=sh</p>
<p>shopt -s nullglob
  if [ -d $CTRL_DIR/third ]; then
      for f in $CTRL_DIR/third/globals_*.env; do
          source $f
      done
      fi</p>
<p>if [ -d $CTRL_DIR/extra ]; then
      for f in $CTRL_DIR/extra/globals_*.env; do
          source $f
      done
       fi
  shopt -u nullglob</p>
<p>#填写gse，nginx外网IP到括号内
  export GSE_WAN_IP=()
  export NGINX_WAN_IP=()
  ```</p>
<ul>
<li><strong>编辑</strong> <code>ports.env</code></li>
</ul>
<p>```bash
  shopt -s nullglob
  if [ -d $CTRL_DIR/extra ]; then
          for f in $CTRL_DIR/extra/ports_*.env; do
              source $f
          done
  fi</p>
<p>if [ -d $CTRL_DIR/third ]; then
          for f in $CTRL_DIR/third/ports_*.env; do
              source $f
          done
  fi
  shopt -u nullglob</p>
<p>export PAAS_HTTPS_PORT=$DEFAULT_HTTPS_PORT
  export CMDB_HTTPS_PORT=$DEFAULT_HTTPS_PORT
  export JOB_HTTPS_PORT=$DEFAULT_HTTPS_PORT
  export APPO_HTTPS_PORT=$DEFAULT_HTTPS_PORT
  export APPT_HTTPS_PORT=$DEFAULT_HTTPS_PORT
  ```</p>
<h2 id="_2">开始升级</h2>
<h3 id="_3">安装开源组件</h3>
<div class="codehilite"><pre><span></span>./bkcec clean cron  <span class="c1"># 停掉监控</span>
./bkcec sync all     <span class="c1"># 同步文件</span>

./bkcec stop mysql  <span class="c1">#更新 mysql 配置</span>
./bkcec install mysql <span class="m">1</span>
./bkcec start mysql

./bkcec install nginx <span class="m">1</span>
./bkcec stop nginx
./bkcec start nginx

<span class="c1">#更新rabbitmq</span>
<span class="c1"># 执行下面操作需要看到有done返回才算成功</span>
<span class="nb">source</span> <span class="nv">$CTRL_DIR</span>/utils.fc

rcmd root@<span class="nv">$RABBITMQ_IP</span> <span class="s2">&quot;rabbitmqctl add_user &quot;</span>bk_monitor<span class="s2">&quot; &quot;</span><span class="k">$(</span>_app_token bk_monitor<span class="k">)</span><span class="s2">&quot;&quot;</span>
rcmd root@<span class="nv">$RABBITMQ_IP</span> <span class="s2">&quot;rabbitmqctl add_user &quot;</span>bk_bkdata<span class="s2">&quot; &quot;</span><span class="k">$(</span>_app_token bk_bkdata<span class="k">)</span><span class="s2">&quot;&quot;</span>
rcmd root@<span class="nv">$RABBITMQ_IP</span> <span class="s2">&quot;rabbitmqctl add_user &quot;</span>bk_paas_kibana<span class="s2">&quot; &quot;</span><span class="k">$(</span>_app_token bk_paas_kibana<span class="k">)</span><span class="s2">&quot;&quot;</span>
rcmd root@<span class="nv">$RABBITMQ_IP</span> <span class="s2">&quot;rabbitmqctl add_user &quot;</span>bk_dataadmin<span class="s2">&quot; &quot;</span><span class="k">$(</span>_app_token bk_dataadmin<span class="k">)</span><span class="s2">&quot;&quot;</span>
rcmd root@<span class="nv">$RABBITMQ_IP</span> <span class="s2">&quot;rabbitmqctl add_user &quot;</span>bk_dataweb<span class="s2">&quot; &quot;</span><span class="k">$(</span>_app_token bk_dataweb<span class="k">)</span><span class="s2">&quot;&quot;</span>
rcmd root@<span class="nv">$RABBITMQ_IP</span> <span class="s2">&quot;rabbitmqctl add_user &quot;</span>bk_appo<span class="s2">&quot; &quot;</span><span class="k">$(</span>_app_token bk_appo<span class="k">)</span><span class="s2">&quot;&quot;</span>
rcmd root@<span class="nv">$RABBITMQ_IP</span> <span class="s2">&quot;rabbitmqctl add_user &quot;</span>bk_appt<span class="s2">&quot; &quot;</span><span class="k">$(</span>_app_token bk_appt<span class="k">)</span><span class="s2">&quot;&quot;</span>
rcmd root@<span class="nv">$RABBITMQ_IP</span> <span class="s2">&quot;rabbitmqctl add_user &quot;</span>bk_sops<span class="s2">&quot; &quot;</span><span class="k">$(</span>_app_token bk_sops<span class="k">)</span><span class="s2">&quot;&quot;</span>
rcmd root@<span class="nv">$RABBITMQ_IP</span> <span class="s2">&quot;rabbitmqctl add_user &quot;</span>gcloud<span class="s2">&quot; &quot;</span><span class="k">$(</span>_app_token gcloud<span class="k">)</span><span class="s2">&quot;&quot;</span>
rcmd root@<span class="nv">$RABBITMQ_IP</span> <span class="s2">&quot;rabbitmqctl add_user &quot;</span>bk_itsm<span class="s2">&quot; &quot;</span><span class="k">$(</span>_app_token bk_itsm<span class="k">)</span><span class="s2">&quot;&quot;</span>

rcmd root@<span class="nv">$RABBITMQ_IP</span> <span class="s2">&quot;rabbitmqctl set_user_tags bk_bkdata management&quot;</span>
rcmd root@<span class="nv">$RABBITMQ_IP</span> <span class="s2">&quot;rabbitmqctl add_vhost bk_bkdata&quot;</span>
rcmd root@<span class="nv">$RABBITMQ_IP</span> <span class="s1">&#39;rabbitmqctl set_permissions -p bk_bkdata bk_bkdata &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;&#39;</span>
</pre></div>


<h3 id="_4">升级蓝鲸组件</h3>
<ul>
<li>更新 PaaS</li>
</ul>
<p>```bash
  source /data/install/utils.fc
  source ~/.bkrc
  # 添加 标记文件
  touch $CTRL_DIR/.migrate/0001_open_paas_20180710-1600_mysql.sql</p>
<p>./bkcec upgrade paas
  ./bkcec stop paas
  ./bkcec initdata paas
  ./bkcec start paas
  ```
- 更新 CMDB</p>
<p><code>bash
  ./bkcec upgrade cmdb
  ./bkcec stop cmdb
  ./bkcec start cmdb
  ./bkcec initdata cmdb</code>
- 更新 FTA</p>
<p>```bash
  source /data/install/utils.fc
  source ~/.bkrc
  # 添加 标记文件
  touch $CTRL_DIR/.migrate/0001_fta_20180727-1814_mysql.sql</p>
<p>./bkcec upgrade fta
  ./bkcec stop fta
  ./bkcec start fta<br />
  ```</p>
<ul>
<li>更新 GSE</li>
</ul>
<p><code>bash
  ./bkcec stop gse
  ./bkcec install gse 1
  ./bkcec initdata gse
  ./bkcec start gse</code>
- 升级 JOB</p>
<p>```bash
  source /data/install/utils.fc
  source ~/.bkrc
  # 添加 标记文件
  touch $CTRL_DIR/.migrate/0001_job_ce_20180712-1000_mysql.sql
  touch $CTRL_DIR/.migrate/0002_job_ce_20180712-1001_mysql.sql</p>
<p>./bkcec upgrade job
  ./bkcec initdata job
  ./bkcec stop job
  ./bkcec start job
  ./bkcec status job
  ```</p>
<ul>
<li>升级 BKDATA</li>
</ul>
<p>```bash
  # 更新bkdata
  source /data/install/utils.fc
  source ~/.bkrc
  # 添加 标记文件
  touch $CTRL_DIR/.migrate/0001_dataapi_20180714-0157_mysql.sql
  touch $CTRL_DIR/.migrate/0002_dataapi_20180716-1741_mysql.sql
  touch $CTRL_DIR/.migrate/0003_dataapi_20180716-1742_mysql.sql
  touch $CTRL_DIR/.migrate/0001_monitor_20180503-0000_mysql.sql</p>
<p>./bkcec upgrade bkdata
  ./bkcec stop bkdata
  ./bkcec status bkdata
  ./bkcec start bkdata   #启动时间长，不可有任何报错信息，且有一堆正常输出
  ```</p>
<h3 id="saas">升级 SaaS</h3>
<p><code>bash
  ./bk_install saas-o</code></p>
<h3 id="agent">升级 Agent</h3>
<ul>
<li>升级蓝鲸所在机器的 gse_agent 在中控机执行</li>
</ul>
<p><code>bash
  cd /data/install
  source utils.fc
  for ip in ${ALL_IP[@]}; do
      ssh $ip "wget http://$NGINX_IP:$DEFAULT_HTTP_PORT/download/agent_setup_pro.sh; \
          bash agent_setup_pro.sh -m client -u"
  done</code></p>
<ul>
<li>
<p>升级 业务机器 的 gse agent</p>
</li>
<li>
<p>请使用 【节点管理】 app 的 agent 升级功能</p>
</li>
<li>
<p>手动升级方法</p>
</li>
</ul>
<p><code>bash
    # 登录 需要升级的机器
  wget http://$NGINX_IP:$DEFAULT_HTTP_PORT/download/agent_setup_pro.sh
  bash agent_setup_pro.sh -m client -u</code></p>
<h2 id="_5">验证</h2>
<ul>
<li>各平台可正常访问</li>
</ul><h1 id="v4116-v50">社区版 V4.1.16 升级至 v5.0 指引</h1>
<h2 id="_1">升级前准备</h2>
<ul>
<li>
<p>解压 <code>src</code></p>
</li>
<li>
<p>停进程</p>
</li>
</ul>
<p><code>bash
  cd /data/install
  echo nginx  license gse cmdb job paas appo appt bkdata fta  | xargs -n1 ./bkcec stop
  # 观察进程是否为EXIT
  echo nginx license gse cmdb job paas appo appt bkdata fta | xargs -n1 ./bkcec status</code></p>
<ul>
<li>备份 <code>src</code> 目录</li>
</ul>
<p><code>bash
   # 中控机执行
   # （必须）请一定用 mv 备份 src 目录!!!
   cd /data
   mv src src.bak</code>
- 备份 <code>install</code> 目录
    <code>bash
    cd /data
    #请不要使用mv命令备份，一定使用cp备份install目录，不然会导致app.token发生改变
    cp -a install install.bak</code></p>
<ul>
<li>解压包</li>
</ul>
<p><code>bash
   tar xf bkce_product-5.0.x.tgz -C /data/  #软件包
   tar xf bkce_common-https-xxx.tgz -C /data/ #公共组件包</code></p>
<ul>
<li>恢复证书</li>
</ul>
<p><code>bash
   cp src.bak/cert/* src/cert/</code>
- 恢复 CICDKit 安装包</p>
<p><code>bash
  # 如果你安装了cicdkit请执行下面操作，该版本目前只支持http部署，若你没有安装则跳过
  cp -a src.bak/cicdkit src/
  cp -a src.bak/service/mysql57   src/service/</code></p>
<h3 id="_2">升级部署脚本</h3>
<ul>
<li>
<p>在中控机执行</p>
</li>
<li>
<p>解压 install_ce-x.x.tar.gz 包，内容覆盖到 install 目录中去</p>
<p><code>bashplainplainplainplainplainplainplainplainplainplainplainplainplainplainplainplainplainplainplain
   tar xf install_ce-x.x.tar.gz -C /data/</code>
   - 还原部署配置<code>（globals.env  ports.env）</code></p>
<p><code>bash
   cd /data/install.bak
   cp -a globals.env  ../install
   # 注意paas登录密码如果你在界面已经修改，请务必将`globals.env`内的`paas_admin_pass`的值改为一致
   # ports.env文件，如果您没有更改过文件内的端口信息请使用最新ports.env文件的即可，如果有更改过请\
   # 替换install/目录下的ports.env文件并根据下面的指引更新ports.env文件。</code>
- 编辑 <code>globals.env</code>，新增以下信息</p>
<p>```bash</p>
<h1 id="httphttps">设置 HTTP/HTTPS 模式</h1>
<p>export HTTP_SCHEMA='http'</p>
<h1 id="ntp">在以下数组中填写 NTP 主服务器的上游时间服务器</h1>
<h1 id="export-ntp_server-0cnpoolntporg-1cnpoolntporg-2cnpoolntporg-3cnpoolntporg">export NTP_SERVER=( 0.cn.pool.ntp.org 1.cn.pool.ntp.org 2.cn.pool.ntp.org 3.cn.pool.ntp.org )</h1>
<p><code>``
- 编辑</code>ports.env`</p>
</li>
</ul>
<p>```bash
  # 新增以下端口
  export GSE_SYNCDATA_PORT=52050
  export CMDB_DATACOLLECTION_PORT=33084</p>
<p>#修改以下端口信息
  export DEFAULT_HTTPS_PORT=8443改为443
  export JOB_API_PORT=8443改为8444
  export LICENSE_PORT=443改为8443
  ```</p>
<ul>
<li>恢复 CICDKit 脚本包</li>
</ul>
<p><code>bash
  #如果你已经部署 CICDKit 请执行，若没有请忽略
  cp -a install.bak/parse_config  install/   
  cp -a install.bak/third/*  install/third/</code>
- 同步数据</p>
<p><code>bash
  ./bkcec sync all  #同步新的软件包</code></p>
<h2 id="_3">开始升级</h2>
<h3 id="_4">升级开源组件</h3>
<ul>
<li>安装依赖</li>
</ul>
<p><code>bash
   ./bkcec install global_pypkg  #安装依赖</code>
- 更新 Nginx</p>
<p>```bash
  # 更新 nginx paas、cmdb、job 启用 https。脚本自动部署使用自签名证书\
  # 路径在：/data/src/cert/bk_domain.crt、 /data/src/cert/bk_domain.key
  cd /data/install</p>
<p>./bkcec install nginx 1
  ./bkcec start nginx
  ./bkcec status nginx
  ```</p>
<h3 id="_5">升级蓝鲸组件</h3>
<ul>
<li>更新 License</li>
</ul>
<p><code>bash
  cd /data/install
  ./bkcec upgrade license # 更新配置，适配新的端口
  ./bkcec start license # 启动进程
  ./bkcec status license # 查看状态</code>
- 更新 GSE</p>
<p><code>bash
  cd /data/install/
  ./bkcec install gse
  ./bkcec start gse
  ./bkcec status gse  #如果有个别进程显示ERROR status状态，是启动时间比较慢，可尝试多刷新几次。</code></p>
<ul>
<li>更新 PaaS</li>
</ul>
<p><code>bash
  ./bkcec upgrade paas
  ./bkcec start paas
  ./bkcec status paas</code></p>
<ul>
<li>更新 CMDB</li>
</ul>
<p><code>bash
  ./bkcec upgrade cmdb  #升级过程中会提示 initdata cmdb error 请忽略
  ./bkcec start cmdb
  ./bkcec status cmdb
  ./bkcec initdata cmdb  #重新初始化 cmdb</code></p>
<ul>
<li>更新 JOB</li>
</ul>
<p><code>bash
  ./bkcec upgrade job
  ./bkcec start job
  ./bkcec status job</code>
- 迁移 <code>job</code> 执行输出日志</p>
<ul>
<li>跳转 <a href="../../升级指引/update_patch/JobLog.md">JobLog 迁移文档</a></li>
</ul>
<p>```bash
  #验证作业平台功能是否正常，如果正常继续下面的操作
  ./bkcec stop job # 迁移 joblog 日志准备
  # 查看 JobLog 迁移文档</p>
<p>1.下载迁移脚本工具包</p>
<p>2.上传到 job 所在服务器，操作方法请参考迁移操作说明文档
  ```</p>
<ul>
<li>更新 BKDATA</li>
</ul>
<p><code>bash
  ./bkcec upgrade bkdata
  ./bkcec start bkdata
  ./bkcec status  bkdata</code></p>
<ul>
<li>更新 FTA</li>
</ul>
<p><code>bash
  ./bkcec upgrade fta
  ./bkcec start fta
  ./bkcec status fta</code>
- 更新 PaaS_Agent</p>
<p>```bash
  # 更新appo
  ./bkcec render appo
  ./bkcec start appo
  ./bkcec status appo</p>
<p># 更新appt
  ./bkcec render appt
  ./bkcec start appt
  ./bkcec status appt<br />
  ```</p>
<h4 id="saas">升级 SaaS</h4>
<ul>
<li>
<p>升级 SaaS</p>
<p><code>bash
 ./bkcec install  saas-o  #安装 saas</code></p>
</li>
</ul>
<h4 id="agent">升级 Agent</h4>
<ul>
<li>
<p>升级蓝鲸所在机器的 gse_agent 在中控机执行</p>
<p><code>bash
cd /data/install
source utils.fc
for ip in ${ALL_IP[@]}; do
    ssh $ip "wget http://$NGINX_IP:$DEFAULT_HTTP_PORT/download/agent_setup_pro.sh; \
        bash agent_setup_pro.sh -m client -u"
done</code>
  - 升级 业务机器 的 gse agent</p>
<ul>
<li>请使用 【节点管理】 app 的 agent 升级功能</li>
</ul>
</li>
<li>
<p>手动升级方法</p>
<p><code>bash
  # 登录 需要升级的机器
wget http://$NGINX_IP:$DEFAULT_HTTP_PORT/download/agent_setup_pro.sh
bash agent_setup_pro.sh -m client -u</code></p>
</li>
</ul>
<h2 id="_6">验证</h2>
<ul>
<li>各平台可正常访问</li>
</ul><h1 id="v4116-v51">社区版 V4.1.16 升级至 v5.1 指引</h1>
<h2 id="_1">升级前准备</h2>
<ul>
<li>查看 MySQL 占用磁盘空间大小</li>
<li>
<p>由于社区版 5.1 的 MySQL 版本从 5.5 升级到 5.7，且蓝鲸组件已经适配 MySQL5.7，所以本次升级的开源组件有 <code>MySQL</code>、<code>Redis</code>、 <code>Nginx</code>、<code>consul</code>。</p>
</li>
<li>
<p>当 MySQL 数据量超过 50G 以上的，可根据自身情况考虑是否清理部分日志表。</p>
</li>
<li>
<p>清理的方式：只用链接到 MySQL 数据库后使用 truncate 或 delete 的方式。</p>
</li>
<li>
<p>解压 <code>src</code></p>
</li>
<li>
<p>停进程</p>
</li>
</ul>
<p><code>bash
  cd /data/install
  echo fta bkdata appo appt gse  job cmdb paas redis  nginx consul license | xargs -n1 ./bkcec stop
  # 观察进程是否为EXIT
  echo fta bkdata appo appt gse job cmdb paas redis  nginx consul license  | xargs -n1 ./bkcec status</code></p>
<ul>
<li>备份 src 目录</li>
</ul>
<p><code>bash
   # 中控机执行
   # （必须）请一定用 mv 备份 src 目录!!!
   cd /data
   mv src src.bak</code>
- 备份 install 目录
    <code>bash
    cd /data
    #请不要使用 mv命令备份，一定使用cp备份install目录，不然会导致app.token发生改变。
    cp -a install install.bak</code></p>
<ul>
<li>解压包</li>
</ul>
<p><code>bash
   tar xf bkce_src-5.x.x.tgz -C /data/  #整包(含src，install目录)</code></p>
<ul>
<li>恢复证书</li>
</ul>
<p><code>bash
   cp src.bak/cert/* src/cert/</code>
- 恢复 CICDKit 安装包</p>
<p><code>bash
  # 如果你安装了 cicdkit 请执行下面操作，该版本目前只支持http部署，若你没有安装则跳过
  cp -a src.bak/cicdkit src/
  cp -a src.bak/service/mysql57   src/service/</code></p>
<h2 id="_2">升级部署脚本</h2>
<ul>
<li>
<p>还原部署配置 <code>（globals.env  ports.env）</code></p>
</li>
<li>
<p>恢复 <code>globals.env</code> 相关配置信息</p>
<ul>
<li>自行比对新老文件的差异，将旧的 <code>globals.env</code> 文件的 <code>#域名信息</code>、<code>#DB信息</code>、<code>#账户信息</code>、<code>GSE\NGINX_WAN_IP</code>、<code>#设置HTTP/HTTPS模式</code> 同步修改到新的 <code>globals.env</code> 配置文件内，务必谨慎对比，账户密码信息至关重要，新配置文件的新增内容不可删除。
<img alt="" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/globals.env.sample2.png" />
<img alt="" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/globals.env.sample3.png" /></li>
</ul>
</li>
<li>
<p>恢复 <code>ports.env</code> 相关配置信息</p>
<ul>
<li>自行比对新老文件的差异，将旧的 <code>ports.env</code> 文件的差异信息同步修改到新的 <code>ports.env</code> 文件内，如果您未修改过 <code>ports.env</code> 文件内的端口，可忽略本步骤。</li>
</ul>
</li>
<li>
<p>更新 <code>install.config</code></p>
<ul>
<li>根据 <code>install.config.new.sample</code> 文件的 <code>[bkce-basic]</code> 格式更新 <code>install.config</code>文件。</li>
<li>示例：
  ```bash
  # 原install.config格式
  10.0.0.1 nginx，appt，rabbitmq，kafka，zk，es，bkdata，consul，fta
  10.0.0.2 mongodb，appo，kafka，zk，es，mysql，beanstalk，consul
  10.0.0.3 paas，cmdb，job，gse，license，kafka，zk，es，redis，consul，influxdb
  # 变更后的格式
  [bkce-basic]
  10.0.0.1 nginx，appt，rabbitmq，kafka(config)，zk(config)，es，bkdata(databus)，bkdata(dataapi)，bkdata(monitor)，consul，fta
  10.0.0.2 mongodb，appo，kafka(config)，zk(config)，es，mysql，beanstalk，consul
  10.0.0.3 paas，cmdb，job，gse，license，kafka(config)，zk(config)，es，redis，consul，influxdb</li>
</ul>
<blockquote>
<blockquote>
<p>Note:原则是不改变原模块所在IP的机器，只新增格式zk(config)，kaka(config)，bkdata(databus)，bkdata(dataapi)，bkdata(monitor)。\
  另：install.config.new.sample内的其他bcs相关模块如需要安装请下载相关安装包解压并新增机器部署bcs，bcs部署机器不能复用[bkce-basic]的机器。
  ```</p>
</blockquote>
</blockquote>
</li>
<li>
<p>恢复 CICDKit 安装包</p>
</li>
</ul>
<p><code>bash
  #如果你已经部署 CICDKit 请执行，若没有请忽略
  cp -a /data/src.bak/cicdkit src/
  cp -a /data/src.bak/service/mysql57 src/service</code></p>
<ul>
<li>恢复 CICDKit 脚本包</li>
</ul>
<p><code>bash
  #如果你已经部署CICDKit请执行，若没有请忽略
  cp -a install.bak/parse_config  install/   
  cp -a install.bak/third/*  install/third/</code></p>
<ul>
<li>升级前检查</li>
</ul>
<p><code>bash
  # 中控机查看
  cat /data/install/.path #查看安装路径是否为空
  ll /data/install/.migrate/ # 查看目录下sql标记文件是否存在</code></p>
<ul>
<li>同步数据</li>
</ul>
<p><code>bash
  ./bkcec sync all  #同步新的软件包</code></p>
<blockquote>
<p>Note: 执行同步过程中，可能有文件不存在的报错，报错文件是点号开头的隐藏文件，可以忽略，是因为并发
分发文件引起的，属于正常现象。
  <img alt="" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/sync1.png" /></p>
</blockquote>
<h2 id="_3">开始升级</h2>
<h3 id="_4">升级开源组件</h3>
<ul>
<li>安装依赖</li>
</ul>
<p><code>bash
   ./bkcec install global_pypkg  #安装依赖</code></p>
<ul>
<li>
<p>更新 Consul
  <code>bash
  ./bkcec install consul
  ./bkcec start consul</code></p>
</li>
<li>
<p>更新 Nginx</p>
</li>
</ul>
<p>```bash
  # 更新nginx paas、cmdb、job启用https。脚本自动部署使用自签名证书\
  # 路径在：/data/src/cert/bk_domain.crt、 /data/src/cert/bk_domain.key
  # 升级Nginx版本，如果你系统是Centos7.0以下的版本需要自行编译nginx1.11.9版本安装，或者下载nginx-1.11.9-1.el6.ngx.x86_64.rpm 版本替换src/nginx/nginx-1.11.9-1.el7.ngx.x86_64.rpm 包</p>
<p>./bkcec install nginx<br />
  ./bkcec start nginx
  ./bkcec status nginx
  ```
- 更新 Redis</p>
<p><code>bash
  ./bkcec install redis   # 升级Redis版本，另Centos6的系统不支持升级
  ./bkcec start redis
  ./bkcec status redis</code>
- 更新 MySQL</p>
<ul>
<li>
<p>备份数据库，也可自行选择其他方式备份数据库。</p>
<p>```bash</p>
<h1 id="mysql">登陆MySQL机器执行</h1>
<p>source /data/install/utils.fc
mkdir -p /data/dbbak
cd /data/dbbak
cat &gt;dbbackup_mysql.sh &lt;&lt;EOF</p>
<h1 id="binbash">!/bin/bash</h1>
<p>ignoredblist='mysql|information_schema|performance_schema|test'
dblist="\$(mysql -u$MYSQL_USER -p$MYSQL_PASS -h$MYSQL_IP -P$MYSQL_PORT -Nse "show databases;"|grep -Ewv "\$ignoredblist"|xargs echo)"
mysqldump -u$MYSQL_USER -p$MYSQL_PASS -h$MYSQL_IP -P$MYSQL_PORT  --skip-opt --create-options --default-character-set=utf8mb4 -R  -E -q --single-transaction --no-autocommit --master-data=2 --max-allowed-packet=1G  --hex-blob  -B  \$dblist &gt; /data/dbbak/bk_mysql_alldata.sql
EOF</p>
<h1 id="_5">执行备份操作</h1>
<p>sh dbbackup_mysql.sh</p>
<h1 id="_6">查看导出是否正确</h1>
<p>grep 'CREATE DATABASE' bk_mysql_alldata.sql</p>
<p><code>``
  - 停止</code>MySQL`进程</p>
<p>```bash</p>
<h1 id="_7">中控机执行</h1>
<p>./bkcec stop mysql # 停止 MySQL 原进程
./bkcec status mysql # 确认进程是否停止
```</p>
</li>
<li>
<p>备份 <code>MySQL5.5</code> 软件和数据目录，配置文件等</p>
<p>```bash</p>
<h1 id="mysql_1">备份，MySQL 机器执行</h1>
<p>mv /data/bkce/service/mysql /data/bkce/service/mysql55
mv /data/bkce/public/mysql /data/bkce/public/mysql55
mv /data/bkce/etc/my.cnf /data/bkce/etc/my.cnf.55
mv /etc/my.cnf /etc/my.cnf.55
```
  - 安装 MySQL</p>
<p>```bash</p>
<h1 id="mysql_2">中控机执行，升级 MySQL 版本</h1>
<p>./bkcec install mysql # 开始更新
./bkcec start mysql
./bkcec status mysql
```</p>
</li>
<li>
<p>恢复备份数据</p>
<p>```bash</p>
<h1 id="mysql_3">MySQL 机器执行</h1>
<p>cd /data/dbbak</p>
<h1 id="_8">恢复数据，等待执行完成</h1>
<p>mysql --default-character-set=utf8mb4&lt;bk_mysql_alldata.sql</p>
<h1 id="mysql_4">中控机重新初始化MySQL</h1>
<p>./bkcec initdata mysql
```</p>
</li>
</ul>
<h3 id="_9">升级蓝鲸组件</h3>
<ul>
<li>更新 License</li>
</ul>
<p><code>bash
  ./bkcec install license # 更新配置，适配新的端口
  ./bkcec start license # 启动进程
  ./bkcec status license # 查看状态</code></p>
<ul>
<li>更新 PaaS</li>
</ul>
<p>```bash</p>
<p># 登录PaaS机器
  mv /data/bkce/open_paas /data/bkce/open_paas_bak</p>
<p># 中控机执行
  ./bkcec install paas
  ./bkcec upgrade paas
  ./bkcec start paas
  ./bkcec status paas
  ```</p>
<ul>
<li>更新 CMDB</li>
</ul>
<p><code>bash
  ./bkcec install cmdb
  ./bkcec start cmdb
  ./bkcec status cmdb
  ./bkcec upgrade cmdb</code>
- 更新 GSE</p>
<p><code>bash
  ./bkcec install gse
  ./bkcec initdata gse
  ./bkcec start gse
  ./bkcec status gse  #如果有个别进程显示 ERROR status 状态，是启动时间比较慢，可尝试多刷新几次。
  ./bkcec pack gse_plugin</code></p>
<ul>
<li>更新 JOB</li>
</ul>
<p><code>bash
  ./bkcec install job
  ./bkcec upgrade job
  ./bkcec start job
  ./bkcec status job</code></p>
<ul>
<li>更新 BKDATA</li>
</ul>
<p><code>bash
  ./bkcec install bkdata
  ./bkcec upgrade bkdata
  ./bkcec start bkdata
  ./bkcec status  bkdata</code></p>
<ul>
<li>更新 FTA</li>
</ul>
<p><code>bash
  ./bkcec install fta
  ./bkcec upgrade fta
  ./bkcec start fta
  ./bkcec status fta</code></p>
<ul>
<li>更新 PaaS_Agent</li>
</ul>
<p>```bash
  # 更新appo
  ./bkcec upgrade appo
  ./bkcec start appo
  ./bkcec status appo
  ./bkcec activate appo</p>
<p># 更新appt
  ./bkcec upgrade appt
  ./bkcec start appt
  ./bkcec status appt
  ./bkcec activate appt
  ```</p>
<h3 id="saas">升级 SaaS</h3>
<ul>
<li>
<p>升级 <code>saas</code></p>
<p><code>bash
 ./bkcec install  saas-o  #安装saas</code></p>
</li>
</ul>
<h3 id="agent">升级 Agent</h3>
<ul>
<li>
<p>升级蓝鲸所在机器的 gse_agent
    在中控机执行</p>
<p><code>bash
cd /data/install
./bk_install gse_agen</code>
  - 升级 业务机器 的 gse agent
- 请使用 【节点管理】 app 的 agent 升级功能</p>
</li>
</ul>
<h2 id="_10">验证</h2>
<ul>
<li>各平台可正常访问</li>
</ul><h1 id="v50-v51">社区版 V5.0 升级至 v5.1 指引</h1>
<h2 id="_1">升级前准备</h2>
<ul>
<li>
<p>查看 MySQL 占用磁盘空间大小</p>
</li>
<li>
<p>由于社区版 5.1 的 MySQL 版本从 5.5 升级到 5.7，且蓝鲸组件已经适配 MySQL5.7，所以本次升级的开源组件有 <code>MySQL</code>、<code>Redis</code> 、<code>Nginx</code>、<code>consul</code>。</p>
</li>
<li>
<p>当 MySQL 数据量超过 50G 以上的，可根据自身情况考虑是否清理部分日志表。</p>
</li>
<li>
<p>清理的方式：只用链接到 MySQL 数据库后使用 truncate 或 delete 的方式。</p>
</li>
<li>
<p>解压 src</p>
</li>
<li>
<p>停进程</p>
</li>
</ul>
<p><code>bash
  cd /data/install
  echo fta bkdata appo appt gse  job cmdb paas redis nginx consul  | xargs -n1 ./bkcec stop
  # 观察进程是否为EXIT
  echo fta bkdata appo appt gse job cmdb paas redis nginx consul  | xargs -n1 ./bkcec status</code></p>
<ul>
<li>备份 src 目录</li>
</ul>
<p><code>bash
  # 中控机执行
  # （必须）请一定用 mv 备份 src 目录。
  cd /data
  mv src src.bak</code></p>
<ul>
<li>备份 install 目录</li>
</ul>
<p><code>bash
  #请不要使用mv命令备份，一定使用cp备份install目录，不然会导致 install/.app.token发生改变
  cp -a install install.bak</code></p>
<ul>
<li>解压包</li>
</ul>
<p><code>bash
  tar xf bkce_src-5.x.x.tgz -C /data/  #整包(含src，install目录)</code></p>
<ul>
<li>恢复证书</li>
</ul>
<p><code>bash
  cp src.bak/cert/* src/cert/</code></p>
<ul>
<li>恢复 CICDKit 安装包</li>
</ul>
<p><code>bash
  # 如果你安装了 cicdkit 请执行下面操作，该版本目前只支持 http 部署，若你没有安装则跳过
  cp -a src.bak/cicdkit src/
  cp -a src.bak/service/mysql57   src/service/</code></p>
<h2 id="_2">升级部署脚本</h2>
<ul>
<li>
<p>还原部署配置 <code>(globals.env  ports.env)</code></p>
</li>
<li>
<p>恢复 <code>globals.env</code> 相关配置信息</p>
<ul>
<li>自行比对新老文件的差异，将旧的 <code>globals.env</code> 文件的 <code>#域名信息</code> <code>#DB信息</code> <code>#账户信息</code> <code>GSE\NGINX_WAN_IP</code> <code>#设置HTTP/HTTPS模式</code>同步修改到新的 <code>globals.env</code> 配置文件内，务必谨慎对比，账户密码信息至关重要，新配置文件的新增内容不可删除。
<img alt="" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/globals.env.sample2.png" />
<img alt="" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/globals.env.sample3.png" /></li>
</ul>
</li>
<li>
<p>恢复 <code>ports.env</code> 相关配置信息</p>
<ul>
<li>自行比对新老文件的差异，将旧的 <code>ports.env</code> 文件的差异信息同步修改到新的 <code>ports.env</code> 文件内，如果您未修改过 <code>ports.env</code> 文件内的端口，可忽略本步骤。</li>
</ul>
</li>
<li>
<p>更新 <code>install.config</code></p>
<ul>
<li>根据 <code>install.config.new.sample</code> 文件的 <code>[bkce-basic]</code> 格式更新 <code>install.config</code> 文件。</li>
<li>示例：
  ```bash
  # 原 install.config格式
  10.0.0.1 nginx，appt，rabbitmq，kafka，zk，es，bkdata，consul，fta
  10.0.0.2 mongodb，appo，kafka，zk，es，mysql，beanstalk，consul
  10.0.0.3 paas，cmdb，job，gse，license，kafka，zk，es，redis，consul，influxdb
  # 变更后的格式
  [bkce-basic]
  10.0.0.1 nginx，appt，rabbitmq，kafka(config)，zk(config)，es，bkdata(databus)，bkdata(dataapi)，bkdata(monitor)，consul，fta
  10.0.0.2 mongodb，appo，kafka(config)，zk(config)，es，mysql，beanstalk，consul
  10.0.0.3 paas，cmdb，job，gse，license，kafka(config)，zk(config)，es，redis，consul，influxdb</li>
</ul>
<blockquote>
<blockquote>
<p>Note:原则是不改变原模块所在IP的机器，只新增格式zk(config)，kaka(config)，bkdata(databus)，\
          bkdata(dataapi)，bkdata(monitor)。\
          另：install.config.new.sample内的其他bcs相关模块如需要安装请下载相关安装包解压并新增机器部署bcs\
          bcs部署机器不能复用[bkce-basic]的机器。
  ```</p>
</blockquote>
</blockquote>
</li>
<li>
<p>恢复 CICDKit 安装包
  ```bash
  #如果你已经部署 CICDKit 请执行，若没有请忽略
  cp -a /data/src.bak/cicdkit src/
  cp -a /data/src.bak/service/mysql57 src/service</p>
</li>
</ul>
<p>```</p>
<ul>
<li>恢复 CICDKit 脚本包</li>
</ul>
<p><code>bash
  #如果你已经部署 CICDKit 请执行，若没有请忽略
  cp -a install.bak/parse_config  install/   
  cp -a install.bak/third/*  install/third/</code>
- 升级前检查
  <code>bash
  # 中控机查看
  cat /data/install/.path #查看安装路径是否为空
  ll /data/install/.migrate/ # 查看目录下sql标记文件是否存在</code></p>
<ul>
<li>同步数据</li>
</ul>
<p><code>bash
  ./bkcec sync all  #同步新的软件包，在同步过程中</code></p>
<blockquote>
<p>Note: 执行同步过程中，可能有文件不存在的报错，报错文件是点号开头的隐藏文件，可以忽略，是因为并发
分发文件引起的，属于正常现象。
  <img alt="" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/sync1.png" /></p>
</blockquote>
<h2 id="_3">开始升级</h2>
<h3 id="_4">升级开源组件</h3>
<ul>
<li>安装依赖</li>
</ul>
<p><code>bash
   ./bkcec install global_pypkg  #安装依赖</code>
- 更新 Consul
  <code>bash
  ./bkcec install consul
  ./bkcec start consul</code></p>
<ul>
<li>更新 Nginx</li>
</ul>
<p><code>bash
  # 更新nginx paas、cmdb、job启用https。脚本自动部署使用自签名证书\
  # 路径在：/data/src/cert/bk_domain.crt、 /data/src/cert/bk_domain.key
  # 升级Nginx版本，如果你系统是Centos7.0以下的版本需要自行编译nginx1.11.9版本安装，或者下载nginx-1.11.9-1.el6.ngx.x86_64.rpm 版本替换src/nginx/nginx-1.11.9-1.el7.ngx.x86_64.rpm 包
  ./bkcec install nginx 1
  ./bkcec start nginx
  ./bkcec status nginx</code>
- 更新 Redis</p>
<p><code>bash
  # 升级Redis版本
  ./bkcec install redis 1  # 升级Redis版本，另Cnetos6不用升级
  ./bkcec start redis
  ./bkcec status redis</code>
- 更新 MySQL</p>
<ul>
<li>备份数据库，也可自行选择其他方式备份数据库。</li>
</ul>
<p>```bash
  # 登陆 MySQL 机器执行</p>
<p>source /data/install/utils.fc
  mkdir -p /data/dbbak
  cd /data/dbbak
  cat &gt;dbbackup_mysql.sh &lt;&lt;EOF
  #!/bin/bash</p>
<p>ignoredblist='mysql|information_schema|performance_schema|test'
  dblist="\$(mysql -u$MYSQL_USER -p$MYSQL_PASS -h$MYSQL_IP -P$MYSQL_PORT -Nse "show databases;"|grep -Ewv "\$ignoredblist"|xargs echo)"
  mysqldump -u$MYSQL_USER -p$MYSQL_PASS -h$MYSQL_IP -P$MYSQL_PORT  --skip-opt --create-options --default-character-set=utf8mb4 -R  -E -q --single-transaction --no-autocommit --master-data=2 --max-allowed-packet=1G  --hex-blob  -B  \$dblist &gt; /data/dbbak/bk_mysql_alldata.sql
  EOF</p>
<p>#执行备份操作
  sh dbbackup_mysql.sh</p>
<p>#查看导出是否正确
  grep 'CREATE DATABASE' bk_mysql_alldata.sql</p>
<p>```</p>
<ul>
<li>停 MySQL 进程</li>
</ul>
<p><code>bash
  # 中控机执行
  ./bkcec stop mysql
  ./bkcec status mysql</code></p>
<ul>
<li>备份 MySQL5.5 软件和数据目录，配置文件等。
  <code>bash
  #备份，MySQL机器执行
  mv /data/bkce/service/mysql /data/bkce/service/mysql55
  mv /data/bkce/public/mysql /data/bkce/public/mysql55
  mv /data/bkce/etc/my.cnf /data/bkce/etc/my.cnf.55
  mv /etc/my.cnf /etc/my.cnf.55</code></li>
<li>安装 MySQL
  <code>bash
  # 中控机执行，升级 MySQL 版本
  ./bkcec install mysql 1
  ./bkcec start mysql
  ./bkcec status mysql</code></li>
<li>恢复备份数据
  <code>bash
  # MySQL机器执行
  cd /data/dbbak
  # 导入数据库
  mysql --default-character-set=utf8mb4&lt;bk_mysql_alldata.sql
  # 中控机重新初始化MySQL
  ./bkcec initdata mysql</code></li>
</ul>
<h3 id="_5">升级蓝鲸组件</h3>
<ul>
<li>更新 PaaS</li>
</ul>
<p>```bash
  # 登录PaaS机器
  mv /data/bkce/open_paas /data/bkce/open_paas_bak</p>
<p># 中控机执行
  ./bkcec install paas
  ./bkcec upgrade paas
  ./bkcec start paas
  ./bkcec status paas
  ```</p>
<ul>
<li>更新 CMDB</li>
</ul>
<p><code>bash
  ./bkcec install cmdb  
  ./bkcec start cmdb
  ./bkcec status cmdb
  ./bkcec upgrade cmdb</code></p>
<ul>
<li>更新 GSE</li>
</ul>
<p><code>bash
  ./bkcec install gse
  ./bkcec upgrade gse # No JSON object could be decode报错属于正常
  ./bkcec start gse
  ./bkcec status gse  #如果有个别进程显示ERROR status状态，是启动时间比较慢，可尝试多刷新几次
  ./bkcec pack gse_plugin</code></p>
<ul>
<li>更新 JOB</li>
</ul>
<p><code>bash
  ./bkcec upgrade job
  ./bkcec start job
  ./bkcec status job</code></p>
<ul>
<li>更新 PaaS_Agent</li>
</ul>
<p>```bash
  # 更新appo
  ./bkcec upgrade appo
  ./bkcec start appo
  ./bkcec status appo
  ./bkcec activate appo</p>
<p># 更新 APPT
  ./bkcec upgrade appt
  ./bkcec start appt
  ./bkcec status appt<br />
  ./bkcec activate appt
  ```</p>
<ul>
<li>更新 BKDATA</li>
</ul>
<p><code>bash
  ./bkcec install bkdata
  ./bkcec upgrade bkdata
  ./bkcec start bkdata
  ./bkcec status  bkdata</code></p>
<ul>
<li>更新 FTA</li>
</ul>
<p><code>bash
  ./bkcec install fta
  ./bkcec upgrade fta
  ./bkcec start fta
  ./bkcec status fta</code></p>
<h3 id="saas">升级 SaaS</h3>
<ul>
<li>升级 SaaS</li>
</ul>
<p><code>bash
   ./bkcec install  saas-o  #安装 saas</code></p>
<h3 id="agent">升级 agent</h3>
<ul>
<li>升级蓝鲸所在机器的 gse_agent
  在中控机执行</li>
</ul>
<p><code>bash
  cd /data/install
  ./bk_install gse_agent</code></p>
<ul>
<li>
<p>升级 业务机器 的 gse agent</p>
</li>
<li>
<p>请使用 【节点管理】 app 的 agent 升级功能</p>
</li>
</ul>
<h2 id="_6">验证</h2>
<ul>
<li>各平台可正常访问</li>
</ul><h1 id="v411x">社区版 V4.1.1x 补丁包升级指南</h1>
<ul>
<li>
<p>适用用户：V4.1.13、V4.1.14、V4.1.15</p>
</li>
<li>
<p>备份数据</p>
</li>
</ul>
<p><code>bash
  cd /data/
  cp -a src src.bak #备份src目录
  cp -a install install.bak   #备份install目录</code>
- 下载部署脚本 <code>install_ce-master-1.4.13.tgz</code> 上传到中控机并解压</p>
<p><code>bash
  cd /data
  tar xf install_ce-master-1.4.13.tgz</code></p>
<ul>
<li>下载 <code>bkce_patch-4.1.16.tgz</code>  <code>bkce_common-1.0.0.tgz</code> 上传到中控机并解压</li>
</ul>
<p><code>bash
  cd /data/
  #解压到src同级目录
  tar xf bkce_patch-4.1.16.tgz /data/   #补丁包
  tar xf bkce_common-1.0.0.tgz /data/   #公共组件包</code>
- 更新脚本</p>
<p>```bash
  cd /data/install.bak
  # ports.env文件有更新，自行对比并更新
  cp -a globals.env /data/install/   #恢复配置文件</p>
<p>cd /data/install
  #编辑globals.env，填写gse,nginx外网IP到括号内
  export GSE_WAN_IP=()
  export NGINX_WAN_IP=()</p>
<p># 同步脚本
  cd /data/install
  ./bkcec sync common #同步最新脚本
  ```</p>
<ul>
<li>更新 RabbitMQ</li>
</ul>
<p>```bash
  # 执行下面操作需要看到有done返回才算成功
  source $CTRL_DIR/utils.fc</p>
<p>rcmd root@$RABBITMQ_IP "rabbitmqctl add_user "bk_monitor" "$(_app_token bk_monitor)""
  rcmd root@$RABBITMQ_IP "rabbitmqctl add_user "bk_bkdata" "$(_app_token bk_bkdata)""
  rcmd root@$RABBITMQ_IP "rabbitmqctl add_user "bk_paas_kibana" "$(_app_token bk_paas_kibana)""
  rcmd root@$RABBITMQ_IP "rabbitmqctl add_user "bk_dataadmin" "$(_app_token bk_dataadmin)""
  rcmd root@$RABBITMQ_IP "rabbitmqctl add_user "bk_dataweb" "$(_app_token bk_dataweb)""
  rcmd root@$RABBITMQ_IP "rabbitmqctl add_user "bk_appo" "$(_app_token bk_appo)""
  rcmd root@$RABBITMQ_IP "rabbitmqctl add_user "bk_appt" "$(_app_token bk_appt)""
  rcmd root@$RABBITMQ_IP "rabbitmqctl add_user "bk_sops" "$(_app_token bk_sops)""
  rcmd root@$RABBITMQ_IP "rabbitmqctl add_user "gcloud" "$(_app_token gcloud)""
  rcmd root@$RABBITMQ_IP "rabbitmqctl add_user "bk_itsm" "$(_app_token bk_itsm)""</p>
<p>rcmd root@$RABBITMQ_IP "rabbitmqctl set_user_tags bk_bkdata management"
  rcmd root@$RABBITMQ_IP "rabbitmqctl add_vhost bk_bkdata"
  rcmd root@$RABBITMQ_IP 'rabbitmqctl set_permissions -p bk_bkdata bk_bkdata ".<em>" ".</em>" ".*"'
  ```</p>
<ul>
<li>更新 Nginx</li>
</ul>
<p><code>bash
  cd /data/install
  ./bkcec stop nginx
  ./bkcec install nginx 1
  ./bkcec start nginx</code></p>
<ul>
<li>更新 PaaS</li>
</ul>
<p><code>bash
  #进入脚本目录
  cd /data/install/
  ./bkcec stop paas
  ./bkcec status paas
  ./bkcec upgrade paas
  ./bkcec start paas
  ./bkcec status paas</code></p>
<ul>
<li>更新 GSE</li>
</ul>
<p><code>bash
  #进入脚本目录
  cd /data/install/
  ./bkcec stop gse
  ./bkcec status gse
  ./bkcec install gse 1
  ./bkcec start gse
  ./bkcec status gse</code></p>
<ul>
<li>更新 BKDATA</li>
</ul>
<p><code>bash
  #进入脚本目录
  cd /data/install/
  ./bkcec stop bkdata
  ./bkcec status bkdata
  ./bkcec upgrade bkdata
  ./bkcec start bkdata
  ./bkcec status bkdata</code></p>
<ul>
<li>更新 FTA</li>
</ul>
<p><code>bash
  #进入脚本目录
  cd /data/install/
  ./bkcec stop fta
  ./bkcec status fta  
  ./bkcec upgrade fta  
  ./bkcec start fta  
  ./bkcec status fta</code></p><h1 id="_1">作业平台社区版日志迁移工具使用说明</h1>
<h2 id="_2">功能</h2>
<ul>
<li>由于社区版 5.0.0 之前的作业执行日志是以文件的形式存放在磁盘上，而 5.0.0 版本之后的作业执行日志存放在 MySQL 中。本工具把日志文件导出成为 SQL 文件，通过执行 sql 脚本迁移执行日志数据到 DB 中。</li>
</ul>
<h2 id="_3">使用说明</h2>
<ul>
<li>提供迁移工具 ce_job_migrate-bin.tgz，解压后目录如下：</li>
</ul>
<p><img alt="JobLog0" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/JobLog0.png" /></p>
<ul>
<li>说明：</li>
</ul>
<p><img alt="JobLog1" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/JobLog1.png" /></p>
<ul>
<li>
<p>具体的数据迁移步骤为：</p>
</li>
<li>
<p>执行前检查。</p>
</li>
<li>
<p>导出日志文件为 sql 脚本。</p>
</li>
<li>
<p>升级 job 到新版本，启动之后验证功能正常。</p>
</li>
<li>
<p>执行工具导出的 sql 脚本，导入原始数据到 db。</p>
</li>
<li>
<p>数据迁移验证。</p>
</li>
</ul>
<h2 id="_4">执行前检查</h2>
<ul>
<li>迁移数据之前需要保证：</li>
<li>
<p>社区版 job 服务停止（避免产生新的数据和影响读取效率）</p>
</li>
<li>
<p>导出操作说明：</p>
</li>
<li>
<p>上传 ce_job_migrate-bin.tgz 到社区版  job 服务器上，并解压缩。</p>
</li>
<li>
<p>进入 job-utils 目录，使用 root 用户执行。</p>
</li>
<li>
<p><img alt="JobLog2" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/JobLog2.png" /></p>
</li>
<li>
<p><img alt="JobLog3" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/JobLog3.png" /></p>
</li>
<li>
<p>脚本会提示输入导出数据的时间范围（作业执行的日志这个日期跟作业平台数据库迁移步骤中选择的时间范围保持一致），建议保留最近的执行日志，而不是全量导出。如果需要全量导出，直接回车即可；全量导出可能会导致导出导入比较耗时。</p>
</li>
<li>
<p>导出数据按照日志产生的日期存放在 job/utils/export_data/log 目录下面。</p>
</li>
<li>
<p><img alt="JobLog4" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/JobLog4.png" /></p>
</li>
<li>
<p>说明：</p>
</li>
<li>
<p><img alt="JobLog5" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/JobLog5.png" /></p>
</li>
<li>
<p>导入操作说明</p>
</li>
<li>
<p>同步导出的 sql 文件到社区版中控机上（比如路径为/ tmp/job/export_data/log/</p>
</li>
<li>cd 到 /tmp/job/export_data/log/ 目录下(确保 MYSQL 命令行能够执行到当前路径下的 sql 文件)。然后登陆 MYSQL:</li>
<li>
<p><img alt="JobLog6" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/JobLog6.png" /></p>
</li>
<li>
<p>使用 MYSQL 命令行，切换到名称为 jobLog 的 schema 下:</p>
</li>
<li>
<p><img alt="JobLog7" src="F:\bkdoc\md_to_pdf/5.1/部署维护/assets/JobLog7.png" /></p>
</li>
<li>
<p>初始化 job 的 db（jobLog，用于存储作业执行日志）。通过 MYSQL 命令行执行。</p>
<p><code>bash
source clean_jobLog_db.sql</code></p>
</li>
<li>
<p>导入数据，通过 MYSQL 命令行执行。
    <code>bash
    source batch_import.sql</code></p>
<blockquote>
<p>注意，必须保证执行过程中没有任何错误；如果出现错误，那么本次数据导入失败，需要分析原因再次清理数据后进行导入。</p>
</blockquote>
</li>
<li>
<p>验证:</p>
</li>
<li>
<p>启动作业平台服务器。</p>
</li>
<li>
<p>检查历史执行作业，查看日志是否完整迁移。</p>
</li>
<li>
<p>验证其他功能。</p>
</li>
</ul><h1 id="_1">补丁包常规更新通用操作指南</h1>
<ul>
<li>下载补丁包上传到中控机</li>
<li>以 open_paas 补丁包更新为例：</li>
</ul>
<p><code>bash
   tar xf open_paas_ce-x.x.x.tgz -C  src/    #解压到src目录下
   cd install/
   ./bkcec stop paas
   ./bkcec upgrade paas
   ./bkcec start paas
   ./bkcec status paas #状态正常，页面访问正常</code></p><h1 id="_1">蓝鲸卸载文档</h1>
<p>如果您确认需要卸载蓝鲸，请注意先清理被蓝鲸管控的主机上安装的 Agent 和下发的采集器后。再卸载蓝鲸后台服务器上安装的服务，也就是 install.config 里配置 IP 地址上的蓝鲸后台服务。</p>
<h2 id="agent">卸载管控机器上的 Agent 和采集器</h2>
<p>卸载 Agent 和采集器</p>
<ul>
<li>
<p>如果使用 SaaS ：节点管理安装 Agent，则使用节点管理的卸载功能即可。</p>
</li>
<li>
<p>如果是手动安装， 按以下步骤来卸载：</p>
</li>
<li>
<p>停 gse_agent ，<code>/usr/local/gse/agent/bin/gsectl stop</code> 。</p>
</li>
<li>
<p>停采集器 ，<code>cd /usr/local/gse/plugins/bin/ &amp;&amp; ./stop.sh basereport</code> 。</p>
</li>
<li>
<p>默认只启动 basereport 和 processbeat 采集器，如果有配置过其他监控采集项，存在其他采集器进程，参考 basereport 方法停掉。 gse_agent 带的采集器进程均在 /usr/local/gse/plugins/bin/ 下。</p>
</li>
<li>
<p>删除 GSE 相关目录 ，<code>rm -rf /usr/local/gse /var/log/gse /var/run/gse /var/lib/gse</code> 。</p>
</li>
</ul>
<h2 id="_2">脚本卸载蓝鲸后台服务</h2>
<p><strong>注意：</strong> 该卸载操作不可逆，也不会备份任何数据，最终会删除 $INSTALL_PATH，$PKG_SRC_PATH，$CTRL_DIR 这三个目录。默认情况下分别是：/data/bce，/data/src，/data/install。请在运行脚本、输入 yes 之前，请三思！</p>
<p>在每台蓝鲸后台服务器上运行：</p>
<div class="codehilite"><pre><span></span><span class="nb">cd</span> /data/install/ <span class="o">&amp;&amp;</span> cp uninstall/uninstall.sh .
bash uninstall.sh
</pre></div>


<h2 id="_3">手动卸载蓝鲸后台服务</h2>
<ul>
<li>手动卸载蓝鲸后台</li>
</ul>
<p>以下操作在中控机上执行:</p>
<ul>
<li>
<p>停止自动拉起 <code>./bkcec clean cron</code>。</p>
</li>
<li>
<p>停止所有进程 <code>./bkcec stop all</code>。</p>
</li>
<li>
<p>确保都停成功 <code>./bkcec status all</code>。</p>
</li>
</ul>
<p>以下操作在每台机器上执行：</p>
<ul>
<li>
<p>如果存在该目录，先解除只读权限，<code>chattr -i /data/install/.migrate/*</code>。</p>
</li>
<li>
<p>删除目录： <code>rm -rf /data/install /data/bkce /data/src</code>。</p>
</li>
<li>
<p>卸载蓝鲸自带的 Python ，<code>rpm -ev python27-2.7.9 python27-devel</code>。</p>
</li>
<li>
<p>卸载 rpm 安装的：<code>yum remove nginx rabbitmq-server beanstalkd</code>。</p>
</li>
<li>
<p>删除 Python 相关文件：<code>rm -f /usr/local/bin/*</code> 注意完整列表见下方。</p>
</li>
</ul>
<p><code>bash
   /usr/local/bin/easy_install           /usr/local/bin/pip            /usr/local/bin/supervisord
   /usr/local/bin/easy_install-2.7       /usr/local/bin/pip2           /usr/local/bin/virtualenv
   /usr/local/bin/echo_supervisord_conf  /usr/local/bin/pip2.7         /usr/local/bin/virtualenv-clone
   /usr/local/bin/pbr                    /usr/local/bin/python         /usr/local/bin/virtualenvwrapper_lazy.sh
   /usr/local/bin/pidproxy               /usr/local/bin/supervisorctl  /usr/local/bin/virtualenvwrapper.sh</code></p>
<ul>
<li>手动清理环境残留</li>
</ul>
<p>以下操作在每台机器上执行：</p>
<ul>
<li>
<p>/etc/hosts 里去掉自动添加的行。</p>
</li>
<li>
<p>/etc/resolv.conf 里去掉 nameserver 127.0.0.1。</p>
</li>
<li>
<p>删除环境变量：<code>rm -f /root/.bkrc</code> ，删除后退出当前会话，重新登陆。</p>
</li>
<li>
<p>删除文件：/etc/rc.d/bkrc.local。</p>
</li>
</ul><h1 id="_1">产品和组件版本</h1>
<p>该文档列出当前最新对外社区版的各蓝鲸产品版本号和安装包自带的开源组件版本。</p>
<h2 id="_2">蓝鲸产品版本</h2>
<ol>
<li>软件包后台版本号，可在部署环境中用命令来查询：</li>
</ol>
<div class="codehilite"><pre><span></span><span class="c1"># 登录到中控机，切换到软件包目录</span>
<span class="nb">cd</span> /data/src

<span class="c1"># 过滤出所有软件的后台版本号</span>
grep . */VERSION */*/VERSION
</pre></div>


<ul>
<li>版本输出示例：</li>
</ul>
<p><code>bash
  bknetwork/VERSION:3.6.0
  cmdb/VERSION:0.0.38
  fta/VERSION:4.1.2
  gse/VERSION:3.2.2
  job/VERSION:4.2.3
  license/VERSION:3.1.4
  open_paas/VERSION:3.0.48
  paas_agent/VERSION:3.0.8
  bkdata/dataapi/VERSION:1.2.92
  bkdata/databus/VERSION:1.2.23
  bkdata/monitor/VERSION:0.1.7</code></p>
<ol>
<li>部署维护脚本包版本号：</li>
</ol>
<div class="codehilite"><pre><span></span><span class="c1"># 登录到中控机，获取部署脚本包的版本号</span>
cat /data/install/VERSION
</pre></div>


<ol>
<li>SaaS 包版本号，在 <strong>蓝鲸工作台 - 开发者中心 - S-mart 应用</strong> 可以看到。</li>
</ol>
<h2 id="_3">蓝鲸自带的开源组件版本</h2>
<p>以下开源组件是包含在蓝鲸提供的 src 包中，按照时拷贝到指定路径安装的。</p>
<ul>
<li>
<p>Consul：<code>consul version</code> v0.8.3。</p>
</li>
<li>
<p>Java：<code>java -version</code> 1.8.0_131。</p>
</li>
<li>
<p>Python:</p>
</li>
<li>
<p><code>/opt/py27/bin/python --version</code> 非 PaaS 用的版本：2.7.10。</p>
</li>
<li>
<p><code>/usr/local/bin/python --version</code> PaaS 专用版本：2.7.9。</p>
</li>
<li>
<p>MySQL：<code>./mysqld --version</code> 5.5.24-patch-1.0。</p>
</li>
<li>
<p>MongoDB：<code>./mongod --version</code>  v3.6.3。</p>
</li>
<li>
<p>Redis：<code>./redis-server --version</code> v3.2.9。</p>
</li>
<li>
<p>InfluxDB：<code>influxd version</code> 1.3.6。</p>
</li>
<li>
<p>ZooKeeper：登陆到 ZK 运行机器执行 <code>source /data/install/utils.fc; echo envi | nc $LAN_IP 2181 | grep version</code> v3.4.10。</p>
</li>
<li>
<p>Kafka：<code>cd /data/src/service/kafka/ &amp;&amp; find libs/ -name "*kafka_*.jar" | head -1 |  cut -d- -f2</code> v0.10.2.0。</p>
</li>
<li>
<p>Elasticsearch：登陆到 ES 运行机器执行 <code>source /data/install/utils.fc; curl $LAN_IP:$ES_REST_PORT</code> v5.4.0。</p>
</li>
</ul>
<p>还有一部分开源组件，是安装脚本使用 <code>yum</code> 来安装的，这些组件版本号取决于安装蓝鲸的
操作系统上配置的 Yum 源中软件仓库的版本。请使用 <code>yum info 包名</code> 来确认。</p>
<ul>
<li>
<p>Nginx</p>
</li>
<li>
<p>RabbitMQ-Server</p>
</li>
<li>
<p>Beanstalk</p>
</li>
</ul>
    </body>
    </html>
    