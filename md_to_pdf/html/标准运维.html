
    <html lang="zh-cn">
    <head>
    <meta content="text/html; charset=utf-8" http-equiv="content-type" />
    <link href="F:\bkdoc\md_to_pdf/default.css" rel="stylesheet">
    </head>
    <body>
    <h1 id="_1">产品简介</h1>
<p>标准运维是通过可视化的图形界面进行任务流程编排和执行的系统，是腾讯蓝鲸产品体系中一款轻量级的调度编排类 SaaS 产品。</p>
<p>标准运维有三大核心服务：
- 调度编排服务：基于蓝鲸 PaaS 平台服务总线（ESB）对接企业内部各个系统 API 的能力，将企业内部多系统间的工作整合到一个流程模版中，实现一键自动化调度。</p>
<ul>
<li>
<p>自助化服务：标准运维通过与蓝鲸集成平台深度整合，为用户提供了 “轻应用” 和 “职能化” 功能，让用户可以将业务日常的运维工作交给产品和职能化人员执行，实现业务的发布、变更等工作自助化。</p>
</li>
<li>
<p>标准插件自主开发：标准插件提供一套完整的开发流程规范，通过丰富的表单界面和验证逻辑将企业内部各个系统、各个平台的 API 组装成一个标准插件模板。使其他的系统通过标准插件的开发模板来调动不同系统间的功能。</p>
</li>
</ul>
<p>现在，蓝鲸标准运维已正式对外开源，GitHub 地址： https://github.com/Tencent/bk-sops</p><h1 id="_1">术语解释</h1>
<h2 id="_2">组件</h2>
<p>在蓝鲸体系里，我们将每一个对接到 ESB（企业服务总线）中的第三方接口称之为组件。</p>
<h2 id="_3">标准插件</h2>
<p>标准运维会根据每个 ESB 组件的业务逻辑进行二次封装，增加丰富的表单界面和验证逻辑，我们将这些称之为标准插件。她可以是一个作业平台的脚本作业，可以是腾讯云某个服务的一次接口调用，也可以是一个定时器等等。</p>
<h2 id="_4">节点</h2>
<p>标准运维中的一个流程单元，包括流程控制节点和任务节点。在执行任务时，每一个节点都会有未执行、正在执行、执行成功、执行失败的状态。</p>
<h2 id="_5">流程控制节点</h2>
<p>标准运维中的一类节点，本身不包含具体执行逻辑，只是用来控制任务流程的执行过程。如开始节点标识任务流程的开始，网关节点控制并行流程和分支流程的开始、结束。</p>
<h2 id="_6">网关节点</h2>
<p>包括并行网关、分支网关和汇聚网关，用来控制并行和分支流程的开始、结束。</p>
<h2 id="_7">并行网关</h2>
<p>用来标识并行流程的开始，通过和汇聚网关配对使用，可以控制多个节点并行执行。</p>
<h2 id="_8">分支网关</h2>
<p>用来标识分支流程的开始，通过和汇聚网关配对使用，可以根据分支表达式的计算结果，动态的控制多个分支中某一个分支执行。</p>
<h2 id="_9">汇聚网关</h2>
<p>用来标识并行流程或者分支流程的结束，请注意，标准运维中并行流程中可以嵌入分支流程，分支流程中也可以再嵌入并行流程，请务必保证汇聚网关和并行网关或分支网关一一对应，而不能出现交叉嵌入或者不配对的情况。</p>
<h2 id="_10">任务节点</h2>
<p>任务节点是标准运维的具体执行逻辑单元，包括标准插件节点和子流程节点，每个任务节点包括基础信息、输入参数和输出参数，其中输入参数和输出参数可以用来勾选生成全局变量，输入参数还可以引用全局变量来简化用户输入。</p>
<h2 id="_11">标准插件节点</h2>
<p>标准运维中的最小执行单元，需要引用标准运维提供的标准插件，表示通过流程模板创建任务时，会执行一次选择的标准插件。</p>
<h2 id="_12">子流程节点</h2>
<p>通过子流程节点，用户可以实现流程模板的复用。一般情况下，用户可以新建多个流程模板，每个流程模板功能比较简单，然后在新建的流程模板中，引用之前创建的简单流程模板作为子流程，组成一个复杂逻辑的新流程模板。</p>
<h2 id="_13">顺序流</h2>
<p>顺序流是标准运维中用来连接两个节点的有向线段，标识任务流程的执行方向。</p>
<h2 id="_14">流程/流程模板</h2>
<p>在标准运维里，每一个基础运维场景的操作指引就是一个流程，流程是创建任务的模板。</p>
<h2 id="_15">任务/任务实例</h2>
<p>在标准运维里，我们可以根据一个流程创建出一个任务，每个任务都是一次真正的业务场景作业，任务可以被暂停、被强制终止。</p>
<h2 id="_16">全局变量</h2>
<p>全局变量是一个流程模板的公共参数，通过 KEY 来做唯一性约束。用户可以在任务节点的输入参数和分支网关表达式中引用，标准运维会在执行任务时自动替换全局变量的引用为全局变量的值。</p>
<h2 id="_17">轻应用</h2>
<p>为了做更精细的权限控制，我们增加了轻应用，你可以通过一个流程模板创建出一个轻应用，并授权给相关人员去执行，轻应用将自动出现在相关人员的蓝鲸桌面上，由于标准运维的任务界面足够简约，所以即便这个人不懂技术也可以执行任务。</p><h1 id="_1">产品架构图</h1>
<p>标准运维后台使用 Python 作为开发语言，使用 Django 开发框架；前端使用 Vue 开发页面，使用 jQuery 开发原子，通过配置式的开发模式，不断降低用户开发原子前端表单的难度。</p>
<p>标准运维的产品结构如图所示：</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/1.png" /></p>
<ul>
<li>
<p>接入层：包含权限控制、API 接口和数据统计等；</p>
</li>
<li>
<p>任务管理层：主要对应标准运维的任务编排和任务控制功能，任务编排包含基础单元标准插件框架和标准插件展示层，任务控制包括创建任务实例的模板校验和参数校验，以及任务实例执行时给用户提供的操作接口如暂停、继续、撤销任务等；</p>
</li>
<li>
<p>流程引擎层：负责解析上层的任务实例，映射节点标准插件对应的服务，并通过底层的蓝鲸服务总线（ESB）调用其他系统的 API（如配置平台的创建集群，作业平台的快速执行脚本等），流程引擎层还包括了具体的任务执行引擎和流程控制、上下文管理等模块。</p>
</li>
</ul><h1 id="_1">产品功能</h1>
<p>标准运维是一套通过成熟稳定的任务调度引擎，把多系统间的工作整合到一个流程，助力运维实现跨系统调度自动化的 SaaS 应用。标准运维拥有可视化的图形界面，用户可通过它实现任务流程编排和执行，包括发布、变更、开区、扩缩容等执行类操作场景。</p>
<h2 id="_2">标准运维</h2>
<p><img alt="功能" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/功能.png" /></p>
<p>​    </p><h1 id="_1">首页</h1>
<p>标准运维在蓝鲸平台上体现为一个工具 APP。首页界面如下所示：是一个全局视图，包含业务的执行任务统计、新建流程类型统计、轻应用类型统计、快速创建任务、业务动态以及任务分类占比等内容。</p>
<ul>
<li>
<p>执行任务统计：包括业务中已经创建的任务数量，以及未执行的任务、执行中的任务、已完成任务的数量。鼠标移动到执行任务附近的图标，点击 【进入】 可以跳转到 "流程模板" 页面，选择流程模板快速创建任务。</p>
</li>
<li>
<p>新建流程统计：包括业务已经创建的流程模板和按照类型区分的统计数量。鼠标移动到新建流程附近的图标，点击 【进入】 可以跳转到 "新建流程模板" 的页面。</p>
</li>
<li>
<p>轻应用统计：包括业务已经创建的轻应用和按照轻应用引用的流程模板类型区分的统计数量。鼠标移动到轻应用附近的图标，点击 【进入】 可以跳转到轻应用管理页面。</p>
</li>
</ul>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/标准运维首页.png" /></p><h1 id="_1">流程模板</h1>
<h2 id="_2">业务流程</h2>
<p>业务流程是标准运维的核心功能。
业务流程页面展示了当前业务下的流程列表，支持高级搜索、新建流程、新建任务、编辑流程、预览流程、克隆流程、权限管理、查看执行历史、删除等操作。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/业务流程.png" /></p>
<p><strong>可视化任务流程配置</strong> 。新建流程时，用户可以通过图形界面进行任务流程编排。在编排页面，用户可以通过左侧的工具栏来添加节点，流程节点包含流程控制节点和任务节点。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/可视化流程.png" /></p>
<p>1、流程控制节点包括：
- 开始节点——标识流程的开始
- 结束节点——标识流程的结束
- 并行网关——标识并行执行的开始
- 分支网关——标识分支执行的开始（每个分支都需要设置分支表达式，执行时只有一条表达式为 True 的分支会被执行）
- 汇聚网关——标识并行或分支的结束</p>
<p>2、任务节点包括标准插件节点和子流程节点。
- 标准插件节点是标准运维内置的最小执行单元，一般对应于蓝鲸服务总线（ESB）的一次接口调用或者标准运维内置服务,如：定时。
- 子流程节点可以选择用户已经创建的流程模板，在新的流程中引用并作为子流程执行。</p>
<p>点击某一个任务节点时，会弹出该节点的参数和配置，不同类型的标准插件参数各不相同，但都可以勾选到全局变量区或者引用全局变量。</p>
<p>每个任务节点可以设置 "失败处理" 和 "是否可选" 属性，勾选了 "是否可选" 的节点在执行任务前的 "节点选择" 阶段可以选择本次任务是否执行该节点；勾选了 【自动忽略】 的节点在执行时不论是否成功都不会中断任务流程，而是继续执行后续的节点。</p>
<h2 id="_3">公共流程</h2>
<p>公共流程是标准运维方便用户在不同业务中共用同一套流程模板的功能。支持业务流程在不同环境之间的迁移，导入和导出。</p>
<p>公共流程页面展示了管理员创建的公共流程列表，包含了高级搜索、新建任务、权限管理、查看执行历史等操作。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/公共流程.png" /></p>
<blockquote>
<p>注意：
导航进入 <strong>管理员入口-公共流程</strong> ，支持管理员新建、导入、导出、编辑公共流程、克隆流程和删除公共流程。</p>
</blockquote><h1 id="_1">周期任务</h1>
<p>周期任务能够满足用户对流程模板定期执行任务的需求。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/43.png" /></p>
<ul>
<li>新建周期任务</li>
</ul>
<p>用户可以在新建任务时通过参数填写的页面中执行计划选择周期执行任务来创建一个周期任务。填写周期表达式来确认任务触发执行的时间。周期表达式可以通过两种方式设置：选择生成，或者手动输入。</p>
<p><img alt="周期任务1" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/周期任务1.png" /></p>
<ul>
<li>周期表达式</li>
</ul>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/45.png" /></p>
<ul>
<li>生成周期任务</li>
</ul>
<p>新建成功后，周期任务会按照周期规则自动执行，在页面上能够对周期任务执行暂停、编辑、删除、执行任务操作。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/46.png" /></p>
<ul>
<li>编辑周期任务</li>
</ul>
<p>用户能够编辑周期任务来修改周期规则以及参数信息。注意：周期任务的状态为”暂停“时才可编辑。如果周期任务为”启动“中时，需将其暂停后再进行编辑操作。</p>
<p><img alt="周期任务2" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/周期任务2.png" /></p>
<ul>
<li>执行历史</li>
</ul>
<p>用户能够查看周期任务完整的执行历史，来查看任务执行情况。并可以对已执行的任务进行克隆、删除。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/48.png" /></p><h1 id="_1">任务记录</h1>
<p><strong>任务历史可追溯</strong>。用户在任务记录页面，可以追溯之前的任务执行情况。</p>
<p><img alt="任务记录" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/任务记录.png" /></p>
<p>可对执行过的任务进行克隆，删除管理。同时，可展开“高级搜索”进行过滤查询。</p><h1 id="_1">业务配置</h1>
<p>业务配置是当前业务下的公共配置，主要是业务执行者设置，业务执行者只能被设置为使用过标准运维的业务运维，可以为空。当设置了执行者时，业务非运维人员和职能化人员执行任务时会以业务执行者身份执行任务，调用 ESB；运维人员执行任务时，依然以本人身份执行任务。当业务执行者为空时，业务非运维人员和职能化人员执行任务时会以任一使用过标准运维的业务运维身份执行任务。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/业务配置.png" /></p><h1 id="_1">轻应用</h1>
<p><strong>零成本创建“轻应用”</strong> 。业务运维人员将日常工作标准化后，以标准运维中一个模板的形式提供给业务非技术人员使用，为了降低使用者的操作风险和使用成本，将该模板以独立 SaaS 应用的方式指定给授权者使用，这种不需要开发、零成本快速生成的 SaaS 应用称为 "轻应用" 。标准运维通过与蓝鲸集成平台深度结合，可以提高业务的自助化能力，便于业务非技术人员执行日常工作。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/sops001.png" /></p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/sops002.png" /></p>
<p>在轻应用页面，用户可以根据一个已执行完成的任务创建一个轻应用到指定用户的蓝鲸桌面。</p>
<ul>
<li>新建轻应用</li>
</ul>
<p>用户可以选择一个流程模板创建出一个轻应用，这个轻应用可以在蓝鲸 PaaS 的应用市场中打开或添加到桌面，对使用人员而言，轻应用只需要关注一个流程模板的参数填写和任务操作，由于页面足够的简洁和友好，一个非技术人员也可以通过轻应用执行任务，这也就是标准运维提供的自助化服务之一。</p>
<blockquote>
<p>注意，只有业务在配置平台设置的运维人员、开发人员、产品人员、测试人员和在 PaaS 人员管理中设置的职能化角色才能访问轻应用，如果需要某个用户可以通过轻应用创建任务和执行任务，请提前在任务流程中选择轻应用引用的流程模板，在权限管理中对用户授权。</p>
</blockquote>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/26.png" /></p>
<ul>
<li>编辑轻应用</li>
</ul>
<p>如果需要修改轻应用的名称、简介或者 Logo，请在轻应用列表中，通过鼠标选择需要修改的轻应用，点击编辑图标后，在弹窗中填写修改后的参数。注意，不能修改轻应用引用的流程模板，如果需要这样做，请删除旧轻应用后重新创建新的轻应用，并引用新的流程模板。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/27.png" /></p>
<ul>
<li>删除轻应用</li>
</ul>
<p>如果需要删除轻应用，请在标准运维轻应用列表中，通过鼠标选择需要修改的轻应用，点击删除图标后，在弹窗中二次确认并删除，删除成功后会同步删除 PaaS 上 的轻应用。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/28.png" /></p><h1 id="_1">管理员入口</h1>
<h2 id="_2">后台管理</h2>
<p>包含远程插件包源管理，和远程插件同步。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/后台管理.png" /></p>
<p>后台管理可以让用户不修改标准运维源码就可以加载第三方插件，主要是为了解决标准插件开发和维护流程复杂的问题。 在之前的版本中， 用户如果想开发自定义插件，并发布到官方标准运维 SaaS 上使用，一般需要先拉取 bk-sops 源码在本地开发插件，测试通过后， 还需要把官方标准运维 SaaS 版本包在本地解压，然后添加自定义插件包到版本包中，并修改部分 settings 配置，然后重新打包并上传部署； 如果自定义插件需要额外安装 python 依赖包，那么用户还需要在 CentOS 机器上执行打包脚本才能完成官方 S-mart 应用打包操作。并且，后续用户开发的自定义插件有任何版本变动，都需要重新打包、上传、部署，维护成本很高。</p>
<p>而后台管理中通过对远程插件包的管理，让用户可以不需要解压官方包以及重新打包，只需要在自定义插件开发测试完成后， 在标准运维配置自定义插件包源信息，然后重新部署应用，就能自动加载插件。</p>
<p>1.配置主包源信息。在配置页面，填入需要的信息
<img alt="" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/远程1.png" />
<img alt="" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/远程2.png" />
<img alt="" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/远程4.png" /></p>
<p>2.重新部署后成功加载插件效果 在"新建流程"中编辑默认的标准插件节点，可以看到远程插件包源中的"自定义原子(CUS)-测试 1"，并且选择该插件后页面渲染正常。
<img alt="" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/远程5.png" /></p>
<h2 id="_3">运营数据</h2>
<p>包含流程统计、任务统计、标准插件统计、轻应用统计 4 个维度的运营数据分析。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/运营数据.png" /></p>
<h2 id="_4">公共流程</h2>
<p>公共流程是标准运维方便用户在不同业务中共用同一套流程模板的功能。通过超级管理员角色新建公共流程，达到多业务共享公共流程模板的目的。</p>
<p>公共流程包含两个入口：</p>
<ul>
<li>管理员角色对公共流程进行新建、导入、导出模板及流程的编辑、克隆、删除等操作的管理员入口。该入口只对管理员开放。</li>
</ul>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/49.png" /></p>
<ul>
<li>管理员角色对公共流程分配业务权限给其他角色，能够对公共流程进行新建任务、查看执行历史等操作的入口。</li>
</ul>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/50.png" /></p><h1 id="_1">新建流程</h1>
<p>具体步骤：</p>
<p><strong>新建流程 - 流程名称 - 流程节点 - 全局变量</strong></p>
<p>1、新建流程</p>
<p>用户可以通过对标准插件节点、子流程节点与网关节点的组合，变量的配置与引用，配置出一个业务流程。</p>
<p>流程名称是用户用来描述流程模板的，默认值是 <code>new时间格式串</code>，用户可以自行修改，注意不能包含空格、括号等特殊字符。</p>
<p>用户可以从左边的工具栏，拖拽合适的节点到画布中，并通过连线，组成合法的流程模板。</p>
<p><strong>注意：</strong> 流程名称不能包含'‘"”$&amp;&lt;&gt;非法字符。</p>
<p><img alt="发布1" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/发布1.jpg" /></p>
<p>2、工具栏说明</p>
<p>工具栏中流程节点包含流程控制节点和任务节点。流程控制节点包括：
开始节点——标识流程的开始
结束节点——标识流程的结束</p>
<p>一个合法的流程模板只能有一个开始节点和结束节点，开始节点出度（箭头指向节点的连线数量）只能为 1，入度（箭头背离节点的连线数量）为 0。结束节点入度为 1，出度为 0。</p>
<p><img alt="guide1" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/guide1.png" /></p>
<p>流程控制节点还包括：
并行网关——标识并行执行的开始，
分支网关——标识分支执行的开始，
汇聚网关——标识并行或分支的结束。</p>
<p>请注意，每一个并行网关或者分支网关都需要配置一个汇聚网关来标识并行或分支流程的结束。</p>
<p>并行网关入度为 1，出度不小于 2。并行网关出度上的多个节点在执行时会并发执行，对应的汇聚网关在等待所有并行流程执行完成后才会开始启动后续的流程节点。</p>
<p><img alt="g2" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/g2.png" /></p>
<p>分支网关和并行网关类似，区别在于分支网关出度上的多个节点在执行时会根据分支条件启动分支表达式为 True 的一个分支流程，其他的分支则不会被执行。启动的分支执行完成后就立刻启动对应的汇聚网关，接着执行后续的流程节点。分支表达式的语法请参考 <a href="/10.附录/term2.md#define">附录 2</a> 说明。</p>
<p><img alt="g3" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/g3.png" /></p>
<p>任务节点包括标准插件节点和子流程节点。标准插件节点是标准运维内置的最小执行单元，一般对应于蓝鲸服务总线（ESB）的一次 API 调用或者标准运维内置服务如定时。</p>
<p>单击标准插件节点可以配置标准插件节点的参数。其中标准插件类型可以选择一个标准运维接入的标准插件，输入参数、输出参数和选择的标准插件对应，每个标准插件的参数一般不同，如 "作业平台(JOB)-快速执行脚本" 是对应作业平台的快速执行脚本 API，需要填写脚本类型、脚本内容、脚本参数、超时时间、目标 IP、目标账户等输入参数，在执行时，标准运维会把用户填写的前端参数转换为 ESB 需要的参数格式并调用 API，然后根据 API 返回结果把 JOB 任务 ID、JOB 任务链接、执行结果（成功或失败）作为输出参数展示在执行详情中，后续的流程节点也可以引用前面节点的输出参数。</p>
<p><img alt="发布6" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/发布6.jpg" /></p>
<p>子流程节点可以选择用户已经创建的流程模板，在新的流程中引用并作为子流程执行。子流程节点的输入参数是选择的流程模板中显示属性为 "显示" 的全局变量，也就是该子流程模板单独创建任务时需要填写的任务参数。输出变量是选择的流程模板中勾选了输出属性的全局变量。</p>
<p><img alt="g4" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/sops003.png" /></p>
<p>5、全局变量</p>
<p>全局变量是一个流程模板的公共参数，通过 KEY 来做唯一性约束。用户可以在任务节点的输入参数和分支网关表达式中引用，标准运维会在执行任务时自动替换全局变量的引用为全局变量的值。</p>
<p>全局变量的来源有三种：</p>
<p>一是 通过任务节点的输入参数勾选生成，这类全局变量的类型是 "组件"，并且不能更改；默认值和来源标准插件的输入参数的表单类型一致，如标准插件节点的参数是单选框，勾选生成的全局变量也是单选框。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/sops004.png" /></p>
<p>二是 通过任务节点的输出参数勾选生成，这类全局变量类型也是 "组件"，并且不能更改；无默认值属性，因为这类全局变量的值是由生成该变量的标准插件节点、子流程节点的输出结果自动生成的，用户无法手动设置；此外，这类全局变量的显示属性是 "隐藏"，并且不能更改，表示执行任务时不需要用户手动填写这类参数。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/sops005.png" /></p>
<p>三是 用户在全局变量区点击 【新增变量】 生成，手动添加的全局变量类型可以选择输入框、文本框、日期时间、整数、IP 选择器等，并且可以随时切换；这类变量可以自定义校验规则，这样在创建任务填写参数时，可以避免填写不合法的参数值。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/sops006.png" /></p>
<p>全局变量可以通过 <code>${key}</code> 的语法引用，并且全局变量的默认值中也可以引用其他的全局变量，只要保证无循环引用即可。多个任务节点的输入参数引用同一个全局变量，可以实现参数共享，减少创建任务时需要填写的参数；任务节点输入参数通过形如 <code>xxx${key}</code> 方式部分引用全局变量，可以实现简化输入参数的目的；任务节点输入参数或者分支条件表达式通过引用之前的任务节点的输出参数生成的全局变量，可以实现根据任务节点输出控制后面节点输入参数和分支流程走向。</p>
<p><img alt="g5" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/sops007.png" /></p><h1 id="_1">新建任务</h1>
<p>用户可以在 【流程模板】 页点击流程模板的 【新建任务】 按钮创建一个任务。</p>
<p>具体步骤：</p>
<p>选择任务节点 - 填写参数 - 预览 - 查看参数 - 启动任务</p>
<p><img alt="任务1" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/任务1.jpg" /></p>
<p>1、新建任务时，用户需要选择要执行的任务节点（也可以通过点击执行方案快速选择要执行的任务节点），并点击 【下一步】。注意，只有设置了可选节点属性为 "ON" 的任务节点，才能在节点选择阶段选择不执行，其他的任务节点必须执行。</p>
<p><img alt="新建任务1" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/新建任务1.png" /></p>
<p>节点选择时，可以开启”预览模式“，查看不同方案下的任务模式。</p>
<p><img alt="新建任务2" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/新建任务2.png" /></p>
<p>2、启动任务之前，用户可以点击 【查看参数】 确认变量替换后生成的每个任务节点的参数，如果不符合预期，可以点击 <code>修改参数</code> 重新填写任务的全局变量参数，确认无误后，点击 【执行】 就可以立即启动当前任务流程实例了。</p>
<p><img alt="新建任务3" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/新建任务3.png" /></p>
<p>3、在任务执行过程中，用户可以暂停任务，继续任务或者终止任务，任务执行到某个标准插件失败后也可以选择 【跳过】 或者修改参数后 【重试】。</p>
<p><img alt="新建任务4" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/新建任务4.png" /></p>
<p>执行完成后可以回到任务记录查看任务详情。</p>
<p><img alt="任务列表" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/任务列表.png" /></p>
<p><img alt="新建任务5" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/新建任务5.png" /></p><h1 id="_1">场景案例</h1>
<p>随着业务的不断发展，企业应用系统也变得越来越复杂，不同应用厂商，其背后研发团队间的技术栈，如所使用的开发语言、开发框架、操作系统、数据库等技术组合，以及发布变更、故障处理等运维操作场景和操作流程，都是不同的。应用架构的差异性和复杂性，也给 CI/CD 应用在包交付模式和灵活的编排上提出更多的挑战。</p>
<p>另外研发与运维团队职责不同以及环境差异化，经常导致研发人员在对配置或环境进行修改之后，不会及时告知运维人员；而运维人员发布应用时，由于对运行环境和应用的内部细节缺乏了解，难以正确选择运行环境和控制发布流程，往往会遇到各种各样的问题，沟通成本非常高。</p>
<p>同时，业务需要更频繁的发布，如果仅仅依靠运维人员的手工部署，一方面效率低、易出错，另外也无法满足不断增加的应用系统和部署环境。所以，开发人员对自助发布的需求越来越强烈，希望能够通过自助平台实现一键发布。</p>
<p>依托蓝鲸体系化设计，可以实现流程编排和应用自动发布的标准运维应运而生。
以下图为例，通过标准运维对应用发布流程进行分解，分解后的每个步骤可以包含多个原子，依次进行代码拉取，备份，以及分发文件等操作。我们可以根据固化的发布流程来创建任务，每个任务都是一次真正的业务场景作业，任务可以被暂停、被强制终止。通过标准运维的助力，实现更可靠的发布，提高部署频率，与业务目标保持紧密一致。</p>
<p><img alt="应用交付自动化-1" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/应用交付自动化-1.png" /></p>
<p>标准运维适配场景有：</p>
<ul>
<li>
<p>运维场景：发布、变更、开区、扩缩容等执行类操作</p>
</li>
<li>
<p>其他场景：监控告警、配置管理、开发工具、企业 IT、办公应用、其它</p>
</li>
</ul>
<p>本节介绍运维常见场景之一：业务发布操作。</p>
<h2 id="_2">业务发布操作</h2>
<h3 id="1">1.创建流程模板</h3>
<p>进入新建流程页面，创建流程模板。选择流程模板的类型为 "运维工具"。如果有接入 ESB 消息通道，请选择任务节点失败和完成时通知方式和通知人员分组。</p>
<p>从左侧标准插件区，选择发布流程中需要的标准插件作为流程的节点，拖拽至流程画布中。</p>
<p><img alt="发布1" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/发布1.jpg" /></p>
<p>点击标准插件打开参数配置页，填写参数。</p>
<p><img alt="发布2" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/发布2.jpg" /></p>
<ul>
<li>修改步骤名称为该节点的分组标签；</li>
<li>根据需要配置该标准插件是否需要忽略错误或可选；</li>
<li>勾选 "添加为变量" 添加到全局变量中，便于执行任务时动态修改；</li>
<li>分支设置。节点之间的流转可规则可以通过分支进行设置。</li>
</ul>
<h3 id="2">2.全局变量</h3>
<p>服务器发生故障后，保障下一次应用发布获取最新的 IP 列表，可以通过 IP 选择器实现。</p>
<p><img alt="发布4" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/发布4.jpg" /></p>
<h3 id="3">3.流程分支</h3>
<p>应用发布过程中，执行成功 和 执行失败的处理分支不同，可以通过流程分支功能对上一步执行结果为真或为假来判断。</p>
<p><img alt="发布5" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/发布5.jpg" /></p>
<p>提前引用上一步流程节点的输出参数“执行结果”，将其用于上图中的流程分支表达式。</p>
<p><img alt="发布6" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/发布6.jpg" /></p>
<p>按照上述步骤，完成流程模板的创建。完成后选择“保存”，或者“保存并新建任务（立刻新建任务）”。这里我们以选择“保存”为例。</p>
<h3 id="4">4.执行任务</h3>
<p>流程模板保存完毕之后，回到业务流程列表中，点击“新建任务”。</p>
<p><img alt="任务1" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/任务1.jpg" /></p>
<p>在任务页面，点击“执行”。请参看视频内容。</p>
<p>{% video %}../assets/sops_execution.mp4{% endvideo %}</p>
<p>任务执行之后可以查看每个任务执行详情。</p>
<p>失败的节点会阻塞任务流程，可以单击查看执行详情，了解异常信息内容。</p>
<p>失败的节点可以重试，点击 "重试" 可以重新填写该标准插件节点参数并执行。</p><h1 id="_1">常见问题</h1>
<p>1.标准运维标准插件支持用户接入企业内 IT 系统吗？</p>
<p>支持，接入方式请参考 <a href="5.1/标准运维/附录/Django.md">附录 3：标准插件开发</a>。</p>
<p>2.标准运维点击开始执行任务后报错：<code>taskflow[id=1] get status error: node(nodee37e20…c7fb131) does not exist, may have not by executed</code>，并且在任务列表中查看任务状态是 <code>未知</code>，可能是什么原因？</p>
<p>标准运维执行引擎依赖于蓝鲸的 RabbitMQ 服务和 App 启动的 Celery 进程，请登录服务器确认服务已启动并正常运行，可以查看 App 的 celery.log 日志文件帮助定位问题原因。</p>
<p>3.标准运维能执行任务，但是标准插件节点报错：<code>Trackback…TypeError:int() argument must be a string or a number,not ‘NoneType’</code>，可能是什么原因？</p>
<p>标准运维任务流程的执行状态和标准插件输入、输出等信息缓存依赖 Redis 服务，所以首次部署请务必按照 <a href="5.1/部署维护/SaaS部署/标准运维/sops_install.md">标准运维部署文档</a>，配置 Redis 环境变量后重新部署。</p><h1 id="_1">定义</h1>
<p>分支表达式是一段符合 Python 语法的简单代码，是二元操作符和关键字组成的表达式。</p><h1 id="_1">语法</h1>
<p>二元操作符语法和使用示例参考下面的表格</p>
<table>
<thead>
<tr>
<th>二元操作符</th>
<th>含义</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td>==</td>
<td>等于</td>
<td v1="v1">$</td>
</tr>
<tr>
<td>!=</td>
<td>不等于</td>
<td v1="v1">$</td>
</tr>
<tr>
<td>&gt;</td>
<td>大于</td>
<td v1="v1">$</td>
</tr>
<tr>
<td>&lt;</td>
<td>小于</td>
<td v1="v1">$</td>
</tr>
<tr>
<td>&gt;=</td>
<td>大于等于</td>
<td v1="v1">$</td>
</tr>
<tr>
<td>&lt;=</td>
<td>小于等于</td>
<td v1="v1">$</td>
</tr>
<tr>
<td>in</td>
<td>包含于</td>
<td v1="v1">$</td>
</tr>
<tr>
<td>notin</td>
<td>不包含于</td>
<td v1="v1">$</td>
</tr>
</tbody>
</table>
<p>关键字语法和使用示例参考下面的表格</p>
<table>
<thead>
<tr>
<th>关键字</th>
<th>含义</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td>and</td>
<td>且</td>
<td v1="v1">$</td>
</tr>
<tr>
<td>or</td>
<td>或</td>
<td v1="v1">$</td>
</tr>
<tr>
<td>True<br>true</td>
<td>真</td>
<td v1="v1">$</td>
</tr>
<tr>
<td>False<br>false</td>
<td>假</td>
<td v1="v1">$</td>
</tr>
</tbody>
</table>
<p>分支表达式也可以通过 ${key} 方式引用全局变量，如:
<code>${v1} == ‘1’</code>
<code>‘test’ in ${v1}</code></p><h1 id="_1">分支执行逻辑</h1>
<p>执行到分支网关节点时，标准运维执行引擎分别计算每个分支表达式的结果，得出为 True 或者 False。
如果有多个分支条件为 True，执行分支会根据判定顺序，执行第一个结果为 True 的分支，所以请不要设置多个分支的条件存在并集或者多个分支条件一样，如</p>
<p>分支 1: <code>${v1} &gt; 2</code>
分支 2: <code>${v1} &gt; 1</code>
分支 3: <code>${v1}  &lt;= 1</code></p>
<p>可以改为
分支 1: <code>${v1} &gt; 2</code>
分支 2: <code>${v1} &gt; 1 and ${v1}  &lt;= 2</code>
分支 3: <code>${v1}  &lt;= 1</code></p>
<p>如果所有分支判定为 False，则分支网关执行报错。分支网关出错后需要人工介入，手动指定执行分支，选项是各分支的条件表达式，所以请不要设置多个分支的条件表达式一样，否则出错后无法区分需要执行的分支</p><h1 id="django-app">创建 Django APP 和目录结构</h1>
<p>在根目录下执行 Django-admin startapp custom_atoms ，然后新建 components/collections 和 static/custom_atoms 目录。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/31.png" /></p><h1 id="settings">修改 settings 配置</h1>
<p>打开 conf/settings_custom.py 文件，找到 I NSTALL_APPS_CUSTOM，加入步骤 1）中创建的 custom_atoms。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/32.png" /></p><h1 id="esb-api">接入 ESB API</h1>
<p>如果需要调用自定义的 API，请在完成 ESB 接入后，更新标准运维 bluking/component 下的文件。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/33.png" /></p><h1 id="_1">标准插件后台开发</h1>
<p>在 custom_atoms/components/collections 目录下创建 test.py 文件，其中需要定义的属性和类如下所示。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/34.png" /></p>
<p>test.py 属性详解：
- <strong><em>*</em></strong><strong><em>*</em></strong><strong><em>*<strong> group_name </strong></em></strong><strong><em>*</em></strong><strong><em>*</em></strong>* ：标准插件所属分类（一般是对应 API 的系统简称，如配置平台(CC)）
- class TestCustomService(Service)：标准插件后台执行逻辑
- <strong><em>*</em></strong><strong><em>*</em></strong><strong> need_schedule </strong><strong><em>*</em></strong><strong><em>*</em></strong> = True：是否是异步执行，默认为 False<br />
- interval = StaticIntervalGenerator(5)：异步标准插件的轮询策略
- def execute：前端参数获取、API 参数组装、结果解析、结果输出
- def schedule：轮询逻辑、结果输出
- def outputs_format：输出参数格式化
- class TestCustomComponent(Component)：标准插件定义
- name： 标准插件名称
- code：唯一编码
- bound_service：绑定后台服务
- form：前端表单定义文件路径  </p>
<p>TestCustomService 中 execute 函数详解：
- 可以是任何 Python 代码，如果对应于 ESB API 调用，一般分为参数组装、API 调用、结果解析。
- data 是标准插件前端数据，对应于前端的表单，可以用 get_one_of_inputs 获取某一个参数；执行完成可以使用 set_outputs 写入返回值和异常信息(ex_data)。
- parent_data 是任务的公共参数，包括 excutor—执行者，operator—操作员，biz_cc_id—所属业务 ID。详细请查看 gcloud/taskflow3/utils.py。
- 返回 True 表示标准插件执行成功，False 表示执行失败</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/35.png" /></p>
<p>TestCustomService 中 execute 函数详解：
- 返回列表格式。
- 列表格式的每一项定义一个返回字段，是 execute 函数中的 set_outputs 输出的字段的子集；key—输出字段标识，name—输出字段含义，type—输出字段类型（str、int 等 Python 数据结构）。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/36.png" /></p>
<p>TestCustomService 中 shedule 函数详解：
- 由 interval 控制调用策略，如 pipeline.core.flow.activity.StaticIntervalGenerator（每隔多少秒轮询一次）、DefaultIntervalGenerator（每次轮询间隔时间是上一次的两倍）。
- 使用 self.finish_schedule 结束轮询。
- 返回 True 表示标准插件执行成功，False 表示执行失败。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/37.png" /></p><h1 id="_1">标准插件前端开发</h1>
<p>在 custom_atoms/static/custom_atoms 目录下创建 test 目录，并创建 test_custom.js 文件，注意文件路径和标准插件后台定义的 form 保持一致。通过 $.atoms 注册标准插件前端配置，其中各项含义是：
- test_custom：标准插件后台定义的 code。
- tag_code：参数 code，请保持全局唯一，命名规范为“系统名_参数名”
- type：前端表单类型，可选 input、textarea、radio、checkbox、select、datetime、datatable、upload、combine 等
- attrs：对应 type 的属性设置，如 name、validation</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/38.png" /></p><h1 id="_1">标准插件测试</h1>
<p>创建流程模板，新增标准插件节点，标准插件类型选择新开发的标准插件，展示的输入参数和前端配置项一致，输出参数和后台 outputs_format 一致，其中执行结果是系统默认，值是 True 或 False，表示节点执行结果是成功还是失败。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/39.png" /></p>
<p>根据上一步创建的流程模板，新建任务执行后查看结果。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/40.png" /></p>
<p>如果标准插件执行出错，请先查看节点执行详情，确定是否是代码逻辑异常。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/41.png" /></p>
<p>接着查看 App 组件类型日志，确定是都是 ESB API 调用异常。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/标准运维/assets/42.png" /></p><h1 id="_1">提交代码</h1>
<p>执行 <code>python manage.py collectstatic –noinput</code>，然后就可以提交代码并打包发布了。</p><h1 id="_1">标准插件开发规范</h1>
<ul>
<li>分组命名规则是 "系统名(系统英文缩写")，如："作业平台(JOB)"。</li>
<li>标准插件编码 (code) 使用下划线方式，规则是 "系统名_接口名"，如：job_execute_task。</li>
<li>后台类名使用驼峰式，规则是 "标准插件编码+继承类名"，如：JobExecuteTaskService。</li>
<li>前端 JS 文件目录保持和系统名缩写一致，JS 文件名保持和标准插件编码一致。</li>
<li>参数 tag_code 命名规则是 "系统名_参数名"，这样可以保证全局唯一；长度不要超过 20 个字符。</li>
</ul><h1 id="4">附录 4：安装指南</h1>
<p>详情请参考 <a href="5.1/部署维护/SaaS部署/标准运维/sops_install.md">标准运维部署安装</a>。</p>
    </body>
    </html>
    