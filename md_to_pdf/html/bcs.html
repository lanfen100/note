
    <html lang="zh-cn">
    <head>
    <meta content="text/html; charset=utf-8" http-equiv="content-type" />
    <link href="F:\bkdoc\md_to_pdf/default.css" rel="stylesheet">
    </head>
    <body>
    <h1 id="_1">产品概述</h1>
<p>蓝鲸容器服务（BCS，Blueking Container Service）是 <strong>高度可扩展、灵活易用的容器管理服务</strong>。</p>
<p>蓝鲸容器服务支持两种不同的集群模式，分别为原生 <strong>Kubernetes</strong> 模式和基于 <strong>Mesos</strong> 自研的模式。</p>
<p>用户无需关注基础设施的安装、运维和管理，只需要调用简单的 API，或者在页面上进行简单的配置，便可对容器进行启动、停止等操作，查看集群、容器及服务的状态，以及使用各种组件服务。</p>
<p>用户可以依据自身的需要选择容器编排的方式，以满足业务的特定要求。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Introduction/media/15675817359278.jpg" /></p>
<h2 id="_2">容器服务怎么用</h2>
<p>见下图，只需要三步即可运行服务：</p>
<ol>
<li>
<p>创建集群</p>
</li>
<li>
<p>创建模板集</p>
</li>
<li>
<p>实例化模板集</p>
</li>
</ol>
<p><img alt="-w1678" src="F:\bkdoc\md_to_pdf/5.1/bcs/Introduction/media/15679996186125.jpg" /></p><h1 id="_1">术语解释</h1>
<p>了解蓝鲸容器服务，会涉及到以下基本概念：</p>
<ul>
<li>容器编排引擎：用于容器化应用的自动化部署、扩展和管理的工具或平台，目前行业主流的引擎有 K8S 、Mesos。</li>
<li>集群：是指容器运行所需要的物理机或虚拟机资源的集合，可以选择集群的模式是 Kubernetes（简称 K8S） 或者 Mesos。</li>
<li>节点：一台已经注册到集群中的服务器，为集群提供计算资源。</li>
<li>应用：由一组容器及服务构成集合，这个集合可以代表一个业务，或者业务的某个大区，在 K8S 中应用由 K8S 的工作负载（Workload）、服务（Service、Ingress）构成一个整体对外提供服务。</li>
<li>模板集：配置文件模板的集合，简化服务管理的复杂度，可以实现部署、升级应用。</li>
<li>网络：主要包含 <strong>服务</strong> 和 <strong>负载均衡器</strong> 的定义和管理，服务是由多个相同配置的容器和访问这些容器的规则组成的微服务，负载均衡器定义了访问规则的具体实现。</li>
<li>资源：资源中可以定义业务配置项，通过配置模板中关联这些业务配置项，可以实现对容器中业务进程使用配置的个性化管理。</li>
<li>仓库：用户存放 Docker 镜像、Helm Charts。</li>
</ul><h1 id="_1">产品架构图</h1>
<p>BCS 是统一的容器部署管理解决方案，为了适应不同业务场景的需要，BCS 内部同时支持基于 Mesos 和基于 K8S 的两种不同的实现。</p>
<p>BCS 在蓝鲸中的位置</p>
<p><img alt="BCS 在蓝鲸中的位置" src="F:\bkdoc\md_to_pdf/5.1/bcs/Architecture/media/BCS%20%E5%9C%A8%E8%93%9D%E9%B2%B8%E4%B8%AD%E7%9A%84%E4%BD%8D%E7%BD%AE.png" /></p>
<h2 id="1-bcs">1. BCS（容器管理平台）架构图</h2>
<p>BCS 由 <strong>BCS SaaS</strong> 和 <strong>BCS 后台</strong> 组成，以下为对应的架构图。</p>
<h3 id="1-bcs-saas">1. BCS SaaS 架构图</h3>
<h4 id="11-bcs-saas">1.1 BCS SaaS 功能结构图</h4>
<p>BCS SaaS 作为 BCS 的上层产品，包含已开源的项目管理系统（bcs-projmgr）、容器服务产品层主体功能模块（bcs-app）、底层的配置中心模块（bcs-cc）以及未开源的监控中心，同时它依赖蓝鲸体系下的其他产品服务（如 PaaS、CMDB 等）。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Architecture/media/15674159010680.jpg" /></p>
<p>SaaS 依赖的服务介绍：
- <a href="https://github.com/Tencent/bk-PaaS">bk-PaaS</a>: 为 BCS SaaS 提供了 4 大服务(统一登录、开发者中心、ESB 和应用引擎)，其中 bcs-app 由应用引擎托管</p>
<ul>
<li>
<p><a href="https://github.com/Tencent/bk-bcs">bk-bcs-services</a>: BCS 底层服务。作为后台服务，bk-bcs-services 给 bcs-app 提供了集群搭建，应用编排等丰富的底层接口，更多详见下 <em>BCS 后台架构图</em> 。</p>
</li>
<li>
<p><a href="https://github.com/Tencent/bk-cmdb">bk-cmdb</a>: 蓝鲸配置平台。bcs-app 的集群管理功能涉及的业务和主机信息来源于配置平台</p>
</li>
<li>
<p>bk-iam: 蓝鲸权限中心，BCS SaaS 基于 bk-iam，实现了用户与平台资源之间的权限控制</p>
</li>
<li>
<p>bk-Habor: 蓝鲸容器管理平台镜像仓库服务。bcs-app 使用 bk-Habor 提供的 API，实现了业务镜像的查询与配置功能</p>
</li>
</ul>
<h4 id="12-bcs-saas">1.2 BCS SaaS 部署拓扑图</h4>
<p>SaaS 包含 bcs-projmgr, bcs-app, bcs-cc 三个模块。</p>
<p>SaaS 依赖的后端服务 bk-bcs-services 也已开源，bk-iam 等灰色标注的系统暂未开源，需要依托蓝鲸独立部署版本进行搭建。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Architecture/media/15677593863168.jpg" /></p>
<h3 id="2-bcs">2. BCS 后台架构图</h3>
<p>下图为 BCS 以及 Mesos 集群的整体架构图：BCS Client 或者业务 SaaS 服务通过 API 接入，API 根据访问的集群将请求路由到 BCS 下的 Mesos 集群或者 K8S 集群。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Architecture/media/15674155869369.jpg" /></p>
<p>Kubenetes 容器编排的说明：
* BCS 支持原生 K8S 的使用方式。
* K8S 集群运行的 Agent（bcs-k8s-agent） 向 BCS API 服务进行集群注册。
* K8S 集群运行的 Data Watch 负责将该集群的数据同步到 BCS Storage。</p>
<p>Mesos 编排的具体说明：
* Mesos 自身包括 Mesos Master 和 Mesos Slave 两大部分，其中 Master 为中心管理节点，负责集群资源调度管理和任务管理；Slave 运行在业务主机上，负责宿主机资源和任务管理。
* Mesos 为二级调度机制，Mesos 本身只负责资源的调度，业务服务的调度需要通过实现调度器（图中 Scheduler）来支持，同时需实现执行器 Executor（Mesos 自身也自带有 Executor）来负责容器或者进程的起停和状态检测上报等工作。
* Mesos（Master 和 Slave）将集群当前可以的资源以 offer（包括可用 CPU、MEMORY、DISK、端口以及定义的属性键值对）的方式上报给 Scheduler，Scheduler 根据当前部署任务来决定是否接受 Offer，如果接受 Offer，则下发指令给 Mesos，Mesos 调用 Executor 来运行容器。
* Mesos 集群数据存储在 ZooKeeper，通过 Datawatch 负责将集群动态数据同步到 BCS 数据中心。
* Mesos Driver 负责集群接口转换。
* 所有中心服务多实例部署实现高可用：Mesos driver 为 Master-Master 运行模式，其他模块为 Master-Slave 运行模式。服务通过 ZooKeeper 实现状态同步和服务发现。</p><h1 id="_1">模板集使用介绍</h1>
<p>在 BCS 中，模板集合是 Kubernetes/Mesos 配置文件模板的集合。您可以通过将多个应用的配置构成一个模板集，来简化服务管理的复杂度；您还可以将模板里面需要频繁修改的数据设置成变量，以方便维护。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/media/image00.png" /></p>
<p>通过『模板集』+『变量』来管理您的业务将非常方便。</p>
<h2 id="1">1. 理解“服务”</h2>
<p>如果您的服务由多个应用构成，通过 <strong>模板集</strong> + <strong>变量</strong> 生成 “应用” 来管理您的服务将会非常方便。</p>
<p>为了方便大家理解，本文将以一个简单的 Nginx 服务为例来说明。该服务下只有一个 Nginx 应用，通过修改模板中 <strong>NGINX_PORT</strong> 变量的值，将应用以不同的端口部署到不同的命名空间中。</p>
<h2 id="2">2. 创建模板集</h2>
<h3 id="21">2.1 推送镜像到仓库</h3>
<p>在创建模板前，先通过以下几个步骤将 <strong>Nginx 应用的的镜像推送到蓝鲸容器服务的镜像仓</strong> 库中。</p>
<h4 id="211">2.1.1 获取镜像的压缩包</h4>
<p>在本地执行 <code>docker save</code> 获取镜像压缩包，您也可以直接点击下载 <a href="http://bkopen-1252002024.file.myqcloud.com/bcs/nginx.tar">nginx.tar</a>。</p>
<div class="codehilite"><pre><span></span>docker pull nginx
docker save nginx &gt; nginx.tar
</pre></div>


<h4 id="212">2.1.2 上传镜像</h4>
<p>选中【仓库】菜单的【项目镜像】页面，参考 <a href="./HarborGuide.md">Harbor 仓库使用指南</a>，通过命令行工具来推送镜像。</p>
<h3 id="22">2.2 创建项目模板集</h3>
<p>选中【模板集】菜单，点击【添加模板集】。</p>
<p>进入创建模板集页面后，可以在模板集定义 Deployment、Service 等资源，这些资源的详情介绍可以参考 <a href="5.1/bcs/Function/k8s/workload/deployment.md">Deployment 说明文档</a>。本文的案例中我只需要创建一个 Deployment。</p>
<p>首先填入一些基本信息，包括名称、描述，实例数量指最终拉起的实例数。Kubernetes 使用选择器（spec.selector.matchLabels）关联资源，实例化后选择器的值不可变，所以在创建模板的时候需要给应用打一个固定的标签，并且把这个标签添加到选择器中。</p>
<p>点击下方的 Pod 模板设置，将网络策略设置为 Host 模式，可以直接用主机网络，将 Nginx 容器端口对外暴露。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/media/image02.png" /></p>
<p>接下来定义 Nginx 容器，需要填写名称、描述，选择 Nginx  镜像。同时将容器端口以变量的形式填写，这样可以将应用以不同的端口部署到不同的命名空间中。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/media/image03.png" /></p>
<p>这样我们的模板集就创建好了，点击上方的保存按钮，将模板集的保存到一个版本中。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/media/image04.png" /></p>
<h2 id="3">3. 设置变量</h2>
<p>选中【变量管理菜单】，统一管理所有的变量，变量分为三类：</p>
<ul>
<li>全局变量：变量的生效范围为整个项目，如系统变量里面的：项目 ID、业务 ID</li>
<li>集群变量：变量的生效范围为集群，同一个变量可以针对不同的集群设置不同的值，如系统变量里面的：集群 ID、仓库域名</li>
<li>命名空间变量：变量的生效范围为命名空间，同一个变量可以针对不同的命名空间设置不同的值</li>
</ul>
<p>点击引用处，可以查看所有引用了这个变量的模板的详情。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/media/image05.png" /></p>
<p>点击批量更新，可以同时对不同的集群、命名空间赋值。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/media/image06.png" /></p>
<h2 id="4">4. 模板集中引用变量</h2>
<p>模板集中可采用<code>{{变量名}}</code>的方式引入变量</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/media/image13.png" /></p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/media/image14.png" /></p>
<h2 id="5">5. 创建服务示例</h2>
<p>选中【模板集】菜单，点击实例化按钮进入实例化页面，选择模板集、命名空间。变量默认值为在上一步设置的值，您也可以在实例化页面修改这个值。最后点击创建就完成了实例化操作。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/media/image07.png" /></p>
<h2 id="6">6. 确认完成</h2>
<p>应用部署完成后，您可以在容器服务左侧导航中点击“应用”，查看 Nginx 服务应用实例，并可以通过 Host IP 和配置的容器端口访问服务。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/media/image08.png" /></p>
<h3 id="61">6.1 滚动升级</h3>
<p>您可以通过配置不同的模板集版本来实现滚动升级的功能。</p>
<h4 id="611">6.1.1 节点设置标签</h4>
<p>通过节点设置标签，可以在调度的时候将应用调度到固定的主机上。本例中将集群节点中的一台主机添加<code>app:nginx</code>的标签。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/media/image09.png" /></p>
<h4 id="612">6.1.2 新增模板集版本</h4>
<p>在模板集的调度约束中，将 <code>NodeSelector</code> 设置为<code>app:nginx</code>，并保存到一个新的版本中。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/media/image10.png" /></p>
<h4 id="613">6.1.3 滚动升级</h4>
<p>在应用页面，点击滚动升级并选择最新的版本，可以页面上查看滚动升级前后的配置文件差异，点击确定将应用滚动升级到新版本。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/media/image11.png" /></p>
<p>进入应用的详情页面，可以发现 Nginx 应用已经被重新调度到了设置了<code>app:nginx</code>标签的主机上，并可以通过新的 Host IP 和配置的容器端口访问 Nginx 服务。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/media/image12.png" /></p>
<h2 id="7">7. 附录</h2>
<h3 id="71">7.1 节点标签说明文档</h3>
<ul>
<li>K8S</li>
</ul>
<p>节点标签主要是一组绑定到 K8S 资源对象上的 key/value 对。通过给指定的资源对象捆绑一个或多个不同的 label 来实现多维度的资源分组管理功能，以便于灵活，方便地资源分配，调度，配置，部署等管理工作。</p>
<ul>
<li>Mesos</li>
</ul>
<p>节点标签主要是 Mesos 一组 key/value 对，允许以更灵活、多样的形式进行资源分配。</p><h1 id="_1">镜像仓库使用指南</h1>
<p>蓝鲸容器服务采用 Harbor 做镜像存储，用户除了可以使用 Harbor 的管理页面对项目、用户和镜像做管理外，还提供与容器服务配套的 API，方便容器服务和仓库使用。</p>
<h2 id="1-harbor">1. Harbor 镜像仓库简介</h2>
<p>Harbor 是 Vmware 公司开源的企业级 Docker Registry 管理项目，开源项目地址：<a href="https://github.com/vmware/harbor">Harbor</a>。</p>
<p>在 Harbor 仓库中，镜像在被推送到仓库之前都需要有一个自己所属的项目。用户和仓库都是基于项目进行组织的，而用户基于项目可以拥有不同的权限。</p>
<p>Harbor 项目类型分为公共仓库和私有仓库两种类型，其中</p>
<ul>
<li>公共仓库：任何使用者都可以获取这个仓库中的镜像。</li>
<li>私有仓库：只有被授予权限的用户可以获取这个仓库中的镜像。</li>
</ul>
<p>更多关于 Harbor 项目和用户的使用指引，请参考 <a href="https://github.com/goharbor/harbor/blob/master/docs/user_guide.md">Harbor 的用户手册</a>。</p>
<h2 id="2-bcs-harbor">2 BCS 中的 Harbor 仓库</h2>
<h3 id="21">2.1 获取项目仓库账号</h3>
<p>选中【Helm】菜单中的【Charts 仓库】，点击右上角【如何推送 Helm Chart 到项目仓库】帮助，可以获取仓库账号。</p>
<p><img alt="-w1566" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/media/15675920013542.jpg" /></p>
<p>包含以下信息：
- 镜像仓库地址：<code>&lt;Registry_URL&gt;</code>；Web 端也可以访问。注意：地址包含端口。
- 镜像仓库账号、密码 （Harbor 中的一个项目账号，可以上传 <strong>镜像</strong> 和 <strong>Charts</strong>）
- 项目 ID：<code>&lt;Project_ID&gt;</code>，如上图中的<code>joyfulgame</code></p>
<h3 id="22">2.2 登录镜像仓库</h3>
<div class="codehilite"><pre><span></span>docker login --username<span class="o">=</span>&lt;USERNAME&gt; &lt;Registry_URL&gt;
Password:
Login Succeeded
</pre></div>


<p>注意：镜像仓库地址包含端口。</p>
<h3 id="23">2.3 推送镜像</h3>
<p>推送镜像之前，要先将镜像 tag 为满足 <strong>Harbor 项目前缀要求的格式</strong>。</p>
<p>例如需要将本地镜像<code>nginx:1.17.0</code>推送到当前项目下，首先将镜像按下面的命令重新 tag。</p>
<div class="codehilite"><pre><span></span>docker tag nginx:1.17.0 &lt;Registry_URL&gt;/&lt;Project_ID&gt;/nginx:1.17.0
docker push &lt;Registry_URL&gt;/&lt;Project_ID&gt;/nginx:1.17.0
</pre></div>


<h3 id="24">2.4 拉取镜像</h3>
<p>拉取项目镜像前需先完成登录，拉取公共镜像可以不登录。</p>
<div class="codehilite"><pre><span></span>docker pull &lt;Registry_URL&gt;/&lt;Project_ID&gt;/nginx:1.17.0
</pre></div>


<h2 id="3-harbor-web">3. 登录 Harbor Web 仓库</h2>
<h3 id="31-harbor">3.1 获取 Harbor 账号</h3>
<ul>
<li>获取项目仓库账号</li>
</ul>
<p>在 <em>获取项目仓库账号</em> 中可以获取 Harbor 的项目账号，可以访问项目（BCS 中新建的项目）仓库。</p>
<ul>
<li>获取 Harbor 管理员账号</li>
</ul>
<p>在<a href="5.1/部署维护/增强包安装/机器评估/bcs_evaluate.md">部署 BCS 的文档</a> 中有一个环境变量文件 <code>globals.env</code> ，其中可以找到 Harbor 的用户名（<code>HARBOR_SERVER_ADMIN_USER</code>）以及密码（<code>HARBOR_SERVER_ADMIN_PASS</code>）。</p>
<h3 id="32-harbor-web">3.2 访问 Harbor Web 端</h3>
<ul>
<li>项目仓库账号 Web 端</li>
</ul>
<p>在 <em>获取项目仓库账号</em> 中可以获取 Harbor 的 Web 端访问 URL，进来可以看到项目列表，包含 <strong>公共项目</strong> 和 <strong>私有项目</strong>。</p>
<p><img alt="-w1565" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/media/15675973703087.jpg" /></p>
<p>在上图中点击 项目仓库 <code>joyfulgame</code>，可以看到有 2 个镜像。</p>
<p><img alt="-w1570" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/media/15675973839581.jpg" /></p>
<p>点击 【Helm Charts】页面，可以看到仓库中上传的 <a href="helm/ServiceAccess.md">Charts</a>。</p>
<p><img alt="-w1566" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/media/15675973941768.jpg" /></p>
<ul>
<li>Harbor 管理员账号 Web 端</li>
</ul>
<p>使用管理员账号，可以实现用户管理、仓库管理、复制管理、配置管理。</p>
<p><img alt="-w1563" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/media/15675975535096.jpg" /></p><h1 id="bcs-k8s-mesos">BCS K8S / Mesos 方案功能对比</h1>
<p>BCS 支持 K8S 和 Mesos 两种容器编排方案，以下是两种编排方案的功能对比：</p>
<div>
    <table border="1" width="100%">
        <tr bgcolor="#D3D3D3">
            <td width="10%">功能点</td>
            <td width="15%">K8S 方案</td>
            <td width="15%">Mesos 方案</td>
            <td width="60%">主要功能及差异说明</td>
        </tr>
        <tr>
            <td>POD</td>
            <td>POD</td>
            <td>POD(taskgroup)</td>
            <td>
                <b>K8S、Mesos 方案均支持：</b>
                <ul>
                    <li>1. Pod 是所有业务类型的基础，它是一个或多个容器的组合，例如：业务容器，sidecar容器
                    <li>2. 这些容器共享存储、网络和命名空间，以及如何运行的规范
                    <li>3. 在 Pod 中，所有容器都被统一编排和调度
                </ul>
            </td>
        </tr>
        <tr>
            <td>无状态应用</td>
            <td>ReplicaSet/Deployment</td>
            <td>Application/Deployment</td>
            <td>
                <b>K8S、Mesos 方案均支持：</b>
                <ul>
                    <li>1. 支持设定编排策略（Restart、Kill等）；
                    <li>2. 支持设定容器启动参数；
                    <li>3. 支持设定镜像版本及加载方式；
                    <li>4. 支持设定端口映射；
                    <li>5. 支持设定环境变量；
                    <li>6. 支持设定 label、备注；
                    <li>7. 支持设定卷、configmap、secret 的关联关系；
                    <li>8. 支持设定网络；
                    <li>9. 支持设定资源配额设定；
                    <li>10. 支持设定健康检查机制；
                </ul>
                <b>差异点主要有：</b>
                <ul>
                    <li>1. K8S 支持设定生命周期、就绪检查；
                    <li>2. K8S 支持更多的存储 driver，并且从 1.9 版本开始支持CSI；
                    <li>3. 调度策略配置不同：
                        K8S：基于 label 的调度策略，通过 selector 进行筛选
                        Mesos：基于变量运算符的调度策略，支持获取 CC 的属性作为调度依据
                    <li>4. 自定义调度支持方式不同：
                        K8S：支持自定义 controller
                        Mesos：支持自定义调度插件
                    <li>5. Mesos 方案支持 POD 固定 IP 调度
                    <li>6. Mesos 方案支持 bridge 模式下端口随机
                </ul>
            </td>
        </tr>
        <tr>
            <td>部署方案</td>
            <td>Deployment</td>
            <td>Deployment</td>
            <td>
                <b>K8S、Mesos 方案均支持：</b>
                <ul>
                    <li>1. recreate 操作方式；
                </ul>
                <b>差异点主要有：</b>
                <ul>
                    <li>1. rollingUpdate：
                        K8S 方案支持设置滚动方式，最大不可用数和最大更新数
                        Mesos 方案支持设置滚动方式，周期，频率，和手动模式
                    </li>
                </ul>
            </td>
        </tr>
        <tr>
            <td>有状态应用</td>
            <td>StatefulSets</td>
            <td>Application</td>
            <td>
                <b>K8S、Mesos 方案均支持：</b>
                <ul>
                    <li>1. POD 拥有独立唯一不变的 ID；
                    <li>2. POD 拥有独立唯一的域名；
                    <li>3. 挂载独立的数据卷；
                </ul>
            </td>
        </tr>
        <tr>
            <td>任务</td>
            <td>Job/CronJob</td>
            <td>Application</td>
            <td>
                <b>K8S、Mesos 方案均支持：</b>
                <ul>
                    <li>1. 短任务单次执行，例如数据库初始化任务；
                </ul>
                <b>差异点主要有：</b>
                <ul>
                    <li>1. Mesos 方案无专门 Workload，通过设置 Application的参数实现
                    <li>2. K8S 支持部署定时任务
                </ul>
            </td>
        </tr>
        <tr>
            <td>配置文件</td>
            <td>Configmap</td>
            <td>Configmap</td>
            <td>
                <b>K8S、Mesos 方案均支持：</b>
                <ul>
                    <li>1. Configmap 内容落地为文件或者环境变量；
                </ul>
                <b>差异点主要有：</b>
                <ul>
                    <li>1. K8S 方案支持在 POD command 中以变量方式引用；
                    <li>2. Mesos 方案支持远端配置，包括文本和二进制配置文件
                </ul>
            </td>
        </tr>
        <tr>
            <td>DaemonSet</td>
            <td>DaemonSet</td>
            <td>Application</td>
            <td>
                <b>K8S、Mesos 方案均支持：</b>
                <ul>
                    <li>1. 按主机 1：1 动态部署容器；
                    <li>2. 能动态跟随物理机资源缩扩容；
                </ul>
                <b>差异点主要有：</b>
                <ul>
                    <li>1. Mesos 方案无专门 Workload，需要通过设置Application 的调度算法实现相同功能；
                </ul>
            </td>
        </tr>
        <tr>
            <td>服务</td>
            <td>Service</td>
            <td>Service</td>
            <td>
                <b>K8S、Mesos 方案均支持：</b>
                <ul>
                    <li>1. 通过自定义域名描述外部服务；
                    <li>2. 对 RS 或者 Application 的服务做抽象；
                    <li>3. 支持容器故障或者扩缩容时 Backends 的动态刷新；
                    <li>4. 支持简单的负载均衡策略；
                    <li>5. 支持 HTTP、TCP、UDP 等主流通讯协议；
                </ul>
                <b>差异点主要有：</b>
                <ul>
                    <li>1. Mesos 方案支持通过 location 对不同域名进行分流
                    <li>2. Mesos 方案支持对两个 Application 之间设置流量权重
                    <li>3. K8S 支持更多对外暴露服务折射方式，除 ClusterIP、LB外，还是支持 NodePort
                </ul>
            </td>
        </tr>
        <tr>
            <td>加密配置</td>
            <td>Secrets</td>
            <td>Secrets</td>
            <td>
                <b>K8S、Mesos 方案均支持：</b>
                <ul>
                    <li>1. 对敏感信息加密；
                </ul>
            </td>
        </tr>
        <tr>
            <td>挂载卷</td>
            <td>Volumes</td>
            <td>Volumes</td>
            <td>
                <b>K8S、Mesos 方案均支持：</b>
                <ul>
                    <li>1. 支持 Empty DIR；
                    <li>2. 支持 Host Path；
                    <li>3. 支持挂载 Ceph、nfs 等远端目录；
                    <li>4. 支持 subPath；
                </ul>
            </td>
        </tr>
        <tr>
            <td>Ingress</td>
            <td>Ingress</td>
            <td>Ingress</td>
            <td>
                <b>K8S、Mesos 方案均支持：</b>
                <ul>
                    <li>1. 实现集群外部对集群内服务的访问；
                    <li>2. 支持 HTTP、TCP；
                    <li>3. 支持轮询的负载均衡方式；
                </ul>
                <b>差异点主要有：</b>
                <ul>
                    <li>1. Mesos 方案支持流量权重设置；
                    <li>2. Mesos 方案支持 Balance Source；
                </ul>
            </td>
        </tr>
    </table>
</div><h1 id="kubernetes-deployment">Kubernetes Deployment 说明</h1>
<p>Deployment 是 kubernetes(简称 K8S)中用于管理 Pod 的对象，从 1.2 版本开始引入，与 Replication Controller 相比，它提供了更加完善的功能，集成了上线部署、滚动升级、创建副本、暂停/恢复上线任务，回滚等功能，使用起来也更加方便</p>
<h2 id="1">1. 模板示例</h2>
<div class="codehilite"><pre><span></span><span class="n">apiVersion</span><span class="o">:</span> <span class="n">apps</span><span class="o">/</span><span class="n">v1beta2</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Deployment</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">servergame</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">selector</span><span class="o">:</span>
    <span class="n">matchLabels</span><span class="o">:</span>
      <span class="n">app</span><span class="o">:</span> <span class="n">servergame</span>
  <span class="n">replicas</span><span class="o">:</span> <span class="mi">4</span>
  <span class="n">strategy</span><span class="o">:</span>
    <span class="n">type</span><span class="o">:</span> <span class="n">RollingUpdate</span>
    <span class="n">rollingUpdate</span><span class="o">:</span>
      <span class="n">maxUnavailable</span><span class="o">:</span> <span class="mi">0</span>
      <span class="n">maxSurge</span><span class="o">:</span> <span class="mi">2</span>
  <span class="n">template</span><span class="o">:</span>
    <span class="n">metadata</span><span class="o">:</span>
      <span class="n">labels</span><span class="o">:</span>
        <span class="n">app</span><span class="o">:</span> <span class="n">servergame</span>
    <span class="n">spec</span><span class="o">:</span>
      <span class="n">nodeSelector</span><span class="o">:</span>
        <span class="n">network</span><span class="o">:</span> <span class="kd">private</span>
      <span class="n">imagePullSecrets</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">paas</span><span class="o">.</span><span class="na">image</span><span class="o">.</span><span class="na">registry</span><span class="o">.</span><span class="na">default</span>
      <span class="n">containers</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">servergame</span>
        <span class="n">image</span><span class="o">:</span> <span class="n">servergame</span><span class="o">:</span><span class="mf">2.0</span><span class="o">.</span><span class="mi">0</span>
        <span class="n">args</span><span class="o">:</span> <span class="o">[</span> <span class="s2">&quot;-c /opt/live.env.conf&quot;</span> <span class="o">]</span>
        <span class="n">env</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">FUEL_ROLE</span>
          <span class="n">value</span><span class="o">:</span> <span class="n">servergame</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">INSTANCE_IP</span>
          <span class="n">valueFrom</span><span class="o">:</span>
            <span class="n">fieldRef</span><span class="o">:</span>
               <span class="n">fieldPath</span><span class="o">:</span> <span class="n">status</span><span class="o">.</span><span class="na">podIP</span>
        <span class="n">envFrom</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">configMapRef</span><span class="o">:</span>
            <span class="n">name</span><span class="o">:</span> <span class="n">external</span><span class="o">-</span><span class="n">config</span>
        <span class="o">-</span> <span class="n">secretRef</span><span class="o">:</span>
            <span class="n">name</span><span class="o">:</span> <span class="n">external</span><span class="o">-</span><span class="n">secret</span><span class="o">-</span><span class="n">config</span>
        <span class="n">livenessProbe</span><span class="o">:</span>
          <span class="n">httpGet</span><span class="o">:</span>
            <span class="n">path</span><span class="o">:</span> <span class="sr">/g/s</span><span class="n">tatus</span>
            <span class="n">port</span><span class="o">:</span> <span class="n">http</span>
          <span class="n">initialDelaySeconds</span><span class="o">:</span> <span class="mi">900</span>
          <span class="n">timeoutSeconds</span><span class="o">:</span> <span class="mi">5</span>
        <span class="n">readinessProbe</span><span class="o">:</span>
          <span class="n">httpGet</span><span class="o">:</span>
            <span class="n">path</span><span class="o">:</span> <span class="sr">/g/s</span><span class="n">tatus</span>
            <span class="n">port</span><span class="o">:</span> <span class="n">http</span>
          <span class="n">initialDelaySeconds</span><span class="o">:</span> <span class="mi">15</span>
          <span class="n">timeoutSeconds</span><span class="o">:</span> <span class="mi">5</span>
        <span class="n">resources</span><span class="o">:</span>
          <span class="n">requests</span><span class="o">:</span>
            <span class="n">cpu</span><span class="o">:</span> <span class="mi">100</span><span class="n">m</span>
            <span class="n">memory</span><span class="o">:</span> <span class="mi">3</span><span class="n">Gi</span>
        <span class="n">ports</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">http</span>
          <span class="n">containerPort</span><span class="o">:</span> <span class="mi">8080</span>
        <span class="n">volumeMounts</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">config</span>
          <span class="n">mountPath</span><span class="o">:</span> <span class="sr">/opt/servergame/</span><span class="n">config</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">applogs</span>
          <span class="n">mountPath</span><span class="o">:</span> <span class="sr">/opt/servergame/</span><span class="n">log</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">shm</span>
          <span class="n">mountPath</span><span class="o">:</span> <span class="sr">/dev/s</span><span class="n">hm</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">g3</span>
        <span class="n">image</span><span class="o">:</span> <span class="n">g3</span><span class="o">:</span><span class="mf">0.5</span>
        <span class="n">volumeMounts</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">shm</span>
          <span class="n">mountPath</span><span class="o">:</span> <span class="sr">/dev/s</span><span class="n">hm</span>
      <span class="n">volumes</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">config</span>
        <span class="n">configMap</span><span class="o">:</span>
          <span class="n">name</span><span class="o">:</span> <span class="n">apps</span><span class="o">-</span><span class="n">servergame</span><span class="o">-</span><span class="n">config</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">applogs</span>
        <span class="n">emptyDir</span><span class="o">:</span> <span class="o">{}</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">shm</span>
        <span class="n">emptyDir</span><span class="o">:</span>
          <span class="n">medium</span><span class="o">:</span> <span class="n">Memory</span>
          <span class="n">sizeLimit</span><span class="o">:</span> <span class="mi">1</span><span class="n">Gi</span>
</pre></div>


<h2 id="2">2. 配置项介绍</h2>
<h3 id="21-selector">2.1 Selector</h3>
<p><code>.spec.selector</code>是可选字段，用来指定 label selector，指定当前 Deployment 所能管理的 Pod 范围。如果被指定，<code>.spec.selector</code>必须匹配<code>.spec.template.metadata.labels</code>，否则它将被 API 拒绝。如果<code>.spec.selector</code>没有被指定，<code>.spec.selector.matchLabels</code>默认是 <code>.spec.template.metadata.labels</code></p>
<h3 id="22-replicas">2.2 Replicas</h3>
<p><code>.spec.replicas</code>是可以选字段，指定期望的 Pod 数量，默认是 1</p>
<h3 id="23-strategy">2.3 Strategy</h3>
<p><code>.spec.strategy</code>指定新 Pod 替换旧 Pod 的策略。<code>.spec.strategy.type</code>可以是"Recreate"或者是 "RollingUpdate"。"RollingUpdate"是默认值。
- "Recreate"相对比较“暴力”，Deployment 在创建出新的 Pod 之前会先杀掉所有已存在的 Pod
- "RollingUpdate"则是使用 rolling update 的方式更新 Pod。用户可以指定 maxUnavailable 和 maxSurge 来控制 rolling update 的进程。
    - <code>.spec.strategy.rollingUpdate.maxUnavailable</code> 是可选配置项，用来指定在升级过程中不可用 Pod 的最大数量。该值可以是一个绝对值，也可以是期望 Pod 数量的百分比(例如 10%)，通过计算百分比的绝对值向下取整。如果<code>.spec.strategy.rollingUpdate.maxSurge</code>为 0 时，这个值不可以为 0。默认值是 1
    - <code>.spec.strategy.rollingUpdate.maxSurge</code>是可选配置项，用来指定可以超过期望的 Pod 数量的最大个数。该值可以是一个绝对值或者是期望的 Pod 数量的百分比。当 MaxUnavailable 为 0 时，该值不可以为 0。通过百分比计算的绝对值向上取整。默认值是 1
    - 示例中<code>maxUnavailable: 0，maxSurge: 2</code>,  表示滚动升级的过程中，处于 Available(Ready)的 Pod 数不低于<code>.spec.replicas-0</code> ，同时所有的 Pod 数之和不会超过<code>.spec.replicas+2</code></p>
<h3 id="24-pod-template">2.4 Pod Template</h3>
<p>Pod 是 K8S 创建或部署的最小/最简单的基本单位，可由单个或多个容器共享组成的资源。Pod template 作为定义方式，可被嵌套到 Deployment、StatefulSet、DaemonSet 等对象中，即下面介绍的<code>.spec.template</code>。
<code>.spec.template</code>是 <code>.spec</code>中唯一必须的字段，和 Pod 具备同样的 schema，除了 apiVersion 和 kind 字段。为了划分 Pod 的范围，Deployment 中的 Pod template 必须指定适当的 label(如 app: servergame)和适当的重启策略。<code>.spec.template.spec.restartPolicy</code>在不指定的情况下，默认为 Always。</p>
<h4 id="241-nodeselector">2.4.1 nodeSelector</h4>
<p><code>.spec.template.spec.nodeSelector</code>是较常用的调度 Pod 到具体 node 节点上的方法，它通过 K8S 的 label-selector 机制进行节点选择。如示例中，Pod 会被调度到已经打上<code>network=private</code>这一 label 的 node 节点上。</p>
<h4 id="242-containers">2.4.2 containers</h4>
<p>一个 Pod 可以管理一个或多个容器，<code>.spec.template.spec.containers[]</code>即是描述这些容器的数组(例如，示例模板中的 Pod 包含 servergame 和 g3 这两个容器)。每个数组对应一个容器的配置，包括容器 name, 所使用的 image，环境变量，resources 的限制等。</p>
<ul>
<li>
<p>环境变量
环境变量的设置方法有多种</p>
<ul>
<li>env 指定<ul>
<li>直接设置 key, value</li>
<li>通过 valueFrom 获取 pod 信息(如<code>status.podIP</code>), 设置 value</li>
</ul>
</li>
<li>envFrom 直接从 configmap 或 secret 中获取环境变量</li>
</ul>
</li>
<li>
<p>健康度探测(livenessProbe 和 readinessProbe)
容器的健康度探测维度分为两类: 存活探针(livenessProbe)和就绪探针(readinessProbe)。kubelet 使用 livenessProbe 来确定何时重启容器，使用 readinessProbe 来确定容器是否已经就绪可以接受流量。探测手段可以通过 http, tcp 或者定义 command。无论使用哪种方式，都会用到下面这几个参数</p>
<ul>
<li><code>initialDelaySeconds</code> 容器启动后第一次执行探测是需要等待多少秒</li>
<li><code>timeoutSeconds</code> 一次性探测的超时时间</li>
<li><code>periodSeconds</code> 探测的时间周期</li>
<li><code>successThreshold</code> 探测失败后，最少连续探测成功多少次才被认定为成功。默认是 1。对于 liveness 必须是 1。最小值是 1</li>
<li><code>failureThreshold</code> 探测成功后，最少连续探测失败多少次才被认定为失败。默认是 3。最小值是 1</li>
</ul>
</li>
<li>
<p>容器挂载卷的引用
<code>.spec.template.spec.containers[i].volumeMounts[]</code>中描述了当前容器需要使用到的一些 volume，通过 name 与 volumes 绑定，mountPath 表示挂载到容器中的位置</p>
</li>
</ul>
<h4 id="243-volumes">2.4.3 volumes</h4>
<p>K8S 支持多种类型的卷，其核心是目录，可以通过 Pod 中的容器来访问。目录是如何形成的、支持该目录的介质以及其内容取决于所使用的特定卷类型。卷的类型：
- configMap
- emptyDir
- hostPath
- persistentVolumeClaim
- cephfs
- ...
类型很多，这里对常用的<code>configMap</code>和<code>emptyDir</code>做重点说明。
<code>configMap</code>类型提供了一种将配置文件注入到 Pods 中的方法，如示例片段，</p>
<div class="codehilite"><pre><span></span>      <span class="n">volumes</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">config</span>
        <span class="n">configMap</span><span class="p">:</span>
          <span class="n">name</span><span class="p">:</span> <span class="n">apps</span><span class="o">-</span><span class="n">servergame</span><span class="o">-</span><span class="n">config</span>
</pre></div>


<p>通过在<code>.spec.template.spec.containers[i].volumeMounts[]</code>中引用<code>name: config</code>，可以将<code>apps-servergame-config</code>中定义的文件内容挂载到容器指定的<code>mountPath</code>下
<code>emptyDir</code>类型主要用于某些应用程序无需永久保存的临时目录，多个容器的共享目录等。这个目录的初始内容为空，当 Pod 从 Node 上移除时，emptyDir 中的数据会被永久删除。根据介质的不同，分为硬盘(emptyDir: {})和内存存储。内存存储用于多个容器需要共享内存的情况，如示例片段，</p>
<div class="codehilite"><pre><span></span>        <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">shm</span>
          <span class="n">emptyDir</span><span class="p">:</span>
            <span class="n">medium</span><span class="p">:</span> <span class="n">Memory</span>
            <span class="n">sizeLimit</span><span class="p">:</span> <span class="mi">1</span><span class="n">Gi</span>
</pre></div>


<p>指定了介质类型为 Memory 和 1G 大小的内存空间。</p>
<h2 id="3-deployment">3. Deployment  之 “吃豆小游戏”实践</h2>
<p>下面是 bcs 小游戏中，Deployment 用法的示例: openresty-v2 是接入层模块，redis-v2 是 redis 服务模块。</p>
<div class="codehilite"><pre><span></span><span class="n">apiVersion</span><span class="o">:</span> <span class="n">extensions</span><span class="o">/</span><span class="n">v1beta1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Deployment</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">openresty</span><span class="o">-</span><span class="n">v2</span>
  <span class="kd">namespace</span><span class="o">:</span> <span class="n">rumpetroll</span><span class="o">-</span><span class="n">v2</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">replicas</span><span class="o">:</span> <span class="mi">1</span>
  <span class="n">selector</span><span class="o">:</span>
    <span class="n">matchLabels</span><span class="o">:</span>
      <span class="n">app</span><span class="o">:</span> <span class="n">openresty</span><span class="o">-</span><span class="n">v2</span>
  <span class="n">template</span><span class="o">:</span>
    <span class="n">metadata</span><span class="o">:</span>
      <span class="n">labels</span><span class="o">:</span>
        <span class="n">app</span><span class="o">:</span> <span class="n">openresty</span><span class="o">-</span><span class="n">v2</span>
    <span class="n">spec</span><span class="o">:</span>
      <span class="n">hostNetwork</span><span class="o">:</span> <span class="kc">true</span>
      <span class="n">dnsPolicy</span><span class="o">:</span> <span class="n">ClusterFirstWithHostNet</span>
      <span class="n">hostAliases</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">ip</span><span class="o">:</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span>
        <span class="n">hostnames</span><span class="o">:</span>
        <span class="o">-</span> <span class="s2">&quot;game2-got.o.qcloud.com&quot;</span>
      <span class="n">containers</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">openresty</span>
        <span class="n">image</span><span class="o">:</span> <span class="n">rumpetroll</span><span class="o">-</span><span class="n">openresty</span><span class="o">:</span><span class="mf">0.61</span>
        <span class="n">imagePullPolicy</span><span class="o">:</span> <span class="n">IfNotPresent</span>
        <span class="n">ports</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">containerPort</span><span class="o">:</span> <span class="mi">80</span>
          <span class="n">hostPort</span><span class="o">:</span> <span class="mi">80</span>
          <span class="n">protocol</span><span class="o">:</span> <span class="n">TCP</span>
        <span class="n">env</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">DOMAIN</span>
          <span class="n">value</span><span class="o">:</span> <span class="n">game2</span><span class="o">-</span><span class="n">got</span><span class="o">.</span><span class="na">o</span><span class="o">.</span><span class="na">qcloud</span><span class="o">.</span><span class="na">com</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">MAX_CLIENT</span>
          <span class="n">value</span><span class="o">:</span> <span class="s2">&quot;2&quot;</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">MAX_ROOM</span>
          <span class="n">value</span><span class="o">:</span> <span class="s2">&quot;100&quot;</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">REDIS_HOST</span>
          <span class="n">value</span><span class="o">:</span> <span class="s2">&quot;redis&quot;</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">NAMESPACE</span>
          <span class="n">valueFrom</span><span class="o">:</span>
            <span class="n">fieldRef</span><span class="o">:</span>
              <span class="n">fieldPath</span><span class="o">:</span> <span class="n">metadata</span><span class="o">.</span><span class="na">namespace</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">REDIS_PORT</span>
          <span class="n">value</span><span class="o">:</span> <span class="s2">&quot;6379&quot;</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">REDIS_DB</span>
          <span class="n">value</span><span class="o">:</span> <span class="s2">&quot;0&quot;</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">REDIS_PASSWORD</span>
          <span class="n">value</span><span class="o">:</span> <span class="s2">&quot;&quot;</span>
</pre></div>


<div class="codehilite"><pre><span></span><span class="n">apiVersion</span><span class="o">:</span> <span class="n">extensions</span><span class="o">/</span><span class="n">v1beta1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Deployment</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">redis</span><span class="o">-</span><span class="n">v2</span>
  <span class="kd">namespace</span><span class="o">:</span> <span class="n">rumpetroll</span><span class="o">-</span><span class="n">v2</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">replicas</span><span class="o">:</span> <span class="mi">1</span>
  <span class="n">selector</span><span class="o">:</span>
    <span class="n">matchLabels</span><span class="o">:</span>
      <span class="n">app</span><span class="o">:</span> <span class="n">redis</span><span class="o">-</span><span class="n">v2</span>
  <span class="n">template</span><span class="o">:</span>
    <span class="n">metadata</span><span class="o">:</span>
      <span class="n">labels</span><span class="o">:</span>
        <span class="n">app</span><span class="o">:</span> <span class="n">redis</span><span class="o">-</span><span class="n">v2</span>
    <span class="n">spec</span><span class="o">:</span>
      <span class="n">containers</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">redis</span><span class="o">-</span><span class="n">v2</span>
        <span class="n">image</span><span class="o">:</span> <span class="n">redis</span><span class="o">:</span><span class="mf">1.0</span>
        <span class="n">imagePullPolicy</span><span class="o">:</span> <span class="n">IfNotPresent</span>
</pre></div>


<p>大部分的配置项都在上一节中做了介绍，这里仅对 openresty-v2 中用到的一些其他配置做简单说明。</p>
<p><code>DNS policies</code>:  一般情况下，Pod 访问集群内 dns 是不需要额外配置的，<code>dnsPolicy</code>的默认值为<code>ClusterFirst</code>，但由于 Pod 绑定了主机网络<code>hostNetwork: true</code>,因此如果需要访问集群内网络，必须设置成<code>ClusterFirstWithHostNet</code>。</p>
<p><code>hostAliases</code>:  通过<code>hostAliases</code>向 hosts 文件添加额外的条目, 即本例中的
<code>127.0.0.1   game2-got.o.qcloud.com</code></p>
<h2 id="4-bcs">4. BCS 模板集操作</h2>
<p>关于 Deployment 的实战演练，请参照 <a href="../../../Scenes/Bcs_deploy_nginx_cluster.md">快速构建 Nginx 集群</a>。</p>
<p><img alt="-w1465" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/k8s/workload/media/15684296480794.jpg" /></p>
<p><img alt="-w1462" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/k8s/workload/media/15684296585366.jpg" /></p><h1 id="kubernetes-statefulset">Kubernetes StatefulSet 说明</h1>
<p>StatefulSet 是为了解决有状态服务的问题而设计的，它是一个给 Pod 提供唯一标志的控制器，可以保证部署和扩展的顺序。StatefulSet 适用于有以下某个或多个需求的应用：
- 稳定的、唯一的网络标识
- 稳定的、持久化的存储
- 有序的、优雅的部署和扩展
- 有序的、优雅的删除和停止</p>
<h2 id="1">1. 模板示例</h2>
<div class="codehilite"><pre><span></span><span class="n">apiVersion</span><span class="o">:</span> <span class="n">apps</span><span class="o">/</span><span class="n">v1beta2</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">StatefulSet</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">relay</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">selector</span><span class="o">:</span>
    <span class="n">matchLabels</span><span class="o">:</span>
      <span class="n">app</span><span class="o">:</span> <span class="n">relay</span>
  <span class="n">podManagementPolicy</span><span class="o">:</span> <span class="s2">&quot;Parallel&quot;</span>
  <span class="n">serviceName</span><span class="o">:</span> <span class="s2">&quot;relay&quot;</span>
  <span class="n">replicas</span><span class="o">:</span> <span class="mi">50</span>
  <span class="n">updateStrategy</span><span class="o">:</span>
    <span class="n">type</span><span class="o">:</span> <span class="n">OnDelete</span>
  <span class="n">template</span><span class="o">:</span>
    <span class="n">metadata</span><span class="o">:</span>
      <span class="n">labels</span><span class="o">:</span>
        <span class="n">app</span><span class="o">:</span> <span class="s2">&quot;relay&quot;</span>
    <span class="n">spec</span><span class="o">:</span>
      <span class="n">schedulerName</span><span class="o">:</span> <span class="n">tgw</span><span class="o">-</span><span class="n">domain</span><span class="o">-</span><span class="n">scheduler</span>
      <span class="n">hostNetwork</span><span class="o">:</span> <span class="kc">true</span>
      <span class="n">dnsPolicy</span><span class="o">:</span> <span class="n">ClusterFirstWithHostNet</span>
      <span class="n">terminationGracePeriodSeconds</span><span class="o">:</span> <span class="mi">660</span>
      <span class="n">containers</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">relay</span><span class="o">-</span><span class="n">runner</span>
        <span class="n">image</span><span class="o">:</span> <span class="n">relay</span><span class="o">:</span><span class="mf">2.0</span><span class="o">.</span><span class="mi">0</span>
        <span class="n">command</span><span class="o">:</span> <span class="o">[</span> <span class="s2">&quot;/bin/bash&quot;</span><span class="o">,</span> <span class="s2">&quot;-c&quot;</span><span class="o">,</span> <span class="s2">&quot;source /tgwenv/tgwenv.sh &amp;&amp; /opt/relay-runner/bin/run_server -c /opt/relay-runner/conf/application.conf&quot;</span> <span class="o">]</span>
        <span class="n">volumeMounts</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">config</span>
          <span class="n">mountPath</span><span class="o">:</span> <span class="sr">/opt/relay-runner/</span><span class="n">conf</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">tgwenv</span>
          <span class="n">mountPath</span><span class="o">:</span> <span class="o">/</span><span class="n">tgwenv</span>
      <span class="n">initContainers</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">tgw</span><span class="o">-</span><span class="n">init</span>
        <span class="n">image</span><span class="o">:</span> <span class="n">tgw</span><span class="o">-</span><span class="n">init</span><span class="o">:</span><span class="mf">0.0</span><span class="o">.</span><span class="mi">3</span>
        <span class="n">command</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">tgw</span><span class="o">-</span><span class="n">init</span>
        <span class="n">args</span><span class="o">:</span> <span class="o">[</span><span class="s2">&quot;--kubeconf=&quot;</span><span class="o">]</span>
        <span class="n">env</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">ENV_PATH</span>
          <span class="n">value</span><span class="o">:</span> <span class="o">/</span><span class="n">tgwenv</span>
        <span class="n">volumeMounts</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">tgwenv</span>
          <span class="n">mountPath</span><span class="o">:</span> <span class="o">/</span><span class="n">tgwenv</span>
      <span class="n">volumes</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">config</span>
        <span class="n">configMap</span><span class="o">:</span>
          <span class="n">name</span><span class="o">:</span> <span class="n">apps</span><span class="o">-</span><span class="n">relay</span><span class="o">-</span><span class="n">config</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">tgwenv</span>
        <span class="n">emptyDir</span><span class="o">:</span> <span class="o">{}</span>
</pre></div>


<h2 id="2">2. 配置项介绍</h2>
<p>StatefulSet 和 Deployment 的大部分配置相同，这里就不在介绍相同点(具体参考 Deployment 说明中的配置项介绍)，重点说明 StatefulSet 常用的配置</p>
<h3 id="21-pod">2.1 Pod 管理策略</h3>
<p><code>.spec.podManagementPolicy</code>有两种："OrderedReady"和"Parallel"，其中"Parallel"策略告诉 StatefulSet 控制器并行的终止所有 Pod，在启动或终止另一个 Pod 前，不必等待这些 Pod 变成 Running 和 Ready 或者完全终止状态</p>
<h3 id="22-initcontainers">2.2 initContainers</h3>
<p><code>initContainers</code>并非 StatefulSet 特有的，它同样可以被 Deployment，Daemonset 所使用。这里单独介绍是因为<code>initContainers</code>在 StatefulSet 中较常用，它可以根据每个 Pod 的“状态”，完成复杂的初始化工作，为后续容器的启动运行提供环境基础。</p>
<h2 id="3-statefulset">3. StatefulSet 之“吃豆小游戏”实践</h2>
<p>小游戏的后台房间服务用到了 StatefulSet，因为每个房间需要自己的网络标识，所以 Pod 是“有状态”的。</p>
<div class="codehilite"><pre><span></span><span class="n">apiVersion</span><span class="o">:</span> <span class="n">apps</span><span class="o">/</span><span class="n">v1beta2</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">StatefulSet</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">rumpetrollv2</span>
  <span class="kd">namespace</span><span class="o">:</span> <span class="n">rumpetroll</span><span class="o">-</span><span class="n">v2</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">selector</span><span class="o">:</span>
    <span class="n">matchLabels</span><span class="o">:</span>
      <span class="n">app</span><span class="o">:</span> <span class="n">web</span>
  <span class="n">serviceName</span><span class="o">:</span> <span class="s2">&quot;rumpetroll2&quot;</span>
  <span class="n">replicas</span><span class="o">:</span> <span class="mi">5</span>
  <span class="n">template</span><span class="o">:</span>
    <span class="n">metadata</span><span class="o">:</span>
      <span class="n">labels</span><span class="o">:</span>
        <span class="n">app</span><span class="o">:</span> <span class="n">web</span>
    <span class="n">spec</span><span class="o">:</span>
      <span class="n">containers</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">web</span>
        <span class="n">image</span><span class="o">:</span> <span class="n">pyrumpetroll</span><span class="o">:</span><span class="mf">0.3</span>
        <span class="n">ports</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">containerPort</span><span class="o">:</span> <span class="mi">20000</span>
          <span class="n">name</span><span class="o">:</span> <span class="n">web</span>
        <span class="n">env</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">DOMAIN</span>
          <span class="n">value</span><span class="o">:</span> <span class="n">game2</span><span class="o">-</span><span class="n">got</span><span class="o">.</span><span class="na">o</span><span class="o">.</span><span class="na">qcloud</span><span class="o">.</span><span class="na">com</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">MAX_CLIENT</span>
          <span class="n">value</span><span class="o">:</span> <span class="s2">&quot;2&quot;</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">MAX_ROOM</span>
          <span class="n">value</span><span class="o">:</span> <span class="s2">&quot;100&quot;</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">REDIS_HOST</span>
          <span class="n">value</span><span class="o">:</span> <span class="n">redis</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">REDIS_PORT</span>
          <span class="n">value</span><span class="o">:</span> <span class="s2">&quot;6379&quot;</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">REDIS_DB</span>
          <span class="n">value</span><span class="o">:</span> <span class="s2">&quot;0&quot;</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">REDIS_PASSWORD</span>
          <span class="n">value</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">NUMPROCS</span>
          <span class="n">value</span><span class="o">:</span> <span class="s2">&quot;1&quot;</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">HOST</span>
          <span class="n">valueFrom</span><span class="o">:</span>
            <span class="n">fieldRef</span><span class="o">:</span>
              <span class="n">fieldPath</span><span class="o">:</span> <span class="n">status</span><span class="o">.</span><span class="na">podIP</span>
</pre></div>


<h2 id="4-bcs">4. BCS 模板集操作</h2>
<p>关于 StatefulSet 在 BCS 界面的用法，请参照 <a href="../../../Scenes/Deploy_wordpress.md">在 K8S 中部署 WordPress</a>。</p>
<p>Helm 实例化 WordPress 资源描述文件如下：</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/k8s/workload/media/15684300467698.jpg" /></p>
<p>部署成功后的实例如下：
<img alt="-w1677" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/k8s/workload/media/15684299788323.jpg" /></p><h1 id="kubernetes-job">Kubernetes Job 说明</h1>
<p>Job 负责批量处理短暂的一次性任务，即仅执行一次的任务，它保证批处理任务的一个或多个 Pod 成功结束。kubernetes(简称 k8s)支持以下几种 Job：
- 非并行 Job：通常创建一个 Pod 直至其成功结束
- 固定结束次数的 Job：设置<code>.spec.completions</code>，创建多个 Pod，直到<code>.spec.completions</code>个 Pod 成功结束
- 带有工作队列的并行 Job：设置<code>.spec.Parallelism</code>但不设置<code>.spec.completions</code>，当所有 Pod 结束并且至少一个成功时，Job 就认为是成功</p>
<h2 id="1">1. 模板示例</h2>
<div class="codehilite"><pre><span></span><span class="n">apiVersion</span><span class="o">:</span> <span class="n">batch</span><span class="o">/</span><span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Job</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">ah</span><span class="o">-</span><span class="n">buyer</span><span class="o">-</span><span class="n">init</span><span class="o">-</span><span class="n">auctionhouse</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">template</span><span class="o">:</span>
    <span class="n">metadata</span><span class="o">:</span>
      <span class="n">name</span><span class="o">:</span> <span class="n">ah</span><span class="o">-</span><span class="n">buyer</span><span class="o">-</span><span class="n">init</span><span class="o">-</span><span class="n">auctionhouse</span>
    <span class="n">spec</span><span class="o">:</span>
      <span class="n">nodeSelector</span><span class="o">:</span>
        <span class="n">network</span><span class="o">:</span> <span class="kd">private</span>
      <span class="n">containers</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">ah</span><span class="o">-</span><span class="n">buyer</span><span class="o">-</span><span class="n">init</span><span class="o">-</span><span class="n">auctionhouse</span>
        <span class="n">image</span><span class="o">:</span> <span class="n">solr</span><span class="o">:</span><span class="mf">5.5</span><span class="o">.</span><span class="mi">5</span>
        <span class="n">command</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">sh</span>
        <span class="o">-</span> <span class="sr">/opt/ahs/jobs/i</span><span class="n">nit</span><span class="o">-</span><span class="n">auctionhouse</span><span class="o">.</span><span class="na">sh</span>
        <span class="n">volumeMounts</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">initjobconfig</span>
          <span class="n">mountPath</span><span class="o">:</span> <span class="sr">/opt/ahs/</span><span class="n">jobs</span>
      <span class="n">restartPolicy</span><span class="o">:</span> <span class="n">OnFailure</span>
      <span class="n">volumes</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">initjobconfig</span>
        <span class="n">configMap</span><span class="o">:</span>
          <span class="n">name</span><span class="o">:</span> <span class="n">ah</span><span class="o">-</span><span class="n">buyer</span><span class="o">-</span><span class="n">init</span><span class="o">-</span><span class="n">jobs</span><span class="o">-</span><span class="n">config</span>
  <span class="n">backoffLimit</span><span class="o">:</span> <span class="mi">4</span>
</pre></div>


<h2 id="2">2.  配置项介绍</h2>
<ul>
<li><code>.spec.template</code>: 这里不再介绍(具体参考 Deployment 说明中的配置项介绍)</li>
<li><code>.spec.completions</code>:  标志 Job 结束需要成功运行的 Pod 个数，默认为 1</li>
<li><code>.spec.parallelism</code>:  标志并行运行的 Pod 的个数，默认为 1</li>
<li><code>.spec.template.spec.containers.restartPolicy</code>: 只能是"Never"或者"OnFailure"</li>
<li><code>.spec.backoffLimit</code>: 确定为失败前的重试次数</li>
<li><code>.spec.activeDeadlineSeconds</code>: 失败 Pod 的重试最大时间，超过这个时间不会继续重试 (No more pods will be created, and existing pods will be deleted)</li>
</ul><h1 id="kubernetes-daemonset">Kubernetes DaemonSet 说明</h1>
<p>DaemonSet 能够让所有（或者一些特定）的 Node 节点运行同一个 Pod。当有节点加入集群时，也会为他们新增一个 Pod。</p>
<p>当有节点从集群移除时，这些 Pod 也会被回收。</p>
<p>删除 DaemonSet 将会删除它创建的所有 Pod。</p>
<p>使用 DaemonSet 的一些典型用法：
- 运行集群存储 daemon，例如在每个节点上运行 glusterd、ceph
- 在每个节点上运行日志收集 daemon，例如 fluentd、logstash
- 在每个节点上运行监控 daemon，例如 Prometheus Node Exporter、collectd 等</p>
<h2 id="1">1. 模板示例</h2>
<div class="codehilite"><pre><span></span><span class="n">apiVersion</span><span class="o">:</span> <span class="n">extensions</span><span class="o">/</span><span class="n">v1beta1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">DaemonSet</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">node</span><span class="o">-</span><span class="n">exporter</span>
  <span class="kd">namespace</span><span class="o">:</span> <span class="n">monitoring</span>
  <span class="n">labels</span><span class="o">:</span>
    <span class="n">name</span><span class="o">:</span> <span class="n">node</span><span class="o">-</span><span class="n">exporter</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">template</span><span class="o">:</span>
    <span class="n">metadata</span><span class="o">:</span>
      <span class="n">labels</span><span class="o">:</span>
        <span class="n">name</span><span class="o">:</span> <span class="n">node</span><span class="o">-</span><span class="n">exporter</span>
      <span class="n">annotations</span><span class="o">:</span>
         <span class="n">prometheus</span><span class="o">.</span><span class="na">io</span><span class="o">/</span><span class="n">scrape</span><span class="o">:</span> <span class="s2">&quot;true&quot;</span>
         <span class="n">prometheus</span><span class="o">.</span><span class="na">io</span><span class="o">/</span><span class="n">port</span><span class="o">:</span> <span class="s2">&quot;9100&quot;</span>
    <span class="n">spec</span><span class="o">:</span>
      <span class="n">hostPID</span><span class="o">:</span> <span class="kc">true</span>
      <span class="n">hostIPC</span><span class="o">:</span> <span class="kc">true</span>
      <span class="n">hostNetwork</span><span class="o">:</span> <span class="kc">true</span>
      <span class="n">containers</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">ports</span><span class="o">:</span>
            <span class="o">-</span> <span class="n">containerPort</span><span class="o">:</span> <span class="mi">9100</span>
              <span class="n">protocol</span><span class="o">:</span> <span class="n">TCP</span>
          <span class="n">resources</span><span class="o">:</span>
            <span class="n">requests</span><span class="o">:</span>
              <span class="n">cpu</span><span class="o">:</span> <span class="mf">0.15</span>
          <span class="n">securityContext</span><span class="o">:</span>
            <span class="n">privileged</span><span class="o">:</span> <span class="kc">true</span>
          <span class="n">image</span><span class="o">:</span> <span class="n">prom</span><span class="o">/</span><span class="n">node</span><span class="o">-</span><span class="n">exporter</span><span class="o">:</span><span class="n">v0</span><span class="o">.</span><span class="mf">15.2</span>
          <span class="n">args</span><span class="o">:</span>
            <span class="o">-</span> <span class="o">--</span><span class="n">path</span><span class="o">.</span><span class="na">procfs</span>
            <span class="o">-</span> <span class="sr">/host/</span><span class="n">proc</span>
            <span class="o">-</span> <span class="o">--</span><span class="n">path</span><span class="o">.</span><span class="na">sysfs</span>
            <span class="o">-</span> <span class="sr">/host/s</span><span class="n">ys</span>
            <span class="o">-</span> <span class="o">--</span><span class="n">collector</span><span class="o">.</span><span class="na">filesystem</span><span class="o">.</span><span class="na">ignored</span><span class="o">-</span><span class="n">mount</span><span class="o">-</span><span class="n">points</span>
            <span class="o">-</span> <span class="s1">&#39;&quot;^/(sys|proc|dev|host|etc)($|/)&quot;&#39;</span>
          <span class="n">name</span><span class="o">:</span> <span class="n">node</span><span class="o">-</span><span class="n">exporter</span>
          <span class="n">volumeMounts</span><span class="o">:</span>
            <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">dev</span>
              <span class="n">mountPath</span><span class="o">:</span> <span class="sr">/host/</span><span class="n">dev</span>
            <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">proc</span>
              <span class="n">mountPath</span><span class="o">:</span> <span class="sr">/host/</span><span class="n">proc</span>
            <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">sys</span>
              <span class="n">mountPath</span><span class="o">:</span> <span class="sr">/host/s</span><span class="n">ys</span>
            <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">rootfs</span>
              <span class="n">mountPath</span><span class="o">:</span> <span class="o">/</span><span class="n">rootfs</span>
      <span class="n">volumes</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">proc</span>
          <span class="n">hostPath</span><span class="o">:</span>
            <span class="n">path</span><span class="o">:</span> <span class="o">/</span><span class="n">proc</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">dev</span>
          <span class="n">hostPath</span><span class="o">:</span>
            <span class="n">path</span><span class="o">:</span> <span class="o">/</span><span class="n">dev</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">sys</span>
          <span class="n">hostPath</span><span class="o">:</span>
            <span class="n">path</span><span class="o">:</span> <span class="o">/</span><span class="n">sys</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">rootfs</span>
          <span class="n">hostPath</span><span class="o">:</span>
            <span class="n">path</span><span class="o">:</span> <span class="o">/</span>
</pre></div>


<h2 id="2">2. 配置项介绍</h2>
<p>DaemonSet 和 Deployment 的大部分配置相同，这里就不在介绍相同点(具体参考 Deployment 说明中的配置项介绍)。</p>
<p>由于 DaemonSet 本身的调度机制和 Deployment 有所不同，配置上会带来一些差异，例如 DaemonSet 并没有<code>.spec.replicas</code>字段，每个节点最多只运行一个 Pod，Pod 的总数取决于调度约束条件(节点个数、nodeSelector、taint 和 toleration 等)。</p><h1 id="kubernetes-cronjob">Kubernetes CronJob 说明</h1>
<p>K8S 集群使用 Cron Job 管理基于时间的作业，可以在指定的时间点执行一次或在指定时间点执行多次任务。 一个 Cron Job 就好像 Linux crontab 中的一行，可以按照 Cron 定时运行任务。</p>
<h2 id="1">1. 模板示例</h2>
<div class="codehilite"><pre><span></span><span class="n">apiVersion</span><span class="o">:</span> <span class="n">batch</span><span class="o">/</span><span class="n">v1beta1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">CronJob</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">recordpopulation</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">concurrencyPolicy</span><span class="o">:</span> <span class="n">Allow</span>
  <span class="n">failedJobsHistoryLimit</span><span class="o">:</span> <span class="mi">1</span>
  <span class="n">jobTemplate</span><span class="o">:</span>
      <span class="n">spec</span><span class="o">:</span>
      <span class="n">template</span><span class="o">:</span>
        <span class="n">spec</span><span class="o">:</span>
          <span class="n">containers</span><span class="o">:</span>
          <span class="o">-</span> <span class="n">args</span><span class="o">:</span>
            <span class="o">-</span> <span class="sr">/app/</span><span class="n">cronrunner</span>
            <span class="o">-</span> <span class="o">-</span><span class="n">host</span>
            <span class="o">-</span> <span class="n">psynet</span><span class="o">:</span><span class="mi">8080</span>
            <span class="o">-</span> <span class="o">-</span><span class="n">job</span>
            <span class="o">-</span> <span class="sr">/ServiceTask/Population/</span><span class="n">RecordPopulation</span>
            <span class="n">env</span><span class="o">:</span>
            <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">TZ</span>
              <span class="n">value</span><span class="o">:</span> <span class="n">Asia</span><span class="o">/</span><span class="n">Shanghai</span>
            <span class="n">image</span><span class="o">:</span> <span class="n">cronrunner</span><span class="o">:</span><span class="n">tc1</span>
            <span class="n">imagePullPolicy</span><span class="o">:</span> <span class="n">IfNotPresent</span>
            <span class="n">name</span><span class="o">:</span> <span class="n">cronrunner</span>
            <span class="n">resources</span><span class="o">:</span> <span class="o">{}</span>
            <span class="n">terminationMessagePath</span><span class="o">:</span> <span class="sr">/dev/</span><span class="n">termination</span><span class="o">-</span><span class="n">log</span>
            <span class="n">terminationMessagePolicy</span><span class="o">:</span> <span class="n">File</span>
          <span class="n">dnsPolicy</span><span class="o">:</span> <span class="n">ClusterFirstWithHostNet</span>
          <span class="n">hostNetwork</span><span class="o">:</span> <span class="kc">true</span>
          <span class="n">restartPolicy</span><span class="o">:</span> <span class="n">Never</span>
          <span class="n">schedulerName</span><span class="o">:</span> <span class="k">default</span><span class="o">-</span><span class="n">scheduler</span>
          <span class="n">securityContext</span><span class="o">:</span> <span class="o">{}</span>
          <span class="n">terminationGracePeriodSeconds</span><span class="o">:</span> <span class="mi">30</span>
  <span class="n">schedule</span><span class="o">:</span> <span class="s1">&#39;*/1 * * * *&#39;</span>
  <span class="n">successfulJobsHistoryLimit</span><span class="o">:</span> <span class="mi">3</span>
  <span class="n">suspend</span><span class="o">:</span> <span class="kc">false</span>
</pre></div>


<h2 id="2">2. 配置项介绍</h2>
<h3 id="21">2.1 调度</h3>
<p><code>.spec.schedule</code>是<code>.spec</code> 中必需的字段，它的值是 Cron 格式字的符串，例如：<code>*/1 * * * *</code> ，根据指定的调度时间 Job 会被创建和执行</p>
<h3 id="22">2.2 并发策略</h3>
<p><code>.spec.concurrencyPolicy</code>字段也是可选的。它指定了如何处理被 Cron Job 创建的 Job 的并发执行。只允许指定下面策略中的一种：
- Allow（默认）：允许并发运行 Job
- Forbid：禁止并发运行，如果前一个还没有完成，则直接跳过下一个
- Replace：取消当前正在运行的 Job，用一个新的来替换
注意，当前策略只能应用于同一个 Cron Job 创建的 Job。如果存在多个 Cron Job，它们创建的 Job 之间总是允许并发运行。</p>
<h3 id="23">2.3 挂起</h3>
<p><code>.spec.suspend</code> 字段是可选的。如果设置为 true，后续所有执行都将被挂起。它对已经开始执行的 Job 不起作用。默认值为 false</p><h1 id="kubernetes-service">Kubernetes Service 说明</h1>
<p>Service 是 kubernetes(简称 k8s)的一种抽象：一个 Pod 的逻辑分组，一种可以访问它们的策略 —— 通常称为微服务。这一组 Pod 能够被 Service 访问到，通常是通过 Label Selector 实现。</p>
<h2 id="1">1. 模板示例</h2>
<div class="codehilite"><pre><span></span><span class="n">kind</span><span class="o">:</span> <span class="n">Service</span>
<span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">servergame</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">type</span><span class="o">:</span> <span class="n">NodePort</span>
  <span class="n">selector</span><span class="o">:</span>
    <span class="n">app</span><span class="o">:</span> <span class="n">servergame</span>
  <span class="n">ports</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">http</span>
    <span class="n">protocol</span><span class="o">:</span> <span class="n">TCP</span>
    <span class="n">port</span><span class="o">:</span> <span class="mi">8080</span>
    <span class="n">targetPort</span><span class="o">:</span> <span class="n">http</span>
    <span class="n">nodePort</span><span class="o">:</span> <span class="mi">30000</span>
</pre></div>


<h2 id="2">2. 配置项说明</h2>
<h3 id="21-servicetypes">2.1 ServiceTypes</h3>
<p>ServiceTypes 允许指定一个需要的类型的 Service，默认是<code>ClusterIP</code>类型
- ClusterIP：通过集群的内部 IP 暴露服务，选择该值，服务只能够在集群内部可以访问，这也是默认的 ServiceType。
- NodePort：通过每个 Node 上的 IP 和静态端口（NodePort）暴露服务。NodePort 服务会路由到 ClusterIP 服务，这个 ClusterIP 服务会自动创建。通过请求 <NodeIP>:<NodePort>，可以从集群的外部访问一个 NodePort 服务。
- LoadBalancer：使用云提供商的负载局衡器，可以向外部暴露服务。外部的负载均衡器可以路由到 NodePort 服务和 ClusterIP 服务。
- ExternalName：通过返回 CNAME 和它的值，可以将服务映射到 externalName 字段的内容（例如， foo.bar.example.com）。 没有任何类型代理被创建，这只有 Kubernetes 1.7 或更高版本的 kube-dns 才支持。
上面的示例中，Service 采用的是 NodePort 类型<code>.spec.type: NodePort</code>，同时也指定了服务端口号<code>nodePort: 30000</code>(如果不指定，会由系统在 service node range 中随机分配一个)</p>
<h3 id="22-selector">2.2 Selector</h3>
<p>通过<code>.spec.selector</code>， 将 Service 对象与指定的 Pods 进行关联。如示例中，<code>servergame</code>这一 Service 对象，会将请求代理到使用了 TCP 端口 8080，并且具有 label <code>app=servergame</code>的 Pods 上。</p>
<h3 id="23-ports">2.3 Ports</h3>
<p><code>.spec.ports[]</code>用来描述 Service 的接收端口与后端 Pod 端口之间的映射关系。Service 能够将一个接收端口映射到任意的 targetPort。 默认情况下，targetPort 将被设置为与 port 字段相同的值。 targetPort 可以是 Pod 的端口号，也可以是一个字符串(引用了 backend Pod 的一个端口的名称)。
<code>.spec.ports[i].protocol</code>能够支持 TCP 和 UDP 协议，默认 TCP 协议</p>
<h2 id="3-service">3. Service 之“吃豆小游戏”实践</h2>
<p>下面是 bcs 小游戏中，Service 用法的示例: rumpetroll2 用于暴露后端小游戏房间的服务，redis 用于暴露 redis 的服务。其中，rumpetroll2 会将请求代理到具有 label<code>app=web</code>的 Pods 上，<code>clusterIP: None</code>表示 rumpetroll2 是 Headless Service，适用于 statefulset 管理的 Pods。</p>
<div class="codehilite"><pre><span></span><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">rumpetroll2</span>
  <span class="kd">namespace</span><span class="o">:</span> <span class="n">rumpetroll</span><span class="o">-</span><span class="n">v2</span>
  <span class="n">labels</span><span class="o">:</span>
    <span class="n">app</span><span class="o">:</span> <span class="n">rumpetroll</span><span class="o">-</span><span class="n">v2</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">ports</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">port</span><span class="o">:</span> <span class="mi">80</span>
    <span class="n">name</span><span class="o">:</span> <span class="n">web</span>
  <span class="n">clusterIP</span><span class="o">:</span> <span class="n">None</span>
  <span class="n">selector</span><span class="o">:</span>
    <span class="n">app</span><span class="o">:</span> <span class="n">web</span>
</pre></div>


<div class="codehilite"><pre><span></span><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">redis</span>
  <span class="kd">namespace</span><span class="o">:</span> <span class="n">rumpetroll</span><span class="o">-</span><span class="n">v2</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">selector</span><span class="o">:</span>
    <span class="n">app</span><span class="o">:</span> <span class="n">redis</span><span class="o">-</span><span class="n">v2</span>
  <span class="n">ports</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="k">default</span>
    <span class="n">protocol</span><span class="o">:</span> <span class="n">TCP</span>
    <span class="n">port</span><span class="o">:</span> <span class="mi">6379</span>
    <span class="n">targetPort</span><span class="o">:</span> <span class="mi">6379</span>
</pre></div>


<h2 id="4-bcs">4. BCS 模板集操作</h2>
<p>关于 Service 的实战演练，请参照 <a href="../../../Scenes/Bcs_deploy_nginx_cluster.md">快速构建 Nginx 集群</a>。</p>
<p><img alt="-w1458" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/k8s/service/media/15684298606765.jpg" /></p><h1 id="kubernetes-ingress">kubernetes Ingress 说明</h1>
<p>Ingress 是管理外部访问集群内服务(典型的如 HTTP)的 API 对象。Ingress 可配置提供外部可访问的 URL、负载均衡、SSL、基于名称的虚拟主机等。用户通过 POST Ingress 资源到 API server 的方式来请求 Ingress。 Ingress controller 负责实现 Ingress，通常使用负载均衡器(如常用的 nginx-controller)。</p>
<h2 id="1">1. 模板示例</h2>
<div class="codehilite"><pre><span></span><span class="n">apiVersion</span><span class="o">:</span> <span class="n">extensions</span><span class="o">/</span><span class="n">v1beta1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Ingress</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">servergame</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">tls</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">hosts</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">demo</span><span class="o">.</span><span class="na">bcs</span><span class="o">.</span><span class="na">com</span>
    <span class="n">secretName</span><span class="o">:</span> <span class="n">servergame</span><span class="o">-</span><span class="n">secret</span>
  <span class="n">rules</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">host</span><span class="o">:</span> <span class="n">demo</span><span class="o">.</span><span class="na">bcs</span><span class="o">.</span><span class="na">com</span>
    <span class="n">http</span><span class="o">:</span>
      <span class="n">paths</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">backend</span><span class="o">:</span>
          <span class="n">serviceName</span><span class="o">:</span> <span class="n">servergame</span>
          <span class="n">servicePort</span><span class="o">:</span> <span class="mi">8080</span>
        <span class="n">path</span><span class="o">:</span> <span class="o">/</span>
</pre></div>


<h2 id="2">2. 配置项介绍</h2>
<h3 id="21">2.1 基于名称的虚拟主机</h3>
<p>通过<code>.spect.rules[]</code>来设置基于名称的虚拟主机，如示例中的<code>host: fwx.ffm.qq.com</code>，所有<code>https://demo.bcs.com:443/</code>的请求都会被转发给名称是<code>servergame</code>的 Service 后端所关联的 Pods</p>
<h3 id="22-tls">2.2 TLS</h3>
<p>通过指定包含 TLS 私钥和证书的 Secret 可以加密 Ingress。目前，Ingress 仅支持单个 TLS 端口 443，并假定 TLS termination。如示例中，利用<code>.spec.tls</code>给域名<code>demo.bcs.com</code>绑定了名为<code>servergame-secret</code>的 Secret 的 TLS 证书。<code>servergame-secret</code>的示意配置如下</p>
<div class="codehilite"><pre><span></span><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">data</span><span class="o">:</span>
  <span class="n">tls</span><span class="o">.</span><span class="na">crt</span><span class="o">:</span> <span class="n">base64</span> <span class="n">encoded</span> <span class="n">cert</span>
  <span class="n">tls</span><span class="o">.</span><span class="na">key</span><span class="o">:</span> <span class="n">base64</span> <span class="n">encoded</span> <span class="n">key</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Secret</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">servergame</span><span class="o">-</span><span class="n">secret</span>
<span class="n">type</span><span class="o">:</span> <span class="n">Opaque</span>
</pre></div>


<h2 id="3-bcs">3. BCS 模板集操作</h2>
<p>关于 Ingress 的实战演练，请参照 <a href="../../../Scenes/Bcs_blue_green_deployment.md">应用的蓝绿发布</a>。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/k8s/service/media/15684302423813.jpg" /></p><h1 id="kubernetes-configmap">kubernetes ConfigMap 说明</h1>
<p>ConfigMap 是用来存储配置文件的 kubernetes(简称 k8s)资源对象，它的作用是将配置文件从容器镜像中解耦，从而增强容器应用的可移植性。在一个 Pod 里面使用 ConfigMap 主要有两种方式：
- 环境变量
- 数据卷文件</p>
<h2 id="1">1. 模板示例</h2>
<h3 id="11">1.1 示例一：环境变量</h3>
<div class="codehilite"><pre><span></span><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">ConfigMap</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">external</span><span class="o">-</span><span class="n">config</span>
<span class="n">data</span><span class="o">:</span>
    <span class="n">AUX_CONNECTION_STRING</span><span class="o">:</span> <span class="n">jdbc</span><span class="o">:</span><span class="n">mysql</span><span class="o">://</span><span class="n">demo</span><span class="o">.</span><span class="na">bcs</span><span class="o">.</span><span class="na">com</span><span class="o">:</span><span class="mi">10000</span><span class="o">/</span><span class="n">db_ffm_aux</span>
    <span class="n">PUBLIC_ASSETS_URL</span><span class="o">:</span> <span class="n">https</span><span class="o">://</span><span class="n">demo</span><span class="o">.</span><span class="na">bcs</span><span class="o">.</span><span class="na">com</span><span class="o">/</span><span class="n">wxlive</span>
</pre></div>


<p>全导入用法</p>
<div class="codehilite"><pre><span></span>        <span class="n">envFrom</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">configMapRef</span><span class="p">:</span>
            <span class="n">name</span><span class="p">:</span> <span class="k">external</span><span class="o">-</span><span class="n">config</span>
</pre></div>


<p>或者部分引用</p>
<div class="codehilite"><pre><span></span>        <span class="n">env</span>
        <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">PUBLIC_ASSETS_URL</span>
          <span class="n">valueFrom</span><span class="p">:</span>
           <span class="n">configMapKeyRef</span><span class="p">:</span>
               <span class="n">name</span><span class="p">:</span> <span class="k">external</span><span class="o">-</span><span class="n">config</span>
               <span class="k">key</span><span class="p">:</span> <span class="n">PUBLIC_ASSETS_URL</span>
</pre></div>


<h3 id="12">1.2 示例二：数据卷文件</h3>
<div class="codehilite"><pre><span></span><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">ConfigMap</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">apps</span><span class="o">-</span><span class="n">servergame</span><span class="o">-</span><span class="n">tlog</span><span class="o">-</span><span class="n">config</span>
<span class="n">data</span><span class="o">:</span>
    <span class="n">logstash</span><span class="o">.</span><span class="na">conf</span><span class="o">:</span> <span class="o">|-</span>
    <span class="n">input</span> <span class="o">{</span>
      <span class="n">file</span> <span class="o">{</span>
        <span class="n">path</span> <span class="o">=&gt;</span> <span class="s2">&quot;/opt/servergame/log/tlog.log&quot;</span>
        <span class="n">type</span> <span class="o">=&gt;</span> <span class="s2">&quot;tlog&quot;</span>
        <span class="n">start_position</span> <span class="o">=&gt;</span> <span class="s2">&quot;beginning&quot;</span>
      <span class="o">}</span>
    <span class="o">}</span>

    <span class="n">filter</span> <span class="o">{</span>
    <span class="o">}</span>

    <span class="n">output</span> <span class="o">{</span>
    <span class="o">}</span>
</pre></div>


<p>引用方法</p>
<div class="codehilite"><pre><span></span>      <span class="n">volumes</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">config</span>
        <span class="n">configMap</span><span class="p">:</span>
          <span class="n">name</span><span class="p">:</span> <span class="n">apps</span><span class="o">-</span><span class="n">servergame</span><span class="o">-</span><span class="n">tlog</span><span class="o">-</span><span class="n">config</span>
</pre></div>


<h2 id="2">2. 配置项介绍</h2>
<p>ConfigMap 的配置数据存储在<code>data</code>字段中，具体参考示例模板</p>
<h2 id="3-bcs">3. BCS 模板集操作</h2>
<p>关于 ConfigMap 的实战演练，请参照 <a href="../../../Scenes/Bcs_blue_green_deployment.md">应用的蓝绿发布</a>。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/k8s/config/media/15684304092327.jpg" /></p><h1 id="kubernetes-secret">kubernetes Secret 说明</h1>
<p>kubernetes(简称 k8s)中的 Secret 资源可以用来存储密码、Token、秘钥等敏感数据。 将这些敏感信息保存在 Secret 中，相对于暴露到 Pod、镜像中更加的安全和灵活。k8s 内置了三种类型的 Secret
- Service Account Secret
- Opaque Secret
- kubernetes.io/dockerconfigjson</p>
<h2 id="1">1. 模板示例</h2>
<h3 id="11-service-account-secret">1.1 Service Account Secret</h3>
<p>为了能从集群内部访问 k8s API，k8s 提供了 Service Account 资源。 Service Account 会自动创建和挂载访问 k8s API 的 Secret，会挂载到 Pod 的<code>/var/run/secrets/kubernetes.io/serviceaccount</code>目录中。 这种类型的 Secret 通常不需要用户显示定义，所以这里不展开</p>
<h3 id="12-opaque-secret">1.2 Opaque Secret</h3>
<p>Opaue 类型的 Secret 是一个 map 结构(key-value)，其中 vlaue 要求以 base64 格式编码</p>
<div class="codehilite"><pre><span></span><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Secret</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">external</span><span class="o">-</span><span class="n">secret</span><span class="o">-</span><span class="n">config</span>
<span class="n">type</span><span class="o">:</span> <span class="n">Opaque</span>
<span class="n">data</span><span class="o">:</span>
  <span class="n">RDS_USERNAME</span><span class="o">:</span> <span class="n">YWRtaW4</span><span class="o">=</span>
  <span class="n">RDS_PASSWORD</span><span class="o">:</span> <span class="n">MWYyZDFlMmU2N2Rm</span>
</pre></div>


<p>引用方式</p>
<div class="codehilite"><pre><span></span>       <span class="n">envFrom</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">secretRef</span><span class="p">:</span>
            <span class="n">name</span><span class="p">:</span> <span class="k">external</span><span class="o">-</span><span class="n">secret</span><span class="o">-</span><span class="n">config</span>
</pre></div>


<h3 id="13-kubernetesiodockerconfigjson">1.3 kubernetes.io/dockerconfigjson</h3>
<p>用于 docker registry 认证的 secret</p>
<div class="codehilite"><pre><span></span><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">data</span><span class="o">:</span>
  <span class="o">.</span><span class="na">dockercfg</span><span class="o">:</span> <span class="n">eyJjY3IuY2NzLnRlbmNlbnR5dW4uY29tL3RlbmNlbnR5dW4iOnsidXNlcm5hbWUiOiIzMzIxMzM3OTk0IiwicGFzc3dvcmQiOiIxMjM0NTYuY29tIiwiZW1haWwiOiIzMzIxMzM3OTk0QHFxLmNvbSIsImF1dGgiOiJNek15TVRNek56azVORG94TWpNME5UWXVZMjl0In19</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Secret</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">paas</span><span class="o">.</span><span class="na">image</span><span class="o">.</span><span class="na">registry</span><span class="o">.</span><span class="na">default</span>
<span class="n">type</span><span class="o">:</span> <span class="n">kubernetes</span><span class="o">.</span><span class="na">io</span><span class="o">/</span><span class="n">dockerconfigjson</span>
</pre></div>


<p>引用方法</p>
<div class="codehilite"><pre><span></span>  <span class="n">spec</span><span class="p">:</span>
      <span class="n">imagePullSecrets</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">paas</span><span class="p">.</span><span class="n">image</span><span class="p">.</span><span class="n">registry</span><span class="p">.</span><span class="k">default</span>
</pre></div>


<h2 id="2">2. 配置项介绍</h2>
<p><code>type</code>字段用于指定 Secret 的类型，<code>data</code>字段存储数据信息(value 需要 base64 编码)</p>
<h2 id="3-bcs">3. BCS 模板集操作</h2>
<p>关于 Secret 的使用，请参照 <a href="../../../Scenes/Deploy_wordpress.md">在 K8S 中部署 WordPress</a>：</p>
<p>如果没有在 Chart 参数中没有设置密码，可以通过命令获取 WordPress 的 Secret。</p>
<div class="codehilite"><pre><span></span><span class="c1"># kubectl  get secret -n dev</span>
<span class="l l-Scalar l-Scalar-Plain">NAME                                                TYPE                                  DATA   AGE</span>
<span class="l l-Scalar l-Scalar-Plain">wordpress-1909130255                                Opaque                                1      4h37m</span>

<span class="l l-Scalar l-Scalar-Plain"># kubectl  get secret/wordpress-1909130255 -n dev -o yaml</span>
<span class="l l-Scalar l-Scalar-Plain">apiVersion</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">data</span><span class="p">:</span>
  <span class="nt">wordpress-password</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bFgzTmZvSHJIVg==</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Secret</span>
  <span class="l l-Scalar l-Scalar-Plain">creationTimestamp</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">2019-09-13T07:01:33Z</span>
  <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">wordpress-1909130255</span>
  <span class="l l-Scalar l-Scalar-Plain">namespace</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">dev</span>
<span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Opaque</span>

<span class="c1"># echo &quot;bFgzTmZvSHJIVg==&quot; | base64 --decode</span>
<span class="l l-Scalar l-Scalar-Plain">lX3NfoHrHV</span>
</pre></div><h1 id="_1">吃豆小游戏案例</h1>
<h2 id="1">1. 小游戏介绍</h2>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/assets/15290364195112/2018-06-19-15-49-27.jpg" /></p>
<p>分为 3 个模块， openresty、rumpetroll 和 redis。其中 openresty 作为游戏的接入模块，rumpetroll 是游戏房间(游戏后台)，redis 是数据存储与服务发现模块。</p>
<h2 id="2">2. 模块示例</h2>
<h3 id="deployment-openresty">基于 Deployment 部署 openresty</h3>
<div class="codehilite"><pre><span></span><span class="n">apiVersion</span><span class="o">:</span> <span class="n">extensions</span><span class="o">/</span><span class="n">v1beta1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Deployment</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">openresty</span><span class="o">-</span><span class="n">v2</span>
  <span class="kd">namespace</span><span class="o">:</span> <span class="n">rumpetroll</span><span class="o">-</span><span class="n">v2</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">replicas</span><span class="o">:</span> <span class="mi">1</span>
  <span class="n">selector</span><span class="o">:</span>
    <span class="n">matchLabels</span><span class="o">:</span>
      <span class="n">app</span><span class="o">:</span> <span class="n">openresty</span><span class="o">-</span><span class="n">v2</span>
  <span class="n">template</span><span class="o">:</span>
    <span class="n">metadata</span><span class="o">:</span>
      <span class="n">labels</span><span class="o">:</span>
        <span class="n">app</span><span class="o">:</span> <span class="n">openresty</span><span class="o">-</span><span class="n">v2</span>
    <span class="n">spec</span><span class="o">:</span>
      <span class="n">hostNetwork</span><span class="o">:</span> <span class="kc">true</span>
      <span class="n">dnsPolicy</span><span class="o">:</span> <span class="n">ClusterFirstWithHostNet</span>
      <span class="n">hostAliases</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">ip</span><span class="o">:</span> <span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span>
        <span class="n">hostnames</span><span class="o">:</span>
        <span class="o">-</span> <span class="s2">&quot;game2-got.o.qcloud.com&quot;</span>
      <span class="n">containers</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">openresty</span>
        <span class="n">image</span><span class="o">:</span> <span class="n">rumpetroll</span><span class="o">-</span><span class="n">openresty</span><span class="o">:</span><span class="mf">0.61</span>
        <span class="n">imagePullPolicy</span><span class="o">:</span> <span class="n">IfNotPresent</span>
        <span class="n">ports</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">containerPort</span><span class="o">:</span> <span class="mi">80</span>
          <span class="n">hostPort</span><span class="o">:</span> <span class="mi">80</span>
          <span class="n">protocol</span><span class="o">:</span> <span class="n">TCP</span>
        <span class="n">env</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">DOMAIN</span>
          <span class="n">value</span><span class="o">:</span> <span class="n">game2</span><span class="o">-</span><span class="n">got</span><span class="o">.</span><span class="na">o</span><span class="o">.</span><span class="na">qcloud</span><span class="o">.</span><span class="na">com</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">MAX_CLIENT</span>
          <span class="n">value</span><span class="o">:</span> <span class="s2">&quot;2&quot;</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">MAX_ROOM</span>
          <span class="n">value</span><span class="o">:</span> <span class="s2">&quot;100&quot;</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">REDIS_HOST</span>
          <span class="n">value</span><span class="o">:</span> <span class="s2">&quot;redis&quot;</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">NAMESPACE</span>
          <span class="n">valueFrom</span><span class="o">:</span>
            <span class="n">fieldRef</span><span class="o">:</span>
              <span class="n">fieldPath</span><span class="o">:</span> <span class="n">metadata</span><span class="o">.</span><span class="na">namespace</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">REDIS_PORT</span>
          <span class="n">value</span><span class="o">:</span> <span class="s2">&quot;6379&quot;</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">REDIS_DB</span>
          <span class="n">value</span><span class="o">:</span> <span class="s2">&quot;0&quot;</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">REDIS_PASSWORD</span>
          <span class="n">value</span><span class="o">:</span> <span class="s2">&quot;&quot;</span>
</pre></div>


<p>openresty 模块直接使用主机网络，对外提供访问服务</p>
<h3 id="statefulset-rumpetroll">基于 Statefulset 部署 rumpetroll</h3>
<div class="codehilite"><pre><span></span><span class="n">apiVersion</span><span class="o">:</span> <span class="n">apps</span><span class="o">/</span><span class="n">v1beta2</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">StatefulSet</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">rumpetrollv2</span>
  <span class="kd">namespace</span><span class="o">:</span> <span class="n">rumpetroll</span><span class="o">-</span><span class="n">v2</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">selector</span><span class="o">:</span>
    <span class="n">matchLabels</span><span class="o">:</span>
      <span class="n">app</span><span class="o">:</span> <span class="n">web</span>
  <span class="n">serviceName</span><span class="o">:</span> <span class="s2">&quot;rumpetroll2&quot;</span>
  <span class="n">replicas</span><span class="o">:</span> <span class="mi">5</span>
  <span class="n">template</span><span class="o">:</span>
    <span class="n">metadata</span><span class="o">:</span>
      <span class="n">labels</span><span class="o">:</span>
        <span class="n">app</span><span class="o">:</span> <span class="n">web</span>
    <span class="n">spec</span><span class="o">:</span>
      <span class="n">containers</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">web</span>
        <span class="n">image</span><span class="o">:</span> <span class="n">pyrumpetroll</span><span class="o">:</span><span class="mf">0.3</span>
        <span class="n">ports</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">containerPort</span><span class="o">:</span> <span class="mi">20000</span>
          <span class="n">name</span><span class="o">:</span> <span class="n">web</span>
        <span class="n">env</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">DOMAIN</span>
          <span class="n">value</span><span class="o">:</span> <span class="n">game2</span><span class="o">-</span><span class="n">got</span><span class="o">.</span><span class="na">o</span><span class="o">.</span><span class="na">qcloud</span><span class="o">.</span><span class="na">com</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">MAX_CLIENT</span>
          <span class="n">value</span><span class="o">:</span> <span class="s2">&quot;2&quot;</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">MAX_ROOM</span>
          <span class="n">value</span><span class="o">:</span> <span class="s2">&quot;100&quot;</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">REDIS_HOST</span>
          <span class="n">value</span><span class="o">:</span> <span class="n">redis</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">REDIS_PORT</span>
          <span class="n">value</span><span class="o">:</span> <span class="s2">&quot;6379&quot;</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">REDIS_DB</span>
          <span class="n">value</span><span class="o">:</span> <span class="s2">&quot;0&quot;</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">REDIS_PASSWORD</span>
          <span class="n">value</span><span class="o">:</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">NUMPROCS</span>
          <span class="n">value</span><span class="o">:</span> <span class="s2">&quot;1&quot;</span>
        <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">HOST</span>
          <span class="n">valueFrom</span><span class="o">:</span>
            <span class="n">fieldRef</span><span class="o">:</span>
              <span class="n">fieldPath</span><span class="o">:</span> <span class="n">status</span><span class="o">.</span><span class="na">podIP</span>
</pre></div>


<div class="codehilite"><pre><span></span><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">rumpetroll2</span>
  <span class="kd">namespace</span><span class="o">:</span> <span class="n">rumpetroll</span><span class="o">-</span><span class="n">v2</span>
  <span class="n">labels</span><span class="o">:</span>
    <span class="n">app</span><span class="o">:</span> <span class="n">rumpetroll</span><span class="o">-</span><span class="n">v2</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">ports</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">port</span><span class="o">:</span> <span class="mi">80</span>
    <span class="n">name</span><span class="o">:</span> <span class="n">web</span>
  <span class="n">clusterIP</span><span class="o">:</span> <span class="n">None</span>
  <span class="n">selector</span><span class="o">:</span>
    <span class="n">app</span><span class="o">:</span> <span class="n">web</span>
</pre></div>


<p>由于每个房间有自己的标识，是有"状态的"，因此采用 StatefulSet 方式部署；同时配置 Headless Service,  提供给 openresty 模块访问</p>
<h3 id="deployment-redis">基于 Deployment 部署 redis</h3>
<div class="codehilite"><pre><span></span><span class="n">apiVersion</span><span class="o">:</span> <span class="n">extensions</span><span class="o">/</span><span class="n">v1beta1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Deployment</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">redis</span><span class="o">-</span><span class="n">v2</span>
  <span class="kd">namespace</span><span class="o">:</span> <span class="n">rumpetroll</span><span class="o">-</span><span class="n">v2</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">replicas</span><span class="o">:</span> <span class="mi">1</span>
  <span class="n">selector</span><span class="o">:</span>
    <span class="n">matchLabels</span><span class="o">:</span>
      <span class="n">app</span><span class="o">:</span> <span class="n">redis</span><span class="o">-</span><span class="n">v2</span>
  <span class="n">template</span><span class="o">:</span>
    <span class="n">metadata</span><span class="o">:</span>
      <span class="n">labels</span><span class="o">:</span>
        <span class="n">app</span><span class="o">:</span> <span class="n">redis</span><span class="o">-</span><span class="n">v2</span>
    <span class="n">spec</span><span class="o">:</span>
      <span class="n">containers</span><span class="o">:</span>
      <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">redis</span><span class="o">-</span><span class="n">v2</span>
        <span class="n">image</span><span class="o">:</span> <span class="n">redis</span><span class="o">:</span><span class="mf">1.0</span>
        <span class="n">imagePullPolicy</span><span class="o">:</span> <span class="n">IfNotPresent</span>
</pre></div>


<div class="codehilite"><pre><span></span><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Service</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">redis</span>
  <span class="kd">namespace</span><span class="o">:</span> <span class="n">rumpetroll</span><span class="o">-</span><span class="n">v2</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">selector</span><span class="o">:</span>
    <span class="n">app</span><span class="o">:</span> <span class="n">redis</span><span class="o">-</span><span class="n">v2</span>
  <span class="n">ports</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="k">default</span>
    <span class="n">protocol</span><span class="o">:</span> <span class="n">TCP</span>
    <span class="n">port</span><span class="o">:</span> <span class="mi">6379</span>
    <span class="n">targetPort</span><span class="o">:</span> <span class="mi">6379</span>
</pre></div>


<p>redis 服务模块采用 Deployment 方式部署，并创建与其关联的 Service。Service 的 Cluster IP 会被注册到 dns 中，方便 openresty 和 rumpetroll 模块从集群内访问服务</p><h1 id="_1">应用列表说明文档</h1>
<p>蓝鲸容器服务应用列表分两个维度展示：模板集维度和命名空间维度；其中，模板集维度主要展示由【模板集】实例化的应用；命名空间维度展示了集群下所有所有命名空间下的所有应用，来源包含模板集、Helm、Client 实例化的应用；以便用户查看和操作应用及查看应用下容器运行详情及资源使用详情。</p>
<ul>
<li>应用类型
deployment/daemonset/job/statefuleset</li>
</ul>
<h2 id="1">1. 查询展示</h2>
<ul>
<li>模板及应用展示</li>
</ul>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/assets/application/template_instance.jpg" /></p>
<ul>
<li>应用详情</li>
</ul>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/assets/application/instance_detail.jpg" /></p>
<ul>
<li>容器详情</li>
</ul>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/assets/application/container_detail.jpg" /></p>
<h2 id="2">2. 操作相关</h2>
<ul>
<li>滚动升级</li>
</ul>
<p><code>注: 允许应用类型包含 deployment/daemonset/job/statefulset</code></p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/assets/application/rollingupdate.jpg" /></p>
<ul>
<li>扩缩容</li>
</ul>
<p>实例数量增加或减少</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/assets/application/scale.jpg" /></p>
<ul>
<li>重建应用</li>
</ul>
<p>重建包含两个步骤: 删除当前应用，然后以现有配置再创建应用(类似进程重启)</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/assets/application/recreate.jpg" /></p>
<ul>
<li>删除应用</li>
</ul>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/assets/application/delete.jpg" /></p>
<ul>
<li>重新调度</li>
</ul>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/assets/application/reschedule.jpg" /></p><h1 id="k8s">K8S 使用技巧</h1>
<h2 id="1">1. 如何与集群中的资源进行比较</h2>
<ul>
<li>场景<ul>
<li>已有 K8S 集群，并部署有业务容器，并希望尽量降低变更风险</li>
<li>怀疑手动改了集群的一些资源配置</li>
</ul>
</li>
</ul>
<p>在 K8S 1.14 中新增了 <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/object-management/#declarative-object-configuration">kubectl diff</a> 命令，支持将线下 YAML 文件与线上环境做比对。</p>
<p>情景：将本地 deployment.yaml 中的 Nginx 的镜像从 1.17.0 修改为 1.17.1，与线上环境比对，结果如下：</p>
<div class="codehilite"><pre><span></span><span class="c1"># kubectl  diff -f deployment.yaml</span>
diff -u -N /tmp/LIVE-740052839/extensions.v1beta1.Deployment.default.bk-bcs-test /tmp/MERGED-190542234/extensions.v1beta1.Deployment.default.bk-bcs-test
--- /tmp/LIVE-740052839/extensions.v1beta1.Deployment.default.bk-bcs-test       <span class="m">2019</span>-09-09 <span class="m">16</span>:11:26.933501898 +0800
+++ /tmp/MERGED-190542234/extensions.v1beta1.Deployment.default.bk-bcs-test     <span class="m">2019</span>-09-09 <span class="m">16</span>:11:26.940501902 +0800
@@ -6,7 +6,7 @@
     kubectl.kubernetes.io/last-applied-configuration: <span class="p">|</span>
       <span class="o">{</span><span class="s2">&quot;apiVersion&quot;</span>:<span class="s2">&quot;extensions/v1beta1&quot;</span>,<span class="s2">&quot;kind&quot;</span>:<span class="s2">&quot;Deployment&quot;</span>,<span class="s2">&quot;metadata&quot;</span>:<span class="o">{</span><span class="s2">&quot;annotations&quot;</span>:<span class="o">{}</span>,<span class="s2">&quot;name&quot;</span>:<span class="s2">&quot;bk-bcs-test&quot;</span>,<span class="s2">&quot;namespace&quot;</span>:<span class="s2">&quot;default&quot;</span><span class="o">}</span>,<span class="s2">&quot;spec&quot;</span>:<span class="o">{</span><span class="s2">&quot;template&quot;</span>:<span class="o">{</span><span class="s2">&quot;metadata&quot;</span>:<span class="o">{</span><span class="s2">&quot;labels&quot;</span>:<span class="o">{</span><span class="s2">&quot;app&quot;</span>:<span class="s2">&quot;bk-bcs-test&quot;</span><span class="o">}}</span>,<span class="s2">&quot;spec&quot;</span>:<span class="o">{</span><span class="s2">&quot;containers&quot;</span>:<span class="o">[{</span><span class="s2">&quot;image&quot;</span>:<span class="s2">&quot;nginx:1.17.0&quot;</span>,<span class="s2">&quot;name&quot;</span>:<span class="s2">&quot;nginx&quot;</span><span class="o">}]}}}}</span>
   creationTimestamp: <span class="s2">&quot;2019-09-09T07:40:57Z&quot;</span>
-  generation: <span class="m">1</span>
+  generation: <span class="m">2</span>
   labels:
     app: bk-bcs-test
   name: bk-bcs-test
@@ -33,7 +33,7 @@
         app: bk-bcs-test
     spec:
       containers:
-      - image: nginx:1.17.0
+      - image: nginx:1.17.1
         imagePullPolicy: IfNotPresent
         name: nginx
         resources: <span class="o">{}</span>
<span class="nb">exit</span> status <span class="m">1</span>
</pre></div><h1 id="bcs-application">bcs application 配置说明</h1>
<p>bcs application 实现 Pod 的含义，并与 k8s 的 RC，Mesos 的 app 概念等价。</p>
<h2 id="1">1. 配置模板说明</h2>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;apiVersion&quot;</span><span class="p">:</span> <span class="s2">&quot;v4&quot;</span><span class="p">,</span>
    <span class="nt">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;application&quot;</span><span class="p">,</span>
    <span class="nt">&quot;restartPolicy&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;policy&quot;</span><span class="p">:</span> <span class="s2">&quot;Never | Always | OnFailure&quot;</span><span class="p">,</span>
        <span class="nt">&quot;interval&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="nt">&quot;backoff&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="nt">&quot;maxtimes&quot;</span><span class="p">:</span> <span class="mi">10</span>
    <span class="p">},</span>
    <span class="nt">&quot;killPolicy&quot;</span><span class="p">:{</span>
        <span class="nt">&quot;gracePeriod&quot;</span><span class="p">:</span> <span class="mi">10</span>
    <span class="p">},</span>
    <span class="nt">&quot;constraint&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;intersectionItem&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="nt">&quot;unionData&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ip-resources&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;operate&quot;</span><span class="p">:</span> <span class="s2">&quot;GREATER&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="nt">&quot;scalar&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="mi">0</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="nt">&quot;unionData&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;label&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;operate&quot;</span><span class="p">:</span> <span class="s2">&quot;EXCLUDE&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
                        <span class="nt">&quot;set&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="nt">&quot;item&quot;</span><span class="p">:</span> <span class="p">[</span>
                                <span class="s2">&quot;appname:gamesvr&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;appname:dbsvr&quot;</span>
                            <span class="p">]</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="nt">&quot;unionData&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;hostname&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;operate&quot;</span><span class="p">:</span> <span class="s2">&quot;CLUSTER&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
                        <span class="nt">&quot;set&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="nt">&quot;item&quot;</span><span class="p">:</span> <span class="p">[</span>
                                <span class="s2">&quot;slave3&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;slave4&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;slave5&quot;</span>
                            <span class="p">]</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="nt">&quot;unionData&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;district&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;operate&quot;</span><span class="p">:</span> <span class="s2">&quot;GROUPBY&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
                        <span class="nt">&quot;set&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="nt">&quot;item&quot;</span><span class="p">:</span> <span class="p">[</span>
                                <span class="s2">&quot;shanghai&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;shenzhen&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;tianjin&quot;</span>
                            <span class="p">]</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="nt">&quot;unionData&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;hostname&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;operate&quot;</span><span class="p">:</span> <span class="s2">&quot;LIKE&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                        <span class="nt">&quot;text&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;slave[3-5]&quot;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="nt">&quot;unionData&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;hostname&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;operate&quot;</span><span class="p">:</span> <span class="s2">&quot;UNLIKE&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                        <span class="nt">&quot;text&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;slave[1-2]&quot;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="nt">&quot;unionData&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;hostname&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;operate&quot;</span><span class="p">:</span> <span class="s2">&quot;UNIQUE&quot;</span>
                    <span class="p">}</span>
                <span class="p">]</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="nt">&quot;unionData&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;idc&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;operate&quot;</span><span class="p">:</span> <span class="s2">&quot;MAXPER&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                        <span class="nt">&quot;text&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;5&quot;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">},</span>
    <span class="nt">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;labels&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;io.tencent.bcs.netsvc.requestip.0&quot;</span><span class="p">:</span> <span class="s2">&quot;10.168.1.1&quot;</span><span class="p">,</span>
            <span class="nt">&quot;io.tencent.bcs.netsvc.requestip.1&quot;</span><span class="p">:</span> <span class="s2">&quot;10.168.2.1&quot;</span><span class="p">,</span>
            <span class="nt">&quot;io.tencent.bcs.netsvc.requestip.2&quot;</span><span class="p">:</span> <span class="s2">&quot;10.168.1.3&quot;</span><span class="p">,</span>
            <span class="nt">&quot;test_label&quot;</span><span class="p">:</span> <span class="s2">&quot;test_label&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ri-test-rc-001&quot;</span><span class="p">,</span>
        <span class="nt">&quot;namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;nfsol&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;spec&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;instance&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="nt">&quot;template&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;labels&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;test_label&quot;</span><span class="p">:</span> <span class="s2">&quot;test_label&quot;</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="nt">&quot;spec&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;containers&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="nt">&quot;hostname&quot;</span><span class="p">:</span> <span class="s2">&quot;container-hostname&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;command&quot;</span><span class="p">:</span> <span class="s2">&quot;bash&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;args&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="s2">&quot;args1&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;args2&quot;</span>
                        <span class="p">],</span>
                        <span class="nt">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="p">{</span>
                                <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;rm&quot;</span><span class="p">,</span>
                                <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;false&quot;</span>
                            <span class="p">}</span>
                        <span class="p">],</span>
                        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;MESOS&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;env&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="p">{</span>
                                <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;test_env&quot;</span><span class="p">,</span>
                                <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;test_env&quot;</span>
                            <span class="p">}</span>
                        <span class="p">],</span>
                        <span class="nt">&quot;image&quot;</span><span class="p">:</span> <span class="s2">&quot;hub_address.com/nfsol/log:92763&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;imagePullUser&quot;</span><span class="p">:</span> <span class="s2">&quot;userName&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;imagePullPasswd&quot;</span><span class="p">:</span> <span class="s2">&quot;passwd&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;imagePullPolicy&quot;</span><span class="p">:</span> <span class="s2">&quot;Always|IfNotPresent&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;privileged&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
                        <span class="nt">&quot;ports&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="p">{</span>
                                <span class="nt">&quot;containerPort&quot;</span><span class="p">:</span> <span class="mi">8090</span><span class="p">,</span>
                                <span class="nt">&quot;hostPort&quot;</span><span class="p">:</span> <span class="mi">8090</span><span class="p">,</span>
                                <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;test-tcp&quot;</span><span class="p">,</span>
                                <span class="nt">&quot;protocol&quot;</span><span class="p">:</span> <span class="s2">&quot;TCP&quot;</span>
                            <span class="p">},</span>
                            <span class="p">{</span>
                                <span class="nt">&quot;containerPort&quot;</span><span class="p">:</span> <span class="mi">8080</span><span class="p">,</span>
                                <span class="nt">&quot;hostPort&quot;</span><span class="p">:</span> <span class="mi">8080</span><span class="p">,</span>
                                <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;test-http&quot;</span><span class="p">,</span>
                                <span class="nt">&quot;protocol&quot;</span><span class="p">:</span> <span class="s2">&quot;http&quot;</span>
                            <span class="p">}</span>
                        <span class="p">],</span>
                        <span class="nt">&quot;healthChecks&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="p">{</span>
                                <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;HTTP|TCP|COMMAND|REMOTE_HTTP|REMOTE_TCP&quot;</span><span class="p">,</span>
                                <span class="nt">&quot;delaySeconds&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                                <span class="nt">&quot;intervalSeconds&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
                                <span class="nt">&quot;timeoutSeconds&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
                                <span class="nt">&quot;consecutiveFailures&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                                <span class="nt">&quot;gracePeriodSeconds&quot;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
                                <span class="nt">&quot;command&quot;</span> <span class="p">:</span> <span class="p">{</span>
                                    <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span>
                                <span class="p">},</span>
                                <span class="nt">&quot;http&quot;</span><span class="p">:</span> <span class="p">{</span>
                                    <span class="nt">&quot;port&quot;</span><span class="p">:</span> <span class="mi">8080</span><span class="p">,</span>
                                    <span class="nt">&quot;portName&quot;</span><span class="p">:</span> <span class="s2">&quot;test-http&quot;</span><span class="p">,</span>
                                    <span class="nt">&quot;scheme&quot;</span><span class="p">:</span> <span class="s2">&quot;http|https&quot;</span><span class="p">,</span>
                                    <span class="nt">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/check&quot;</span><span class="p">,</span>
                                    <span class="nt">&quot;headers&quot;</span><span class="p">:</span> <span class="p">{</span>
                                        <span class="nt">&quot;key1&quot;</span><span class="p">:</span> <span class="s2">&quot;value1&quot;</span><span class="p">,</span>
                                        <span class="nt">&quot;key2&quot;</span><span class="p">:</span> <span class="s2">&quot;value2&quot;</span>
                                    <span class="p">}</span>
                                <span class="p">},</span>
                                <span class="nt">&quot;tcp&quot;</span><span class="p">:</span> <span class="p">{</span>
                                    <span class="nt">&quot;port&quot;</span><span class="p">:</span> <span class="mi">8090</span><span class="p">,</span>
                                    <span class="nt">&quot;portName&quot;</span><span class="p">:</span> <span class="s2">&quot;test-tcp&quot;</span>
                                <span class="p">}</span>
                            <span class="p">}</span>
                        <span class="p">],</span>
                        <span class="nt">&quot;resources&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="nt">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="nt">&quot;cpu&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
                                <span class="nt">&quot;memory&quot;</span><span class="p">:</span> <span class="s2">&quot;8&quot;</span>
                            <span class="p">},</span>
                            <span class="nt">&quot;requests&quot;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="nt">&quot;cpu&quot;</span><span class="p">:</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span>
                                <span class="nt">&quot;memory&quot;</span><span class="p">:</span> <span class="s2">&quot;8&quot;</span>
                            <span class="p">}</span>
                        <span class="p">},</span>
                        <span class="nt">&quot;volumes&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="p">{</span>
                                <span class="nt">&quot;volume&quot;</span><span class="p">:</span> <span class="p">{</span>
                                    <span class="nt">&quot;hostPath&quot;</span><span class="p">:</span> <span class="s2">&quot;/data/host/path&quot;</span><span class="p">,</span>
                                    <span class="nt">&quot;mountPath&quot;</span><span class="p">:</span> <span class="s2">&quot;/container/path&quot;</span><span class="p">,</span>
                                    <span class="nt">&quot;readOnly&quot;</span><span class="p">:</span> <span class="kc">false</span>
                                <span class="p">},</span>
                                <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;test-vol&quot;</span>
                            <span class="p">}</span>
                        <span class="p">],</span>
                        <span class="nt">&quot;secrets&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="p">{</span>
                                <span class="nt">&quot;secretName&quot;</span><span class="p">:</span> <span class="s2">&quot;mySecret&quot;</span><span class="p">,</span>
                                <span class="nt">&quot;items&quot;</span><span class="p">:</span> <span class="p">[</span>
                                    <span class="p">{</span>
                                        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;env&quot;</span><span class="p">,</span>
                                        <span class="nt">&quot;dataKey&quot;</span><span class="p">:</span> <span class="s2">&quot;abc&quot;</span><span class="p">,</span>
                                        <span class="nt">&quot;keyOrPath&quot;</span><span class="p">:</span> <span class="s2">&quot;SRECT_ENV&quot;</span>
                                    <span class="p">},</span>
                                    <span class="p">{</span>
                                        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;file&quot;</span><span class="p">,</span>
                                        <span class="nt">&quot;dataKey&quot;</span><span class="p">:</span> <span class="s2">&quot;abc&quot;</span><span class="p">,</span>
                                        <span class="nt">&quot;keyOrPath&quot;</span><span class="p">:</span> <span class="s2">&quot;/data/container/path/filename.conf&quot;</span><span class="p">,</span>
                                        <span class="nt">&quot;subPath&quot;</span><span class="p">:</span> <span class="s2">&quot;relativedir/&quot;</span><span class="p">,</span>
                                        <span class="nt">&quot;readOnly&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
                                        <span class="nt">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;user00&quot;</span>
                                    <span class="p">}</span>
                                <span class="p">]</span>
                            <span class="p">}</span>
                        <span class="p">],</span>
                        <span class="nt">&quot;configmaps&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="p">{</span>
                                <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;template-configmap&quot;</span><span class="p">,</span>
                                <span class="nt">&quot;items&quot;</span><span class="p">:</span> <span class="p">[</span>
                                    <span class="p">{</span>
                                        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;env&quot;</span><span class="p">,</span>
                                        <span class="nt">&quot;dataKey&quot;</span><span class="p">:</span> <span class="s2">&quot;config-one&quot;</span><span class="p">,</span>
                                        <span class="nt">&quot;keyOrPath&quot;</span><span class="p">:</span> <span class="s2">&quot;SECRET_ENV&quot;</span>
                                    <span class="p">},</span>
                                    <span class="p">{</span>
                                        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;file&quot;</span><span class="p">,</span>
                                        <span class="nt">&quot;dataKey&quot;</span><span class="p">:</span> <span class="s2">&quot;config_two&quot;</span><span class="p">,</span>
                                        <span class="nt">&quot;dataKeyAlias&quot;</span><span class="p">:</span> <span class="s2">&quot;config-two&quot;</span><span class="p">,</span>
                                        <span class="nt">&quot;KeyOrPath&quot;</span><span class="p">:</span> <span class="s2">&quot;/data/contianer/path/filename.txt&quot;</span><span class="p">,</span>
                                        <span class="nt">&quot;readOnly&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
                                        <span class="nt">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;root&quot;</span>
                                    <span class="p">}</span>
                                <span class="p">]</span>
                            <span class="p">}</span>
                        <span class="p">]</span>
                    <span class="p">}</span>
                <span class="p">],</span>
                <span class="nt">&quot;networkMode&quot;</span><span class="p">:</span> <span class="s2">&quot;USER&quot;</span><span class="p">,</span>
                <span class="nt">&quot;networkType&quot;</span><span class="p">:</span> <span class="s2">&quot;cni&quot;</span><span class="p">,</span>
                <span class="nt">&quot;netLimit&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;egressLimit&quot;</span><span class="p">:</span> <span class="mi">100</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h3 id="11-killpolicy">1.1 KillPolicy 机制</h3>
<p>gracePeriod：宽限期描述在强制 kill container 之前等待多久，单位秒。 默认为 1</p>
<h3 id="12-restartpolicy">1.2 RestartPolicy 机制</h3>
<ul>
<li>
<p>policy：支持Never Always OnFailure三种配置(默认为OnFailure),OnFailure表示在失败的情况下重新调度,Always表示在失败和Lost情况下重新调度, Never表示任何情况下不重新调度</p>
</li>
<li>
<p>interval: 失败后到执行重启的间隔(秒),默认为0</p>
</li>
<li>
<p>backoff：多次失败时,每次重启间隔增加秒,默认为0.如果interval为5,backoff为10,则首次失败时5秒后重新调度,第二次失败时15秒后重新调度,第三次失败时25秒后重新调度</p>
</li>
<li>
<p>maxtimes: 最多重新调度次数,默认为0表示不受次数限制.容器正常运行30分钟后重启次数清零重新计算</p>
</li>
</ul>
<h3 id="13-constraint">1.3 constraint 调度约束</h3>
<p>constraint 字段用于定义调度策略</p>
<ul>
<li>IntersectionItem</li>
</ul>
<p>该字段为数组，策略为：所有元素同时满足时才进行调度。使用多个 IntersectionItem 可以同时满足多个条件限制。</p>
<p>每个 IntersectionItem 中支持多个 UnionData 为规则细节字段，用于填写调度匹配规则，也为数组，该数组含义为：所有元素只需要满足一个即可。使用 UnionData 可以实现多个条件满足其一即可。</p>
<h3 id="14-uniondata">1.4 UnionData 字段说明</h3>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;hostname&quot;</span><span class="p">,</span>
    <span class="nt">&quot;operate&quot;</span><span class="p">:</span> <span class="s2">&quot;ClUSTER&quot;</span><span class="p">,</span>
    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="err">|</span><span class="mi">4</span><span class="p">,</span>
    <span class="nt">&quot;set&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;item&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;mesos-slave-1&quot;</span><span class="p">,</span> <span class="s2">&quot;mesos-slave-2&quot;</span><span class="p">,</span> <span class="s2">&quot;mesos-slave-3&quot;</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="nt">&quot;text&quot;</span><span class="p">:{</span>
        <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;mesos-slave-1&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<ul>
<li>
<p>name: 调度字段 key（如主机名，主机类型，主机 IDC 等）用来调度的字段需要 mesos slave 通过属性的方式进行上报，hostname 参数自动获取无需属性上报</p>
</li>
<li>
<p>operator：调度算法，当前支持以下 5 种调度算法（大写）：</p>
</li>
<li>
<p>UNIQUE: 每个实例的 name 的取值唯一：如果 name 为主机名则表示每台主机只能部署一个实例，如果 name 为 IDC 则表示每个 IDC 只能部署一个实例。UNIQUE 算法无需参数。</p>
</li>
<li>
<p>MAXPER: name 同一取值下最多可运行的实例数，为 UNIQUE 的增强版（数量可配置），MAXPER 算法需通过参数 text(type 为 3)指定最多运行的实例数。</p>
</li>
<li>
<p>CLUSTER: 配合 set 字段（type 为 4），要求 name 的取值必须是 set 中一个，可以限定实例部署在 name 的取值在指定 set 范围。</p>
</li>
<li>
<p>LIKE: 配合 text 字段（type 为 3）或者 set 字段（type 为 4），name 与 text（或者 set）中的内容进行简单的正则匹配，可以限定实例部署时 name 的取值。如果是参数是 set（type 为 4），只要和 set 中某一个匹配即可。</p>
</li>
<li>
<p>UNLIKE: LIKE 取反。如果是参数为 set（type 为 4），必须和 set 中所有项都不匹配。</p>
</li>
<li>
<p>GROUPBY: 根据 name 的目标个数，实例被均匀调度在目标上，与 set 一起使用，如果实例个数不能被 set 的元素个数整除，则会存在差 1 的情况，例如：name 为 IDC，实例数为 3,set 为["idc1","idc2"],则会在其中一个 idc 部署两个实例。</p>
</li>
<li>
<p>EXCLUDE: 和具有指定标签的 application 不部署在相同的机器上，即：如果该主机上已经部署有这些标签（符合一个即可）的 application 的实例，则不能部署该 application 的实例。目前 name 只支持"label",label 的 k:v 在 set 数组中指定。</p>
</li>
<li>
<p>GREATER: 配合 scaler 字段（type 为 1），要求 name 的取值必须大于 scalar 的值。</p>
</li>
<li>
<p>type: 参数的数据类型，决定 operator 所操作 key 为 name 的值的范围</p>
</li>
</ul>
<p>1: scaler: float64</p>
<p>2：text：字符串。</p>
<p>3：set：字符串集合。</p>
<p>案例说明：</p>
<ul>
<li>要求各实例运行在不同主机上</li>
</ul>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;hostname&quot;</span><span class="p">,</span>
    <span class="nt">&quot;operate&quot;</span><span class="p">:</span> <span class="s2">&quot;UNIQUE&quot;</span>
<span class="p">}</span>
</pre></div>


<ul>
<li>要求实例限制运行在深圳和东莞地区（要求 slave 上报 section 字段）</li>
</ul>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;section&quot;</span><span class="p">,</span>
    <span class="nt">&quot;operate&quot;</span><span class="p">:</span> <span class="s2">&quot;ClUSTER&quot;</span><span class="p">,</span>
    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="nt">&quot;set&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;item&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;shenzhen&quot;</span><span class="p">,</span> <span class="s2">&quot;dongguan&quot;</span><span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<ul>
<li>要求实例运行在 mesos-slave-1，mesos-slave-2 上</li>
</ul>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;hostname&quot;</span><span class="p">,</span>
    <span class="nt">&quot;operate&quot;</span><span class="p">:</span> <span class="s2">&quot;LIKE&quot;</span><span class="p">,</span>
    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="nt">&quot;text&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;mesos-slave-[1-2]&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h3 id="15-meta">1.5 meta 元数据</h3>
<ul>
<li>
<p>name: Application 名字，小写字母与数字构成，但不能完全由数字构成，不能数字开头</p>
</li>
<li>
<p>namespace：App 命名空间，小写字母与数字构成，不能完全由数字构成，不能数字开头；不同业务必然不同，默认值为 defaultGroup</p>
</li>
<li>
<p>label：app 的 lable 信息，对应 k8s RC label</p>
<ul>
<li>
<p>io.tencent.bcs.cluster：用于标识集群 Id 信息</p>
</li>
<li>
<p>io.tencent.bcs.app.appid：业务 ccID</p>
</li>
<li>
<p>io.tencent.bcs.app.setid：业务 cc 大区 ID</p>
</li>
<li>
<p>io.tencent.bcs.app.moduleid：业务 cc 模块 ID</p>
</li>
</ul>
</li>
</ul>
<p>当容器网络使用 bcs-cni 方案的时，如果想针对容器指定 IP，可以使用以下 label</p>
<ul>
<li>io.tencent.bcs.netsvc.requestip.[i]：针对 Pod 申请 IP，i 代表 Pod 的实例，从 0 开始计算</li>
</ul>
<p>当容器指定 Ip 时，不同的 taskgroup 需要调度到特定的宿主机上面，宿主机的制定方式与 constraint 调度约束一致，如下是使用 InnerIp：</p>
<ul>
<li>io.tencent.bcs.netsvc.requestip.[i]: "10.168.1.1|InnerIp=10.158.49.13;10.158.49.12"</li>
</ul>
<p>使用分隔符"|"分隔，"|"前面为容器 Ip，后面为需要调度到的宿主机 Ip，多个宿主机之间使用分隔符";"分隔，宿主机 Ip 支持正则表示式，方式如下：</p>
<ul>
<li>io.tencent.bcs.netsvc.requestip.[i]: "10.168.1.1|InnerIp=10.158.49.[12-25];10.158.48.[11-13]"</li>
</ul>
<h3 id="16">1.6 容器字段信息</h3>
<ul>
<li>
<p>instance：运行实例个数</p>
</li>
<li>
<p>label：运行时容器 label 信息，对应 k8s pod label</p>
</li>
<li>
<p>name: pod 名字，mesos 中不启用</p>
</li>
<li>
<p>type：DOCKER/MESOS</p>
</li>
<li>
<p>hostname: 容器的 hostname 设置，如果网络模式为"HOST"，则该字段无效</p>
</li>
<li>
<p>command：字符串，容器启动命令，例如/bin/bash</p>
</li>
<li>
<p>args：command 的参数，例如 ["-c", "echo hello world"]</p>
</li>
<li>
<p>env: key/value 格式，环境变量。针对 BCS 默认注入的环境变量（BCS_CONTAINER_IP,BCS_NODE_IP）支持赋值操作</p>
</li>
<li>
<p>parameters：docker 参数，当前以下 docker 参数已支持</p>
</li>
<li>
<p>oom-kill-disable：有效值 true，设置为 true 后，如果容器资源超限会进行强杀</p>
</li>
<li>
<p>ulimit：可以设置 ulimit 参数，例如 core=-1</p>
</li>
<li>
<p>rm：有效值为 true，容器退出后，是否直接删除容器</p>
</li>
<li>
<p>image：镜像链接</p>
</li>
<li>
<p>imagePullSecrets：存储仓库鉴权信息的 secret 名字</p>
</li>
<li>
<p>imagePullPolicy：拉取容器策略</p>
</li>
<li>
<p>Always：每次都重新从仓库拉取</p>
</li>
<li>
<p>IfNotPresent：如果本地没有，则尝试拉取（默认值）</p>
</li>
<li>
<p>privileged：容器特权参数，默认为 false</p>
</li>
<li>
<p>resources：容器使用资源</p>
</li>
<li>
<p>limits.cpu:字符串，可以填写小数，1 为使用 1 核</p>
</li>
<li>
<p>limits.memory：内存使用，字符串，单位默认为 M. 注意：当 memory &gt;= 4Mb, 使用 memory 的值限制内存；否则，不对 memory 做 limits</p>
</li>
<li>
<p>limits.storage：磁盘使用大小，默认单位 M</p>
</li>
<li>
<p>request 仅对 k8s 生效</p>
</li>
<li>
<p>networkMode：网络模式</p>
</li>
<li>
<p>HOST: docker 原生网络模式，与宿主机共用一个 Network Namespace，此模式下需要自行解决网络端口冲突问题</p>
</li>
<li>
<p>BRIDGE: docker 原生网络模式，此模式会为每一个容器分配 Network Namespace、设置 IP 等，并将一个主机上的 Docker 容器连接到一个虚拟网桥上，通过端口映射的方式对外提供服务</p>
</li>
<li>
<p>NONE: 除了 lo 网络之外，不配置任何网络</p>
</li>
<li>
<p>USER: 用户深度定制的网络模式，支持 macvlan、calico 等网络方案</p>
</li>
<li>
<p>networkType：只有在 networkMode 为 USER 模式下，该字段才有效</p>
</li>
<li>
<p>cni(小写): 使用 bcs 提供的 cni 来构建网络，具体 cni 的类型是由配置决定</p>
</li>
<li>
<p>空或其它值：使用 docker 原生或用户自定义的方式来构建网络</p>
</li>
</ul>
<h3 id="17-netlimit">1.7 netLimit 说明</h3>
<p>对容器的网络流量进行限制，包括 ingress(进流量)和 egress(出流量)，默认情况下不限制。
暂时只支持对 egress 的限制。</p>
<ul>
<li>egressLimit: 容器出流量的限制，value 为大于 0 的整数，单位为 Mbps。</li>
</ul>
<h3 id="18-volume">1.8 Volume 说明</h3>
<p>支持主机磁盘挂载</p>
<ul>
<li>
<p>name：挂载名，在 app 中需要保持唯一</p>
</li>
<li>
<p>volume.hostPath: 主机目录</p>
</li>
<li>
<p>当目录没填写时，默认为创建一个随机目录，该目录 Pod 唯一</p>
</li>
<li>
<p>该目录路径可以支持变量$BCS_POD_ID</p>
</li>
<li>
<p>volume.mountPath: 需要挂载的容器目录，需要其父目录存在，否则报错</p>
</li>
<li>
<p>readOnly: true/false, 是否只读，默认 false</p>
</li>
</ul>
<h3 id="19-configmap">1.9 ConfigMap 说明</h3>
<p>主要功能是引用 configmap 数据，并作为环境变量/文件注入容器中。</p>
<ul>
<li>name：configmap 索引名字</li>
</ul>
<p><strong>环境变量</strong>注入</p>
<ul>
<li>
<p>items[x].type: env</p>
</li>
<li>
<p>items[x].dataKey: configmap 子项索引名</p>
</li>
<li>
<p>items[x].keyOrPath: 需要注入环境变量名</p>
</li>
</ul>
<p><strong>文件</strong>注入</p>
<ul>
<li>
<p>items[x].type: file</p>
</li>
<li>
<p>items[x].dataKey: configmap 子项索引名，默认为文件名</p>
</li>
<li>
<p>items[x].dataKeyAlias: 对于 k8s configmap，如果原始文件名带有"_"，则需要对文件进行重命名，使用 keyAlias 对子项进行索引。也可以增加前缀目录，keyAlias 拼接默认构成完成容器路径。</p>
</li>
<li>
<p>items[x].keyOrPath: 文件在容器中路径，需要保证父目录存在</p>
</li>
<li>
<p>items[x].readOnly: true/false，默认 false，文件是否只读</p>
</li>
<li>
<p>items[x].user: 文件用户设置，默认 root，k8s 不生效</p>
</li>
</ul>
<h3 id="110-secrets">1.10 Secrets 机制</h3>
<p>secret 在 k8s 和 mesos 中实现存在差异。在 k8s 中，即为默认支持的 secret 数据，并存储在 etcd 中；在 mesos 中，secret 为 bcs-scheduler 增加
的数据结构，数据默认存储在 vault 中，读写控制需要通过 bcs-authserver。secrets 的数据默认可以注入环境变量/文件。</p>
<p>在 k8s 中，secret 只能存储一项数据，所以不存在子项数据结构。mesos 下，一个 secret 可以存储多项数据。</p>
<ul>
<li>secretName: 引用的 secret 名字</li>
</ul>
<p>注入<strong>环境变量</strong>：</p>
<ul>
<li>
<p>items[x].type: env</p>
</li>
<li>
<p>items[x].dataKey: secret 中子项索引，mesos 有效</p>
</li>
<li>
<p>items[x].keyOrPath： 环境变量 KEY</p>
</li>
</ul>
<p>注入<strong>文件</strong></p>
<ul>
<li>
<p>items[x].type: file</p>
</li>
<li>
<p>items[x].dataKey：secret 中子项索引，mesos 有效</p>
</li>
<li>
<p>items[x].keyOrPath：需要挂载的容器目录</p>
</li>
<li>
<p>items[x].subPath：需要挂载子目录，仅 k8s 有效</p>
</li>
<li>
<p>items[x].readOnly： true/false，文件是否只读，默认为 false</p>
</li>
<li>
<p>items[x].user：user00，文件属主，mesos 有效</p>
</li>
</ul>
<h3 id="111-ports">1.11 容器 Ports 机制说明</h3>
<p>ports 字段说明：</p>
<ul>
<li>
<p>protocol：协议，必填，http，tcp，udp</p>
</li>
<li>
<p>name：标识 port 信息，唯一，必填</p>
</li>
<li>
<p>containerPort：容器中服务使用端口，必填</p>
</li>
<li>
<p>hostPort: 物理主机使用的端口，0 代表 scheduler 进行随机选择</p>
</li>
</ul>
<p>特别说明：</p>
<ul>
<li>
<p>host 模式下，containerPort 即代表 hostPort</p>
</li>
<li>
<p>填写固定端口，需要业务自行确认是否产生冲突</p>
</li>
<li>
<p>填写 0，意味着 scheduler 进行随机选择</p>
</li>
<li>
<p>bridge 模式下，hostPort 代表物理主机上的端口</p>
</li>
<li>
<p>hostPort 填写固定端口，业务自行解决冲突的问题</p>
</li>
<li>
<p>填写 0，scheduler 默认进行端口随机</p>
</li>
</ul>
<p><strong>端口随机</strong>的状态下，scheduler 会根据 ports 字段序号，生成 PORT0 ~ n 的环境变量，以便业务读取该随机端口。不支持 PORT_NAME 的方式</p>
<h2 id="2-health-check">2. <strong>容器 Health Check 机制说明</strong></h2>
<h3 id="21-mesos-executor-executor">2.1 通过 mesos 协议下发检测机制到 executor，通过 executor 执行检测</h3>
<ul>
<li>
<p>支持的类型为 HTTP,TCP 和 COMMAND 三种</p>
</li>
<li>
<p>scheduler 根据 application 定义的检测机制，启动进程时下发到 executor</p>
</li>
<li>
<p>executor 根据检测配置实施检测（并在多次检测失败的情况下 kill 进程，可配置）</p>
</li>
<li>
<p>executor 将检测结果通过 TaskStatus 中的 healthy（bool）上报到 scheduler</p>
</li>
<li>
<p>scheduler 根据 healthy 的值以及进程的其他数据(配置数据和动态数据)来确定后续行为：</p>
</li>
<li>
<p>状态修改，数据记录，触发告警等</p>
</li>
<li>
<p>重新调度</p>
</li>
</ul>
<h3 id="22-mesos-scheduler">2.2 mesos scheduler 根据检测机制直接远程执行检测</h3>
<ul>
<li>支持的类型为 REMOTE_HTTP,REMOTE_TCP</li>
</ul>
<h3 id="23-health-check-type">2.3 health check Type 说明</h3>
<ul>
<li>
<p>health check 可以同时支持多种类型的 check，目前最多为三种</p>
</li>
<li>
<p>HTTP,TCP 和 COMMAND 三种类型，最多只能同时支持一种</p>
</li>
<li>
<p>REMOTE_HTTP,REMOTE_TCP 两种类型可以同时支持</p>
</li>
</ul>
<h3 id="24-healthchecks">2.4 healthChecks 字段说明</h3>
<ul>
<li>
<p>type: 检测方式，目前支持 HTTP,TCP,COMMAND,REMOTE_TCP 和 REMOTE_HTTP  五种</p>
</li>
<li>
<p>delaySeconds：容器启动之后到开始进行健康检测的等待时长(mesos 协议中有,marathon 协议中不支持,因为有 gracePeriodSeconds,该参数好像意义不大,可能被废弃)</p>
</li>
<li>
<p>intervalSeconds：前后两次执行健康监测的时间间隔.</p>
</li>
<li>
<p>timeoutSeconds: 健康监测可允许的等待超时时间。在该段时间之后，不管收到什么样的响应，都被认为健康监测是失败的，<strong>timeoutSeconds 需要小于 intervalSeconds</strong></p>
</li>
<li>
<p>consecutiveFailures: 在一个不健康的任务被杀掉之前，连续的健康监测失败次数，如果值设为 0，tasks 如果不通过健康监测，则它不会被杀掉。进程被杀掉后 scheduler 根据 application 的 restartpolicy 来决定是否重新调度. marathon 协议中为 maxConsecutiveFailures</p>
</li>
<li>
<p>gracePeriodSeconds：启动之后在该时段内健康监测失败会被忽略。或直到任务首次变成健康状态.</p>
</li>
<li>
<p>command: type 为 COMMAND 时有效</p>
</li>
<li>
<p>value: 需要执行的命令,value 中支持环境变量.mesos 协议中区分是否 shell,这里不做区分,如果为 shell 命令,需要包括"/bin/bash ‐c",系统不会自动添加(参考 marathon)</p>
</li>
<li>
<p>后续可能需要补充其他参数如 USER</p>
</li>
<li>
<p>http: type 为 HTTP 和 REMOTE_HTTP 时有效</p>
</li>
<li>
<p>port: 检测的端口,如果配置为 0,则该字段无效</p>
</li>
<li>
<p>portName: 检测端口名字(替换 marathon 协议中的 portIndex)</p>
<ul>
<li>
<p>portName 在 port 配置大于 0 的情况下,该字段无效</p>
</li>
<li>
<p>portName 在 port 配置不大于 0 的情况下,检测的端口通过 portName 从 ports 配置中获取（scheduler 处理）</p>
</li>
<li>
<p>根据 portName 获取端口的时候,需要根据不同的网络模型获取不同的端口，目前规则(和 exportservice 保持一致)如下：</p>
</li>
<li>
<p>BRIDGE 模式下如果 HostPort 大于零则为 HostPort,否则为 ContainerPort</p>
</li>
<li>
<p>其他模式为 ContainerPort</p>
</li>
</ul>
</li>
<li>
<p>scheme： http 和 https(https 不会做认证的处理)</p>
</li>
<li>
<p>path：请求路径</p>
</li>
<li>
<p>headers: http 消息头，为了支持 health check 时，需要认证的方式，例如：Host: www.xxxx.com。NOTE:目前只支持 REMOTE_HTTP。</p>
</li>
<li>
<p>检测方式:</p>
<ul>
<li>
<p>Sends a GET request to scheme://<host>:port/path.</p>
</li>
<li>
<p>Note that host is not configurable and is resolved automatically, in most cases to 127.0.0.1.</p>
</li>
<li>
<p>Default executors treat return codes between 200 and 399 as success; custom executors may employ a different strategy, e.g. leveraging the <code>statuses</code> field.</p>
</li>
<li>
<p>bcs executor 需要根据网络模式等情况再具体确认规则</p>
</li>
</ul>
</li>
<li>
<p>tcp： type 为 TCP 和 REMOTE_TCP 的情况下有效：</p>
</li>
<li>
<p>port: 检测的端口,如果配置为 0,则该字段无效</p>
</li>
<li>
<p>portName: 检测端口名字(替换 marathon 协议中的 portIndex)</p>
<ul>
<li>
<p>protName 在 port 配置大于 0 的情况下,该字段无效</p>
</li>
<li>
<p>portName 在 port 配置不大于 0 的情况下,检测的端口通过 portName 从 ports 配置中获取（scheduler 处理）</p>
</li>
<li>
<p>根据 portName 获取端口的时候,需要根据不同的网络模型获取不同的端口，目前规则(和 exportservice 保持一致)如下：</p>
</li>
<li>
<p>BRIDGE 模式下如果 HostPort 大于零则为 HostPort,否则为 ContainerPort</p>
</li>
<li>
<p>其他模式为 ContainerPort</p>
</li>
</ul>
</li>
<li>
<p>检测方式： tcp 连接成功即表示健康，需根据不同网络模型获取不同的地址</p>
</li>
</ul><h1 id="configmap">ConfigMap 数据定义</h1>
<h2 id="1">1. 配置模板说明</h2>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;apiVersion&quot;</span><span class="p">:</span><span class="s2">&quot;v4&quot;</span><span class="p">,</span>
    <span class="nt">&quot;kind&quot;</span><span class="p">:</span><span class="s2">&quot;configmap&quot;</span><span class="p">,</span>
    <span class="nt">&quot;metadata&quot;</span><span class="p">:{</span>
        <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;template-configmap&quot;</span><span class="p">,</span>
        <span class="nt">&quot;namespace&quot;</span><span class="p">:</span><span class="s2">&quot;defaultGroup&quot;</span><span class="p">,</span>
        <span class="nt">&quot;labels&quot;</span><span class="p">:{</span>
            <span class="nt">&quot;io.tencent.bcs.app.appid&quot;</span><span class="p">:</span> <span class="s2">&quot;756&quot;</span><span class="p">,</span>
            <span class="nt">&quot;io.tencent.bcs.cluster&quot;</span><span class="p">:</span> <span class="s2">&quot;SET-SH-16111614092707&quot;</span><span class="p">,</span>
            <span class="nt">&quot;io.tencent.bcs.app.moduleid&quot;</span><span class="p">:</span> <span class="s2">&quot;5088&quot;</span><span class="p">,</span>
            <span class="nt">&quot;io.tencent.bcs.app.setid&quot;</span><span class="p">:</span> <span class="s2">&quot;1767&quot;</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&quot;datas&quot;</span><span class="p">:{</span>
        <span class="nt">&quot;bcs.conf&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;file&quot;</span><span class="p">,</span>
            <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;Y29uZmlnIGNvbnRleHQ=&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;config-one&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;http&quot;</span><span class="p">,</span>
            <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;http://adfasdasdasdfasdfad/a.txt&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;myftp&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ftp&quot;</span><span class="p">,</span>
            <span class="nt">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;ftp://path/to/a.txt&quot;</span><span class="p">,</span>
            <span class="nt">&quot;RemoteUser&quot;</span><span class="p">:</span> <span class="s2">&quot;myuyser&quot;</span><span class="p">,</span>
            <span class="nt">&quot;remotePasswd&quot;</span><span class="p">:</span> <span class="s2">&quot;nIGNvbnRleHQ=&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<ul>
<li>RemoteUser  //存储该文件第三方存储的用户名，如果请求需要认证</li>
<li>remotePasswd   //密码</li>
</ul>
<p><strong>bcs application</strong>数据结构</p>
<div class="codehilite"><pre><span></span><span class="s2">&quot;configmaps&quot;</span><span class="err">:</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;template-configmap&quot;</span><span class="p">,</span>
        <span class="nt">&quot;items&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;env&quot;</span><span class="p">,</span>
                <span class="nt">&quot;dataKey&quot;</span><span class="p">:</span> <span class="s2">&quot;config-one&quot;</span><span class="p">,</span>
                <span class="nt">&quot;KeyOrPath&quot;</span><span class="p">:</span> <span class="s2">&quot;SECRET_ENV&quot;</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;file&quot;</span><span class="p">,</span>
                <span class="nt">&quot;dataKey&quot;</span><span class="p">:</span> <span class="s2">&quot;config_two&quot;</span><span class="p">,</span>
                <span class="nt">&quot;dataKeyAlias&quot;</span><span class="p">:</span> <span class="s2">&quot;config-two&quot;</span><span class="p">,</span>
                <span class="nt">&quot;KeyOrPath&quot;</span><span class="p">:</span> <span class="s2">&quot;/data/contianer/path/myfile.conf&quot;</span><span class="p">,</span>
                <span class="nt">&quot;readOnly&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
                <span class="nt">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;root&quot;</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">]</span>
</pre></div>


<p>字段含义：(field comment)</p>
<ul>
<li>name：索引 configmap 名字 （index configmap name）</li>
<li>type：</li>
<li>env：将 configmap 子项注入环境变量</li>
<li>file：将 configmap 注入文件</li>
<li>dataKey：索引 configmap 中子项（subitem index in index configmap）</li>
<li>KeyOrPath：在容器中绝对路径（absolute directory in container）</li>
<li>readOnly：权限（permission, true or false）</li>
<li>user：文件用户，默认 root，如果用户在系统中找不到，默认 root （file user, default value is root. default is root if user is not exist in OS）</li>
</ul><h1 id="bcs-deployment">BCS Deployment 说明</h1>
<h2 id="1-bcs-deployment">1. bcs-deployment 简介</h2>
<p>bcs-deployment 是基于 bcs-application 抽象出的顶层概念、主要满足应用的滚动升级，回滚，暂停，扩、缩容等需求。</p>
<p><code>注: 不支持deployment关联已经存在的application</code></p>
<h2 id="2">2. 配置模板说明</h2>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;apiVersion&quot;</span><span class="p">:</span> <span class="s2">&quot;v4&quot;</span><span class="p">,</span>
    <span class="nt">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;deployment&quot;</span><span class="p">,</span>
    <span class="nt">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;labels&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;label_deployment&quot;</span><span class="p">:</span> <span class="s2">&quot;label_deployment&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;deployment-test-001&quot;</span><span class="p">,</span>
        <span class="nt">&quot;namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;defaultGroup&quot;</span>
    <span class="p">},</span>
    <span class="nt">&quot;restartPolicy&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;policy&quot;</span><span class="p">:</span> <span class="s2">&quot;Always&quot;</span><span class="p">,</span>
        <span class="nt">&quot;interval&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
        <span class="nt">&quot;backoff&quot;</span><span class="p">:</span> <span class="mi">10</span>
    <span class="p">},</span>
     <span class="nt">&quot;killPolicy&quot;</span><span class="p">:{</span>
        <span class="nt">&quot;gracePeriod&quot;</span><span class="p">:</span> <span class="mi">10</span>
    <span class="p">},</span>
    <span class="nt">&quot;constraint&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;IntersectionItem&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="nt">&quot;UnionData&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;hostname&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;operate&quot;</span><span class="p">:</span> <span class="s2">&quot;CLUSTER&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
                        <span class="nt">&quot;set&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="nt">&quot;item&quot;</span><span class="p">:</span> <span class="p">[</span>
                                <span class="s2">&quot;mesos-slave-1&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;mesos-slave-2&quot;</span>
                            <span class="p">]</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">},</span>
    <span class="nt">&quot;spec&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;instance&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="nt">&quot;selector&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;podname&quot;</span><span class="p">:</span> <span class="s2">&quot;app-test-001&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;strategy&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;RollingUpdate&quot;</span><span class="p">,</span>
            <span class="nt">&quot;rollingupdate&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;maxUnavilable&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="nt">&quot;maxSurge&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="nt">&quot;upgradeDuration&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
                <span class="nt">&quot;rollingOrder&quot;</span><span class="p">:</span> <span class="s2">&quot;CreateFirst&quot;</span><span class="p">,</span>
                <span class="nt">&quot;rollingManually&quot;</span><span class="p">:</span> <span class="kc">false</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="nt">&quot;template&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;labels&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;label_deployment&quot;</span><span class="p">:</span> <span class="s2">&quot;label_deployment&quot;</span>
                <span class="p">},</span>
                <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;deployment-test-001&quot;</span><span class="p">,</span>
                <span class="nt">&quot;namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;defaultGroup&quot;</span>
            <span class="p">},</span>
            <span class="nt">&quot;spec&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;containers&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="nt">&quot;command&quot;</span><span class="p">:</span> <span class="s2">&quot;python&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;args&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="s2">&quot;-m&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;SimpleHTTPServer&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;8888&quot;</span>
                        <span class="p">],</span>
                        <span class="nt">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">[],</span>
                        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;MESOS&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;env&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="p">{</span>
                                <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;DNS_HOSTS&quot;</span><span class="p">,</span>
                                <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;test_env&quot;</span>
                            <span class="p">}</span>
                        <span class="p">],</span>
                        <span class="nt">&quot;image&quot;</span><span class="p">:</span> <span class="s2">&quot;hub_address.com/bcs/&lt;IMAGE_NAME&gt;&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;imagePullUser&quot;</span><span class="p">:</span> <span class="s2">&quot;xxx&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;imagePullPasswd&quot;</span><span class="p">:</span> <span class="s2">&quot;xxx&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;imagePullPolicy&quot;</span><span class="p">:</span> <span class="s2">&quot;Always&quot;</span><span class="p">,</span>
                        <span class="nt">&quot;privileged&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
                        <span class="nt">&quot;ports&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="p">{</span>
                                <span class="nt">&quot;containerPort&quot;</span><span class="p">:</span> <span class="mi">8899</span><span class="p">,</span>
                                <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;test-port&quot;</span><span class="p">,</span>
                                <span class="nt">&quot;protocol&quot;</span><span class="p">:</span> <span class="s2">&quot;HTTP&quot;</span>
                            <span class="p">}</span>
                        <span class="p">],</span>
                        <span class="nt">&quot;healthChecks&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="p">{</span>
                                <span class="nt">&quot;protocol&quot;</span><span class="p">:</span> <span class="s2">&quot;tcp&quot;</span><span class="p">,</span>
                                <span class="nt">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/http/path/only&quot;</span><span class="p">,</span>
                                <span class="nt">&quot;delaySeconds&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                                <span class="nt">&quot;gracePeriodSeconds&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">,</span>
                                <span class="nt">&quot;intervalSeconds&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                                <span class="nt">&quot;timeoutSeconds&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                                <span class="nt">&quot;consecutiveFailures&quot;</span><span class="p">:</span> <span class="mi">10</span>
                            <span class="p">}</span>
                        <span class="p">],</span>
                        <span class="nt">&quot;resources&quot;</span><span class="p">:</span> <span class="p">{</span>
                            <span class="nt">&quot;limits&quot;</span><span class="p">:</span> <span class="p">{</span>
                                <span class="nt">&quot;cpu&quot;</span><span class="p">:</span> <span class="s2">&quot;0.5&quot;</span><span class="p">,</span>
                                <span class="nt">&quot;memory&quot;</span><span class="p">:</span> <span class="s2">&quot;8&quot;</span>
                            <span class="p">}</span>
                        <span class="p">},</span>
                        <span class="nt">&quot;volumes&quot;</span><span class="p">:</span> <span class="p">[],</span>
                        <span class="nt">&quot;secrets&quot;</span><span class="p">:</span> <span class="p">[],</span>
                        <span class="nt">&quot;configmaps&quot;</span><span class="p">:</span> <span class="p">[]</span>
                    <span class="p">}</span>
                <span class="p">],</span>
                <span class="nt">&quot;networkMode&quot;</span><span class="p">:</span> <span class="s2">&quot;BRIDGE&quot;</span><span class="p">,</span>
                <span class="nt">&quot;networktype&quot;</span><span class="p">:</span> <span class="s2">&quot;cnm&quot;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<ul>
<li>基础信息简介
由于 bcs-deployment 是基于 bcs-application 构建，其中的大部分信息与 bcs-application 一致，包含以下内容：<ul>
<li>restartPolicy</li>
<li>killPolicy</li>
<li>constraint</li>
<li>spec.template 中所有字段信息</li>
</ul>
</li>
</ul>
<p>关于这部分字段与结构的详细信息请见。</p>
<p><code>下面介绍一下关于bcs-deployment本身特性的相关策略。</code></p>
<div class="codehilite"><pre><span></span>    <span class="s2">&quot;spec&quot;</span><span class="err">:</span> <span class="p">{</span>
       <span class="nt">&quot;instance&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
       <span class="nt">&quot;selector&quot;</span><span class="p">:</span> <span class="p">{</span>
           <span class="nt">&quot;podname&quot;</span><span class="p">:</span> <span class="s2">&quot;app-test-001&quot;</span>
       <span class="p">},</span>
       <span class="nt">&quot;strategy&quot;</span><span class="p">:</span> <span class="p">{</span>
           <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;RollingUpdate&quot;</span><span class="p">,</span>
           <span class="nt">&quot;rollingupdate&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="nt">&quot;maxUnavilable&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="nt">&quot;maxSurge&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="nt">&quot;upgradeDuration&quot;</span><span class="p">:</span> <span class="mi">60</span><span class="p">,</span>
                <span class="nt">&quot;rollingOrder&quot;</span><span class="p">:</span> <span class="s2">&quot;CreateFirst&quot;</span><span class="p">,</span>
                 <span class="nt">&quot;rollingManually&quot;</span><span class="p">:</span><span class="kc">false</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></div>


<ul>
<li>
<p>实例数
相关参数为 spec.instance(第 2 行)，用于配置要创建的 taskgroup 的数量。该 taskgroup 是由 deployment 创建的一个 application 来管理。</p>
</li>
<li>
<p>application 选择器
相关参数为 spec.selector（第 3 行），用于配置 deployment 所需要管理的 bcs-appliction,默认这些 bcs-application 是由 bcs-deployment 自动创建的。</p>
</li>
</ul>
<h2 id="3-deployment">3. deployment 升级策略</h2>
<p>相关配置项为 spec.strategy（第 6-15 行），用于配置 deployment 执行 rolling 操作时所需要的策略：
- type: 定义 deployment 进行 rolling 时要选择的策略，目前只支持 RollingUpdate：
  - <code>RollingUpdate</code>:<br />
    RollingUpdate 即为滚动升级，该策略允许我们对滚动操作的过程中每次新创建的容器数量，删除的容器数量，创建间隔等策略进行控制。当原有的 taskgroup 全部删除，新的 taskgroup（个数通过 instances 参数定义）全部创建，则 update 结束。</p>
<ul>
<li>RollingUpdate
可以对 Rolling 的操作进行详细的配置，包含以下参数：</li>
<li><code>maxUnavilable</code>:<br />
  决定了每个 rolling 周期内可以<code>删除</code>的 taskgroup 数量。如果原有的 taskgroup 已经全部删除，则后续每一次 rolling 中不会再删除 taskgroup。</li>
<li><code>maxSurge</code>:<br />
  决定了每个 rolling 周期内可以<code>创建</code>的 taskgroup 数量。如果新的 taskgroup 已经全部创建，则后续每一次 rolling 中不会再创建 taskgroup。</li>
<li><code>upgradeDuration</code>:<br />
  配置每次 rolling 操作之间的<code>最小</code>间隔时间。</li>
<li><code>rollingOrder</code>:
  配置在进行每次 rolling 操作期间的每个周期内，创建和删除应用的先后顺序。该配置支持两种模式<code>CreateFirst</code>, <code>DeleteFirst</code>。 <strong>CreateFirst</strong>策略会先创建新的应用，然后删除老的应用。而<strong>DeleteFirst</strong>策略会先删除老的应用，再创建新的应用。</li>
<li><code>rollingManually</code>:
  配置每次滚动是否需要手动触发，默认为 false，即一次滚动完成之后在时间间隔结束之后自动进行下一次滚动，如果配置为 true，则在每次滚动后自动 pause，需输入 resume 命令才会在时间间隔结束之后进行下一次滚动</li>
</ul>
<h2 id="4-rolling-update">4. rolling update 的策略示例</h2>
<p>我们假设 rolling 前 deployment 的 instances 为 oldInstances, rolling 的 deployment instances 为 newInstances。可以预见在 rolling 过程中会有以下三种场景：
- oldInstances &lt; newInstances
对 application 进行一次 rolling update，并且达到扩容的效果
- oldInstances = newInstances<br />
对 application 进行一次 rolling update，容器数量保持不变
- oldInstances &gt; newInstances<br />
对 application 进行一次 rolling update，并且达到缩容的效果</p>
<h2 id="5-deployment">5. 支持的 deployment 操作</h2>
<ul>
<li>create
创建一个 deployment：如果已有绑定的 application，则 delete 当前 application 并创建新的 application；如果不存在绑定的 application，则创建 application。也可以创建一个空的 deployment 绑定到当前已有的 application。</li>
<li>udpate
对 deployment 进行 rolling update： 通过 instances 的变化，可以同时到达扩容和缩容的效果。</li>
<li>rollback
停止当前的 update 操作，将新创建的 application 和 taskgroup 删除，将原有的 application 的 taskgroup 恢复到原有的 instances 个数</li>
<li>pause
暂停 rolling update： rolling update 过程中可以通过该命令暂停 update。</li>
<li>resume
继续 rolling update： 可以将暂停的 update 继续。</li>
<li>delete
删除 deployment，以及相应的 application</li>
</ul><h1 id="bcs-ingress">bcs Ingress 配置说明</h1>
<p>bcs ingress 基于 bcs-service 抽象出将流量导入 bcs 集群的基本规则，满足应用多场景下的负载均衡需求。</p>
<h2 id="1">1. 配置模板说明</h2>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;apiVersion&quot;</span><span class="p">:</span> <span class="s2">&quot;v1&quot;</span><span class="p">,</span>
    <span class="nt">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;ingress&quot;</span><span class="p">,</span>
    <span class="nt">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ingress-demo&quot;</span><span class="p">,</span>
        <span class="nt">&quot;namespace&quot;</span><span class="p">:</span> <span class="s2">&quot;default&quot;</span><span class="p">,</span>
        <span class="nt">&quot;labels&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;ingressname&quot;</span><span class="p">:</span> <span class="s2">&quot;ingress-demo&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;annotation&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;annotation-demo&quot;</span><span class="p">:</span> <span class="s2">&quot;annotation-value&quot;</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&quot;spec&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;lbGroup&quot;</span><span class="p">:</span> <span class="s2">&quot;external&quot;</span><span class="p">,</span>
        <span class="nt">&quot;clusterid&quot;</span><span class="p">:</span> <span class="s2">&quot;sz-loldemo-0000123&quot;</span><span class="p">,</span>
        <span class="nt">&quot;rules&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="nt">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;HTTP&quot;</span><span class="p">,</span>
                <span class="nt">&quot;balance&quot;</span><span class="p">:</span> <span class="s2">&quot;roundrobin&quot;</span><span class="p">,</span>
                <span class="nt">&quot;httpIngress&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;host&quot;</span><span class="p">:</span> <span class="s2">&quot;demo.bcs.com&quot;</span><span class="p">,</span>
                    <span class="nt">&quot;paths&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="nt">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/read/demo&quot;</span><span class="p">,</span>
                            <span class="nt">&quot;backend&quot;</span><span class="p">:</span> <span class="p">[</span>
                                <span class="p">{</span>
                                    <span class="nt">&quot;serviceName&quot;</span><span class="p">:</span> <span class="s2">&quot;service-1&quot;</span><span class="p">,</span>
                                    <span class="nt">&quot;servicePort&quot;</span><span class="p">:</span> <span class="s2">&quot;8801&quot;</span><span class="p">,</span>
                                    <span class="nt">&quot;weight&quot;</span><span class="p">:</span> <span class="mi">70</span>
                                <span class="p">},</span>
                                <span class="p">{</span>
                                    <span class="nt">&quot;serviceName&quot;</span><span class="p">:</span> <span class="s2">&quot;service-2&quot;</span><span class="p">,</span>
                                    <span class="nt">&quot;servicePort&quot;</span><span class="p">:</span> <span class="s2">&quot;8802&quot;</span><span class="p">,</span>
                                    <span class="nt">&quot;weight&quot;</span><span class="p">:</span> <span class="mi">30</span>
                                <span class="p">}</span>
                            <span class="p">]</span>
                        <span class="p">}</span>
                    <span class="p">]</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="nt">&quot;kind&quot;</span><span class="p">:</span> <span class="s2">&quot;TCP&quot;</span><span class="p">,</span>
                <span class="nt">&quot;balance&quot;</span><span class="p">:</span> <span class="s2">&quot;roundrobin&quot;</span><span class="p">,</span>
                <span class="nt">&quot;tcpIngress&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="nt">&quot;listenPort&quot;</span><span class="p">:</span> <span class="mi">8083</span><span class="p">,</span>
                    <span class="nt">&quot;backend&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="nt">&quot;serviceName&quot;</span><span class="p">:</span> <span class="s2">&quot;service-3&quot;</span><span class="p">,</span>
                            <span class="nt">&quot;servicePort&quot;</span><span class="p">:</span> <span class="s2">&quot;8803&quot;</span><span class="p">,</span>
                            <span class="nt">&quot;weight&quot;</span><span class="p">:</span> <span class="mi">70</span>
                        <span class="p">},</span>
                        <span class="p">{</span>
                            <span class="nt">&quot;serviceName&quot;</span><span class="p">:</span> <span class="s2">&quot;service-4&quot;</span><span class="p">,</span>
                            <span class="nt">&quot;servicePort&quot;</span><span class="p">:</span> <span class="s2">&quot;8804&quot;</span><span class="p">,</span>
                            <span class="nt">&quot;weight&quot;</span><span class="p">:</span> <span class="mi">30</span>
                        <span class="p">}</span>
                    <span class="p">]</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<ul>
<li>基本信息</li>
<li>apiVersion: 版本</li>
<li>kind：ingress</li>
<li>metadata:</li>
<li>name: ingress name</li>
<li>namespace: ingress 所属的 namespace</li>
<li>labels: ingress 所需要的 label 信息。</li>
<li>annotaion: ingress 所需要的相关标注信息。</li>
</ul>
<h2 id="2-ingress-spec">2. Ingress Spec 信息</h2>
<h3 id="21-lbgroup">2.1 <code>lbGroup</code></h3>
<p>标识该 ingress 所属的 lb 管理节点。该名称需要和 lb 的名称相对应。否则无法正常工作。</p>
<h3 id="22-clusterid">2.2 <code>clusterid</code></h3>
<p>标识该 ingress 所属的 cluster。</p>
<h3 id="23-rules">2.3 <code>rules</code></h3>
<p>rules 明确的指出该 ingress 所需要负载均衡的<code>一组</code>相关信息，具体如下:
 - kind:<br />
   支持<code>TCP</code>和<code>HTTP</code>两种类型, 使用 HTTP 则需要配置<code>httpIngress</code>，使用<code>TCP</code>则需要配置<code>tcpIngress</code>。
 - balance:<br />
   配置负载均衡的策略，支持"roundrobin"与"source"。
 - httpIngress：
   - host:<br />
     需要负载均衡的域名。
   - paths:<br />
     该域名下具体的 uri 分配规则
     - path:<br />
       指定具体的 path
     - backend:<br />
       配置后端具体负载的实例，以 service 为逻辑单位（"serviceName"），同时可以指定多个 service 之间的流量比例（"weight"）</p>
<ul>
<li>tcpIngress:</li>
<li>listenPort:<br />
     lb 监听的服务端口。</li>
<li>backend:<br />
     配置后端具体负载的实例，以 service 为逻辑单位（"serviceName"），同时可以指定多个 service 之间的流量比例（"weight"）</li>
</ul>
<blockquote>
<p><strong><code>注意</code></strong>
1. 目前 k8s 只支持 HTTP 的路由策略，TCP 的暂不支持。
2. 对于<code>httpIngress</code>中的<code>paths</code>，现预留为数组，目前仅支持一个，如果配置多个，数组中的第<code>0</code>个元素生效，其它的不会生效。</p>
</blockquote><h1 id="secret">Secret 数据定义</h1>
<h2 id="1">1. 数据结构说明</h2>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;apiVersion&quot;</span><span class="p">:</span><span class="s2">&quot;v4&quot;</span><span class="p">,</span>
    <span class="nt">&quot;kind&quot;</span><span class="p">:</span><span class="s2">&quot;secret&quot;</span><span class="p">,</span>
    <span class="nt">&quot;metadata&quot;</span><span class="p">:{</span>
        <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;template-secret&quot;</span><span class="p">,</span>
        <span class="nt">&quot;namespace&quot;</span><span class="p">:</span><span class="s2">&quot;defaultGroup&quot;</span><span class="p">,</span>
        <span class="nt">&quot;labels&quot;</span><span class="p">:{</span>
            <span class="nt">&quot;io.tencent.bcs.app.appid&quot;</span><span class="p">:</span> <span class="s2">&quot;756&quot;</span><span class="p">,</span>
            <span class="nt">&quot;io.tencent.bcs.cluster&quot;</span><span class="p">:</span> <span class="s2">&quot;SET-SH-16111614092707&quot;</span><span class="p">,</span>
            <span class="nt">&quot;io.tencent.bcs.app.moduleid&quot;</span><span class="p">:</span> <span class="s2">&quot;5088&quot;</span><span class="p">,</span>
            <span class="nt">&quot;io.tencent.bcs.app.setid&quot;</span><span class="p">:</span> <span class="s2">&quot;1767&quot;</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="nt">&quot;datas&quot;</span><span class="p">:{</span>
        <span class="nt">&quot;first-secret&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/path/to/store/in/vault&quot;</span><span class="p">,</span>
            <span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="s2">&quot;Y29uZmlnIGNvbnRleHQ=&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;second-secret&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/path/to/store/in/vault&quot;</span><span class="p">,</span>
            <span class="nt">&quot;content&quot;</span><span class="p">:</span><span class="s2">&quot;Y29uZmlnIGNvbnRleHQ=&quot;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>字段含义：</p>
<ul>
<li>name：具体 secret 名字</li>
<li>content：secret 内容</li>
</ul>
<p><strong>bcs application</strong>数据结构</p>
<div class="codehilite"><pre><span></span><span class="s2">&quot;secrets&quot;</span><span class="err">:</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="nt">&quot;secretName&quot;</span><span class="p">:</span> <span class="s2">&quot;mySecret&quot;</span><span class="p">,</span>
        <span class="nt">&quot;items&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;env&quot;</span><span class="p">,</span>
                <span class="nt">&quot;dataKey&quot;</span><span class="p">:</span> <span class="s2">&quot;abc&quot;</span><span class="p">,</span>
                <span class="nt">&quot;keyOrPath&quot;</span><span class="p">:</span> <span class="s2">&quot;SRECT_ENV&quot;</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;file&quot;</span><span class="p">,</span>
                <span class="nt">&quot;dataKey&quot;</span><span class="p">:</span> <span class="s2">&quot;abc&quot;</span><span class="p">,</span>
                <span class="nt">&quot;keyOrPath&quot;</span><span class="p">:</span> <span class="s2">&quot;/data/container/path/myfile.conf&quot;</span><span class="p">,</span>
                <span class="nt">&quot;readOnly&quot;</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
                <span class="nt">&quot;user&quot;</span><span class="p">:</span> <span class="s2">&quot;user00&quot;</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">]</span>
</pre></div>


<h2 id="2">2. 工作机制和流程</h2>
<p>数据<strong>流转流程</strong></p>
<ul>
<li>bcs-client create --type secret --name template-secret --clusterid saldfkaslkdfj</li>
<li>--path vault 存储 path，必填</li>
<li>--file key:/path/to/file.conf 指定文件，文件大小不能超过 100k</li>
<li>--from-files dir 指定文件夹，根据文件名做 key，总大小不能超过 2M</li>
<li>--content key:content 直接指定具体内容</li>
<li>bcs-apiserver（正常存入 vault？）</li>
<li>DELETE: 根据规则删除 secret</li>
<li>POST：存储 vault 中</li>
<li>GET: 查询 secret 信息</li>
<li>bcs-route 流程</li>
<li>查询 secret 信息，并入 taskgroup 请求，转发给 scheduler</li>
</ul>
<p><strong>相关调整</strong>工作</p>
<ul>
<li>apiserver 增加 secret 接口</li>
<li>post</li>
<li>get</li>
<li>delete</li>
<li>bcs-route 数据解析</li>
<li>捕获 secret 字段，提取 secret 具体内容</li>
<li>转发给 bcs-scheduler</li>
<li>bcs-client 增加 secret 子命令，参数如下</li>
<li>--path vault 存储 path，必填</li>
<li>--file key:/path/to/file.conf 指定文件，文件大小不能超过 100k</li>
<li>--from-files dir 指定文件夹，根据文件名做 key，总大小不能超过 2M</li>
<li>--content key:content 直接指定具体内容</li>
</ul><h1 id="mesos-service">Mesos Service 定义</h1>
<h2 id="1-service">1. Service 数据结构说明</h2>
<p>service 主要用<strong>服务发现</strong>，<strong>DNS 基础数据</strong>，<strong>loadbalance 服务导出</strong>。</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;apiVersion&quot;</span><span class="p">:</span><span class="s2">&quot;v4&quot;</span><span class="p">,</span>
    <span class="nt">&quot;kind&quot;</span><span class="p">:</span><span class="s2">&quot;service&quot;</span><span class="p">,</span>
    <span class="nt">&quot;metadata&quot;</span><span class="p">:{</span>
        <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;template-service&quot;</span><span class="p">,</span>
        <span class="nt">&quot;namespace&quot;</span><span class="p">:</span><span class="s2">&quot;defaultGroup&quot;</span><span class="p">,</span>
        <span class="nt">&quot;labels&quot;</span><span class="p">:{</span>
            <span class="nt">&quot;BCSGROUP&quot;</span><span class="p">:</span> <span class="s2">&quot;external&quot;</span><span class="p">,</span>
            <span class="nt">&quot;BCSBALANCE&quot;</span><span class="p">:</span> <span class="s2">&quot;source|roundrobin|leastconn&quot;</span><span class="p">,</span>
            <span class="nt">&quot;BCS-WEIGHT-lol-summoner&quot;</span><span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span>
            <span class="nt">&quot;BCS-WEIGHT-new-lol-summoner&quot;</span><span class="p">:</span> <span class="s2">&quot;7&quot;</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&quot;spec&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;selector&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&quot;label-one&quot;</span><span class="p">:</span> <span class="s2">&quot;lol-summoner&quot;</span><span class="p">,</span>
            <span class="nt">&quot;label-two&quot;</span><span class="p">:</span> <span class="s2">&quot;new-lol-summoner&quot;</span>
        <span class="p">},</span>
        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;ClusterIP|NodePort|None|Integration&quot;</span><span class="p">,</span>
        <span class="nt">&quot;clusterIP&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;1.1.1.1&quot;</span><span class="p">,</span> <span class="s2">&quot;1.1.1.2&quot;</span><span class="p">],</span>
        <span class="nt">&quot;ports&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;http_8080&quot;</span><span class="p">,</span>
                <span class="nt">&quot;domainName&quot;</span><span class="p">:</span> <span class="s2">&quot;demo.bcs.com&quot;</span><span class="p">,</span>
                <span class="nt">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/local/path&quot;</span><span class="p">,</span>
                <span class="nt">&quot;protocol&quot;</span><span class="p">:</span> <span class="s2">&quot;http&quot;</span><span class="p">,</span>
                <span class="nt">&quot;servicePort&quot;</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span>
                <span class="nt">&quot;targetPort&quot;</span><span class="p">:</span> <span class="mi">8080</span><span class="p">,</span>
                <span class="nt">&quot;nodePort&quot;</span><span class="p">:</span> <span class="mi">31000</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;tcp-28800&quot;</span><span class="p">,</span>
                <span class="nt">&quot;domainName&quot;</span><span class="p">:</span> <span class="s2">&quot;demo.bcs.com&quot;</span><span class="p">,</span>
                <span class="nt">&quot;path&quot;</span><span class="p">:</span> <span class="s2">&quot;/local/path&quot;</span><span class="p">,</span>
                <span class="nt">&quot;protocol&quot;</span><span class="p">:</span> <span class="s2">&quot;tcp&quot;</span><span class="p">,</span>
                <span class="nt">&quot;servicePort&quot;</span><span class="p">:</span> <span class="mi">28800</span><span class="p">,</span>
                <span class="nt">&quot;targetPort&quot;</span><span class="p">:</span> <span class="mi">8080</span><span class="p">,</span>
                <span class="nt">&quot;nodePort&quot;</span><span class="p">:</span> <span class="mi">31001</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h2 id="2-endpoints">2. endpoints</h2>
<p>如果存在 endpoints，DNS 直接 watch 并直接关联 DNS 解析记录。
如果没有，自行关联 service 和 taskgroup 信息，解析 status 信息提取 IP。</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;apiVersion&quot;</span><span class="p">:</span><span class="s2">&quot;v1&quot;</span><span class="p">,</span>
    <span class="nt">&quot;kind&quot;</span><span class="p">:</span><span class="s2">&quot;endpoint&quot;</span><span class="p">,</span>
    <span class="nt">&quot;metadata&quot;</span><span class="p">:{</span>
        <span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="s2">&quot;template-endpoint&quot;</span><span class="p">,</span>
        <span class="nt">&quot;namespace&quot;</span><span class="p">:</span><span class="s2">&quot;defaultGroup&quot;</span><span class="p">,</span>
        <span class="nt">&quot;label&quot;</span><span class="p">:{</span>
            <span class="nt">&quot;io.tencent.bcs.app.appid&quot;</span><span class="p">:</span> <span class="s2">&quot;756&quot;</span><span class="p">,</span>
            <span class="nt">&quot;io.tencent.bcs.cluster&quot;</span><span class="p">:</span> <span class="s2">&quot;SET-SH-16111614092707&quot;</span><span class="p">,</span>
            <span class="nt">&quot;io.tencent.bcs.app.moduleid&quot;</span><span class="p">:</span> <span class="s2">&quot;5088&quot;</span><span class="p">,</span>
            <span class="nt">&quot;io.tencent.bcs.app.setid&quot;</span><span class="p">:</span> <span class="s2">&quot;1767&quot;</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="nt">&quot;eps&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="nt">&quot;nodeIP&quot;</span><span class="p">:</span> <span class="s2">&quot;10.1.1.1&quot;</span><span class="p">,</span>
            <span class="nt">&quot;containerIP&quot;</span><span class="p">:</span> <span class="s2">&quot;192.168.1.2&quot;</span>
        <span class="p">},{</span>
            <span class="nt">&quot;nodeIP&quot;</span><span class="p">:</span> <span class="s2">&quot;10.1.1.2&quot;</span><span class="p">,</span>
            <span class="nt">&quot;containerIP&quot;</span><span class="p">:</span> <span class="s2">&quot;192.168.1.1&quot;</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>


<h2 id="3">3. 特别字段说明</h2>
<p><strong>clusterIP</strong>：考虑未来需要做外部域名访问和服务发现，clusterIP 暂留用于指向 proxyIP 信息</p>
<p><strong>ports</strong>[x]说明：</p>
<ul>
<li>name：该 name 需要和 taskgroup 中 ports 字段中的 name 一致</li>
<li>domainName：http 协议的状态下，需要填写域名信息，做转发用途</li>
<li>servicePort：主要用于负载均衡和服务导出端口</li>
<li>targetPort：用于指向 taskgroup 中 ports 字段中目标端口，默认目标端口为 containerPort，如果有 hostPort，则指向 hostPort</li>
</ul>
<p><strong>BCSGROUP</strong>: 用于 service 导出标识
<strong>BCSBALANCE</strong>：用于服务导出负载均衡算法，默认值为 roundrobin
<strong>BCS-WEIGHT-</strong>: 当使用 selector 匹配多个 application 时，用于表达多个 application 之间的权重，该值为大于等于 0 的整数，类型为 string。如果等于 0，则该 application 没有流量导入。</p>
<h2 id="4-bcs-loadbalance">4. <strong>bcs-loadbalance 功能使用</strong></h2>
<p>如果要启动 loadbalance 的功能，需要：</p>
<ul>
<li>label 中增加特殊字段<strong>"BCSGROUP":"external"</strong>：external 代表 bcs-loadbalance 模块的集群 ID，默认值 external</li>
<li>label 中增加特殊字段<strong>"BCSBALANCE":"roundrobin"</strong>：负载均衡算法，默认值为 roundrobin，其他值为 source（ip_hash），leastconn</li>
<li>application 有定义 ports 信息，并和 service 对应</li>
</ul>
<p>ports 信息在 loadbalance 中的含义说明：</p>
<ul>
<li>protocol：http 或者 tcp，当前不支持 udp</li>
<li>name：名字为 application 中定义 port 的名字，必须要对应</li>
<li>domainName：协议为 http 时有效</li>
<li>servicePort：如果协议是 http，该值被忽略，loadbalance 默认使用 80 端口；如果是 tcp，loadbalance 则监听该指定端口，各 service 之间该端口不能冲突</li>
</ul>
<p>bcs-loadbalance 可以工作两种环境下：</p>
<ul>
<li>overlay 方式，默认使用 servicePort 作为服务端口，流量转发至 containerPort</li>
<li>underlay 方式，使用 servicePort 作为服务端口，流量转发至 hostPort（限于 host/bridge 模式）</li>
</ul>
<h2 id="5-taskgroup">5. taskgroup 服务端口机制</h2>
<p>服务端口数据来源于镜像字段 ports，主要包含：</p>
<ul>
<li>containerPort：容器中使用端口</li>
<li>servicePort：多实例状态使用的服务端口，用于服务导出和负载均衡使用</li>
<li>hostPort：从容器映射到主机的端口</li>
<li>hostIP：预留字段，当物理主机包含多个网卡时，默认是所有网卡都映射。如果 0.0.0.0 监听存在风险，可以监听内网</li>
<li>protocol：协议，tcp/udp，http（默认转换为 tcp 处理，仅对 datawatch/loadbalance 生效）</li>
<li>name：域名信息，http 时必须为域名，必须唯一</li>
<li>path: 路由转发，用于转发到后端对应的 endpoint</li>
</ul>
<p>填写端口信息，至少需要填写 name、protocol、containerPort、servicePort 信息。如果不需要实现端口映射，hostPort 无需填写。</p>
<p>docker 存在网络模式：None，Host，Bridge，User（CNM/CNI），端口映射对 None（当前 Executor 暂未校验）</p>
<p><strong>hostPort</strong>使用定义：-1 为不使用，0 为随机端口，正数为指定端口</p>
<p>针对 docker 容器端口映射实现，端口绑定有两个情况：</p>
<ul>
<li><strong>指定端口</strong>绑定</li>
</ul>
<p>下发参数中没有 parameter 参数-P，并直接指定 hostPort，executor 默认直接将该指定参数提交给 docker 进行绑定。端口冲突是否需要用户执行决断。
如果没有特别指定调度策略将实例分开，有极大几率造成端口冲突。</p>
<ul>
<li>
<p>Host 模式下 hostPort 保持和 containerPort 一致，方便 datawatch 处理</p>
</li>
<li>
<p><strong>随机端口</strong>绑定</p>
</li>
</ul>
<p>下发参数中存在-P，并且有 ports 字段，hostPort 字段默认为 0，scheduler 使用 offer 上报的端口信息确认端口，更新 taskgroup 字段，并下发给 Executor。
随机端口绑定可以<strong>消除端口冲突</strong>的问题。<strong>有随机端口的情况下，为了方便应用获取到端口信息，需要将 port 端口根据需要导入环境变量 PORT0 ~ PORTn</strong></p>
<p><strong>更新</strong>（2017-05-22，根据 LOL 需求更新）：</p>
<ul>
<li>Host 模式下:</li>
<li>containerPort 设置为 0，默认使用 offer 提供端口资源，hostPort 和 containerPort 保持一致。port 端口根据序号导入环境变量 PORT0 ~ PORTn</li>
<li>containerPort 指定端口，默认传递该端口，port 端口根据序号导入环境变量 PORT0 ~ PORTn</li>
<li>Bridge 模式</li>
<li>hostPort 不填写默认补齐为-1，仅有 containerPort</li>
<li>hostPort 为 0，默认随机端口，使用 offer 端口资源，port 端口根据序号导入环境变量 PORT0 ~ PORTn</li>
</ul>
<h3 id="51">5.1 服务端口代码调整说明</h3>
<ul>
<li>executor</li>
</ul>
<p>executor 上报容器状态时，增加 ports 字段，结构包括 name，hostPort，containerPort，protocol</p>
<ul>
<li>api/scheduler</li>
</ul>
<p>使用随机端口时，默认 hostPort 直接填写 0，使用 offer 里面端口资源更新 hostPort 信息，不使用 HostPort，建议默认值为负数</p>
<ul>
<li>datawatch-mesos/datawatch-kube/loadbalance 支持</li>
</ul>
<p>上报 ExportService 时，结构调整，当前为</p>
<div class="codehilite"><pre><span></span><span class="c1">//ExportService info to hold export service</span>
<span class="kd">type</span> <span class="nx">ExportService</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Cluster</span>     <span class="kt">string</span>       <span class="s">`json:&quot;cluster&quot;`</span>     <span class="c1">//cluster info</span>
    <span class="nx">Namespace</span>   <span class="kt">string</span>       <span class="s">`json:&quot;namespace&quot;`</span>   <span class="c1">//namespace info, for business</span>
    <span class="nx">ServiceName</span> <span class="kt">string</span>       <span class="s">`json:&quot;serviceName&quot;`</span> <span class="c1">//service name</span>
    <span class="nx">ServicePort</span> <span class="p">[]</span><span class="nx">ExportPort</span> <span class="s">`json:&quot;ports&quot;`</span>       <span class="c1">//export ports info</span>
    <span class="nx">BCSGroup</span>    <span class="p">[]</span><span class="kt">string</span>     <span class="s">`json:&quot;BCSGroup&quot;`</span>    <span class="c1">//service export group</span>
    <span class="nx">SSLCert</span>     <span class="kt">bool</span>         <span class="s">`json:&quot;sslcert&quot;`</span>     <span class="c1">//SSL certificate for ser</span>
    <span class="nx">Balance</span>     <span class="kt">string</span>       <span class="s">`json:&quot;balance&quot;`</span>     <span class="c1">//loadbalance algorithm, default source</span>
    <span class="nx">MaxConn</span>     <span class="kt">int</span>          <span class="s">`json:&quot;maxconn&quot;`</span>     <span class="c1">//max connection setting</span>
<span class="p">}</span>
</pre></div>


<p>字段信息：</p>
<ul>
<li>SSLCert：是否使用 https，当前默认不开启，忽略</li>
<li>Balance：负载均衡的算法，默认是 source，忽略；</li>
<li>MaxConn：最大连接数，默认是 20000</li>
</ul>
<p>调整 ServicePort 和 Backends 字段，对其进行合并</p>
<div class="codehilite"><pre><span></span><span class="kd">type</span> <span class="nx">ExportPort</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">BCSVHost</span>    <span class="kt">string</span>    <span class="s">`json:&quot;BCSVHost&quot;`</span>
    <span class="nx">Protocol</span>    <span class="kt">string</span>    <span class="s">`json:&quot;protocol&quot;`</span>
    <span class="nx">Path</span>        <span class="kt">string</span>    <span class="s">`json:&quot;path&quot;`</span>
    <span class="nx">ServicePort</span> <span class="kt">int</span>       <span class="s">`json:&quot;servicePort&quot;`</span>
    <span class="nx">Backends</span>    <span class="p">[]</span><span class="nx">Backend</span> <span class="s">`json:&quot;backends&quot;`</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Backend</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">TargetIP</span> <span class="kt">string</span> <span class="s">`json:&quot;targetIP&quot;`</span>
    <span class="nx">TargetPort</span> <span class="kt">int</span>   <span class="s">`json:&quot;targetPort&quot;`</span>
<span class="p">}</span>
</pre></div>


<p>datawatch 构建 ExportService 时需要按照新结构进行。构建 ExportService 信息需要结合 Service 和 TaskGroup 信息。</p>
<ul>
<li>service 中，多个 ports 对应多个 ExportPort</li>
<li>Service.ports[i].name == TaskGroup.container[i].ports[i].name</li>
<li>提取 TaskGroup 多个实例的 containerIP，NodeIP，ContainerPort，HostPort</li>
<li>backend 组装说明，多个实例有多个 backend</li>
<li>如果 TaskGroup 网络模式 host，取 NodeIP 和 ContainerPort，组成 backend</li>
<li>网络模式为 bridge，如果有 HostPort：NodeIP + HostPort；如果没有，则 ContainerIP + ContainerPort</li>
<li>其他模式：ContainerIP + ContainerPort</li>
</ul><h1 id="_1">应用列表说明文档</h1>
<p>蓝鲸容器服务应用列表分两个维度展示：模板集维度和命名空间维度；其中，模板集维度主要展示由【模板集】实例化的应用；命名空间维度展示了集群下所有所有命名空间下的所有应用，来源包含模板集、Client 实例化的应用；以便用户查看和操作应用及查看应用下容器运行详情及资源使用详情。</p>
<ul>
<li>应用类型
application/deployment</li>
</ul>
<h2 id="1">1. 查询展示</h2>
<ul>
<li>模板及应用展示</li>
</ul>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/assets/application/template_instance.jpg" /></p>
<ul>
<li>应用详情</li>
</ul>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/assets/application/instance_detail.jpg" /></p>
<ul>
<li>容器详情</li>
</ul>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/assets/application/container_detail.jpg" /></p>
<h2 id="2">2. 操作相关</h2>
<ul>
<li>滚动升级</li>
</ul>
<p><code>注: 允许应用类型包含 deployment/daemonset/job/statefulset</code></p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/assets/application/rollingupdate.jpg" /></p>
<ul>
<li>扩缩容</li>
</ul>
<p>实例数量增加或减少</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/assets/application/scale.jpg" /></p>
<ul>
<li>重建应用</li>
</ul>
<p>重建包含两个步骤: 删除当前应用，然后以现有配置再创建应用(类似进程重启)</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/assets/application/recreate.jpg" /></p>
<ul>
<li>删除应用</li>
</ul>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/assets/application/delete.jpg" /></p>
<ul>
<li>重新调度</li>
</ul>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/assets/application/reschedule.jpg" /></p><h1 id="bcs">BCS 容器网络方案集成</h1>
<p>面对复杂业务应用需求，BCS 针对业务的 <strong>网络支持是按照插件化</strong> 方式进行设计，方便业务在不同环境下能对接不同的网络实现，完成具体的定制。</p>
<p>在网络标准选择上，BCS 建议采用 CNI 网络，以方便容器网络能获得最佳的扩展能力。如果启用 BCS 相关的 <a href="https://github.com/Tencent/bk-bcs-saas">SaaS 服务</a>，集群的相关安装与配置可以通过 SaaS 来完成，如果只是启用 BCS 后台服务，相关配置请参照以下指引。</p>
<ul>
<li><a href="../StorageSolution/kubernetes.md">BCS Kubernetes 网络实践</a></li>
<li><a href="./mesos.md">BCS Mesos 网络实践</a></li>
</ul><h1 id="kubernetes">Kubernetes 网络设置</h1>
<p>如果针对容器网络，没有额外设计需求，BCS 建议采用 Kubernetes 社区建议的网络方案。</p>
<p>Kubernetes 与 BCS 集成可以参考 <a href="https://github.com/Tencent/bk-bcs/blob/master/docs/install/Deploy_BCS_in_K8S_HA_Cluster.md">BCS 高可用 Kubernetes 集群部署</a></p>
<h2 id="1-cni">1. CNI 扩展</h2>
<p>Kubernetes node 节点默认安装 CNI 工具的目录</p>
<ul>
<li>二进制目录：/opt/cni/bin/</li>
<li>配置目录: /etc/cni/net.d/</li>
</ul>
<p>如果已经针对网络进行 CNI 扩展，则需要进行扩展 CNI 工具进行部署。</p>
<p><strong>手动部署</strong></p>
<ul>
<li>CNI 部署，将编译好的 CNI 工具部署到所有 Node 节点 /opt/cni/bin</li>
<li>配置部署，编写对应的 CNI 配置，放置到 /etc/cni/net.d/ ，注意配置文件字母序要为第一。</li>
</ul>
<p><strong>镜像部署</strong></p>
<p>社区采用方案，将扩展好的 CNI 工具与 CNI 社区提供的所有工具整合成 CNI 工具镜像，默认在每个节点启动 Daemonset，实现 CNI 工具部署。</p>
<p>细节可以参考 <a href="https://github.com/coreos/flannel-cni">Flannel-CNI 项目</a></p>
<p>kubelet 在 /etc/cni/net.d 目录下读取 CNI 的配置文件时，是按文件名的字母顺序来的。在这个目录下可以放多个配置文件，kubelet 会读取字母顺序排第一的配置文件。</p>
<h2 id="2">2. 多网络集成</h2>
<p>针对部分复杂的场景，容器可能需要多网络设置与集成，由于 Kubernetes 默认不支持 CNI 链式
调用，BCS 建议在以下场景，可以采用链式 CNI 插件实现多 CNI 插件集成。</p>
<ul>
<li>多网络栈配置</li>
<li>网络带宽限制</li>
<li>额外路由配置</li>
<li>IP 端口映射</li>
<li>网络内核参数调整</li>
</ul>
<p>社区当前有多重链式 CNI 插件可以选择：</p>
<ul>
<li><a href="https://github.com/intel/multus-cni">multus-CNI</a></li>
<li><a href="https://github.com/cni-genie/CNI-Genie">CNI-genie</a></li>
</ul>
<p>插件安装方式请参照上述链接。</p>
<h2 id="3-saas">3. SaaS 插件使用</h2>
<p>完成 multus-CNI 安装之后，multus-CNI 在 bcs-saas 相关页面设置：</p>
<blockquote>
<p>模板集--Deployment 设置--更多设置--备注，完成 annotation 的 KV 填写</p>
<p>如下图：</p>
</blockquote>
<p><img alt="multus-CNI" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/NetworkSolution/k8s/media/multus-cni.png" /></p><h1 id="loadbalancer">LoadBalancer</h1>
<p><a href="../../../Function/k8s/service/ingress.md">Ingress</a> 一节中提到 Ingress 描述资源对外的访问方式，背后需要 Ingress Controller 支撑，本节介绍 BCS 中的使用的 Ingress Controller。</p>
<p><a href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/">Ingress Controller</a> 有很多种实现，比如 Traefik、Nginx Ingress Controller、 HAProxy Ingress Controller 等，在 BCS 中定义 LoadBalancer， 采用 K8S 官方维护的 Nginx Ingress Controller。</p>
<h2 id="1-loadbalancer">1. 如何创建 LoadBalancer</h2>
<p>在【LoadBalancer】菜单中，点击【新建 LoadBalancer】，添加一台或多台节点作为 LoadBalancer，点击【保存】即可。</p>
<p><img alt="-w1653" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/NetworkSolution/k8s/media/15683668713785.jpg" /></p>
<h2 id="2-loadbalancer">2. LoadBalancer 的背后技术</h2>
<h3 id="21-nginx-ingress-controller">2.1 Nginx Ingress Controller</h3>
<p>实际是创建了 2 个 Deploymengt</p>
<div class="codehilite"><pre><span></span><span class="c1"># kubectl get deploy -n dev</span>
NAME                                     DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
blueking-nginx-ingress-controller        <span class="m">1</span>         <span class="m">1</span>         <span class="m">1</span>            <span class="m">1</span>           32h
blueking-nginx-ingress-default-backend   <span class="m">1</span>         <span class="m">1</span>         <span class="m">1</span>            <span class="m">1</span>           32h
</pre></div>


<p>查看 nginx-ingress-controller 的配置文件，可以看到我们在场景案例 <a href="../../..//Scenes/Bcs_blue_green_deployment.md">应用的蓝绿发布</a> 中定义的 Ingress 。</p>
<div class="codehilite"><pre><span></span><span class="c1"># kubectl  exec blueking-nginx-ingress-controller-79c687dc95-c4k5b -n dev -- cat /etc/nginx/nginx.conf</span>

    <span class="c1">## start server blue.bk.tencent.com</span>
    server <span class="o">{</span>
        server_name blue.bk.tencent.com <span class="p">;</span>

        listen <span class="m">80</span><span class="p">;</span>

        listen <span class="o">[</span>::<span class="o">]</span>:80<span class="p">;</span>

        <span class="nb">set</span> <span class="nv">$proxy_upstream_name</span> <span class="s2">&quot;-&quot;</span><span class="p">;</span>

        location / <span class="o">{</span>

            port_in_redirect off<span class="p">;</span>

            <span class="nb">set</span> <span class="nv">$proxy_upstream_name</span> <span class="s2">&quot;dev-web-nginx-blue-80&quot;</span><span class="p">;</span>

            <span class="nb">set</span> <span class="nv">$namespace</span>      <span class="s2">&quot;dev&quot;</span><span class="p">;</span>
            <span class="nb">set</span> <span class="nv">$ingress_name</span>   <span class="s2">&quot;web-nginx-blue&quot;</span><span class="p">;</span>
            <span class="nb">set</span> <span class="nv">$service_name</span>   <span class="s2">&quot;web-nginx-blue&quot;</span><span class="p">;</span>

            client_max_body_size                    <span class="s2">&quot;500m&quot;</span><span class="p">;</span>

            proxy_set_header Host                   <span class="nv">$best_http_host</span><span class="p">;</span>

            <span class="c1"># Pass the extracted client certificate to the backend</span>

            proxy_set_header ssl-client-cert        <span class="s2">&quot;&quot;</span><span class="p">;</span>
            proxy_set_header ssl-client-verify      <span class="s2">&quot;&quot;</span><span class="p">;</span>
            proxy_set_header ssl-client-dn          <span class="s2">&quot;&quot;</span><span class="p">;</span>

            <span class="c1"># Allow websocket connections</span>
            proxy_set_header                        Upgrade           <span class="nv">$http_upgrade</span><span class="p">;</span>

            proxy_set_header                        Connection        <span class="nv">$connection_upgrade</span><span class="p">;</span>

            proxy_set_header X-Real-IP              <span class="nv">$the_real_ip</span><span class="p">;</span>

            proxy_set_header X-Forwarded-For        <span class="nv">$the_real_ip</span><span class="p">;</span>

            proxy_set_header X-Forwarded-Host       <span class="nv">$best_http_host</span><span class="p">;</span>
            proxy_set_header X-Forwarded-Port       <span class="nv">$pass_port</span><span class="p">;</span>
            proxy_set_header X-Forwarded-Proto      <span class="nv">$pass_access_scheme</span><span class="p">;</span>
            proxy_set_header X-Original-URI         <span class="nv">$request_uri</span><span class="p">;</span>
            proxy_set_header X-Scheme               <span class="nv">$pass_access_scheme</span><span class="p">;</span>

            <span class="c1"># Pass the original X-Forwarded-For</span>
            proxy_set_header X-Original-Forwarded-For <span class="nv">$http_x_forwarded_for</span><span class="p">;</span>

            <span class="c1"># mitigate HTTPoxy Vulnerability</span>
            <span class="c1"># https://www.nginx.com/blog/mitigating-the-httpoxy-vulnerability-with-nginx/</span>
            proxy_set_header Proxy                  <span class="s2">&quot;&quot;</span><span class="p">;</span>

            <span class="c1"># Custom headers to proxied server</span>

            proxy_connect_timeout                   5s<span class="p">;</span>
            proxy_send_timeout                      60s<span class="p">;</span>
            proxy_read_timeout                      60s<span class="p">;</span>

            proxy_buffering                         <span class="s2">&quot;off&quot;</span><span class="p">;</span>
            proxy_buffer_size                       <span class="s2">&quot;4k&quot;</span><span class="p">;</span>
            proxy_buffers                           <span class="m">4</span> <span class="s2">&quot;4k&quot;</span><span class="p">;</span>
            proxy_request_buffering                 <span class="s2">&quot;on&quot;</span><span class="p">;</span>

            proxy_http_version                      <span class="m">1</span>.1<span class="p">;</span>

            proxy_cookie_domain                     off<span class="p">;</span>
            proxy_cookie_path                       off<span class="p">;</span>

            <span class="c1"># In case of errors try the next upstream server before returning an error</span>
            proxy_next_upstream                     error timeout invalid_header http_502 http_503 http_504<span class="p">;</span>

            proxy_pass http://dev-web-nginx-blue-80<span class="p">;</span>

            proxy_redirect                          off<span class="p">;</span>

        <span class="o">}</span>

    <span class="o">}</span>
    <span class="c1">## end server blue.bk.tencent.com</span>
</pre></div>


<h3 id="22">2.2 使用建议</h3>
<p>一般我们建议选择多台专属节点作为 LoadBalancer，不要分配其他 Pod 到该节点。</p>
<p>可以通过 节点 <strong>亲和性约束</strong> 实现。</p>
<p><img alt="-w1678" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/NetworkSolution/k8s/media/15683681052985.jpg" /></p><h1 id="bcs-mesos">BCS 自研 Mesos 容器方案网络集成</h1>
<p>BCS 在设计 Mesos 方案之初已经考虑多种网络的集成问题。在容器 json 文件中有相关参数进行
网络参数详细设定。原始 json 文档可以参考</p>
<ul>
<li><a href="https://github.com/Tencent/bk-bcs/blob/master/docs/templates/mesos-artifact/application.md">Application</a></li>
</ul>
<p>关键参数说明</p>
<ul>
<li>networkType：容器网络标准，可选 cni 与 cnm</li>
<li>cnm：默认值，与 docker 网络集成时使用</li>
<li>cni：CNI 标准支持，支持基于 CNI 标准的所有插件</li>
<li>networkMode: 容器网络模式</li>
<li>HOST：host 网络模式，需要和 cnm 组合，容器共享主机网络栈</li>
<li>BRIDGE：网桥模式，cnm/cni 标准皆可以支持</li>
<li>自定义方式：docker 支持的其他网络模式、CNI 支持的插件皆可</li>
</ul>
<h2 id="1-docker">1. 与 docker 集成</h2>
<p>与 docker 网络集成时，application 的 json 配置 networkType 需要填写 cnm，默认即为该模式。</p>
<p>networkMode 的值则为 docker 已生效的网络模式，docker 网络模式查看：</p>
<div class="codehilite"><pre><span></span>$ docker network ls
NETWORK ID          NAME                DRIVER              SCOPE
437f2816be0a        bridge              bridge              <span class="nb">local</span>               
1093cd0625ed        host                host                <span class="nb">local</span>               
a1a0f9fbd969        none                null                <span class="nb">local</span>
</pre></div>


<p>其他自定义 docker 网络模式需要自行手动创建或对支持 CNM 模式的网络方案进行集成，例如 macvlan：</p>
<div class="codehilite"><pre><span></span><span class="c1">#创建macvlan，网络名字为test-macvlan</span>
$ docker network create -d macvlan <span class="se">\</span>
  --subnet<span class="o">=</span><span class="m">172</span>.16.86.0/24 <span class="se">\</span>
  --gateway<span class="o">=</span><span class="m">172</span>.16.86.1 <span class="se">\</span>
  -o <span class="nv">parent</span><span class="o">=</span>eth1 <span class="se">\</span>
  test-macvlan
</pre></div>


<p>当使用 docker host、bridge 时，BCS 方案会针对 json 中填写的端口信息进行映射。例如 application 定义：</p>
<div class="codehilite"><pre><span></span><span class="s2">&quot;ports&quot;</span><span class="err">:</span> <span class="p">[{</span>
        <span class="nt">&quot;containerPort&quot;</span><span class="p">:</span> <span class="mi">8090</span><span class="p">,</span>
        <span class="nt">&quot;hostPort&quot;</span><span class="p">:</span> <span class="mi">8090</span><span class="p">,</span>
        <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;test-tcp&quot;</span><span class="p">,</span>
        <span class="nt">&quot;protocol&quot;</span><span class="p">:</span> <span class="s2">&quot;TCP&quot;</span>
    <span class="p">}</span>
<span class="p">]</span>
</pre></div>


<p>映射方式说明：
* host 模式下，containerPort 即代表 hostPort
  * 填写固定端口，需要业务自行确认是否产生冲突
  * 填写 0，意味着 BCS 针对端口进行随机选择，端口实际值会写入环境变量中
* bridge 模式下，hostPort 代表物理主机上的端口
  * hostPort 填写固定端口，业务自行解决冲突的问题
  * 填写 0，BCS 默认进行端口随机
  * 小于 0，不进行端口映射</p>
<h2 id="2-cni">2. CNI 集成</h2>
<p>BCS Mesos 方案默认支持 CNI 插件，使用 CNI 方案需要配置：</p>
<ul>
<li>CNI 目录，安装 BCS scheudler 时设置，默认为/data/bcs/bcs-cni</li>
<li>二进制插件目录：/data/bcs/bcs-cni/bin</li>
<li>配置目录：/data/bcs/bcs-cni/conf</li>
<li>部署 CNI 插件与配置到对应目录</li>
<li>application 或 deployment json 中指定使用的网络插件</li>
</ul>
<p>例如采用 macvlan</p>
<div class="codehilite"><pre><span></span><span class="s2">&quot;networkType&quot;</span><span class="err">:</span> <span class="s2">&quot;cni&quot;</span><span class="err">,</span>
<span class="s2">&quot;networkMode&quot;</span><span class="err">:</span> <span class="s2">&quot;mymacvlan&quot;</span><span class="err">,</span>
</pre></div>


<p>macvlan 插件配置：</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;cniVersion&quot;</span><span class="p">:</span> <span class="s2">&quot;0.3.0&quot;</span><span class="p">,</span>
  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;mymacvlan&quot;</span><span class="p">,</span>
  <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;macvlan&quot;</span><span class="p">,</span>
  <span class="nt">&quot;master&quot;</span><span class="p">:</span> <span class="s2">&quot;eth1&quot;</span><span class="p">,</span>
  <span class="nt">&quot;ipam&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;bcs-ipam&quot;</span><span class="p">,</span>
    <span class="nt">&quot;routes&quot;</span><span class="p">:</span> <span class="p">[</span>
      <span class="p">{</span><span class="nt">&quot;dst&quot;</span><span class="p">:</span><span class="s2">&quot;0.0.0.0/0&quot;</span><span class="p">}</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h2 id="3">3. 多网络集成</h2>
<p>BCS Mesos 方案下的容器实现默认支持 CNI 链式调用方案。如要启动 CNI 链式调用，需要：</p>
<ul>
<li>CNI conf 目录下需要放置有链式调用配置</li>
<li>CNI bin 目录下放置有所依赖的二进制文件</li>
</ul>
<p>例如 CNI 配置:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;cniVersion&quot;</span><span class="p">:</span> <span class="s2">&quot;0.3.1&quot;</span><span class="p">,</span>
  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;dbnet&quot;</span><span class="p">,</span>
  <span class="nt">&quot;plugins&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;bridge&quot;</span><span class="p">,</span>
      <span class="nt">&quot;bridge&quot;</span><span class="p">:</span> <span class="s2">&quot;cni0&quot;</span><span class="p">,</span>
      <span class="nt">&quot;ipam&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;host-local&quot;</span><span class="p">,</span>
        <span class="nt">&quot;subnet&quot;</span><span class="p">:</span> <span class="s2">&quot;10.1.0.0/16&quot;</span><span class="p">,</span>
        <span class="nt">&quot;gateway&quot;</span><span class="p">:</span> <span class="s2">&quot;10.1.0.1&quot;</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nt">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;tuning&quot;</span><span class="p">,</span>
      <span class="nt">&quot;sysctl&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;net.core.somaxconn&quot;</span><span class="p">:</span> <span class="s2">&quot;500&quot;</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>


<ul>
<li>确保 CNI bin 目录下部署有 bridge 与 tunning 二进制文件</li>
<li>运行时依次调用 bridge 与 tunning 插件</li>
</ul>
<p>调用该 CNI 配置时，Application 或 Deployment 需要明确填写：</p>
<div class="codehilite"><pre><span></span><span class="s2">&quot;networkType&quot;</span><span class="err">:</span> <span class="s2">&quot;cni&quot;</span><span class="err">,</span>
<span class="s2">&quot;networkMode&quot;</span><span class="err">:</span> <span class="s2">&quot;dbnet&quot;</span><span class="err">,</span>
</pre></div>


<h2 id="4-saas">4. SaaS 页面插件使用</h2>
<p>完成插件配置后之后，在 bcs-saas 相关页面设置：</p>
<blockquote>
<p>模板集--Application 设置--更多设置--网络，完成相关参数填写</p>
<p>如下图：</p>
</blockquote>
<p><img alt="mesos-CNI" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/NetworkSolution/resource/mesos-cni.png" /></p><h1 id="k8s">K8S 存储</h1>
<p>BCS 支持 K8S 原生的多种存储能力。在存储类型上，支持本地存储 hostpath、emptyDir、local 等；在存储方式上，支持 Volume、静态 PV、动态 PV； 在存储插件方案上，支持 K8S 内置的 In-tree 存储驱动、FlexVolume 存储驱动，以及 CSI 存储驱动的方案。  </p>
<h2 id="1">1. 基础概念</h2>
<ul>
<li>
<p>Volume、PV 和动态 PV
K8S 使用 Volume、PV 来管理 Pod 容器的持久化数据。  </p>
</li>
<li>
<p>Volume
Volume 生命周期与 Pod 绑定，容器挂掉重启后，Volume 的数据依然存在。 Pod 被删除时， Volume 被清理， 数据是否丢失取决于 Volume Driver 类型。  </p>
</li>
<li>
<p>PV
为了更好管理应用的持久化数据存储，K8S 推出了 PV（<a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/">Persistent Volume</a>）的概念。PV 独立于 Pod 的生命周期。应用在使用 PV 时，先创建 PVC（<a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims">PersistentVolumeClaim</a>），然后在 Pod 中声明绑定 PVC。  </p>
<p>PV 有 Static PV 和 <a href="https://kubernetes.io/docs/concepts/storage/dynamic-provisioning/">Dynamic PV</a> 两种使用方式。  </p>
</li>
<li>
<p>PV 、PVC 的关系：</p>
</li>
<li>PV、PVC 类似 Nodes、Pods 的关系，Pod 是最小调度单元，资源是 Node 提供。</li>
<li>工作负载（Workload）调度 PVC 申请网络资源，PVC 按照规范匹配合适的 PV，或者动态创建，然后 PV 和 PVC 进行绑定</li>
</ul>
<h2 id="2">2. 本地存储</h2>
<h3 id="21-hostpath">2.1 hostpath</h3>
<p>hostpath 映射宿主机 host 上的目录或文件至 K8S Pod 容器中，典型场景如运行的容器需要访问 Docker 内部结构，此时挂载宿主机 host 上的 /var/lib/docker 目录至容器中， 又如将 cAdvisor 部署在 Pod 容器中，需要挂载宿主机 host 上的 /sys 目录至容器中。</p>
<p>使用示例：</p>
<div class="codehilite"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">test-pd</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">containers</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nginx:latest</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nginx</span>
    <span class="nt">ports</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">containerPort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
    <span class="nt">volumeMounts</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">mountPath</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/data</span>
      <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">testvolume</span>
  <span class="nt">volumes</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">testvolume</span>
    <span class="nt">hostPath</span><span class="p">:</span>
      <span class="nt">path</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/testvolume</span>
</pre></div>


<h3 id="22-emptydir">2.2 emptyDir</h3>
<p>emptyDir 用于 Pod 需要挂载临时目录的情况。当 Pod 被调度到 host 节点上时，在 host 上自动创建一个空目录并挂载进 Pod 容器中，当 Pod 从 host 上删除时，这个目录也被删除。因此目录中存储的数据在 Pod 删除后并不会持久化到宿主机 host 上。</p>
<p>使用示例：</p>
<div class="codehilite"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">test-pd</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">containers</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nginx:latest</span>
    <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nginx</span>
    <span class="nt">ports</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">containerPort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
    <span class="nt">volumeMounts</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="nt">mountPath</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/cache</span>
      <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cache-volume</span>
  <span class="nt">volumes</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cache-volume</span>
    <span class="nt">emptyDir</span><span class="p">:</span> <span class="p p-Indicator">{}</span>
</pre></div>


<h2 id="3">3. 本地存储使用方式</h2>
<p>使用 hostpath 和 emptyDir 等本地存储时，建议用 volume 方式来做存储管理。<br />
在 "模板集 》Deployment 》Pod 模板设置 》卷" 中，可以配置使用 hostpath 或 emptyDir 本地存储。  </p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/StorageSolution/media/localStorage.png" /></p>
<h2 id="4">4. 存储插件方案</h2>
<p>K8S 支持多种后端存储，包括公有云存储产品 AWS EBS, AzureFile, GCE PD 等；商业存储产品 ScaleIO 等；开源存储产品 Ceph, GlusterFS 等。<br />
后端存储是以插件化的方式提供支持的，K8S 前期都是以内置 in-tree 的方式接入第三方存储，存储驱动的代码是嵌入 K8S 核心代码当中的。从 1.13 版本开始，CSI(Container Storage Interface)插件方案正式进入到稳定版本，使用 CSI 插件方案可以解耦 K8S 与存储 driver， 以容器化的方式把 CSI 存储驱动部署在 K8S 集群中。  </p>
<p>BCS 原生支持 K8S 的存储方案，考虑到安全性、可扩展性以及可运维性，BCS 推荐以 CSI 的方式使用第三方后端存储。<br />
下面以 Ceph RBD 为例，展示 BCS K8S 第三方分布式存储的接入。  </p>
<h2 id="5-ceph-rbd">5. Ceph RBD 接入和使用</h2>
<h3 id="51-rbd-csi">5.1 RBD CSI 部署</h3>
<p>RBD CSI 推荐以 Helm 的方式部署到 K8S 集群当中。BCS 会在 Helm 仓库中提供 RBD CSI 的 Helm Chart 包，用户如果需要在 K8S 集群的应用中使用 Ceph RBD 分布式块存储，可直接通过 Helm 把 RBD CSI 部署至集群当中。  </p>
<h3 id="52-rbd-csi">5.2 RBD CSI 使用</h3>
<h4 id="521-storageclass">5.2.1 创建 StorageClass</h4>
<p>BCS 管理员后台创建 RBD 的 StorageClass</p>
<ul>
<li>secret:</li>
</ul>
<div class="codehilite"><pre><span></span><span class="c1"># This is a template secret that helps define a Ceph cluster configuration</span>
<span class="c1"># as required by the CSI driver. This is used when a StorageClass has the</span>
<span class="c1"># &quot;clusterID&quot; defined as one of the parameters, to provide the CSI instance</span>
<span class="c1"># Ceph cluster configuration information.</span>
<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Secret</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="c1"># The &lt;cluster-id&gt; is used by the CSI plugin to uniquely identify and use a</span>
  <span class="c1"># Ceph cluster, the value MUST match the value provided as `clusterID` in the</span>
  <span class="c1"># StorageClass</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ceph-cluster-{ceph_cluster_id}</span>
  <span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="nt">data</span><span class="p">:</span>
  <span class="c1"># Base64 encoded and comma separated Ceph cluster monitor list</span>
  <span class="c1">#   - Typically output of: `echo -n &quot;mon1:port,mon2:port,...&quot; | base64`</span>
  <span class="nt">monitors</span><span class="p">:</span>
  <span class="c1"># Base64 encoded and comma separated list of pool names from which volumes</span>
  <span class="c1"># can be provisioned</span>
  <span class="nt">pools</span><span class="p">:</span>
  <span class="c1"># Base64 encoded admin ID to use for provisioning</span>
  <span class="c1">#   - Typically output of: `echo -n &quot;&lt;admin-id&gt;&quot; | base64`</span>
  <span class="c1"># Substitute the entire string including angle braces, with the base64 value</span>
  <span class="nt">adminid</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">=</span>
  <span class="c1"># Base64 encoded key of the provisioner admin ID</span>
  <span class="c1">#   - Output of: `ceph auth get-key client.&lt;admin-id&gt; | base64`</span>
  <span class="c1"># Substitute the entire string including angle braces, with the base64 value</span>
  <span class="nt">adminkey</span><span class="p">:</span>
  <span class="c1"># Base64 encoded user ID to use for publishing</span>
  <span class="c1">#   - Typically output of: `echo -n &quot;&lt;admin-id&gt;&quot; | base64`</span>
  <span class="c1"># Substitute the entire string including angle braces, with the base64 value</span>
  <span class="nt">userid</span><span class="p">:</span>
  <span class="c1"># Base64 encoded key of the publisher user ID</span>
  <span class="c1">#   - Output of: `ceph auth get-key client.&lt;admin-id&gt; | base64`</span>
  <span class="c1"># Substitute the entire string including angle braces, with the base64 value</span>
  <span class="nt">userkey</span><span class="p">:</span>
</pre></div>


<ul>
<li>StorageClass:</li>
</ul>
<div class="codehilite"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">storage.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">StorageClass</span>
<span class="nt">metadata</span><span class="p">:</span>
   <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">csi-rbd</span>
<span class="nt">provisioner</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rbd.csi.ceph.com</span>
<span class="nt">parameters</span><span class="p">:</span>
  <span class="nt">clusterID</span><span class="p">:</span> <span class="p p-Indicator">{</span><span class="nv">ceph_cluster_id</span><span class="p p-Indicator">}</span>
  <span class="nt">pool</span><span class="p">:</span>
  <span class="c1"># RBD image format. Defaults to &quot;2&quot;.</span>
  <span class="nt">imageFormat</span><span class="p">:</span> <span class="s">&quot;2&quot;</span>

  <span class="c1"># RBD image features. Available for imageFormat: &quot;2&quot;</span>
  <span class="c1"># CSI RBD currently supports only `layering` feature.</span>
  <span class="nt">imageFeatures</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">layering</span>
<span class="nt">reclaimPolicy</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Delete</span>
</pre></div>


<h4 id="522-pvc">5.2.2 创建 PVC</h4>
<p>用户在模板集中创建 PVC, 或者使用 kubectl 通过 bcs-api 操作 K8S 集群创建 PVC</p>
<ul>
<li>PVC:</li>
</ul>
<div class="codehilite"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rbd-pvc</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">accessModes</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ReadWriteOnce</span>
  <span class="nt">resources</span><span class="p">:</span>
    <span class="nt">requests</span><span class="p">:</span>
      <span class="nt">storage</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">0.1Gi</span>
  <span class="nt">storageClassName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">csi-rbd</span>
</pre></div>


<h4 id="523-pvc">5.2.3 引用 PVC</h4>
<p>在模板集中创建的 Deployment 应用时，在 Pod 中指定挂载 PVC</p>
<ul>
<li>Deployment:</li>
</ul>
<div class="codehilite"><pre><span></span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">csirbd-demo-deploy</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">replicas</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
  <span class="nt">selector</span><span class="p">:</span>
    <span class="nt">matchLabels</span><span class="p">:</span>
      <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">csirbd-demo-Pod</span>
  <span class="nt">template</span><span class="p">:</span>
    <span class="nt">metadata</span><span class="p">:</span>
      <span class="nt">labels</span><span class="p">:</span>
        <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">csirbd-demo-Pod</span>
    <span class="nt">spec</span><span class="p">:</span>
      <span class="nt">containers</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nginx</span>
        <span class="nt">image</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">nginx:latest</span>
        <span class="nt">imagePullPolicy</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">IfNotPresent</span>
        <span class="nt">ports</span><span class="p">:</span>
        <span class="p p-Indicator">-</span> <span class="nt">containerPort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
        <span class="nt">volumeMounts</span><span class="p">:</span>
          <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mypvc</span>
            <span class="nt">mountPath</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">/data1</span>
      <span class="nt">volumes</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mypvc</span>
        <span class="nt">persistentVolumeClaim</span><span class="p">:</span>
          <span class="nt">claimName</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rbd-pvc</span>
          <span class="nt">readOnly</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</pre></div><h1 id="nfs-k8s-pv-provisioner">将 NFS 作为 K8S PV Provisioner</h1>
<h4 id="_1">情景</h4>
<p>互联网应用常见的三层架构：接入层、逻辑层、存储层，在操作系统中 <strong>文件系统</strong> 提供存储层的存储介质，在 K8S 中是 <strong>Persistent Volumes</strong>（持久卷，简称 PV），而 PV 背后需要对接存储介质，比如 NFS、CephFS 以及公有云的云硬盘[1]。</p>
<p>接下来以 NFS 作为 K8S PV 的存储介质（Provisioner）为例，介绍在 K8S 中如何申请以及使用存储空间。</p>
<h4 id="_2">前提条件</h4>
<ul>
<li>了解 K8S 中 <a href="kubernetes.md">存储</a> 的基础的概念。</li>
<li>了解 <a href="../helm/ServiceAccess.md">K8S 的包管理工具 Helm</a></li>
</ul>
<h4 id="_3">操作步骤</h4>
<ol>
<li>部署 NFS Server</li>
<li>部署 NFS-Client-Provisioner</li>
<li>创建 PVC 测试</li>
</ol>
<h2 id="1-nfs-server">1. 部署 NFS Server</h2>
<blockquote>
<p>以下为测试环境在 CentOS 7 下搭建 NFS 的示例，生产环境请咨询公司系统管理员。</p>
</blockquote>
<p>安装 NFS Server 端（ IP : 10.0.5.85），并启动以及设置开机自启动。</p>
<div class="codehilite"><pre><span></span><span class="c1"># yum -y install nfs-utils</span>
systemctl <span class="nb">enable</span> rpcbind
systemctl <span class="nb">enable</span> nfs
systemctl start rpcbind
systemctl start nfs
</pre></div>


<p>设置 <code>/nfs</code> 目录为挂载目录，对 <code>10.0.0.0/16</code> 网段开放。</p>
<div class="codehilite"><pre><span></span><span class="c1"># mkdir /nfs</span>

<span class="c1"># vim /etc/exports</span>
/nfs    <span class="m">10</span>.0.0.0/16<span class="o">(</span>rw,sync,no_root_squash,no_all_squash<span class="o">)</span>

<span class="c1"># systemctl restart nfs</span>

<span class="c1"># showmount -e localhost</span>
Export list <span class="k">for</span> localhost:
/nfs <span class="m">10</span>.0.0.0/16
</pre></div>


<p>本地挂载测试，验证 NFS 部署是否成功。</p>
<div class="codehilite"><pre><span></span><span class="c1"># mount -t nfs &lt;NFS_SERVER_IP&gt;:/nfs /mnt</span>

<span class="c1"># nfsstat -m  </span>
/mnt from &lt;NFS_SERVER_IP&gt;:/nfs
 Flags: rw,relatime,vers<span class="o">=</span><span class="m">4</span>.1,rsize<span class="o">=</span><span class="m">1048576</span>,wsize<span class="o">=</span><span class="m">1048576</span>,namlen<span class="o">=</span><span class="m">255</span>,hard,proto<span class="o">=</span>tcp,timeo<span class="o">=</span><span class="m">600</span>,retrans<span class="o">=</span><span class="m">2</span>,sec<span class="o">=</span>sys,clientaddr<span class="o">=</span>&lt;NFS_SERVER_IP&gt;,local_lock<span class="o">=</span>none,addr<span class="o">=</span>&lt;NFS_SERVER_IP&gt;
</pre></div>


<h2 id="2-nfs-client-provisioner">2. 部署 NFS-Client-Provisioner</h2>
<p>K8S 使用 NFS 资源，需要能挂载 NFS 以及配套的 K8S 资源（StorageClass、ServerAccout、PersistentVolume、PersistentVolumeClaim 等）。</p>
<p>为了简化部署，以及为了使用 K8S 中的包管理器 <a href="../helm/ServiceAccess.md">Helm</a>（类比 yum ） 来部署 <a href="https://github.com/kubernetes-incubator/external-storage/tree/master/nfs-client">NFS-Client-Provisioner</a> 的 <a href="https://github.com/helm/charts/tree/master/stable/nfs-client-provisioner">Chart</a>（类比 rpm）。</p>
<h3 id="21-chart">2.1 将 Chart 推到仓库</h3>
<blockquote>
<p>由于 Helm V2 需要在集群中部署 tiller，存在安全风险，无法直接使用 Helm install 部署应用，BCS 会将 Chart 通过  Helm template 解析为 K8S 的资源配置来部署。</p>
</blockquote>
<p>下载  的 Charts。</p>
<div class="codehilite"><pre><span></span>git clone https://github.com/helm/charts/
</pre></div>


<div class="codehilite"><pre><span></span><span class="c1"># pwd</span>
charts/stable/nfs-client-provisioner
<span class="c1"># ll</span>
总用量 <span class="m">28</span>
-rw-r--r-- <span class="m">1</span> root root  <span class="m">479</span> 8月  <span class="m">27</span> <span class="m">17</span>:00 Chart.yaml
drwxr-xr-x <span class="m">2</span> root root <span class="m">4096</span> 8月  <span class="m">27</span> <span class="m">17</span>:00 ci
-rw-r--r-- <span class="m">1</span> root root   <span class="m">74</span> 8月  <span class="m">27</span> <span class="m">17</span>:00 OWNERS
-rw-r--r-- <span class="m">1</span> root root <span class="m">5193</span> 8月  <span class="m">27</span> <span class="m">17</span>:00 README.md
drwxr-xr-x <span class="m">2</span> root root <span class="m">4096</span> 8月  <span class="m">27</span> <span class="m">17</span>:00 templates
-rw-r--r-- <span class="m">1</span> root root <span class="m">1677</span> 8月  <span class="m">27</span> <span class="m">17</span>:00 values.yaml

<span class="c1"># helm push . joyfulgame</span>
Pushing nfs-client-provisioner-1.2.6.tgz to joyfulgame...
Done.
</pre></div>


<p>选择菜单 【Chart 仓库】，点击【同步仓库】可以看到刚刚推送上来的 Chart。</p>
<p><img alt="-w1676" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/StorageSolution/media/15680230226584.jpg" /></p>
<h3 id="22-chart">2.2 部署 Chart</h3>
<p>点击 【部署】，准备部署 Chart</p>
<p><img alt="-w1629" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/StorageSolution/media/15680231028519.jpg" /></p>
<p>填写 Helm 参数： NFS Server 的 IP（nfs.server）、 开放挂载的目录（nfs.path）。</p>
<p>如果集群中没有 StorageClass ，建议将其设置为默认（StorageClass.defaultClass）。</p>
<p>然后点击 【部署】。</p>
<p><img alt="-w1674" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/StorageSolution/media/15680277372426.jpg" /></p>
<p>完成部署后，接下来创建 PVC 测试。</p>
<h2 id="3-pvc">3. 创建 PVC 测试</h2>
<ul>
<li>检查 StorageClass 是否设置成功</li>
</ul>
<div class="codehilite"><pre><span></span><span class="c1"># kubectl get storageclass</span>
NAME                   PROVISIONER   AGE
nfs-client <span class="o">(</span>default<span class="o">)</span>   nfs           12d
</pre></div>


<ul>
<li>创建 PVC</li>
</ul>
<div class="codehilite"><pre><span></span><span class="c1"># cat auto-clain.yaml</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">PersistentVolumeClaim</span>
<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">metadata</span><span class="p">:</span>
  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">auto-claim</span>
  <span class="nt">annotations</span><span class="p">:</span>
<span class="nt">spec</span><span class="p">:</span>
  <span class="nt">accessModes</span><span class="p">:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">ReadWriteMany</span>
  <span class="nt">resources</span><span class="p">:</span>
    <span class="nt">requests</span><span class="p">:</span>
      <span class="nt">storage</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">1Gi</span>
</pre></div>


<div class="codehilite"><pre><span></span><span class="c1"># kubectl apply -f auto-clain.yaml</span>
persistentvolumeclaim/auto-claim created
</pre></div>


<div class="codehilite"><pre><span></span><span class="c1"># kubectl get pvc</span>
NAME         STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
auto-claim   Bound    pvc-9803c5c5-d2f8-11e9-86f7-525400673e62   1Gi        RWX            nfs-client     13s
</pre></div>


<p>可以看到  PVC 创建成功。</p>
<ul>
<li>在 NFS 的挂载目录中，可以看到自动创建对应的目录。</li>
</ul>
<div class="codehilite"><pre><span></span><span class="c1"># ll</span>
总用量 <span class="m">32</span>
drwxrwxrwx <span class="m">2</span> root root <span class="m">4096</span> 9月   <span class="m">9</span> <span class="m">19</span>:54 default-auto-claim-pvc-9803c5c5-d2f8-11e9-86f7-525400673e62
</pre></div>


<h2 id="1-storageclass">附录 1 : 默认 StorageClass 不生效</h2>
<p>指定了默认的 StorageClass，申请 PVC 不指定 StorageClass 时无法自动创建 PVC。</p>
<h3 id="11">1.1 问题原因</h3>
<p>在 <a href="https://kubernetes.io/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims">PersistentVolumeClaims</a> 中提到如果想实现上述功能，除了指定了默认的 StorageClass 外，还需要开启 <a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/#defaultstorageclass">DefaultStorageClass</a>。</p>
<p>下图是解决问题之后的截图，和出问题是配置的差异是 kube-system 命名空间下的 kube-apiserver Pod 的启动参数中多了 <code>DefaultStorageClass</code>。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/StorageSolution/media/15682537115267.jpg" /></p>
<blockquote>
<p><code>--admission-control</code> was deprecated in <code>1.10</code> and replaced with <code>--enable-admission-plugins</code>.</p>
</blockquote>
<h3 id="12">1.2 如何解决</h3>
<p><a href="https://kubernetes.io/zh/docs/reference/command-line-tools-reference/kube-apiserver/">kube-apiserver</a> 是 <a href="https://kubernetes.io/docs/tasks/configure-pod-container/static-pod/">Static Pod</a>，修改对应配置文件即可。</p>
<p>登录 K8S Master， 在 <code>/etc/kubernetes/manifests/kube-apiserver.manifest</code> 文件的 <code>admission-control</code> 参数后追加 <code>DefaultStorageClass</code>。</p>
<p>将该文件移出、移入当前目录来创建 kube-apiserver POD 。</p>
<p>重新创建 PVC，即可生效。</p><h1 id="mesos">mesos 存储</h1>
<p>目前，BCS mesos 解决方案中，在存储支持上使用 docker 的 volume 存储方案，使用 docker volume 的 bind mount 方式，把宿主机 host 上的一个目录挂载进容器当中。如果要使用 ceph rbd 等分布式块存储，可由 BCS 管理员将 rbd 块存储挂载至集群 node 的某个目录上，然后在创建 mesos 应用时，再把该目录挂载进容器当中。  </p>
<p>以 Ceph rbd 为使用示例来说明：</p>
<h2 id="1">1. 准备存储卷</h2>
<p>管理员创建 ceph rbd 块，把 rbd 块设备 map 到集群 node 节点上，格式化并挂载至某个目录中，如 /mnt/testvolume</p>
<h2 id="2">2. 挂载进容器</h2>
<p>用户在模板集中创建 mesos 应用，在容器配置中指定挂载源为 /mnt/testvolume  </p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/assets/storage/mesosStorage.png" /></p><h1 id="helm">业务接入 Helm</h1>
<p>本文先简单介绍什么是 Helm，以及蓝鲸容器服务（BCS）提供的 Helm 与标准 Helm 的差异，然后以蓝鲸小游戏为例，介绍如何使用蓝鲸容器服务部署您的 Helm Release。</p>
<h2 id="1-helm">1. 什么是 Helm</h2>
<p>Helm 是 Kubernetes 的一个包管理工具，用来简化 Kubernetes 应用的部署和管理。可以把 Helm 比作 CentOS 的 yum 工具。</p>
<p>使用 Helm 可以完成以下事情：</p>
<ul>
<li>管理 Kubernetes manifest files</li>
<li>管理 Helm 安装包 Charts</li>
<li>基于 Chart 的 Kubernetes 应用分发</li>
</ul>
<p>如果您希望进一步了解 Helm，可以阅读 <a href="https://www.kubernetes.org.cn/3435.html">Helm, Kubernetes 的包管理工具</a> 这篇文章。</p>
<blockquote>
<p>蓝鲸容器服务 Helm 中使用了 <code>helm template</code> 生成 Kubernetes YAML, 但是部署没有使用 Helm Tiller，而是直接使用的 <code>kubectl apply</code>。</p>
</blockquote>
<h2 id="2-helm-chart">2. Helm Chart 仓库</h2>
<p>系统会给项目分配 Helm Chart 仓库，用于存放项目的 Chart，仓库的读写操作均需要密码；另外，所有项目只读共享一个公共仓库，用于共享公共资源，比如社区中常用开源组件的部署方案，所有项目对公共仓库享有只读权限。</p>
<p><img alt="-w1628" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/helm/media/15680228351971.jpg" /></p>
<p>如果您有 Chart 需要推送到公共仓库，可以在 Harbor 的页面的 <code>public</code> 项目下的 <code>Helm Charts</code> 上传。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/helm/imgs/img02.png" /></p>
<h2 id="3-helm-chart">3. 推送业务 Helm Chart 到仓库</h2>
<p>推送 Chart 到项目仓库请移步到蓝鲸容器服务的，<code>容器服务</code>/<code>Helm</code>/<code>Chart 仓库</code> 页面，点击右上角 <code>如何推送 Helm Chart 到项目仓库</code> 指引，系统为您的项目生成了对应的 Chart 推送命令，可直接复制使用。</p>
<p><img alt="-w1625" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/helm/media/15680226631931.jpg" /></p>
<p>建议参照指引完成 Helm Chart 的推送。</p>
<p><img alt="-w1632" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/helm/media/15680227175027.jpg" /></p><h1 id="helm">使用 Helm 发布应用</h1>
<h2 id="1-helm-chart">1. 使用蓝鲸容器服务 Helm 部署 Chart</h2>
<p>参考上一步推送完 Chart 之后，您就可以在<code>项目仓库</code>栏目中看到新推送的 Chart，如果没有可以点击<code>同步仓库</code>进行同步。</p>
<ul>
<li>创建入口<ul>
<li><code>容器服务</code>/<code>Helm</code>/<code>Release列表</code>菜单，点击<code>部署Helm Chart</code></li>
<li><code>容器服务</code>/<code>Helm</code>/<code>Chart仓库</code>菜单，选择目标 Chart 点击<code>部署</code></li>
</ul>
</li>
</ul>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/helm/imgs/release_deploy.jpg" /></p>
<p>图：Helm Release 创建人口 - 从<code>Helm</code>/<code>Release列表</code>菜单进入</p>
<p><img src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/helm/imgs/chart_to_deploy.jpg" width="750">
<br/>
图：Helm Release创建入口 - 从<code>Helm</code>/<code>Chart 仓库</code> 菜单进入</p>
<ul>
<li>参数填写<ul>
<li>名称：只能输入字母, 数字或者 <code>-</code></li>
<li>Chart 版本：Chart 版本</li>
<li>命名空间：需要实例化的目标集群+命名空间</li>
<li>用于实例化 Helm Release 的参数，包括直接编辑 yaml 和表单两种方式：<ul>
<li>yaml 文本编辑，相当于给<code>helm template</code>命令传递<code>-f, --values</code>参数</li>
<li>表单，主要为了提升输入体验和参数校验，只有在 Chart 中定义了<code>questions.yaml</code>文件时，创建 Helm Release 页面才会生成根据<code>questions.yaml</code>内容生成表单页面。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/helm/imgs/rumpetroll_deploy.jpg" width="750">
<br/>
图：Helm Release创建参数页面</p>
<ul>
<li>Helm Release 预览<ul>
<li>在真正创建 Helm Release 之前，可以通过 “预览” 功能查看，将要生成的 k8s 资源配置是否符合预期。</li>
</ul>
</li>
</ul>
<p><img src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/helm/imgs/preview_button.jpg" width="750">
<br/>
图：Helm Release创建<code>预览</code>入口</p>
<p><img src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/helm/imgs/preview_source.jpg" width="750">
<br/>
图：Helm Release创建预览页面示例</p>
<ul>
<li>Helm Release 升级-对比查看功能<ul>
<li>相比于创建，针对更新的场景，蓝鲸容器服务提供了对比的功能，可以确认变更内容之后，再执行更新</li>
</ul>
</li>
</ul>
<p><img src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/helm/imgs/release_update.jpg" width="750">
<br/>
图：Helm Release升级-对比查看功能</p>
<ul>
<li>回滚<ul>
<li>针对您对 Helm Release 的变更，蓝鲸容器服务还提供了回滚功能，在 Helm Release 列表中，选中需要回滚 Helm Release 的<code>回滚</code>操作按钮。即可以看到回滚页面，选中会要回滚的版本，确认回滚操作的变更内容即可执行回滚。</li>
</ul>
</li>
</ul>
<p><img src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/helm/imgs/release_rollback.jpg" width="750">
<br/>
图：Helm Release回滚入口</p>
<p><img src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/helm/imgs/release_rollback_version.jpg" width="750">
<br/>
图：Helm Release回滚版本选择</p>
<p><img src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/helm/imgs/rollback_info.jpg" width="750">
<br/>
图：Helm Release回滚对比预览页面</p>
<h2 id="2-helm-release">2. 检查 Helm Release 状态</h2>
<ul>
<li>通过 Helm Release 列表页面查看<ul>
<li>在<code>容器服务</code>/<code>Helm</code>/<code>Release列表</code>页面中，选中<code>查看状态</code>即可查看资源的状态信息。</li>
</ul>
</li>
</ul>
<p><img src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/helm/imgs/release_status.jpg" width="750">
<br/>
图：Helm Release状态查看入口</p>
<p><img src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/helm/imgs/status_detail.jpg" width="750">
<br/>
图：Helm Release状态效果图</p>
<ul>
<li>使用蓝鲸容器服务 WebConsole 功能<ul>
<li>使用蓝鲸容器服务的 WebConsole 功能，您可以不用登录跳板机，直接使用 kubectl 命令查看业务容器的状态。</li>
</ul>
</li>
</ul>
<p><img src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/helm/imgs/webconsole_site.jpg" width="750">
<br/>
图：WebConsole 入口</p>
<p><img src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/helm/imgs/webconsole_detail.jpg" width="750">
<br/>
图：WebConsole 使用效果图</p>
<h2 id="3-helm-release">3. Helm Release 的升级的版本</h2>
<p>通过蓝鲸容器服务对 Helm Release 做升级时，有个默认选中的版本，也就是当前版本，在当前版本的版本号左边有个备注，备注的作用用于说明，Release 所使用的版本，是否发生过变化，或者已经被删除。如下图所示，蓝鲸小游戏 rumpetroll 当前版本是 1.0.0，标记的是 <code>unchanged</code> , 表示当前版本自上一次被当前 Helm Release 使用之后未发生过变化。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/helm/imgs/release_unchange.jpg" /></p>
<ul>
<li><a href="https://github.com/helm/charts">开源 Helm Chart</a></li>
</ul><h1 id="helm">Helm 使用技巧</h1>
<h2 id="1-chart-bcs">1. 在 Chart 中使用 BCS 变量</h2>
<h3 id="11-bcs-helm">1.1 BCS 提供的 Helm 变量</h3>
<ul>
<li>这些变量可以在 helm chart 中通过<code>{{ .Values.__BCS__.Key }}</code>的方式引用。</li>
</ul>
<table>
<thead>
<tr>
<th>Key</th>
<th>Value 示例</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>SYS_JFROG_DOMAIN</td>
<td>xxx</td>
<td>仓库域名</td>
</tr>
<tr>
<td>SYS_CLUSTER_ID</td>
<td>BCS-K8S-XXX</td>
<td>集群 ID</td>
</tr>
<tr>
<td>SYS_PROJECT_ID</td>
<td>xxx</td>
<td>项目 ID</td>
</tr>
<tr>
<td>SYS_CC_APP_ID</td>
<td>1</td>
<td>业务 ID</td>
</tr>
<tr>
<td>SYS_NAMESPACE</td>
<td>default</td>
<td>命名空间</td>
</tr>
</tbody>
</table>
<p>如下两种使用方式支持包含子 Chart 的场景</p>
<h4 id="111-1-chart">1.1.1 方式 1 ：直接在 Chart 中使用</h4>
<div class="codehilite"><pre><span></span><span class="cp">{{</span> <span class="nv">default</span> <span class="s2">&quot;127.0.0.1&quot;</span> <span class="err">$</span><span class="nv">.Values.global.__BCS__.SYS_JFROG_DOMAIN</span> <span class="cp">}}</span><span class="x"></span>
</pre></div>


<h4 id="112-2">1.1.2 方式 2 ：通过模板的方式使用</h4>
<div class="codehilite"><pre><span></span>{{<span class="cm">/*</span>
<span class="cm">domain template</span>
<span class="cm">*/</span>}}
{{<span class="o">-</span> <span class="nv">define</span> <span class="s2">&quot;</span><span class="s">bcsDomain</span><span class="s2">&quot;</span> <span class="o">-</span>}}
    {{<span class="o">-</span> <span class="mh">$defa</span><span class="nv">ult</span> :<span class="o">=</span> <span class="s2">&quot;</span><span class="s">127.0.0.1</span><span class="s2">&quot;</span> <span class="o">-</span>}}
    {{<span class="o">-</span> $<span class="nv">values</span> :<span class="o">=</span> .<span class="nv">Values</span> }}
    {{<span class="o">-</span> <span class="k">if</span> $<span class="nv">values</span> <span class="o">-</span>}}

        {{<span class="o">-</span> $<span class="nv">global</span> :<span class="o">=</span> $<span class="nv">values</span>.<span class="nv">global</span> }}
        {{<span class="o">-</span> <span class="k">if</span> $<span class="nv">global</span> <span class="o">-</span>}}

            {{<span class="o">-</span> <span class="mh">$bc</span><span class="nv">s</span> :<span class="o">=</span> $<span class="nv">global</span>.<span class="nv">__BCS__</span> <span class="o">-</span>}}
            {{<span class="o">-</span> <span class="k">if</span> <span class="mh">$bc</span><span class="nv">s</span> <span class="o">-</span>}}

                {{<span class="o">-</span> <span class="k">if</span> <span class="mh">$bc</span><span class="nv">s</span>.<span class="nv">SYS_JFROG_DOMAIN</span> <span class="o">-</span>}}
                    {{<span class="o">-</span> <span class="mh">$bc</span><span class="nv">s</span>.<span class="nv">SYS_JFROG_DOMAIN</span> <span class="o">-</span>}}
                {{<span class="o">-</span> <span class="k">else</span> <span class="o">-</span>}}
                    {{<span class="o">-</span> <span class="mh">$defa</span><span class="nv">ult</span> <span class="o">-</span>}}
                {{<span class="o">-</span> <span class="k">end</span> <span class="o">-</span>}}

            {{<span class="o">-</span> <span class="k">else</span> <span class="o">-</span>}}
                {{<span class="o">-</span> <span class="mh">$defa</span><span class="nv">ult</span> <span class="o">-</span>}}
            {{<span class="o">-</span> <span class="k">end</span> <span class="o">-</span>}}

        {{<span class="o">-</span> <span class="k">else</span> <span class="o">-</span>}}
            {{<span class="o">-</span> <span class="mh">$defa</span><span class="nv">ult</span> <span class="o">-</span>}}
        {{<span class="o">-</span> <span class="k">end</span> <span class="o">-</span>}}

    {{<span class="o">-</span> <span class="k">else</span> <span class="o">-</span>}}
        {{<span class="o">-</span> <span class="mh">$defa</span><span class="nv">ult</span> <span class="o">-</span>}}
    {{<span class="o">-</span> <span class="k">end</span> <span class="o">-</span>}}
{{<span class="o">-</span> <span class="k">end</span> <span class="o">-</span>}}
</pre></div>


<p>在 Chart 中使用方式如下：</p>
<div class="codehilite"><pre><span></span><span class="cp">{{</span> <span class="nv">template</span> <span class="s2">&quot;bcsDomain&quot;</span> <span class="err">$</span> <span class="cp">}}</span><span class="x"></span>
</pre></div>


<h2 id="2-helm-release-valuesyaml">2. Helm Release 创建时表单与 values.yaml 参数说明</h2>
<ul>
<li>在创建 Helm Release 时，您可以通过填写表单或者直接编辑<code>values.yaml</code>来给 chart 传递参数。</li>
<li>表单是为了提升输入体验（规避错误输入）而引入的一种技术，它的值最终通过<code>--set</code>方式传递给<code>helm template</code>命令（string 类型的值通过 <code>--set-string</code> 传递给 <code>helm template</code>）。</li>
<li>页面编辑的<code>values.yaml</code>默认值是 Chart 中<code>values.yaml</code>文件内容，用于生成 Helm Release 时并不会替换 Chart 中的<code>values.yaml</code>文件，而是通过<code>--values</code>参数传递给<code>helm template</code>命令。</li>
<li>优先级问题<ul>
<li>为了消除您对参数优先级的困惑，我们通过一种双向同步的技术，将最新修改的输入源同步到另外一个输入源。比如，您在 form 表单中修改了镜像的 tag，当 form 表单失去焦点时，这个 tag 值会同步到<code>values.yaml</code>中，对应的，如果您接着编辑<code>values.yaml</code>的值，文本内容的变化也会自动反应到 form 表单中。</li>
</ul>
</li>
</ul><h1 id="helm-questionsyaml">如何编写 Helm <code>questions.yaml</code></h1>
<h2 id="1-helm-questionsyaml">1. Helm questions.yaml 是什么</h2>
<p>Helm 是一个软件包管理器，提供了一种简单的方法来查找、共享和使用为 Kubernetes 而构建的软件。它提供 key-value 或者 <code>values.yaml</code> 用于设置 Helm 应用的实例化参数。</p>
<p><code>questions.yaml</code> 是为了提高蓝鲸容器服务中 Helm 功能的易用性，参考开源产品 <code>Rancher</code> 提供的一种动态表单生成技术。</p>
<p>用户可在 Chart 中提供 <code>questions.yaml</code> 文件，在蓝鲸容器服务产品中实例化 helm 应用的时候，蓝鲸容器服务会根据 <code>questions.yaml</code> 生成表单供用户输入实例化参数。</p>
<p>如下图所示，即为一个包含了 <code>questions.yaml</code> 的 Chart：</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/helm/imgs/15422121558476.jpg" /></p>
<h2 id="2">2. 可以干什么</h2>
<p>为了说明 <code>questions.yaml</code> 可以提供什么样的动态表单，下面先展示一个 <code>questions.yaml</code> 内容段用于说明。</p>
<div class="codehilite"><pre><span></span><span class="p p-Indicator">-</span> <span class="nt">variable</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">persistence.enabled</span>
  <span class="nt">default</span><span class="p">:</span> <span class="s">&quot;false&quot;</span>
  <span class="nt">description</span><span class="p">:</span> <span class="s">&quot;Enable</span><span class="nv"> </span><span class="s">persistent</span><span class="nv"> </span><span class="s">volume</span><span class="nv"> </span><span class="s">for</span><span class="nv"> </span><span class="s">WordPress&quot;</span>
  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">boolean</span>
  <span class="nt">required</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="nt">label</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">WordPress Persistent Volume Enabled</span>
  <span class="nt">show_subquestion_if</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="nt">group</span><span class="p">:</span> <span class="s">&quot;WordPress</span><span class="nv"> </span><span class="s">Settings&quot;</span>
  <span class="nt">subquestions</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">variable</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">persistence.size</span>
    <span class="nt">default</span><span class="p">:</span> <span class="s">&quot;10Gi&quot;</span>
    <span class="nt">description</span><span class="p">:</span> <span class="s">&quot;WordPress</span><span class="nv"> </span><span class="s">Persistent</span><span class="nv"> </span><span class="s">Volume</span><span class="nv"> </span><span class="s">Size&quot;</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">string</span>
    <span class="nt">label</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">WordPress Volume Size</span>
  <span class="p p-Indicator">-</span> <span class="nt">variable</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">persistence.storageClass</span>
    <span class="nt">default</span><span class="p">:</span> <span class="s">&quot;&quot;</span>
    <span class="nt">description</span><span class="p">:</span> <span class="s">&quot;If</span><span class="nv"> </span><span class="s">undefined</span><span class="nv"> </span><span class="s">or</span><span class="nv"> </span><span class="s">null,</span><span class="nv"> </span><span class="s">uses</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">default</span><span class="nv"> </span><span class="s">StorageClass.</span><span class="nv"> </span><span class="s">Default</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">null&quot;</span>
    <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">storageclass</span>
    <span class="nt">label</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Default StorageClass for WordPress</span>
</pre></div>


<p>上面这段配置在用户创建或者更新 helm 应用的时候一个如下表单，</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/helm/imgs/1.png" /></p>
<p>该表单包含一个 radio 用于设置是否使用可持久化存储。如果用户选中使用可持久化存储，<code>storage class</code> 和 <code>volume size</code> 就可以用来供用户填写对应的存储类和卷大小。</p>
<h2 id="3">3. 使用场景</h2>
<ul>
<li>业务相对稳定之后，把常规发布经常修改的参数项设置成 Form 表单</li>
<li>产品自助，如果希望让产品自行发布，表单是个不错的选择</li>
<li>防止错误输入，为了尽量减少拼写错误，您可以为输入项设置校验规则</li>
</ul>
<h2 id="4">4. 如何编写</h2>
<table>
<thead>
<tr>
<th>Variable</th>
<th>Type</th>
<th>Required</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>variable</td>
<td>string</td>
<td>true</td>
<td>申明该表单值对应于 <code>values.yaml</code> 中的字断, 及联字段使用 <code>.</code> 进行隔开，比如 <code>persistence.enabled</code>.</td>
</tr>
<tr>
<td>label</td>
<td>string</td>
<td>true</td>
<td>表单项的标签 <code>label</code>.</td>
</tr>
<tr>
<td>description</td>
<td>string</td>
<td>false</td>
<td>关于变量的特别说明.</td>
</tr>
<tr>
<td>type</td>
<td>string</td>
<td>false</td>
<td>表单值的字断类型，默认是 <code>string</code> 类型 (当前支持的字断的类型为： string, boolean, int, enum, password, storageclass and hostname).</td>
</tr>
<tr>
<td>required</td>
<td>bool</td>
<td>false</td>
<td>申明该字断是否是必填项 (真/假)</td>
</tr>
<tr>
<td>default</td>
<td>string</td>
<td>false</td>
<td>设置默认值.</td>
</tr>
<tr>
<td>group</td>
<td>string</td>
<td>false</td>
<td>输入项所属的组.</td>
</tr>
<tr>
<td>min_length</td>
<td>int</td>
<td>false</td>
<td>最小字符串长度.</td>
</tr>
<tr>
<td>max_length</td>
<td>int</td>
<td>false</td>
<td>最大字符串长度.</td>
</tr>
<tr>
<td>min</td>
<td>int</td>
<td>false</td>
<td>最小整数长度.</td>
</tr>
<tr>
<td>max</td>
<td>int</td>
<td>false</td>
<td>最大整数长度.</td>
</tr>
<tr>
<td>options</td>
<td>[]string</td>
<td>false</td>
<td>如果变量类型是 <code>enum</code> 类型, 该字断用于设置可选项，比如选项:<br> - "ClusterIP" <br> - "NodePort" <br> - "LoadBalancer"</td>
</tr>
<tr>
<td>valid_chars</td>
<td>string</td>
<td>false</td>
<td>有效输入字符串校验.</td>
</tr>
<tr>
<td>invalid_chars</td>
<td>string</td>
<td>false</td>
<td>无效输入字符串的校验.</td>
</tr>
<tr>
<td>subquestions</td>
<td>[]subquestion</td>
<td>false</td>
<td>数组类型，用户包含子问题.</td>
</tr>
<tr>
<td>show_if</td>
<td>string</td>
<td>false</td>
<td>控制是否显示当前输入项, 比如 <code>show_if: "serviceType=Nodeport"</code></td>
</tr>
<tr>
<td>show_subquestion_if</td>
<td>string</td>
<td>false</td>
<td>如果当前值为 <code>true</code> 或者可选项的值，则该子问题会被显示出来. 比如 <code>show_subquestion_if: "true"</code></td>
</tr>
</tbody>
</table>
<p><strong>subquestions</strong>: <code>subquestions[]</code> 除了不能包含 <code>subquestions</code> 或者 <code>show_subquestions_if</code> 字段, 上表中的其它字断均支持.</p><h1 id="webconsole">WebConsole 说明</h1>
<h2 id="1-webconsole">1. WebConsole 简介</h2>
<p>WebConsole 是容器服务提供快捷查看集群状态的命令行服务</p>
<p>kubectl 是 K8S 官方的命令行工具，用于管理 K8S 集群，用户添加完节点，部署完 Deployments, Helm 等，都可以通过 WebConsole 内的 kubectl 命令工具查看节点，Deployment 等信息</p>
<p>注意： <code>WebConsole 目前只支持K8S集群</code></p>
<h2 id="2-webconsole">2. WebConsole 使用</h2>
<p>进入容器服务，在任意页面右下角，选择对应集群进入 WebConsole。</p>
<p><img alt="-w1560" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/web_console/media/15675992084889.jpg" /></p>
<p>大概 1 秒钟打开 WebConsole ，背后实际是启动了一个 WebConsole 的 Pod。</p>
<p>在 WebConsole 中可以使用 kubectl 命令操作集群。</p>
<p><img alt="-w1157" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/web_console/media/15675996254116.jpg" /></p>
<h2 id="3-kubectl">3. kubectl 常用命令介绍</h2>
<h3 id="31">3.1 查询集群信息</h3>
<div class="codehilite"><pre><span></span>kubectl cluster-info
</pre></div>


<h3 id="32-kubectl-get">3.2 Kubectl Get</h3>
<p><strong>获取 K8S 集群资源列表</strong>，包含 Nodes、Namespaces、Pods、Deployment、Services 等。</p>
<ul>
<li>查询 Node 节点信息</li>
</ul>
<div class="codehilite"><pre><span></span>kubectl get nodes
</pre></div>


<ul>
<li>获取 NameSpace 信息</li>
</ul>
<div class="codehilite"><pre><span></span>kubectl get namespace
</pre></div>


<ul>
<li>查询 Pods 列表</li>
</ul>
<div class="codehilite"><pre><span></span>kubectl get pods
</pre></div>


<ul>
<li>以 JSON 格式输出 Pod 的详细信息</li>
</ul>
<div class="codehilite"><pre><span></span>kubectl get pod &lt;podname&gt; -o json
</pre></div>


<ul>
<li>查询打印 DEBUG 信息</li>
</ul>
<div class="codehilite"><pre><span></span>kubectl get pods -v<span class="o">=</span><span class="m">11</span>
</pre></div>


<h3 id="32-kubectl-describe">3.2 Kubectl Describe</h3>
<p>获取<strong>集群资源的详情</strong>，在排查故障的非常有用，例如某一个 Pod 无法启动。</p>
<div class="codehilite"><pre><span></span>kubectl describe pod &lt;podname&gt;
</pre></div>


<h3 id="33-help">3.3 Help 查看帮助</h3>
<div class="codehilite"><pre><span></span>kubectl --help
</pre></div>


<p>kubectl 的帮助信息、示例相当详细，而且简单易懂。</p>
<p>更多 kubectl 使用说明请参照 <a href="https://kubernetes.io/docs/reference/generated/kubectl/kubectl-commands">Kubectl 操作手册</a>。</p><h1 id="_1">快速入门</h1>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/QuickStart/media/15290519660825.jpg" /></p>
<p>此外，场景案例中的 <a href="../Scenes/Bcs_deploy_nginx_cluster.md">如何构建 Nginx 集群</a> 也可以实现快速上手 BCS。</p>
<h2 id="1">1. 登录蓝鲸容器服务控制台</h2>
<p>登录蓝鲸容器服务控制台。</p>
<h2 id="2">2. 创建项目（也可选择已有项目）</h2>
<ul>
<li>创建新项目：进入项目管理页面，点击“创建新项目”按钮，完成项目创建操作</li>
<li>获取已有项目权限：进入蓝鲸权限中心，申请加入已有项目用户组来获取项目使用权限</li>
</ul>
<p><strong>关键项说明：</strong>
- 当您选择使用蓝鲸容器服务部署业务，创建项目后，进入容器服务，还需要关联“蓝鲸配置平台（CMDB）”上的某个业务，该项目集群节点将从该业务机器资源池中拉取
- 您可以根据业务情况，选择使用容器编排类型为 Kubernetes 或 Mesos（注意：一旦创建集群后，容器编排类型将不可更改）</p>
<p><strong>项目管理：</strong>
您可以在项目管理页面管理您的项目基础信息。</p>
<h2 id="3">3. 创建集群</h2>
<p>在容器服务左侧导航中点击“集群”进入集群管理页面，点击“创建集群”按钮。</p>
<p><strong>关键项说明：</strong>
- 集群 Master 节点为奇数个，最少 1 个，最多 7 个
- 创建集群，系统将对主机做以下初始化操作：
    - 机器前置检查
    - 安装蓝鲸容器服务初始化包
    - 安装蓝鲸容器服务基础组件
- Master 要求：
    - 机器配置：至少 Cpu/内存为 4 核/8G
    - 系统版本：CentOS 7 及以上系统（内核版本 3.10.0-693 及以上），推荐 CentOS 7.4</p>
<h2 id="4">4. 添加集群节点</h2>
<p>集群创建成功后，您可以进入集群节点列表，为集群增加节点。</p>
<p><strong>关键项说明：</strong>
- Node 要求：
    - 系统版本：CentOS 7 及以上系统（内核版本 3.10.0-693 及以上），推荐 CentOS 7.4
    - NAT 模块：确认 NAT 模块已安装</p>
<h2 id="5">5. 创建命名空间</h2>
<p>在容器服务左侧导航中点击“配置”—》“命名空间”，点击“新建命名空间”按钮，创建指定集群的命名空间信息（创建服务实例将以集群命名空间维度创建）。</p>
<p><code>注意: 创建命名空间后，名称不允许修改</code></p>
<h2 id="6">6. 创建服务实例</h2>
<p>新建项目，系统将初始“示例模板集”到您的项目模板集库中，您可以直接使用该模板集体验操作。</p>
<p>示例模板集：
- 是蓝鲸提供的《吃豆小游戏》模板配置，您可以查看该模板配置详情，对模板的使用有一个初步概念
- 模板集中使用了镜像仓库提供的公共镜像，您可以在容器服务左侧导航中点击“仓库”查看，并推送您的项目镜像到项目私有镜像仓库</p>
<p>创建服务应用实例：
- 进入“示例模板集”，点击“实例化”按钮进入实例化页面
- 选择模板集，选择集群命名空间
- 点击“创建”按钮</p>
<h2 id="7">7. 确认完成</h2>
<p>《吃豆小游戏》已经部署完成，您可以在容器服务左侧导航中点击“应用”，查看小游戏服务应用实例。
<img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/QuickStart/assets/rumpetroll_game/game_app.jpg" /></p>
<p>接下来，您可以体验吃豆小游戏：</p>
<ul>
<li>在<code>deploy-nginx</code>应用详情页面查看<code>Host IP</code>，也就是接入层的 IP</li>
<li>将链接 <code>http://HOST_IP/rumpetroll/?openid=is__superuser&amp;token=tPp5GwAmMPIrzXhyyA8X</code> 中的 <code>HOST_IP</code>替换为接入层 IP(如下图红框部分)，访问即可体验</li>
</ul>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/Function/assets/rumpetroll_game/nginx_app.jpg" /></p>
<p>您可以尝试：
- 在线滚动升级小游戏
- 在线扩缩容小游戏服务实例
- 在线删除或重建小游戏服务实例</p>
<h2 id="8">8. 小游戏使用说明</h2>
<p>部署完成后，用户可以登入小游戏试玩使用</p>
<p>注意：下面 token 默认为<code>tPp5GwAmMPIrzXhyyA8X</code></p>
<h3 id="81-pc">8.1 PC 登入地址</h3>
<blockquote>
<p><code>http://{domain}/rumpetroll/?openid=is__superuser&amp;token={token}</code></p>
</blockquote>
<p>PC 登入可以显示倒计时页面，管理员或者投放到大屏使用</p>
<h3 id="82">8.2 玩家登入地址</h3>
<blockquote>
<p><code>http://{domain}/rumpetroll/</code></p>
</blockquote>
<p>普通玩家使用上面地址登入游戏</p>
<h3 id="83">8.3 游戏开启和关闭</h3>
<p>默认情况下，游戏是关闭的，可以调用 API 开启，关闭游戏</p>
<div class="codehilite"><pre><span></span><span class="c1"># 开启游戏</span>
curl -X POST -H <span class="s1">&#39;Content-Type: application/x-www-form-urlencoded&#39;</span> -d <span class="s1">&#39;func_code=is_start&amp;enabled=1&#39;</span> <span class="s1">&#39;http://{domain}/rumpetroll/api/func_controller/?token={token}&#39;</span>

<span class="c1"># 关闭游戏</span>
curl -X POST -H <span class="s1">&#39;Content-Type: application/x-www-form-urlencoded&#39;</span> -d <span class="s1">&#39;func_code=is_start&amp;enabled=0&#39;</span> <span class="s1">&#39;http://{domain}/rumpetroll/api/func_controller/?token={token}&#39;</span>

<span class="c1"># 获取开关状态</span>
curl -X GET <span class="s1">&#39;http://{domain}/rumpetroll/api/func_controller/?token={token}&amp;func_code=is_start&#39;</span>
</pre></div>


<h3 id="84">8.4 发送豆子</h3>
<p>可以调用 API 发送豆子，用户角色吃掉豆子后，体型有变大效果</p>
<div class="codehilite"><pre><span></span><span class="c1"># 发送豆子, num 是发送豆子数量</span>
curl -X GET <span class="s1">&#39;http://{domain}/rumpetroll/api/gold/?token={token}&amp;num={num}&#39;</span>
</pre></div>


<p>注意：发送完成后，PC 端会自动进入倒计时，默认 3 分钟</p>
<h3 id="85">8.5 游戏统计地址</h3>
<ul>
<li>在线统计:  http://{domain}/rumpetroll/api/stat/?token={token}&amp;meter=online</li>
<li>吃豆排名统计:  http://{domain}/rumpetroll/api/stat/?token={token}&amp;meter=online</li>
<li>豆子剩余数量：http://{domain}/rumpetroll/api/stat/?token={token}&amp;meter=golds</li>
</ul>
<h3 id="85_1">8.5 重置数据</h3>
<p>使用 <code>web-console</code> 登入到 redis 所在 pod 中，清空 redis 数据即可</p>
<div class="codehilite"><pre><span></span>redis-cli flushall
</pre></div><h1 id="nginx">快速构建 Nginx 集群</h1>
<h4 id="_1">情景</h4>
<p>传统的 Nginx 集群要先部署多个 Nginx 节点，然后通过 <code>upstream</code> 统一一个入口提供给用户访问。</p>
<p>该过程操作繁琐，接下来看 BCS（容器管理平台） 如何通过 <strong>容器调度 (以 K8S 编排为例，BCS 同时还支持 Mesos)</strong> 快速构建 Nginx 集群。</p>
<h4 id="_2">前提条件</h4>
<ul>
<li>
<p><a href="https://kubernetes.io/zh/docs/concepts/">K8S 基本概念</a>，包含  <a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/deployment/">Deployment</a>、<a href="https://kubernetes.io/docs/concepts/services-networking/service/">Services</a>。</p>
</li>
<li>
<p><a href="5.1/部署维护/增强包安装/机器评估/bcs_evaluate.md">完成 BCS 部署</a></p>
</li>
<li>准备 2 台云主机：4 核 8 G，不低于 CentOS 7，K8s Master 和 Node 各 1 台</li>
<li>完成上述 2 台云主机的 <a href="5.1/节点管理/快速入门/agent0.md">Agent 安装</a> ，并分配至  <a href="5.1/配置平台/产品功能/Resource.md">CMDB 业务下</a></li>
</ul>
<h4 id="_3">操作步骤</h4>
<ol>
<li>
<p>新建集群</p>
</li>
<li>
<p>BCS 快速构建 Nginx 集群</p>
</li>
</ol>
<h2 id="1">1. 新建集群</h2>
<h3 id="11">1.1 启用容器服务</h3>
<p>在 BCS 首页，点击<code>新建项目</code>，如<code>欢乐游戏(demo)</code>。</p>
<p><img alt="-w1378" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15648362836651.jpg" /></p>
<p>然后选择容器编排类型为 <code>Kubernetes</code> ，关联 <em>前提条件</em> 中提到的 CMDB 业务，点击<code>启用容器服务</code>。</p>
<p><img alt="-w1304" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15648364147641.jpg" /></p>
<h3 id="12">1.2 新建集群</h3>
<p><code>启用容器服务</code>后，进入容器服务欢迎页，点击<code>创建容器集群</code>。</p>
<p><img alt="-w1361" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15648365448905.jpg" /></p>
<p>按提示填写集群的基本信息。</p>
<p><img alt="-w1368" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15648366557109.jpg" /></p>
<blockquote>
<p>容器服务的集群划分和<a href="5.1/bk_solutions/CD/CMDB/CMDB_management_hosts.md">传统单体应用在 CMDB 中的集群划分</a>很类似，可以按照<code>地域（如华北区）</code>或者<code>完全独立的应用集合（微信区）</code>来划分。</p>
</blockquote>
<p>选择 1 台云主机作为 Master。</p>
<p><img alt="-w1368" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15648366389029.jpg" /></p>
<p>点击<code>确定</code>后，集群开始初始化。</p>
<p><img alt="-w1368" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15648367382011.jpg" /></p>
<p>点击<code>节点管理</code></p>
<p><img alt="-w1363" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15648839802641.jpg" /></p>
<p>点击<code>添加节点</code>，按提示节点添加。</p>
<p><img alt="-w1368" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15648840282881.jpg" /></p>
<p>至此，新建集群完毕。可以看到集群的基础信息。</p>
<p><img alt="-w1487" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15648861584543.jpg" /></p>
<p>另外，在集群的设置(<strong>⋮</strong>)下拉菜单中，可以看到集群主要性能指标。</p>
<p><img alt="-w1488" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15648861821783.jpg" /></p>
<h2 id="2-bcs-nginx">2. BCS 快速构建 Nginx 集群</h2>
<h3 id="21">2.1 新建命名空间</h3>
<p>新建命名空间<code>dev</code></p>
<p><img alt="-w1462" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15652519427953.jpg" /></p>
<h3 id="22">2.2 新建模板集</h3>
<p>模板集，可以类比为 K8S 中 <strong><a href="https://helm.sh/">Helm</a></strong> 的<code>Charts</code>，在 K8S 编排中，是 K8S 对象的集合：<code>Deployment（无状态）</code>、<code>StatefulSet（有状态）</code>、<code>DaemonSet（守护进程集）</code>、<code>Job（定时任务）</code>、<code>Configmap（配置项）</code>、<code>Secret（保密字典）</code>，具体参见 <a href="5.1/bcs/Function/TemplateIntroduce.md">模板集使用介绍</a> 。</p>
<p>打开菜单<code>[模板集]</code>，新建模板集<code>web-nginx</code>。</p>
<p><img alt="-w1466" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15652520004880.jpg" /></p>
<p>按提示，填写<code>Deployment</code></p>
<p><img alt="-w1465" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15652532175601.jpg" />
<img alt="-w1462" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15652535815272.jpg" /></p>
<p>填写<code>Service</code></p>
<p><img alt="-w1458" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15652542476126.jpg" /></p>
<h3 id="23">2.3 实例化</h3>
<p><img alt="-w1470" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15652543011285.jpg" />
<img alt="-w1466" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15652545088426.jpg" /></p>
<h3 id="24">2.4 检查部署效果</h3>
<p>在菜单<code>网络</code> -&gt; <code>Services</code>中，找到刚实例化的 Service <code>web-nginx</code></p>
<p><img alt="-w1465" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15652551496895.jpg" /></p>
<p>在菜单<code>[应用]</code> -&gt; <code>[Deployment]</code>中可以找到 <code>web-nginx</code></p>
<p><img alt="-w1464" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15652552229901.jpg" /></p>
<p>以及其运行指标</p>
<p><img alt="-w1463" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15652552369974.jpg" /></p>
<p>通过访问 <code>Node+NodePort</code>，可以查看刚刚部署 Nginx 集群的版本号。</p>
<div class="codehilite"><pre><span></span><span class="o">[</span>root@ip-10-0-5-94-n-bcs-k8s-40015 ~<span class="o">]</span><span class="c1"># curl 10.0.5.94:30008 -I</span>
HTTP/1.1 <span class="m">200</span> OK
Server: nginx/1.12.2
Date: Thu, <span class="m">08</span> Aug <span class="m">2019</span> <span class="m">09</span>:11:42 GMT
</pre></div>


<p>通过访问<code>Service IP + Port</code>，也可以查看刚部署 Nginx 的版本号。</p>
<div class="codehilite"><pre><span></span><span class="o">[</span>root@ip-10-0-5-94-n-bcs-k8s-40015 ~<span class="o">]</span><span class="c1"># curl 10.254.11.4:8088 -I</span>
HTTP/1.1 <span class="m">200</span> OK
Server: nginx/1.12.2
Date: Thu, <span class="m">08</span> Aug <span class="m">2019</span> <span class="m">09</span>:12:33 GMT
Content-Type: text/html
Content-Length: <span class="m">612</span>
Last-Modified: Tue, <span class="m">11</span> Jul <span class="m">2017</span> <span class="m">13</span>:29:18 GMT
Connection: keep-alive
ETag: <span class="s2">&quot;5964d2ae-264&quot;</span>
Accept-Ranges: bytes
</pre></div><h1 id="_1">应用的滚动升级</h1>
<h4 id="_2">情景</h4>
<p>传统的应用更新方式是停服更新，用户在更新期间<strong>无法使用服务</strong>。</p>
<p>接下来，将以 Nginx 从<code>1.12.2</code>升级<code>1.17.0</code>为例，看 BCS 中的<strong>滚动更新能力</strong>是如何实现<strong>不停机更新</strong>，<strong>用户无感知</strong>。</p>
<h4 id="_3">前提条件</h4>
<ul>
<li>
<p><a href="https://kubernetes.io/zh/docs/concepts/">K8S 基本概念</a>，包含 <a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/deployment/">Deployment</a>、<a href="https://kubernetes.io/docs/concepts/services-networking/service/">Services</a>。</p>
</li>
<li>
<p><a href="5.1/部署维护/增强包安装/机器评估/bcs_evaluate.md">完成 BCS 部署</a></p>
</li>
</ul>
<h4 id="_4">操作步骤</h4>
<ol>
<li>
<p>滚动更新逻辑介绍</p>
</li>
<li>
<p>BCS 滚动更新操作指引</p>
</li>
</ol>
<h2 id="1">1. 滚动更新逻辑介绍</h2>
<p>滚动更新的逻辑如下图，创建一个新版本的实例（ POD），销毁一个旧版本实例（POD），如此滚动，直至线上都是新版本，旧版本已全部销毁。</p>
<p>滚动更新对用户无感知。</p>
<p><img alt="w1549" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15652581859764.jpg" /></p>
<h2 id="2-bcs">2. BCS 滚动更新操作指引</h2>
<h4 id="21-nginx1170">2.1 推送 Nginx:1.17.0 至镜像仓库</h4>
<p>参照 <a href="5.1/bcs/Function/HarborGuide.md">Harbor 仓库使用指南</a>，将镜像 Nginx:1.17.0 推送至 BCS 公共镜像仓库。</p>
<h4 id="211">2.1.1 注册镜像仓库账号</h4>
<p>在<a href="5.1/部署维护/增强包安装/机器评估/bcs_evaluate.md">部署 BCS</a> 的中控机上获取镜像仓库的访问地址。</p>
<div class="codehilite"><pre><span></span><span class="c1"># source /data/install/utils.fc &amp;&amp; echo ${HARBOR_SERVER_FQDN}:${HARBOR_SERVER_HTTPS_PORT}</span>
hub-d.o.******.com:443
</pre></div>


<p>登录仓库地址，注册镜像仓库账号。</p>
<p><img alt="w1051" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15652566855628.jpg" /></p>
<p>注册完，登录后可以访问公共仓库。</p>
<p><img alt="w1478" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15652567813655.jpg" /></p>
<h4 id="212-nginx1170">2.1.2 推送 Nginx:1.17.0 至镜像仓库</h4>
<p>使用<code>docker pull</code> 从<code>hub.docker.com</code>拉取镜像<code>nginx:1.17.0</code>。</p>
<div class="codehilite"><pre><span></span><span class="c1"># docker pull nginx:1.17.0</span>
<span class="m">1</span>.17.0: Pulling from library/nginx
fc7181108d40: Pull <span class="nb">complete</span>
c4277fc40ec2: Pull <span class="nb">complete</span>
780053e98559: Pull <span class="nb">complete</span>
Digest: sha256:bdbf36b7f1f77ffe7bd2a32e59235dff6ecf131e3b6b5b96061c652f30685f3a
Status: Downloaded newer image <span class="k">for</span> nginx:1.17.0
</pre></div>


<p>规范镜像<code>tag</code>为仓库要求的格式。</p>
<div class="codehilite"><pre><span></span><span class="c1"># docker tag nginx:1.17.0 hub-d.******.com/public/nginx:1.17.0</span>

<span class="c1"># docker images</span>
REPOSITORY                                                                TAG                  IMAGE ID            CREATED             SIZE
nginx                                                                     <span class="m">1</span>.17.0               719cd2e3ed04        <span class="m">8</span> weeks ago         109MB
hub-d.******.com/public/nginx                                           <span class="m">1</span>.17.0               719cd2e3ed04        <span class="m">8</span> weeks ago         109MB
</pre></div>


<p>推动镜像至 BCS 镜像仓库。</p>
<div class="codehilite"><pre><span></span><span class="c1"># docker push hub-d.******.com/public/nginx:1.17.0</span>
The push refers to repository <span class="o">[</span>hub-d.******.com/public/nginx<span class="o">]</span>
d7acf794921f: Pushed
d9569ca04881: Pushed
cf5b3c6798f7: Pushed
<span class="m">1</span>.17.0: digest: sha256:079aa93463d2566b7a81cbdf856afc6d4d2a6f9100ca3bcbecf24ade92c9a7fe size: <span class="m">948</span>
</pre></div>


<p>在镜像仓库中，可以找到刚推送的<code>Nginx:1.17.0</code>镜像。</p>
<p><img alt="w1465" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15652572564612.jpg" /></p>
<p>在 BCS 的<code>[仓库菜单]</code>中也可以找到。</p>
<p><img alt="w1462" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15652575817580.jpg" /></p>
<h3 id="22-nginx-1122-1170">2.2 滚动升级 Nginx ：从 1.12.2 到 1.17.0</h3>
<p>确认当前版本号为<code>nginx/1.12.2</code></p>
<div class="codehilite"><pre><span></span><span class="o">[</span>root@ip-10-0-5-94-n-bcs-k8s-40015 ~<span class="o">]</span><span class="c1"># curl 10.0.5.94:30008 -I</span>
HTTP/1.1 <span class="m">200</span> OK
Server: nginx/1.12.2
Date: Thu, <span class="m">08</span> Aug <span class="m">2019</span> <span class="m">09</span>:11:42 GMT
</pre></div>


<p>在【模板集】的【Deployment】页面中，修改【镜像及版本】，将版本从<code>1.12.2</code>修改为在 <em>推送 Nginx:1.17.0</em> 至镜像仓库 中上传的 Nginx 新镜像 <code>1.17.0</code>。</p>
<p><img alt="w1633" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15652627456802.jpg" /></p>
<p>点击【更多设置】，了解默认滚动升级的更新策略。</p>
<p><img alt="w1269" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15659379375124.jpg" /></p>
<blockquote>
<ul>
<li><code>maxUnavailable</code> : 滚动升级期间，考虑应用容量，不可用 Pod 的数量上限</li>
<li><code>maxSurge</code> : 滚动升级期间，考虑集群资源，超出期望 Pod 的数量上限</li>
<li><code>minReadySeconds</code> : 滚动升级期间，考虑可用性，探测 Pod 正常后转为可用的时间  </li>
</ul>
</blockquote>
<p>修改完镜像的版本后，接下来【保存】模板集，填写【新版本】的版本号。</p>
<p><img alt="w1633" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15652627905254.jpg" /></p>
<p>接着，开始滚动升级。点击菜单【应用】 -&gt; 【Deployment】，找到<code>web-nginx</code>应用，点击【滚动升级】。</p>
<p><img alt="w1637" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15652616938580.jpg" /></p>
<p>可以看到，差异点是<code>images</code>从<code>nginx:1.12.2</code>调整为<code>nginx:1.17.0</code></p>
<p><img alt="w1637" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15652628433125.jpg" /></p>
<p>点击【确定】滚动升级后，正在更新。</p>
<p><img alt="w1636" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15652628788988.jpg" /></p>
<p>通过 右下角的 【Web console】 可以通过命令行的方式获取实例(POD)的基础信息。</p>
<p><img alt="w1636" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15652622109567.jpg" /></p>
<p>以下是更新前后的对比</p>
<div class="codehilite"><pre><span></span>root:~$ kubectl get pods -n dev -o wideNAME                         READY   STATUS    RESTARTS   AGE    IP            NODE                           NOMINATED NODE
web-nginx-678bb9c4fb-m8cf4   <span class="m">1</span>/1     Running   <span class="m">0</span>          134m   <span class="m">172</span>.32.1.18   ip-10-0-5-94-n-bcs-k8s-40015   &lt;none&gt;
web-nginx-678bb9c4fb-nxwf4   <span class="m">1</span>/1     Running   <span class="m">0</span>          134m   <span class="m">172</span>.32.1.17   ip-10-0-5-94-n-bcs-k8s-40015   &lt;none&gt;

root:~$ kubectl get pods -n dev -o wide
NAME                        READY   STATUS    RESTARTS   AGE   IP            NODE                           NOMINATED NODE
web-nginx-f95ffc78d-cxhrq   <span class="m">1</span>/1     Running   <span class="m">0</span>          21s   <span class="m">172</span>.32.1.20   ip-10-0-5-94-n-bcs-k8s-40015   &lt;none&gt;
web-nginx-f95ffc78d-pqtcj   <span class="m">1</span>/1     Running   <span class="m">0</span>          14s   <span class="m">172</span>.32.1.21   ip-10-0-5-94-n-bcs-k8s-40015   &lt;none&gt;
</pre></div>


<p>可以看到<code>Nginx</code>版本已经从<code>1.12.2</code>更新为<code>1.17.0</code></p>
<div class="codehilite"><pre><span></span><span class="o">[</span>root@ip-10-0-5-94-n-bcs-k8s-40015 ~<span class="o">]</span><span class="c1"># curl 10.0.5.94:30008 -I</span>
HTTP/1.1 <span class="m">200</span> OK
Server: nginx/1.17.0
</pre></div><h1 id="_1">应用的蓝绿发布</h1>
<h4 id="_2">情景</h4>
<p>传统的应用更新方式是<strong>停服更新</strong>，用户在更新期间<strong>无法使用服务</strong>。</p>
<p>接下来，将以 Nginx 从 <code>1.12.2</code> 升级 <code>1.17.0</code> + 程序代码（index.html 的内容从 Nginx 默认页 更新为 1.17.0）为例，看 BCS 中的<strong>蓝绿发布能力</strong>是如何实现<strong>不停机更新</strong>，<strong>用户无感知</strong>。</p>
<h4 id="_3">前提条件</h4>
<ul>
<li>
<p><a href="https://kubernetes.io/zh/docs/concepts/">K8S 基本概念</a>，包含 <a href="https://kubernetes.io/zh/docs/concepts/workloads/controllers/deployment/">Deployment</a>、<a href="https://kubernetes.io/docs/concepts/services-networking/service/">Services</a>；本节教程新增概念：<a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/">ConfigMap</a>、<a href="https://kubernetes.io/docs/concepts/services-networking/ingress/">Ingress</a>、<a href="https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/">Ingress Controllers</a>。</p>
</li>
<li>
<p><a href="5.1/部署维护/增强包安装/机器评估/bcs_evaluate.md">完成 BCS 部署</a></p>
</li>
</ul>
<h4 id="_4">操作步骤</h4>
<ol>
<li>
<p>应用的蓝绿发布逻辑介绍</p>
</li>
<li>
<p>使用 K8S 资源准备版本</p>
</li>
<li>
<p>使用 K8S 资源准备新版本</p>
</li>
<li>
<p>切换流量并观察</p>
</li>
</ol>
<h2 id="1">1. 蓝绿发布逻辑介绍</h2>
<h3 id="11">1.1 发布逻辑示意图</h3>
<p>蓝绿发布，即准备 <em>当前运行版本</em> 和 <em>新版本</em> 两组实例，正式发布的时候，修改服务的域名的 DNS 记录将，将其指向新版本的 Ingress 指向的地址 。</p>
<p><img alt="-w1303" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15680799749131.jpg" /></p>
<h3 id="12">1.2 版本更新流程中引入的对象</h3>
<p>以 Nginx 从 <code>1.12.2</code> 升级 <code>1.17.0</code> + 程序代码（index.html 的内容从 Nginx 默认页 更新为 1.17.0）为例，使用以下几个 新的对象：</p>
<ul>
<li>程序代码或可执行文件（index.html） ：Docker 镜像</li>
<li>程序或运行环境配置（nginx.conf） ：ConfigMap</li>
<li>负载均衡器 （LoadBalancer）+ Ingress ： 用户接入和负载均衡</li>
</ul>
<p>其中 Deployment、Service 不再赘述。</p>
<h2 id="2-k8s">2. 使用 K8S 资源准备版本</h2>
<h3 id="21-loadbalancer">2.1 新增 LoadBalancer</h3>
<p>Ingress 是 K8S 中描述用户接入的对象之一， 需要配合 LB 应用才能对外提供访问。</p>
<p>在 BCS 中，LoadBalancer 背后的技术是 K8S 维护的 <strong>Nginx Ingress Controller</strong>。</p>
<p>选择菜单【LoadBalancer】，点击【新建 LoadBalancer】，选择一个节点作为 LB 对外提供网络接入服务。</p>
<p><img alt="-w1678" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15659439205670.jpg" /></p>
<blockquote>
<p>建议业务 Pod 不调度至 LB 所在的节点，可使用 节点亲和性（nodeAffinity）实现。</p>
</blockquote>
<h3 id="22-configmap-nginxconf">2.2 Configmap ： 存放 nginx.conf</h3>
<p>在【模板集】菜单中，选择【Configmap】，新建 nginx.conf 和 default.conf 两个 configmap，实现<strong>应用程序和配置的解耦</strong>。</p>
<p><img alt="-w1674" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15659435399613.jpg" /></p>
<h3 id="23-k8s-deployment-serviceingress">2.3 创建 K8S 对象 Deployment 、Service、Ingress</h3>
<ul>
<li>创建 Deployment</li>
</ul>
<p>在【Deployment】中，填写 名称、标签（Label）、容器镜像、挂载卷（挂载 Configmap）。</p>
<p><img alt="-w1675" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15659437982262.jpg" />
<img alt="-w1672" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15659438850899.jpg" /></p>
<ul>
<li>创建 Service</li>
</ul>
<p>在【Service】中关联 Deployment 以及服务名称、暴露的端口。</p>
<p><img alt="-w1629" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15680918349969.jpg" /></p>
<ul>
<li>新建 Ingress</li>
</ul>
<p>在【Ingress】中填写 【主机名】、【路径】以及绑定 【Service】。</p>
<p><img alt="-w1629" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15680920723966.jpg" /></p>
<h3 id="24">2.4 实例化模板集</h3>
<p>保存模板集后，实例化模板集。</p>
<p><img alt="-w1678" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15659439491084.jpg" /></p>
<p>可以看到对应资源已生成好。</p>
<ul>
<li>Deployment</li>
</ul>
<p><img alt="-w1678" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15659449765672.jpg" /></p>
<ul>
<li>Service</li>
</ul>
<p><img alt="-w1677" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15659450631792.jpg" /></p>
<ul>
<li>Ingress</li>
</ul>
<p><img alt="-w1677" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15659450818610.jpg" /></p>
<p>修改域名解析或修改 PC 上 hosts 文件（Mac 下路径为 /etc/hosts），将 Ingress 中配置的主机名解析到 LoadBalancer 中节点的外网 IP，然后打开浏览器访问。</p>
<p><img alt="-w1115" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15680984160424.jpg" /></p>
<p>以上作为线上环境运行的版本，接下来部署新版本。</p>
<h2 id="3-k8s">3. 使用 K8S 资源准备新版本</h2>
<p>本次新版本参照微服务更新的最佳实践：将应用程序打入 Docker Image，<strong>更新 Deployment 中的镜像即更新版本</strong>。</p>
<h3 id="31-docker-image">3.1 制作新版本的 Docker Image</h3>
<p>以 index.html 为应用程序，将其打入镜像，由于新版本的运行时是 Ningx 1.17.0，故以  Nginx 1.17.0 为基础镜像。</p>
<ul>
<li>准备 dockerfile</li>
</ul>
<div class="codehilite"><pre><span></span>$ ll
total <span class="m">16</span>
-rw-r--r--  <span class="m">1</span> breaking  staff    49B  <span class="m">9</span> <span class="m">10</span> <span class="m">10</span>:55 dockerfile
-rw-r--r--  <span class="m">1</span> breaking  staff    40B  <span class="m">9</span> <span class="m">10</span> <span class="m">10</span>:54 index.html

$ cat index.html

Welcome to BCS.

Nginx Version: <span class="m">1</span>.17.0

$ cat dockerfile
FROM nginx:1.17.0
COPY index.html /usr/share/nginx/html
</pre></div>


<ul>
<li>构建 Docker Image</li>
</ul>
<div class="codehilite"><pre><span></span>$ docker build -t bcs_nginx:1.17.0 .
Sending build context to Docker daemon  <span class="m">3</span>.072kB
Step <span class="m">1</span>/2 : FROM nginx:1.17.0
 ---&gt; 719cd2e3ed04
Step <span class="m">2</span>/2 : COPY index.html /usr/share/nginx/html
 ---&gt; 9e1342027c80
Successfully built 9e1342027c80
Successfully tagged bcs_nginx:1.17.0

$ docker images
REPOSITORY                                              TAG                   IMAGE ID            CREATED             SIZE
bcs_nginx                                               <span class="m">1</span>.17.0                9e1342027c80        <span class="m">18</span> seconds ago      109MB
</pre></div>


<ul>
<li>推送镜像到仓库</li>
</ul>
<div class="codehilite"><pre><span></span>$ docker tag bcs_nginx:1.17.0 &lt;Registry_URL&gt;/joyfulgame/bcs_nginx:1.17.0

$ docker push &lt;Registry_URL&gt;/joyfulgame/bcs_nginx:1.17.0
The push refers to repository <span class="o">[</span>&lt;Registry_URL&gt;/joyfulgame/bcs_nginx<span class="o">]</span>
8b2c2f2923c8: Pushed
d7acf794921f: Mounted from joyfulgame/nginx
d9569ca04881: Mounted from joyfulgame/nginx
cf5b3c6798f7: Mounted from joyfulgame/nginx
<span class="m">1</span>.17.0: digest: sha256:b608ac54ca92dd092529f9b86403d3a539eab030103e2e0c1a984787ece448c9 size: <span class="m">1155</span>
</pre></div>


<blockquote>
<p>更多 Docker Image 的构建方法可以参考 <a href="https://github.com/nginxinc/docker-nginx/blob/master/stable/alpine/Dockerfile">docker-nginx</a>。</p>
</blockquote>
<h3 id="32">3.2 克隆模板集为新版本</h3>
<p>由于新版本主要在 Deployment 的镜像版本、Ingress 绑定的主机名，以及这几个 K8S 对象的命名差别（同一个命名空间不允许重名），所以克隆模板集，然后修改即可。</p>
<p>点击【复制模板集】，会克隆一个模板集，命名为：蓝绿发布-绿</p>
<p><img alt="-w1678" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15659444709512.jpg" /></p>
<ul>
<li>修改【Deployment】中的名称、标签以及镜像版本。</li>
</ul>
<p><img alt="-w1679" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15681000388594.jpg" /></p>
<ul>
<li>修改【Service】中的名称、关联标签。</li>
</ul>
<p><img alt="-w1620" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15681000844250.jpg" /></p>
<ul>
<li>修改 Ingress，主机名不能上一个版本一样。</li>
</ul>
<p><img alt="-w1631" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15681001549718.jpg" /></p>
<p>最后保存模板集，然后开始实例化模板集。</p>
<p>修改域名解析或修改 PC 上 hosts 文件（Mac 下路径为 /etc/hosts）后，访问 Ingress 中配置的主机名。</p>
<p><img alt="-w513" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15681005088734.jpg" /></p>
<h2 id="4">4. 切换流量并观察</h2>
<p>如果是客户端业务，将请求的后端地址指向为新版本的主机名即可，如果客户端不方便更新配置，可以使用 CNAME 将域名指向到新的版本的主机名。</p>
<p>观察一段时间，如果没有异常，删除原版本的实例即可。</p>
<p><img alt="-w1626" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15681007939276.jpg" /></p>
<ul>
<li>
<p>蓝绿发布的好处：新版本如果发现异常，可以快速的切换到老版本。</p>
</li>
<li>
<p>蓝绿发布的坏处：预备双倍的资源，直到下线老版本。不过如果有云平台，成本可控。</p>
</li>
</ul>
<p>企业可以结合自身实际情况，选择合适的版本发布方式。</p><h1 id="k8s-wordpress">在 K8S 中部署 WordPress</h1>
<h4 id="_1">情景</h4>
<p>WordPress 是流行的开源博客程序，Helm 官方维护了 WorePress 的 Chart，接下来看在 BCS 中如何部署 WordPress，开始你的博客之旅。</p>
<h4 id="_2">前提条件</h4>
<ul>
<li><a href="../Function/helm/ServiceAccess.md">了解 Helm 的使用方法</a></li>
<li><a href="../Function/StorageSolution/kubernetes.md">集成 K8S 存储</a>，例如 <a href="../Function/StorageSolution/K8s_NFS_Client_Provisioner.md">将 NFS 作为 K8S PV Provisioner</a></li>
<li>Git Clone <a href="https://github.com/helm/charts/">Helm Charts</a></li>
<li>新增 <a href="../Function/NetworkSolution/k8s/LoadBalancer.md">LoadBalancer</a></li>
</ul>
<h4 id="_3">操作步骤</h4>
<ol>
<li>上传 WordPress Chart 到仓库</li>
<li>部署 WordPress</li>
<li>访问测试</li>
</ol>
<h2 id="1-wordpress-chart">1. 上传 WordPress Chart 到仓库</h2>
<p>进入 <a href="https://github.com/helm/charts/">Charts</a> 本地仓库的 wordpress 目录。</p>
<div class="codehilite"><pre><span></span><span class="c1"># cd charts/stable/wordpress/</span>

<span class="c1"># ll</span>
总用量 <span class="m">84</span>
-rw-r--r-- <span class="m">1</span> root root   <span class="m">454</span> 9月  <span class="m">12</span> <span class="m">11</span>:01 Chart.yaml
-rw-r--r-- <span class="m">1</span> root root   <span class="m">186</span> 9月  <span class="m">12</span> <span class="m">11</span>:01 OWNERS
-rw-r--r-- <span class="m">1</span> root root <span class="m">29059</span> 9月  <span class="m">12</span> <span class="m">11</span>:01 README.md
-rw-r--r-- <span class="m">1</span> root root   <span class="m">233</span> 9月  <span class="m">12</span> <span class="m">11</span>:01 requirements.lock
-rw-r--r-- <span class="m">1</span> root root   <span class="m">173</span> 8月  <span class="m">27</span> <span class="m">17</span>:00 requirements.yaml
drwxr-xr-x <span class="m">3</span> root root  <span class="m">4096</span> 9月  <span class="m">12</span> <span class="m">11</span>:01 templates
-rw-r--r-- <span class="m">1</span> root root <span class="m">13278</span> 9月  <span class="m">12</span> <span class="m">11</span>:01 values-production.yaml
-rw-r--r-- <span class="m">1</span> root root <span class="m">12925</span> 9月  <span class="m">12</span> <span class="m">11</span>:01 values.yaml
</pre></div>


<p>可以看到存在 requirements.yaml 文件，了解 WordPress 依赖 mariadb 的 Chart。</p>
<div class="codehilite"><pre><span></span><span class="c1"># cat requirements.yaml</span>
dependencies:
- name: mariadb
  version: <span class="m">6</span>.x.x
  repository: https://kubernetes-charts.storage.googleapis.com/
  condition: mariadb.enabled
  tags:
    - wordpress-database
</pre></div>


<p>在当前目录使用 Helm 命令下载依赖包。</p>
<div class="codehilite"><pre><span></span><span class="c1"># helm dep build</span>
Hang tight <span class="k">while</span> we grab the latest from your chart repositories...
...Successfully got an update from the <span class="s2">&quot;joyfulgame&quot;</span> chart repository
...Successfully got an update from the <span class="s2">&quot;stable&quot;</span> chart repository
Update Complete. ⎈Happy Helming!⎈
Saving <span class="m">1</span> charts
Downloading mariadb from repo https://kubernetes-charts.storage.googleapis.com/
Deleting outdated charts
</pre></div>


<p>推送 Chart 到仓库</p>
<div class="codehilite"><pre><span></span><span class="c1"># helm push . joyfulgame</span>
Pushing wordpress-7.3.4.tgz to joyfulgame...
Done.
</pre></div>


<p>在 BCS 【Chart 仓库】菜单中，点击【同步仓库】，将刚刚上传的 Chart 从仓库同步到 BCS 的界面中。</p>
<h2 id="2-wordpress">2. 部署 WordPress</h2>
<p>在 BCS 【Chart 仓库】菜单中，找到刚刚上传的 WordPress Chart ，点击【部署】。</p>
<p><img alt="w1645" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15682579071348.jpg" /></p>
<p>可以修改 Helm 参数，例如 WordPress 管理员账号、密码等，这里重点提一下用户访问用到的 Service 和 Ingress：</p>
<ul>
<li>Service</li>
</ul>
<p>使用 ClusterIP 即可，因为用户访问使用 Ingress。</p>
<div class="codehilite"><pre><span></span><span class="nt">service</span><span class="p">:</span>
  <span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ClusterIP</span>
  <span class="c1"># HTTP Port</span>
  <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
</pre></div>


<ul>
<li>Ingress</li>
</ul>
<p>此处启用 Ingress，并填写绑定的 <strong>主机名</strong> 和 <strong>路径</strong>。类似 Nginx 配置文件中 Server Section 部分的 server_name。</p>
<p><img alt="w1678" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15682642857653.jpg" /></p>
<p>点击【预览】，可以看到 BCS 将 Charts 通过 <code>helm template</code> 命令渲染为 K8S 的对象描述文件。</p>
<p><img alt="w1657" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15682582162576.jpg" /></p>
<p>点击 【部署】即可。</p>
<p>在【Release 列表】菜单中可以查看部署状态。</p>
<p><img alt="w1652" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15683730410624.jpg" /></p>
<p>部署成功，接下来测试访问。</p>
<h2 id="3">3. 访问测试</h2>
<p>修改域名解析或 PC 上 hosts 文件（Mac 下路径为 /etc/hosts），将 Ingress 中配置的主机名指向到 LoadBalancer 中节点的外网 IP，然后打开浏览器访问，可以看到 WordPress 首页。</p>
<p><img alt="w1648" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15683743074917.jpg" /></p>
<p>输入用户名（默认为 user）和密码登录 Wordpress 后台。</p>
<p><img alt="w1676" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15683744779001.jpg" /></p>
<p>如果没有在 Chart 参数中没有设置密码，可以通过命令获取 WordPress 的 Secret。</p>
<div class="codehilite"><pre><span></span><span class="c1"># kubectl  get secret -n dev</span>
<span class="l l-Scalar l-Scalar-Plain">NAME                                                TYPE                                  DATA   AGE</span>
<span class="l l-Scalar l-Scalar-Plain">wordpress-1909130255                                Opaque                                1      4h37m</span>

<span class="l l-Scalar l-Scalar-Plain"># kubectl  get secret/wordpress-1909130255 -n dev -o yaml</span>
<span class="l l-Scalar l-Scalar-Plain">apiVersion</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">data</span><span class="p">:</span>
  <span class="nt">wordpress-password</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">bFgzTmZvSHJIVg==</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Secret</span>
  <span class="l l-Scalar l-Scalar-Plain">creationTimestamp</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">2019-09-13T07:01:33Z</span>
  <span class="l l-Scalar l-Scalar-Plain">name</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">wordpress-1909130255</span>
  <span class="l l-Scalar l-Scalar-Plain">namespace</span><span class="p p-Indicator">:</span> <span class="l l-Scalar l-Scalar-Plain">dev</span>
<span class="nt">type</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Opaque</span>

<span class="c1"># echo &quot;bFgzTmZvSHJIVg==&quot; | base64 --decode</span>
<span class="l l-Scalar l-Scalar-Plain">lX3NfoHrHV</span>
</pre></div>


<p>BCS 部署应用，如此简单。</p><h1 id="k8s-gitlab">在 K8S 中部署 GitLab</h1>
<h4 id="_1">情景</h4>
<p>GitLab，不仅仅一个独立部署的流行 Git 代码托管仓库，通过其 Pipeline 具备部分 CI 环节的能力，接下来看 BCS 如何快速部署 GitLab。</p>
<h4 id="_2">前提条件</h4>
<ul>
<li><a href="../Function/helm/ServiceAccess.md">了解 Helm 的使用方法</a></li>
<li><a href="../Function/StorageSolution/kubernetes.md">集成 K8S 存储</a>，例如 <a href="../Function/StorageSolution/K8s_NFS_Client_Provisioner.md">将 NFS 作为 K8S PV Provisioner</a></li>
<li>Git Clone <a href="https://github.com/helm/charts/">Helm Charts</a></li>
<li>新增 <a href="../Function/NetworkSolution/k8s/LoadBalancer.md">LoadBalancer</a></li>
</ul>
<h4 id="_3">操作步骤</h4>
<ol>
<li>
<p>上传 GitLab Chart 到仓库</p>
</li>
<li>
<p>部署 GitLab</p>
</li>
<li>
<p>访问测试</p>
</li>
</ol>
<h2 id="1-gitlab-chart">1. 上传 GitLab Chart 到仓库</h2>
<p>进入 <a href="https://github.com/helm/charts/">Charts</a> 本地仓库的 gitlab-ce 目录。</p>
<div class="codehilite"><pre><span></span><span class="c1"># cd charts/stable/gitlab-ce/</span>

<span class="c1"># ll</span>
总用量 <span class="m">28</span>
-rwxr-xr-x <span class="m">1</span> root root  <span class="m">365</span> 8月  <span class="m">27</span> <span class="m">17</span>:00 Chart.yaml
-rw-r--r-- <span class="m">1</span> root root <span class="m">2502</span> 8月  <span class="m">27</span> <span class="m">17</span>:00 README.md
-rw-r--r-- <span class="m">1</span> root root  <span class="m">336</span> 8月  <span class="m">27</span> <span class="m">17</span>:00 requirements.lock
-rw-r--r-- <span class="m">1</span> root root  <span class="m">209</span> 8月  <span class="m">27</span> <span class="m">17</span>:00 requirements.yaml
drwxr-xr-x <span class="m">2</span> root root <span class="m">4096</span> 9月  <span class="m">13</span> <span class="m">15</span>:14 templates
-rw-r--r-- <span class="m">1</span> root root <span class="m">3445</span> 8月  <span class="m">27</span> <span class="m">17</span>:00 values.yaml
</pre></div>


<p>可以看到存在 requirements.yaml 文件，了解 GitLab 依赖 redis、postgresql 的 Chart。</p>
<div class="codehilite"><pre><span></span><span class="c1"># cat requirements.yaml</span>
dependencies:
- name: redis
  version: <span class="m">0</span>.9.0
  repository: https://kubernetes-charts.storage.googleapis.com/
- name: postgresql
  version: <span class="m">0</span>.8.1
  repository: https://kubernetes-charts.storage.googleapis.com/
</pre></div>


<p>在当前目录使用 Helm 命令下载依赖包。</p>
<div class="codehilite"><pre><span></span><span class="c1"># helm dep build</span>
Hang tight <span class="k">while</span> we grab the latest from your chart repositories...
...Successfully got an update from the <span class="s2">&quot;joyfulgame&quot;</span> chart repository
...Successfully got an update from the <span class="s2">&quot;stable&quot;</span> chart repository
Update Complete. ⎈Happy Helming!⎈
Saving <span class="m">2</span> charts
Downloading redis from repo https://kubernetes-charts.storage.googleapis.com/
Downloading postgresql from repo https://kubernetes-charts.storage.googleapis.com/
Deleting outdated charts
</pre></div>


<p>推送 Chart 到仓库</p>
<div class="codehilite"><pre><span></span><span class="c1"># helm push . joyfulgame</span>
Pushing gitlab-ce-0.2.2.tgz to joyfulgame...
Done.
</pre></div>


<p>在 BCS 【Chart 仓库】菜单中，点击【同步仓库】，将刚刚上传的 Chart 从仓库同步到 BCS 的界面中。</p>
<h2 id="2-gitlab">2. 部署 GitLab</h2>
<p>在 BCS 【Chart 仓库】菜单中，找到刚刚上传的 GitLab Chart ，点击【部署】。</p>
<p><img alt="-w1678" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15683755718942.jpg" /></p>
<p>选择 Chart 版本以及命名空间后，下方显示 Helm 参数。</p>
<p><img alt="-w1673" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15683757228949.jpg" /></p>
<p>需调整 externalUrl、Service 和 Ingress：</p>
<ul>
<li>externalUrl</li>
</ul>
<p>必填，安装过程需要 GitLab 访问地址。</p>
<ul>
<li>Service</li>
</ul>
<p>使用 ClusterIP 即可，因为用户访问使用 Ingress。</p>
<div class="codehilite"><pre><span></span><span class="nt">serviceType</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ClusterIP</span>
</pre></div>


<ul>
<li>Ingress</li>
</ul>
<p>此处启用 Ingress，并填写 URL。</p>
<div class="codehilite"><pre><span></span><span class="nt">ingress</span><span class="p">:</span>
  <span class="nt">annotations</span><span class="p">:</span>
      <span class="c1"># kubernetes.io/ingress.class: nginx</span>
      <span class="c1"># kubernetes.io/tls-acme: &quot;true&quot;</span>
  <span class="nt">enabled</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
  <span class="nt">tls</span><span class="p">:</span>
      <span class="c1"># - secretName: gitlab.cluster.local</span>
      <span class="c1">#   hosts:</span>
      <span class="c1">#     - gitlab.cluster.local</span>
  <span class="nt">url</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">gitlab.bk.tencent.com</span>
</pre></div>


<p>点击【预览】，可以看到 BCS 将 Charts 通过 <code>helm template</code> 命令渲染为 K8S 的对象描述文件。</p>
<p><img alt="-w1679" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15683761927767.jpg" /></p>
<p>点击 【部署】即可。</p>
<p>在【Release 列表】菜单中可以查看部署状态。</p>
<p><img alt="-w1676" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15683762160110.jpg" /></p>
<p>部署成功，接下来测试访问。</p>
<h2 id="3">3. 访问测试</h2>
<p>修改域名解析或 PC 上 hosts 文件（Mac 下路径为 /etc/hosts），将 Ingress 中配置的主机名指向到 LoadBalancer 中节点的外网 IP，然后打开浏览器访问，可以看到 GitLab 首次登陆密码设置界面。</p>
<p>管理员用户名为 root，登陆后界面如下：</p>
<p><img alt="-w1678" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15683762619925.jpg" /></p>
<p>创建一个仓库，体验一下。</p>
<p><img alt="-w1676" src="F:\bkdoc\md_to_pdf/5.1/bcs/Scenes/media/15683763495121.jpg" /></p>
<p>BCS 部署应用，如此简单。</p><h1 id="dashboard-metric">Dashboard - Metric 数据查看和配置</h1>
<p>容器的基础性能数据、容器的日志（标准输出日志采集、非标准输出日志采集）、容器内运行的应用程序的自定义 Metric 在采集，清洗完成，且在数据平台生成相应结果表后，即可在 Dashboard 中查询。</p>
<p>入口地址： 【监控中心】 -&gt; 【Dashboard】</p>
<p>Dashboard 含默认 和 自定义 2 种。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/monitor/assets/images/dashboards.png" /></p>
<p>注意： <code>请勿修改默认 Dashboard，默认视图下次升级会覆盖您修改的配置</code></p>
<p>点击 <code>New Dashboard</code> 可以添加自定义数据仪表盘，点击 <code>Import Dashboard</code> 可以导入自定义数据仪表盘。</p>
<h2 id="1">1. 视图</h2>
<p>默认 Dashboard 包含</p>
<ul>
<li>
<p><code>BCS Cluster</code>, 集群视图</p>
</li>
<li>
<p><code>BCS Node</code>, 集群节点视图</p>
</li>
<li>
<p><code>BCS Pods</code>, 容器 Pod 视图</p>
</li>
</ul>
<h3 id="11-bcs-cluster">1.1 BCS Cluster</h3>
<p>呈现集群的 CPU、内存资源的容量以及使用率。</p>
<p><img alt="-w1676" src="F:\bkdoc\md_to_pdf/5.1/bcs/monitor/Dashboard/media/15683767505889.jpg" /></p>
<h3 id="12-bcs-node">1.2 BCS Node</h3>
<p>呈现节点的平均负载以及 CPU、内存使用率。</p>
<p><img alt="-w1677" src="F:\bkdoc\md_to_pdf/5.1/bcs/monitor/Dashboard/media/15683768457325.jpg" />
<img alt="-w1671" src="F:\bkdoc\md_to_pdf/5.1/bcs/monitor/Dashboard/media/15683768658574.jpg" /></p>
<h3 id="13-bcs-pods">1.3 BCS Pods</h3>
<p>呈现 Pod 的 CPU、内存、网络资源的使用情况。
<img alt="-w1679" src="F:\bkdoc\md_to_pdf/5.1/bcs/monitor/Dashboard/media/15683774087127.jpg" /></p>
<h2 id="2">2. 告警策略配置</h2>
<p>选择 【告警策略】菜单，可以容器、主机等维度的告警策略，如下图：</p>
<p><img alt="-w1678" src="F:\bkdoc\md_to_pdf/5.1/bcs/monitor/Dashboard/media/15684274112803.jpg" /></p>
<p>如选择容器维度后，还可以继续选择集群、命名空间、Deployment、StatefulSet 等维度。</p>
<p><img alt="-w1677" src="F:\bkdoc\md_to_pdf/5.1/bcs/monitor/Dashboard/media/15684274217177.jpg" /></p>
<p>例如选择 <strong>集群</strong> 维度，接下来选择  <strong>CPU 使用率</strong>
<img alt="-w1676" src="F:\bkdoc\md_to_pdf/5.1/bcs/monitor/Dashboard/media/15684274832175.jpg" /></p>
<p>设置对应的告警检测策略。</p>
<p><img alt="-w1678" src="F:\bkdoc\md_to_pdf/5.1/bcs/monitor/Dashboard/media/15684275535601.jpg" /></p>
<p>上图是生产环境设置的策略，为了测试告警也可以降低阈值，可以看到阈值在下图的右侧以红线呈现，以直观的视角辅助阈值设置。</p>
<p><img alt="-w1678" src="F:\bkdoc\md_to_pdf/5.1/bcs/monitor/Dashboard/media/15683775688941.jpg" /></p>
<p>【保存】后告警策略设置成功。</p>
<p><img alt="-w1664" src="F:\bkdoc\md_to_pdf/5.1/bcs/monitor/Dashboard/media/15684275767970.jpg" /></p><h1 id="dashboard-templating">Dashboard - 模板(Templating)</h1>
<p>模板允许更多交互式,动态的仪表板。您可以在度量标准查询中使用变量代替硬编码 cluster_id，namespace 和 container_id 名称等内容。变量显示为仪表板顶部的下拉选择框。通过这些下拉菜单，您可以轻松更改仪表板中显示的数据。</p>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/monitor/assets/images/templating.png" /></p>
<h2 id="1">1. 什么是变量</h2>
<p>变量是值的占位符。您可以在度量标准查询和面板标题中使用变量。因此，当您更改值时，使用仪表板顶部的下拉列表，面板的度量标准查询将更改以反映新值。</p>
<h3 id="11-interpolation">1.1 Interpolation</h3>
<p>面板标题和度量标准查询可以使用两种不同的语法引用变量：</p>
<ul>
<li><code>$&lt;varname&gt;</code>  Example: apps.frontend.$server.requests.count</li>
<li><code>[[varname]]</code> Example: apps.frontend.[[server]].requests.count</li>
</ul>
<p>为什么两种方式？第一种语法更易于读写，但不允许在单词中间使用变量。在表达式中使用第二种语法  <code>my.server[[serverNumber]].count</code>.</p>
<p>在将查询发送到数据源之前，将对查询进行插值，这意味着将变量替换为其当前值。在插值期间，可以对变量值进行转义，以符合查询语言的语法和使用它的位置。例如，InfluxDB 或 Prometheus 查询中的正则表达式中使用的变量将进行正则表达式转义。有关插值期间值转义的详细信息，请阅读数据源特定文档文章。</p>
<h3 id="12">1.2 变量选项</h3>
<p>变量显示为仪表板顶部的下拉选择框。它具有当前值和一组选项。该选项是一组可供选择的值。</p>
<h2 id="2">2. 添加变量</h2>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/monitor/assets/images/templating_var_list.png" /></p>
<p>您可以通过 Dashboard &gt; Templating 添加变量。这将打开一个变量列表和一个 New 用于创建新变量的按钮。</p>
<h3 id="21">2.1 基本变量选项</h3>
<table>
<thead>
<tr>
<th>选项</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>Name</em></td>
<td>变量的名称，这是在度量标准查询中引用变量时使用的名称。必须是唯一的，不包含空格。</td>
</tr>
<tr>
<td><em>Label</em></td>
<td>此变量的下拉列表的名称。</td>
</tr>
<tr>
<td><em>Hide</em></td>
<td>隐藏下拉选择框的选项。</td>
</tr>
<tr>
<td><em>Type</em></td>
<td>定义变量类型。</td>
</tr>
</tbody>
</table>
<h3 id="22">2.2 变量类型</h3>
<table>
<thead>
<tr>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>Query</em></td>
<td>此变量类型允许您编写数据源查询，该查询通常返回度量标准名称，标记值或键的列表。例如，返回服务器名称，传感器 ID 或数据中心列表的查询。</td>
</tr>
<tr>
<td><em>Interval</em></td>
<td>此变量可表示时间跨度。不是按时间或日期直方图间隔对组进行硬编码，而是使用此类型的变量。</td>
</tr>
<tr>
<td><em>Datasource</em></td>
<td>此类型允许您快速更改整个仪表板的数据源。如果您在不同的环境中有多个数据源实例，则非常有用。</td>
</tr>
<tr>
<td><em>Custom</em></td>
<td>使用逗号分隔列表手动定义变量选项。</td>
</tr>
<tr>
<td><em>Constant</em></td>
<td>定义隐藏常量。对于要共享的仪表板的度量标准路径前缀很有用。在仪表板导出期间，常量变量将变为导入选项。</td>
</tr>
<tr>
<td><em>Ad hoc filters</em></td>
<td>非常特殊的变量，目前仅适用于某些数据源，InfluxDB 和 Elasticsearch。它允许您添加键/值过滤器，这些过滤器将自动添加到使用指定数据源的所有度量标准查询中。</td>
</tr>
</tbody>
</table>
<h3 id="23">2.3 查询选项</h3>
<p>此变量类型是最强大和最复杂的，因为它可以使用数据源查询动态获取其选项。</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>Data source</em></td>
<td>查询的数据源目标。</td>
</tr>
<tr>
<td><em>Refresh</em></td>
<td>控制何时更新变量选项列表（下拉列表中的值）。在仪表板上加载将减慢仪表板负载，因为在初始化仪表板之前需要完成变量查询。如果变量选项查询包含时间范围过滤器或取决于仪表板时间范围，则仅将此设置为“ 开启时间范围更改”。</td>
</tr>
<tr>
<td><em>Query</em></td>
<td>数据源特定的查询表达式。</td>
</tr>
<tr>
<td><em>Regex</em></td>
<td>正则表达式用于过滤或捕获数据源查询返回的名称的特定部分。可选的。</td>
</tr>
<tr>
<td><em>Sort</em></td>
<td>在下拉列表中定义选项的排序顺序。已禁用表示将使用数据源查询返回的选项顺序。</td>
</tr>
</tbody>
</table>
<h3 id="24">2.4 查询表达式</h3>
<p>每个数据源的查询表达式都不同。</p>
<ul>
<li><a href="./DashboardSearch.md">Elasticsearch templating queries</a></li>
<li><a href="./DashboardSearch.md">InfluxDB templating queries</a></li>
</ul>
<p>需要注意的一点是，查询表达式可以包含对其他变量的引用，实际上可以创建链接变量。Grafana 将检测到这一点并在其中一个变量包含变量时自动刷新变量。</p>
<h2 id="3">3. 选择选项</h2>
<table>
<thead>
<tr>
<th>选项</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>Multi-value</em></td>
<td>如果启用，该变量将支持同时选择多个选项。</td>
</tr>
<tr>
<td><em>Include All option</em></td>
<td>添加一个特殊 All 选项，其值包括所有选项。</td>
</tr>
<tr>
<td><em>Custom all value</em></td>
<td>默认情况下，该 All 值将包括组合表达式中的所有选项。这可能会变得很长并且可能会出现性能问题。很多时候，最好指定一个自定义的所有值，比如通配符正则表达式。为了能够在 Custom all value 选项中使用自定义正则表达式，globs 或 lucene 语法，它永远不会被转义，因此您必须考虑哪些是数据源的有效值。</td>
</tr>
</tbody>
</table>
<h3 id="31">3.1 形成多个值</h3>
<p>使用所选择的多个值对变量进行插值是很棘手的，因为如何将多个值格式化为在使用该变量的给定上下文中有效的字符串。Grafana 试图通过允许每个数据源插件通知模板插值引擎用于多个值的格式来解决这个问题。</p>
<p>例如，<strong>Graphite</strong>使用 glob 表达式。在这种情况下，具有多个值的变量将被内插，<code>{host1,host2,host3}</code>就像当前变量值是 host1，host2 和 host3 一样。</p>
<p><strong>InfluxDB</strong> 和 <strong>Prometheus</strong> 使用正则表达式，因此相同的变量将被插值为<code>(host1|host2|host3)</code>。如果没有，每个值也将是正则表达式转义，具有正则表达式控制字符的值将破坏正则表达式。</p>
<p><strong>Elasticsearch</strong> 使用 lucene 查询语法，因此在这种情况下，相同的变量将被格式化为<code>("host1" OR "host2" OR "host3")</code>。在这种情况下，每个值都需要进行转义，以便该值可以包含 lucene 控制字和引号。</p>
<h3 id="32">3.2 值组/标签</h3>
<p>如果您在多值变量的下拉列表中有很多选项。您可以使用此功能将值分组为可选标记。</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><em>Tags query</em></td>
<td>应返回标记列表的数据源查询</td>
</tr>
<tr>
<td><em>Tag values query</em></td>
<td>应返回指定标记键值的列表的数据源查询。<code>$tag</code>在查询中使用以引用当前选定的标记。</td>
</tr>
</tbody>
</table>
<p><img alt="" src="F:\bkdoc\md_to_pdf/5.1/bcs/monitor/assets/images/variable_dropdown_tags.png" /></p>
<h3 id="33">3.3 区间变量</h3>
<p>使用 Interval 类型创建表示时间跨度的变量（例如<code>1m</code>，<code>1h</code>，<code>1d</code>）。还有一个特殊 auto 选项会根据当前时间范围而改变。您可以指定当前时间范围应分多少次以计算当前 auto 时间跨度。</p>
<p>此变量类型可用作按时间分组的参数（对于 InfluxDB），日期直方图间隔（对于 Elasticsearch）或作为汇总函数参数（对于 Graphite）。</p>
<p>在 graphite 函数中使用<code>myinterval</code>类型的模板变量的示例<code>Interval</code>：</p>
<div class="codehilite"><pre><span></span><span class="n">summarize</span><span class="p">(</span><span class="err">$</span><span class="n">myinterval</span><span class="p">,</span> <span class="k">sum</span><span class="p">,</span> <span class="k">false</span><span class="p">)</span>
</pre></div>


<h2 id="4">4. 全局内置变量</h2>
<p>Grafana 具有全局内置变量，可以在查询编辑器中的表达式中使用。</p>
<h3 id="41-__interval">4.1 $__interval 变量</h3>
<p>这个$__interval 变量类似于上面描述的<code>auto</code>interval 变量。它可以用作按时间分组的参数（对于 InfluxDB），日期直方图间隔（对于 Elasticsearch）或作为汇总函数参数（对于 Graphite）</p>
<p>Grafana 自动计算可用于在查询中按时间分组的间隔。当数据点多于图表上显示的数据点时，可以通过更大的间隔分组来提高查询效率。在查看 3 个月的数据时，分组比 1 天比 10 分更有效，图表看起来相同，查询会更快。的$__interval 使用时间范围和图形（像素数）的宽度来计算。</p>
<p>近似计算： <code>(from - to) / resolution</code></p>
<p>例如，当时间范围为 1 小时且图形为全屏时，则可以计算间隔<code>2m</code> - 以 2 分钟为间隔对点进行分组。如果时间范围是 6 个月并且图表是全屏，则间隔可能是<code>1d</code>（1 天） - 点按天分组。</p>
<p>在 InfluxDB 数据源中，遗留变量<code>$interval</code>是同一个变量。<code>$__interval</code>应该用来代替。</p>
<p>InfluxDB 和 Elasticsearch 数据源具有 Group by time interval 用于对间隔进行硬编码或设置<code>$__interval</code>变量的最小限制的字段（通过使用&gt;语法 - &gt; &gt;10m）。</p>
<h3 id="42-__interval_ms">4.2 $__interval_ms 变量</h3>
<p>此变量是以<code>$__interval</code>毫秒为单位的变量（而不是格式化字符串的时间间隔）。例如，如果<code>$__interval</code>是，20m 那么<code>$__interval_ms</code>是 1200000。</p>
<h3 id="43-timefilter-or-__timefilter">4.3 $timeFilter or $__timeFilter 变量</h3>
<p>$timeFilter 变量返回当前选定的时间范围作为表达。例如，时间范围间隔<code>Last 7 days</code>表达式为<code>time &gt; now() - 7d</code>。</p>
<p>这在 InfluxDB 数据源的 WHERE 子句中使用。在查询编辑器模式下，Grafana 会自动将其添加到 InfluxDB 查询中。必须在文本编辑器模式下手动添加：<code>WHERE $timeFilter</code>。</p>
<h3 id="44-__name">4.4  $__name 变量</h3>
<p>此变量仅在 Singlestat 面板中可用，可以在“选项”选项卡上的前缀或后缀字段中使用。变量将替换为系列名称或别名。</p>
<h2 id="5">5. 重复面板</h2>
<p>模板变量对于在整个仪表板中动态更改查询非常有用。如果您希望 Grafana 根据您选择的值动态创建新面板或行，则可以使用“ 重复”功能。</p>
<p>如果您启用了变量<code>Multi-value</code>或<code>Include all value</code>选项，则可以选择一个面板或一行，并让 Grafana 为每个选定值重复该行。您可以在面板编辑模式的“常规”选项卡下找到此选项。选择要重复的变量，然后选择<code>min span</code>。该<code>min span</code>控制小 Grafana 将如何使面板（如果您有很多值中选择）。Grafana 将自动调整每个重复面板的宽度，以便填满整行。目前，您不能将一行中的其他面板与重复面板混合使用。</p>
<p>仅对第一个面板（原始模板）进行更改。要使更改在所有面板上生效，您需要触发动态仪表板重建。您可以通过更改变量值（这是重复的基础）或重新加载仪表板来完成此操作。</p>
<h2 id="6">6. 重复行</h2>
<p>此选项要求您打开行选项视图。将鼠标悬停在行左侧以触发行菜单，在此菜单中单击 Row Options。这将打开行选项视图。在这里，您可以找到重复下拉列表，您可以在其中选择要重复的变量。</p>
<h2 id="7-url">7. URL 状态</h2>
<p>变量值始终使用语法同步到 URL <code>var-&lt;varname&gt;=value</code>。</p>
<h3 id="_1">示例</h3>
<ul>
<li><a href="http://play.grafana.org/dashboard/db/elasticsearch-templated">Elasticsearch Templated Dashboard</a></li>
<li><a href="http://play.grafana.org/dashboard/db/influxdb-templated-queries">InfluxDB Templated Dashboard</a></li>
</ul><h1 id="faq">FAQ</h1>
<h2 id="1">1. 产品使用</h2>
<h3 id="11-bcs-k8smesos">1.1 BCS 与 K8S、Mesos 的关系和区别是什么</h3>
<p>K8S、Mesos 为容器编排引擎，BCS 是容器管理平台，兼容 K8S、Mesos 两种容器编排引擎，提供便捷的容器管理服务，更多介绍详见 <a href="5.1/bcs/Architecture/Architecture.md">产品架构</a>。</p>
<h3 id="12">1.2 一个集群需要至少需要几台机器</h3>
<p>集群由 Master 和 Node 组成，其中 Master 主要用来部署集群的基础组件，Slave 主要用来承载业务容器。</p>
<blockquote>
<p>注: master 不允许调度，因此，至少需要一台 slave 运行业务容器</p>
</blockquote>
<ul>
<li>
<p>平台建议 Master 配置
  建议至少 4 核 / 8 G / 3 台 / CentOS 7.4 +</p>
</li>
<li>
<p>平台建议 Node 配置
   配置和数量视业务需求而定(至少需要 1 台)；操作系统：CentOS 7.4 +</p>
</li>
</ul>
<h3 id="13">1.3 调度约束</h3>
<p>用户通过调度约束可以自动的为 POD 选择指定节点，而且可以通过 <strong>亲和性</strong> 和 <strong>反亲和性</strong> 实现个性化的调度能力。</p>
<blockquote>
<p>注意: 使用不当可能导致其他的 POD 调度不成功</p>
</blockquote>
<ul>
<li>
<p>使用场景</p>
<ul>
<li>想要自己的服务运行到指定的节点</li>
<li>限制其他服务运行到指定节点</li>
</ul>
</li>
<li>
<p>出现节点匹配提示问题</p>
</li>
</ul>
<div class="codehilite"><pre><span></span><span class="o">#</span> <span class="err">错误信息</span>
<span class="k">No</span> <span class="n">nodes</span> <span class="k">are</span> <span class="n">available</span> <span class="n">that</span> <span class="k">match</span> <span class="k">all</span> <span class="k">of</span> <span class="n">the</span> <span class="n">predicates</span><span class="p">:</span> <span class="n">MatchInterPodAffinity</span> <span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">MatchNodeSelector</span> <span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">NodeNotReady</span> <span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">PodToleratesNodeTaints</span> <span class="p">(</span><span class="mi">3</span><span class="p">).</span>
</pre></div>


<ul>
<li>确认是否必须调度约束<blockquote>
<p>如果自己的场景不必须使用调度约束，可以直接去掉；如果必须使用可以确认下面条件是否满足</p>
</blockquote>
<ul>
<li>是否设置相应的节点标签，比如 nodeselect 为 app=test，这样节点必须要打 app=test 的标签</li>
<li>当前节点是否有设置亲和性，比如设置了亲和性，那么必须满足亲和性条件</li>
<li>其他服务是否有设置反亲和性，比如别的节点设置了反亲和性，那么设置的节点就不允许其他服务调度</li>
</ul>
</li>
</ul>
<h2 id="2">2. 问题排查</h2>
<h3 id="21">2.1 拉取镜像失败</h3>
<p>出现镜像拉取失败的问题，可能有如下两种可能导致：</p>
<ul>
<li>
<p>镜像不存在
针对这种情况，需要用户上传镜像即可。</p>
</li>
<li>
<p>节点没有权限拉取镜像
这种情况，一般是由于平台侧创建<code>imagePullSecrets</code>失败导致。</p>
</li>
</ul>
<h2 id="22">2.2 启动容器失败</h2>
<p>这种情况一般是用户镜像有问题，用户可以通过如下两种方式查看日志:
- 使用 Webconsole，kubectl logs <code>pod name</code> -n <code>namespace name</code>
- 登录节点机器，通过 docker logs <code>container id</code>查看相应日志信息</p>
<h3 id="221-webconsole">2.2.1 使用 Webconsole 查看日志</h3>
<ul>
<li>登录 Webcosole
点击容器服务的右下角“WebConsole”，点击相应的集群，弹出 Webcosole 页面</li>
</ul>
<p><img alt="webconsole" src="F:\bkdoc\md_to_pdf/5.1/bcs/FAQ/media/web-console.png" /></p>
<p>然后，输入 kubectl logs <code>pod name</code> -n <code>namespace name</code>，查看指定命名空间下的应用日志</p>
<h3 id="222">2.2.2 登录节点查看日志</h3>
<ul>
<li>通过点击应用详情，跳转到应用详情页</li>
</ul>
<p><img alt="点击查看详情" src="F:\bkdoc\md_to_pdf/5.1/bcs/FAQ/media/app.jpg" /></p>
<ul>
<li>查找 Pod / Taskgroup 管理项，查看到部署的节点</li>
</ul>
<p><img alt="应用详情" src="F:\bkdoc\md_to_pdf/5.1/bcs/FAQ/media/taskgroup_pod.jpg" /></p>
<ul>
<li>登录节点查看相应的容器日志</li>
</ul>
<h3 id="23-pod-waiting-containercreating">2.3 关于 POD 创建后一直处于 Waiting 或 ContainerCreating 状态</h3>
<ul>
<li>2.3.1 检查应用配置的资源设置
首先，通过查看事件日志，如果此时出现下面这种错误，可以认为启动容器的资源不能满足需求</li>
</ul>
<div class="codehilite"><pre><span></span><span class="nv">to</span> <span class="nv">start</span> <span class="nv">sandbox</span> <span class="nv">container</span> <span class="k">for</span> <span class="nv">pod</span> ... <span class="nv">Error</span> <span class="nv">response</span> <span class="nv">from</span> <span class="nv">daemon</span>: <span class="nv">OCI</span> <span class="nv">runtime</span> <span class="nv">create</span> <span class="nv">failed</span>: <span class="nv">container_linux</span>.<span class="nv">go</span>:<span class="mi">348</span>: <span class="nv">starting</span> <span class="nv">container</span> <span class="nv">process</span> <span class="nv">caused</span> <span class="s2">&quot;</span><span class="s">process_linux.go:301: running exec setns process for init caused </span><span class="s2">&quot;</span><span class="nv">signal</span>: <span class="nv">killed</span><span class="s2">&quot;&quot;</span>: <span class="nv">unknown</span>
</pre></div>


<p>其次，检查下应用下面容器的配置，类似下图；然后根据需求设置 request 和 limit 数量</p>
<p><img alt="应用资源限制" src="F:\bkdoc\md_to_pdf/5.1/bcs/FAQ/media/res_limit.jpg" /></p>
<ul>
<li>2.3.2 镜像问题
参考 查看 <em>镜像拉取失败</em> 处理流程</li>
</ul>
    </body>
    </html>
    